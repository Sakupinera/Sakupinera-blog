<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Sakupinera" href="http://sakupinera.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Sakupinera" href="http://sakupinera.github.io/atom.xml"><link rel="alternate" type="application/json" title="Sakupinera" href="http://sakupinera.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="è¯»ä¹¦ç¬”è®°,C#"><link rel="canonical" href="http://sakupinera.github.io/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/"><title>CLR via C# - Chapter 30 Hybrid Thread Synchronization - CLR-via-CSharp - CSharp | Hanamai Sora = Sakupinera</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">CLR via C# - Chapter 30 Hybrid Thread Synchronization</h1><div class="meta"><span class="item" title="Created: 2023-02-10 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2023-02-10T00:00:00+08:00">2023-02-10</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>76k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>1:09</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Hanamai Sora</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipexj2jgzj20zk0m8b09.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipewr8iypj20zk0m8b29.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicli3sbvtj20zk0m8x6p.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipeudstjqj20zk0m8k3r.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicljitigmj20zk0m87fp.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclhpw3lwj20zk0m8gvw.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/" itemprop="item" rel="index" title="In CSharp"><span itemprop="name">CSharp</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/CLR-via-CSharp/" itemprop="item" rel="index" title="In CLR-via-CSharp"><span itemprop="name">CLR-via-CSharp</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="http://sakupinera.github.io/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Sakupinera"><meta itemprop="description" content=", ä¿æŒä½ çš„å†³å¿ƒï¼"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sakupinera"></span><div class="body md" itemprop="articleBody"><h1 id="chapter-30-hybrid-thread-synchronization-constructs"><a class="anchor" href="#chapter-30-hybrid-thread-synchronization-constructs">#</a> Chapter 30 Hybrid Thread Synchronization Constructs</h1><h2 id="a-simple-hybrid-lock"><a class="anchor" href="#a-simple-hybrid-lock">#</a> A Simple Hybrid Lock</h2><blockquote><p>So, without further ado, let me start off by showing you an example of a hybrid thread synchronization lock.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">SimpleHybridLock</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// The Int32 is used by the primitive user-mode constructs (Interlocked methods)</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">Int32</span> m_waiters <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// The AutoResetEvent is the primitive kernel-mode construct</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">AutoResetEvent</span> m_waiterLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoResetEvent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// Indicate that this thread wants the lock</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>Interlocked<span class="token punctuation">.</span><span class="token function">Increment</span><span class="token punctuation">(</span><span class="token keyword">ref</span> m_waiters<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// Lock was free, no contention, just return</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Another thread has the lock (contention), make this thread wait</span></pre></td></tr><tr><td data-num="11"></td><td><pre> m_waiterLock<span class="token punctuation">.</span><span class="token function">WaitOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Bad performance hit here</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// When WaitOne returns, this thread now has the lock</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Leave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token comment">// This thread is releasing the lock</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>Interlocked<span class="token punctuation">.</span><span class="token function">Decrement</span><span class="token punctuation">(</span><span class="token keyword">ref</span> m_waiters<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// No other threads are waiting, just return</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token comment">// Other threads are waiting, wake 1 of them</span></pre></td></tr><tr><td data-num="19"></td><td><pre> m_waiterLock<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Bad performance hit here</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> m_waiterLock<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The SimpleHybridLock contains two fields: an Int32, which will be manipulated via the primitive user-mode constructs, and an AutoResetEvent, which is a primitive kernel-mode construct. To get great performance, the lock tries to use the Int32 and avoid using the AutoResetEvent as much as possible. Just constructing a SimpleHybridLock object causes the AutoResetEvent to be created, and this is a massive performance hit compared to the overhead associated with the Int32 field. Later in this chapter, weâ€™ll see another hybrid construct (AutoResetEventSlim) that avoids the performance hit of creating the AutoResetEvent until the first time contention is detected from multiple threads accessing the lock at the same time. The Dispose method closes the AutoResetEvent, and this is also a big performance hit.</p></blockquote><blockquote><p>Although it would be nice to improve the performance of constructing and disposing of a SimpleHybridLock object, it would be better to focus on the performance of its Enter and Leave methods because these methods tend to be called many, many times over the objectâ€™s lifetime. Letâ€™s focus on these methods now.</p></blockquote><blockquote><p>The first thread to call Enter causes Interlocked.Increment to add one to the m_waiters field, making its value 1. This thread sees that there were zero threads waiting for this lock, so the thread gets to return from its call to Enter. The thing to appreciate here is that the thread acquired the lock very quickly. Now, if another thread comes along and calls Enter, this second thread increments m_waiters to 2 and sees that another thread has the lock, so this thread blocks by calling WaitOne using the AutoResetEvent. Calling WaitOne causes the thread to transition into the Windowsâ€™ kernel, and this is a big performance hit. However, the thread must stop running anyway, so it is not too bad to have a thread waste some time to stop completely. The good news is that the thread is now blocked, and so it is not wasting CPU time by spinning on the CPU, which is what the SimpleSpinLockâ€™s Enter method, introduced in Chapter 29, does.</p></blockquote><blockquote><p>Now letâ€™s look at the Leave method. When a thread calls Leave, Interlocked.Decrement is called to subtract 1 from the m_waiters field. If m_waiters is now 0, then no other threads are blocked inside a call to Enter and the thread calling Leave can simply return. Again, think about how fast this is: leaving a lock means that a thread subtracts 1 from an Int32, performs a quick if test, and then returns! On the other hand, if the thread calling Leave sees that m_waiters was not 1, then the thread knows that there is contention and that there is at least one other thread blocked in the kernel. This thread must wake up one (and only one) of the blocked threads. It does this by calling Set on AutoResetEvent. This is a performance hit, because the thread must transition into the kernel and back, but this transition occurs only when there was contention. Of course, AutoResetEvent ensures that only one blocked thread wakes up; any other threads blocked on the AutoResetEvent will continue to block until the newly unblocked thread eventually calls Leave.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼Œä»»ä½•çº¿ç¨‹å¯ä»¥åœ¨ä»»ä½•æ—¶é—´è°ƒç”¨ <code>Leave</code> ï¼Œ å› ä¸º <code>Enter</code> æ–¹æ³•æ²¡æœ‰è®°å½•å“ªä¸€ä¸ªçº¿ç¨‹æˆåŠŸè·å¾—äº†é”ã€‚å¾ˆå®¹æ˜“æ·»åŠ å­—æ®µå’Œä»£ç æ¥ç»´æŠ¤è¿™ç§ä¿¡æ¯ï¼Œä½†ä¼šå¢å¤§é”å¯¹è±¡è‡ªèº«éœ€è¦çš„å†…å­˜ï¼Œå¹¶æŸå®³ <code>Enter</code> å’Œ <code>Leave</code> æ–¹æ³•çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒä»¬ç°åœ¨å¿…é¡»æ“ä½œè¿™ä¸ªå­—æ®µã€‚æˆ‘æƒ…æ„¿æœ‰ä¸€ä¸ªæ€§èƒ½é«˜è¶…çš„é”ï¼Œå¹¶ç¡®ä¿æˆ‘çš„ä»£ç ä»¥æ­£ç¡®æ–¹å¼ä½¿ç”¨å®ƒã€‚ä½ ä¼šæ³¨æ„åˆ°ï¼Œäº‹ä»¶å’Œä¿¡å·é‡éƒ½æ²¡æœ‰ç»´æŠ¤è¿™ç§ä¿¡æ¯ï¼Œåªæœ‰äº’æ–¥ä½“æ‰æœ‰ç»´æŠ¤ã€‚</p><p>ğŸ’¡å°ç»“ï¼š <code>SimpleHybridLock</code> åŒ…å«ä¸¤ä¸ªå­—æ®µï¼šä¸€ä¸ª <code>Int32</code> ï¼Œç”±åŸºå…ƒç”¨æˆ·æ¨¡å¼çš„æ„é€ æ¥æ“ä½œï¼›ä»¥åŠä¸€ä¸ª <code>AutoResetEvent</code> ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŸºå…ƒå†…æ ¸æ¨¡å¼çš„æ„é€ ã€‚ä¸ºäº†è·å¾—å‡ºè‰²çš„æ€§èƒ½ï¼Œé”è¦å°½é‡æ“ä½œ <code>Int32</code> ï¼Œå°½é‡å°‘æ“ä½œ <code>AutoResetEvent</code> ã€‚æ¯æ¬¡æ„é€  <code>SimpleHybridLock</code> å¯¹è±¡å°±ä¼šåˆ›å»º <code>AutoResetEvent</code> ï¼›å’Œ <code>Int32</code> å­—æ®µç›¸æ¯”ï¼Œå®ƒå¯¹æ€§èƒ½çš„å½±å“å¤§å¾—å¤šã€‚å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®é”æ—¶ï¼Œåªæœ‰åœ¨ç¬¬ä¸€æ¬¡æ£€æµ‹åˆ°ç«äº‰æ—¶æ‰ä¼šåˆ›å»º <code>AutoResetEvent</code> ï¼Œè¿™æ ·å°±é¿å…äº†æ€§èƒ½æŸå¤±ã€‚</p><h2 id="spinning-thread-ownership-and-recursion"><a class="anchor" href="#spinning-thread-ownership-and-recursion">#</a> Spinning, Thread Ownership, and Recursion</h2><blockquote><p>Because transitions into the kernel incur such a big performance hit and threads tend to hold on to a lock for very short periods of time, an applicationâ€™s overall performance can be improved by having a thread spin in user mode for a little while before having the thread transition to kernel mode. If the lock that the thread is waiting for becomes available while spinning, then the transition to kernel mode is avoided.</p></blockquote><blockquote><p>In addition, some locks impose a limitation where the thread that acquires the lock must be the thread that releases the lock. And some locks allow the currently owning thread to own the lock recursively. The Mutex lock is an example of a lock that has these characteristics.1 Using some fancy logic, it is possible to build a hybrid lock that offers spinning, thread ownership, and recursion. Here is what the code looks like.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AnotherHybridLock</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// The Int32 is used by the primitive user-mode constructs (Interlocked methods)</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">Int32</span> m_waiters <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// The AutoResetEvent is the primitive kernel-mode construct</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">AutoResetEvent</span> m_waiterLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoResetEvent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// This field controls spinning in an effort to improve performance</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">Int32</span> m_spincount <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span> <span class="token comment">// Arbitrarily chosen count</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// These fields indicate which thread owns the lock and how many times it owns it</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">Int32</span> m_owningThreadId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> m_recursion <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// If calling thread already owns the lock, increment recursion count and return</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token class-name">Int32</span> threadId <span class="token operator">=</span> Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>threadId <span class="token operator">==</span> m_owningThreadId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> m_recursion<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// The calling thread doesn't own the lock, try to get it</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token class-name">SpinWait</span> spinwait <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SpinWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> spinCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> spinCount <span class="token operator">&lt;</span> m_spincount<span class="token punctuation">;</span> spinCount<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token comment">// If the lock was free, this thread got it; set some state and return</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>Interlocked<span class="token punctuation">.</span><span class="token function">CompareExchange</span><span class="token punctuation">(</span><span class="token keyword">ref</span> m_waiters<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> GotLock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">// Black magic: give other threads a chance to run </span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// in hopes that the lock will be released</span></pre></td></tr><tr><td data-num="21"></td><td><pre> spinwait<span class="token punctuation">.</span><span class="token function">SpinOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token comment">// Spinning is over and the lock was still not obtained, try one more time</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>Interlocked<span class="token punctuation">.</span><span class="token function">Increment</span><span class="token punctuation">(</span><span class="token keyword">ref</span> m_waiters<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token comment">// Still contention, this thread must wait</span></pre></td></tr><tr><td data-num="26"></td><td><pre> m_waiterLock<span class="token punctuation">.</span><span class="token function">WaitOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wait for the lock; performance hit</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token comment">// When this thread wakes, it owns the lock; set some state and return</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre> GotLock<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token comment">// When a thread gets the lock, we record its ID and </span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">// indicate that the thread owns the lock once</span></pre></td></tr><tr><td data-num="32"></td><td><pre> m_owningThreadId <span class="token operator">=</span> threadId<span class="token punctuation">;</span> m_recursion <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Leave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token comment">// If the calling thread doesn't own the lock, there is a bug</span></pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token class-name">Int32</span> threadId <span class="token operator">=</span> Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>threadId <span class="token operator">!=</span> m_owningThreadId<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SynchronizationLockException</span><span class="token punctuation">(</span><span class="token string">"Lock not owned by calling thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token comment">// Decrement the recursion count. If this thread still owns the lock, just return</span></pre></td></tr><tr><td data-num="40"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>m_recursion <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> m_owningThreadId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// No thread owns the lock now</span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token comment">// If no other threads are waiting, just return</span></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>Interlocked<span class="token punctuation">.</span><span class="token function">Decrement</span><span class="token punctuation">(</span><span class="token keyword">ref</span> m_waiters<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token comment">// Other threads are waiting, wake 1 of them</span></pre></td></tr><tr><td data-num="46"></td><td><pre> m_waiterLock<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Bad performance hit here</span></pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> m_waiterLock<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>As you can see, adding extra behavior to the lock increases the number of fields it has, which increases its memory consumption. The code is also more complex, and this code must execute, which decreases the lockâ€™s performance. In Chapter 29â€™s â€œEvent Constructsâ€ section, I compared the performance of incrementing an Int32 without any locking, with a primitive user-mode construct, and with a kernel-mode construct. I repeat the results of those performance tests here and I include the results of using the SimpleHybridlock and the AnotherHybridLock. The results are in fastest to slowest order.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Incrementing</span> x<span class="token punctuation">:</span> <span class="token number">8</span> Fastest</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Incrementing</span> x <span class="token keyword">in</span> M<span class="token punctuation">:</span> <span class="token number">69</span> <span class="token operator">~</span>9x slower</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token class-name">Incrementing</span> x <span class="token keyword">in</span> SpinLock<span class="token punctuation">:</span> <span class="token number">164</span> <span class="token operator">~</span>21x slower</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">Incrementing</span> x <span class="token keyword">in</span> SimpleHybridLock<span class="token punctuation">:</span> <span class="token number">164</span> <span class="token operator">~</span>21x slower <span class="token punctuation">(</span>similar <span class="token class-name">to</span> SpinLock<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token class-name">Incrementing</span> x <span class="token keyword">in</span> AnotherHybridLock<span class="token punctuation">:</span> <span class="token number">230</span> <span class="token operator">~</span>29x slower <span class="token punctuation">(</span>due to ownership<span class="token operator">/</span>recursion<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token class-name">Incrementing</span> x <span class="token keyword">in</span> SimpleWaitLock<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span><span class="token number">854</span> <span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">,</span>107x slower</pre></td></tr></table></figure><blockquote><p>It is worth noting that the AnotherHybridLock hurts performance as compared to using the SimpleHybridLock. This is due to the additional logic and error checking required managing the thread ownership and recursion behaviors. As you see, every behavior added to a lock impacts its performance.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šç”±äºè½¬æ¢ä¸ºå†…æ ¸æ¨¡å¼ä¼šé€ æˆå·¨å¤§çš„æ€§èƒ½æŸå¤±ï¼Œè€Œä¸”çº¿ç¨‹å æœ‰é”çš„æ—¶é—´é€šå¸¸éƒ½å¾ˆçŸ­ï¼Œæ‰€ä»¥ä¸ºäº†æå‡åº”ç”¨ç¨‹åºçš„æ€»ä½“æ€§èƒ½ï¼Œå¯ä»¥è®©ä¸€ä¸ªçº¿ç¨‹åœ¨ç”¨æˆ·æ¨¡å¼ä¸­ â€œè‡ªæ—‹â€ ä¸€å°æ®µæ—¶é—´ï¼Œå†è®©çº¿ç¨‹è½¬æ¢ä¸ºå†…æ ¸æ¨¡å¼ã€‚å¦‚æœçº¿ç¨‹æ­£åœ¨ç­‰å¾…çš„é”åœ¨çº¿ç¨‹ â€œè‡ªæ—‹â€ æœŸé—´å˜å¾—å¯ç”¨ï¼Œå°±èƒ½é¿å…å‘å†…æ ¸æ¨¡å¼çš„è½¬æ¢äº†ã€‚æ­¤å¤–ï¼Œæœ‰çš„é”é™åˆ¶åªèƒ½ç”±è·å¾—é”çš„çº¿ç¨‹é‡Šæ”¾é”ã€‚æœ‰çš„é”å…è®¸å½“å‰æ‹¥æœ‰å®ƒçš„çº¿ç¨‹é€’å½’åœ°æ‹¥æœ‰é” (å¤šæ¬¡æ‹¥æœ‰)ï¼Œ <code>Mutex</code> é”å°±æ˜¯è¿™æ ·ä¸€ä¸ªä¾‹å­ã€‚ä¸ºé”æ·»åŠ äº†é¢å¤–çš„è¡Œä¸ºä¹‹åï¼Œä¼šå¢å¤§å®ƒæ‹¥æœ‰çš„å­—æ®µæ•°é‡ï¼Œè¿›è€Œå¢å¤§å†…å­˜æ¶ˆè€—ã€‚ä»£ç è¿˜å˜å¾—æ›´å¤æ‚äº†ï¼Œè€Œä¸”è¿™äº›ä»£ç å¿…é¡»æ‰§è¡Œï¼Œé€ æˆé”çš„æ€§èƒ½çš„ä¸‹é™ã€‚</p><h2 id="hybrid-constructs-in-the-framework-class-library"><a class="anchor" href="#hybrid-constructs-in-the-framework-class-library">#</a> Hybrid Constructs in the Framework Class Library</h2><blockquote><p>The FCL ships with many hybrid constructs that use fancy logic to keep your threads in user mode, improving your applicationâ€™s performance. Some of these hybrid constructs also avoid creating the kernel-mode construct until the first time threads contend on the construct. If threads never contend on the construct, then your application avoids the performance hit of creating the object and also avoids allocating memory for the object. A number of the constructs also support the use of a CancellationToken (discussed in Chapter 27, â€œCompute-Bound Asynchronous Operationsâ€) so that a thread can forcibly unblock other threads that might be waiting on the construct. In this section, I introduce you to these hybrid constructs.</p></blockquote><h3 id="the-manualreseteventslim-and-semaphoreslim-classes"><a class="anchor" href="#the-manualreseteventslim-and-semaphoreslim-classes">#</a> The ManualResetEventSlim and SemaphoreSlim Classes</h3><blockquote><p>The first two hybrid constructs are System.Threading.ManualResetEventSlim and System. Threading.SemaphoreSlim.2 These constructs work exactly like their kernel-mode counterparts, except that both employ spinning in user mode, and they both defer creating the kernel-mode construct until the first time contention occurs. Their Wait methods allow you to pass a timeout and a CancellationToken. Here is what these classes look like (some method overloads are not shown).</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ManualResetEventSlim</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token function">ManualResetEventSlim</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> initialState<span class="token punctuation">,</span> <span class="token class-name">Int32</span> spinCount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Wait</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> millisecondsTimeout<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> IsSet <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> SpinCount <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">WaitHandle</span> WaitHandle <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SemaphoreSlim</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">public</span> <span class="token function">SemaphoreSlim</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> initialCount<span class="token punctuation">,</span> <span class="token class-name">Int32</span> maxCount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> <span class="token function">Release</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> releaseCount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Wait</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> millisecondsTimeout<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token comment">// Special method for use with async and await (see Chapter 28)</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Boolean<span class="token punctuation">></span></span> <span class="token function">WaitAsync</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> millisecondsTimeout<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> </pre></td></tr><tr><td data-num="18"></td><td><pre>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> CurrentCount <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">WaitHandle</span> AvailableWaitHandle <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="the-monitor-class-and-sync-blocks"><a class="anchor" href="#the-monitor-class-and-sync-blocks">#</a> The Monitor Class and Sync Blocks</h3><blockquote><p>Probably the most-used hybrid thread synchronization construct is the Monitor class, which provides a mutual-exclusive lock supporting spinning, thread ownership, and recursion. This is the most-used construct because it has been around the longest, C# has a built-in keyword to support it, the just-intime (JIT) compiler has built-in knowledge of it, and the common language runtime (CLR) itself uses it on your applicationâ€™s behalf. However, as youâ€™ll see, there are many problems with this construct, making it easy to produce buggy code. Iâ€™ll start by explaining the construct, and then Iâ€™ll show the problems and some ways to work around these problems.</p></blockquote><blockquote><p>Every object on the heap can have a data structure, called a sync block, associated with it. A sync block contains fields similar to that of the AnotherHybridLock class that appeared earlier in this chapter. Specifically, it has fields for a kernel object, the owning threadâ€™s ID, a recursion count, and a waiting threads count. The Monitor class is a static class whose methods accept a reference to any heap object, and these methods manipulate the fields in the specified objectâ€™s sync block. Here is what the most commonly used methods of the Monitor class look like.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Monitor</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Enter</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Exit</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// You can also specify a timeout when entered the lock (not commonly used):</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryEnter</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Int32</span> millisecondsTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Iâ€™ll discuss the lockTaken argument later</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Enter</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name">Boolean</span> lockTaken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TryEnter</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Int32</span> millisecondsTimeout<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name">Boolean</span> lockTaken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Now obviously, associating a sync block data structure with every object in the heap is quite wasteful, especially because most objectsâ€™ sync blocks are never used. To reduce memory usage, the CLR team uses a more efficient way to offer the functionality just described. Hereâ€™s how it works: when the CLR initializes, it allocates an array of sync blocks in native heap. As discussed elsewhere in this book, whenever an object is created in the heap, it gets two additional overhead fields associated with it. The first overhead field, the type object pointer, contains the memory address of the typeâ€™s type object. The second overhead field, the sync block index, contains an integer index into the array of sync blocks.</p></blockquote><blockquote><p>When an object is constructed, the objectâ€™s sync block index is initialized to -1, which indicates that it doesnâ€™t refer to any sync block. Then, when Monitor.Enter is called, the CLR finds a free sync block in the array and sets the objectâ€™s sync block index to refer to the sync block that was found. In other words, sync blocks are associated with an object on the fly. When Exit is called, it checks to see whether there are any more threads waiting to use the objectâ€™s sync block. If there are no threads waiting for it, the sync block is free, Exit sets the objectâ€™s sync block index back to -1, and the free sync block can be associated with another object in the future.</p></blockquote><blockquote><p>Figure 30-1 shows the relationship between objects in the heap, their sync block indexes, and elements in the CLRâ€™s sync block array. Object-A, Object-B, and Object-C all have their type object pointer member set to refer to Type-T (a type object). This means that all three objects are of the same type. As discussed in Chapter 4, â€œType Fundamentals,â€ a type object is also an object in the heap, and like all other objects, a type object has the two overhead members: a sync block index and a type object pointer. This means that a sync block can be associated with a type object and a reference to a type object can be passed to Monitorâ€™s methods. By the way, the sync block array is able to create more sync blocks if necessary, so you shouldnâ€™t worry about the system running out of sync blocks if many objects are being synchronized simultaneously.</p></blockquote><p><img data-src="/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/image-20230207163104486.png" alt="image-20230207163104486"></p><blockquote><p>Here is some code that demonstrates how the Monitor class was originally intended to be used.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Transaction</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">DateTime</span> m_timeOfLastTrans<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">PerformTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// This code has exclusive access to the data...</span></pre></td></tr><tr><td data-num="6"></td><td><pre> m_timeOfLastTrans <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> LastTransaction <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// This code has exclusive access to the data...</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token class-name">DateTime</span> temp <span class="token operator">=</span> m_timeOfLastTrans<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">return</span> temp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>On the surface, this seems simple enough, but there is something wrong with this code. The problem is that each objectâ€™s sync block index is implicitly public. The following code demonstrates the impact of this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This thread takes the object's public lock</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Have a thread pool thread display the LastTransaction time</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// NOTE: The thread pool thread blocks until SomeMethod calls Monitor.Exit!</span></pre></td></tr><tr><td data-num="6"></td><td><pre> ThreadPool<span class="token punctuation">.</span><span class="token function">QueueUserWorkItem</span><span class="token punctuation">(</span>o <span class="token operator">=></span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>LastTransaction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// Execute some other code here... </span></pre></td></tr><tr><td data-num="8"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>In this code, the thread executing SomeMethod calls Monitor.Enter, taking the Transaction objectâ€™s publicly exposed lock. When the thread pool thread queries the LastTransaction property, this property also calls Monitor.Enter to acquire the same lock, causing the thread pool thread to block until the thread executing SomeMethod calls Monitor.Exit. Using a debugger, you can determine that the thread pool thread is blocked inside the LastTransaction property, but it is very hard to determine which other thread has the lock. If you do somehow figure out which thread has the lock, then you have to figure out what code caused it to take the lock. This is very difficult, and even worse, if you do figure it out, then the code might not be code that you have control over and you might not be able to modify this code to fix the problem. Therefore, my suggestion to you is to always use a private lock instead. Hereâ€™s how Iâ€™d fix the Transaction class.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Transaction</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Object</span> m_lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Each transaction has a PRIVATE lock now</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">DateTime</span> m_timeOfLastTrans<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">PerformTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Enter the private lock</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// This code has exclusive access to the data...</span></pre></td></tr><tr><td data-num="7"></td><td><pre> m_timeOfLastTrans <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Exit the private lock</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> LastTransaction <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Enter the private lock</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// This code has exclusive access to the data...</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token class-name">DateTime</span> temp <span class="token operator">=</span> m_timeOfLastTrans<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Exit the private lock</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">return</span> temp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If Transactionâ€™s members were static, then simply make the m_lock field static, too, and now the static members are thread safe.</p></blockquote><blockquote><p>It should be clear from this discussion that Monitor should not have been implemented as a static class; it should have been implemented like all the other locks: a class you instantiate and call instance methods on. In fact, Monitor has many other problems associated with it that are all because it is a static class. Here is a list of additional problems:</p><ul><li><p>A variable can refer to a proxy object if the type of object it refers to is derived from the System.MarshalByRefObject class (discussed in Chapter 22, â€œCLR Hosting and AppDomainsâ€). When you call Monitorâ€™s methods, passing a reference to a proxy object, you are locking the proxy object, not the actual object that the proxy refers to.</p></li><li><p>If a thread calls Monitor.Enter, passing it a reference to a type object that has been loaded domain neutral (discussed in Chapter 22), the thread is taking a lock on that type across all AppDomains in the process. This is a known bug in the CLR that violates the isolation that AppDomains are supposed to provide. The bug is difficult to fix in a high-performance way, so it never gets fixed. The recommendation is to never pass a reference to a type object into Monitorâ€™s methods.</p></li><li><p>Because strings can be interned (as discussed in Chapter 14, â€œChars, Strings, and Working with Textâ€), two completely separate pieces of code could unknowingly get references to a single String object in memory. If they pass the reference to the String object into Monitorâ€™s methods, then the two separate pieces of code are now synchronizing their execution with each other unknowingly.</p></li><li><p>When passing a string across an AppDomain boundary, the CLR does not make a copy of the string; instead, it simply passes a reference to the string into the other AppDomain. This improves performance, and in theory, it should be OK because String objects are immutable. However, like all objects, String objects have a sync block index associated with them, which is mutable, and this allows threads in different AppDomains to synchronize with each other unknowingly. This is another bug in CLRâ€™s AppDomain isolation story. The recommendation is never to pass String references to Monitorâ€™s methods.</p></li><li><p>Because Monitorâ€™s methods take an Object, passing a value type causes the value type to get boxed, resulting in the thread taking a lock on the boxed object. Each time Monitor.Enter is called, a lock is taken on a completely different object and you get no thread synchronization at all.</p></li><li><p>Applying the [MethodImpl(MethodImplOptions.Synchronized)] attribute to a method causes the JIT compiler to surround the methodâ€™s native code with calls to Monitor.Enter and Monitor.Exit. If the method is an instance method, then this is passed to these methods, locking the implicitly public lock. If the method is static, then a reference to the typeâ€™s type object is passed to these methods, potentially locking a domain-neutral type. The recommendation is to never use this attribute.</p></li><li><p>When calling a typeâ€™s type constructor (discussed in Chapter 8, â€œMethodsâ€), the CLR takes a lock on the typeâ€™s type object to ensure that only one thread initializes the type object and its static fields. Again, this type could be loaded domain neutral, causing a problem. For example, if the type constructorâ€™s code enters an infinite loop, then the type is unusable by all AppDomains in the process. The recommendation here is to avoid type constructors as much as possible or least keep them short and simple.</p></li></ul></blockquote><blockquote><p>Unfortunately, the story gets worse. Because it is so common for developers to take a lock, do some work, and then release the lock within a single method, the C# language offers simplified syntax via its lock keyword. Suppose that you write a method like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">lock</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// This code has exclusive access to the data...</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>It <span class="token keyword">is</span> <span class="token class-name">equivalent</span> to having written the method like <span class="token keyword">this</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token class-name">Boolean</span> lockTaken <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// An exception (such as ThreadAbortException) could occur here...</span></pre></td></tr><tr><td data-num="11"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">ref</span> lockTaken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// This code has exclusive access to the data...</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>lockTaken<span class="token punctuation">)</span> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The first problem here is that the C# team felt that they were doing you a favor by calling Monitor.Exit in a finally block. Their thinking was that this ensures that the lock is always released no matter what happens inside the try block. However, this is not a good thing. If an exception occurs inside the try block while changing state, then the state is now corrupted. When the lock is exited in the finally block, another thread will now start manipulating the corrupted state. It is better to have your application hang than it is to continue running with a corrupted state and potential security holes. The second problem is that entering and leaving a try block decreases the performance of the method. And some JIT compilers wonâ€™t inline a method that contains a try block in it, which decreases performance even more. So now we have slower code that lets threads access corrupted state.3 The recommendation is not to use C#â€™s lock statement.</p></blockquote><blockquote><p>Now we get to the Boolean lockTaken variable. Here is the problem that this variable is trying to solve. Letâ€™s say that a thread enters the try block and before calling Monitor.Enter, the thread is aborted (as discussed in Chapter 22). Now the finally block is called, but its code should not exit the lock. The lockTaken variable solves this problem. It is initialized to false, which assumes that the lock has not been entered into. Then, if Monitor.Enter is called and successfully takes the lock, it sets lockTaken to true. The finally block examines lockTaken to know whether to call Monitor.Exit or not. By the way, the SpinLock structure also supports this lockTaken pattern.</p></blockquote><h3 id="the-readerwriterlockslim-class"><a class="anchor" href="#the-readerwriterlockslim-class">#</a> The ReaderWriterLockSlim Class</h3><blockquote><p>It is common to have threads simply read the contents of some data. If this data is protected by a mutual exclusive lock (like the SimpleSpinLock, SimpleWaitLock, SimpleHybridLock, AnotherHybridLock, SpinLock, Mutex, or Monitor), then if multiple threads attempt this access concurrently, only one thread gets to run and all the other threads are blocked, which can reduce scalability and throughput in your application substantially. However, if all the threads want to access the data in a read-only fashion, then there is no need to block them at all; they should all be able to access the data concurrently. On the other hand, if a thread wants to modify the data, then this thread needs exclusive access to the data. The ReaderWriterLockSlim construct encapsulates the logic to solve this problem. Specifically, the construct controls threads like this:</p><ul><li><p>When one thread is writing to the data, all other threads requesting access are blocked.</p></li><li><p>When one thread is reading from the data, other threads requesting read access are allowed to continue executing, but threads requesting write access are blocked.</p></li><li><p>When a thread writing to the data has completed, either a single writer thread is unblocked so it can access the data or all the reader threads are unblocked so that all of them can access the data concurrently. If no threads are blocked, then the lock is free and available for the next reader or writer thread that wants it.</p></li><li><p>When all threads reading from the data have completed, a single writer thread is unblocked so it can access the data. If no threads are blocked, then the lock is free and available for the next reader or writer thread that wants it.</p></li></ul></blockquote><blockquote><p>Here is what this class looks like (some method overloads are not shown).</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReaderWriterLockSlim</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token function">ReaderWriterLockSlim</span><span class="token punctuation">(</span><span class="token class-name">LockRecursionPolicy</span> recursionPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EnterReadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryEnterReadLock</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> millisecondsTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ExitReadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EnterWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryEnterWriteLock</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> millisecondsTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ExitWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Most applications will never query any of these properties </span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> IsReadLockHeld <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> IsWriteLockHeld <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> CurrentReadCount <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> RecursiveReadCount <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> RecursiveWriteCount <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> WaitingReadCount <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> WaitingWriteCount <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">LockRecursionPolicy</span> RecursionPolicy <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">// Members related to upgrading from a reader to a writer not shown</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Here is some code that demonstrates the use of this construct.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Transaction</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ReaderWriterLockSlim</span> m_lock <span class="token operator">=</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ReaderWriterLockSlim</span><span class="token punctuation">(</span>LockRecursionPolicy<span class="token punctuation">.</span>NoRecursion<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">DateTime</span> m_timeOfLastTrans<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">PerformTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> m_lock<span class="token punctuation">.</span><span class="token function">EnterWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// This code has exclusive access to the data...</span></pre></td></tr><tr><td data-num="8"></td><td><pre> m_timeOfLastTrans <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> m_lock<span class="token punctuation">.</span><span class="token function">ExitWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> LastTransaction <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> m_lock<span class="token punctuation">.</span><span class="token function">EnterReadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// This code has shared access to the data...</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token class-name">DateTime</span> temp <span class="token operator">=</span> m_timeOfLastTrans<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> m_lock<span class="token punctuation">.</span><span class="token function">ExitReadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">return</span> temp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> m_lock<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>There are a few concepts related to this construct that deserve special mention. First, ReaderWriterLockSlimâ€™s constructor allows you to pass in a LockRecursionPolicy flag, which is defined as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">LockRecursionPolicy</span> <span class="token punctuation">&#123;</span> NoRecursion<span class="token punctuation">,</span> SupportsRecursion <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If you pass the SupportsRecursion flag, then the lock will add thread ownership and recursion behaviors to the lock. As discussed earlier in this chapter, these behaviors negatively affect the lockâ€™s performance, so I recommend that you always pass LockRecursionPolicy.NoRecursion to the constructor (as Iâ€™ve done). For a reader-writer lock, supporting thread ownership and recursion is phenomenally expensive, because the lock must keep track of all the reader threads that it has let into the lock and keep a separate recursion count for each reader thread. In fact, to maintain all this information in a thread-safe way, the ReaderWriterLockSlim internally uses a mutually exclusive spinlock! No, Iâ€™m not kidding.</p></blockquote><blockquote><p>The ReaderWriterLockSlim class offers additional methods (not shown earlier) that allow a reading thread to upgrade itself to a writer thread. Later, the thread can downgrade itself to a reader thread. The thinking here is that a thread could start reading the data and based on the dataâ€™s contents, the thread might want to modify the data. To do this, the thread would upgrade itself from a reader to a writer. Having the lock support this behavior deteriorates the lockâ€™s performance, and I donâ€™t think that this is a useful feature at all. Hereâ€™s why: a thread canâ€™t just turn itself from a reader into a writer. Other threads may be reading, too, and these threads will have to exit the lock completely before the thread trying to upgrade is allowed to become a writer. This is the same as having the reader thread exit the lock and then immediately acquire it for writing.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šFCL è¿˜æä¾›äº†ä¸€ä¸ª <code>ReaderWriterLock</code> æ„é€ ï¼Œå®ƒæ˜¯åœ¨ Microsoft .NET Framework 1.0 ä¸­å¼•å…¥çš„ã€‚è¿™ä¸ªæ„é€ å­˜åœ¨è®¸å¤šé—®é¢˜ï¼Œæ‰€ä»¥ Microsoft åœ¨ .NET Framework 3.5 ä¸­å¼•å…¥äº† <code>ReaderWriterLockSlim</code> æ„é€ ã€‚å›¢é˜Ÿæ²¡æœ‰å¯¹åŸå…ˆçš„ <code>ReaderWriterLock</code> æ„é€ è¿›è¡Œæ”¹è¿›ï¼Œå› ä¸ºå®ƒä»¬å®³æ€•å¤±å»å’Œé‚£äº›æ­£åœ¨ä½¿ç”¨å®ƒçš„åº”ç”¨ç¨‹åºçš„å…¼å®¹æ€§ã€‚ä¸‹é¢åˆ—ä¸¾äº† <code>ReaderWriterLock</code> å­˜åœ¨çš„å‡ ä¸ªé—®é¢˜ã€‚é¦–å…ˆï¼Œå³ä½¿ä¸å­˜åœ¨çº¿ç¨‹ç«äº‰ï¼Œå®ƒçš„é€Ÿåº¦ä¹Ÿéå¸¸æ…¢ã€‚å…¶æ¬¡ï¼Œçº¿ç¨‹æ‰€æœ‰æƒå’Œé€’å½’è¡Œä¸ºæ˜¯è¿™ä¸ªæ„é€ å¼ºåŠ çš„ï¼Œå®Œå…¨å–æ¶ˆä¸äº†ï¼Œè¿™ä½¿é”å˜å¾—æ›´æ…¢ã€‚æœ€åï¼Œç›¸æ¯” writer çº¿ç¨‹ï¼Œå®ƒæ›´é’çäº reader çº¿ç¨‹ï¼Œæ‰€ä»¥ writer çº¿ç¨‹å¯èƒ½æ’èµ·å¥½é•¿çš„é˜Ÿï¼Œå´å¾ˆå°‘æœ‰æœºä¼šè·å¾—æœåŠ¡ï¼Œæœ€ç»ˆé€ æˆ â€œæ‹’ç»æœåŠ¡â€(DoS) é—®é¢˜ã€‚</p><h3 id="the-onemanylock-class"><a class="anchor" href="#the-onemanylock-class">#</a> The OneManyLock Class</h3><blockquote><p>I have created my own reader-writer construct that is faster than the FCLâ€™s ReaderWriterLockSlim class. My class is called OneManyLock because it allows access to either one writer thread or many reader threads. The class basically looks like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">OneManyLock</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token function">OneManyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Enter</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> exclusive<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Leave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Now Iâ€™d like to give you a sense of how it works. Internally, the class has an Int32 field for the state of the lock, a Semaphore object that reader threads block on, and an AutoResetEvent object that writer threads block on. The Int64 state field is divided into five subfields as follows:</p><ul><li><p>Four bits represent the state of the lock itself. The possibilities are 0=Free, 1=OwnedByWriter, 2=OwnedByReaders, 3=OwnedByReadersAndWriterPending, and 4=ReservedForWriter. The other values are not used.</p></li><li><p>Twenty bits (a number from 0 to 1,048,575) represent the number of reader threads reading (RR) that the lock has currently allowed in.</p></li><li><p>Twenty bits represent the number of reader threads waiting (RW) to get into the lock. These threads block on the auto-reset event object.</p></li><li><p>Twenty bits represent the number of writer threads waiting (WW) to get into the lock. These threads block on the other semaphore object.</p></li></ul></blockquote><blockquote><p>Now, because all the information about the lock fits in a single Int64 field, I can manipulate this field by using the methods of the Interlocked class so the lock is incredibly fast and causes a thread to block only when there is contention.</p></blockquote><blockquote><p>Hereâ€™s what happens when a thread enters the lock for shared access.</p><ul><li><p>If the lock is Free: Set state to OwnedByReaders, RR=1, Return.</p></li><li><p>If the lock is OwnedByReaders: RR++, Return.</p></li><li><p>Else: RW++, Block reader thread. When the thread wakes, loop around and try again.</p></li></ul></blockquote><blockquote><p>Hereâ€™s what happens when a thread that has shared access leaves the lock.</p><ul><li><p>RR--</p></li><li><p>If RR &gt; 0: Return</p></li><li><p>If WW &gt; 0: Set state to ReservedForWriter, WW--, Release 1 blocked writer thread, Return</p></li><li><p>If RW == 0 &amp;&amp; WW == 0: Set state to Free, Return</p></li></ul></blockquote><blockquote><p>Hereâ€™s what happens when a thread enters the lock for exclusive access:</p><ul><li><p>If the lock is Free: Set state to OwnedByWriter, Return.</p></li><li><p>If the lock is ReservedForWriter: Set state to OwnedByWriter, Return.</p></li><li><p>If the lock is OwnedByWriter: WW++, Block writer thread. When thread wakes, loop around and try again.</p></li><li><p>Else: Set state to OwnedByReadersAndWriterPending, WW++, Block writer thread. When thread wakes, loop around and try again.</p></li></ul></blockquote><blockquote><p>Hereâ€™s what happens when a thread that has exclusive access leaves the lock:</p><ul><li><p>If WW == 0 &amp;&amp; RW == 0: Set state to Free, Return</p></li><li><p>If WW &gt; 0: Set state to ReservedForWriter, WW--, Release 1 blocked writer thread, Return</p></li><li><p>If WW == 0 &amp;&amp; RW &gt; 0: Set state to Free , RW=0, Wake all blocked reader threads, Return</p></li></ul></blockquote><blockquote><p>Letâ€™s say that there is currently one thread reading from the lock and another thread wants to enter the lock for writing. The writer thread will first check to see if the lock is Free, and because it is not, the thread will advance to perform the next check. However, at this point, the reader thread could leave the lock, and seeing that RR and WW are both 0, the thread could set the lockâ€™s state to Free. This is a problem because the writer thread has already performed this test and moved on. Basically what happened is that the reader thread changed the state that the writer thread was accessing behind its back. I needed to solve this problem so that the lock would function correctly.</p></blockquote><blockquote><p>To solve the problem, all of these bit manipulations are performed using the technique I showed in the â€œThe Interlocked Anything Patternâ€ section from Chapter 29. If you recall, this pattern lets you turn any operation into a thread-safe atomic operation. This is what allows this lock to be so fast and have less state in it than other reader-writer locks. When I run performance tests comparing my OneManyLock against the FCLâ€™s ReaderWriterLockSlim and ReaderWriterLock classes, I get the following results.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Incrementing</span> x <span class="token keyword">in</span> OneManyLock<span class="token punctuation">:</span> <span class="token number">330</span> Fastest</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Incrementing</span> x <span class="token keyword">in</span> ReaderWriterLockSlim<span class="token punctuation">:</span> <span class="token number">554</span> <span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">.</span>7x slower </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token class-name">Incrementing</span> x <span class="token keyword">in</span> ReaderWriterLock<span class="token punctuation">:</span> <span class="token number">984</span> <span class="token operator">~</span>3x slower</pre></td></tr></table></figure><blockquote><p>Of course, because all reader-writer locks perform more logic than a mutually exclusive lock, their performance can be slightly worse. However, you have to weigh this against the fact that a readerwriter lock allows multiple readers into the lock simultaneously.</p></blockquote><blockquote><p>Before leaving this section, Iâ€™ll also mention that my Power Threading library (downloadable for free from <span class="exturl" data-url="aHR0cDovL1dpbnRlbGxlY3QuY29tL1Bvd2VyVGhyZWFkaW5nLmFzcHg=">http://Wintellect.com/PowerThreading.aspx</span>) offers a slightly different version of this lock, called OneManyResourceLock. This lock and others in the library offer many additional features, such as deadlock detection, the ability to turn on lock ownership and recursion (albeit at a performance cost), a unified programming model for all locks, and the ability to observe the run-time behavior of the locks. For observing behavior, you can see the maximum amount of time that a thread ever waited to acquire a lock, and you can see the minimum and maximum amount of time that a lock was held.</p></blockquote><h3 id="the-countdownevent-class"><a class="anchor" href="#the-countdownevent-class">#</a> The CountdownEvent Class</h3><blockquote><p>The next construct is System.Threading.CountdownEvent. Internally, this construct uses a ManualResetEventSlim object. This construct blocks a thread until its internal counter reaches 0. In a way, this constructâ€™s behavior is the opposite of that of a Semaphore (which blocks threads while its count is 0). Here is what this class looks like (some method overloads are not shown).</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountdownEvent</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token function">CountdownEvent</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> initialCount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Set CurrentCount to count</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddCount</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> signalCount<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Increments CurrentCount by signalCount</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryAddCount</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> signalCount<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Increments CurrentCount by signalCount</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Signal</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> signalCount<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Decrements CurrentCount by signameCount</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Wait</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> millisecondsTimeout<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> CurrentCount <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> IsSet <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// true if CurrentCount is 0</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">WaitHandle</span> WaitHandle <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>After a CountdownEventâ€™s CurrentCount reaches 0, it cannot be changed. The AddCount method throws InvalidOperationException when CurrentCount is 0, whereas the TryAddCount method simply returns false if CurrentCount is 0.</p></blockquote><h3 id="the-barrier-class"><a class="anchor" href="#the-barrier-class">#</a> The Barrier Class</h3><blockquote><p>The System.Threading.Barrier construct is designed to solve a very rare problem, so it is unlikely that you will have a use for it. Barrier is used to control a set of threads that are working together in parallel so that they can step through phases of the algorithm together. Perhaps an example is in order: when the CLR is using the server version of its garbage collector (GC), the GC algorithm creates one thread per core. These threads walk up different application threadsâ€™ stacks, concurrently marking objects in the heap. As each thread completes its portion of the work, it must stop waiting for the other threads to complete their portion of the work. After all threads have marked the objects, then the threads can compact different portions of the heap concurrently. As each thread finishes compacting its portion of the heap, the thread must block waiting for the other threads. After all the threads have finished compacting their portion of the heap, then all the threads walk up the applicationâ€™s threadsâ€™ stacks, fixing up roots to refer to the new location of the compacted object. Only after all the threads have completed this work is the garbage collector considered complete and the applicationâ€™s threads can be resumed.</p></blockquote><blockquote><p>This scenario is easily solved using the Barrier class, which looks like this (some method overloads are not shown).</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Barrier</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token function">Barrier</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> participantCount<span class="token punctuation">,</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span>Barrier<span class="token punctuation">></span></span> postPhaseAction<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int64</span> <span class="token function">AddParticipants</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> participantCount<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Adds participants</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RemoveParticipants</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> participantCount<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Subtracts participants</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">SignalAndWait</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> millisecondsTimeout<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span></pre></td></tr><tr><td data-num="7"></td><td><pre> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int64</span> CurrentPhaseNumber <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// Indicates phase in process (starts at 0)</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> ParticipantCount <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// Number of participants</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> ParticipantsRemaining <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// # of threads needing to call SignalAndWait</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When you construct a Barrier, you tell it how many threads are participating in the work, and you can also pass an Action delegate referring to code that will be invoked whenever all participants complete a phase of the work. You can dynamically add and remove participating threads from the Barrier by calling the AddParticipant and RemoveParticipant methods but, in practice, this is rarely done. As each thread completes its phase of the work, it should call SignalAndWait, which tells the Barrier that the thread is done and the Barrier blocks the thread (using a ManualResetEventSlim). After all participants call SignalAndWait, the Barrier invokes the delegate (using the last thread that called SignalAndWait) and then unblocks all the waiting threads so they can begin the next phase.</p></blockquote><h3 id="thread-synchronization-construct-summary"><a class="anchor" href="#thread-synchronization-construct-summary">#</a> Thread Synchronization Construct Summary</h3><blockquote><p>My recommendation always is to avoid writing code that blocks any threads. When performing asynchronous compute or I/O operations, hand the data off from thread to thread in such a way to avoid the chance that multiple threads could access the data simultaneously. If you are unable to fully accomplish this, then try to use the Volatile and Interlocked methods because they are fast and they also never block a thread. Unfortunately, these methods manipulate only simple types, but you can perform rich operations on these types as described in the â€œThe Interlocked Anything Patternâ€ section in Chapter 29.</p></blockquote><blockquote><p>There are two main reasons why you would consider blocking threads:</p><ul><li><p>The programming model is simplified By blocking a thread, you are sacrificing some resources and performance so that you can write your application code sequentially without using callback methods. But C#â€™s async methods feature gives you a simplified programming model without blocking threads.</p></li><li><p>A thread has a dedicated purpose Some threads must be used for specific tasks. The best example is an applicationâ€™s primary thread. If an applicationâ€™s primary thread doesnâ€™t block, then it will eventually return and the whole process will terminate. Another example is an applicationâ€™s GUI thread or threads. Windows requires that a window or control always be manipulated by the thread that created it, so we sometimes write code that blocks a GUI thread until some other operation is done, and then the GUI thread updates any windows and controls as needed. Of course, blocking the GUI thread hangs the application and provides a bad end-user experience.</p></li></ul></blockquote><blockquote><p>To avoid blocking threads, donâ€™t mentally assign a label to your threads. For example, donâ€™t create a spell-checking thread, a grammar-checking thread, a thread that handles this particular client request, and so on. The moment you assign a label to a thread, you have also said to yourself that the thread canâ€™t do anything else. But threads are too expensive a resource to have them dedicated to a particular purpose. Instead, you should use the thread pool to rent threads for short periods of time. So, a thread pool thread starts out spell checking, then it changes to grammar checking, and then it changes again to perform work on behalf of a client request, and so on.</p></blockquote><blockquote><p>If, in spite of this discussion, you decide to block threads, then use the kernel object constructs if you want to synchronize threads that are running in different AppDomains or processes. To atomically manipulate state via a set of operations, use the Monitor class with a private field.5 Alternatively, you could use a reader-writer lock instead of Monitor. Reader-writer locks are generally slower than Monitor, but they allow multiple reader threads to execute concurrently, which improves overall performance and minimizes the chance of blocking threads.</p></blockquote><blockquote><p>In addition, avoid using recursive locks (especially recursive reader-writer locks) because they hurt performance. However, Monitor is recursive and its performance is very good.6 Also, avoid releasing a lock in a finally block because entering and leaving exception-handling blocks incurs a performance hit, and if an exception is thrown while mutating state, then the state is corrupted, and other threads that manipulate it will experience unpredictable behavior and security bugs.</p></blockquote><blockquote><p>Of course, if you do write code that holds a lock, your code should not hold the lock for a long time, because this increases the likelihood of threads blocking. In the â€œAsynchronous Synchronizationâ€ section later in this chapter, I will show a technique that uses collection classes as a way to avoid holding a lock for a long time.</p></blockquote><blockquote><p>Finally, for compute-bound work, you can use tasks (discussed in Chapter 27) to avoid a lot of the thread synchronization constructs. In particular, I love that each task can have one or more continuewith tasks associated with it that execute via some thread pool thread when some operation completes. This is much better than having a thread block waiting for some operation to complete. For I/O-bound work, call the various XxxAsync methods that cause your code to continue running after the I/O operation completes; this is similar to a taskâ€™s continue-with task.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šFCL è‡ªå¸¦äº†è®¸å¤šæ··åˆæ„é€ ï¼Œå®ƒä»¬é€šè¿‡ä¸€äº›åˆ«è‡´çš„é€»è¾‘å°†ä½ çš„çº¿ç¨‹ä¿æŒåœ¨ç”¨æˆ·æ¨¡å¼ï¼Œä»è€Œå¢åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚æœ‰çš„æ··åˆæ„é€ ç›´åˆ°é¦–æ¬¡æœ‰çº¿ç¨‹åœ¨ä¸€ä¸ªæ„é€ ä¸Šå‘ç”Ÿç«äº‰æ—¶ï¼Œæ‰ä¼šåˆ›å»ºå†…æ ¸æ¨¡å¼çš„æ„é€ ã€‚å¦‚æœçº¿ç¨‹ä¸€ç›´ä¸åœ¨æ„é€ è¯´ä¸Šå‘ç”Ÿç«äº‰ï¼Œåº”ç”¨ç¨‹åºå°±å¯é¿å…å› ä¸ºåˆ›å»ºå¯¹è±¡è€Œäº§ç”Ÿçš„æ€§èƒ½æŸå¤±ï¼ŒåŒæ—¶é¿å…ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ã€‚è®¸å¤šæ„é€ è¿˜æ”¯æŒä½¿ç”¨ä¸€ä¸ª <code>CancellationToken</code> ï¼Œä½¿ä¸€ä¸ªçº¿ç¨‹å¼ºè¿«è§£é™¤å¯èƒ½æ­£åœ¨æ„é€ ä¸Šç­‰å¾…çš„å…¶ä»–çº¿ç¨‹çš„é˜»å¡ã€‚ <code>System.Threading.ManualResetEventSlim</code> å’Œ <code>System.Threading.SemaphoreSlim</code> è¿™ä¸¤ä¸ªç±»ã€‚è¿™ä¸¤ä¸ªæ„é€ çš„å·¥ä½œæ–¹å¼å’Œå¯¹åº”çš„å†…æ ¸æ¨¡å¼æ„é€ å®Œå…¨ä¸€è‡´ï¼Œåªæ˜¯å®ƒä»¬éƒ½åœ¨ç”¨æˆ·æ¨¡å¼ä¸­ â€œè‡ªæ—‹â€ï¼Œè€Œä¸”éƒ½æ¨è¿Ÿåˆ°å‘ç”Ÿç¬¬ä¸€æ¬¡ç«äº‰æ—¶ï¼Œæ‰åˆ›å»ºå†…æ ¸æ¨¡å¼çš„æ„é€ ã€‚å®ƒä»¬çš„ <code>Wait</code> æ–¹æ³•å…è®¸ä¼ é€’ä¸€ä¸ªè¶…æ—¶å€¼å’Œä¸€ä¸ª <code>CancellationToken</code> ã€‚æˆ–è®¸æœ€å¸¸ç”¨çš„æ··åˆå‹çº¿ç¨‹åŒæ­¥æ„é€ å°±æ˜¯ <code>Monitor</code> ç±»ï¼Œå®ƒæä¾›äº†æ”¯æŒè‡ªæ—‹ã€çº¿ç¨‹æ‰€æœ‰æƒå’Œé€’å½’å’Œäº’æ–¥é”ã€‚ä¹‹æ‰€ä»¥æœ€å¸¸ç”¨ï¼Œæ˜¯å› ä¸ºå®ƒèµ„æ ¼æœ€è€ï¼ŒC# æœ‰å†…å»ºçš„å…³é”®å­—æ”¯æŒå®ƒï¼ŒJIT ç¼–è¯‘å™¨å¯¹å®ƒçŸ¥ä¹‹ç”šè¯¦ï¼Œè€Œä¸” CLR è‡ªå·±ä¹Ÿåœ¨ä»£è¡¨ä½ çš„åº”ç”¨ç¨‹åºä½¿ç”¨å®ƒã€‚å †ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½å¯å…³è”ä¸€ä¸ªåä¸º<strong>åŒæ­¥å—</strong>çš„æ•°æ®ç»“æ„ã€‚åŒæ­¥å—åŒ…å«å­—æ®µï¼Œè¿™äº›å­—æ®µå’Œæœ¬ç« å‰é¢å±•ç¤ºçš„ <code>AnotherHybridLock</code> ç±»çš„å­—æ®µç›¸ä¼¼ã€‚å…·ä½“åœ°è¯´ï¼Œå®ƒå¯¹å†…æ ¸å¯¹è±¡ã€æ‹¥æœ‰çº¿ç¨‹ (owning thread) çš„ IDã€é€’å½’è®¡æ•° (recursion count) ä»¥åŠç­‰å¾…çº¿ç¨‹ (waiting thread) è®¡æ•°æä¾›äº†ç›¸åº”çš„å­—æ®µã€‚ <code>Monitor</code> æ˜¯é™æ€ç±»ï¼Œå®ƒçš„æ–¹æ³•æ¥æ”¶å¯¹ä»»ä½•å †å¯¹è±¡çš„å¼•ç”¨ã€‚è¿™äº›æ–¹æ³•å¯¹æŒ‡å®šå¯¹è±¡çš„åŒæ­¥å—ä¸­çš„å­—æ®µè¿›è¡Œæ“ä½œã€‚ä¸ºèŠ‚çœå†…å­˜ï¼ŒCLR å›¢é˜Ÿé‡‡ç”¨ä¸€ç§æ›´ç»æµçš„æ–¹å¼æä¾›åˆšæ‰æè¿°çš„åŠŸèƒ½ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯ï¼šCLR åˆå§‹åŒ–æ—¶åœ¨å †ä¸­åˆ†é…ä¸€ä¸ªåŒæ­¥å—æ•°ç»„ã€‚æ¯å½“ä¸€ä¸ªå¯¹è±¡åœ¨å †ä¸­åˆ›å»ºçš„æ—¶å€™ï¼Œéƒ½æœ‰ä¸¤ä¸ªé¢å¤–çš„å¼€é”€å­—æ®µä¸å®ƒå…³è”ã€‚ç¬¬ä¸€ä¸ª â€œç±»å‹å¯¹è±¡æŒ‡é’ˆâ€ï¼ŒåŒ…å«ç±»å‹çš„ â€œç±»å‹å¯¹è±¡â€ çš„å†…å­˜åœ°å€ã€‚ç¬¬äºŒä¸ªæ˜¯ â€œåŒæ­¥å—ç´¢å¼•â€ï¼ŒåŒ…å«åŒæ­¥å—æ•°ç»„ä¸­çš„ä¸€ä¸ªæ•´æ•°ç´¢å¼•ã€‚ä¸€ä¸ªå¯¹è±¡åœ¨æ„é€ æ—¶ï¼Œå®ƒçš„åŒæ­¥å—ç´¢å¼•åˆå§‹åŒ–ä¸º -1ï¼Œè¡¨æ˜ä¸å¼•ç”¨ä»»ä½•åŒæ­¥å—ã€‚ç„¶åï¼Œè°ƒç”¨ <code>Monitor.Enter</code> æ—¶ï¼ŒCLR åœ¨æ•°ç»„ä¸­æ‰¾åˆ°ä¸€ä¸ªç©ºç™½åŒæ­¥å—ï¼Œå¹¶è®¾ç½®å¯¹è±¡çš„åŒæ­¥å—ç´¢å¼•ï¼Œè®©å®ƒå¼•ç”¨è¯¥åŒæ­¥å—ã€‚æ¢è¨€ä¹‹ï¼ŒåŒæ­¥å—å’Œå¯¹è±¡æ˜¯åŠ¨æ€å…³è”çš„ã€‚è°ƒç”¨ <code>Exit</code> æ—¶ï¼Œä¼šæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ä»»ä½•çº¿ç¨‹æ­£åœ¨ç­‰å¾…ä½¿ç”¨å¯¹è±¡çš„åŒæ­¥å—ã€‚å¦‚æœæ²¡æœ‰çº¿ç¨‹åœ¨ç­‰å¾…å®ƒï¼ŒåŒæ­¥å—å°±è‡ªç”±äº†ï¼Œ <code>Exit</code> å°†å¯¹è±¡çš„åŒæ­¥å—ç´¢å¼•è®¾å› <code>-1</code> ï¼Œè‡ªç”±çš„åŒæ­¥å—å°†æ¥å¯ä»¥å’Œå¦ä¸€ä¸ªå¯¹è±¡å…³è”ã€‚å’Œå…¶ä»–æ‰€æœ‰å¯¹è±¡ä¸€æ ·ï¼Œç±»å‹å¯¹è±¡æœ‰ä¸¤ä¸ªå¼€é”€æˆå‘˜ï¼šåŒæ­¥å—ç´¢å¼•å’Œç±»å‹å¯¹è±¡æŒ‡é’ˆã€‚è¿™æ„å‘³ç€åŒæ­¥å—å¯ä»¥å’Œç±»å‹å¯¹è±¡å…³è”ï¼Œè€Œä¸”å¯ä»¥å°†ä¸€ä¸ªç±»å‹å¯¹è±¡å¼•ç”¨ä¼ ç»™ <code>Monitor</code> çš„æ–¹æ³•ã€‚é¡ºä¾¿è¯´ä¸€å¥ï¼Œå¦‚æœ‰å¿…è¦ï¼ŒåŒæ­¥å—æ•°ç»„èƒ½åˆ›å»ºæ›´å¤šçš„åŒæ­¥å—ã€‚æ‰€ä»¥ï¼ŒåŒæ—¶åŒæ­¥å¤§é‡å¯¹è±¡æ—¶ï¼Œä¸å¿…æ‹…å¿ƒç³»ç»Ÿä¼šç”¨å…‰åŒæ­¥å—ã€‚ <code>Monitor</code> æ ¹æœ¬å°±ä¸è¯¥å®ç°æˆé™æ€ç±»ï¼›å®ƒåº”è¯¥åƒå…¶ä»–æ‰€æœ‰åŒæ­¥æ„é€ é‚£æ ·å®ç°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåº”è¯¥æ˜¯ä¸€ä¸ªå¯ä»¥å®ä¾‹åŒ–å¹¶åœ¨ä¸Šé¢è°ƒç”¨å®ä¾‹æ–¹æ³•çš„ç±»ã€‚äº‹å®ä¸Šï¼Œæ­£å› ä¸º <code>Monitor</code> è¢«è®¾è®¡æˆä¸€ä¸ªé™æ€ç±»ï¼Œæ‰€ä»¥å®ƒè¿˜å­˜åœ¨å…¶ä»–è®¸å¤šé—®é¢˜ã€‚1. è°ƒç”¨ <code>Monitor</code> çš„æ–¹æ³•æ—¶ï¼Œä¼ é€’å¯¹ä»£ç†å¯¹è±¡çš„å¼•ç”¨ï¼Œé”å®šçš„æ˜¯ä»£ç†å¯¹è±¡è€Œä¸æ˜¯ä»£ç†å¼•ç”¨çš„å®é™…å¯¹è±¡ã€‚2. å¦‚æœçº¿ç¨‹è°ƒç”¨ <code>Monitor.Enter</code> ï¼Œå‘å®ƒä¼ é€’å¯¹ç±»å‹å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œä¸”è¿™ä¸ªç±»å‹å¯¹è±¡æ˜¯ä»¥ â€œAppDomain ä¸­ç«‹â€ çš„æ–¹å¼åŠ è½½çš„ï¼Œçº¿ç¨‹å°±ä¼šè·¨è¶Šè¿›ç¨‹ä¸­çš„æ‰€æœ‰ AppDomain åœ¨é‚£ä¸ªç±»å‹ä¸Šè·å–é”ã€‚3. ç”±äºå­—ç¬¦ä¸²å¯ä»¥ç•™ç”¨ï¼Œæ‰€ä»¥ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„ä»£ç æ®µå¯èƒ½åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è·å–å¯¹å†…å­˜ä¸­çš„ä¸€ä¸ª <code>String</code> å¯¹è±¡çš„å¼•ç”¨ã€‚å¦‚æœå°†è¿™ä¸ª <code>String</code> å¯¹è±¡å¼•ç”¨ä¼ ç»™ <code>Monitor</code> çš„æ–¹æ³•ï¼Œä¸¤ä¸ªç‹¬ç«‹çš„ä»£ç æ®µç°åœ¨å°±ä¼šåœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ä»¥åŒæ­¥æ–¹å¼æ‰§è¡Œã€‚4. è·¨è¶Š AppDomain è¾¹ç•Œä¼ é€’å­—ç¬¦ä¸²æ—¶ï¼ŒCLR ä¸åˆ›å»ºå­—ç¬¦ä¸²çš„å‰¯æœ¬ï¼›ç›¸åï¼Œå®ƒåªæ˜¯å°†å¯¹å­—ç¬¦ä¸²çš„ä¸€ä¸ªå¼•ç”¨ä¼ ç»™å…¶ä»– AppDomainã€‚è¿™å¢å¼ºäº†æ€§èƒ½ï¼Œç†è®ºä¸Šä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œå› ä¸º <code>String</code> å¯¹è±¡æœ¬æ¥å°±ä¸å¯å˜ (ä¸å¯ä¿®æ”¹)ã€‚ä½†å’Œå…¶ä»–æ‰€æœ‰å¯¹è±¡ä¸€æ ·ï¼Œ <code>String</code> å¯¹è±¡å…³è”äº†ä¸€ä¸ªåŒæ­¥ç´¢å¼•å—ï¼Œè¿™ä¸ªç´¢å¼•æ˜¯å¯å˜çš„ (å¯ä¿®æ”¹)ï¼Œä½¿ä¸åŒ AppDomain ä¸­çš„çº¿ç¨‹åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å¼€å§‹åŒæ­¥ã€‚5. ç”±äº <code>Monitor</code> çš„æ–¹æ³•è¦è·å–ä¸€ä¸ª <code>Object</code> ï¼Œæ‰€ä»¥ä¼ é€’å€¼ç±»å‹ä¼šå¯¼è‡´å€¼ç±»å‹è¢«è£…ç®±ï¼Œé€ æˆçº¿ç¨‹åœ¨å·²è£…ç®±å¯¹è±¡ä¸Šä¸ªè·å–é”ã€‚æ¯æ¬¡è°ƒç”¨ <code>Monitor.Enter</code> éƒ½ä¼šåœ¨ä¸€ä¸ªå®Œå…¨ä¸åŒçš„å¯¹è±¡ä¸Šè·å–é”ï¼Œé€ æˆå®Œå…¨æ— æ³•å®ç°çº¿ç¨‹åŒæ­¥ã€‚6. å‘æ–¹æ³•åº”ç”¨ <code>[MethodImpl(MethodImplOptions.Synchronized)]</code> ç‰¹æ€§ï¼Œä¼šé€ æˆ JIT ç¼–è¯‘å™¨ç”¨ <code>Monitor.Entrer</code> å’Œ <code>Monitor.Exit</code> è°ƒç”¨åŒ…å›´æ–¹æ³•çš„æœ¬æœºä»£ç ã€‚å¦‚æœæ–¹æ³•æ˜¯å®ä¾‹æ–¹æ³•ï¼Œä¼šå°† <code>this</code> ä¼ ç»™ <code>Monitor</code> çš„è¿™äº›æ–¹æ³•ï¼Œé”å®šéšå¼å…¬å…±çš„é”ã€‚å¦‚æœæ–¹æ³•æ—¶é™æ€çš„ï¼Œå¯¹ç±»å‹çš„ç±»å‹å¯¹è±¡çš„å¼•ç”¨ä¼šä¼ ç»™è¿™äº›æ–¹æ³•ï¼Œé€ æˆé”å®š â€œAppDomain ä¸­ç«‹â€ çš„ç±»å‹ã€‚7. è°ƒç”¨ç±»å‹çš„ç±»å‹æ„é€ å™¨æ—¶ï¼ŒCLR è¦è·å–ç±»å‹å¯¹è±¡ä¸Šçš„ä¸€ä¸ªé”ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹åˆå§‹åŒ–ç±»å‹å¯¹è±¡åŠå…¶é™æ€å­—æ®µã€‚åŒæ ·åœ°ï¼Œè¿™ä¸ªç±»å‹å¯èƒ½ä»¥ â€œAppDomain ä¸­ç«‹â€ çš„æ–¹å¼åŠ è½½ï¼Œæ‰€ä»¥ä¼šå‡ºé—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå‡å®šç±»å‹æ„é€ å™¨çš„ä»£ç è¿›å…¥æ­»å¾ªç¯ï¼Œè¿›ç¨‹ä¸­çš„æ‰€æœ‰ AppDomain éƒ½æ— æ³•ä½¿ç”¨è¯¥ç±»å‹ã€‚å¦‚æœæ‰€æœ‰çº¿ç¨‹éƒ½å¸Œæœ›ä»¥åªè¯»æ–¹å¼è®¿é—®æ•°æ®ï¼Œå°±æ ¹æœ¬æ²¡æœ‰å¿…è¦é˜»å¡å®ƒä»¬ï¼›åº”è¯¥å…è®¸å®ƒä»¬å¹¶å‘åœ°è®¿é—®æ•°æ®ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹å¸Œæœ›ä¿®æ”¹æ•°æ®ï¼Œè¿™ä¸ªçº¿ç¨‹å°±éœ€è¦å¯¹æ•°æ®çš„ç‹¬å å¼è®¿é—®ã€‚ <code>ReaderWriterLockSlim</code> æ„é€ å°è£…äº†è§£å†³è¿™ä¸ªé—®é¢˜çš„é€»è¾‘ã€‚ <code>ReaderWriterLockSlim</code> çš„æ„é€ å™¨å…è®¸ä¼ é€’ä¸€ä¸ª <code>LockRecurionsPolicy</code> æ ‡å¿—ï¼Œå¦‚æœä¼ é€’ <code>SupportsRecursion</code> æ ‡å¿—ï¼Œé”å°±æ”¯æŒçº¿ç¨‹æ‰€æœ‰æƒå’Œé€’å½’è¡Œä¸ºã€‚å¦‚åŒæœ¬ç« æ—©äº›æ—¶å€™è®¨è®ºçš„é‚£æ ·ï¼Œè¿™äº›è¡Œä¸ºå¯¹é”çš„æ€§èƒ½æœ‰è´Ÿé¢å½±å“ã€‚æ‰€ä»¥ï¼Œå»ºè®®æ€»æ˜¯å‘æ„é€ å™¨ä¼ é€’ <code>LockRecursionPolicy.NoRecursion</code> ã€‚reader-writer é”æ”¯æŒçº¿ç¨‹æ‰€æœ‰æƒå’Œé€’å½’çš„ä»£ä»·éå¸¸é«˜æ˜‚ï¼Œå› ä¸ºé”å¿…é¡»è·Ÿè¸ªæ›¾å…è®¸è¿›å…¥é”çš„æ‰€æœ‰ reader çº¿ç¨‹ï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½å•ç‹¬ç»´æŠ¤é€’å½’è®¡æ•°ã€‚ <code>ReaderWriterLockSlim</code> ç±»æä¾›äº†ä¸€äº›é¢å¤–çš„æ–¹æ³• (å‰é¢æ²¡æœ‰åˆ—å‡º) å…è®¸ä¸€ä¸ª reader çº¿ç¨‹å‡çº§ä¸º writer çº¿ç¨‹ã€‚ä»¥åï¼Œçº¿ç¨‹å¯ä»¥æŠŠè‡ªå·±é™çº§å› reader çº¿ç¨‹ã€‚é”å¦‚æœæ”¯æŒè¿™ä¸ªè¡Œä¸ºï¼Œæ€§èƒ½ä¼šå¤§æ‰“æŠ˜æ‰£ã€‚çº¿ç¨‹å¹¶ä¸æ˜¯ç›´æ¥ä» reader å˜æˆ writer çš„ã€‚å½“æ—¶å¯èƒ½è¿˜æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è¯»å–ï¼Œè¿™äº›çº¿ç¨‹å¿…é¡»å®Œå…¨é€€å‡ºé”ã€‚åœ¨æ­¤ä¹‹åï¼Œå°è¯•å‡çº§çš„çº¿ç¨‹æ‰å…è®¸æˆä¸º writerã€‚è¿™ç›¸å½“äºå…ˆè®© reader çº¿ç¨‹é€€å‡ºé”ï¼Œå†ç«‹å³è·å–è¿™ä¸ªé”ä»¥è¿›è¡Œå†™å…¥ã€‚ä¸‹ä¸€ä¸ªç»“æ„æ˜¯ <code>System.Threading.CountdownEvent</code> ã€‚è¿™ä¸ªæ„é€ ä½¿ç”¨äº†ä¸€ä¸ª <code>ManualResetEventSlim</code> å¯¹è±¡ã€‚è¿™ä¸ªæ„é€ é˜»å¡ä¸€ä¸ªçº¿ç¨‹ï¼Œç›´åˆ°å®ƒçš„å†…éƒ¨è®¡æ•°å™¨å˜æˆ 0ã€‚ä»æŸç§è§’åº¦è¯´ï¼Œè¿™ä¸ªæ„é€ çš„è¡Œä¸ºå’Œ <code>Semaphore</code> çš„è¡Œä¸ºç›¸å ( <code>Semaphore</code> æ˜¯åœ¨è®¡æ•°ä¸º 0 æ—¶é˜»å¡çº¿ç¨‹)ã€‚ <code>System.Threading.Barrier</code> æ„é€ ç”¨äºè§£å†³ä¸€ä¸ªéå¸¸ç¨€æœ‰çš„é—®é¢˜ã€‚ <code>Barrier</code> æ§åˆ¶çš„ä¸€ç³»åˆ—çº¿ç¨‹éœ€è¦å¹¶è¡Œå·¥ä½œï¼Œä»è€Œåœ¨ä¸€ä¸ªç®—æ³•çš„ä¸åŒé˜¶æ®µæ¨è¿›ã€‚å½“ CLR ä½¿ç”¨å®ƒçš„åƒåœ¾å›æ”¶å™¨ (GC) çš„æœåŠ¡å™¨ç‰ˆæœ¬æ—¶ï¼ŒGC ç®—æ³•ä¸ºæ¯ä¸ªå†…æ ¸éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚è¿™äº›çº¿ç¨‹åœ¨ä¸åŒåº”ç”¨ç¨‹åºçº¿ç¨‹çš„æ ˆæ±‡æ€»å‘ä¸Šç§»åŠ¨ï¼Œå¹¶å‘æ ‡è®°å †ä¸­çš„å¯¹è±¡ã€‚æ¯ä¸ªçº¿ç¨‹å®Œæˆäº†å®ƒè‡ªå·±çš„é‚£ä¸€éƒ¨åˆ†å·¥ä½œä¹‹åï¼Œå¿…é¡»åœä¸‹æ¥ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆã€‚æ‰€æœ‰çº¿ç¨‹éƒ½æ ‡è®°å¥½å¯¹è±¡åï¼Œçº¿ç¨‹å°±å¯ä»¥å¹¶å‘åœ°å‹ç¼© (compact) å †çš„ä¸åŒéƒ¨åˆ†ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½å®Œæˆäº†å¯¹å®ƒçš„é‚£ä¸€éƒ¨åˆ†çš„å †çš„å‹ç¼©ä¹‹åï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½è¦åœ¨åº”ç”¨ç¨‹åºçš„çº¿ç¨‹çš„æ ˆä¸­ä¸Šè¡Œï¼Œå¯¹æ ¹è¿›è¡Œä¿®æ­£ï¼Œä½¿ä¹‹å¼•ç”¨å› ä¸ºå‹ç¼©è€Œå‘ç”Ÿäº†ç§»åŠ¨çš„å¯¹è±¡çš„æ–°ä½ç½®ã€‚åªæœ‰åœ¨æ‰€æœ‰çº¿ç¨‹éƒ½å®Œæˆè¿™ä¸ªå·¥ä½œä¹‹åï¼Œåƒåœ¾å›æ”¶å™¨çš„å·¥ä½œæ‰ç®—æ­£çœŸå®Œæˆï¼Œåº”ç”¨ç¨‹åºçš„çº¿ç¨‹ç°åœ¨å¯ä»¥æ¢å¤æ‰§è¡Œäº†ã€‚æ„é€  <code>Barrier</code> æ—¶è¦å‘Šè¯‰å®ƒæœ‰å¤šå°‘ä¸ªçº¿ç¨‹å‡†å¤‡å‚ä¸å·¥ä½œï¼Œè¿˜å¯ä¼ é€’ä¸€ä¸ª <code>Action&lt;Barrier&gt;</code> å§”æ‰˜æ¥å¼•ç”¨æ‰€æœ‰å‚ä¸è€…å®Œæˆä¸€ä¸ªé˜¶æ®µçš„å·¥ä½œåè¦è°ƒç”¨çš„ä»£ç ã€‚æ‰§è¡Œå¼‚æ­¥è®¡ç®—æˆ– I/O æ“ä½œæ—¶ï¼Œå°†æ•°æ®ä»ä¸€ä¸ªçº¿ç¨‹äº¤ç»™å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œåº”é¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æ•°æ®ã€‚å¦‚æœä¸èƒ½å®Œå…¨åšåˆ°è¿™ä¸€ç‚¹ï¼Œè¯·å°½é‡ä½¿ç”¨ <code>Volatile</code> å’Œ <code>Interlocked</code> çš„æ–¹æ³•ï¼Œå› ä¸ºå®ƒä»¬çš„é€Ÿåº¦å¾ˆå¿«ï¼Œè€Œä¸”ç»ä¸é˜»å¡çº¿ç¨‹ã€‚è¦é¿å…é˜»å¡çº¿ç¨‹ï¼Œå°±ä¸è¦åˆ»æ„åœ°ä¸ºçº¿ç¨‹æ‰“ä¸Šæ ‡ç­¾ã€‚ä¾‹å¦‚ï¼Œä¸è¦åˆ›å»ºä¸€ä¸ªæ‹¼å†™æ£€æŸ¥çº¿ç¨‹ã€ä¸€ä¸ªè¯­æ³•æ£€æŸ¥çº¿ç¨‹ã€ä¸€ä¸ªå¤„ç†ç‰¹å®šå®¢æˆ·ç«¯è¯·æ±‚çš„çº¿ç¨‹ç­‰ã€‚ä¸ºçº¿ç¨‹æ‰“ä¸Šæ ‡ç­¾ï¼Œå…¶å®æ˜¯åœ¨å‘Šè¯«è‡ªå·±è¯¥çº¿ç¨‹ä¸èƒ½åšå…¶ä»–ä»»ä½•äº‹æƒ…ã€‚ä½†ç”±äºçº¿ç¨‹æ˜¯å¦‚æ­¤æ˜‚è´µï¼Œæ‰€ä»¥ä¸èƒ½æŠŠå®ƒä»¬ä¸“é—¨ç”¨äºæŸä¸ªç›®çš„ã€‚ç›¸åï¼Œåº”é€šè¿‡çº¿ç¨‹æ± å°†çº¿ç¨‹å‡ºç§ŸçŸ­æš‚æ—¶é—´ã€‚æ‰€ä»¥æ­£ç¡®æ–¹å¼æ˜¯ä¸€ä¸ªçº¿ç¨‹æ± çº¿ç¨‹å¼€å§‹æ‹¼å†™æ£€æŸ¥ï¼Œå†æ”¹ä¸ºè¯­æ³•æ£€æŸ¥ï¼Œå†ä»£è¡¨ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚æ‰§è¡Œå·¥ä½œï¼Œä»¥æ­¤ç±»æ¨ã€‚å¦‚æœä¸€å®šè¦é˜»å¡çº¿ç¨‹ï¼Œä¸ºäº†åŒæ­¥åœ¨ä¸åŒ AppDomain æˆ–è¿›ç¨‹ä¸­è¿è¡Œçš„çº¿ç¨‹ï¼Œè¯·ä½¿ç”¨å†…æ ¸å¯¹è±¡æ„é€ ã€‚</p><h2 id="the-famous-double-check-locking-technique"><a class="anchor" href="#the-famous-double-check-locking-technique">#</a> The Famous Double-Check Locking Technique</h2><blockquote><p>There is a famous technique called double-check locking, which is used by developers who want to defer constructing a singleton object until an application requests it (sometimes called lazy initialization). If the application never requests the object, it never gets constructed, saving time and memory. A potential problem occurs when multiple threads request the singleton object simultaneously. In this case, some form of thread synchronization must be used to ensure that the singleton object gets constructed just once.</p></blockquote><blockquote><p>This technique is not famous because it is particularly interesting or useful. It is famous because there has been much written about it. This technique was used heavily in Java, and later it was discovered that Java couldnâ€™t guarantee that it would work everywhere. The famous document that describes the problem can be found on this webpage: <span class="exturl" data-url="aHR0cDovL3d3dy5jcy51bWQuZWR1L35wdWdoL2phdmEvbWVtb3J5TW9kZWwv">www.cs.umd.edu/~pugh/java/memoryModel/</span> DoubleCheckedLocking.html.</p></blockquote><blockquote><p>Anyway, youâ€™ll be happy to know that the CLR supports the double-check locking technique just fine because of its memory model and volatile field access (described in Chapter 29). Here is code that demonstrates how to implement the double-check locking technique in C#.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// s_lock is required for thread safety and having this object assumes that creating </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// the singleton object is more expensive than creating a System.Object object and that </span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// creating the singleton object may not be necessary at all. Otherwise, it is more </span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// efficient and easier to just create the singleton object in a class constructor</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Object</span> s_lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// This field will refer to the one Singleton object</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> s_value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Private constructor prevents any code outside this class from creating an instance </span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Code to initialize the one Singleton object goes here...</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// Public, static method that returns the Singleton object (creating it if necessary) </span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Singleton</span> <span class="token function">GetSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token comment">// If the Singleton was already created, just return it (this is fast)</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>s_value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> s_value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>s_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Not created, let 1 thread create it</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>s_value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// Still not created, create it</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token class-name">Singleton</span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token comment">// Save the reference in s_value (see discussion for details)</span></pre></td></tr><tr><td data-num="23"></td><td><pre> Volatile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">ref</span> s_value<span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>s_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token comment">// Return a reference to the one Singleton object </span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token keyword">return</span> s_value<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The idea behind the double-check locking technique is that a call to the GetSingleton method quickly checks the s_value field to see if the object has already been created, and if it has, the method returns a reference to it. The beautiful thing here is that no thread synchronization is required after the object has been constructed; the application will run very fast. On the other hand, if the first thread that calls the GetSingleton method sees that the object hasnâ€™t been created, it takes a thread synchronization lock to ensure that only one thread constructs the single object. This means that a performance hit occurs only the first time a thread queries the singleton object.</p></blockquote><blockquote><p>Now, let me explain why this pattern didnâ€™t work in Java. The Java Virtual Machine read the value of s_value into a CPU register at the beginning of the GetSingleton method and then just queried the register when evaluating the second if statement, causing the second if statement to always evaluate to true, and multiple threads ended up creating Singleton objects. Of course, this happened only if multiple threads called GetSingleton at exactly the same time, which in most applications is very unlikely. This is why it went undetected in Java for so long.</p></blockquote><blockquote><p>In the CLR, calling any lock method is a full memory fence, and any variable writes you have before the fence must complete before the fence and any variable reads after the fence must start after it. For the GetSingleton method, this means that the s_value field must be reread after the call to Monitor.Enter; it cannot be cached in a register across this method call.</p></blockquote><blockquote><p>Inside GetSingleton, you see the call to Volatile.Write. Hereâ€™s the problem that this is solving. Letâ€™s say that what you had inside the second if statement was the following line of code.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>s_value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This is what you'd ideally like to write</span></pre></td></tr></table></figure><blockquote><p>You would expect the compiler to produce code that allocates the memory for a Singleton, calls the constructor to initialize the fields, and then assigns the reference into the s_value field. Making a value visible to other threads is called publishing. But the compiler could do this instead: allocate memory for the Singleton, publish (assign) the reference into s_value, and then call the constructor. From a single threadâ€™s perspective, changing the order like this has no impact. But what if, after publishing the reference into s_value and before calling the constructor, another thread calls the GetSingleton method? This thread will see that s_value is not null and start to use the Singleton object, but its constructor has not finished executing yet! This can be a very hard bug to track down, especially because it is all due to timing.</p></blockquote><blockquote><p>The call to Volatile.Write fixes this problem. It ensures that the reference in temp can be published into s_value only after the constructor has finished executing. Another way to solve this problem would be to mark the s_value field with C#â€™s volatile keyword. This makes the write to s_value volatile, and again, the constructor has to finish running before the write can happen. Unfortunately, this makes all reads volatile, too, and because there is no need for this, you are hurting your performance with no benefit.</p></blockquote><blockquote><p>In the beginning of this section, I mentioned that the double-check locking technique is not that interesting. In my opinion, developers think it is cool, and they use it far more often than they should. In most scenarios, this technique actually hurts efficiency. Here is a much simpler version of the Singleton class that behaves the same as the previous version. This version does not use the double-check locking technique.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> s_value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Private constructor prevents any code outside this class from creating an instance </span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Code to initialize the one Singleton object goes here...</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Public, static method that returns the Singleton object (creating it if necessary) </span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Singleton</span> <span class="token function">GetSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> s_value<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Because the CLR automatically calls a typeâ€™s class constructor the first time code attempts to access a member of the class, the first time a thread queries Singletonâ€™s GetSingleton method, the CLR will automatically call the class constructor, which creates an instance of the object. Furthermore, the CLR already ensures that calls to a class constructor are thread safe. I explained all of this in Chapter 8. The one downside of this approach is that the type constructor is called when any member of a class is first accessed. If the Singleton type defined some other static members, then the Singleton object would be created when any one of them was accessed. Some people work around this problem by defining nested classes.</p></blockquote><blockquote><p>Let me show you a third way of producing a single Singleton object.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> s_value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Private constructor prevents any code outside this class from creating an instance </span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Code to initialize the one Singleton object goes here...</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// Public, static method that returns the Singleton object (creating it if necessary) </span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Singleton</span> <span class="token function">GetSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>s_value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> s_value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Create a new Singleton and root it if another thread didn't do it first</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">Singleton</span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> Interlocked<span class="token punctuation">.</span><span class="token function">CompareExchange</span><span class="token punctuation">(</span><span class="token keyword">ref</span> s_value<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// If this thread lost, then the second Singleton object gets GC'd</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">return</span> s_value<span class="token punctuation">;</span> <span class="token comment">// Return reference to the single object</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If multiple threads call GetSingleton simultaneously, then this version might create two (or more) Singleton objects. However, the call to Interlocked.CompareExchange ensures that only one of the references is ever published into the s_value field. Any object not rooted by this field will be garbage collected later on. Because, in most applications, it is unlikely that multiple threads will call GetSingleton at the same time, it is unlikely that more than one Singleton object will ever be created.</p></blockquote><blockquote><p>Now it might upset you that multiple Singleton objects could be created, but there are many benefits to this code. First, it is very fast. Second, it never blocks a thread; if a thread pool thread is blocked on a Monitor or any other kernel-mode thread synchronization construct, then the thread pool creates another thread to keep the CPUs saturated with work. So now, more memory is allocated and initialized and all the DLLs get a thread attach notification. With CompareExchange, this can never happen. Of course, you can use this technique only when the constructor has no side effects.</p></blockquote><blockquote><p>The FCL offers two types that encapsulate the patterns described in this section. The generic System.Lazy class looks like this (some methods are not shown).</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Lazy<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token function">Lazy</span><span class="token punctuation">(</span><span class="token class-name">Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> valueFactory<span class="token punctuation">,</span> <span class="token class-name">LazyThreadSafetyMode</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> IsValueCreated <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">T</span> Value <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>This code demonstrates how it works.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Create a lazy-initialization wrapper around getting the DateTime</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name">Lazy<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Lazy<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">ToLongTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>IsValueCreated<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns false because Value not queried yet</span></pre></td></tr><tr><td data-num="5"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// The delegate is invoked now</span></pre></td></tr><tr><td data-num="6"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>IsValueCreated<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns true because Value was queried</span></pre></td></tr><tr><td data-num="7"></td><td><pre> Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wait 10 seconds and display the time again</span></pre></td></tr><tr><td data-num="8"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// The delegate is NOT invoked now; same result</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When I run this, I get the following output.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>False</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">40</span><span class="token punctuation">:</span><span class="token number">42</span> PM</pre></td></tr><tr><td data-num="3"></td><td><pre>True</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">40</span><span class="token punctuation">:</span><span class="token number">42</span> PM ÃŸ Notice that the time did <span class="token keyword">not</span> change <span class="token number">10</span> seconds later</pre></td></tr></table></figure><blockquote><p>The preceding code constructed an instance of the Lazy class and passed one of the LazyThreadSafetyMode flags into it. Here is what these flags look like and what they mean.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">LazyThreadSafetyMode</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> None<span class="token punctuation">,</span> <span class="token comment">// No thread-safety support at all (good for GUI apps)</span></pre></td></tr><tr><td data-num="3"></td><td><pre> ExecutionAndPublication <span class="token comment">// Uses the double-check locking technique</span></pre></td></tr><tr><td data-num="4"></td><td><pre> PublicationOnly<span class="token punctuation">,</span> <span class="token comment">// Uses the Interlocked.CompareExchange technique</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>In some memory-constrained scenarios, you might not even want to create an instance of the Lazy class. Instead, you can call static methods of the System.Threading.LazyInitializer class. The class looks like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LazyInitializer</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// These two methods use Interlocked.CompareExchange internally: </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">EnsureInitialized</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">T</span> target<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">EnsureInitialized</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">T</span> target<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> valueFactory<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// These two methods pass the syncLock to Monitor's Enter and Exit methods internally</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">EnsureInitialized</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">T</span> target<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name">Boolean</span> initialized<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">ref</span> <span class="token class-name">Object</span> syncLock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">EnsureInitialized</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">T</span> target<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name">Boolean</span> initialized<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">ref</span> <span class="token class-name">Object</span> syncLock<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> valueFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Also, being able to explicitly specify a synchronization object to the EnsureInitialized methodâ€™s syncLock parameter allows multiple initialization functions and fields to be protected by the same lock.</p></blockquote><blockquote><p>Here is an example using a method from this class.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Because name is null, the delegate runs and initializes name</span></pre></td></tr><tr><td data-num="4"></td><td><pre> LazyInitializer<span class="token punctuation">.</span><span class="token function">EnsureInitialized</span><span class="token punctuation">(</span><span class="token keyword">ref</span> name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"Jeffrey"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Displays "Jeffrey"</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Because name is not null, the delegate does not run; name doesnâ€™t change</span></pre></td></tr><tr><td data-num="7"></td><td><pre> LazyInitializer<span class="token punctuation">.</span><span class="token function">EnsureInitialized</span><span class="token punctuation">(</span><span class="token keyword">ref</span> name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"Richter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Also displays "Jeffrey" </span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>ğŸ’¡å°ç»“ï¼šåŒæ£€é” (Double-Check Locking) æ˜¯ä¸€ä¸ªéå¸¸è‘—åçš„æŠ€æœ¯ï¼Œå¼€å‘äººå‘˜ç”¨å®ƒå°†å•å®ä¾‹ (singleton) å¯¹è±¡çš„æ„é€ æ¨è¿Ÿåˆ°åº”ç”¨ç¨‹åºé¦–æ¬¡è¯·æ±‚è¯¥å¯¹è±¡æ—¶è¿›è¡Œã€‚è¿™æœ‰æ—¶ä¹Ÿç§°ä¸º<strong>å»¶è¿Ÿåˆå§‹åŒ–</strong> (lazy Initialization)ã€‚å¦‚æœåº”ç”¨ç¨‹åºæ°¸è¿œä¸è¯·æ±‚å¯¹è±¡ï¼Œå¯¹è±¡å°±æ°¸è¿œä¸ä¼šæ„é€ ï¼Œä»è€ŒèŠ‚çœäº†æ—¶é—´å’Œå†…å­˜ã€‚CLR å¾ˆå¥½åœ°æ”¯æŒåŒæ£€é”æŠ€æœ¯ï¼Œè¿™åº”è¯¥å½’åŠŸäº CLR çš„å†…å­˜æ¨¡å‹ä»¥åŠ <code>volatile</code> å­—æ®µè®¿é—®ã€‚åŒæ£€é”æŠ€æœ¯èƒŒåçš„æ€è·¯åœ¨äºï¼Œå¯¹ <code>GetSingleton</code> æ–¹æ³•çš„ä¸€ä¸ªè°ƒç”¨å¯ä»¥å¿«é€Ÿåœ°æ£€æŸ¥ <code>s_value</code> å­—æ®µï¼Œåˆ¤æ–­å¯¹è±¡æ˜¯å¦åˆ›å»ºã€‚å¦‚æœæ˜¯ï¼Œæ–¹æ³•å°±è¿”å›å¯¹å®ƒçš„å¼•ç”¨ã€‚è¿™é‡Œçš„å¦™å¤„åœ¨äºï¼Œå¦‚æœå¯¹è±¡å·²ç»æ„é€ å¥½ï¼Œå°±ä¸éœ€è¦çº¿ç¨‹åŒæ­¥ï¼›åº”ç”¨ç¨‹åºä¼šè¿è¡Œå¾—éå¸¸å¿«ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœè°ƒç”¨ <code>GetSingleton</code> æ–¹æ³•çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹å‘ç°å¯¹è±¡è¿˜æ²¡æœ‰åˆ›å»ºï¼Œå°±ä¼šè·å–ä¸€ä¸ªçº¿ç¨‹åŒæ­¥é”æ¥ç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ„é€ å•å®ä¾‹å¯¹è±¡ã€‚è¿™æ„å‘³ç€åªæœ‰çº¿ç¨‹ç¬¬ä¸€æ¬¡æŸ¥è¯¢å•å®ä¾‹å¯¹è±¡æ—¶ï¼Œæ‰ä¼šå‡ºç°æ€§èƒ½ä¸Šçš„æŸå¤±ã€‚åœ¨ CLR ä¸­ï¼Œå¯¹ä»»ä½•é”æ–¹æ³•çš„è°ƒç”¨éƒ½æ„æˆäº†ä¸€ä¸ªå®Œæ•´çš„å†…å­˜æ …æ ï¼Œåœ¨æ …æ ä¹‹å‰å†™å…¥çš„ä»»ä½•å˜é‡å¿…é¡»åœ¨æ …æ ä¹‹å‰å®Œæˆï¼›åœ¨æ …æ ä¹‹åçš„ä»»ä½•å˜é‡è¯»å–éƒ½å¿…é¡»åœ¨æ …æ ä¹‹åå¼€å§‹ã€‚å¯¹äº <code>GetSingleton</code> æ–¹æ³•ï¼Œè¿™æ„å‘³ç€ <code>s_value</code> å­—æ®µçš„å€¼å¿…é¡»åœ¨è°ƒç”¨äº† <code>Monitor.Enter</code> ä¹‹åé‡æ–°è¯»å–ï¼›è°ƒç”¨å‰ç¼“å­˜åˆ°å¯„å­˜å™¨ä¸­çš„ä¸œè¥¿ä½œä¸äº†æ•°ã€‚ <code>GetSingleton</code> å†…éƒ¨æœ‰ä¸€ä¸ª <code>Volatile.Write</code> è°ƒç”¨ã€‚ä½¿ä¸€ä¸ªå€¼å¯¹å…¶ä»–çº¿ç¨‹å¯è§ç§°ä¸º<strong>å‘å¸ƒ</strong> (publishing)ã€‚å¦‚æœä¸è¿™ä¹ˆå†™ï¼Œç¼–è¯‘å™¨å¯èƒ½è¿™æ ·åšï¼šä¸º <code>Singleton</code> åˆ†é…å†…å­˜ï¼Œå°†å¼•ç”¨å‘å¸ƒåˆ° (èµ‹ç»™) <code>s_value</code> ï¼Œå†è°ƒç”¨æ„é€ å™¨ï¼Œä»è€Œå½±å“äº†çº¿ç¨‹å®‰å…¨æ€§ã€‚å¯¹ <code>Volatile.Write</code> çš„è°ƒç”¨ä¿®æ­£äº†è¿™ä¸ªé—®é¢˜ã€‚å®ƒä¿è¯ <code>temp</code> ä¸­çš„å¼•ç”¨åªæœ‰åœ¨æ„é€ å™¨ç»“æŸæ‰§è¡Œä¹‹åï¼Œæ‰å‘å¸ƒåˆ° <code>s_value</code> ä¸­ã€‚FCL æœ‰ä¸¤ä¸ªç±»å‹å°è£…äº†æœ¬ä¹¦æè¿°çš„æ¨¡å¼ã€‚ä¸€ä¸ªæ˜¯æ³›å‹ <code>Syste.Lazy</code> ç±»ï¼Œå†…å­˜æœ‰é™å¯èƒ½ä¸æƒ³åˆ›å»º <code>Lazy</code> ç±»çš„å®ä¾‹ï¼Œè¿™æ—¶å¯è°ƒç”¨ <code>System.Threading.LazyInitializer</code> ç±»çš„é™æ€æ–¹æ³•ã€‚</p><h2 id="the-condition-variable-pattern"><a class="anchor" href="#the-condition-variable-pattern">#</a> The Condition Variable Pattern</h2><blockquote><p>Letâ€™s say that a thread wants to execute some code when a complex condition is true. One option would be to let the thread spin continuously, repeatedly testing the condition. But this wastes CPU time, and it is also not possible to atomically test multiple variables that are making up the complex condition. Fortunately, there is a pattern that allows threads to efficiently synchronize their operations based on a complex condition.</p></blockquote><blockquote><p>This pattern is called the condition variable pattern, and we use it via the following methods defined inside the Monitor class.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Monitor</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Wait</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Wait</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Int32</span> millisecondsTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Pulse</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">PulseAll</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Here is what the pattern looks like.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">ConditionVariablePattern</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Object</span> m_lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">Boolean</span> m_condition <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Thread1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Acquire a mutual-exclusive lock</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// While under the lock, test the complex condition "atomically"</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_condition<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// If condition is not met, wait for another thread to change the condition</span></pre></td></tr><tr><td data-num="9"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Temporarily release lock so other threads can get it</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// The condition was met, process the data...</span></pre></td></tr><tr><td data-num="12"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Permanently release lock</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Thread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Acquire a mutual-exclusive lock</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token comment">// Process data and modify the condition...</span></pre></td></tr><tr><td data-num="17"></td><td><pre> m_condition <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token comment">// Monitor.Pulse(m_lock); // Wakes one waiter AFTER lock is released</span></pre></td></tr><tr><td data-num="19"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">PulseAll</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wakes all waiters AFTER lock is released</span></pre></td></tr><tr><td data-num="20"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Release lock</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>In this code, the thread executing the Thread1 method enters a mutual-exclusive lock and then tests a condition. Here, I am just checking a Boolean field, but this condition can be arbitrarily complex. For example, you could check to see if it is a Tuesday in March and if a certain collection object has 10 elements in it. If the condition is false, then you want the thread to spin on the condition, but spinning wastes CPU time, so instead, the thread calls Wait. Wait releases the lock so that another thread can get it and blocks the calling thread.</p></blockquote><blockquote><p>The Thread2 method shows code that the second thread executes. It calls Enter to take ownership of the lock, processes some data, which results in changing the state of the condition, and then calls Pulse or PulseAll, which will unblock a thread from its Wait call. Pulse unblocks the longest waiting thread (if any), whereas PulseAll unblocks all waiting threads (if any). However, any unblocked threads donâ€™t wake up yet. The thread executing Thread2 must call Monitor.Exit, allowing the lock to be owned by another thread. Also, if PulseAll is called, the other threads do not unblock simultaneously. When a thread that called Wait is unblocked, it becomes the owner of the lock, and because it is a mutual-exclusive lock, only one thread at a time can own it. Other threads can get it after an owning thread calls Wait or Exit.</p></blockquote><blockquote><p>When the thread executing Thread1 wakes, it loops around and tests the condition again. If the condition is still false, then it calls Wait again. If the condition is true, then it processes the data as it likes and ultimately calls Exit, leaving the lock so other threads can get it. The nice thing about this pattern is that it is possible to test several variables making up a complex condition using simple synchronization logic (just one lock), and multiple waiting threads can all unblock without causing any logic failure, although the unblocking threads might waste some CPU time.</p></blockquote><blockquote><p>Here is an example of a thread-safe queue that can have multiple threads enqueuing and dequeuing items to it. Note that threads attempting to dequeue an item block until an item is available for them to process.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedQueue<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Object</span> m_lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Queue<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> m_queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Queue<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Enqueue</span><span class="token punctuation">(</span><span class="token class-name">T</span> item<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// After enqueuing an item, wake up any/all waiters</span></pre></td></tr><tr><td data-num="8"></td><td><pre> m_queue<span class="token punctuation">.</span><span class="token function">Enqueue</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">PulseAll</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">T</span> <span class="token function">Dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// Loop while the queue is empty (the condition)</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">while</span> <span class="token punctuation">(</span>m_queue<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token comment">// Dequeue an item from the queue and return it for processing</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token class-name">T</span> item <span class="token operator">=</span> m_queue<span class="token punctuation">.</span><span class="token function">Dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token keyword">return</span> item<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>ğŸ’¡å°ç»“ï¼šè¿™ä¸ªæ¨¡å¼çš„å¦™å¤„åœ¨äºï¼Œå¯ä»¥ä½¿ç”¨ç®€å•çš„åŒæ­¥é€»è¾‘ (åªæ˜¯ä¸€ä¸ªé”) æ¥æµ‹è¯•æ„æˆä¸€ä¸ªå¤åˆæ¡ä»¶çš„å‡ ä¸ªå˜é‡ï¼Œè€Œä¸”å¤šä¸ªæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥å…¨éƒ¨è§£é™¤é˜»å¡ï¼Œè€Œä¸ä¼šé€ æˆä»»ä½•é€»è¾‘é”™è¯¯ã€‚å”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯è§£é™¤çº¿ç¨‹çš„é˜»å¡å¯èƒ½æµªè´¹ä¸€äº› CPU æ—¶é—´ã€‚</p><h2 id="asynchronous-synchronization"><a class="anchor" href="#asynchronous-synchronization">#</a> Asynchronous Synchronization</h2><blockquote><p>Iâ€™m not terribly fond of any of the thread synchronization constructs that use kernel-mode primitives, because all of these primitives exist to block a thread from running, and threads are just too expensive to create and not have them run. Here is an example that hopefully clarifies the problem.</p></blockquote><blockquote><p>Imagine a website into which clients make requests. When a client request arrives, a thread pool thread starts processing the clientâ€™s request. Letâ€™s say that this client wants to modify some data in the server in a thread-safe way, so it acquires a reader-writer lock for writing. Letâ€™s pretend that this lock is held for a long time. As the lock is held, another client request comes in, so that thread pool creates a new thread for the client request, and then the thread blocks trying to acquire the reader-writer lock for reading. In fact, as more and more client requests come in, the thread pool creates more and more threads. Thus, all these threads are just blocking themselves on the lock. The server is spending all its time creating threads so that they can stop running! This server does not scale well at all.</p></blockquote><blockquote><p>Then, to make matters worse, when the writer thread releases the lock, all the reader threads unblock simultaneously and get to run, but now there may be lots of threads trying to run on relatively few CPUs, so Windows is context switching between the threads constantly. The result is that the workload is not being processed as quickly as it could because of all the overhead associated with the context switches.</p></blockquote><blockquote><p>If you look over all the constructs shown in this chapter, many of the problems that these constructs are trying to solve can be much better accomplished using the Task class discussed in Chapter 27. Take the Barrier class, for example: you could spawn several Task objects to work on a phase and then, when all these tasks complete, you could continue with one or more other Task objects. Compared to many of the constructs shown in this chapter, tasks have many advantages:</p><ul><li><p>Tasks use much less memory than threads and they take much less time to create and destroy.</p></li><li><p>The thread pool automatically scales the tasks across available CPUs.</p></li><li><p>As each task completes a phase, the thread running that task goes back to the thread pool, where it can do other work, if any is available for it.</p></li><li><p>The thread pool has a process-global view of tasks and, as such, it can better schedule these tasks, reducing the number of threads in the process and also reducing context switching.</p></li></ul></blockquote><blockquote><p>Locks are popular but, when held for a long time, they introduce significant scalability issues. What would really be useful is if we had asynchronous synchronization constructs where your code indicates that it wants a lock. If the thread canâ€™t have it, it can just return and perform some other work, rather than blocking indefinitely. Then, when the lock becomes available, your code somehow gets resumed, so it can access the resource that the lock protects. I came up with this idea after trying to solve a big scalability problem for a customer, and I then sold the patent rights to Microsoft. In 2009, the Patent Office issued the patent (Patent #7,603,502).</p></blockquote><blockquote><p>The SemaphoreSlim class implements this idea via its WaitAsync method. Here is the signature for the most complicated overload of this method.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">WaitAsync</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> millisecondsTimeout<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>With this, you can synchronize access to a resource asynchronously (without blocking any thread).</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">AccessResourceViaAsyncSynchronization</span><span class="token punctuation">(</span><span class="token class-name">SemaphoreSlim</span> asyncLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// TODO: Execute whatever code you want here...</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">await</span> asyncLock<span class="token punctuation">.</span><span class="token function">WaitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Request exclusive access to a resource via its lock</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// When we get here, we know that no other thread is accessing the resource</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// TODO: Access the resource (exclusively)...</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// When done accessing resource, relinquish lock so other code can access the resource</span></pre></td></tr><tr><td data-num="7"></td><td><pre> asyncLock<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// TODO: Execute whatever code you want here...</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The SemaphoreSlimâ€™s WaitAsync method is very useful but, of course, it gives you semaphore semantics. Usually, youâ€™ll create the SemaphoreSlim with a maximum count of 1, which gives you mutual-exclusive access to the resource that the SemaphoreSlim protects. So, this is similar to the behavior you get when using Monitor, except that SemaphoreSlim does not offer thread ownership and recursion semantics (which is good).</p></blockquote><blockquote><p>But, what about reader-writer semantics? Well, the .NET Framework has a class called ConcurrentExclusiveSchedulerPair, which looks like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentExclusiveSchedulerPair</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token function">ConcurrentExclusiveSchedulerPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">TaskScheduler</span> ExclusiveScheduler <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">TaskScheduler</span> ConcurrentScheduler <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Other methods not shown...</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>An instance of this class comes with two TaskScheduler objects that work together to provide reader/writer semantics when scheduling tasks. Any tasks scheduled by using ExclusiveScheduler will execute one at a time, as long as no tasks are running that were scheduled using the ConcurrentScheduler. And, any tasks scheduled using the ConcurrentScheduler can all run simultaneously, as long as no tasks are running that were scheduled by using the ExclusiveScheduler. Here is some code that demonstrates the use of this class.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConcurrentExclusiveSchedulerDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> cesp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConcurrentExclusiveSchedulerPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> tfExclusive <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskFactory</span><span class="token punctuation">(</span>cesp<span class="token punctuation">.</span>ExclusiveScheduler<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> tfConcurrent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskFactory</span><span class="token punctuation">(</span>cesp<span class="token punctuation">.</span>ConcurrentScheduler<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> operation <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> operation <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> operation<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> exclusive <span class="token operator">=</span> operation <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// For demo, I make 2 exclusive &amp; 3 concurrent</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">(</span><span class="token class-name">exclusive <span class="token punctuation">?</span></span> tfExclusive <span class="token punctuation">:</span> tfConcurrent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"&#123;0&#125; access"</span><span class="token punctuation">,</span> exclusive <span class="token punctuation">?</span> <span class="token string">"exclusive"</span> <span class="token punctuation">:</span> <span class="token string">"concurrent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// TODO: Do exclusive write or concurrent read computation here...</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Unfortunately, the .NET Framework doesnâ€™t come with an asynchronous lock offering reader-writer semantics. However, I have built such a class, which I call AsyncOneManyLock. You use it the same way that youâ€™d use a SemaphoreSlim. Here is an example.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">AccessResourceViaAsyncSynchronization</span><span class="token punctuation">(</span><span class="token class-name">AsyncOneManyLock</span> asyncLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// TODO: Execute whatever code you want here...</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Pass OneManyMode.Exclusive or OneManyMode.Shared for wanted concurrent access</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">await</span> asyncLock<span class="token punctuation">.</span><span class="token function">AcquireAsync</span><span class="token punctuation">(</span>OneManyMode<span class="token punctuation">.</span>Shared<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Request shared access</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// When we get here, no threads are writing to the resource; other threads may be reading</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// TODO: Read from the resource...</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// When done accessing resource, relinquish lock so other code can access the resource</span></pre></td></tr><tr><td data-num="8"></td><td><pre> asyncLock<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// TODO: Execute whatever code you want here...</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The following is the code for my AsyncOneManyLock.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">OneManyMode</span> <span class="token punctuation">&#123;</span> Exclusive<span class="token punctuation">,</span> Shared <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AsyncOneManyLock</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">region</span> Lock code</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">SpinLock</span> m_lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SpinLock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Don't use readonly with a SpinLock</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token class-name">Boolean</span> taken <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> m_lock<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span><span class="token keyword">ref</span> taken<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> m_lock<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">region</span> Lock state and helper methods</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">Int32</span> m_state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name">Boolean</span> IsFree <span class="token punctuation">&#123;</span> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> m_state <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name">Boolean</span> IsOwnedByWriter <span class="token punctuation">&#123;</span> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> m_state <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name">Boolean</span> IsOwnedByReaders <span class="token punctuation">&#123;</span> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> m_state <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name">Int32</span> <span class="token function">AddReaders</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> m_state <span class="token operator">+=</span> count<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name">Int32</span> <span class="token function">SubtractReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token operator">--</span>m_state<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MakeWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> m_state <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MakeFree</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> m_state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token comment">// For the no-contention case to improve performance and reduce memory consumption</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Task</span> m_noContentionAccessGranter<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// Each waiting writers wakes up via their own TaskCompletionSource queued here</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Queue<span class="token punctuation">&lt;</span>TaskCompletionSource<span class="token punctuation">&lt;</span>Object<span class="token punctuation">></span><span class="token punctuation">></span></span> m_qWaitingWriters <span class="token operator">=</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Queue<span class="token punctuation">&lt;</span>TaskCompletionSource<span class="token punctuation">&lt;</span>Object<span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token comment">// All waiting readers wake up by signaling a single TaskCompletionSource</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">TaskCompletionSource<span class="token punctuation">&lt;</span>Object<span class="token punctuation">></span></span> m_waitingReadersSignal <span class="token operator">=</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskCompletionSource<span class="token punctuation">&lt;</span>Object<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">Int32</span> m_numWaitingReaders <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token keyword">public</span> <span class="token function">AsyncOneManyLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre> m_noContentionAccessGranter <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromResult</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Object<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">WaitAsync</span><span class="token punctuation">(</span><span class="token class-name">OneManyMode</span> mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token class-name">Task</span> accressGranter <span class="token operator">=</span> m_noContentionAccessGranter<span class="token punctuation">;</span> <span class="token comment">// Assume no contention</span></pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token keyword">case</span> OneManyMode<span class="token punctuation">.</span>Exclusive<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>IsFree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token function">MakeWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// No contention</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token comment">// Contention: Queue new writer task &amp; return it so writer waits</span></pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> tcs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskCompletionSource<span class="token punctuation">&lt;</span>Object<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre> m_qWaitingWriters<span class="token punctuation">.</span><span class="token function">Enqueue</span><span class="token punctuation">(</span>tcs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> accressGranter <span class="token operator">=</span> tcs<span class="token punctuation">.</span>Task<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token keyword">case</span> OneManyMode<span class="token punctuation">.</span>Shared<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>IsFree <span class="token operator">||</span> <span class="token punctuation">(</span>IsOwnedByReaders <span class="token operator">&amp;&amp;</span> m_qWaitingWriters<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token function">AddReaders</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// No contention</span></pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Contention</span></pre></td></tr><tr><td data-num="48"></td><td><pre> <span class="token comment">// Contention: Increment waiting readers &amp; return reader task so reader waits</span></pre></td></tr><tr><td data-num="49"></td><td><pre> m_numWaitingReaders<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre> accressGranter <span class="token operator">=</span> m_waitingReadersSignal<span class="token punctuation">.</span>Task<span class="token punctuation">.</span><span class="token function">ContinueWith</span><span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token keyword">return</span> accressGranter<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre> <span class="token class-name">TaskCompletionSource<span class="token punctuation">&lt;</span>Object<span class="token punctuation">></span></span> accessGranter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Assume no code is released</span></pre></td></tr><tr><td data-num="59"></td><td><pre> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>IsOwnedByWriter<span class="token punctuation">)</span> <span class="token function">MakeFree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// The writer left</span></pre></td></tr><tr><td data-num="61"></td><td><pre> <span class="token keyword">else</span> <span class="token function">SubtractReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// A reader left</span></pre></td></tr><tr><td data-num="62"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>IsFree<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre> <span class="token comment">// If free, wake 1 waiting writer or all waiting readers</span></pre></td></tr><tr><td data-num="64"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>m_qWaitingWriters<span class="token punctuation">.</span>Count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre> <span class="token function">MakeWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre> accessGranter <span class="token operator">=</span> m_qWaitingWriters<span class="token punctuation">.</span><span class="token function">Dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m_numWaitingReaders <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre> <span class="token function">AddReaders</span><span class="token punctuation">(</span>m_numWaitingReaders<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre> m_numWaitingReaders <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre> accessGranter <span class="token operator">=</span> m_waitingReadersSignal<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre> <span class="token comment">// Create a new TCS for future readers that need to wait</span></pre></td></tr><tr><td data-num="72"></td><td><pre> m_waitingReadersSignal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskCompletionSource<span class="token punctuation">&lt;</span>Object<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre> <span class="token comment">// Wake the writer/reader outside the lock to reduce</span></pre></td></tr><tr><td data-num="77"></td><td><pre> <span class="token comment">// chance of contention improving performance</span></pre></td></tr><tr><td data-num="78"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>accessGranter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> accessGranter<span class="token punctuation">.</span><span class="token function">SetResult</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>As I said, this code never blocks a thread. The reason is because it doesnâ€™t use any kernel constructs internally. Now, it does use a SpinLock that internally uses user-mode constructs. But, if you recall from the discussion about SpinLocks in Chapter 29, a SpinLock can only be used when held over sections of code that are guaranteed to execute in a short and finite amount of time. If you examine my WaitAsync method, youâ€™ll notice that all I do while holding the lock is some integer calculations and comparison and perhaps construct a TaskCompletionSource and add it to a queue. This canâ€™t take very long at all, so the lock is guaranteed to be held for a very short period of time.</p></blockquote><blockquote><p>Similarly, if you examine my Release method, youâ€™ll notice that all I do is some integer calculations, a comparison and perhaps dequeue a TaskCompletionSource or possibly construct a TaskCompletionSource. Again, this canâ€™t take very long either. The end result is that I feel very comfortable using a SpinLock to guard access to the Queue. Therefore, threads never block when using this lock, which allows me to build responsive and scalable software.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šå’Œæœ¬ç« å±•ç¤ºçš„å¤§é‡æ„é€ ç›¸æ¯”ï¼Œä»»åŠ¡å…·æœ‰ä¸‹è¿°è®¸å¤šä¼˜åŠ¿ï¼š1. ä»»åŠ¡ä½¿ç”¨çš„å†…å­˜æ¯”çº¿ç¨‹å°‘å¾—å¤šï¼Œåˆ›å»ºå’Œé”€æ¯æ‰€éœ€çš„æ—¶é—´ä¹Ÿå°‘å¾—å¤šã€‚2. çº¿ç¨‹æ± æ ¹æ®å¯ç”¨ CPU æ•°é‡è‡ªåŠ¨ä¼¸ç¼©ä»»åŠ¡è§„æ¨¡ã€‚3. æ¯ä¸ªä»»åŠ¡å®Œæˆä¸€ä¸ªé˜¶æ®µåï¼Œè¿è¡Œä»»åŠ¡çš„çº¿ç¨‹å›åˆ°çº¿ç¨‹æ± ï¼Œåœ¨å“ªé‡Œèƒ½æ¥å—æ–°ä»»åŠ¡ã€‚4. æ¯ä¸ªä»»åŠ¡å®Œæˆä¸€ä¸ªé˜¶æ®µåï¼Œè¿è¡Œä»»åŠ¡çš„çº¿ç¨‹å›åˆ°çº¿ç¨‹æ± ï¼Œåœ¨å“ªé‡Œèƒ½æ¥å—æ–°ä»»åŠ¡ã€‚5. çº¿ç¨‹æ± æ˜¯ç«™åœ¨æ•´ä¸ªè¿›ç¨‹çš„é«˜åº¦è§‚å¯Ÿä»»åŠ¡ã€‚æ‰€ä»¥ï¼Œå®ƒèƒ½æ›´å¥½åœ°è°ƒåº¦è¿™äº›ä»»åŠ¡ï¼Œå‡å°‘è¿›ç¨‹ä¸­çš„çº¿ç¨‹æ•°ï¼Œå¹¶å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚é”å¾ˆæµè¡Œï¼Œä½†é•¿æ—¶é—´æ‹¥æœ‰ä¼šå¸¦æ¥å·¨å¤§çš„ä¼¸ç¼©æ€§é—®é¢˜ã€‚å¦‚æœä»£ç èƒ½é€šè¿‡å¼‚æ­¥çš„åŒæ­¥æ„é€ æŒ‡å‡ºå®ƒæƒ³è¦ä¸€ä¸ªé”ï¼Œé‚£ä¹ˆä¼šéå¸¸æœ‰ç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœçº¿ç¨‹å¾—ä¸åˆ°é”ï¼Œå¯ç›´æ¥è¿”å›å¹¶æ‰§è¡Œå…¶ä»–å·¥ä½œï¼Œè€Œä¸å¿…åœ¨é‚£é‡Œå‚»å‚»åœ°é˜»å¡ã€‚ä»¥åå½“é”å¯ç”¨æ—¶ï¼Œä»£ç å¯æ¢å¤æ‰§è¡Œå¹¶è®¿é—®é”æ‰€ä¿æŠ¤çš„èµ„æºã€‚ <code>SemaphoreSlim</code> çš„ <code>WaitAsync</code> æ–¹æ³•å¾ˆæœ‰ç”¨ï¼Œä½†å®ƒæä¾›çš„æ˜¯ä¿¡å·é‡è¯­ä¹‰ã€‚ä¸€èˆ¬åˆ›å»ºæœ€å¤§è®¡æ•°ä¸º 1 çš„ <code>SemaphoreSlim</code> ï¼Œä»è€Œå¯¹ <code>SemaphoreSlim</code> ä¿æŠ¤çš„èµ„æºè¿›è¡Œäº’æ–¥è®¿é—®ã€‚æ‰€ä»¥ï¼Œè¿™å’Œä½¿ç”¨ <code>Monitor</code> æ—¶çš„è¡Œä¸ºç›¸ä¼¼ï¼Œåªæ˜¯ <code>SemaphoreSlim</code> ä¸æ”¯æŒçº¿ç¨‹æ‰€æœ‰æƒå’Œé€’å½’è¯­ä¹‰ (è¿™æ˜¯å¥½äº‹)ã€‚.NET Framework æä¾›äº† <code>ConcurrentExclusiveSchedulerPair</code> ç±»ï¼Œè¿™ä¸ªç±»çš„å®ä¾‹å¸¦æœ‰ä¸¤ä¸ª <code>TaskScheduler</code> å¯¹è±¡ï¼Œå®ƒä»¬åœ¨ä»£ç”¨ä»»åŠ¡æ—¶è´Ÿè´£æä¾› reader/writer è¯­ä¹‰ã€‚åªè¦å½“å‰æ²¡æœ‰è¿è¡Œä½¿ç”¨ <code>ConcurrentScheduler</code> è°ƒåº¦çš„ä»»åŠ¡ï¼Œä½¿ç”¨ <code>ExclusiveScheduler</code> è°ƒåº¦çš„ä»»ä½•ä»»åŠ¡å°†ç‹¬å å¼åœ°è¿è¡Œ (ä¸€æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ª)ã€‚å¦å¤–ï¼Œåªè¦å½“å‰æ²¡æœ‰è¿è¡Œä½¿ç”¨ <code>ExclusiveScheduler</code> è°ƒåº¦çš„ä»»åŠ¡ï¼Œä½¿ç”¨ <code>ConcurrentScheduler</code> è°ƒåº¦çš„ä»»åŠ¡å°±å¯åŒæ—¶è¿è¡Œ (ä¸€æ¬¡è¿è¡Œå¤šä¸ª)ã€‚é—æ†¾çš„æ˜¯ï¼Œ.NET Framework æ²¡æœ‰æä¾›å…·æœ‰ reader-writer è¯­ä¹‰çš„å¼‚æ­¥é”ã€‚ä½œè€…æ„å»ºäº†è¿™æ ·çš„ä¸€ä¸ªç±»ï¼Œç§°ä¸º <code>AsyncOneManyLock</code> ã€‚å®ƒçš„ç”¨æ³•å’Œ <code>SemaphoreSlim</code> ä¸€æ ·ã€‚çº¿ç¨‹åœ¨ä½¿ç”¨è¿™ç§é”æ—¶æ°¸è¿œä¸ä¼šé˜»å¡ï¼Œèƒ½æ„å»ºå“åº”çµæ•çš„ã€å¯ä¼¸ç¼©çš„è½¯ä»¶ã€‚</p><h2 id="the-concurrent-collection-classes"><a class="anchor" href="#the-concurrent-collection-classes">#</a> The Concurrent Collection Classes</h2><blockquote><p>The FCL ships with four thread-safe collection classes, all of which are in the System.Collections. Concurrent namespace: ConcurrentQueue, ConcurrentStack, ConcurrentDictionary, and ConcurrentBag. Here is what some of their most commonly used members look like.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Process items in a first-in, first-out order (FIFO)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentQueue<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IProducerConsumerCollection<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">,</span> </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">ICollection</span><span class="token punctuation">,</span> <span class="token class-name">IEnumerable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token function">ConcurrentQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Enqueue</span><span class="token punctuation">(</span><span class="token class-name">T</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryDequeue</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">T</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> Count <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerator<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token function">GetEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// Process items in a last-in, first-out order (LIFO)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentStack<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IProducerConsumerCollection<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">,</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">ICollection</span><span class="token punctuation">,</span> <span class="token class-name">IEnumerable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">public</span> <span class="token function">ConcurrentStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Push</span><span class="token punctuation">(</span><span class="token class-name">T</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryPop</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">T</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> Count <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerator<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token function">GetEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">// An unordered set of items where duplicates are allowed</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentBag<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IProducerConsumerCollection<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">,</span> </span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">ICollection</span><span class="token punctuation">,</span> <span class="token class-name">IEnumerable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">public</span> <span class="token function">ConcurrentBag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token class-name">T</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryTake</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">T</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> Count <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerator<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token function">GetEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">// An unordered set of key/value pairs</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span>TKey<span class="token punctuation">,</span> TValue<span class="token punctuation">></span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDictionary<span class="token punctuation">&lt;</span>TKey<span class="token punctuation">,</span> TValue<span class="token punctuation">></span></span><span class="token punctuation">,</span></span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token class-name">ICollection<span class="token punctuation">&lt;</span>KeyValuePair<span class="token punctuation">&lt;</span>TKey<span class="token punctuation">,</span> TValue<span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>KeyValuePair<span class="token punctuation">&lt;</span>TKey<span class="token punctuation">,</span> TValue<span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token class-name">IDictionary</span><span class="token punctuation">,</span> <span class="token class-name">ICollection</span><span class="token punctuation">,</span> <span class="token class-name">IEnumerable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token keyword">public</span> <span class="token function">ConcurrentDictionary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryAdd</span><span class="token punctuation">(</span><span class="token class-name">TKey</span> key<span class="token punctuation">,</span> <span class="token class-name">TValue</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token class-name">TKey</span> key<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name">TValue</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">TValue</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token class-name">TKey</span> key<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryUpdate</span><span class="token punctuation">(</span><span class="token class-name">TKey</span> key<span class="token punctuation">,</span> <span class="token class-name">TValue</span> newValue<span class="token punctuation">,</span> <span class="token class-name">TValue</span> comparisonValue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryRemove</span><span class="token punctuation">(</span><span class="token class-name">TKey</span> key<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name">TValue</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">TValue</span> <span class="token function">AddOrUpdate</span><span class="token punctuation">(</span><span class="token class-name">TKey</span> key<span class="token punctuation">,</span> <span class="token class-name">TValue</span> addValue<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token class-name">Func<span class="token punctuation">&lt;</span>TKey<span class="token punctuation">,</span> TValue<span class="token punctuation">></span></span> updateValueFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">TValue</span> <span class="token function">GetOrAdd</span><span class="token punctuation">(</span><span class="token class-name">TKey</span> key<span class="token punctuation">,</span> <span class="token class-name">TValue</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> Count <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerator<span class="token punctuation">&lt;</span>KeyValuePair<span class="token punctuation">&lt;</span>TKey<span class="token punctuation">,</span> TValue<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>All these collection classes are non-blocking. That is, if a thread tries to extract an element when no such element exists, the thread returns immediately; the thread does not block waiting for an element to appear. This is why methods like TryDequeue, TryPop, TryTake, and TryGetValue all return true if an item was obtained and returns false, if not.</p></blockquote><blockquote><p>These non-blocking collections are not necessarily lock-free. The ConcurrentDictionary class uses Monitor internally, but the lock is held for a very short time while manipulating the item in the collection. ConcurrentQueue and ConcurrentStack are lock-free; these both internally use Interlocked methods to manipulate the collection. A single ConcurrentBag object internally consists of a mini-collection object per thread. When a thread adds an item to the bag, Interlocked methods are used to add the item to the calling threadâ€™s mini-collection. When a thread tries to extract an element from the bag, the bag checks the calling threadâ€™s mini-collection for the item. If the item is there, then an Interlocked method is used to extract the item. If the threadâ€™s mini-collection doesnâ€™t have the item, then a Monitor is taken internally to extract an item from another threadâ€™s mini-collection. We say that the thread is stealing the item from another thread.</p></blockquote><blockquote><p>Youâ€™ll notice that all the concurrent classes offer a GetEnumerator method, which is typically used with C#â€™s foreach statement, but can also be used with Language Integrated Query (LINQ). For the ConcurrentStack, ConcurrentQueue, and ConcurrentBag, the GetEnumerator method takes a snapshot of the collectionâ€™s contents and returns elements from this snapshot; the contents of the actual collection may change while enumerating over the snapshot. ConcurrentDictionaryâ€™s GetEnumerator method does not take a snapshot of its contents, so the contents of the dictionary may change while enumerating over the dictionary; beware of this. Also note that the Count property returns the number of elements that are in the collection at the moment you query it. The count may immediately become incorrect if other threads are adding or removing elements from the collection at the same time.</p></blockquote><blockquote><p>Three of the concurrent collection classes, ConcurrentStack, ConcurrentQueue, and ConcurrentBag, implement the IProducerConsumerCollection interface, which is defined as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IProducerConsumerCollection<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">ICollection</span><span class="token punctuation">,</span> <span class="token class-name">IEnumerable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token return-type class-name">Boolean</span> <span class="token function">TryAdd</span><span class="token punctuation">(</span><span class="token class-name">T</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token return-type class-name">Boolean</span> <span class="token function">TryTake</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">T</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token return-type class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CopyTo</span><span class="token punctuation">(</span><span class="token class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> array<span class="token punctuation">,</span> <span class="token class-name">Int32</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Any class that implements this interface can be turned into a blocking collection, where threads producing (adding) items will block if the collection is full and threads consuming (removing) items will block if the collection is empty. Of course, Iâ€™d try to avoid using blocking collections because their purpose in life is to block threads. To turn a non-blocking collection into a blocking collection, you construct a System.Collections.Concurrent.BlockingCollection class by passing in a reference to a non-blocking collection to its constructor. The BlockingCollection class looks like this (some methods are not shown).</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlockingCollection<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">ICollection</span><span class="token punctuation">,</span> <span class="token class-name">IEnumerable</span><span class="token punctuation">,</span> <span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token function">BlockingCollection</span><span class="token punctuation">(</span><span class="token class-name">IProducerConsumerCollection<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> collection<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name">Int32</span> boundedCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token class-name">T</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryAdd</span><span class="token punctuation">(</span><span class="token class-name">T</span> item<span class="token punctuation">,</span> <span class="token class-name">Int32</span> msTimeout<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CompleteAdding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">T</span> <span class="token function">Take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryTake</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">T</span> item<span class="token punctuation">,</span> <span class="token class-name">Int32</span> msTimeout<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> BoundedCapacity <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> Count <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> IsAddingCompleted <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// true if CompleteAdding is called</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> IsCompleted <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// true if IsAddingComplete is true and Count==0</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token function">GetConsumingEnumerable</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CopyTo</span><span class="token punctuation">(</span><span class="token class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> array<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When you construct a BlockingCollection, the boundedCapacity parameter indicates the maximum number of items that you want in the collection. If a thread calls Add when the underlying collection has reached its capacity, the producing thread will block. If preferred, the producing thread can call TryAdd, passing a timeout (in milliseconds) and/or a CancellationToken, so that the thread blocks until the item is added, the timeout expires, or the CancellationToken is canceled (see Chapter 27 for more information about the CancellationToken class).</p></blockquote><blockquote><p>The BlockingCollection class implements the IDisposable interface. When you call Dispose, it calls Dispose on the underlying collection. It also disposes of two SemaphoreSlim objects that the class uses internally to block producers and consumers.</p></blockquote><blockquote><p>When producers will not be adding any more items into the collection, a producer should call the CompleteAdding method. This will signal the consumers that no more items will be produced. Specifically, this causes a foreach loop that is using GetConsumingEnumerable to terminate. The following example code demonstrates how to set up a producer/consumer scenario and signal completion.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> bl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BlockingCollection<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConcurrentQueue<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// A thread pool thread will do the consuming</span></pre></td></tr><tr><td data-num="4"></td><td><pre> ThreadPool<span class="token punctuation">.</span><span class="token function">QueueUserWorkItem</span><span class="token punctuation">(</span>ConsumeItems<span class="token punctuation">,</span> bl<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Add 5 items to the collection</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> item <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> item <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> item<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Producing: "</span> <span class="token operator">+</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> bl<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Tell the consuming thread(s) that no more items will be added to the collection</span></pre></td></tr><tr><td data-num="11"></td><td><pre> bl<span class="token punctuation">.</span><span class="token function">CompleteAdding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// For testing purposes</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConsumeItems</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> bl <span class="token operator">=</span> <span class="token punctuation">(</span>BlockingCollection<span class="token operator">&lt;</span>Int32<span class="token operator">></span><span class="token punctuation">)</span> o<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token comment">// Block until an item shows up, then process it</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> item <span class="token keyword">in</span> bl<span class="token punctuation">.</span><span class="token function">GetConsumingEnumerable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Consuming: "</span> <span class="token operator">+</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// The collection is empty and no more items are going into it</span></pre></td></tr><tr><td data-num="21"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"All items have been consumed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When I execute the preceding code, I get the following output.</p></blockquote><pre><code class="language-cmd">Producing: 0
Producing: 1
Producing: 2
Producing: 3
Producing: 4
Consuming: 0
Consuming: 1
Consuming: 2
Consuming: 3
Consuming: 4
All items have been consumed
</code></pre><blockquote><p>If you run this yourself, the Producing and Consuming lines could be interspersed, but the All items have been consumed line will always be last.</p></blockquote><blockquote><p>The BlockingCollection class also has static AddToAny, TryAddToAny, TakeFromAny, and TryTakeFromAny methods. All of these methods take a BlockingCollection[], in addition to an item, a timeout, and a CancellationToken. The (Try)AddToAny methods cycle through all the collections in the array until they find a collection that can accept the item because it is below capacity. The (Try)TakeFromAny methods cycle through all the collections in the array until they find a collection to remove an item from.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šFCL è‡ªå¸¦ 4 ä¸ªçº¿ç¨‹å®‰å…¨çš„é›†åˆç±»ï¼Œå…¨éƒ¨åœ¨ <code>System.Collections.Concurrent</code> å‘½åç©ºé—´ä¸­å®šä¹‰ã€‚å®ƒä»¬æ˜¯ <code>ConcurrentQueue</code> ï¼Œ <code>ConcurrentStack</code> ï¼Œ <code>ConcurrentDictionary</code> å’Œ <code>ConcurrentBag</code> ã€‚æ‰€æœ‰è¿™äº›é›†åˆç±»éƒ½æ˜¯ â€œéé˜»å¡â€ çš„ã€‚æ¢è¨€ä¹‹ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è¯•å›¾æå–ä¸€ä¸ªä¸å­˜åœ¨çš„å…ƒç´  (æ•°æ®é¡¹)ï¼Œçº¿ç¨‹ä¼šç«‹å³è¿”å›ï¼›çº¿ç¨‹ä¸ä¼šé˜»å¡åœ¨é‚£é‡Œï¼Œç­‰ç€ä¸€ä¸ªå…ƒç´ çš„å‡ºç°ã€‚æ­£æ˜¯ç”±äºè¿™ä¸ªåŸå› ï¼Œæ‰€ä»¥å¦‚æœè·å–äº†ä¸€ä¸ªæ•°æ®é¡¹ï¼Œåƒ <code>TryDequeue</code> ï¼Œ <code>TryPop</code> ï¼Œ <code>TryTake</code> å’Œ <code>TryGetValue</code> è¿™æ ·çš„æ–¹æ³•å…¨éƒ½è¿”å› <code>true</code> ï¼›å¦åˆ™è¿”å› <code>false</code> ã€‚ä¸€ä¸ªé›†åˆ â€œéé˜»å¡â€ï¼Œå¹¶ä¸æ„å‘³ç€å®ƒå°±å°±ä¸éœ€è¦é”äº†ã€‚ <code>ConcurrentDictionary</code> ç±»åœ¨å†…éƒ¨ä½¿ç”¨äº† <code>Monitor</code> ã€‚ ä½†æ˜¯ï¼Œå¯¹é›†åˆä¸­çš„é¡¹è¿›è¡Œæ“ä½œæ—¶ï¼Œé”åªè¢«å æœ‰æçŸ­çš„æ—¶é—´ã€‚ <code>ConcurrentQueue</code> å’Œ <code>ConcurrentStack</code> ç¡®å®ä¸éœ€è¦é”ï¼›å®ƒä»¬ä¸¤ä¸ªåœ¨å†…éƒ¨éƒ½ä½¿ç”¨ <code>Interlocked</code> çš„æ–¹æ³•æ¥æ“çºµé›†åˆã€‚ä¸€ä¸ª <code>ConcurrentBag</code> å¯¹è±¡ (ä¸€ä¸ª bag) ç”±å¤§é‡è¿·ä½ é›†åˆå¯¹è±¡æ„æˆï¼Œæ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªã€‚çº¿ç¨‹å°†ä¸€ä¸ªé¡¹æ·»åŠ åˆ° bag ä¸­æ—¶ï¼Œå°±ç”¨ <code>Interlocked</code> çš„æ–¹æ³•å°†è¿™ä¸ªé¡¹æ·»åŠ åˆ°è°ƒç”¨çº¿ç¨‹çš„è¿·ä½ é›†åˆä¸­ã€‚ä¸€ä¸ªçº¿ç¨‹è¯•å›¾ä» bag ä¸­æå–ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œbag å°±æ£€æŸ¥è°ƒç”¨çº¿ç¨‹çš„è¿·ä½ é›†åˆï¼Œè¯•å›¾ä»ä¸­å–å‡ºæ•°æ®é¡¹ã€‚å¦‚æœæ•°æ®é¡¹åœ¨é‚£é‡Œï¼Œå°±ç”¨ä¸€ä¸ª <code>Interlocked</code> æ–¹æ³•æå–è¿™ä¸ªé¡¹ã€‚å¦‚æœä¸åœ¨ï¼Œå°±åœ¨å†…éƒ¨è·å–ä¸€ä¸ª <code>Monitor</code> ï¼Œä»¥ä¾¿ä»å¦ä¸€ä¸ªçº¿ç¨‹çš„è¿·ä½ é›†åˆæå–ä¸€ä¸ªé¡¹ã€‚è¿™ç§°ä¸ºä¸€ä¸ªçº¿ç¨‹ä»å¦ä¸€ä¸ªçº¿ç¨‹ â€œçªƒå–â€ ä¸€ä¸ªæ•°æ®é¡¹ã€‚æ³¨æ„ï¼Œæ‰€æœ‰å¹¶å‘é›†åˆç±»éƒ½æä¾›äº† <code>GetEnumerator</code> æ–¹æ³•ï¼Œå®ƒä¸€èˆ¬ç”¨äº C# çš„ <code>foreach</code> è¯­å¥ï¼Œä½†ä¹Ÿå¯ç”¨äº LINQã€‚å¯¹äº <code>ConcurrentStack</code> ï¼Œ <code>ConcurrentQueue</code> å’Œ <code>ConcurrentBag</code> ç±»ï¼Œ <code>GetEnumerator</code> æ–¹æ³•è·å–é›†åˆå†…å®¹çš„ä¸€ä¸ª â€œå¿«ç…§â€ï¼Œå¹¶ä»è¿™ä¸ªå¿«ç…§è¿”å›å…ƒç´ ï¼›å®é™…é›†åˆçš„å†…å®¹å¯èƒ½åœ¨ä½¿ç”¨å¿«ç…§æšä¸¾æ—¶å‘ç”Ÿæ”¹å˜ã€‚ <code>ConcurrentDictionary</code> çš„ <code>GetEnumerator</code> æ–¹æ³•ä¸è·å–å®ƒçš„å†…å®¹çš„å¿«ç…§ã€‚å› æ­¤ï¼Œåœ¨æšä¸¾å­—å…¸æœŸé—´ï¼Œå­—å…¸çš„å†…å®¹å¯èƒ½æ”¹å˜ï¼›è¿™ä¸€ç‚¹åŠ¡å¿…æ³¨æ„ã€‚è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œ <code>Count</code> å±æ€§è¿”å›çš„æ˜¯æŸ¥è¯¢æ—¶é›†åˆä¸­çš„å…ƒç´ æ•°é‡ã€‚å¦‚æœå…¶ä»–çº¿ç¨‹åŒæ—¶æ­£åœ¨é›†åˆä¸­å¢åˆ å…ƒç´ ï¼Œè¿™ä¸ªè®¡æ•°å¯èƒ½é©¬ä¸Šå°±å˜å¾—ä¸æ­£ç¡®äº†ã€‚ <code>ConcurrentStack</code> ï¼Œ <code>ConcurrentQueue</code> å’Œ <code>ConcurrentBag</code> è¿™ä¸‰ä¸ªå¹¶å‘é›†åˆç±»éƒ½å®ç°äº† <code>IProducerConsumerCollection</code> æ¥å£ã€‚å®ç°äº†è¿™ä¸ªæ¥å£çš„ä»»ä½•ç±»éƒ½èƒ½è½¬å˜æˆä¸€ä¸ªé˜»å¡é›†åˆã€‚å¦‚æœé›†åˆå·²æ»¡ï¼Œé‚£ä¹ˆè´Ÿè´£ç”Ÿäº§ (æ·»åŠ ) æ•°æ®é¡¹çš„çº¿ç¨‹ä¼šé˜»å¡ï¼›å¦‚æœé›†åˆå·²ç©ºï¼Œé‚£ä¹ˆè´Ÿè´£æ¶ˆè´¹ (ç§»é™¤) æ•°æ®é¡¹çš„çº¿ç¨‹ä¼šé˜»å¡ã€‚è¦å°†éé˜»å¡çš„é›†åˆè½¬å˜æˆé˜»å¡é›†åˆï¼Œéœ€è¦æ„é€ ä¸€ä¸ª <code>System.Collecitons.Concurrent.BlockingCollection</code> ç±»ï¼Œå‘å®ƒçš„æ„é€ å™¨ä¼ é€’å¯¹éé˜»å¡é›†åˆçš„å¼•ç”¨ã€‚æ„é€ ä¸€ä¸ª <code>BlockingCollection</code> æ—¶ï¼Œ <code>boundedCapacity</code> å‚æ•°æŒ‡å‡ºä½ æƒ³åœ¨é›†åˆä¸­æœ€å¤šå®¹çº³å¤šå°‘ä¸ªæ•°æ®é¡¹ã€‚åœ¨åŸºç¡€é›†åˆå·²æ»¡çš„æ—¶å€™ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ <code>Add</code> ï¼Œç”Ÿäº§çº¿ç¨‹å°±ä¼šé˜»å¡ã€‚å¦‚æœæ„¿æ„ï¼Œç”Ÿäº§çº¿ç¨‹å¯è°ƒç”¨ <code>TryAdd</code> ï¼Œä¼ é€’ä¸€ä¸ªè¶…æ—¶å€¼ (ä»¥æ¯«ç§’ä¸ºå•ä½) å’Œ / æˆ–ä¸€ä¸ª <code>CancellationToken</code> ï¼Œä½¿çº¿ç¨‹ä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æ•°æ®é¡¹æˆåŠŸæ·»åŠ ã€è¶…æ—¶åˆ°æœŸæˆ–è€… <code>CancellationToken</code> è¢«å–æ¶ˆã€‚ <code>BlockingCollection</code> ç±»å®ç°äº† <code>IDisposable</code> æ¥å£ã€‚è°ƒç”¨ <code>Dispose</code> æ—¶ï¼Œè¿™ä¸ª <code>Dispose</code> ä¼šè°ƒç”¨åŸºç¡€é›†åˆçš„ <code>Dispose</code> ã€‚å®ƒè¿˜ä¼šå¯¹ç±»å†…éƒ¨ç”¨äºé˜»å¡ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä¸¤ä¸ª <code>SemaphoreSlim</code> å¯¹è±¡è¿›è¡Œæ¸…ç†ã€‚ç”Ÿäº§è€…ä¸å†å‘é›†åˆæ·»åŠ æ›´å¤šçš„é¡¹æ—¶ï¼Œç”Ÿäº§è€…åº”è°ƒç”¨ <code>CompleteAdding</code> æ–¹æ³•ã€‚è¿™ä¼šå‘æ¶ˆè´¹è€…å‘å‡ºä¿¡å·ï¼Œè®©å®ƒä»¬çŸ¥é“ä¸ä¼šå†ç”Ÿäº§æ›´å¤šçš„é¡¹äº†ã€‚å…·ä½“åœ°è¯´ï¼Œè¿™ä¼šé€ æˆæ­£åœ¨ä½¿ç”¨ <code>GetConsumingEnumerable</code> çš„ä¸€ä¸ª <code>foreach</code> å¾ªç¯ç»ˆæ­¢ã€‚ <code>BlockingCollection</code> ç±»è¿˜æä¾›äº†é™æ€ <code>AddToAny</code> ï¼Œ <code>TryAddToAny</code> ï¼Œ <code>TakeFromAny</code> å’Œ <code>TryTakeFromAny</code> æ–¹æ³•ã€‚æ‰€æœ‰è¿™äº›æ–¹æ³•éƒ½è·å–ä¸€ä¸ª <code>BlockingCollection&lt;T&gt;[]</code> ï¼Œä»¥åŠä¸€ä¸ªæ•°æ®é¡¹ã€ä¸€ä¸ªè¶…æ—¶å€¼ä»¥åŠä¸€ä¸ª <code>CancellationToken</code> ã€‚ <code>(Try)AddToAny</code> æ–¹æ³•éå†æ•°ç»„ä¸­çš„æ‰€æœ‰é›†åˆï¼Œç›´åˆ°å‘ç°å› ä¸ºå®¹é‡è¿˜æ²¡æœ‰åˆ°è¾¾ (è¿˜æ²¡æœ‰æ»¡)ï¼Œè€Œèƒ½å¤Ÿæ¥å—æ•°æ®é¡¹çš„ä¸€ä¸ªé›†åˆã€‚ <code>(Try)TakeFromAny</code> æ–¹æ³•åˆ™éå†æ•°ç»„ä¸­çš„æ‰€æœ‰é›†åˆï¼Œç›´åˆ°å‘ç°ä¸€ä¸ªèƒ½ä»ä¸­ç§»é™¤ä¸€ä¸ªæ•°æ®é¡¹çš„é›†åˆã€‚</p><div class="tags"><a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag"><i class="ic i-tag"></i> è¯»ä¹¦ç¬”è®°</a> <a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C#</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2023-02-10 21:46:31" itemprop="dateModified" datetime="2023-02-10T21:46:31+08:00">2023-02-10</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(ï¿£â–½ï¿£)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Sakupinera WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/images/alipay.png" alt="Sakupinera Alipay"><p>Alipay</p></div><div><img data-src="/images/paypal.png" alt="Sakupinera PayPal"><p>PayPal</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Sakupinera <i class="ic i-at"><em>@</em></i>Sakupinera</li><li class="link"><strong>Post link: </strong><a href="http://sakupinera.github.io/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/" title="CLR via C# - Chapter 30 Hybrid Thread Synchronization">http://sakupinera.github.io/2023/02/10/csharp/clr-via-csharp/Chapter 30 Hybrid Thread Synchronization Constructs/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2023/02/09/csharp/clr-via-csharp/Chapter%2029%20Primitive%20Thread%20Synchronization%20Constructs/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipet4bz0yj20zk0m8e81.jpg" title="CLR via C# - Chapter 29 Primitive Thread Synchronization"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 29 Primitive Thread Synchronization</h3></a></div><div class="item right"><a href="/2023/03/20/cpp/design-patterns/Design%20Patterns/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicliierfjj20zk0m8npd.jpg" title="è®¾è®¡æ¨¡å¼ï¼ˆDesign Patternsï¼‰"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> Design-Patterns</span><h3>è®¾è®¡æ¨¡å¼ï¼ˆDesign Patternsï¼‰</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#chapter-30-hybrid-thread-synchronization-constructs"><span class="toc-number">1.</span> <span class="toc-text">Chapter 30 Hybrid Thread Synchronization Constructs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#a-simple-hybrid-lock"><span class="toc-number">1.1.</span> <span class="toc-text">A Simple Hybrid Lock</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spinning-thread-ownership-and-recursion"><span class="toc-number">1.2.</span> <span class="toc-text">Spinning, Thread Ownership, and Recursion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hybrid-constructs-in-the-framework-class-library"><span class="toc-number">1.3.</span> <span class="toc-text">Hybrid Constructs in the Framework Class Library</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#the-manualreseteventslim-and-semaphoreslim-classes"><span class="toc-number">1.3.1.</span> <span class="toc-text">The ManualResetEventSlim and SemaphoreSlim Classes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-monitor-class-and-sync-blocks"><span class="toc-number">1.3.2.</span> <span class="toc-text">The Monitor Class and Sync Blocks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-readerwriterlockslim-class"><span class="toc-number">1.3.3.</span> <span class="toc-text">The ReaderWriterLockSlim Class</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-onemanylock-class"><span class="toc-number">1.3.4.</span> <span class="toc-text">The OneManyLock Class</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-countdownevent-class"><span class="toc-number">1.3.5.</span> <span class="toc-text">The CountdownEvent Class</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-barrier-class"><span class="toc-number">1.3.6.</span> <span class="toc-text">The Barrier Class</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#thread-synchronization-construct-summary"><span class="toc-number">1.3.7.</span> <span class="toc-text">Thread Synchronization Construct Summary</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-famous-double-check-locking-technique"><span class="toc-number">1.4.</span> <span class="toc-text">The Famous Double-Check Locking Technique</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-condition-variable-pattern"><span class="toc-number">1.5.</span> <span class="toc-text">The Condition Variable Pattern</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#asynchronous-synchronization"><span class="toc-number">1.6.</span> <span class="toc-text">Asynchronous Synchronization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-concurrent-collection-classes"><span class="toc-number">1.7.</span> <span class="toc-text">The Concurrent Collection Classes</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%201%20The%20CLR%E2%80%99s%20Execution%20Model/" rel="bookmark" title="CLR via C# - Chapter 1 The CLRâ€™s Execution Model">CLR via C# - Chapter 1 The CLRâ€™s Execution Model</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%202%20Building,%20Packaging,%20Deploying,%20and%20Administering%20Applications%20and%20Types/" rel="bookmark" title="CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types">CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%203%20Shared%20Assemblies%20and%20Strongly%20Named%20Assemblies/" rel="bookmark" title="CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies">CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies</a></li><li><a href="/2022/09/27/csharp/clr-via-csharp/Chapter%204%20Type%20Fundamentals/" rel="bookmark" title="CLR via C# - Chapter 4 Type Fundamentals">CLR via C# - Chapter 4 Type Fundamentals</a></li><li><a href="/2022/10/15/csharp/clr-via-csharp/Chapter%205%20Primitive,%20Reference,%20and%20Value%20%20Types/" rel="bookmark" title="CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals">CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals</a></li><li><a href="/2022/10/21/csharp/clr-via-csharp/Chapter%206%20Type%20and%20Member%20Basics/" rel="bookmark" title="CLR via C# - Chapter 6 Type and Member Basics">CLR via C# - Chapter 6 Type and Member Basics</a></li><li><a href="/2022/10/24/csharp/clr-via-csharp/Chapter%207%20Constants%20and%20Fields/" rel="bookmark" title="CLR via C# - Chapter 7 Constants and Fields">CLR via C# - Chapter 7 Constants and Fields</a></li><li><a href="/2022/10/25/csharp/clr-via-csharp/Chapter%208%20Methods/" rel="bookmark" title="CLR via C# - Chapter 8 Methods">CLR via C# - Chapter 8 Methods</a></li><li><a href="/2022/10/27/csharp/clr-via-csharp/Chapter%209%20Parameters/" rel="bookmark" title="CLR via C# - Chapter 9 Parameters">CLR via C# - Chapter 9 Parameters</a></li><li><a href="/2022/10/28/csharp/clr-via-csharp/Chapter%2010%20Properties/" rel="bookmark" title="CLR via C# - Chapter 10 Properties">CLR via C# - Chapter 10 Properties</a></li><li><a href="/2022/10/29/csharp/clr-via-csharp/Chapter%2011%20Events/" rel="bookmark" title="CLR via C# - Chapter 11 Events">CLR via C# - Chapter 11 Events</a></li><li><a href="/2022/11/02/csharp/clr-via-csharp/Chapter%2012%20Generics/" rel="bookmark" title="CLR via C# - Chapter 12 Generics">CLR via C# - Chapter 12 Generics</a></li><li><a href="/2022/11/04/csharp/clr-via-csharp/Chapter%2013%20Interfaces/" rel="bookmark" title="CLR via C# - Chapter 13 Interfaces">CLR via C# - Chapter 13 Interfaces</a></li><li><a href="/2022/11/16/csharp/clr-via-csharp/Chapter%2014%20Chars,%20Strings,%20and%20Working%20%20with%20Text/" rel="bookmark" title="CLR via C# - Chapter 14 Chars, Strings, and Working with Text">CLR via C# - Chapter 14 Chars, Strings, and Working with Text</a></li><li><a href="/2022/11/17/csharp/clr-via-csharp/Chapter%2015%20Enumerated%20Types%20and%20Bit%20Flags/" rel="bookmark" title="CLR via C# - Chapter 15 Enumerated Types and Bit Flags">CLR via C# - Chapter 15 Enumerated Types and Bit Flags</a></li><li><a href="/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/" rel="bookmark" title="CLR via C# - Chapter 16 Arrays">CLR via C# - Chapter 16 Arrays</a></li><li><a href="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/" rel="bookmark" title="CLR via C# - Chapter 17 Delegates">CLR via C# - Chapter 17 Delegates</a></li><li><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" rel="bookmark" title="CLR via C# - Chapter 18 Custom Attributes">CLR via C# - Chapter 18 Custom Attributes</a></li><li><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" rel="bookmark" title="CLR via C# - Chapter 19 Nullable Value Types">CLR via C# - Chapter 19 Nullable Value Types</a></li><li><a href="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/" rel="bookmark" title="CLR via C# - Chapter 20 Exceptions and State Management">CLR via C# - Chapter 20 Exceptions and State Management</a></li><li><a href="/2022/11/27/csharp/clr-via-csharp/Chapter%2021%20The%20Managed%20Heap%20and%20Garbage%20%20Collection/" rel="bookmark" title="CLR via C# - Chapter 21 The Managed Heap and Garbage  Collection">CLR via C# - Chapter 21 The Managed Heap and Garbage Collection</a></li><li><a href="/2022/11/28/csharp/clr-via-csharp/Chapter%2022%20CLR%20Hosting%20and%20AppDomains/" rel="bookmark" title="CLR via C# - Chapter 22 CLR Hosting and AppDomains">CLR via C# - Chapter 22 CLR Hosting and AppDomains</a></li><li><a href="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/" rel="bookmark" title="CLR via C# - Chapter 23 Assembly Loading and Reflection">CLR via C# - Chapter 23 Assembly Loading and Reflection</a></li><li><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" rel="bookmark" title="CLR via C# - Chapter 24 Runtime Serialization">CLR via C# - Chapter 24 Runtime Serialization</a></li><li><a href="/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/" rel="bookmark" title="CLR via C# - Chapter 25 Interoperating with WinRT Components">CLR via C# - Chapter 25 Interoperating with WinRT Components</a></li><li><a href="/2023/02/06/csharp/clr-via-csharp/Chapter%2026%20Thread%20Basics/" rel="bookmark" title="CLR via C# - Chapter 26 Thread Basics">CLR via C# - Chapter 26 Thread Basics</a></li><li><a href="/2023/02/07/csharp/clr-via-csharp/Chapter%2027%20Compute-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations">CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations</a></li><li><a href="/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 28 IO-Bound Asynchronous Operations">CLR via C# - Chapter 28 IO-Bound Asynchronous Operations</a></li><li><a href="/2023/02/09/csharp/clr-via-csharp/Chapter%2029%20Primitive%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 29 Primitive Thread Synchronization">CLR via C# - Chapter 29 Primitive Thread Synchronization</a></li><li class="active"><a href="/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 30 Hybrid Thread Synchronization">CLR via C# - Chapter 30 Hybrid Thread Synchronization</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Sakupinera" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Sakupinera</p><div class="description" itemprop="description">ä¿æŒä½ çš„å†³å¿ƒï¼</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">89</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">17</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">8</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Nha3VwaW5lcmE=" title="https:&#x2F;&#x2F;github.com&#x2F;sakupinera"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9zYWt1cGluZXJh" title="https:&#x2F;&#x2F;twitter.com&#x2F;sakupinera"><i class="ic i-twitter"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTQwNzIyOTA3MQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;407229071"><i class="ic i-cloud-music"></i></span> <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMjIzMDczOTg/c3BtX2lkX2Zyb209MzMzLjEwMDcuMC4w" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;22307398?spm_id_from&#x3D;333.1007.0.0"><i class="ic i-bilibili"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/games/" rel="section"><i class="ic i-flag"></i>games</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-person"></i>About</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2023/02/09/csharp/clr-via-csharp/Chapter%2029%20Primitive%20Thread%20Synchronization%20Constructs/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2023/03/20/cpp/design-patterns/Design%20Patterns/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/GAMES101/" title="In GAMES101">GAMES101</a></div><span><a href="/2023/08/20/computer-graphics/games101/%E9%A2%9C%E8%89%B2%E4%B8%8E%E6%84%9F%E7%9F%A5/" title="GAMES101 - Color and Perceptionï¼ˆé¢œè‰²ä¸æ„ŸçŸ¥ï¼‰">GAMES101 - Color and Perceptionï¼ˆé¢œè‰²ä¸æ„ŸçŸ¥ï¼‰</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/" title="CLR via C# - Chapter 16 Arrays">CLR via C# - Chapter 16 Arrays</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/GAMES101/" title="In GAMES101">GAMES101</a></div><span><a href="/2022/09/30/computer-graphics/games101/%E7%9D%80%E8%89%B2/" title="GAMES101 - Shadingï¼ˆç€è‰²ï¼‰">GAMES101 - Shadingï¼ˆç€è‰²ï¼‰</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/10/24/csharp/clr-via-csharp/Chapter%207%20Constants%20and%20Fields/" title="CLR via C# - Chapter 7 Constants and Fields">CLR via C# - Chapter 7 Constants and Fields</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2023/02/07/csharp/clr-via-csharp/Chapter%2027%20Compute-Bound%20Asynchronous%20Operations/" title="CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations">CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/08/28/linux/learn-linux/%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8Vim/" title="LearnLinux - æ–‡æœ¬ç¼–è¾‘å™¨Vim">LearnLinux - æ–‡æœ¬ç¼–è¾‘å™¨Vim</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/27/csharp/clr-via-csharp/Chapter%2021%20The%20Managed%20Heap%20and%20Garbage%20%20Collection/" title="CLR via C# - Chapter 21 The Managed Heap and Garbage  Collection">CLR via C# - Chapter 21 The Managed Heap and Garbage Collection</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2023/01/03/cpp/cpp-primer/Chapter%2011%20Associative%20Containers/" title="C++ Primer - Chapter 11 Associative Containers">C++ Primer - Chapter 11 Associative Containers</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2023/01/09/cpp/cpp-primer/Chapter%2017%20Specialized%20Library%20Facilities/" title="C++ Primer - Chapter 17 Specialized Library Facilities">C++ Primer - Chapter 17 Specialized Library Facilities</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/" title="CLR via C# - Chapter 25 Interoperating with WinRT Components">CLR via C# - Chapter 25 Interoperating with WinRT Components</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 â€“ <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Sakupinera @ Hanamai Sora</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">2.2m words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">34:05</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2023/02/10/csharp/clr-via-csharp/Chapter 30 Hybrid Thread Synchronization Constructs/",favicon:{show:"ï¼ˆâ—Â´3ï½€â—ï¼‰Goooood",hide:"(Â´Ğ”ï½€)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/assets/shifuku.model.json"},display:{position:"left",width:250,height:500},mobile:{show:!1},react:{opacity:.9},log:!1})</script></body></html>