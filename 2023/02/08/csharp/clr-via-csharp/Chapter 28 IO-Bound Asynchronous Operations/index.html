<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Sakupinera" href="http://sakupinera.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Sakupinera" href="http://sakupinera.github.io/atom.xml"><link rel="alternate" type="application/json" title="Sakupinera" href="http://sakupinera.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="è¯»ä¹¦ç¬”è®°,C#"><link rel="canonical" href="http://sakupinera.github.io/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/"><title>CLR via C# - Chapter 28 IO-Bound Asynchronous Operations - CLR-via-CSharp - CSharp | Hanamai Sora = Sakupinera</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">CLR via C# - Chapter 28 IO-Bound Asynchronous Operations</h1><div class="meta"><span class="item" title="Created: 2023-02-08 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2023-02-08T00:00:00+08:00">2023-02-08</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>71k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>1:05</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Hanamai Sora</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://s2.loli.net/2023/03/08/J4XewNCOu8fzIy9.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/AK1D84aqsYghTOC.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/r1VBTR45h8jQWZA.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/vWqdDn4KtmcIXr3.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/3J2uz5ejLcmstkD.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/R9PEJQ54o7HMAis.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/" itemprop="item" rel="index" title="In CSharp"><span itemprop="name">CSharp</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/CLR-via-CSharp/" itemprop="item" rel="index" title="In CLR-via-CSharp"><span itemprop="name">CLR-via-CSharp</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="http://sakupinera.github.io/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Sakupinera"><meta itemprop="description" content=", ä¿æŒä½ çš„å†³å¿ƒï¼"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sakupinera"></span><div class="body md" itemprop="articleBody"><h1 id="chapter-28-io-bound-asynchronous-operations"><a class="anchor" href="#chapter-28-io-bound-asynchronous-operations">#</a> Chapter 28 IO-Bound Asynchronous Operations</h1><h2 id="how-windows-performs-io-operations"><a class="anchor" href="#how-windows-performs-io-operations">#</a> How Windows Performs I/O Operations</h2><blockquote><p>Letâ€™s begin by discussing how Windows performs synchronous I/O operations. Figure 28-1 represents a computer system with several hardware devices connected to it. Each of these hardware devices has its own circuit board, each of which contains a small, special-purpose computer that knows how to control its hardware device. For example, the hard disk drive has a circuit board that knows how to spin up the drive, seek the head to the right track, read or write data from or to the disk, and transfer the data to or from your computerâ€™s memory.</p></blockquote><p><img data-src="/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/image-20230206220936582.png" alt="image-20230206220936582"></p><blockquote><p>In your program, you open a disk file by constructing a FileStream object. Then you call the Read method to read data from the file. When you call FileStreamâ€™s Read method, your thread transitions from managed code to native/user-mode code and Read internally calls the Win32 ReadFile function (#1). ReadFile then allocates a small data structure called an I/O Request Packet (IRP) (#2). The IRP structure is initialized to contain the handle to the file, an offset within the file where bytes will start to be read from, the address of a Byte[] that should be filled with the bytes being read, the number of bytes to transfer, and some other less interesting stuff.</p></blockquote><blockquote><p>ReadFile then calls into the Windows kernel by having your thread transition from native/usermode code to native/kernel-mode code, passing the IRP data structure to the kernel (#3). From the device handle in the IRP, the Windows kernel knows which hardware device the I/O operation is destined for, and Windows delivers the IRP to the appropriate device driverâ€™s IRP queue (#4). Each device driver maintains its own IRP queue that contains I/O requests from all processes running on the machine. As IRP packets show up, the device driver passes the IRP information to the circuit board associated with the actual hardware device. The hardware device now performs the requested I/O operation (#5).</p></blockquote><blockquote><p>But here is the important part: While the hardware device is performing the I/O operation, your thread that issued the I/O request has nothing to do, so Windows puts your thread to sleep so that it is not wasting CPU time (#6). This is great, but although your thread is not wasting time, it is wasting space (memory), as its user-mode stack, kernel-mode stack, thread environment block (TEB), and other data structures are sitting in memory but are not being accessed at all. In addition, for GUI applications, the UI canâ€™t respond to user input while the thread is blocked. All of this is bad.</p></blockquote><blockquote><p>Ultimately, the hardware device will complete the I/O operation, and then Windows will wake up your thread, schedule it to a CPU, and let it return from kernel mode to user mode, and then back to managed code (#7, #8, and #9). FileStreamâ€™s Read method now returns an Int32, indicating the actual number of bytes read from the file so that you know how many bytes you can examine in the Byte[] that you passed to Read.</p></blockquote><blockquote><p>Letâ€™s imagine that you are implementing a web application and as each client request comes in to your server, you need to make a database request. When a client request comes in, a thread pool thread will call into your code. If you now issue a database request synchronously, the thread will block for an indefinite amount of time waiting for the database to respond with the result. If during this time another client request comes in, the thread pool will have to create another thread and again this thread will block when it makes another database request. As more and more client requests come in, more and more threads are created, and all these threads block waiting for the database to respond. The result is that your web server is allocating lots of system resources (threads and their memory) that are barely even used!</p></blockquote><blockquote><p>And to make matters worse, when the database does reply with the various results, threads become unblocked and they all start executing. But because you might have lots of threads running and relatively few CPU cores, Windows has to perform frequent context switches, which hurts performance even more. This is no way to implement a scalable application.</p></blockquote><blockquote><p>Now, letâ€™s discuss how Windows performs asynchronous I/O operations. In Figure 28-2, I have removed all the hardware devices except the hard disk from the picture, I introduce the common language runtimeâ€™s (CLRâ€™s) thread pool, and Iâ€™ve modified the code slightly. I still open the disk file by constructing a FileStream object, but now I pass in the FileOptions.Asynchronous flag. This flag tells Windows that I want my read and write operations against the file to be performed asynchronously.</p></blockquote><blockquote><p>To read data from the file, I now call ReadAsync instead of Read. ReadAsync internally allocates a Task object to represent the pending completion of the read operation. Then, ReadAsync calls Win32â€™s ReadFile function (#1). ReadFile allocates its IRP, initializes it just like it did in the synchronous scenario (#2), and then passes it down to the Windows kernel (#3). Windows adds the IRP to the hard disk driverâ€™s IRP queue (#4), but now, instead of blocking your thread, your thread is allowed to return to your code; your thread immediately returns from its call to ReadAsync (#5, #6, and #7). Now, of course, the IRP has not necessarily been processed yet, so you cannot have code after ReadAsync that attempts to access the bytes in the passed-in Byte[].</p></blockquote><blockquote><p>Now you might ask, when and how do you process the data that will ultimately be read? Well, when you call ReadAsync, it returns to you a Task object. Using this object, you can call ContinueWith to register a callback method that should execute when the task completes and then process the data in this callback method. Or, alternatively, you can use C#â€™s asynchronous function feature to simplify your code by allowing you to write it sequentially (as you would if you were performing synchronous I/O).</p></blockquote><p><img data-src="/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/image-20230206221054458.png" alt="image-20230206221054458"></p><blockquote><p>When the hardware device completes processing the IRP (a), it will queue the completed IRP into the CLRâ€™s thread pool (b). Sometime in the future, a thread pool thread will extract the completed IRP and execute code that completes the task by setting an exception (if an error occurred) or the result (in this case, an Int32 indicating the number of bytes successfully read) (c).1 So now the Task object knows when the operation has completed and this, in turn, lets your code run so it can safely access the data inside the Byte[].</p></blockquote><blockquote><p>Now that you understand the basics, letâ€™s put it all into perspective. Letâ€™s say that a client request comes in, and our server makes an asynchronous database request. As a result, our thread wonâ€™t block, and it will be allowed to return to the thread pool so that it can handle more incoming client requests. So now we have just one thread handling all incoming client requests. When the database server responds, its response is also queued into the thread pool, so our thread pool thread will just process it at some point and ultimately send the necessary data back to the client. At this point, we have just one thread processing all client requests and all database responses. Our server is using very few system resources and it is still running as fast as it can, especially because there are no context switches!</p></blockquote><blockquote><p>If items appear in the thread pool quicker than our one thread can process them all, then the thread pool might create additional threads. The thread pool will quickly create one thread per CPU on the machine. So, on a quad-processor machine, four client requests/database responses (in any combination) are running on four threads without any context switching.</p></blockquote><blockquote><p>However, if any of these threads voluntarily block (by invoking a synchronous I/O operation, calling Thread.Sleep, or waiting to acquire a thread synchronization lock), then Windows notifies the thread pool that one of its threads has stopped running. The thread pool now realizes that the CPUs are undersaturated and creates a new thread to replace the blocked thread. This, of course, is not ideal because creating a new thread is very expensive in terms of both time and memory.</p></blockquote><blockquote><p>Whatâ€™s worse is that the blocked thread might wake up and now the CPUs are oversaturated again and context switching must occur, decreasing performance. However, the thread pool is smart here. As threads complete their processing and return to the pool, the thread pool wonâ€™t let them process new work items until the CPUs become exactly saturated again, thereby reducing context switches and improving performance. And if the thread pool later determines that it has more threads in it than it needs, it lets the extra threads kill themselves, thereby reclaiming the resources that these threads were using.</p></blockquote><blockquote><p>Internally, the CLRâ€™s thread pool uses a Windows resource called an I/O Completion Port to elicit the behavior that Iâ€™ve just described. The CLR creates an I/O Completion Port when it initializes and, as you open hardware devices, these devices can be bound to the I/O Completion Port so that device drivers know where to queue the completed IRPs. If you want to understand more about this mechanism, I recommend the book, Windows via C/C++, Fifth Edition, by myself and Christophe Nasarre (Microsoft Press, 2007).</p></blockquote><blockquote><p>In addition to minimal resource usage and reduced context switches, we get many other benefits when performing I/O operations asynchronously. Whenever a garbage collection starts, the CLR must suspend all the threads in the process. Therefore, the fewer threads we have, the faster the garbage collector runs. In addition, when a garbage collection occurs, the CLR must walk all the threadsâ€™ stacks looking for roots. Again, the fewer threads there are, the fewer stacks there are, and this also makes the garbage collection faster. But, in addition, if our threads donâ€™t block while processing work items, the threads tend to spend most of their time waiting in the thread pool. So when a garbage collection occurs, the threads are at the top of their stack, and walking each threadâ€™s stack for roots takes very little time.</p></blockquote><blockquote><p>Also, when you debug an application, Windows suspends all threads in the debuggee when you hit a breakpoint. Then, when you continue executing the debuggee, Windows has to resume all its threads, so if you have a lot of threads in an application, single-stepping through the code in a debugger can be excruciatingly slow. Using asynchronous I/O allows you to have just a few threads, improving your debugging performance.</p></blockquote><blockquote><p>And, hereâ€™s yet another benefit: letâ€™s say that your application wants to download 10 images from various websites, and that it takes 5 seconds to download each image. If you perform this work synchronously (downloading one image after another), then it takes you 50 seconds to get the 10 images. However, if you use just one thread to initiate 10 asynchronous download operations, then all 10 are being performed concurrently and all 10 images will come back in just 5 seconds! That is, when performing multiple synchronous I/O operations, the time it takes to get all the results is the sum of the times required for each individual result. However, when performing multiple asynchronous I/O operations, the time it takes to get all the results is the time required to get the single worst-performing operation.</p></blockquote><blockquote><p>For GUI applications, asynchronous operations offer yet another advantage: the applicationâ€™s user interface doesnâ€™t hang and remains responsive to the end user. In fact, if you are building a Microsoft Silverlight or Windows Store application, you must perform all I/O operations asynchronously, because the class libraries available to you for performing I/O operations only expose these operations asynchronously; the equivalent synchronous methods simply do not exist in the library. This was done purposely ensuring that these applications can never issue a synchronous I/O operation, thereby blocking the GUI thread making the application nonresponsive to the end user. This forces developers to build responsive applications providing end users a better experience.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šWindows æ‰§è¡ŒåŒæ­¥ I/O æ“ä½œæ—¶ï¼Œé¦–å…ˆé€šè¿‡æ„é€ ä¸€ä¸ª <code>FileStream</code> å¯¹è±¡æ¥æ‰“å¼€ç£ç›˜æ–‡ä»¶ï¼Œç„¶åè°ƒç”¨ <code>Read</code> æ–¹æ³•ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚è°ƒç”¨ <code>FileStream</code> çš„ <code>Read</code> æ–¹æ³•æ—¶ï¼Œçº¿ç¨‹ä¼šä»æ‰˜ç®¡ä»£ç è½¬å˜ä¸ºæœ¬æœº / ç”¨æˆ·æ¨¡å¼ä»£ç ï¼Œ <code>Read</code> å†…éƒ¨è°ƒç”¨ Win32 <code>ReadFile</code> å‡½æ•°ã€‚ <code>ReadFile</code> åˆ†é…ä¸€ä¸ªå°çš„æ•°æ®ç»“æ„ï¼Œç§°ä¸º I/O è¯·æ±‚åŒ…ï¼ˆI/O Request Packetï¼ŒIRPï¼‰ã€‚IRP ç»“æ„åˆå§‹åŒ–ååŒ…å«çš„å†…å®¹æœ‰ï¼šæ–‡ä»¶å¥æŸ„ï¼Œæ–‡ä»¶ä¸­çš„åç§»é‡ï¼ˆä»è¿™ä¸ªä½ç½®å¼€å§‹è¯»å–å­—èŠ‚ï¼‰ï¼Œä¸€ä¸ª <code>Byte[]</code> æ•°ç»„çš„åœ°å€ï¼ˆæ•°ç»„ç”¨è¯»å–çš„å­—èŠ‚æ¥å¡«å……ï¼‰ï¼Œè¦ä¼ è¾“çš„å­—èŠ‚æ•°ä»¥åŠå…¶ä»–å¸¸è§„æ€§å†…å®¹ã€‚ç„¶åï¼Œ <code>ReadFile</code> å°†çº¿ç¨‹ä»æœ¬æœº / ç”¨æˆ·æ¨¡å¼ä»£ç è½¬å˜æˆæœ¬æœº / å†…æ ¸æ¨¡å¼ä»£ç ï¼Œå‘å†…æ ¸ä¼ é€’ IRP æ•°æ®ç»“æ„ï¼Œä»è€Œè°ƒç”¨ Windows å†…æ ¸ã€‚æ ¹æ® IRP ä¸­çš„è®¾å¤‡å¥æŸ„ï¼ŒWindows å†…æ ¸çŸ¥é“ I/O æ“ä½œè¦ä¼ é€ç»™å“ªä¸ªç¡¬ä»¶è®¾å¤‡ã€‚å› æ­¤ï¼ŒWindows å°† IRP ä¼ é€ç»™æ°å½“çš„è®¾å¤‡é©±åŠ¨çš„ IRP é˜Ÿåˆ—ã€‚æ¯ä¸ªè®¾å¤‡é©±åŠ¨ç¨‹åºéƒ½ç»´æŠ¤ç€è‡ªå·±çš„ IRP é˜Ÿåˆ—ï¼Œå…¶ä¸­åŒ…å«äº†æœºå™¨ä¸Šè¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹å‘å‡ºçš„ I/O è¯·æ±‚ã€‚IRP æ•°æ®åŒ…åˆ°è¾¾æ—¶ï¼Œè®¾å¤‡é©±åŠ¨ç¨‹åºå°† IRP ä¿¡æ¯ä¼ ç»™ç‰©ç†ç¡¬ä»¶è®¾å¤‡ä¸Šå®‰è£…çš„ç”µè·¯æ¿ã€‚ç°åœ¨ï¼Œç¡¬ä»¶è®¾å¤‡å°†æ‰§è¡Œè¯·æ±‚çš„ I/O æ“ä½œã€‚åœ¨ç¡¬ä»¶è®¾å¤‡æ‰§è¡Œ I/O æ“ä½œæœŸé—´ï¼Œå‘å‡ºäº† I/O è¯·æ±‚çš„çº¿ç¨‹å°†æ— äº‹å¯åšï¼Œæ‰€ä»¥ Windows å°†çº¿ç¨‹å˜æˆç¡çœ çŠ¶æ€ï¼Œé˜²æ­¢å®ƒæµªè´¹ CPU æ—¶é—´ã€‚è¿™å½“ç„¶å¾ˆå¥½ã€‚ä½†æ˜¯ï¼Œè™½ç„¶çº¿ç¨‹ä¸æµªè´¹æ—¶é—´ï¼Œä½†å®ƒä»ç„¶æµªè´¹äº†ç©ºé—´ (å†…å­˜)ï¼Œå› ä¸ºå®ƒçš„ç”¨æˆ·æ¨¡å¼æ ˆã€å†…æ ¸æ¨¡å¼æ ˆã€çº¿ç¨‹ç¯å¢ƒå— (thread environment blockï¼ŒTEB) å’Œå…¶ä»–æ•°æ®ç»“æ„éƒ½è¿˜åœ¨å†…å­˜ä¸­ï¼Œè€Œä¸”å®Œå…¨æ²¡æœ‰è°å»è®¿é—®è¿™äº›ä¸œè¥¿ã€‚è¿™å½“ç„¶å°±ä¸å¥½äº†ã€‚æœ€ç»ˆï¼Œç¡¬ä»¶è®¾å¤‡ä¼šå®Œæˆ I/O æ“ä½œã€‚ç„¶åï¼ŒWindows ä¼šå”¤é†’ä½ çš„çº¿ç¨‹ï¼ŒæŠŠå®ƒè°ƒåº¦ç»™ä¸€ä¸ª CPUï¼Œä½¿å®ƒä»å†…æ ¸æ¨¡å¼è¿”å›ç”¨æˆ·æ¨¡å¼ï¼Œå†è¿”å›è‡³æ‰˜ç®¡ä»£ç ã€‚ <code>FileStream</code> çš„ <code>Read</code> æ–¹æ³•ç°åœ¨è¿”å›ä¸€ä¸ª <code>Int32</code> ï¼ŒæŒ‡æ˜ä»æ–‡ä»¶ä¸­è¯»å–çš„å®é™…å­—èŠ‚æ•°ï¼Œä½¿ä½ çŸ¥é“åœ¨ä¼ ç»™ <code>Read</code> çš„ <code>Byte[]</code> ä¸­ï¼Œå®é™…èƒ½æ£€ç´¢åˆ°å¤šå°‘ä¸ªå­—èŠ‚ã€‚ç°åœ¨è®¨è®ºä¸€ä¸‹ Windows å¦‚ä½•æ‰§è¡Œå¼‚æ­¥ I/O æ“ä½œï¼Œæ‰“å¼€ç£ç›˜æ–‡ä»¶çš„æ–¹å¼ä»ç„¶æ˜¯é€šè¿‡æ„é€ ä¸€ä¸ª <code>FileStream</code> å¯¹è±¡ï¼Œä½†ç°åœ¨ä¼ é€’äº†ä¸€ä¸ª <code>FileOptions.Asynchronous</code> æ ‡å¿—ï¼Œå‘Šè¯‰ Windows æˆ‘å¸Œæœ›æ–‡ä»¶çš„è¯» / å†™æ“ä½œä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œã€‚ç°åœ¨è°ƒç”¨ <code>ReadAsync</code> è€Œä¸æ˜¯ <code>Read</code> ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚ <code>ReadAsync</code> å†…éƒ¨åˆ†é…ä¸€ä¸ª <code>Task&lt;Int32&gt;</code> å¯¹è±¡æ¥ä»£è¡¨ç”¨äºå®Œæˆè¯»å–æ“ä½œçš„ä»£ç ã€‚ç„¶åï¼Œ <code>ReadAsync</code> è°ƒç”¨ Win32 <code>ReadFile</code> å‡½æ•°ã€‚ <code>ReadFile</code> åˆ†é… IRPï¼Œå’Œå‰é¢çš„åŒæ­¥æ“ä½œä¸€æ ·åˆå§‹åŒ–å®ƒï¼Œç„¶åæŠŠå®ƒä¼ ç»™ Windows å†…æ ¸ã€‚Windows æŠŠ IRP æ·»åŠ åˆ°ç¡¬ç›˜é©±åŠ¨ç¨‹åºçš„ IRP é˜Ÿåˆ—ä¸­ã€‚ä½†çº¿ç¨‹ä¸å†é˜»å¡ï¼Œè€Œæ˜¯å…è®¸è¿”å›è‡³ä½ çš„ä»£ç ã€‚æ‰€ä»¥ï¼Œçº¿ç¨‹èƒ½ç«‹å³ä» <code>ReadAsync</code> è°ƒç”¨ä¸­è¿”å›ã€‚å½“ç„¶ï¼Œæ­¤æ—¶ IRP å¯èƒ½å°šæœªå‡ºå¤„ç†å¥½ï¼Œæ‰€ä»¥ä¸èƒ½å¤Ÿåœ¨ <code>ReadAsync</code> ä¹‹åçš„ä»£ç ä¸­è®¿é—®ä¼ é€’çš„ <code>Byte[]</code> ä¸­çš„å­—èŠ‚ã€‚æ³¨æ„ï¼Œè°ƒç”¨ <code>ReadAsync</code> è¿”å›çš„æ˜¯ä¸€ä¸ª <code>Task&lt;Int32&gt;</code> å¯¹è±¡ã€‚å¯åœ¨è¯¥å¯¹è±¡ä¸Šè°ƒç”¨ <code>ContinueWith</code> æ¥ç™»è®°ä»»åŠ¡å®Œæˆæ—¶æ‰§è¡Œçš„å›è°ƒæ–¹æ³•ï¼Œç„¶ååœ¨å›è°ƒæ–¹æ³•ä¸­å¤„ç†æ•°æ®ã€‚å½“ç„¶ï¼Œä¹Ÿå¯åˆ©ç”¨ C# çš„å¼‚æ­¥å‡½æ•°åŠŸèƒ½ç®€åŒ–ç¼–ç ï¼Œä»¥é¡ºåºæ–¹å¼å†™ä»£ç  (æ„Ÿè§‰å°±åƒæ˜¯æ‰§è¡ŒåŒæ­¥ I/O)ã€‚ç¡¬ä»¶è®¾å¤‡å¤„ç†å¥½ IRP åï¼Œä¼šå°†å®Œæˆçš„ IRP æ”¾åˆ° CLR çš„çº¿ç¨‹æ± é˜Ÿåˆ—ä¸­ã€‚å°†æ¥æŸä¸ªæ—¶å€™ï¼Œä¸€ä¸ªçº¿ç¨‹æ± çº¿ç¨‹ä¼šæå–å®Œæˆçš„ IRP å¹¶æ‰§è¡Œå®Œæˆä»»åŠ¡çš„ä»£ç ï¼Œæœ€ç»ˆè¦ä¹ˆè®¾ç½®å¼‚å¸¸ (å¦‚æœå‘ç”Ÿé”™è¯¯)ï¼Œè¦ä¹ˆè¿”å›ç»“æœ (æœ¬ä¾‹æ˜¯ä»£è¡¨æˆåŠŸè¯»å–çš„å­—èŠ‚æ•°çš„ä¸€ä¸ª <code>Int32</code> )ã€‚è¿™æ ·ä¸€æ¥ï¼Œ <code>Task</code> å¯¹è±¡å°±çŸ¥é“æ“ä½œåœ¨ä»€ä¹ˆæ—¶å€™å®Œæˆï¼Œä»£ç å¯ä»¥å¼€å§‹è¿è¡Œå¹¶å®‰å…¨åœ°è®¿é—® <code>Byte[]</code> ä¸­çš„æ•°æ®ã€‚å‡å®šåœ¨ä¼ å…¥ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ä¹‹åï¼ŒæœåŠ¡å™¨å‘å‡ºçš„æ˜¯ä¸€ä¸ªå¼‚æ­¥æ•°æ®åº“è¯·æ±‚ã€‚æ­¤æ—¶çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œå®ƒå¯è¿”å›çº¿ç¨‹æ± ä»¥å¤„ç†ä¼ å…¥çš„æ›´å¤šå®¢æˆ·ç«¯è¯·æ±‚ã€‚æ‰€ä»¥ï¼Œç°åœ¨ç”¨ä¸€ä¸ªçº¿ç¨‹å°±èƒ½å¤„ç†æ‰€æœ‰ä¼ å…¥çš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚æ•°æ®åº“æœåŠ¡å™¨å“åº”ä¹‹åï¼Œå®ƒçš„å“åº”ä¹Ÿä¼šè¿›å…¥çº¿ç¨‹æ± é˜Ÿåˆ—ï¼Œä½¿çº¿ç¨‹æ± çº¿ç¨‹èƒ½åœ¨æŸä¸ªæ—¶é—´å¤„ç†å®ƒï¼Œæœ€åå°†éœ€è¦çš„æ•°æ®å‘é€å›å®¢æˆ·ç«¯ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªç”¨ä¸€ä¸ªçº¿ç¨‹å°±å¤„ç†äº†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚å’Œæ‰€æœ‰æ•°æ®åº“å“åº”ã€‚æœåŠ¡å™¨åªéœ€ä½¿ç”¨æå°‘çš„ç³»ç»Ÿèµ„æºï¼ŒåŒæ—¶è¿è¡Œé€Ÿåº¦ä¹Ÿå¾—åˆ°äº†ä¿è¯ã€‚å¦‚æœå·¥ä½œé¡¹è¢«é€å…¥çº¿ç¨‹æ± çš„é€Ÿåº¦æ¯”ä¸€ä¸ªçº¿ç¨‹å¤„ç†å®ƒä»¬çš„é€Ÿåº¦è¿˜è¦å¿«ï¼Œçº¿ç¨‹æ± å°±å¯èƒ½åˆ›å»ºé¢å¤–çš„çº¿ç¨‹ã€‚çº¿ç¨‹æ± å¾ˆå¿«ä¼šä¸ºæœºå™¨ä¸Šçš„æ¯ä¸ª CPU éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚ä¾‹å¦‚ï¼Œåœ¨ 4 æ ¸æœºå™¨ä¸Šï¼Œ4 ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ / æ•°æ®åº“å“åº” (ä»»æ„ç»„åˆ) å¯ä»¥åœ¨ 4 ä¸ªçº¿ç¨‹ä¸ŠåŒæ—¶è¿è¡Œï¼Œè€Œä¸”è¿˜ä¸ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ç„¶è€Œï¼Œå¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä¸»åŠ¨é˜»å¡ (é€šè¿‡è°ƒç”¨åŒæ­¥ I/O æ“ä½œï¼Œè°ƒç”¨ <code>Thread.Sleep</code> æˆ–è€…ç­‰å¾…è·å–çº¿ç¨‹åŒæ­¥é”)ï¼ŒWindows å°±ä¼šé€šçŸ¥çº¿ç¨‹æ± å®ƒçš„ä¸€ä¸ªçº¿ç¨‹åœæ­¢äº†è¿è¡Œã€‚éšåï¼Œçº¿ç¨‹æ± æ„è¯†åˆ° CPU å¤„äºæ¬ é¥±å’ŒçŠ¶æ€ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ›¿æ¢é˜»å¡çš„çº¿ç¨‹ã€‚æ›´ç³Ÿçš„æ˜¯ï¼Œé˜»å¡çš„çº¿ç¨‹å¯èƒ½é†’æ¥ï¼ŒCPU åˆå˜å¾—è¿‡é¥±å’Œäº†ï¼Œæ‰€ä»¥å¿…é¡»å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™ä¼šå½±å“åˆ°æ€§èƒ½ã€‚ç„¶è€Œï¼Œçº¿ç¨‹æ± åœ¨è¿™ä¸ªæ—¶å€™æ˜¯æ¯”è¾ƒèªæ˜çš„ã€‚çº¿ç¨‹å®Œæˆå¤„ç†å¹¶å›åˆ°æ± ä¸­æ—¶ï¼Œé™¤é CPU å†åº¦å˜å¾—é¥±å’Œï¼Œå¦åˆ™çº¿ç¨‹æ± ä¸è®©å®ƒä»¬å¤„ç†æ–°çš„å·¥ä½œé¡¹ã€‚è¿™æ ·å°±å‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢å¹¶æå‡äº†æ€§èƒ½ã€‚å¦‚æœçº¿ç¨‹æ± ä»¥ååˆ¤æ–­å®ƒçš„çº¿ç¨‹æ•°è¶…è¿‡éœ€è¦çš„æ•°é‡ï¼Œä¼šå…è®¸å¤šä½™çš„çº¿ç¨‹ç»ˆæ­¢è‡ªèº«ï¼Œå›æ”¶è¿™äº›çº¿ç¨‹ä½¿ç”¨çš„èµ„æºã€‚åœ¨å†…éƒ¨ï¼ŒCLR çš„çº¿ç¨‹æ± ä½¿ç”¨åä¸º â€œI/O å®Œæˆç«¯å£â€(I/O Completion Port) çš„ Windows èµ„æºæ¥å¼•å‡ºæˆ‘åˆšæ‰æè¿°çš„è¡Œä¸ºã€‚CLR åœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºä¸€ä¸ª I/O å®Œæˆç«¯å£ã€‚å½“ä½ æ‰“å¼€ç¡¬ä»¶è®¾å¤‡æ—¶ï¼Œè¿™äº›è®¾å¤‡å¯ä»¥å’Œ I/O å®Œæˆç«¯å£å…³è”ï¼Œä½¿è®¾å¤‡é©±åŠ¨ç¨‹åºçŸ¥é“å°†å®Œæˆçš„ IRP é€åˆ°å“ªå„¿ã€‚ é™¤äº†å°†èµ„æºåˆ©ç”¨ç‡é™åˆ°æœ€ä½ï¼Œå¹¶å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œ I/O æ“ä½œè¿˜æœ‰å…¶ä»–è®¸å¤šå¥½å¤„ã€‚æ¯å¼€å§‹ä¸€æ¬¡åƒåœ¾å›æ”¶ï¼ŒCLR éƒ½å¿…é¡»æŒ‚èµ·è¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹ã€‚æ‰€ä»¥ï¼Œçº¿ç¨‹è¶Šå°‘ï¼Œåƒåœ¾å›æ”¶å™¨è¿è¡Œçš„é€Ÿåº¦è¶Šå¿«ã€‚æ­¤å¤–ï¼Œä¸€æ¬¡åƒåœ¾å›æ”¶å‘ç”Ÿæ—¶ï¼ŒCLR å¿…é¡»éå†æ‰€æœ‰çº¿ç¨‹çš„æ ˆæ¥æŸ¥æ‰¾æ ¹ã€‚åŒæ ·ï¼Œçº¿ç¨‹è¶Šå°‘ï¼Œæ ˆçš„æ•°é‡è¶Šå°‘ï¼Œä½¿åƒåœ¾å›æ”¶é€Ÿåº¦å˜å¾—æ›´å¿«ã€‚å¦å¤–ï¼Œåœ¨è°ƒè¯•åº”ç”¨ç¨‹åºæ—¶ï¼Œä¸€æ—¦é‡åˆ°æ–­ç‚¹ï¼ŒWindows ä¼šæŒ‚èµ·è¢«è°ƒè¯•çš„åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰çº¿ç¨‹ã€‚åº”ç”¨ç¨‹åºåˆšæ¢å¤ç»§ç»­è¿è¡Œæ—¶ï¼ŒWindows å¿…é¡»æ¢å¤å®ƒçš„æ‰€æœ‰çº¿ç¨‹ã€‚æ‰€ä»¥ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­çš„çº¿ç¨‹æ•°å¤ªå¤šï¼Œåœ¨è°ƒè¯•å™¨ä¸­å•æ­¥è°ƒè¯•ä»£ç ä¼šæ…¢å¾—ä»¤äººéš¾å—ã€‚ä½¿ç”¨å¼‚æ­¥ I/O å¯ä»¥å°†çº¿ç¨‹æ•°æ§åˆ¶åœ¨å°‘æ•°å‡ ä¸ªï¼Œå¯ä»¥å¢å¼ºè°ƒè¯•æ€§èƒ½ã€‚ è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å€¼å¾—ä¸€æï¼šæ‰§è¡Œå¤šä¸ªåŒæ­¥ I/O æ“ä½œï¼Œè·å¾—æ‰€æœ‰ç»“æœçš„æ—¶é—´æ˜¯è·å¾—æ¯ä¸ªå•ç‹¬ç»“æœæ‰€éœ€æ—¶é—´ä¹‹å’Œã€‚ä½†æ‰§è¡Œå¤šä¸ªå¼‚æ­¥ I/O æ“ä½œï¼Œè·å¾—æ‰€æœ‰ç»“æœçš„æ—¶é—´æ˜¯è¡¨ç°æœ€å·®çš„é‚£ä¸ªæ“ä½œæ‰€éœ€çš„æ—¶é—´ã€‚ å¯¹äº GUI åº”ç”¨ç¨‹åºï¼Œå¼‚æ­¥æ“ä½œè¿˜æœ‰å¦ä¸€ä¸ªå¥½å¤„ï¼Œå³ç”¨æˆ·ç•Œé¢ä¸ä¼šæŒ‚èµ·ï¼Œä¸€ç›´éƒ½èƒ½çµæ•åœ°å“åº”ç”¨æˆ·çš„æ“ä½œã€‚</p><h2 id="cs-asynchronous-functions"><a class="anchor" href="#cs-asynchronous-functions">#</a> C#â€™s Asynchronous Functions</h2><blockquote><p>Performing asynchronous operations is the key to building scalable and responsive applications that allow you to use very few threads to execute lots of operations. And when coupled with the thread pool, asynchronous operations allow you to take advantage of all of the CPUs that are in the machine. Realizing the enormous potential here, Microsoft designed a programming model that would make it easy for developers to take advantage of this capability.3 This pattern leverages Tasks (as discussed in Chapter 27, â€œCompute-Bound Asynchronous Operationsâ€) and a C# language feature called asynchronous functions (or async functions, for short). Here is an example of code that uses an async function to issue two asynchronous I/O operations.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> <span class="token function">IssueClientRequestAsync</span><span class="token punctuation">(</span><span class="token class-name">String</span> serverName<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> pipe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NamedPipeClientStream</span><span class="token punctuation">(</span>serverName<span class="token punctuation">,</span> <span class="token string">"PipeName"</span><span class="token punctuation">,</span> PipeDirection<span class="token punctuation">.</span>InOut<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> PipeOptions<span class="token punctuation">.</span>Asynchronous <span class="token operator">|</span> PipeOptions<span class="token punctuation">.</span>WriteThrough<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> pipe<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Must Connect before setting ReadMode</span></pre></td></tr><tr><td data-num="5"></td><td><pre> pipe<span class="token punctuation">.</span>ReadMode <span class="token operator">=</span> PipeTransmissionMode<span class="token punctuation">.</span>Message<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Asynchronously send data to the server</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> request <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">await</span> pipe<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// Asynchronously read the server's response</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Byte</span><span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">Int32</span> bytesRead <span class="token operator">=</span> <span class="token keyword">await</span> pipe<span class="token punctuation">.</span><span class="token function">ReadAsync</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">return</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token punctuation">&#125;</span> <span class="token comment">// Close the pipe</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>In the preceding code, you can tell that IssueClientRequestAsync is an async function, because I specified async on the first line just after static. When you mark a method as async, the compiler basically transforms your methodâ€™s code into a type that implements a state machine (the details of which will be discussed in the next section). This allows a thread to execute some code in the state machine and then return without having the method execute all the way to completion. So, when a thread calls IssueClientRequestAsync, the thread constructs a NamedPipeClientStream, calls Connect, sets its ReadMode property, converts the passed-in message to a Byte[] and then calls WriteAsync. WriteAsync internally allocates a Task object and returns it back to IssueClientRequestAsync. At this point, the C# await operator effectively calls ContinueWith on the Task object passing in the method that resumes the state machine and then, the thread returns from IssueClientRequestAsync.</p></blockquote><blockquote><p>Sometime in the future, the network device driver will complete writing the data to the pipe and then, a thread pool thread will notify the Task object, which will then activate the ContinueWith callback method, causing a thread to resume the state machine. More specifically, a thread will re-enter the IssueClientRequestAsync method but at the point of the await operator. Our method now executes compiler-generated code that queries the status of the Task object. If the operation failed, an exception representing the failure is thrown. If the operation completes successfully, the await operator returns the result. In this case, WriteAsync returns a Task instead of a Task, so there is no return value.</p></blockquote><blockquote><p>Now, our method continues executing by allocating a Byte[] and then calls NamedPipeClientStreamâ€™s asynchronous ReadAsync method. Internally, ReadAsync creates a Task object and returns it. Again, the await operator effectively calls ContinueWith on the Task object passing in the method that resumes the state machine. And then, the thread returns from IssueClientRequestAsync again.</p></blockquote><blockquote><p>Sometime in the future, the server will send a response back to the client machine, the network device driver gets this response, and a thread pool thread notifies the Task object, which will then resume the state machine. The await operator causes the compiler to generate code that queries the Task objectâ€™s Result property (an Int32) and assigns the result to the bytesRead local variable or throws an exception if the operation failed. Then, the rest of the code in IssueClientRequestAsync executes, returning the result string and closing the pipe. At this point, the state machine has run to completion and the garbage collector will reclaim any memory it needed.</p></blockquote><blockquote><p>Because async functions return before their state machine has executed all the way to completion, the method calling IssueClientRequestAsync will continue its execution right after IssueClientRequestAsync executes its first await operator. But, how can the caller know when IssueClientRequestAsync has completed executing its state machine in its entirety? Well, when you mark a method as async, the compiler automatically generates code that creates a Task object when the state machine begins its execution; this Task object is completed automatically when the state machine runs to completion. Youâ€™ll notice that the IssueClientRequestAsync methodâ€™s return type is a Task. It actually returns the Task object that the compiler-generated code creates back to its caller, and the Taskâ€™s Result property is of type String in this case. Near the bottom of IssueClientRequestAsync, I return a string. This causes the compiler-generated code to complete the Task object it created and set its Result property to the returned string.</p></blockquote><blockquote><p>You should be aware of the following restrictions related to async functions:</p><ul><li><p>You cannot turn your applicationâ€™s Main method into an async function. In addition, constructors, property accessor methods and event accessor methods cannot be turned into async functions.</p></li><li><p>You cannot have any out or ref parameters on an async function.</p></li><li><p>You cannot use the await operator inside a catch, finally, or unsafe block.</p></li><li><p>You cannot take a lock that supports thread ownership or recursion before an await operator and release it after the await operator. The reason is because one thread might execute the code before the await and a different thread might execute the code after the await. If you use await within a C# lock statement, the compiler issues an error. If you explicitly call Monitorâ€™s Enter and Exit methods instead, then the code will compile but Monitor.Exit will throw a SynchronizationLockException at run time.4</p></li><li><p>Within a query expression, the await operator may only be used within the first collection expression of the initial from clause or within the collection expression of a join clause.</p></li></ul></blockquote><blockquote><p>These restrictions are pretty minor. If you violate one, the compiler will let you know, and you can usually work around the problem with some small code modifications.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šæ‰§è¡Œå¼‚æ­¥æ“ä½œæ˜¯æ„å»ºå¯ä¼¸ç¼©çš„ã€å“åº”çµæ•çš„åº”ç”¨ç¨‹åºçš„å…³é”®ï¼Œå®ƒå…è®¸ä½¿ç”¨å°‘é‡çº¿ç¨‹æ‰§è¡Œå¤§é‡æ“ä½œã€‚ä¸çº¿ç¨‹æ± ç»“åˆï¼Œå¼‚æ­¥æ“ä½œå…è®¸åˆ©ç”¨æœºå™¨ä¸­çš„æ‰€æœ‰ CPUã€‚æ„è¯†åˆ°å…¶ä¸­çš„å·¨å¤§æ½œåŠ›ï¼ŒMicrosoft è®¾è®¡äº†ä¸€ä¸ªç¼–ç¨‹æ¨¡å‹æ¥å¸®åŠ©å¼€å‘è€…åˆ©ç”¨è¿™ç§èƒ½åŠ›ã€‚è¯¥æ¨¡å¼åˆ©ç”¨äº† <code>Task</code> å’Œç§°ä¸ºå¼‚æ­¥å‡½æ•°çš„ä¸€ä¸ª C# è¯­è¨€åŠŸèƒ½ã€‚æ³¨æ„ï¼Œå¼‚æ­¥å‡½æ•°å­˜åœ¨ä»¥ä¸‹é™åˆ¶ã€‚1. æ„é€ å™¨ã€å±æ€§è®¿é—®å™¨æ–¹æ³•å’Œäº‹ä»¶è®¿é—®å™¨æ–¹æ³•ä¸èƒ½è½¬å˜æˆå¼‚æ­¥å‡½æ•°ã€‚2. å¼‚æ­¥å‡½æ•°ä¸èƒ½ä½¿ç”¨ä»»ä½• <code>out</code> æˆ– <code>ref</code> å‚æ•°ã€‚3. ä¸èƒ½åœ¨ catchï¼Œfinally æˆ– unsafe å—ä¸­ä½¿ç”¨ await æ“ä½œç¬¦ã€‚4. ä¸èƒ½åœ¨ <code>await</code> æ“ä½œç¬¦ä¹‹å‰è·å¾—ä¸€ä¸ªæ”¯æŒçº¿ç¨‹æ‰€æœ‰æƒæˆ–é€’å½’çš„é”ï¼Œå¹¶åœ¨ <code>await</code> æ“ä½œç¬¦ä¹‹åé‡Šæ”¾å®ƒã€‚è¿™æ˜¯å› ä¸º <code>await</code> ä¹‹å‰çš„ä»£ç ç”±ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œä¹‹åçš„ä»£ç åˆ™å¯èƒ½ç”±å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚åœ¨ C# <code>lock</code> è¯­å¥ä¸­ä½¿ç”¨ <code>await</code> ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚å¦‚æœæ˜¾å¼è°ƒç”¨ <code>Monitor</code> çš„ <code>Enter</code> å’Œ <code>Exit</code> æ–¹æ³•ï¼Œé‚£ä¹ˆä»£ç è™½ç„¶èƒ½ç¼–è¯‘ï¼Œä½† <code>Monitor.Exit</code> ä¼šåœ¨è¿è¡Œæ—¶æŠ›å‡ºä¸€ä¸ª <code>SynchronizationLockException</code> ã€‚5. åœ¨æŸ¥è¯¢è¡¨è¾¾å¼ä¸­ï¼Œ <code>await</code> æ“ä½œç¬¦åªèƒ½åœ¨åˆå§‹ <code>from</code> å­å¥çš„ç¬¬ä¸€ä¸ªé›†åˆè¡¨è¾¾å¼ä¸­ä½¿ç”¨ï¼Œæˆ–è€…åœ¨ <code>join</code> å­å¥çš„é›†åˆè¡¨è¾¾å¼ä¸­ä½¿ç”¨ã€‚</p><h2 id="how-the-compiler-transforms-an-async-function-into-a-state-machine"><a class="anchor" href="#how-the-compiler-transforms-an-async-function-into-a-state-machine">#</a> How the Compiler Transforms an Async Function into a State Machine</h2><blockquote><p>When working with async functions, you will be more productive with them if you have an understanding and appreciation for the code transform that the compiler is doing for you. And, I think the easiest and best way for you to learn that is by going through an example. So, letâ€™s start off by defining some simple type definitions and some simple methods.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Type1</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Type2</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Type1<span class="token punctuation">></span></span> <span class="token function">Method1Async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">/* Does some async thing that returns a Type1 object */</span> </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Type2<span class="token punctuation">></span></span> <span class="token function">Method2Async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">/* Does some async thing that returns a Type2 object */</span> </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Now, let me show you an async function that consumes these simple types and methods.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> <span class="token function">MyMethodAsync</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> argument<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name">Int32</span> local <span class="token operator">=</span> argument<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name">Type1</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">Method1Async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token class-name">Type2</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">Method2Async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Catch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Finally"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">return</span> <span class="token string">"Done"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Although MyMethodAsync seems rather contrived, it demonstrates some key things. First, it is an async function itself that returns a Task but the codeâ€™s body ultimately returns a String. Second, it calls other functions that execute operations asynchronously, one stand-alone and the other from within a for loop. Finally, it also contains exception handling code. When compiling MyMethodAsync, the compiler transforms the code in this method to a state machine structure that is capable of being suspended and resumed.</p></blockquote><blockquote><p>I took the preceding code, compiled it, and then reverse engineered the IL code back into C# source code. I then simplified the code and added a lot of comments to it so you can understand what the compiler is doing to make async functions work. The following is the essence of the code created by the compilerâ€™s transformation. I show the transformed MyMethodAsync method as well as the state machine structure it now depends on.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// AsyncStateMachine attribute indicates an async method (good for tools using reflection); </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// the type indicates which structure implements the state machine</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>DebuggerStepThrough<span class="token punctuation">,</span> <span class="token function">AsyncStateMachine</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">StateMachine</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> <span class="token function">MyMethodAsync</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> argument<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Create state machine instance &amp; initialize it</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token class-name">StateMachine</span> stateMachine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// Create builder returning Task&lt;String> from this stub method</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// State machine accesses builder to set Task completion/exception</span></pre></td></tr><tr><td data-num="9"></td><td><pre> m_builder <span class="token operator">=</span> AsyncTaskMethodBuilder<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> m_state <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// Initialize state machine location</span></pre></td></tr><tr><td data-num="11"></td><td><pre> m_argument <span class="token operator">=</span> argument <span class="token comment">// Copy arguments to state machine fields</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// Start executing the state machine</span></pre></td></tr><tr><td data-num="14"></td><td><pre> stateMachine<span class="token punctuation">.</span>m_builder<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token keyword">ref</span> stateMachine<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">return</span> stateMachine<span class="token punctuation">.</span>m_builder<span class="token punctuation">.</span>Task<span class="token punctuation">;</span> <span class="token comment">// Return state machine's Task</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">// This is the state machine structure</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">[</span>CompilerGenerated<span class="token punctuation">,</span> <span class="token function">StructLayout</span><span class="token punctuation">(</span>LayoutKind<span class="token punctuation">.</span>Auto<span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">struct</span> <span class="token class-name">StateMachine</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAsyncStateMachine</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// Fields for state machine's builder (Task) &amp; its location</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token keyword">public</span> <span class="token class-name">AsyncTaskMethodBuilder<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> m_builder<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">public</span> <span class="token class-name">Int32</span> m_state<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token comment">// Argument and local variables are fields now:</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token keyword">public</span> <span class="token class-name">Int32</span> m_argument<span class="token punctuation">,</span> m_local<span class="token punctuation">,</span> m_x<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token keyword">public</span> <span class="token class-name">Type1</span> m_resultType1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token keyword">public</span> <span class="token class-name">Type2</span> m_resultType2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token comment">// There is 1 field per awaiter type.</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">// Only 1 of these fields is important at any time. That field refers </span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token comment">// to the most recently executed await that is completing asynchronously:</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">TaskAwaiter<span class="token punctuation">&lt;</span>Type1<span class="token punctuation">></span></span> m_awaiterType1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">TaskAwaiter<span class="token punctuation">&lt;</span>Type2<span class="token punctuation">></span></span> m_awaiterType2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token comment">// This is the state machine method itself</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token return-type class-name"><span class="token keyword">void</span></span> IAsyncStateMachine<span class="token punctuation">.</span><span class="token function">MoveNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Task's result value</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token comment">// Compiler-inserted try block ensures the state machineâ€™s task completes</span></pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token class-name">Boolean</span> executeFinally <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// Assume we're logically leaving the 'try' block</span></pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>m_state <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// If 1st time in state machine method,</span></pre></td></tr><tr><td data-num="39"></td><td><pre> m_local <span class="token operator">=</span> m_argument<span class="token punctuation">;</span> <span class="token comment">// execute start of original method</span></pre></td></tr><tr><td data-num="40"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> <span class="token comment">// Try block that we had in our original code</span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token class-name">TaskAwaiter<span class="token punctuation">&lt;</span>Type1<span class="token punctuation">></span></span> awaiterType1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token class-name">TaskAwaiter<span class="token punctuation">&lt;</span>Type2<span class="token punctuation">></span></span> awaiterType2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token keyword">switch</span> <span class="token punctuation">(</span>m_state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token comment">// Start execution of code in 'try'</span></pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token comment">// Call Method1Async and get its awaiter</span></pre></td></tr><tr><td data-num="48"></td><td><pre> awaiterType1 <span class="token operator">=</span> <span class="token function">Method1Async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAwaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>awaiterType1<span class="token punctuation">.</span>IsCompleted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre> m_state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 'Method1Async' is completing </span></pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token comment">// asynchronously</span></pre></td></tr><tr><td data-num="52"></td><td><pre> m_awaiterType1 <span class="token operator">=</span> awaiterType1<span class="token punctuation">;</span> <span class="token comment">// Save the awaiter for when we come back</span></pre></td></tr><tr><td data-num="53"></td><td><pre> <span class="token comment">// Tell awaiter to call MoveNext when operation completes</span></pre></td></tr><tr><td data-num="54"></td><td><pre> m_builder<span class="token punctuation">.</span><span class="token function">AwaitUnsafeOnCompleted</span><span class="token punctuation">(</span><span class="token keyword">ref</span> awaiterType1<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token comment">// The line above invokes awaiterType1's OnCompleted which approximately </span></pre></td></tr><tr><td data-num="56"></td><td><pre> <span class="token comment">// calls ContinueWith(t => MoveNext()) on the Task being awaited.</span></pre></td></tr><tr><td data-num="57"></td><td><pre> <span class="token comment">// When the Task completes, the ContinueWith task calls MoveNext</span></pre></td></tr><tr><td data-num="58"></td><td><pre> executeFinally <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// We're not logically leaving the 'try' </span></pre></td></tr><tr><td data-num="59"></td><td><pre> <span class="token comment">// block</span></pre></td></tr><tr><td data-num="60"></td><td><pre> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// Thread returns to caller</span></pre></td></tr><tr><td data-num="61"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre> <span class="token comment">// 'Method1Async' completed synchronously</span></pre></td></tr><tr><td data-num="63"></td><td><pre> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre> <span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment">// 'Method1Async' completed asynchronously</span></pre></td></tr><tr><td data-num="65"></td><td><pre> awaiterType1 <span class="token operator">=</span> m_awaiterType1<span class="token punctuation">;</span> <span class="token comment">// Restore most-recent awaiter</span></pre></td></tr><tr><td data-num="66"></td><td><pre> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre> <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token comment">// 'Method2Async' completed asynchronously</span></pre></td></tr><tr><td data-num="68"></td><td><pre> awaiterType2 <span class="token operator">=</span> m_awaiterType2<span class="token punctuation">;</span> <span class="token comment">// Restore most-recent awaiter</span></pre></td></tr><tr><td data-num="69"></td><td><pre> <span class="token keyword">goto</span> ForLoopEpilog<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre> <span class="token comment">// After the first await, we capture the result &amp; start the 'for' loop</span></pre></td></tr><tr><td data-num="72"></td><td><pre> m_resultType1 <span class="token operator">=</span> awaiterType1<span class="token punctuation">.</span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Get awaiter's result</span></pre></td></tr><tr><td data-num="73"></td><td><pre> ForLoopPrologue<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="74"></td><td><pre> m_x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 'for' loop initialization</span></pre></td></tr><tr><td data-num="75"></td><td><pre> <span class="token keyword">goto</span> ForLoopBody<span class="token punctuation">;</span> <span class="token comment">// Skip to 'for' loop body</span></pre></td></tr><tr><td data-num="76"></td><td><pre> ForLoopEpilog<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="77"></td><td><pre> m_resultType2 <span class="token operator">=</span> awaiterType2<span class="token punctuation">.</span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre> m_x<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// Increment x after each loop iteration</span></pre></td></tr><tr><td data-num="79"></td><td><pre> <span class="token comment">// Fall into the 'for' loopâ€™s body</span></pre></td></tr><tr><td data-num="80"></td><td><pre> ForLoopBody<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="81"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>m_x <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 'for' loop test</span></pre></td></tr><tr><td data-num="82"></td><td><pre> <span class="token comment">// Call Method2Async and get its awaiter</span></pre></td></tr><tr><td data-num="83"></td><td><pre> awaiterType2 <span class="token operator">=</span> <span class="token function">Method2Async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAwaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>awaiterType2<span class="token punctuation">.</span>IsCompleted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre> m_state <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 'Method2Async' is completing asynchronously</span></pre></td></tr><tr><td data-num="86"></td><td><pre> m_awaiterType2 <span class="token operator">=</span> awaiterType2<span class="token punctuation">;</span> <span class="token comment">// Save the awaiter for when we come back</span></pre></td></tr><tr><td data-num="87"></td><td><pre> <span class="token comment">// Tell awaiter to call MoveNext when operation completes </span></pre></td></tr><tr><td data-num="88"></td><td><pre> m_builder<span class="token punctuation">.</span><span class="token function">AwaitUnsafeOnCompleted</span><span class="token punctuation">(</span><span class="token keyword">ref</span> awaiterType2<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre> executeFinally <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// We're not logically leaving the 'try' block</span></pre></td></tr><tr><td data-num="90"></td><td><pre> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// Thread returns to caller</span></pre></td></tr><tr><td data-num="91"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre> <span class="token comment">// 'Method2Async' completed synchronously</span></pre></td></tr><tr><td data-num="93"></td><td><pre> <span class="token keyword">goto</span> ForLoopEpilog<span class="token punctuation">;</span> <span class="token comment">// Completed synchronously, loop around</span></pre></td></tr><tr><td data-num="94"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="95"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Catch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="100"></td><td><pre> <span class="token comment">// Whenever a thread physically leaves a 'try', the 'finally' executes</span></pre></td></tr><tr><td data-num="101"></td><td><pre> <span class="token comment">// We only want to execute this code when the thread logically leaves the 'try'</span></pre></td></tr><tr><td data-num="102"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>executeFinally<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Finally"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="105"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="106"></td><td><pre> result <span class="token operator">=</span> <span class="token string">"Done"</span><span class="token punctuation">;</span> <span class="token comment">// What we ultimately want to return from the async function</span></pre></td></tr><tr><td data-num="107"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre> <span class="token comment">// Unhandled exception: complete state machine's Task with exception</span></pre></td></tr><tr><td data-num="110"></td><td><pre> m_builder<span class="token punctuation">.</span><span class="token function">SetException</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre> <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre> <span class="token comment">// No exception: complete state machine's Task with result</span></pre></td></tr><tr><td data-num="114"></td><td><pre> m_builder<span class="token punctuation">.</span><span class="token function">SetResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If you spend the time to walk through the preceding code and read all the comments, I think youâ€™ll be able to fully digest what the compiler does for you. However, there is a piece of glue that attaches the object being awaited to the state machine and I think it would be helpful if I explained how this piece of glue worked. Whenever you use the await operator in your code, the compiler takes the specified operand and attempts to call a GetAwaiter method on it. This method can be either an instance method or an extension method. The object returned from calling the GetAwaiter method is referred to as an awaiter. An awaiter is the glue I was referring to.</p></blockquote><blockquote><p>After the state machine obtains an awaiter, it queries its IsCompleted property. If the operation completed synchronously, true is returned and, as an optimization, the state machine simply continues executing. At this point, it calls the awaiterâ€™s GetResult method, which either throws an exception if the operation failed or returns the result if the operation was successful. The state machine continues running from here to process the result.</p></blockquote><blockquote><p>If the operation completes asynchronously, IsCompleted returns false. In this case, the state machine calls the awaiterâ€™s OnCompleted method passing it a delegate to the state machineâ€™s MoveNext method. And now, the state machine allows its thread to return back to where it came from so that it can execute other code. In the future, the awaiter, which wraps the underlying Task, knows when it completes and invokes the delegate causing MoveNext to execute. The fields within the state machine are used to figure out how to get to the right point in the code, giving the illusion that the method is continuing from where it left off. At this point, the code calls the awaiterâ€™s GetResult method and execution continues running from here to process the result.</p></blockquote><blockquote><p>That is how async functions work and the whole purpose is to simplify the coding effort normally involved when writing non-blocking code.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šç¼–è¯‘ <code>MyMethodAsync</code> æ—¶ï¼Œç¼–è¯‘å™¨å°†è¯¥æ–¹æ³•ä¸­çš„ä»£ç è½¬æ¢æˆä¸€ä¸ªçŠ¶æ€æœºç»“æ„ã€‚è¿™ç§ç»“æ„èƒ½æŒ‚èµ·å’Œæ¢å¤ã€‚èŠ±äº›æ—¶é—´æ¢³ç†ä¸Šè¿°ä»£ç å¹¶è¯»å®Œæ‰€æœ‰æ³¨é‡Šï¼Œæˆ‘çŒœä½ å°±èƒ½å®Œå…¨åœ°é¢†ä¼šç¼–è¯‘å™¨ä¸ºä½ åšçš„äº‹æƒ…äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœå°†è¢«ç­‰å¾…çš„å¯¹è±¡ä¸çŠ¶æ€æœºç²˜åˆèµ·æ¥è¿˜éœ€ç€é‡è§£é‡Šä¸€ä¸‹ã€‚ä»»ä½•æ—¶å€™ä½¿ç”¨ <code>await</code> æ“ä½œç¬¦ï¼Œç¼–è¯‘å™¨éƒ½ä¼šè·å–æ“ä½œæ•°ï¼Œå¹¶å°è¯•åœ¨å®ƒä¸Šé¢è°ƒç”¨ <code>GetAwaiter</code> æ–¹æ³•ã€‚è¿™å¯èƒ½æ˜¯å®ä¾‹æ–¹æ³•æˆ–æ‰©å±•æ–¹æ³•ã€‚è°ƒç”¨ <code>GetAwaiter</code> æ–¹æ³•æ‰€è¿”å›çš„å¯¹è±¡ç§°ä¸º <code>awaiter</code> (ç­‰å¾…è€…)ï¼Œæ­£æ˜¯å®ƒå°†è¢«ç­‰å¾…çš„å¯¹è±¡ä¸çŠ¶æ€æœºç²˜åˆèµ·æ¥ã€‚çŠ¶æ€æœºè·å¾— awaiter åï¼Œä¼šæŸ¥è¯¢å…¶ <code>IsCompleted</code> å±æ€§ã€‚å¦‚æœæ“ä½œå·²ç»ä»¥åŒæ­¥æ–¹å¼å®Œæˆäº†ï¼Œå±æ€§å°†è¿”å› <code>true</code> ï¼Œè€Œä½œä¸ºä¸€é¡¹ä¼˜åŒ–æªæ–½ï¼ŒçŠ¶æ€æœºå°†ç»§ç»­æ‰§è¡Œå¹¶è°ƒç”¨ awaiter çš„ <code>GetResult</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•è¦ä¹ˆæŠ›å‡ºå¼‚å¸¸ (æ“ä½œå¤±è´¥)ï¼Œè¦ä¹ˆè¿”å›ç»“æœ (æ“ä½œæˆåŠŸ)ã€‚çŠ¶æ€æœºç»§ç»­æ‰§è¡Œä»¥å¤„ç†ç»“æœã€‚å¦‚æœæ“ä½œä»¥å¼‚æ­¥æ–¹å¼å®Œæˆï¼Œ <code>IsCompleted</code> å°†è¿”å› <code>false</code> ã€‚çŠ¶æ€æœºè°ƒç”¨ awaiter çš„ <code>OnCompleted</code> æ–¹æ³•å¹¶å‘å®ƒä¼ é€’ä¸€ä¸ªå§”æ‰˜ (å¼•ç”¨çŠ¶æ€æœºçš„ <code>MoveNext</code> æ–¹æ³•)ã€‚ç°åœ¨ï¼ŒçŠ¶æ€æœºå…è®¸å®ƒçš„çº¿ç¨‹å›åˆ°åŸåœ°ä»¥æ‰§è¡Œå…¶ä»–ä»£ç ã€‚å°†æ¥æŸä¸ªæ—¶å€™ï¼Œå°è£…äº†åº•å±‚ä»»åŠ¡çš„ awaiter ä¼šåœ¨å®Œæˆæ—¶è°ƒç”¨å§”æ‰˜ä»¥æ‰§è¡Œ <code>MoveNext</code> ã€‚å¯æ ¹æ®çŠ¶æ€æœºä¸­çš„æ­£ç¡®ä½ç½®ï¼Œä½¿æ–¹æ³•èƒ½ä»å®ƒå½“åˆç¦»å¼€æ—¶çš„ä½ç½®ç»§ç»­ã€‚è¿™æ—¶ï¼Œä»£ç è°ƒç”¨ awaiter çš„ <code>GetResult</code> æ–¹æ³•ã€‚æ‰§è¡Œå°†ä»è¿™é‡Œç»§ç»­ï¼Œä»¥ä¾¿å¯¹ç»“æœè¿›è¡Œå¤„ç†ã€‚è¿™ä¾¿æ˜¯å¼‚æ­¥å‡½æ•°çš„å·¥ä½œåŸç†ï¼Œå¼€å‘äººå‘˜å¯ç”¨å®ƒè½»æ¾åœ°å†™å‡ºä¸é˜»å¡çš„ä»£ç ã€‚</p><h2 id="async-function-extensibility"><a class="anchor" href="#async-function-extensibility">#</a> Async Function Extensibility</h2><blockquote><p>As for extensibility, if you can wrap a Task object around an operation that completes in the future, you can use the await operator to await that operation. Having a single type (Task) to represent all kinds of asynchronous operations is phenomenally useful because it allows you to implement combinators (like Taskâ€™s WhenAll and WhenAny methods) and other helpful operations. Later in this chapter, I demonstrate doing this by wrapping a CancellationToken with a Task so I can await an asynchronous operation while also exposing timeout and cancellation.</p></blockquote><blockquote><p>Iâ€™d also like to share with you another example. The following is my TaskLogger class, which you can use to show you asynchronous operations that havenâ€™t yet completed. This is very useful in debugging scenarios especially when your application appears hung due to a bad request or a nonresponding server.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TaskLogger</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">TaskLogLevel</span> <span class="token punctuation">&#123;</span> None<span class="token punctuation">,</span> Pending <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">TaskLogLevel</span> LogLevel <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">TaskLogEntry</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> Task <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">internal</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> Tag <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">internal</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> LogTime <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">internal</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> CallerMemberName <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">internal</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> CallerFilePath <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">internal</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> CallerLineNumber <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">internal</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"LogTime=&#123;0&#125;, Tag=&#123;1&#125;, Member=&#123;2&#125;, File=&#123;3&#125;(&#123;4&#125;)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre> LogTime<span class="token punctuation">,</span> Tag <span class="token operator">??</span> <span class="token string">"(none)"</span><span class="token punctuation">,</span> CallerMemberName<span class="token punctuation">,</span> CallerFilePath<span class="token punctuation">,</span> CallerLineNumber<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span>Task<span class="token punctuation">,</span> TaskLogEntry<span class="token punctuation">></span></span> s_log <span class="token operator">=</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span>Task<span class="token punctuation">,</span> TaskLogEntry<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>TaskLogEntry<span class="token punctuation">></span></span> <span class="token function">GetLogEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> s_log<span class="token punctuation">.</span>Values<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">Log</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Task<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span> task<span class="token punctuation">,</span> <span class="token class-name">String</span> tag <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CallerMemberName</span></span><span class="token punctuation">]</span> <span class="token class-name">String</span> callerMemberName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CallerFilePath</span></span><span class="token punctuation">]</span> <span class="token class-name">String</span> callerFilePath <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CallerLineNumber</span></span><span class="token punctuation">]</span> <span class="token class-name">Int32</span> callerLineNumber <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token keyword">return</span> <span class="token punctuation">(</span>Task<span class="token operator">&lt;</span>TResult<span class="token operator">></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Task<span class="token punctuation">)</span>task<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> callerMemberName<span class="token punctuation">,</span> callerFilePath<span class="token punctuation">,</span> callerLineNumber<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task</span> <span class="token function">Log</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Task</span> task<span class="token punctuation">,</span> <span class="token class-name">String</span> tag <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CallerMemberName</span></span><span class="token punctuation">]</span> <span class="token class-name">String</span> callerMemberName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CallerFilePath</span></span><span class="token punctuation">]</span> <span class="token class-name">String</span> callerFilePath <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CallerLineNumber</span></span><span class="token punctuation">]</span> <span class="token class-name">Int32</span> callerLineNumber <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>LogLevel <span class="token operator">==</span> TaskLogLevel<span class="token punctuation">.</span>None<span class="token punctuation">)</span> <span class="token keyword">return</span> task<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> logEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskLogEntry</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre> Task <span class="token operator">=</span> task<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre> LogTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre> Tag <span class="token operator">=</span> tag<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre> CallerMemberName <span class="token operator">=</span> callerMemberName<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre> CallerFilePath <span class="token operator">=</span> callerFilePath<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre> CallerLineNumber <span class="token operator">=</span> callerLineNumber</pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre> s_log<span class="token punctuation">[</span>task<span class="token punctuation">]</span> <span class="token operator">=</span> logEntry<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre> task<span class="token punctuation">.</span><span class="token function">ContinueWith</span><span class="token punctuation">(</span>t <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token class-name">TaskLogEntry</span> entry<span class="token punctuation">;</span> s_log<span class="token punctuation">.</span><span class="token function">TryRemove</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token keyword">out</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre> TaskContinuationOptions<span class="token punctuation">.</span>ExecuteSynchronously<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token keyword">return</span> task<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>And here is some code that demonstrates the use of the class.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token preprocessor property">#<span class="token directive keyword">if</span> DEBUG</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Using TaskLogger incurs a memory and performance hit; so turn it on in debug builds</span></pre></td></tr><tr><td data-num="4"></td><td><pre> TaskLogger<span class="token punctuation">.</span>LogLevel <span class="token operator">=</span> TaskLogger<span class="token punctuation">.</span>TaskLogLevel<span class="token punctuation">.</span>Pending<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token preprocessor property">#<span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Initiate 3 task; for testing the TaskLogger, we control their duration explicitly</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Task<span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"2s op"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"5s op"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"6s op"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// Wait for all tasks but cancel after 3 seconds; only 1 task should complete in time</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// Note: WithCancellation is my extension method described later in this chapter</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WhenAll</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token function">WithCancellation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OperationCanceledException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">// Ask the logger which tasks have not yet completed and sort</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// them in order from the one thatâ€™s been waiting the longest</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> op <span class="token keyword">in</span> TaskLogger<span class="token punctuation">.</span><span class="token function">GetLogEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">OrderBy</span><span class="token punctuation">(</span>tle <span class="token operator">=></span> tle<span class="token punctuation">.</span>LogTime<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When I build and run this code, I get the following output.</p></blockquote><pre><code class="language-cmd">LogTime=7/16/2012 6:44:31 AM, Tag=6s op, Member=Go, File=C:\CLR via C#\Code\Ch28-1-IOOps.cs(332)
LogTime=7/16/2012 6:44:31 AM, Tag=5s op, Member=Go, File=C:\CLR via C#\Code\Ch28-1-IOOps.cs(331)
</code></pre><blockquote><p>In addition to all the flexibility you have with using Task, async functions have another extensibility point: the compiler calls GetAwaiter on whatever operand is used with await. So, the operand doesnâ€™t have to be a Task object at all; it can be of any type as long as it has a GetAwaiter method available to call. Here is an example of my own awaiter that is the glue between an async methodâ€™s state machine and an event being raised.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">EventAwaiter<span class="token punctuation">&lt;</span>TEventArgs<span class="token punctuation">></span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">INotifyCompletion</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">ConcurrentQueue<span class="token punctuation">&lt;</span>TEventArgs<span class="token punctuation">></span></span> m_events <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConcurrentQueue<span class="token punctuation">&lt;</span>TEventArgs<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">Action</span> m_continuation<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">region</span> Members invoked by the state machine</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// The state machine will call this first to get our awaiter; we return ourself</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">EventAwaiter<span class="token punctuation">&lt;</span>TEventArgs<span class="token punctuation">></span></span> <span class="token function">GetAwaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// Tell state machine if any events have happened yet</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> IsCompleted <span class="token punctuation">&#123;</span> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> m_events<span class="token punctuation">.</span>Count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// The state machine tells us what method to invoke later; we save it</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnCompleted</span><span class="token punctuation">(</span><span class="token class-name">Action</span> continuation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> Volatile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">ref</span> m_continuation<span class="token punctuation">,</span> continuation<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// The state machine queries the result; this is the await operator's result</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">TEventArgs</span> <span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token class-name">TEventArgs</span> e<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> m_events<span class="token punctuation">.</span><span class="token function">TryDequeue</span><span class="token punctuation">(</span><span class="token keyword">out</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">return</span> e<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// Potentially invoked by multiple threads simultaneously when each raises the event</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EventRaised</span><span class="token punctuation">(</span><span class="token class-name">Object</span> sender<span class="token punctuation">,</span> <span class="token class-name">TEventArgs</span> eventArgs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> m_events<span class="token punctuation">.</span><span class="token function">Enqueue</span><span class="token punctuation">(</span>eventArgs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Save EventArgs to return it from GetResult/await</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token comment">// If there is a pending continuation, this thread takes it</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token class-name">Action</span> continuation <span class="token operator">=</span> Interlocked<span class="token punctuation">.</span><span class="token function">Exchange</span><span class="token punctuation">(</span><span class="token keyword">ref</span> m_continuation<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>continuation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token function">continuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Resume the state machine</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>And here is a method that uses my EventAwaiter class to return from an await operator whenever an event is raised. In this case, the state machine continues whenever any thread in the AppDomain throws an exception</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ShowExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> eventAwaiter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EventAwaiter<span class="token punctuation">&lt;</span>FirstChanceExceptionEventArgs<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> AppDomain<span class="token punctuation">.</span>CurrentDomain<span class="token punctuation">.</span>FirstChanceException <span class="token operator">+=</span> eventAwaiter<span class="token punctuation">.</span>EventRaised<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"AppDomain exception: &#123;0&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">(</span><span class="token keyword">await</span> eventAwaiter<span class="token punctuation">)</span><span class="token punctuation">.</span>Exception<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>And finally, here is some code that demonstrates it all working.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token function">ShowExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">switch</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ObjectDisposedException</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentOutOfRangeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>ğŸ’¡å°ç»“ï¼šåœ¨æ‰©å±•æ€§æ–¹é¢ï¼Œèƒ½ç”¨ <code>Task</code> å¯¹è±¡åŒ…è£…ä¸€ä¸ªå°†æ¥å®Œæˆçš„æ“ä½œï¼Œå°±å¯ä»¥ç”¨ <code>await</code> æ“ä½œç¬¦æ¥ç­‰å¾…è¯¥æ“ä½œã€‚ç”¨ä¸€ä¸ªç±»å‹ ( <code>Task</code> ) æ¥è¡¨ç¤ºå„ç§å¼‚æ­¥æ“ä½œå¯¹ç¼–ç æœ‰åˆ©ï¼Œå› ä¸ºå¯ä»¥å®ç°ç»„åˆæ“ä½œ (æ¯”å¦‚ <code>Task</code> çš„ <code>WhenAll</code> å’Œ <code>WhenAny</code> æ–¹æ³•) å’Œå…¶ä»–æœ‰ç”¨çš„æ“ä½œã€‚é™¤äº†å¢å¼ºä½¿ç”¨ <code>Task</code> æ—¶çš„çµæ´»æ€§ï¼Œå¼‚æ­¥å‡½æ•°å¦ä¸€ä¸ªå¯¹æ‰©å±•æ€§æœ‰åˆ©çš„åœ°æ–¹åœ¨äºç¼–è¯‘å™¨å¯ä»¥åœ¨ <code>await</code> çš„ä»»ä½•æ“ä½œæ•°ä¸Šè°ƒç”¨ <code>GetAwaiter</code> ã€‚æ‰€ä»¥æ“ä½œæ•°ä¸ä¸€å®šæ˜¯ <code>Task</code> å¯¹è±¡ã€‚å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œåªè¦æä¾›äº†ä¸€ä¸ªå¯ä»¥è°ƒç”¨çš„ <code>GetAwaiter</code> æ–¹æ³•ã€‚</p><h2 id="async-functions-and-event-handlers"><a class="anchor" href="#async-functions-and-event-handlers">#</a> Async Functions and Event Handlers</h2><blockquote><p>Async functions usually have a return type of either Task or Task to represent the completion of the functionâ€™s state machine. However, it is also possible to define an async function with a void return type. This is a special case that the C# compiler allows to simplify the very common scenario where you want to implement an asynchronous event handler.</p></blockquote><blockquote><p>Almost all event handler methods adhere to a method signature similar to this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EventHandlerCallback</span><span class="token punctuation">(</span><span class="token class-name">Object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>But, it is common to want to perform I/O operations inside an event handler, for example, when a user clicks a UI element to open a file and read from it. To keep the UI responsive, this I/O should be done asynchronously. Allowing you to write this code in an event handler method that has a void return type requires that the C# compiler allows async functions to have a void return type so you can use the await operator to perform non-blocking I/O operations. When an async function has a void return type, the compiler still generates code to create the state machine but it does not create a Task object because there is no way that one could be used. Because of this, there is no way to know when the state machine of a void-returning async function has run to completion.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šå¼‚æ­¥å‡½æ•°çš„è¿”å›ç±»å‹ä¸€èˆ¬æ˜¯ <code>Task</code> æˆ– <code>Task&lt;TResult&gt;</code> ï¼Œå®ƒä»¬ä»£è¡¨å‡½æ•°çš„çŠ¶æ€æœºå®Œæˆã€‚ä½†å¼‚æ­¥å‡½æ•°æ˜¯å¯ä»¥è¿”å› <code>void</code> çš„ã€‚å®ç°å¼‚æ­¥äº‹ä»¶å¤„ç†ç¨‹åºæ—¶ï¼ŒC# ç¼–è¯‘å™¨å…è®¸ä½ åˆ©ç”¨è¿™ä¸ªç‰¹æ®Šæƒ…å†µç®€åŒ–ç¼–ç ã€‚ä½†ç»å¸¸éœ€è¦åœ¨äº‹ä»¶å¤„ç†æ–¹æ³•ä¸­æ‰§è¡Œ I/O æ“ä½œï¼Œæ¯”å¦‚åœ¨ç”¨æˆ·ç‚¹å‡» UI å…ƒç´ æ¥æ‰“å¼€å¹¶è¯»å–æ–‡ä»¶æ—¶ã€‚ä¸ºäº†ä¿æŒ UI çš„å¯å“åº”æ€§ï¼Œè¿™ä¸ª I/O åº”è¯¥ä»¥å¼‚æ­¥å‡½æ•°è¿”å› <code>void</code> çš„äº‹ä»¶å¤„ç†æ–¹æ³•ä¸­å†™è¿™æ ·çš„ä»£ç ï¼ŒC# ç¼–è¯‘å™¨å°±è¦å…è®¸å¼‚æ­¥å‡½æ•°è¿”å› <code>void</code> ï¼Œè¿™æ ·æ‰èƒ½åˆ©ç”¨ <code>await</code> æ“ä½œç¬¦æ‰§è¡Œä¸é˜»å¡çš„ I/O æ“ä½œã€‚ç¼–è¯‘å™¨ä»ç„¶ä¸ºè¿”å› <code>void</code> çš„å¼‚æ­¥å‡½æ•°åˆ›å»ºçŠ¶æ€æœºï¼Œä½†ä¸å†åˆ›å»º <code>Task</code> å¯¹è±¡ï¼Œå› ä¸ºåˆ›å»ºäº†ä¹Ÿæ²¡æ³•ä½¿ç”¨ã€‚æ‰€ä»¥ï¼Œæ²¡æœ‰åŠæ³•çŸ¥é“è¿”å› <code>void</code> çš„å¼‚æ­¥å‡½æ•°çš„çŠ¶æ€æœºåœ¨ä»€ä¹ˆæ—¶å€™è¿è¡Œå®Œæ¯•ã€‚</p><h2 id="async-functions-in-the-framework-class-library"><a class="anchor" href="#async-functions-in-the-framework-class-library">#</a> Async Functions in the Framework Class Library</h2><blockquote><p>Personally, I love async functions because they are relatively easy to learn, simple to use, and they are supported by many types in the FCL. It is easy to identify async functions because, by convention, Async is suffixed onto the methodâ€™s name. In the Framework Class Library (FCL), many of the types that offer I/O operations offer XxxAsync methods.6 Here are some examples.</p><ul><li><p>All the System.IO.Stream-derived classes offer ReadAsync, WriteAsync, FlushAsync, and CopyToAsync methods.</p></li><li><p>All the System.IO.TextReader-derived classed offer ReadAsync, ReadLineAsync, ReadToEndAsync, and ReadBlockAsync methods. And the System.IO.TextWriter-derived classes offer WriteAsync, WriteLineAsync, and FlushAsync methods.</p></li><li><p>The System.Net.Http.HttpClient class offers GetAsync, GetStreamAsync, GetByteArrayAsync, PostAsync, PutAsync, DeleteAsync, and many more.</p></li><li><p>All System.Net.WebRequest-derived classes (including FileWebRequest, FtpWebRequest, and HttpWebRequest) offer GetRequestStreamAsync and GetResponseAsync methods.</p></li><li><p>The System.Data.SqlClient.SqlCommand class offers ExecuteDbDataReaderAsync, ExecuteNonQueryAsync, ExecuteReaderAsync, ExecuteScalarAsync, and ExecuteXmlReaderAsync methods.</p></li><li><p>Tools (such as SvcUtil.exe) that produce web service proxy types also generate XxxAsync methods.</p></li></ul></blockquote><blockquote><p>For anyone who has been working with earlier versions of the .NET Framework, you may be familiar with some other asynchronous programming models that it offered. There is the programming model that used BeginXxx and EndXxx methods along with an IAsyncResult interface. And there is the event-based programming model that also had XxxAsync methods (that did not return Task objects) and invoked event handler methods when an asynchronous operation completed. These two asynchronous programming models are now considered obsolete and the new model using Task objects is the preferred model.</p></blockquote><blockquote><p>While looking through the FCL, you might notice some classes that are lacking XxxAsync methods and instead only offer BeginXxx and EndXxx methods. This is mostly due to Microsoft not having the time to update these classes with the new methods. In the future, Microsoft should be enhancing these classes so that they fully support the new model. However, until they do, there is a helper method that you can use to adapt the old BeginXxx and EndXxx model to the new Task-based model.</p></blockquote><blockquote><p>Earlier I showed the code for a client application that makes a request over a named pipe. Let me show the server side of this code now.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">StartServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> pipe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NamedPipeServerStream</span><span class="token punctuation">(</span>c_pipeName<span class="token punctuation">,</span> PipeDirection<span class="token punctuation">.</span>InOut<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre> PipeTransmissionMode<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> PipeOptions<span class="token punctuation">.</span>Asynchronous <span class="token operator">|</span> PipeOptions<span class="token punctuation">.</span>WriteThrough<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Asynchronously accept a client connection</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// NOTE: NamedPipServerStream uses the old Asynchronous Programming Model (APM) </span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// I convert the old APM to the new Task model via TaskFactory's FromAsync method</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">await</span> Task<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">FromAsync</span><span class="token punctuation">(</span>pipe<span class="token punctuation">.</span>BeginWaitForConnection<span class="token punctuation">,</span> pipe<span class="token punctuation">.</span>EndWaitForConnection<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Start servicing the client, which returns immediately because it is asynchronous</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token function">ServiceClientRequestAsync</span><span class="token punctuation">(</span>pipe<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The NamedPipeServerStream class has BeginWaitForConnection and EndWaitForConnection methods defined, but it does not yet have a WaitForConnectionAsync method defined. Hopefully this method will be added in a future version of the FCL. However, all is not lost, because, as you see in the preceding code, I call TaskSchedulerâ€™s FromAsync method, passing into it the names of the BeginXxx and EndXxx methods, and then FromAsync internally creates a Task object that wraps these methods. Now I can use the Task object with the await operator.</p></blockquote><blockquote><p>For the old event-based programming model, the FCL does not include any helper methods to adapt this model into the new Task-based model. So you have to hand-code it. Here is code demonstrating how to wrap a WebClient (which uses the event-based programming model) with a TaskCompletionSource so it can be awaited on in an async function.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> <span class="token function">AwaitWebClient</span><span class="token punctuation">(</span><span class="token class-name">Uri</span> uri<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// The System.Net.WebClient class supports the Event-based Asynchronous Pattern</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> wc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>WebClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Create the TaskCompletionSource and its underlying Task object</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> tcs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskCompletionSource<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// When a string completes downloading, the WebClient object raises the</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// DownloadStringCompleted event, which completes the TaskCompletionSource</span></pre></td></tr><tr><td data-num="8"></td><td><pre> wc<span class="token punctuation">.</span>DownloadStringCompleted <span class="token operator">+=</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>Cancelled<span class="token punctuation">)</span> tcs<span class="token punctuation">.</span><span class="token function">SetCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>Error <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> tcs<span class="token punctuation">.</span><span class="token function">SetException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">else</span> tcs<span class="token punctuation">.</span><span class="token function">SetResult</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// Start the asynchronous operation</span></pre></td></tr><tr><td data-num="14"></td><td><pre> wc<span class="token punctuation">.</span><span class="token function">DownloadStringAsync</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token comment">// Now, we can the TaskCompletionSourceâ€™s Task and process the result as usual</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token keyword">await</span> tcs<span class="token punctuation">.</span>Task<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token comment">// Process the resulting string (if desired)...</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>ğŸ’¡å°ç»“ï¼šå¼‚æ­¥å‡½æ•°å¾ˆå®¹æ˜“åˆ†è¾¨ï¼Œå› ä¸ºè§„èŒƒè¦æ±‚ä¸ºæ–¹æ³•åé™„åŠ  <code>Async</code> åç¼€ã€‚åœ¨ FCL ä¸­ï¼Œæ”¯æŒ I/O æ“ä½œçš„è®¸å¤šç±»å‹éƒ½æä¾›äº† <code>XxxAsync</code> æ–¹æ³•ã€‚ç”¨è¿‡æ—©èµ·ç‰ˆæœ¬çš„ .NET Framework çš„å¼€å‘äººå‘˜åº”è¯¥ç†Ÿæ‚‰å®ƒæä¾›çš„å…¶ä»–å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ã€‚æœ‰ä¸€ä¸ªç¼–ç¨‹æ¨¡å‹ä½¿ç”¨ <code>BeginXxx/EndXxx</code> æ–¹æ³•å’Œ <code>IAsyncResult</code> æ¥å£ã€‚è¿˜æœ‰ä¸€ä¸ªåŸºäºäº‹ä»¶çš„ç¼–ç¨‹æ¨¡å‹ï¼Œå®ƒä¹Ÿæä¾›äº† <code>XxxAsync</code> æ–¹æ³• (ä¸è¿”å› <code>Task</code> å¯¹è±¡)ï¼Œèƒ½åœ¨å¼‚æ­¥æ“ä½œå®Œæˆæ—¶è°ƒç”¨äº‹ä»¶å¤„ç†ç¨‹åºã€‚ç°åœ¨è¿™ä¸¤ä¸ªå¼‚æ­¥ç¼–ç¨‹æ¨¡å‹å·²ç»è¿‡æ—¶ï¼Œä½¿ç”¨ <code>Task</code> çš„æ–°æ¨¡å‹æ‰æ˜¯ä½ çš„é¦–è¦é€‰æ‹©ã€‚å½“å‰ï¼ŒFCL çš„ä¸€äº›ç±»ç¼ºä¹ <code>XxxAsync</code> æ–¹æ³•ï¼Œåªæä¾›äº† <code>BeginXxx</code> å’Œ <code>EndXxx</code> æ–¹æ³•ã€‚è¿™ä¸»è¦æ˜¯ç”±äº Microsoft æ²¡æœ‰æ—¶é—´ç”¨æ–°æ–¹æ³•æ›´æ–°è¿™äº›ç±»ã€‚Microsoft å°†æ¥ä¼šå¢å¼ºè¿™äº›ç±»ï¼Œä½¿å…¶å®Œå…¨æ”¯æŒæ–°æ¨¡å‹ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œæœ‰ä¸€ä¸ªè¾…åŠ©æ–¹æ³•å¯å°†æ—§çš„ <code>BeginXxx</code> å’Œ <code>EndXxx</code> æ–¹æ³•è½¬å˜æˆæ–°çš„ã€åŸºäº <code>Task</code> çš„æ¨¡å‹ã€‚è°ƒç”¨ <code>TaskFactory</code> çš„ <code>FromAsync</code> æ–¹æ³•ï¼Œå‘å®ƒä¼ é€’ <code>BeginXxx</code> å’Œ <code>EndXxx</code> æ–¹æ³•çš„åç§°ã€‚ç„¶åï¼Œ <code>FromAsync</code> å†…éƒ¨åˆ›å»ºä¸€ä¸ª <code>Task</code> å¯¹è±¡æ¥åŒ…è£…è¿™äº›æ–¹æ³•ã€‚ç°åœ¨å°±å¯ä»¥éšåŒ <code>await</code> æ“ä½œç¬¦ä½¿ç”¨ <code>Task</code> å¯¹è±¡äº†ã€‚FCL æ²¡æœ‰æä¾›ä»»ä½•è¾…åŠ©æ–¹æ³•å°†æ—§çš„ã€åŸºäºäº‹ä»¶çš„ç¼–ç¨‹æ¨¡å‹æ”¹ç¼–æˆæ–°çš„ã€åŸºäº <code>Task</code> çš„æ¨¡å‹ã€‚æ‰€ä»¥åªèƒ½é‡‡ç”¨ç¡¬ç¼–ç çš„æ–¹å¼ã€‚</p><h2 id="async-functions-and-exception-handling"><a class="anchor" href="#async-functions-and-exception-handling">#</a> Async Functions and Exception Handling</h2><blockquote><p>When a Windows device driver is processing an asynchronous I/O request, it is possible for something to go wrong, and Windows will need to inform your application of this. For example, while sending bytes or waiting for bytes to come in over the network, a timeout could expire. If the data does not come in time, the device driver will want to tell you that the asynchronous operation completed with an error. To accomplish this, the device driver posts the completed IRP to the CLRâ€™s thread pool and a thread pool thread will complete the Task object with an exception. When your state machine method is resumed, the await operator sees that the operation failed and throws this exception.</p></blockquote><blockquote><p>In Chapter 27, I discussed how Task objects normally throw an AggregateException, and then youâ€™d query this exceptionâ€™s InnerExceptions property to see the real exception(s) that occurred. However, when using await with a Task, the first inner exception is thrown instead of an AggregateException.8 This was done to give you the programming experience you expect. Also, without this, youâ€™d have to catch AggregateException throughout your code, check the inner exception and either handle the exception or re-throw it. This would be very cumbersome.</p></blockquote><blockquote><p>If your state machine method experiences an unhandled exception, then the Task object representing your async function completes due to the unhandled exception. Any code waiting for this Task object to complete will see the exception. However, it is also possible for an async function to have a void return type. In this case, there is no way for a caller to discover the unhandled exception. So, when a void-returning async function throws an unhandled exception, the compiler-generated code catches it and causes it to be rethrown using the callerâ€™s synchronization context (discussed later). If the caller executed via a GUI thread, the GUI thread will eventually rethrow the exception. If the caller executed via a non-GUI thread, some thread pool thread will eventually rethrow the exception. Usually, rethrowing these exceptions causes the whole process to terminate.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šä¸€ä¸ªçº¿ç¨‹æ± çº¿ç¨‹ä¼šå®Œæˆ <code>Task</code> å¯¹è±¡å¹¶è®¾ç½®å¼‚å¸¸ã€‚ä½ çš„çŠ¶æ€æœºæ–¹æ³•æ¢å¤æ—¶ï¼Œ <code>await</code> æ“ä½œç¬¦å‘ç°æ“ä½œå¤±è´¥å¹¶å¼•å‘è¯¥å¼‚å¸¸ã€‚ <code>Task</code> å¯¹è±¡é€šå¸¸æŠ›å‡ºä¸€ä¸ª <code>AggregateException</code> ï¼Œå¯æŸ¥è¯¢è¯¥å¼‚å¸¸çš„ <code>InnerExceptions</code> å±æ€§æ¥æŸ¥çœ‹çœŸæ­£å‘ç”Ÿäº†ä»€ä¹ˆå¼‚å¸¸ã€‚ä½†å°† <code>await</code> ç”¨äº <code>Task</code> æ—¶ï¼ŒæŠ›å‡ºçš„æ˜¯ç¬¬ä¸€ä¸ªå†…éƒ¨å¼‚å¸¸è€Œä¸æ˜¯ <code>AggregateException</code> ã€‚å¦‚æœçŠ¶æ€æœºå‡ºç°æœªå¤„ç†çš„å¼‚å¸¸ï¼Œé‚£ä¹ˆä»£è¡¨å¼‚æ­¥å‡½æ•°çš„ <code>Task</code> å¯¹è±¡ä¼šå› ä¸ºæœªå¤„ç†çš„å¼‚å¸¸è€Œå®Œæˆã€‚ç„¶åï¼Œæ­£åœ¨ç­‰å¾…è¯¥ <code>Task</code> çš„ä»£ç ä¼šçœ‹åˆ°å¼‚å¸¸ã€‚ä½†å¼‚æ­¥å‡½æ•°ä¹Ÿå¯èƒ½ä½¿ç”¨äº† <code>void</code> è¿”å›ç±»å‹ï¼Œè¿™æ—¶è°ƒç”¨è€…å°±æ²¡æœ‰åŠæ³•å‘ç°æœªå¤„ç†çš„å¼‚å¸¸ã€‚æ‰€ä»¥ï¼Œå½“è¿”å› <code>void</code> çš„å¼‚æ­¥å‡½æ•°æŠ›å‡ºæœªå¤„ç†çš„å¼‚å¸¸æ—¶ï¼Œç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç å°†æ•æ‰å®ƒï¼Œå¹¶ä½¿ç”¨è°ƒç”¨è€…çš„åŒæ­¥ä¸Šä¸‹æ–‡ (ç¨åè®¨è®º) é‡æ–°æŠ›å‡ºå®ƒã€‚å¦‚æœè°ƒç”¨è€…é€šè¿‡ GUI çº¿ç¨‹æ‰§è¡Œï¼Œ GUI çº¿ç¨‹æœ€ç»ˆå°†é‡æ–°æŠ›å‡ºå¼‚å¸¸ã€‚é‡æ–°æŠ›å‡ºè¿™ç§å¼‚å¸¸é€šå¸¸é€ æˆæ•´ä¸ªè¿›ç¨‹ç»ˆæ­¢ã€‚</p><h2 id="other-async-function-features"><a class="anchor" href="#other-async-function-features">#</a> Other Async Function Features</h2><blockquote><p>In this section, Iâ€™d like to share with you some additional features related to async functions. Microsoft Visual Studio has great support for debugging async functions. When the debugger is stopped on an await operator, stepping over (F10) will actually break into the debugger when the next statement is reached after the operation completes. This code might even execute on a different thread than the one that initiated the operation! This is incredibly useful and simplifies debugging substantially.</p></blockquote><blockquote><p>Also, if you accidentally step into (F11), an async function, you can step out (Shift+F11) of the function to get back to the caller; you must do this while on the opening brace of the async function. After you pass the open brace, step out (Shift+F11) wonâ€™t break until the async function runs all the way to completion. If you need to debug the calling method before the state machine runs to completion, put a breakpoint in the calling method and just run (F5) to it.</p></blockquote><blockquote><p>Some asynchronous operations execute quickly and therefore complete almost instantaneously. When this happens, it is inefficient to suspend the state machine and then have another thread immediately resume the state machine; it is much more efficient to have the state machine just continue its execution. Fortunately, the await operatorâ€™s compiler-generated code does check for this. If an asynchronous operation completes just before the thread would return, the thread does not return and instead, it just executes the next line of code.</p></blockquote><blockquote><p>This is all fine and good but occasionally, you might have an async function that performs an intensive amount of processing before initiating an asynchronous operation. If you invoke the function via your appâ€™s GUI thread, your user interface will become non-responsive to the user. And, if the asynchronous operation completes synchronously, then your user-interface will be non-responsive even longer. So, if you want to initiate an async function from a thread other than the thread that calls it, you can use Taskâ€™s static Run method as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Task.Run is called on the GUI thread</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// This code runs on a thread pool thread</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// TODO: Do intensive compute-bound processing here...</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">await</span> <span class="token function">XxxAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Initiate asynchronous operation</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Do more processing here...</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>This code demonstrates another C# feature: async lambda expressions. You see, you canâ€™t just put an await operator inside the body of a regular lambda expression, because the compiler wouldnâ€™t know how to turn the method into a state machine. But placing async just before the lambda expression causes the compiler to turn the lambda expression into a state machine method that returns a Task or Task, which can then be assigned to any Func delegate variable whose return type is Task or Task.</p></blockquote><blockquote><p>When writing code, it is very easy to invoke an async function, forgetting to use the await operator; the following code demonstrates.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OuterAsyncFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token function">InnerAsyncFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Oops, forgot to put the await operator on this line!</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Code here continues to execute while InnerAsyncFunction also continues to execute...</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InnerAsyncFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* Code in here not important */</span> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Fortunately, when you do this, the C# compiler issues the following warning: Because this call is not awaited, execution of the current method continues before the call is completed. Consider applying the 'await' operator to the result of the call. This is nice but on rare occasions, you actually donâ€™t care when InnerAsyncFunction completes, and you do want to write the preceding code and not have the compiler issue a warning.</p></blockquote><blockquote><p>To quiet the compiler warning, you can simply assign the Task returned from InnerAsyncFunction to a variable and then ignore the variable.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OuterAsyncFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> noWarning <span class="token operator">=</span> <span class="token function">InnerAsyncFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// I intend not to put the await operator on this line.</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Code here continues to execute while InnerAsyncFunction also continues to execute...</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Or, I prefer to define an extension method that looks like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MethodImpl</span><span class="token attribute-arguments"><span class="token punctuation">(</span>MethodImplOptions<span class="token punctuation">.</span>AggressiveInlining<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">// Causes compiler to optimize the call away</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NoWarning</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Task</span> task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* No code goes in here */</span> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>And then I can use it like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OuterAsyncFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token function">InnerAsyncFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoWarning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// I intend not to put the await operator on this line.</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Code here continues to execute while InnerAsyncFunction also continues to execute...</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>One of the truly great features of performing asynchronous I/O operations is that you can initiate many of them concurrently so that they are all executing in parallel. This can give your application a phenomenal performance boost. I never showed you the code that started my named pipe server and then made a bunch of client requests to it. Let me show that code now.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Start the server, which returns immediately because </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// it asynchronously waits for client requests</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token function">StartServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This returns void, so compiler warning to deal with</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Make lots of async client requests; save each client's Task&lt;String></span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token class-name">List<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span><span class="token punctuation">></span></span> requests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> requests<span class="token punctuation">.</span>Capacity<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre> requests<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">IssueClientRequestAsync</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token string">"Request #"</span> <span class="token operator">+</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// Asynchronously wait until all client requests have completed</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// NOTE: If 1+ tasks throws, WhenAll rethrows the last-throw exception</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">String<span class="token punctuation">[</span><span class="token punctuation">]</span></span> responses <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WhenAll</span><span class="token punctuation">(</span>requests<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Process all the responses</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> responses<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>responses<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>This code starts the named pipe server so that it is listening for client requests and then, in a for loop, it initiates 10,000 client requests as fast as it possibly can. Each time IssueClientRequestAsync is called, it returns a Task object, which I then add to a collection. Now, the named pipe server is processing these client requests as fast as it possibly can using thread pool threads that will try to keep all the CPUs on the machine busy.10 As the server completes processing each request; each requestâ€™s Task object completes with the string response returned from the server.</p></blockquote><blockquote><p>In the preceding code, I want to wait until all the client requests have gotten their response before processing their results. I accomplish this by calling Taskâ€™s static WhenAll method. Internally, this method creates a Task object that completes after all of the Listâ€™s Task objects have completed. I then await the Task object so that the state machine continues execution after all of the tasks have completed. After all the tasks have completed, I loop through all the responses at once and process them (call Console.WriteLine).</p></blockquote><blockquote><p>Perhaps youâ€™d prefer to process each response as it happens rather than waiting for all of them to complete. Accomplishing this is almost as easy by way of Taskâ€™s static WhenAny method. The revised code looks like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Start the server, which returns immediately because </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// it asynchronously waits for client requests</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token function">StartServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Make lots of async client requests; save each client's Task&lt;String></span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token class-name">List<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span><span class="token punctuation">></span></span> requests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> requests<span class="token punctuation">.</span>Capacity<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre> requests<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">IssueClientRequestAsync</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token string">"Request #"</span> <span class="token operator">+</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// Continue AS EACH task completes</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">while</span> <span class="token punctuation">(</span>requests<span class="token punctuation">.</span>Count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// Process each completed response sequentially</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token class-name">Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WhenAny</span><span class="token punctuation">(</span>requests<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> requests<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Remove the completed task from the collection</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// Process a single client's response</span></pre></td></tr><tr><td data-num="15"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Here, I create a while loop that iterates once per client request. Inside the loop I await Taskâ€™s WhenAny method, which returns one Task object at a time, indicating a client request that has been responded to by the server. After I get this Task object, I remove it from the collection, and then I query its result in order to process it (pass it to Console.WriteLine).</p></blockquote><p>ğŸ’¡å°ç»“ï¼šæœ‰çš„å¼‚æ­¥æ“ä½œæ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ï¼Œå‡ ä¹ç¬é—´å°±èƒ½å®Œæˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæŒ‚èµ·çŠ¶æ€æœºå¹¶è®©å¦ä¸€ä¸ªçº¿ç¨‹ç«‹å³æ¢å¤çŠ¶æ€æœºå°±æ˜¾å¾—ä¸å¤ªåˆ’ç®—ã€‚æ›´æœ‰æ•ˆçš„åšæ³•æ˜¯è®©çŠ¶æ€æœºç»§ç»­æ‰§è¡Œã€‚å¹¸å¥½ï¼Œç¼–è¯‘å™¨ä¸º <code>await</code> æ“ä½œç¬¦ç”Ÿæˆçš„ä»£ç èƒ½æ£€æµ‹åˆ°è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœå¼‚æ­¥æ“ä½œåœ¨çº¿ç¨‹è¿”å›å‰å®Œæˆï¼Œå°±é˜»æ­¢çº¿ç¨‹è¿”å›ï¼Œç›´æ¥ç”±å®ƒæ‰§è¡Œä¸‹ä¸€è¡Œä»£ç ã€‚åˆ°ç›®å‰ä¸ºæ­¢ä¸€åˆ‡éƒ½å¾ˆå®Œç¾ï¼Œä½†æœ‰æ—¶å¼‚æ­¥å‡½æ•°éœ€è¦å…ˆæ‰§è¡Œå¯†é›†çš„ã€è®¡ç®—é™åˆ¶çš„å¤„ç†ï¼Œå†å‘èµ·å¼‚æ­¥æ“ä½œã€‚å¦‚æœé€šè¿‡åº”ç”¨ç¨‹åºçš„ GUI çº¿ç¨‹æ¥è°ƒç”¨å‡½æ•°ï¼ŒUI å°±ä¼šçªç„¶å¤±å»å“åº”ï¼Œå¥½é•¿æ—¶é—´æ‰èƒ½æ¢å¤ã€‚å¦å¤–ï¼Œå¦‚æœæ“ä½œä»¥åŒæ­¥æ–¹å¼å®Œæˆï¼Œé‚£ä¹ˆ UI å¤±å»å“åº”çš„æ—¶é—´è¿˜ä¼šå˜å¾—æ›´é•¿ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯åˆ©ç”¨ <code>Task</code> çš„é™æ€ <code>Run</code> æ–¹æ³•ä»éè°ƒç”¨çº¿ç¨‹çš„å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œå¼‚æ­¥å‡½æ•°ã€‚ C# çš„å¼‚æ­¥ lambda è¡¨è¾¾å¼ä¸èƒ½åªåœ¨æ™®é€šçš„ lambda è¡¨è¾¾å¼ä¸»ä½“ä¸­æ·»åŠ  <code>await</code> æ“ä½œç¬¦å®Œäº‹ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¸çŸ¥é“å¦‚ä½•å°†æ–¹æ³•è½¬æ¢æˆçŠ¶æ€æœºã€‚ä½†åŒæ—¶åœ¨ lambda è¡¨è¾¾å¼å‰é¢æ·»åŠ  <code>async</code> ï¼Œç¼–è¯‘å™¨å°±èƒ½å°† lambda è¡¨è¾¾å¼è½¬æ¢æˆçŠ¶æ€æœºæ–¹æ³•æ¥è¿”å›ä¸€ä¸ª <code>Task</code> æˆ– <code>Task&lt;TResult&gt;</code> ï¼Œå¹¶å¯èµ‹ç»™è¿”å›ç±»å‹ä¸º <code>Task</code> æˆ– <code>Task&lt;TResult&gt;</code> çš„ä»»ä½• <code>Func</code> å§”æ‰˜å˜é‡ã€‚å¼‚æ­¥ I/O æ“ä½œæœ€å¥½çš„ä¸€ä¸ªåœ°æ–¹æ˜¯å¯ä»¥åŒæ—¶å‘èµ·è®¸å¤šè¿™æ ·çš„æ“ä½œï¼Œè®©å®ƒä»¬å¹¶è¡Œæ‰§è¡Œï¼Œä»è€Œæ˜¾è‘—æå‡åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚</p><h2 id="applications-and-their-threading-models"><a class="anchor" href="#applications-and-their-threading-models">#</a> Applications and Their Threading Models</h2><blockquote><p>The .NET Framework supports several different kinds of application models, and each application model can impose its own threading model. Console applications and Windows Services (which are really console applications; you just donâ€™t see the console) do not impose any kind of threading model; that is, any thread can do whatever it wants when it wants.</p></blockquote><blockquote><p>However, GUI applications, including Windows Forms, Windows Presentation Foundation (WPF), Silverlight, and Windows Store apps impose a threading model where the thread that created a UI element is the only thread allowed to update that UI element. It is common for the GUI thread to spawn off an asynchronous operation so that the GUI thread doesnâ€™t block and stop responding to user input like mouse, keystroke, pen, and touch events. However, when the asynchronous operation completes, a thread pool thread completes the Task object resuming the state machine.</p></blockquote><blockquote><p>For some application models, this is OK and even desired because itâ€™s efficient. But for some other application models, like GUI applications, this is a problem, because your code will throw an exception if it tries to update UI elements via a thread pool thread. Somehow, the thread pool thread must have the GUI thread update the UI elements.</p></blockquote><blockquote><p><span class="exturl" data-url="aHR0cDovL0FTUC5ORVQ=">ASP.NET</span> applications allow any thread to do whatever it wants. When a thread pool thread starts to process a clientâ€™s request, it can assume the clientâ€™s culture (System.Globalization.CultureInfo), allowing the web server to return culture-specific formatting for numbers, dates, and times.11 In addition, the web server can assume the clientâ€™s identity (System.Security.Principal. IPrincipal), so that the server can access only the resources that the client is allowed to access. When a thread pool thread spawns an asynchronous operation, it may be completed by another thread pool thread, which will be processing the result of an asynchronous operation. While this work is being performed on behalf of the original client request, the culture and identity needs to â€œflowâ€ to the new thread pool thread so any additional work done on behalf of the client is performed using the clientâ€™s culture and identity information.</p></blockquote><blockquote><p>Fortunately, the FCL defines a base class, called System.Threading.SynchronizationContext, which solves all these problems. Simply stated, a SynchronizationContext-derived object connects an application model to its threading model. The FCL defines several classes derived from SynchronizationContext, but usually you will not deal directly with these classes; in fact, many of them are not publicly exposed or documented.</p></blockquote><blockquote><p>For the most part, application developers do not need to know anything about the SynchronizationContext class. When you await a Task, the calling threadâ€™s SynchronizationContext object is obtained. When a thread pool thread completes the Task, the SynchronizationContext object is used, ensuring the right threading model for your application model. So, when a GUI thread awaits a Task, the code following the await operator is guaranteed to execute on the GUI thread as well, allowing that code to update UI elements. For an <span class="exturl" data-url="aHR0cDovL0FTUC5ORVQ=">ASP.NET</span> application, the code following the await operator is guaranteed to execute on a thread pool thread that has the clientâ€™s culture and principal information associated with it.</p></blockquote><blockquote><p>Most of the time, having a state machine resume using the application modelâ€™s threading model is phenomenally useful and convenient. But, on some occasions, this can get you into trouble. Here is an example that causes a WPF application to deadlock.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">MyWpfWindow</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Window</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token function">MyWpfWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> Title <span class="token operator">=</span> <span class="token string">"WPF Window"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnActivated</span><span class="token punctuation">(</span><span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Querying the Result property prevents the GUI thread from returning; </span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// the thread blocks waiting for the result</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token class-name">String</span> http <span class="token operator">=</span> <span class="token function">GetHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Result<span class="token punctuation">;</span> <span class="token comment">// Get the string synchronously!</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnActivated</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> <span class="token function">GetHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Issue the HTTP request and let the thread return from GetHttp</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">HttpResponseMessage</span> msg <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token string">"http://Wintellect.com/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// We never get here: The GUI thread is waiting for this method to finish but this method </span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// can't finish because the GUI thread is waiting for it to finish --> DEADLOCK!</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">return</span> <span class="token keyword">await</span> msg<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">ReadAsStringAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Developers creating class libraries definitely need to be aware of the SynchronizationContext class so they can write high-performance code that works with all application models. Because a lot of class library code is application model agnostic, we want to avoid the additional overhead involved in using a SynchronizationContext object. In addition, class library developers should do everything in their power to help application developers avoid deadlock situations. To solve both of these problems, both the Task and Task classes offer a method called ConfigureAwait whose signature looks like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Task defines this method:</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token return-type class-name">ConfiguredTaskAwaitable</span> <span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> continueOnCapturedContext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// Task&lt;TResult> defines this method:</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token return-type class-name">ConfiguredTaskAwaitable<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span> <span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> continueOnCapturedContext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Passing true to this method gives you the same behavior as not calling the method at all. But, if you pass false, the await operator does not query the calling threadâ€™s SynchronizationContext object and, when a thread pool thread completes the Task, it simply completes it and the code after the await operator executes via the thread pool thread.</p></blockquote><blockquote><p>Even though my GetHttp method is not class library code, the deadlock problem goes away if I add calls to ConfigureAwait. Here is the modified version of my GetHttp method.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> <span class="token function">GetHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Issue the HTTP request and let the thread return from GetHttp</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name">HttpResponseMessage</span> msg <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token string">"http://Wintellect.com/"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// We DO get here now because a thread pool can execute this code </span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// as opposed to forcing the GUI thread to execute it. </span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">return</span> <span class="token keyword">await</span> msg<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">ReadAsStringAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>As the preceding code shows, ConfigureAwait(false) must be applied to every Task object you await. This is because asynchronous operations may complete synchronously and, when this happens, the calling thread simply continues executing without returning to its caller; you never know which operation requires ignoring the SynchronizationContext object, so you have to tell all of them to ignore it. This also means that your class library code should be application model agnostic.</p></blockquote><blockquote><p>Alternatively, I could re-write my GetHttp method as follows so that the whole thing executes via a thread pool thread.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> <span class="token function">GetHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// We run on a thread pool thread now that has no SynchronizationContext on it</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name">HttpResponseMessage</span> msg <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token string">"http://Wintellect.com/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// We DO get here because some thread pool can execute this code </span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">return</span> <span class="token keyword">await</span> msg<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">ReadAsStringAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>In this version of the code, notice that my GetHttp method is not an async function; I removed the async keyword from the method signature, because the method no longer has an await operator in it. On the other hand, the lambda expression I pass to Task.Run is an async function.</p></blockquote><p>ğŸ’¡å°ç»“ï¼š.NET Framework æ”¯æŒå‡ ç§ä¸åŒçš„åº”ç”¨ç¨‹åºæ¨¡å‹ï¼Œè€Œæ¯ç§æ¨¡å‹éƒ½å¯èƒ½å¼•å…¥äº†å®ƒè‡ªå·±çš„çº¿ç¨‹å¤„ç†æ¨¡å‹ã€‚æ§åˆ¶å°åº”ç”¨ç¨‹åºå’Œ Windows æœåŠ¡ (å®é™…ä¹Ÿæ˜¯æ§åˆ¶å°åº”ç”¨ç¨‹åºï¼›åªæ˜¯çœ‹ä¸è§æ§åˆ¶å°è€Œå·²) æ²¡æœ‰å¼•å…¥ä»»ä½•çº¿ç¨‹å¤„ç†æ¨¡å‹ï¼›æ¢è¨€ä¹‹ï¼Œä»»ä½•çº¿ç¨‹å¯åœ¨ä»»ä½•æ—¶å€™åšå®ƒæƒ³åšçš„ä»»ä½•äº‹æƒ…ã€‚ä½† GUI åº”ç”¨ç¨‹åº (åŒ…æ‹¬ Windows çª—ä½“ã€WPFã€Silverlight å’Œ Windows Store åº”ç”¨ç¨‹åº) å¼•å…¥äº†ä¸€ä¸ªçº¿ç¨‹å¤„ç†æ¨¡å‹ã€‚åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼ŒUI å…ƒç´ åªèƒ½ç”±åˆ›å»ºå®ƒçš„çº¿ç¨‹æ›´æ–°ã€‚åœ¨ GUI çº¿ç¨‹ä¸­ï¼Œç»å¸¸éƒ½éœ€è¦ç”Ÿæˆä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œä½¿ GUI çº¿ç¨‹ä¸è‡³äºé˜»å¡å¹¶åœæ­¢å“åº”ç”¨æˆ·è¾“å…¥ (æ¯”å¦‚é¼ æ ‡ã€æŒ‰é”®ã€æ‰‹å†™ç¬”å’Œè§¦æ§äº‹ä»¶)ã€‚ä½†å½“å¼‚æ­¥æ“ä½œå®Œæˆæ—¶ï¼Œæ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹æ± çº¿ç¨‹å®Œæˆ <code>Task</code> å¯¹è±¡å¹¶æ¢å¤çŠ¶æ€æœºã€‚çº¿ç¨‹æ± çº¿ç¨‹ç”Ÿæˆä¸€ä¸ªå¼‚æ­¥æ“ä½œåï¼Œå®ƒå¯èƒ½ç”±å¦ä¸€ä¸ªçº¿ç¨‹æ± çº¿ç¨‹å®Œæˆï¼Œè¯¥çº¿ç¨‹å°†å¤„ç†å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚ä»£è¡¨åŸå§‹å®¢æˆ·ç«¯æ‰§è¡Œå·¥ä½œæ—¶ï¼Œè¯­è¨€æ–‡åŒ–å’Œèº«ä»½æ ‡è¯†ä¿¡æ¯éœ€è¦ â€œæµå‘â€ æ–°çš„çº¿ç¨‹æ± çº¿ç¨‹ã€‚è¿™æ ·ä¸€æ¥ï¼Œä»£è¡¨å®¢æˆ·ç«¯æ‰§è¡Œçš„ä»»ä½•é¢å¤–çš„å·¥ä½œæ‰èƒ½ä½¿ç”¨å®¢æˆ·ç«¯çš„è¯­è¨€æ–‡åŒ–å’Œèº«ä»½æ ‡è¯†ä¿¡æ¯ã€‚å¹¸å¥½ FCL å®šä¹‰äº†ä¸€ä¸ªå <code>System.Threading.SynchronizationContext</code> çš„åŸºç±»ï¼Œå®ƒè§£å†³äº†æ‰€æœ‰è¿™äº›é—®é¢˜ã€‚ç®€å•åœ°è¯´ï¼Œ <code>SynchronizationContext</code> æ´¾ç”Ÿå¯¹è±¡å°†åº”ç”¨ç¨‹åºæ¨¡å‹è¿æ¥åˆ°å®ƒçš„çº¿ç¨‹å¤„ç†æ¨¡å‹ã€‚åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜é€šå¸¸ä¸éœ€è¦äº†è§£å…³äº <code>SynchronizationContext</code> ç±»çš„ä»»ä½•äº‹æƒ…ã€‚ç­‰å¾…ä¸€ä¸ª <code>Task</code> æ—¶ä¼šè·å–è°ƒç”¨çº¿ç¨‹çš„ <code>SynchronizationContext</code> å¯¹è±¡ã€‚çº¿ç¨‹æ± çº¿ç¨‹å®Œæˆ <code>Task</code> åï¼Œä¼šä½¿ç”¨è¯¥ <code>SynchronizationContext</code> å¯¹è±¡ï¼Œç¡®ä¿ä¸ºåº”ç”¨ç¨‹åºæ¨¡å‹ä½¿ç”¨æ­£ç¡®çš„çº¿ç¨‹å¤„ç†æ¨¡å‹ã€‚æ‰€ä»¥ï¼Œå½“ GUI çº¿ç¨‹ç­‰å¾…ä¸€ä¸ª <code>Task</code> æ—¶ï¼Œ <code>await</code> æ“ä½œç¬¦åé¢çš„ä»£ç ä¿è¯åœ¨ GUI çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œä½¿ä»£ç èƒ½æ›´æ–° UI å…ƒç´ ã€‚å¯¹äº <span class="exturl" data-url="aHR0cDovL0FTUC5ORVQ=">ASP.NET</span> åº”ç”¨ç¨‹åºï¼Œ <code>await</code> åé¢çš„ä»£ç ä¿è¯åœ¨å…³è”äº†å®¢æˆ·ç«¯è¯­è¨€æ–‡åŒ–å’Œèº«ä»½æ ‡è¯†ä¿¡æ¯çš„çº¿ç¨‹æ± çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚ç±»åº“å¼€å‘äººå‘˜ä¸ºäº†å†™é«˜æ€§èƒ½çš„ä»£ç æ¥åº”å¯¹å„ç§åº”ç”¨ç¨‹åºæ¨¡å‹ï¼Œå°¤å…¶éœ€è¦æ³¨æ„ <code>SynchronizationContext</code> ç±»ã€‚ç”±äºè®¸å¤šç±»åº“ä»£ç éƒ½è¦æ±‚ä¸ä¾èµ–äºç‰¹å®šçš„åº”ç”¨ç¨‹åºæ¨¡å‹ï¼Œæ‰€ä»¥è¦é¿å…å› ä¸ºä½¿ç”¨ <code>SynchronizationContext</code> å¯¹è±¡è€Œäº§ç”Ÿçš„é¢å¤–å¼€é”€ã€‚æ­¤å¤–ï¼Œç±»åº“å¼€å‘äººå‘˜è¦ç«­å°½å…¨åŠ›å¸®åŠ©åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜é˜²æ­¢æ­»é”ã€‚ä¸ºäº†è§£å†³è¿™ä¸¤æ–¹é¢çš„é—®é¢˜ï¼Œ <code>Task</code> å’Œ <code>Task&lt;TResult&gt;</code> ç±»æä¾›äº†ä¸€ä¸ª <code>ConfigureAwait</code> æ–¹æ³•ã€‚å‘æ–¹æ³•ä¼ é€’ <code>true</code> ç›¸å½“äºæ ¹æœ¬æ²¡æœ‰è°ƒç”¨æ–¹æ³•ã€‚ä½†å¦‚æœä¼ é€’ <code>false</code> ï¼Œ <code>await</code> æ“ä½œç¬¦å°±ä¸æŸ¥è¯¢è°ƒç”¨çº¿ç¨‹çš„ <code>SynchronizationContext</code> å¯¹è±¡ã€‚å½“çº¿ç¨‹æ± çº¿ç¨‹ç»“æŸ <code>Task</code> æ—¶ä¼šç›´æ¥å®Œæˆå®ƒï¼Œ <code>await</code> æ“ä½œç¬¦åé¢çš„ä»£ç é€šè¿‡çº¿ç¨‹æ± çº¿ç¨‹æ‰§è¡Œã€‚</p><h2 id="implementing-a-server-asynchronously"><a class="anchor" href="#implementing-a-server-asynchronously">#</a> Implementing a Server Asynchronously</h2><blockquote><p>From talking to many developers over the years, Iâ€™ve discovered that very few of them are aware that the .NET Framework has built-in support allowing you to build asynchronous servers that scale really well. In this book, I canâ€™t explain how to do this for every kind of server, but I can list what you should look for in the MSDN documentation.</p><ul><li><p>To build asynchronous <span class="exturl" data-url="aHR0cDovL0FTUC5ORVQ=">ASP.NET</span> Web Forms: in your .aspx file, add â€œAsync=trueâ€ to your page directive and look up the System.Web.UI.Pageâ€™s RegisterAsyncTask method.</p></li><li><p>To build an asynchronous <span class="exturl" data-url="aHR0cDovL0FTUC5ORVQ=">ASP.NET</span> MVC controller: derive your controller class from System.Web.Mvc.AsyncController and simply have your action method return a Task.</p></li><li><p>To build an asynchronous <span class="exturl" data-url="aHR0cDovL0FTUC5ORVQ=">ASP.NET</span> handler: derive your class from System.Web.HttpTaskAsyncHandler and then override its abstract ProcessRequestAsync method.</p></li><li><p>To build an asynchronous WCF service: implement your service as an async function and have it return Task or Task.</p></li></ul></blockquote><p>ğŸ’¡å°ç»“ï¼š.NET Framework å…¶å®å†…å»ºäº†å¯¹ä¼¸ç¼©æ€§å¾ˆå¥½çš„ä¸€äº›å¼‚æ­¥æœåŠ¡å™¨çš„æ”¯æŒã€‚è¦æ„å»ºå¼‚æ­¥ <span class="exturl" data-url="aHR0cDovL0FTUC5ORVQ=">ASP.NET</span> Web çª—ä½“ï¼Œåœ¨ .aspx æ–‡ä»¶ä¸­æ·»åŠ  <code>Async=&quot;true&quot;</code> ç½‘é¡µæŒ‡ä»¤ï¼Œå¹¶å‚è€ƒ <code>System.Web.UI.Page</code> çš„ <code>RegisterAsyncTask</code> æ–¹æ³•ã€‚è¦æ„å»ºå¼‚æ­¥ <span class="exturl" data-url="aHR0cDovL0FTUC5ORVQ=">ASP.NET</span> MVC æ§åˆ¶å™¨ï¼Œä½¿ä½ çš„æ§åˆ¶å™¨ç±»ä» <code>System.Web.Mvc.AsyncController</code> æ´¾ç”Ÿï¼Œè®©æ“ä½œæ–¹æ³•è¿”å›ä¸€ä¸ª <code>Task&lt;ActionResult&gt;</code> å³å¯ã€‚è¦æ„å»ºå¼‚æ­¥ <span class="exturl" data-url="aHR0cDovL0FTUC5ORVQ=">ASP.NET</span> å¤„ç†ç¨‹åºï¼Œä½¿ä½ çš„ç±»ä» <code>System.Web.HttpTaskAsyncHandler</code> æ´¾ç”Ÿï¼Œé‡å†™å…¶æŠ½è±¡ <code>ProcessRequestAsync</code> æ–¹æ³•ã€‚è¦æ„å»ºå¼‚æ­¥ WCF æœåŠ¡ï¼Œå°†æœåŠ¡ä½œä¸ºå¼‚æ­¥å‡½æ•°å®ç°ï¼Œè®©å®ƒè¿”å› <code>Task</code> æˆ– <code>Task&lt;TResult&gt;</code> ã€‚</p><h2 id="canceling-io-operations"><a class="anchor" href="#canceling-io-operations">#</a> Canceling I/O Operations</h2><blockquote><p>In general, Windows doesnâ€™t give you a way to cancel an outstanding I/O operation. This is a feature that many developers would like, but it is actually quite hard to implement. After all, if you make a request from a server and then you decide you donâ€™t want the response anymore, there is no way to tell the server to abandon your original request. The way to deal with this is just to let the bytes come back to the client machine and then throw them away. In addition, there is a race condition hereâ€” your request to cancel the request could come just as the server is sending the response. Now what should your application do? Youâ€™d need to handle this potential race condition occurring in your own code and decide whether to throw the data away or act on it.</p></blockquote><blockquote><p>To assist with this, I recommend you implement a WithCancellation extension method that extends Task (you need a similar overload that extends Task too) as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">struct</span> <span class="token class-name">Void</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// Because there isn't a non-generic TaskCompletionSource class.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">WithCancellation</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Task<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span> originalTask<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Create a Task that completes when the CancellationToken is canceled</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> cancelTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskCompletionSource<span class="token punctuation">&lt;</span>Void<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// When the CancellationToken is canceled, complete the Task</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">using</span> <span class="token punctuation">(</span>ct<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="8"></td><td><pre> t <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">(</span>TaskCompletionSource<span class="token operator">&lt;</span>Void<span class="token operator">></span><span class="token punctuation">)</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">TrySetResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cancelTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// Create a Task that completes when either the original or </span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// CancellationToken Task completes</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">Task</span> any <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WhenAny</span><span class="token punctuation">(</span>originalTask<span class="token punctuation">,</span> cancelTask<span class="token punctuation">.</span>Task<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// If any Task completes due to CancellationToken, throw OperationCanceledException</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>any <span class="token operator">==</span> cancelTask<span class="token punctuation">.</span>Task<span class="token punctuation">)</span> ct<span class="token punctuation">.</span><span class="token function">ThrowIfCancellationRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token comment">// await original task (synchronously); if it failed, awaiting it </span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token comment">// throws 1st inner exception instead of AggregateException</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">return</span> <span class="token keyword">await</span> originalTask<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Now, you can call this extension method as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Create a CancellationTokenSource that cancels itself after # milliseconds</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// To cancel sooner, call cts.Cancel()</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> ct <span class="token operator">=</span> cts<span class="token punctuation">.</span>Token<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// I used Task.Delay for testing; replace this with another method that returns a Task</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithCancellation</span><span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Task completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OperationCanceledException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Task cancelled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>ğŸ’¡å°ç»“ï¼šWindows ä¸€èˆ¬æ²¡æœ‰æä¾›å–æ¶ˆæœªå®Œæˆ I/O æ“ä½œçš„é€”å¾„ã€‚è¿™æ˜¯è®¸å¤šå¼€å‘äººå‘˜éƒ½æƒ³è¦çš„åŠŸèƒ½ï¼Œå®ç°èµ·æ¥å´å¾ˆå›°éš¾ã€‚æ¯•ç«Ÿï¼Œå¦‚æœå‘æœåŠ¡å™¨è¯·æ±‚äº† 1000 ä¸ªå­—èŠ‚ï¼Œç„¶åå†³å®šä¸å†éœ€è¦è¿™äº›å­—èŠ‚ï¼Œé‚£ä¹ˆå…¶å®æ²¡æœ‰åŠæ³•å‘Šè¯‰æœåŠ¡å™¨å¿˜æ‰ä½ çš„è¯·æ±‚ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªèƒ½è®©å­—èŠ‚ç…§å¸¸è¿”å›ï¼Œå†å°†å®ƒä»¬ä¸¢å¼ƒã€‚æ­¤å¤–ï¼Œè¿™é‡Œè¿˜ä¼šå‘ç”Ÿç«æ€æ¡ä»¶ â€”â€”â€”â€” å–æ¶ˆè¯·æ±‚çš„è¯·æ±‚å¯èƒ½æ­£å¥½åœ¨æœåŠ¡å™¨å‘é€å“åº”çš„æ—¶å€™åˆ°æ¥ã€‚è¿™æ—¶åº”è¯¥æ€ä¹ˆåŠï¼Ÿæ‰€ä»¥ï¼Œè¦åœ¨ä»£ç ä¸­å¤„ç†è¿™ç§æ½œåœ¨çš„ç«æ€æ¡ä»¶ï¼Œå†³å®šæ˜¯ä¸¢å¼ƒè¿˜æ˜¯ä½¿ç”¨æ•°æ®ã€‚ä¸ºæ­¤ï¼Œä½œè€…å»ºè®®å®ç°ä¸€ä¸ª <code>WithCancellation</code> æ‰©å±•æ–¹æ³•æ¥æ‰©å±• <code>Task&lt;TResult&gt;</code> (éœ€è¦ç±»ä¼¼çš„é‡è½½ç‰ˆæœ¬æ¥æ‰©å±• <code>Task</code> )ã€‚</p><h2 id="some-io-operations-must-be-done-synchronously"><a class="anchor" href="#some-io-operations-must-be-done-synchronously">#</a> Some I/O Operations Must Be Done Synchronously</h2><blockquote><p>The Win32 API offers many functions that execute I/O operations. Unfortunately, some of these methods do not let you perform the I/O asynchronously. For example, the Win32 CreateFile method (called by FileStreamâ€™s constructor) always executes synchronously. If youâ€™re trying to create or open a file on a network server, it could take several seconds before CreateFile returnsâ€”the calling thread is idle all the while. An application designed for optimum responsiveness and scalability would ideally call a Win32 function that lets you create or open a file asynchronously so that your thread is not sitting and waiting for the server to reply. Unfortunately, Win32 has no CreateFile-like function to let you do this, and therefore the FCL cannot offer an efficient way to open a file asynchronously. Windows also doesnâ€™t offer functions to asynchronously access the registry, access the event log, get a directoryâ€™s files/subdirectories, or change a fileâ€™s/directoryâ€™s attributes, to name just a few.</p></blockquote><blockquote><p>Here is an example where this is a real problem. Imagine writing a simple UI control that allows the user to type a file path and provides automatic completion (similar to the common File Open dialog box). The control must use separate threads to enumerate directories looking for files because Windows doesnâ€™t offer any functions to enumerate files asynchronously. As the user continues to type in the UI control, you have to use more threads and ignore the results from any previously spawned threads. With Windows Vista, Microsoft introduced a new Win32 function called CancelSynchronousIO. This function allows one thread to cancel a synchronous I/O operation that is being performed by another thread. This function is not exposed by the FCL, but you can also P/Invoke to t if you want to take advantage of it from a desktop application implemented with managed code. I show the P/Invoke signature near the end of this chapter.</p></blockquote><blockquote><p>The point I want you to take away though is that many people think that synchronous APIs are easier to work with, and in many cases this is true. But in some cases, synchronous APIs make things much harder.</p></blockquote><blockquote><p>Due to all the problems that exist when executing I/O operations synchronously, when designing the Windows Runtime, the Windows team decided to expose all methods that perform I/O asynchronously. So, now there is a Windows Runtime API to open files asynchronously; see Windows. Storage.StorageFileâ€™s OpenAsync method. In fact, the Windows Runtime does not offer any APIs allowing you to perform an I/O operation synchronously. Fortunately, you can use the C#â€™s async function feature to simplify your coding when calling these APIs.</p></blockquote><h3 id="filestream-specific-issues"><a class="anchor" href="#filestream-specific-issues">#</a> FileStream-Specific Issues</h3><blockquote><p>When you create a FileStream object, you get to specify whether you want to communicate using synchronous or asynchronous operations via the FileOptions.Asynchronous flag (which is equivalent to calling the Win32 CreateFile function and passing into it the FILE_FLAG_OVERLAPPED flag). If you do not specify this flag, Windows performs all operations against the file synchronously. Of course, you can still call FileStreamâ€™s ReadAsync method, and to your application, it looks as if the operation is being performed asynchronously, but internally, the FileStream class uses another thread to emulate asynchronous behavior; use of this thread is wasteful and hurts performance.</p></blockquote><blockquote><p>On the other hand, you can create a FileStream object by specifying the FileOptions.Asynchronous flag. Then you can call FileStreamâ€™s Read method to perform a synchronous operation. Internally, the FileStream class emulates this behavior by starting an asynchronous operation and then immediately puts the calling thread to sleep until the operation is complete. This is also inefficient, but it is not as inefficient as calling ReadAsync by using a FileStream constructed without the FileOptions.Asynchronous flag.</p></blockquote><blockquote><p>So, to summarize, when working with a FileStream, you must decide up front whether you intend to perform synchronous or asynchronous I/O against the file and indicate your choice by specifying the FileOptions.Asynchronous flag (or not). If you specify this flag, always call ReadAsync. If you do not specify this flag, always call Read. This will give you the best performance. If you intend to make some synchronous and some asynchronous operations against the FileStream, it is more efficient to construct it using the FileOptions.Asynchronous flag. Alternatively, you can create two FileStream objects over the same file; open one FileStream for asynchronous I/O and open the other FileStream for synchronous I/O. Note that the System.IO.Fileâ€™s class offers helper methods (Create, Open, and OpenWrite) that create and return FileStream objects. Internally, none of these methods specify the FileOptions.Asynchronous flag, so you should avoid using these methods if you want to create a responsive or scalable application.</p></blockquote><blockquote><p>You should also be aware that the NTFS file system device driver performs some operations synchronously no matter how you open the file. For more information about this, see http:// <span class="exturl" data-url="aHR0cDovL3N1cHBvcnQubWljcm9zb2Z0LmNvbS9kZWZhdWx0LmFzcHg/c2NpZD1rYiUzQmVuLXVzJTNCMTU2OTMy">support.microsoft.com/default.aspx?scid=kb%3Ben-us%3B156932</span>.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šWin32 API æä¾›äº†è®¸å¤š I/O å‡½æ•°ã€‚é—æ†¾çš„æ˜¯ï¼Œæœ‰çš„æ–¹æ³•ä¸å…è®¸ä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œ I/Oã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæ³¨é‡æ€§èƒ½å’Œä¼¸ç¼©æ€§çš„åº”ç”¨ç¨‹åºåº”è¯¥è°ƒç”¨ä¸€ä¸ªå…è®¸ä»¥å¼‚æ­¥æ–¹å¼åˆ›å»ºæˆ–æ‰“å¼€æ–‡ä»¶çš„ Win32 å‡½æ•°ï¼Œä½¿çº¿ç¨‹ä¸è‡³äºå‚»ä¹ä¹åœ°ç­‰ç€æœåŠ¡å™¨å“åº”ã€‚é—æ†¾çš„æ˜¯ï¼ŒWin32 æ²¡æœ‰æä¾›ä¸€ä¸ªå…è®¸è¿™æ ·åšä¸”åŠŸèƒ½å’Œ <code>CreateFile</code> ç›¸åŒçš„å‡½æ•°ã€‚å› æ­¤ï¼ŒFCL ä¸èƒ½ä»¥å¼‚æ­¥æ–¹å¼é«˜æ•ˆåœ°æ‰“å¼€æ–‡ä»¶ã€‚å¦å¤–ï¼ŒWindows ä¹Ÿæ²¡æœ‰æä¾›å‡½æ•°ä»¥å¼‚æ­¥æ–¹å¼è®¿é—®æ³¨å†Œè¡¨ã€è®¿é—®äº‹ä»¶æ—¥å¿—ã€è·å–ç›®å½•çš„æ–‡ä»¶ / å­ç›®å½•æˆ–è€…æ›´æ”¹æ–‡ä»¶ / ç›®å½•çš„å±äºç­‰ç­‰ã€‚ä» Windows Vista èµ·ï¼ŒMicrosoft å¼•å…¥äº†ä¸€ä¸ªåä¸º <code>CancelSynchronousIO</code> çš„ Win32 å‡½æ•°ã€‚å®ƒå…è®¸ä¸€ä¸ªçº¿ç¨‹å–æ¶ˆæ­£åœ¨ç”±å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„åŒæ­¥ I/O æ“ä½œã€‚FCL æ²¡æœ‰å…¬å¼€è¯¥å‡½æ•°ï¼Œä½†è¦åœ¨ç”¨æ‰˜ç®¡ä»£ç å®ç°çš„æ¡Œé¢åº”ç”¨ç¨‹åºä¸­åˆ©ç”¨å®ƒï¼Œå¯ä»¥ P/Invoke å®ƒã€‚è€ƒè™‘åˆ°åŒæ­¥ I/O æ“ä½œçš„å„ç§é—®é¢˜ï¼Œåœ¨è®¾è®¡ Windows Runtime çš„æ—¶å€™ï¼ŒWindows å›¢é˜Ÿå†³å®šå…¬å¼€ä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œ I/O çš„æ‰€æœ‰æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œç°åœ¨å¯ä»¥ç”¨ä¸€ä¸ª Windows Runtime API æ¥å¼‚æ­¥åœ°æ‰“å¼€æ–‡ä»¶äº†ï¼Œè¯¦æƒ…å‚è§ <code>Windows.Storage.StorageFile</code> çš„ <code>OpenAsync</code> æ–¹æ³•ã€‚äº‹å®ä¸Šï¼Œ Windows Runtime æ²¡æœ‰æä¾›ä»¥åŒæ­¥æ–¹å¼æ‰§è¡Œ I/O æ“ä½œçš„ä»»ä½• APIã€‚å¹¸å¥½ï¼Œå¯ä»¥ä½¿ç”¨ C# çš„å¼‚æ­¥å‡½æ•°åŠŸèƒ½ç®€åŒ–è°ƒç”¨è¿™äº› API æ—¶çš„ç¼–ç ã€‚åˆ›å»º <code>FileStream</code> å¯¹è±¡æ—¶ï¼Œå¯é€šè¿‡ <code>FileOptions.Asynchronous</code> æ ‡å¿—æŒ‡å®šä»¥åŒæ­¥è¿˜æ˜¯å¼‚æ­¥æ–¹å¼è¿›è¡Œé€šä¿¡ã€‚è¿™ç­‰ä»·äºè°ƒç”¨ Win32 <code>CreateFile</code> å‡½æ•°å¹¶ä¼ é€’ <code>FILE_FLAG_OVERLAPPED</code> æ ‡å¿—ã€‚å¦‚æœä¸æŒ‡å®šè¿™ä¸ªæ ‡å¿—ï¼ŒWindows ä»¥åŒæ­¥æ–¹å¼æ‰§è¡Œæ‰€æœ‰æ–‡ä»¶æ“ä½œã€‚å½“ç„¶ï¼Œä»ç„¶å¯ä»¥è°ƒç”¨ <code>FileStream</code> çš„ <code>ReadAsync</code> æ–¹æ³•ã€‚å¯¹äºä½ çš„åº”ç”¨ç¨‹åºï¼Œæ“ä½œè¡¨é¢ä¸Šå¼‚æ­¥æ‰§è¡Œï¼Œä½† <code>FileStream</code> ç±»æ˜¯åœ¨å†…éƒ¨ç”¨å¦ä¸€ä¸ªçº¿ç¨‹æ¨¡æ‹Ÿå¼‚æ­¥è¡Œä¸ºã€‚è¿™ä¸ªé¢å¤–çš„çº¿ç¨‹çº¯å±æµªè´¹ï¼Œè€Œä¸”ä¼šå½±å“åˆ°æ€§èƒ½ã€‚å¦ä¸€æ–¹é¢ï¼Œå¯åœ¨åˆ›å»º <code>FileStream</code> å¯¹è±¡æ—¶æŒ‡å®š <code>FileOptions.Asynchronous</code> æ ‡å¿—ã€‚ç„¶åï¼Œå¯ä»¥è°ƒç”¨ <code>FileStream</code> çš„ <code>Read</code> æ–¹æ³•æ‰§è¡Œä¸€ä¸ªåŒæ­¥æ“ä½œã€‚åœ¨å†…éƒ¨ï¼Œ <code>FileStream</code> ç±»ä¼šå¼€å§‹ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œç„¶åç«‹å³ä½¿è°ƒç”¨çº¿ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç›´è‡³æ“ä½œå®Œæˆæ‰ä¼šå”¤é†’ï¼Œä»è€Œæ¨¡æ‹ŸåŒæ­¥è¡Œä¸ºã€‚è¿™åŒæ ·æ•ˆç‡ä½ä¸‹ã€‚ä½†ç›¸è¾ƒäºä¸æŒ‡å®š <code>FileOPtions.Asynchronous</code> æ ‡å¿—æ¥æ„å»ºä¸€ä¸ª <code>FileStream</code> å¹¶è°ƒç”¨ <code>ReadAsync</code> ï¼Œå®ƒçš„æ•ˆç‡è¿˜æ˜¯è¦é«˜ä¸Šé‚£ä¹ˆä¸€ç‚¹ç‚¹çš„ã€‚æ€»ä¹‹ï¼Œä½¿ç”¨ <code>FileStream</code> æ—¶å¿…é¡»å…ˆæƒ³å¥½æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥æ‰§è¡Œæ–‡ä»¶ I/Oï¼Œå¹¶æŒ‡å®š (æˆ–ä¸æŒ‡å®š) <code>FileOptions.Asynchronous</code> æ ‡å¿—æ¥æŒ‡æ˜è‡ªå·±çš„é€‰æ‹©ã€‚å¦‚æœæŒ‡å®šäº†è¯¥æ ‡å¿—ï¼Œå°±æ€»æ˜¯è°ƒç”¨ <code>ReadAsync</code> ã€‚ å¦‚æœæ²¡æœ‰æŒ‡å®šè¿™ä¸ªæ ‡å¿—ï¼Œå°±æ€»æ˜¯è°ƒç”¨ <code>Read</code> ã€‚è¿™æ ·å¯ä»¥è·å¾—æœ€ä½³çš„æ€§èƒ½ã€‚å¦‚æœæƒ³å…ˆå¯¹ <code>FileStream</code> æ‰§è¡Œä¸€äº›åŒæ­¥æ“ä½œï¼Œå†æ‰§è¡Œä¸€äº›å¼‚æ­¥æ“ä½œï¼Œé‚£ä¹ˆæ›´é«˜æ•ˆçš„åšæ³•æ˜¯ä½¿ç”¨ <code>FileOptions.Asynchronous</code> æ ‡å¿—æ¥æ„é€ å®ƒã€‚å¦å¤–ï¼Œä¹Ÿå¯é’ˆå¯¹åŒä¸€ä¸ªæ–‡ä»¶åˆ›å»ºä¸¤ä¸ª <code>FileStream</code> å¯¹è±¡ï¼›æ‰“å¼€ä¸€ä¸ª <code>FileStream</code> è¿›è¡Œå¼‚æ­¥ I/Oï¼Œæ‰“å¼€å¦ä¸€ä¸ª <code>FileStream</code> è¿›è¡ŒåŒæ­¥ I/Oã€‚æ³¨æ„ï¼Œ <code>System.IO.File</code> ç±»æä¾›äº†è¾…åŠ©æ–¹æ³• ( <code>Create</code> ï¼Œ <code>Open</code> å’Œ <code>OpenWrite</code> ) æ¥åˆ›å»ºå¹¶è¿”å› <code>FileStream</code> å¯¹è±¡ã€‚ä½†æ‰€æœ‰è¿™äº›æ–¹æ³•éƒ½æ²¡æœ‰åœ¨å†…éƒ¨æŒ‡å®š <code>FileOptions.Asynchronous</code> æ ‡å¿—ï¼Œæ‰€ä»¥ä¸ºäº†å®ç°å“åº”çµæ•çš„ã€å¯ä¼¸ç¼©çš„åº”ç”¨ç¨‹åºï¼Œåº”é¿å…ä½¿ç”¨è¿™äº›æ–¹æ³•ã€‚è¿˜è¦æ³¨æ„ï¼ŒNTFS æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡é©±åŠ¨ç¨‹åºæ€»æ˜¯ä»¥åŒæ­¥æ–¹å¼æ‰§è¡Œä¸€äº›æ“ä½œï¼Œä¸ç®¡å…·ä½“å¦‚ä½•æ‰“å¼€æ–‡ä»¶ã€‚</p><h2 id="io-request-priorities"><a class="anchor" href="#io-request-priorities">#</a> I/O Request Priorities</h2><blockquote><p>In Chapter 26, â€œThread Basics,â€ I showed how setting thread priorities affects how threads are scheduled. However, threads also perform I/O requests to read and write data from various hardware devices. If a low-priority thread gets CPU time, it could easily queue hundreds or thousands of I/O requests in a very short time. Because I/O requests typically require time to process, it is possible that a low-priority thread could significantly affect the responsiveness of the system by suspending high-priority threads, which prevents them from getting their work done. Because of this, you can see a machine become less responsive when executing long-running low-priority services such as disk defragmenters, virus scanners, content indexers, and so on.</p></blockquote><blockquote><p>Windows allows a thread to specify a priority when making I/O requests. For more details about I/O priorities, refer to the white paper at <span class="exturl" data-url="aHR0cDovL3d3dy5taWNyb3NvZnQuY29tL3doZGMvZHJpdmVyL3ByaW9yaXR5aW8ubXNweA==">http://www.microsoft.com/whdc/driver/priorityio.mspx</span>. Unfortunately, the FCL does not include this functionality yet; hopefully, it will be added in a future version. However, you can still take advantage of this feature by P/Invoking out to native Win32 functions. Here is the P/Invoke code.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadIO</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">BackgroundProcessingDisposer</span> <span class="token function">BeginBackgroundProcessing</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name">Boolean</span> process <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token function">ChangeBackgroundProcessing</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BackgroundProcessingDisposer</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EndBackgroundProcessing</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> process <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token function">ChangeBackgroundProcessing</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ChangeBackgroundProcessing</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> process<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> start<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">Boolean</span> ok <span class="token operator">=</span> <span class="token return-type class-name">process</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token punctuation">?</span> <span class="token function">SetPriorityClass</span><span class="token punctuation">(</span><span class="token function">GetCurrentWin32ProcessHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> start <span class="token punctuation">?</span> ProcessBackgroundMode<span class="token punctuation">.</span>Start <span class="token punctuation">:</span> ProcessBackgroundMode<span class="token punctuation">.</span>End<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token punctuation">:</span> <span class="token function">SetThreadPriority</span><span class="token punctuation">(</span><span class="token function">GetCurrentWin32ThreadHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> start <span class="token punctuation">?</span> ThreadBackgroundgMode<span class="token punctuation">.</span>Start <span class="token punctuation">:</span> ThreadBackgroundgMode<span class="token punctuation">.</span>End<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ok<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Win32Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token comment">// This struct lets C#'s using statement end the background processing mode</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">BackgroundProcessingDisposer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Boolean</span> m_process<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token keyword">public</span> <span class="token function">BackgroundProcessingDisposer</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> process<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> m_process <span class="token operator">=</span> process<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">EndBackgroundProcessing</span><span class="token punctuation">(</span>m_process<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadIO</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">BackgroundProcessingDisposer</span> <span class="token function">BeginBackgroundProcessing</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token class-name">Boolean</span> process <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token function">ChangeBackgroundProcessing</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BackgroundProcessingDisposer</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EndBackgroundProcessing</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> process <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token function">ChangeBackgroundProcessing</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ChangeBackgroundProcessing</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> process<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> start<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token class-name">Boolean</span> ok <span class="token operator">=</span> <span class="token return-type class-name">process</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token punctuation">?</span> <span class="token function">SetPriorityClass</span><span class="token punctuation">(</span><span class="token function">GetCurrentWin32ProcessHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="36"></td><td><pre> start <span class="token punctuation">?</span> ProcessBackgroundMode<span class="token punctuation">.</span>Start <span class="token punctuation">:</span> ProcessBackgroundMode<span class="token punctuation">.</span>End<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token punctuation">:</span> <span class="token function">SetThreadPriority</span><span class="token punctuation">(</span><span class="token function">GetCurrentWin32ThreadHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="38"></td><td><pre> start <span class="token punctuation">?</span> ThreadBackgroundgMode<span class="token punctuation">.</span>Start <span class="token punctuation">:</span> ThreadBackgroundgMode<span class="token punctuation">.</span>End<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ok<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Win32Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> <span class="token comment">// This struct lets C#'s using statement end the background processing mode</span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">BackgroundProcessingDisposer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Boolean</span> m_process<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token keyword">public</span> <span class="token function">BackgroundProcessingDisposer</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> process<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> m_process <span class="token operator">=</span> process<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">EndBackgroundProcessing</span><span class="token punctuation">(</span>m_process<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>And here is code showing how to use it.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> Main <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">using</span> <span class="token punctuation">(</span>ThreadIO<span class="token punctuation">.</span><span class="token function">BeginBackgroundProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Issue low-priority I/O requests in here (eg: calls to ReadAsync/WriteAsync)</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>You tell Windows that you want your thread to issue low-priority I/O requests by calling ThreadIOâ€™s BeginBackgroundProcessing method. Note that this also lowers the CPU scheduling priority of the thread. You can return the thread to making normal-priority I/O requests (and normal CPU scheduling priority) by calling EndBackgroundProcessing or by calling Dispose on the value returned by BeginBackgroundProcessing (as shown in the preceding code via C#â€™s using statement). A thread can only affect its own background processing mode; Windows doesnâ€™t allow a thread to change the background processing mode of another thread.</p></blockquote><blockquote><p>If you want all threads in a process to make low-priority I/O requests and have low CPU scheduling, you can call BeginBackgroundProcessing, passing in true for the process parameter. A process can only affect its own background processing mode; Windows doesnâ€™t allow a thread to change the background processing mode of another process.</p></blockquote><p>ğŸ’¡é‡è¦æç¤ºï¼šä½œä¸ºå¼€å‘äººå‘˜ï¼Œæ˜¯ä½ çš„è´£ä»»ä½¿ç”¨è¿™äº›æ–°çš„åå°ä¼˜å…ˆçº§å¢å¼ºå‰å°åº”ç”¨ç¨‹åºçš„å“åº”èƒ½åŠ›ï¼Œä»è€Œé¿å…ä¼˜å…ˆçº§å‘ç”Ÿåè½¬ã€‚åœ¨å­˜åœ¨å¤§é‡æ™®é€šä¼˜å…ˆçº§ I/O æ“ä½œçš„æƒ…å†µä¸‹ï¼Œä»¥åå°ä¼˜å…ˆçº§è¿è¡Œè¿è¡Œçš„çº¿ç¨‹å¯èƒ½å»¶è¿Ÿæ•°ç§’æ‰èƒ½è¿‡å¾—åˆ°å®ƒçš„ I/O è¯·æ±‚ç»“æœã€‚å¦‚æœä¸€ä¸ªä½ä¼˜å…ˆçº§çº¿ç¨‹è·å–äº†ä¸€ä¸ªçº¿ç¨‹åŒæ­¥é”ï¼Œé€ æˆæ™®é€šä¼˜å…ˆçº§çº¿ç¨‹ç­‰å¾…ï¼Œæ™®é€šä¼˜å…ˆçº§çº¿ç¨‹å¯èƒ½ä¸€ç›´ç­‰å¾…åå°ä¼˜å…ˆçº§çº¿ç¨‹ï¼Œç›´è‡³ä½ä¼˜å…ˆçº§ I/O è¯·æ±‚å®Œæˆä¸ºæ­¢ã€‚ä½ çš„åå°ä¼˜å…ˆçº§çº¿ç¨‹ç”šè‡³ä¸éœ€è¦æäº¤è‡ªå·±çš„ I/O è¯·æ±‚ï¼Œå°±å¯èƒ½é€ æˆä¸Šè¿°é—®é¢˜ã€‚æ‰€ä»¥ï¼Œåº”å°½é‡é¿å… (ç”šè‡³å®Œå…¨æœç») åœ¨æ™®é€šä¼˜å…ˆçº§å’Œåå°ä¼˜å…ˆçº§çº¿ç¨‹ä¹‹é—´ä½¿ç”¨å…±äº«çš„åŒæ­¥å¯¹è±¡ï¼Œé¿å…æ™®é€šä¼˜å…ˆçº§çš„çº¿ç¨‹å› ä¸ºåå°ä¼˜å…ˆçº§çº¿ç¨‹æ‹¥æœ‰çš„é”è€Œé˜»å¡ï¼Œä»è€Œå‘ç”Ÿä¼˜å…ˆçº§åè½¬ã€‚</p><p>ğŸ’¡å°ç»“ï¼šç¬¬ 26 ç«  â€œçº¿ç¨‹åŸºç¡€â€ ä»‹ç»äº†çº¿ç¨‹ä¼˜å…ˆçº§å¯¹çº¿ç¨‹è°ƒåº¦æ–¹å¼çš„å½±å“ã€‚ç„¶è€Œï¼Œçº¿ç¨‹è¿˜è¦æ‰§è¡Œ I/O è¯·æ±‚ä»¥ä¾¿ä»å„ç§ç¡¬ä»¶è®¾å¤‡ä¸­è¯»å†™æ•°æ®ã€‚å¦‚æœä¸€ä¸ªä½ä¼˜å…ˆçº§çº¿ç¨‹è·å¾—äº† CPU æ—¶é—´ï¼Œå®ƒå¯ä»¥åœ¨éå¸¸çŸ­çš„æ—¶é—´é‡Œè½»æ˜“åœ°å°†æˆç™¾ä¸Šåƒçš„ I/O è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ã€‚ç”±äº I/O è¯·æ±‚ä¸€èˆ¬éœ€è¦æ—¶é—´æ¥æ‰§è¡Œï¼Œæ‰€ä»¥ä¸€ä¸ªä½ä¼˜å…ˆçº§çº¿ç¨‹å¯èƒ½æŒ‚èµ·é«˜ä¼˜å…ˆçº§çº¿ç¨‹ï¼Œä½¿åè€…ä¸èƒ½å¿«é€Ÿå®Œæˆå·¥ä½œï¼Œä»è€Œä¸¥é‡å½±å“ç³»ç»Ÿçš„æ€»ä½“å“åº”èƒ½åŠ›ã€‚æ­£æ˜¯ç”±äºè¿™ä¸ªåŸå› ï¼Œå½“ç³»ç»Ÿæ‰§è¡Œä¸€äº›è€—æ—¶çš„ä½ä¼˜å…ˆçº§æœåŠ¡æ—¶ (æ¯”å¦‚ç£ç›˜ç¢ç‰‡æ•´ç†ç¨‹åºã€ç—…æ¯’æ‰«æç¨‹åºã€å†…å®¹ç´¢å¼•ç¨‹åºç­‰)ï¼Œæœºå™¨çš„å“åº”èƒ½åŠ›å¯èƒ½ä¼šå˜å¾—éå¸¸å·®ã€‚Windows å…è®¸çº¿ç¨‹åœ¨å‘å‡º I/O è¯·æ±‚æ—¶æŒ‡å®šä¼˜å…ˆçº§ã€‚é—æ†¾çš„æ˜¯ï¼ŒFCL è¿˜æ²¡æœ‰åŒ…å«è¿™ä¸ªåŠŸèƒ½ï¼›ä½†æœªæ¥çš„ç‰ˆæœ¬æœ‰æœ›æ·»åŠ ã€‚å¦‚æœç°åœ¨å°±æƒ³ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥é‡‡å– P/Invoke æœ¬æœº Win32 å‡½æ•°çš„æ–¹å¼ã€‚çº¿ç¨‹åªèƒ½å½±å“å®ƒè‡ªå·±çš„åå°å¤„ç†æ¨¡å¼ï¼›Windows ä¸å…è®¸çº¿ç¨‹æ›´æ”¹å¦ä¸€ä¸ªçº¿ç¨‹çš„åå°å¤„ç†æ¨¡å¼ã€‚å¦‚æœå¸Œæœ›ä¸€ä¸ªè¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½å‘å‡ºä½ä¼˜å…ˆçº§ I/O è¯·æ±‚å’Œè¿›è¡Œä½ä¼˜å…ˆçº§çš„ CPU è°ƒåº¦ï¼Œå¯è°ƒç”¨ <code>BeginBackgroundProcessing</code> ï¼Œä¸ºå®ƒçš„ <code>process</code> å‚æ•°ä¼ é€’ <code>true</code> å€¼ã€‚ä¸€ä¸ªè¿›ç¨‹åªèƒ½å½±å“å®ƒè‡ªå·±çš„åå°å¤„ç†æ¨¡å¼ï¼›Windows ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ›´æ”¹å¦ä¸€ä¸ªè¿›ç¨‹çš„åå°å¤„ç†æ¨¡å¼ã€‚</p><div class="tags"><a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag"><i class="ic i-tag"></i> è¯»ä¹¦ç¬”è®°</a> <a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C#</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2023-02-10 21:45:49" itemprop="dateModified" datetime="2023-02-10T21:45:49+08:00">2023-02-10</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(ï¿£â–½ï¿£)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Sakupinera WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/images/alipay.png" alt="Sakupinera Alipay"><p>Alipay</p></div><div><img data-src="/images/paypal.png" alt="Sakupinera PayPal"><p>PayPal</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Sakupinera <i class="ic i-at"><em>@</em></i>Sakupinera</li><li class="link"><strong>Post link: </strong><a href="http://sakupinera.github.io/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/" title="CLR via C# - Chapter 28 IO-Bound Asynchronous Operations">http://sakupinera.github.io/2023/02/08/csharp/clr-via-csharp/Chapter 28 IO-Bound Asynchronous Operations/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2023/02/07/csharp/clr-via-csharp/Chapter%2027%20Compute-Bound%20Asynchronous%20Operations/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;03&#x2F;08&#x2F;5rFIQnpK6fEoLOU.png" title="CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations</h3></a></div><div class="item right"><a href="/2023/02/09/csharp/clr-via-csharp/Chapter%2029%20Primitive%20Thread%20Synchronization%20Constructs/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;03&#x2F;08&#x2F;jV3gF2wSUYTdtsp.jpg" title="CLR via C# - Chapter 29 Primitive Thread Synchronization"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 29 Primitive Thread Synchronization</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#chapter-28-io-bound-asynchronous-operations"><span class="toc-number">1.</span> <span class="toc-text">Chapter 28 IO-Bound Asynchronous Operations</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#how-windows-performs-io-operations"><span class="toc-number">1.1.</span> <span class="toc-text">How Windows Performs I&#x2F;O Operations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cs-asynchronous-functions"><span class="toc-number">1.2.</span> <span class="toc-text">C#â€™s Asynchronous Functions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#how-the-compiler-transforms-an-async-function-into-a-state-machine"><span class="toc-number">1.3.</span> <span class="toc-text">How the Compiler Transforms an Async Function into a State Machine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#async-function-extensibility"><span class="toc-number">1.4.</span> <span class="toc-text">Async Function Extensibility</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#async-functions-and-event-handlers"><span class="toc-number">1.5.</span> <span class="toc-text">Async Functions and Event Handlers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#async-functions-in-the-framework-class-library"><span class="toc-number">1.6.</span> <span class="toc-text">Async Functions in the Framework Class Library</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#async-functions-and-exception-handling"><span class="toc-number">1.7.</span> <span class="toc-text">Async Functions and Exception Handling</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#other-async-function-features"><span class="toc-number">1.8.</span> <span class="toc-text">Other Async Function Features</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#applications-and-their-threading-models"><span class="toc-number">1.9.</span> <span class="toc-text">Applications and Their Threading Models</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#implementing-a-server-asynchronously"><span class="toc-number">1.10.</span> <span class="toc-text">Implementing a Server Asynchronously</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#canceling-io-operations"><span class="toc-number">1.11.</span> <span class="toc-text">Canceling I&#x2F;O Operations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#some-io-operations-must-be-done-synchronously"><span class="toc-number">1.12.</span> <span class="toc-text">Some I&#x2F;O Operations Must Be Done Synchronously</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#filestream-specific-issues"><span class="toc-number">1.12.1.</span> <span class="toc-text">FileStream-Specific Issues</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#io-request-priorities"><span class="toc-number">1.13.</span> <span class="toc-text">I&#x2F;O Request Priorities</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%201%20The%20CLR%E2%80%99s%20Execution%20Model/" rel="bookmark" title="CLR via C# - Chapter 1 The CLRâ€™s Execution Model">CLR via C# - Chapter 1 The CLRâ€™s Execution Model</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%202%20Building,%20Packaging,%20Deploying,%20and%20Administering%20Applications%20and%20Types/" rel="bookmark" title="CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types">CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%203%20Shared%20Assemblies%20and%20Strongly%20Named%20Assemblies/" rel="bookmark" title="CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies">CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies</a></li><li><a href="/2022/09/27/csharp/clr-via-csharp/Chapter%204%20Type%20Fundamentals/" rel="bookmark" title="CLR via C# - Chapter 4 Type Fundamentals">CLR via C# - Chapter 4 Type Fundamentals</a></li><li><a href="/2022/10/15/csharp/clr-via-csharp/Chapter%205%20Primitive,%20Reference,%20and%20Value%20%20Types/" rel="bookmark" title="CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals">CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals</a></li><li><a href="/2022/10/21/csharp/clr-via-csharp/Chapter%206%20Type%20and%20Member%20Basics/" rel="bookmark" title="CLR via C# - Chapter 6 Type and Member Basics">CLR via C# - Chapter 6 Type and Member Basics</a></li><li><a href="/2022/10/24/csharp/clr-via-csharp/Chapter%207%20Constants%20and%20Fields/" rel="bookmark" title="CLR via C# - Chapter 7 Constants and Fields">CLR via C# - Chapter 7 Constants and Fields</a></li><li><a href="/2022/10/25/csharp/clr-via-csharp/Chapter%208%20Methods/" rel="bookmark" title="CLR via C# - Chapter 8 Methods">CLR via C# - Chapter 8 Methods</a></li><li><a href="/2022/10/27/csharp/clr-via-csharp/Chapter%209%20Parameters/" rel="bookmark" title="CLR via C# - Chapter 9 Parameters">CLR via C# - Chapter 9 Parameters</a></li><li><a href="/2022/10/28/csharp/clr-via-csharp/Chapter%2010%20Properties/" rel="bookmark" title="CLR via C# - Chapter 10 Properties">CLR via C# - Chapter 10 Properties</a></li><li><a href="/2022/10/29/csharp/clr-via-csharp/Chapter%2011%20Events/" rel="bookmark" title="CLR via C# - Chapter 11 Events">CLR via C# - Chapter 11 Events</a></li><li><a href="/2022/11/02/csharp/clr-via-csharp/Chapter%2012%20Generics/" rel="bookmark" title="CLR via C# - Chapter 12 Generics">CLR via C# - Chapter 12 Generics</a></li><li><a href="/2022/11/04/csharp/clr-via-csharp/Chapter%2013%20Interfaces/" rel="bookmark" title="CLR via C# - Chapter 13 Interfaces">CLR via C# - Chapter 13 Interfaces</a></li><li><a href="/2022/11/16/csharp/clr-via-csharp/Chapter%2014%20Chars,%20Strings,%20and%20Working%20%20with%20Text/" rel="bookmark" title="CLR via C# - Chapter 14 Chars, Strings, and Working with Text">CLR via C# - Chapter 14 Chars, Strings, and Working with Text</a></li><li><a href="/2022/11/17/csharp/clr-via-csharp/Chapter%2015%20Enumerated%20Types%20and%20Bit%20Flags/" rel="bookmark" title="CLR via C# - Chapter 15 Enumerated Types and Bit Flags">CLR via C# - Chapter 15 Enumerated Types and Bit Flags</a></li><li><a href="/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/" rel="bookmark" title="CLR via C# - Chapter 16 Arrays">CLR via C# - Chapter 16 Arrays</a></li><li><a href="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/" rel="bookmark" title="CLR via C# - Chapter 17 Delegates">CLR via C# - Chapter 17 Delegates</a></li><li><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" rel="bookmark" title="CLR via C# - Chapter 18 Custom Attributes">CLR via C# - Chapter 18 Custom Attributes</a></li><li><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" rel="bookmark" title="CLR via C# - Chapter 19 Nullable Value Types">CLR via C# - Chapter 19 Nullable Value Types</a></li><li><a href="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/" rel="bookmark" title="CLR via C# - Chapter 20 Exceptions and State Management">CLR via C# - Chapter 20 Exceptions and State Management</a></li><li><a href="/2022/11/27/csharp/clr-via-csharp/Chapter%2021%20The%20Managed%20Heap%20and%20Garbage%20%20Collection/" rel="bookmark" title="CLR via C# - Chapter 21 The Managed Heap and Garbage  Collection">CLR via C# - Chapter 21 The Managed Heap and Garbage Collection</a></li><li><a href="/2022/11/28/csharp/clr-via-csharp/Chapter%2022%20CLR%20Hosting%20and%20AppDomains/" rel="bookmark" title="CLR via C# - Chapter 22 CLR Hosting and AppDomains">CLR via C# - Chapter 22 CLR Hosting and AppDomains</a></li><li><a href="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/" rel="bookmark" title="CLR via C# - Chapter 23 Assembly Loading and Reflection">CLR via C# - Chapter 23 Assembly Loading and Reflection</a></li><li><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" rel="bookmark" title="CLR via C# - Chapter 24 Runtime Serialization">CLR via C# - Chapter 24 Runtime Serialization</a></li><li><a href="/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/" rel="bookmark" title="CLR via C# - Chapter 25 Interoperating with WinRT Components">CLR via C# - Chapter 25 Interoperating with WinRT Components</a></li><li><a href="/2023/02/06/csharp/clr-via-csharp/Chapter%2026%20Thread%20Basics/" rel="bookmark" title="CLR via C# - Chapter 26 Thread Basics">CLR via C# - Chapter 26 Thread Basics</a></li><li><a href="/2023/02/07/csharp/clr-via-csharp/Chapter%2027%20Compute-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations">CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations</a></li><li class="active"><a href="/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 28 IO-Bound Asynchronous Operations">CLR via C# - Chapter 28 IO-Bound Asynchronous Operations</a></li><li><a href="/2023/02/09/csharp/clr-via-csharp/Chapter%2029%20Primitive%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 29 Primitive Thread Synchronization">CLR via C# - Chapter 29 Primitive Thread Synchronization</a></li><li><a href="/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 30 Hybrid Thread Synchronization">CLR via C# - Chapter 30 Hybrid Thread Synchronization</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Sakupinera" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Sakupinera</p><div class="description" itemprop="description">ä¿æŒä½ çš„å†³å¿ƒï¼</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">86</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">13</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">6</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Nha3VwaW5lcmE=" title="https:&#x2F;&#x2F;github.com&#x2F;sakupinera"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9zYWt1cGluZXJh" title="https:&#x2F;&#x2F;twitter.com&#x2F;sakupinera"><i class="ic i-twitter"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTQwNzIyOTA3MQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;407229071"><i class="ic i-cloud-music"></i></span> <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMjIzMDczOTg/c3BtX2lkX2Zyb209MzMzLjEwMDcuMC4w" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;22307398?spm_id_from&#x3D;333.1007.0.0"><i class="ic i-bilibili"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/games/" rel="section"><i class="ic i-flag"></i>Games</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-person"></i>About</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2023/02/07/csharp/clr-via-csharp/Chapter%2027%20Compute-Bound%20Asynchronous%20Operations/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2023/02/09/csharp/clr-via-csharp/Chapter%2029%20Primitive%20Thread%20Synchronization%20Constructs/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" title="CLR via C# - Chapter 24 Runtime Serialization">CLR via C# - Chapter 24 Runtime Serialization</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2022/12/14/cpp/cpp-primer/Chapter%206%20Functions/" title="C++ Primer - Chapter 6 Functions">C++ Primer - Chapter 6 Functions</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/GAMES101/" title="In GAMES101">GAMES101</a></div><span><a href="/2022/09/18/computer-graphics/games101/%E5%8F%98%E6%8D%A2/" title="GAMES101 - Transformationï¼ˆå˜æ¢ï¼‰">GAMES101 - Transformationï¼ˆå˜æ¢ï¼‰</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/08/28/linux/learn-linux/%E7%94%A8%E6%88%B7%E5%92%8C%E7%94%A8%E6%88%B7%E7%BB%84%E7%AE%A1%E7%90%86/" title="LearnLinux - ç”¨æˆ·å’Œç”¨æˆ·ç»„ç®¡ç†">LearnLinux - ç”¨æˆ·å’Œç”¨æˆ·ç»„ç®¡ç†</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/09/05/linux/learn-linux/Linux%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/" title="LearnLinux - LinuxæœåŠ¡ç®¡ç†">LearnLinux - LinuxæœåŠ¡ç®¡ç†</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2022/12/17/cpp/cpp-primer/Chapter%209%20Sequential%20Containers/" title="C++ Primer - Chapter 9 Sequential Containers">C++ Primer - Chapter 9 Sequential Containers</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2022/12/09/cpp/cpp-primer/Chapter%201%20Getting%20Started/" title="C++ Primer - Chapter 1 Getting Started">C++ Primer - Chapter 1 Getting Started</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2023/01/05/cpp/cpp-primer/Chapter%2013%20Copy%20Control/" title="C++ Primer - Chapter 13 Copy Control">C++ Primer - Chapter 13 Copy Control</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/" title="CLR via C# - Chapter 17 Delegates">CLR via C# - Chapter 17 Delegates</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/" title="CLR via C# - Chapter 30 Hybrid Thread Synchronization">CLR via C# - Chapter 30 Hybrid Thread Synchronization</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 â€“ <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Sakupinera @ Hanamai Sora</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">2.2m words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">33:30</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2023/02/08/csharp/clr-via-csharp/Chapter 28 IO-Bound Asynchronous Operations/",favicon:{show:"ï¼ˆâ—Â´3ï½€â—ï¼‰Goooood",hide:"(Â´Ğ”ï½€)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/assets/shifuku.model.json"},display:{position:"left",width:250,height:500},mobile:{show:!1},react:{opacity:.9},log:!1})</script></body></html>