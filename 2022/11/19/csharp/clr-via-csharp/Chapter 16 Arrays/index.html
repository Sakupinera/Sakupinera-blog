<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Sakupinera" href="http://sakupinera.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Sakupinera" href="http://sakupinera.github.io/atom.xml"><link rel="alternate" type="application/json" title="Sakupinera" href="http://sakupinera.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="读书笔记,C#"><link rel="canonical" href="http://sakupinera.github.io/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/"><title>CLR via C# - Chapter 16 Arrays - CLR-via-CSharp - CSharp | Hanamai Sora = Sakupinera</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">CLR via C# - Chapter 16 Arrays</h1><div class="meta"><span class="item" title="Created: 2022-11-19 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2022-11-19T00:00:00+08:00">2022-11-19</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>38k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>34 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Hanamai Sora</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://s2.loli.net/2023/03/08/Z2QTWRnpq3aDLdM.png"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/OQq9sc7VlKfnvGL.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/lrzLEXqhHuVUcP2.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/utEsOX73wkq1ycI.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/Rft6Y9pgTV5E17J.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/Z2usRnE64TXN1Lp.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/" itemprop="item" rel="index" title="In CSharp"><span itemprop="name">CSharp</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/CLR-via-CSharp/" itemprop="item" rel="index" title="In CLR-via-CSharp"><span itemprop="name">CLR-via-CSharp</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="http://sakupinera.github.io/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Sakupinera"><meta itemprop="description" content=", 保持你的决心！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sakupinera"></span><div class="body md" itemprop="articleBody"><h1 id="chapter-16-arrays"><a class="anchor" href="#chapter-16-arrays">#</a> Chapter 16 Arrays</h1><blockquote><p>Arrays are mechanisms that allow you to treat several items as a single collection. The Microsoft .NET common language runtime (CLR) supports single-dimensional arrays, multi-dimensional arrays, and jagged arrays (that is, arrays of arrays). All array types are implicitly derived from the <code>System.Array</code> abstract class, which itself is derived from <code>System.Object</code> . This means that arrays are always reference types that are allocated on the managed heap and that your application’s variable or field contains a reference to the array and not the elements of the array itself. The following code makes this clearer.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> myIntegers<span class="token punctuation">;</span> <span class="token comment">// Declares a reference to an array </span></pre></td></tr><tr><td data-num="2"></td><td><pre>myIntegers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Creates an array of 100 Int32s</span></pre></td></tr></table></figure><blockquote><p>On the first line, myIntegers is a variable that’s capable of pointing to a single-dimensional array of Int32s. Initially, myIntegers will be set to null because I haven’t allocated an array. The second line of code allocates an array of 100 Int32 values; all of the Int32s are initialized to 0. Because arrays are reference types, the memory block required to hold the 100 unboxed Int32s is allocated on the managed heap. Actually, in addition to the array’s elements, the memory block occupied by an array object also contains a type object pointer, a sync block index, and some additional overhead members as well. The address of this array’s memory block is returned and saved in the variable myIntegers.</p></blockquote><blockquote><p>You can also create arrays of reference types.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Control<span class="token punctuation">[</span><span class="token punctuation">]</span></span> myControls<span class="token punctuation">;</span> <span class="token comment">// Declares a reference to an array </span></pre></td></tr><tr><td data-num="2"></td><td><pre>myControls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Control</span><span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Creates an array of 50 Control references</span></pre></td></tr></table></figure><blockquote><p>On the first line, myControls is a variable capable of pointing to a single-dimensional array of Control references. Initially, myControls will be set to null because I haven’t allocated an array. The second line allocates an array of 50 Control references; all of these references are initialized to null. Because Control is a reference type, creating the array creates only a bunch of references; the actual objects aren’t created at this time. The address of this memory block is returned and saved in the variable myControls.</p></blockquote><blockquote><p>Figure 16-1 shows how arrays of value types and arrays of reference types look in the managed heap.</p></blockquote><p><img data-src="/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/image-20221118120658511.png" alt="image-20221118120658511"></p><blockquote><p>In the figure, the Controls array shows the result after the following lines have executed.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>myControls<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Button</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre>myControls<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TextBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>myControls<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> myControls<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Two elements refer to the same object. </span></pre></td></tr><tr><td data-num="4"></td><td><pre>myControls<span class="token punctuation">[</span><span class="token number">46</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DataGrid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>myControls<span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ComboBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre>myControls<span class="token punctuation">[</span><span class="token number">49</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Button</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Common Language Specification (CLS) compliance requires all arrays to be zero-based. This allows a method written in C# to create an array and pass the array’s reference to code written in another language, such as Microsoft Visual Basic .NET. In addition, because zero-based arrays are, by far, the most common arrays, Microsoft has spent a lot of time optimizing their performance. However, the CLR does support non-zero–based arrays even though their use is discouraged. For those of you who don’t care about a slight performance penalty or cross-language portability, I’ll demonstrate how to create and use non-zero–based arrays later in this chapter.</p></blockquote><blockquote><p>Notice in Figure 16-1 that each array has some additional overhead information associated with it. This information contains the rank of the array (number of dimensions), the lower bounds for each dimension of the array (almost always 0), and the length of each dimension. The overhead also contains the array’s element type. I’ll mention the methods that allow you to query this overhead information later in this chapter.</p></blockquote><blockquote><p>So far, I’ve shown examples demonstrating how to create single-dimensional arrays. When possible, you should stick with single-dimensional, zero-based arrays, sometimes referred to as SZ arrays, or vectors. Vectors give the best performance because you can use specific Intermediate Language (IL) instructions—such as newarr, ldelem, ldelema, ldlen, and stelem—to manipulate them. However, if you prefer to work with multi-dimensional arrays, you can. Here are some examples of multi-dimensional arrays.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Create a two-dimensional array of Doubles. </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Double<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span></span> myDoubles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Double</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// Create a three-dimensional array of String references. </span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">String<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">,</span><span class="token punctuation">]</span></span> myStrings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">String</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>The CLR also supports jagged arrays, which are arrays of arrays. Zero-based, single-dimensional jagged arrays have the same performance as normal vectors. However, accessing the elements of a jagged array means that two or more array accesses must occur. Here are some examples of how to create an array of polygons with each polygon consisting of an array of Point instances.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Create a single-dimensional array of Point arrays. </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Point<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> myPolygons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Point</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// myPolygons[0] refers to an array of 10 Point instances. </span></pre></td></tr><tr><td data-num="4"></td><td><pre>myPolygons<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Point</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// myPolygons[1] refers to an array of 20 Point instances. </span></pre></td></tr><tr><td data-num="6"></td><td><pre>myPolygons<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Point</span><span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// myPolygons[2] refers to an array of 30 Point instances. </span></pre></td></tr><tr><td data-num="8"></td><td><pre>myPolygons<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Point</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// Display the Points in the first polygon. </span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> myPolygons<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Length<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>myPolygons<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">x</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>💡注意：CLR 会验证数组索引的有效性。换句话说，不能创建含有 100 个元素的数组 (索引编号 0 到 99)，然后试图访问索引为 -5 或 100 的元素。这样做会导致 <code>System.IndexOutOfRangeException</code> 异常。允许访问数组范围之外的内存会破坏类型安全性，而且会造成潜在的安全漏洞，所以 CLR 不允许可验证的代码这么做。通常，索引范围检查对性能的影响微乎其微，因为 JIT 编译器通常只在循环开始之前检查一次数组边界，而不是每次循环迭代都检查 &lt;sup&gt;①&lt;/sup&gt;。不过，如果仍然担心 CLR 索引检查造成的性能损失，可以在 C# 中使用 unsafe 代码来访问数组。16.7 节 “数组的内部工作原理” 将演示具体做法。</p><p>① 不要混淆 “循环” 和 “循环迭代”。例如以下代码：</p><pre><code class="language-C#">Int32[] myArray = new Int32[100];
for (Int32 i = 0; i &lt; myArray.Length; i++) myArray[i] = i;
</code></pre><p>“ <code>for</code> 循环” 总共要 “循环迭代 100 次”，有时也简单地说 “迭代 100 次”。</p><p>💡小结：所有数组类型都隐式地从 <code>System.Array</code> 抽象类派生，后者又派生自 <code>System.Object</code> 。这意味着数组始终是引用类型，是在托管堆上分配的。实际上，除了数组元素，数组对象占据的内存块还包含一个类型对象指针、一个同步块索引和一些额外的成员。为了符合 “公共语言规范”（Common Language Specification，CLS）的要求，所有数组都必须是 0 基数组（即最小索引为 0）。这样就可以用 C# 的方法创建数组，并将该数组的引用传给其他语言（比如 Microsoft Visual Basic .NET）写的代码。不过 CLR 确实支持非 0 基数组，只是不提倡使用。每个数组都关联了一些额外的开销信息。这些信息包括数组的秩（即 rank，或称数组的维数）、数组每一维的下限（几乎总是 0）和每一维的长度。开销信息还包含数组的元素类型。应尽可能使用一维 0 基数组，有时也将这种数组称为 SZ（single-dimension，zero-based）数组或向量（vector）。向量的性能是最佳的，因为可以使用一些特殊的 IL 指令（比如 newarr，ldelem，ldelema，ldlen 和 stelem）来处理。必要时也可以使用多维数组。CLR 还支持交错数组（jagged array），即数组构成的数组。0 基一维交错数组的性能和普通向量一样好。不过，访问交错数组的元素意味着必须进行两次或更多次数组访问。</p><h2 id="initializing-array-elements"><a class="anchor" href="#initializing-array-elements">#</a> Initializing Array Elements</h2><blockquote><p>In the previous section, I showed how to create an array object and then I showed how to initialize the elements of the array. C# offers syntax that allows you to do these two operations in one statement. The following shows an example.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">String<span class="token punctuation">[</span><span class="token punctuation">]</span></span> names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">String<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token string">"Aidan"</span><span class="token punctuation">,</span> <span class="token string">"Grant"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>The comma-separated set of tokens contained within the braces is called an array initializer. Each token can be an arbitrarily complex expression or, in the case of a multi-dimensional array, a nested array initializer. In the preceding example, I used just two simple String expressions.</p></blockquote><blockquote><p>If you are declaring a local variable in a method to refer to the initialized array, then you can use C#’s implicitly typed local variable (var) feature to simplify the code a little.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Using C#’s implicitly typed local variable feature:</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name"><span class="token keyword">var</span></span> names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">String<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token string">"Aidan"</span><span class="token punctuation">,</span> <span class="token string">"Grant"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Here, the compiler is inferring that the names local variable should be of the String[] type because that is the type of the expression on the right of the assignment operator (=).</p></blockquote><blockquote><p>You can use C#’s implicitly typed array feature to have the compiler infer the type of the array’s elements. Notice the following line has no type specified between new and [].</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Using C#’s implicitly typed local variable and implicitly typed array features:</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name"><span class="token keyword">var</span></span> names <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token string">"Aidan"</span><span class="token punctuation">,</span> <span class="token string">"Grant"</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>In the preceding line, the compiler examines the types of the expressions being used inside the array to initialize the array’s elements, and the compiler chooses the closest base class that all the elements have in common to determine the type of the array. In this example, the compiler sees two Strings and null. Because null is implicitly castable to any reference type (including String), the compiler infers that it should be creating and initializing an array of String references.</p></blockquote><blockquote><p>If you had this code:</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Using C#’s implicitly typed local variable &amp; implicitly typed array features: (error)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name"><span class="token keyword">var</span></span> names <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token string">"Aidan"</span><span class="token punctuation">,</span> <span class="token string">"Grant"</span><span class="token punctuation">,</span> <span class="token number">123</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>the compiler would issue the message error CS0826: No best type found for implicitlytyped array. This is because the base type in common between the two Strings and the Int32 is Object, which would mean that the compiler would have to create an array of Object references and then box the 123 and have the last array element refer to a boxed Int32 with a value of 123. The C# compiler team thinks that boxing array elements is too heavy-handed for the compiler to do for you implicitly, and that is why the compiler issues the error.</p></blockquote><blockquote><p>As an added syntactical bonus when initializing an array, you can write the following.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">String<span class="token punctuation">[</span><span class="token punctuation">]</span></span> names <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">"Aidan"</span><span class="token punctuation">,</span> <span class="token string">"Grant"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Notice that on the right of the assignment operator (=), only the array initializer expression is given with no new, no type, and no []s. This syntax is nice, but unfortunately, the C# compiler does not allow you to use implicitly typed local variables with this syntax.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// This is a local variable now (error)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name"><span class="token keyword">var</span></span> names <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">"Aidan"</span><span class="token punctuation">,</span> <span class="token string">"Grant"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>If you try to compile the preceding line of code, the compiler issues two messages: error CS0820: Cannot initialize an implicitly-typed local variable with an array initializer and error CS0622: Can only use array initializer expressions to assign to array types. Try using a new expression instead. Although the compiler could make this work, the C# team thought that the compiler would be doing too much for you here. It would be inferring the type of the array, new’ing the array, initializing the array, and inferring the type of the local variable, too.</p></blockquote><blockquote><p>The last thing I’d like to show you is how to use implicitly typed arrays with anonymous types and implicitly typed local variables. Anonymous types and how type identity applies to them are discussed in Chapter 10, “Properties.” Examine the following code.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Using C#’s implicitly typed local, implicitly typed array, and anonymous type features:</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name"><span class="token keyword">var</span></span> kids <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token punctuation">&#123;</span> Name<span class="token operator">=</span><span class="token string">"Aidan"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token punctuation">&#123;</span> Name<span class="token operator">=</span><span class="token string">"Grant"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// Sample usage (with another implicitly typed local variable):</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> kid <span class="token keyword">in</span> kids<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>kid<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>In this example, I am using an array initializer that has two expressions for the array elements. Each expression represents an anonymous type (because no type name is specified after the new operator). Because the two anonymous types have the identical structure (one field called Name of type String), the compiler knows that these two objects are of the exact same type. Now, I use C#’s implicitly typed array feature (no type specified between the new and the []s) so that the compiler will infer the type of the array itself, construct this array object, and initialize its references to the two instances of the one anonymous type.1 Finally, a reference to this array object is assigned to the kids local variable, the type of which is inferred by the compiler due to C#’s implicitly typed local variable feature.</p></blockquote><blockquote><p>I show the foreach loop as an example of how to use this array that was just created and initialized with the two anonymous type objects. I have to use an implicitly typed local variable (kid) for the loop, too. When I run this code, I get the following output.</p></blockquote><pre><code class="language-cmd">Aidan
Grant
</code></pre><p>💡小结：C# 允许用一个语句创建数组对象并初始化数组中的元素。大括号中的以逗号分隔的数据项称为数组初始化器（array initializer）。每个数据项都可以是一个任意复杂度的表达式；在多维数组的情况下，则可以是一个嵌套的数组初始化器。此外，还可以利用 C# 的 “隐式类型的局部变量” 或者 C# 的隐式类型的数组功能来简化代码。作为初始化数组时的一个额外的语法奖励，赋值操作符（=）右侧只给出了一个初始化器，没有 new，没有类型，没有 []。这个语法可读性很好，不过 C# 编译器不允许在这种语法中使用隐式类型的局部变量，因为 C# 团队认为编译器在这里会为你做太多的工作。它要推断数组类型，新建数组对象，初始化数组，还要推断局部变量的类型。</p><h2 id="casting-arrays"><a class="anchor" href="#casting-arrays">#</a> Casting Arrays</h2><blockquote><p>For arrays with reference type elements, the CLR allows you to implicitly cast the source array’s element type to a target type. For the cast to succeed, both array types must have the same number of dimensions, and an implicit or explicit conversion from the source element type to the target element type must exist. The CLR doesn’t allow the casting of arrays with value type elements to any other type. (However, by using the <code>Array.Copy</code> method, you can create a new array and populate its elements in order to obtain the desired effect.) The following code demonstrates how array casting works.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Create a two-dimensional FileStream array. </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">FileStream<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span></span> fs2dim <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// Implicit cast to a two-dimensional Object array </span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span></span> o2dim <span class="token operator">=</span> fs2dim<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// Can't cast from two-dimensional array to one-dimensional array </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// Compiler error CS0030: Cannot convert type 'object[*,*]' to </span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// 'System.IO.Stream[]' </span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token class-name">Stream<span class="token punctuation">[</span><span class="token punctuation">]</span></span> s1dim <span class="token operator">=</span> <span class="token punctuation">(</span>Stream<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> o2dim<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// Explicit cast to two-dimensional Stream array </span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token class-name">Stream<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span></span> s2dim <span class="token operator">=</span> <span class="token punctuation">(</span>Stream<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span> o2dim<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// Explicit cast to two-dimensional String array </span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// Compiles but throws InvalidCastException at runtime</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token class-name">String<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span></span> st2dim <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span> o2dim<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// Create a one-dimensional Int32 array (value types). </span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> i1dim <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// Can't cast from array of value types to anything else </span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">// Compiler error CS0030: Cannot convert type 'int[]' to 'object[]' </span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> o1dim <span class="token operator">=</span> <span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> i1dim<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">// Create a new array, then use Array.Copy to coerce each element in the </span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">// source array to the desired type in the destination array. </span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">// The following code creates an array of references to boxed Int32s. </span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> ob1dim <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object</span><span class="token punctuation">[</span>i1dim<span class="token punctuation">.</span>Length<span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="23"></td><td><pre>Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>i1dim<span class="token punctuation">,</span> ob1dim<span class="token punctuation">,</span> i1dim<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>The <code>Array.Copy</code> method is not just a method that copies elements from one array to another. The Copy method handles overlapping regions of memory correctly, as does C’s <code>memmove</code> function. C’s <code>memcpy</code> function, on the other hand, doesn’t handle overlapping regions correctly. The Copy method can also convert each array element as it is copied if conversion is required. The Copy method is capable of performing the following conversions:</p><ul><li><p>Boxing value type elements to reference type elements, such as copying an Int32[] to an Object[].</p></li><li><p>Unboxing reference type elements to value type elements, such as copying an Object[] to an Int32[].</p></li><li><p>Widening CLR primitive value types, such as copying elements from an Int32[] to a Double[].</p></li><li><p>Downcasting elements when copying between array types that can’t be proven to be compatible based on the array’s type, such as when casting from an Object[] to an <code>IFormattable[]</code> . If every object in the Object[] implements <code>IFormattable</code> , Copy will succeed.</p></li></ul></blockquote><blockquote><p>Here’s another example showing the usefulness of Copy.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Define a value type that implements an interface. </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">struct</span> <span class="token class-name">MyValueType</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IComparable</span></span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> <span class="token function">CompareTo</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token range operator">..</span><span class="token punctuation">.</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// Create an array of 100 value types. </span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token class-name">MyValueType<span class="token punctuation">[</span><span class="token punctuation">]</span></span> src <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyValueType</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// Create an array of IComparable references. </span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token class-name">IComparable<span class="token punctuation">[</span><span class="token punctuation">]</span></span> dest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IComparable</span><span class="token punctuation">[</span>src<span class="token punctuation">.</span>Length<span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// Initialize an array of IComparable elements to refer to boxed </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// versions of elements in the source array. </span></pre></td></tr><tr><td data-num="15"></td><td><pre> Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> src<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>As you might imagine, the Framework Class Library (FCL) takes advantage of Array’s Copy method quite frequently.</p></blockquote><blockquote><p>In some situations, it is useful to cast an array from one type to another. This kind of functionality is called array covariance. When you take advantage of array covariance, you should be aware of an associated performance penalty. Let’s say you have the following code.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">String<span class="token punctuation">[</span><span class="token punctuation">]</span></span> sa <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">String</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> oa <span class="token operator">=</span> sa<span class="token punctuation">;</span> <span class="token comment">// oa refers to an array of String elements </span></pre></td></tr><tr><td data-num="3"></td><td><pre>oa<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Jeff"</span><span class="token punctuation">;</span> <span class="token comment">// Perf hit: CLR checks oa's element type for String; OK </span></pre></td></tr><tr><td data-num="4"></td><td><pre>oa<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// Perf hit: CLR checks oa's element type for Int32; throws </span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// ArrayTypeMismatchException</span></pre></td></tr></table></figure><blockquote><p>In the preceding code, the oa variable is typed as an Object[]; however, it really refers to a String[]. The compiler will allow you to write code that attempts to put a 5 into an array element because 5 is an Int32, which is derived from Object. Of course, the CLR must ensure type safety, and when assigning to an array element, the CLR must ensure that the assignment is legal. So the CLR must check at run time whether the array contains Int32 elements. In this case, it doesn’t, and the assignment cannot be allowed; the CLR will throw an ArrayTypeMismatchException.</p></blockquote><p>💡注意：如果只是需要将数组的某些元素复制到另一个数组，可选择 <code>System.Buffer</code> 的 <code>BlockCopy</code> 方法，它比 <code>Array</code> 的 <code>Copy</code> 方法快。但 <code>Buffer</code> 的 <code>BlockCopy</code> 方法只支持基于类型，不提供像 <code>Array</code> 的 <code>Copy</code> 方法那样的转型能力。方法的 <code>Int32</code> 参数代表的是数组中的字节偏移量，而非元素索引。设计 <code>BlockCopy</code> 的目的实际是将按位兼容 (bitwise-compatible)&lt;sup&gt;①&lt;/sup &gt; 的数据从一个数组类型复制到另一个按位兼容的数据类型，比如将包含 Unicode 字符的一个 <code>Byte[]</code> (按字节的正确顺序) 复制到一个 <code>Char[]</code> 中，该方法一定程度上弥补了不能将数组当作任意类型的内存块来处理的不足。</p><p>要将一个数组的元素可靠地复制到另一个数组，应该使用 <code>System.Array</code> 的 <code>ConstrainedCopy</code> 方法。该方法要么完成复制，要么抛出异常，总之不会破坏目标数组中的数据。这就允许 <code>ConstrainedCopy</code> 在约束执行区域 (Constrained Execution Region, CER) 中执行。为了提供这种保证， <code>ConstrainedCopy</code> 要求源数组的元素类型要么与目标数组的元素类型相同，要么派生自目标数组的元素类型。另外，它不执行任何装箱、拆箱或向下类型转型。</p><p>💡小结：对于元素为引用类型的数组，CLR 允许将数组元素从一种类型转型为另一种。成功转型要求数组维数相同，而且必须存在从元素源类型到目标类型的隐式或显式转换。CLR 不允许将值类型元素的数组转型为其他任何类型。不过，可用 <code>Array.Copy</code> 方法创建新数组并在其中填充元素来模拟这种效果。Copy 方法还能正确处理内存的重叠区域，就像 C 的 <code>memmove</code> 函数一样。Copy 方法还能在复制每个数组元素时进行必要的类型转换。有时确实需要将数组从一种类型转换为另一种类型。这种功能称为数组协变性（array covariance）。但在利用它时要清楚由此而来的性能损失。</p><h2 id="all-arrays-are-implicitly-derived-from-systemarray"><a class="anchor" href="#all-arrays-are-implicitly-derived-from-systemarray">#</a> All Arrays Are Implicitly Derived from System.Array</h2><blockquote><p>When you declare an array variable like this:</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">FileStream<span class="token punctuation">[</span><span class="token punctuation">]</span></span> fsArray<span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>then the CLR automatically creates a FileStream[] type for the AppDomain. This type will be implicitly derived from the System.Array type, and therefore, all of the instance methods and properties defined on the System.Array type will be inherited by the FileStream[] type, allowing these methods and properties to be called using the fsArray variable. This makes working with arrays extremely convenient because there are many helpful instance methods and properties defined by System.Array, such as Clone, CopyTo, GetLength, GetLongLength, GetLowerBound, GetUpperBound, Length, Rank, and others.</p></blockquote><blockquote><p>The System.Array type also exposes a large number of extremely useful static methods that operate on arrays. These methods all take a reference to an array as a parameter. Some of the useful static methods are AsReadOnly, BinarySearch, Clear, ConstrainedCopy, ConvertAll, Copy, Exists, Find, FindAll, FindIndex, FindLast, FindLastIndex, ForEach, IndexOf, LastIndexOf, Resize, Reverse, Sort, and TrueForAll. There are many overloads for each of these methods. In fact, many of the methods provide generic overloads for compile-time type safety as well as good performance. I encourage you to examine the SDK documentation to get an understanding of how useful and powerful these methods are.</p></blockquote><p>💡小结：声明 XXX 类型数组变量时，CLR 会自动为 <code>AppDomain</code> 创建一个 <code>XXX[]</code> 类型。该类型隐式派生自 <code>System.Array</code> 类型；因此， <code>System.Array</code> 类型定义的所有实例方法和属性都将由 <code>XXX[]</code> 继承。</p><h2 id="all-arrays-implicitly-implement-ienumerable-icollection-and-ilist"><a class="anchor" href="#all-arrays-implicitly-implement-ienumerable-icollection-and-ilist">#</a> All Arrays Implicitly Implement IEnumerable, ICollection, and IList</h2><blockquote><p>There are many methods that operate on various collection objects because the methods are declared with parameters such as IEnumerable, ICollection, and IList. It is possible to pass arrays to these methods because System.Array also implements these three interfaces. System.Array implements these non-generic interfaces because they treat all elements as System.Object. However, it would be nice to have System.Array implement the generic equivalent of these interfaces, providing better compile-time type safety as well as better performance.</p></blockquote><blockquote><p>The CLR team didn’t want System.Array to implement IEnumerable, ICollection, and IList, though, because of issues related to multi-dimensional arrays and non-zero–based arrays. Defining these interfaces on System.Array would have enabled these interfaces for all array types. Instead, the CLR performs a little trick: when a single-dimensional, zero–lower bound array type is created, the CLR automatically makes the array type implement IEnumerable, ICollection, and IList (where T is the array’s element type) and also implements the three interfaces for all of the array type’s base types as long as they are reference types. The following hierarchy diagram helps make this clear.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token return-type class-name">Object</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> Array <span class="token punctuation">(</span>non<span class="token operator">-</span><span class="token class-name">generic</span> IEnumerable<span class="token punctuation">,</span> ICollection<span class="token punctuation">,</span> IList<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> 	Object<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>IEnumerable<span class="token punctuation">,</span> ICollection<span class="token punctuation">,</span> IList <span class="token class-name">of</span> Object<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> 		String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>IEnumerable<span class="token punctuation">,</span> ICollection<span class="token punctuation">,</span> IList <span class="token class-name">of</span> String<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> 		Stream<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>IEnumerable<span class="token punctuation">,</span> ICollection<span class="token punctuation">,</span> IList <span class="token class-name">of</span> Stream<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> 			FileStream<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>IEnumerable<span class="token punctuation">,</span> ICollection<span class="token punctuation">,</span> IList <span class="token class-name">of</span> FileStream<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> 		<span class="token punctuation">.</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> 		<span class="token punctuation">.</span>		 <span class="token punctuation">(</span>other arrays of <span class="token class-name">reference</span> types<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token punctuation">.</span></pre></td></tr></table></figure><blockquote><p>So, for example, if you have the following line of code:</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">FileStream<span class="token punctuation">[</span><span class="token punctuation">]</span></span> fsArray<span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>then when the CLR creates the FileStream[] type, it will cause this type to automatically implement the IEnumerable, ICollection, and IList interfaces. Furthermore, the FileStream[] type will also implement the interfaces for the base types: IEnumerable, IEnumerable, ICollection, ICollection, IList, and IList. Because all of these interfaces are automatically implemented by the CLR, the fsArray variable could be used wherever any of these interfaces exist. For example, the fsArray variable could be passed to methods that have any of the following prototypes.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">M1</span><span class="token punctuation">(</span><span class="token class-name">IList<span class="token punctuation">&lt;</span>FileStream<span class="token punctuation">></span></span> fsList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> … <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">M2</span><span class="token punctuation">(</span><span class="token class-name">ICollection<span class="token punctuation">&lt;</span>Stream<span class="token punctuation">></span></span> sCollection<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> … <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">M3</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>Object<span class="token punctuation">></span></span> oEnumerable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> … <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Note that if the array contains value type elements, the array type will not implement the interfaces for the element’s base types. For example, if you have the following line of code:</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">DateTime<span class="token punctuation">[</span><span class="token punctuation">]</span></span> dtArray<span class="token punctuation">;</span> <span class="token comment">// An array of value types</span></pre></td></tr></table></figure><blockquote><p>then the DateTime[] type will implement IEnumerable, ICollection, and IList only; it will not implement versions of these interfaces that are generic over System.ValueType or System.Object. This means that the dtArray variable cannot be passed as an argument to the M3 method shown earlier. The reason for this is because arrays of value types are laid out in memory differently than arrays of reference types. Array memory layout was discussed earlier in this chapter.</p></blockquote><p>💡小结： <code>System.Array</code> 实现了 <code>IEnumerable</code> ， <code>ICollection</code> 和 <code>IList</code> 这些非泛型接口，是因为这些接口将所有元素都视为 <code>System.Object</code> 。要想让 <code>System.Array</code> 实现这些接口的泛型形式，提供更好的编译时类型安全性和更好的性能，CLR 耍了一个小花招：创建一维 0 基数组类型时，CLR 自动使数组类型实现 <code>IEnumerable&lt;T&gt;</code> ， <code>ICollection&lt;T&gt;</code> 和 <code>IList&lt;T&gt;</code> （T 是数组元素的类型）。同时，还为数组类型的所有基类型实现这三个接口，只要它们是引用类型。注意，如果数组包含值类型的元素，数组类型不会为元素的基类型实现接口。</p><h2 id="passing-and-returning-arrays"><a class="anchor" href="#passing-and-returning-arrays">#</a> Passing and Returning Arrays</h2><blockquote><p>When passing an array as an argument to a method, you are really passing a reference to that array. Therefore, the called method is able to modify the elements in the array. If you don’t want to allow this, you must make a copy of the array and pass the copy into the method. Note that the Array.Copy method performs a shallow copy, and therefore, if the array’s elements are reference types, the new array refers to the already existing objects.</p></blockquote><blockquote><p>Similarly, some methods return a reference to an array. If the method constructs and initializes the array, returning a reference to the array is fine. But if the method wants to return a reference to an internal array maintained by a field, you must decide if you want the method’s caller to have direct access to this array and its elements. If you do, just return the array’s reference. But most often, you won’t want the method’s caller to have such access, so the method should construct a new array and call Array.Copy, returning a reference to the new array. Again, be aware that Array.Copy makes a shallow copy of the original array.</p></blockquote><blockquote><p>If you define a method that returns a reference to an array, and if that array has no elements in it, your method can return either null or a reference to an array with zero elements in it. When you’re implementing this kind of method, Microsoft strongly recommends that you implement the method by having it return a zero-length array because doing so simplifies the code that a developer calling the method must write. For example, this easy-to-understand code runs correctly even if there are no appointments to iterate over.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// This code is easier to write and understand. </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Appointment<span class="token punctuation">[</span><span class="token punctuation">]</span></span> appointments <span class="token operator">=</span> <span class="token function">GetAppointmentsForToday</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> a <span class="token operator">&lt;</span> appointments<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> a<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token range operator">..</span><span class="token punctuation">.</span> </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The following code also runs correctly if there are no appointments to iterate over. However, this code is slightly more difficult to write and understand.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// This code is harder to write and understand. </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Appointment<span class="token punctuation">[</span><span class="token punctuation">]</span></span> appointments <span class="token operator">=</span> <span class="token function">GetAppointmentsForToday</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>appointments <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> a <span class="token operator">&lt;</span> appointments<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> a<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Do something with appointments[a] </span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If you design your methods to return arrays with zero elements instead of null, callers of your methods will have an easier time working with them. By the way, you should do the same for fields. If your type has a field that’s a reference to an array, you should consider having the field refer to an array even if the array has no elements in it.</p></blockquote><p>💡小结：数组作为实参传给方法时，实际传递的是对该数组的引用。因此，被调用的方法能修改数组中的元素。如果不想被修改，必须生成数组的拷贝并将拷贝传给方法。 <code>Array.Copy</code> 方法执行的是浅拷贝。换言之，如果数组元素是引用类型，新数组将引用现有的对象。如果定义返回数组引用的方法，而且数组中不包含元素，那么方法既可以返回 null，也可以返回对包含零个元素的一个数组的引用。实现这种方法时，Microsoft 强烈建议让它返回后者，因为这样能简化调用该方法时需要写的代码。将方法设计为返回对含有 0 个元素的一个数组的引用，而不是返回 null，该方法的调用者就能更轻松地使用该方法。顺便提一句，对字段也应如此。如果类型中有一个字段是数组引用，应考虑让这个字段始终引用数组，即使数组中不包含任何元素。</p><h2 id="creating-non-zero-lower-bound-arrays"><a class="anchor" href="#creating-non-zero-lower-bound-arrays">#</a> Creating Non-Zero Lower Bound Arrays</h2><blockquote><p>Earlier I mentioned that it’s possible to create and work with arrays that have non-zero lower bounds. You can dynamically create your own arrays by calling Array’s static CreateInstance method. Several overloads of this method exist, allowing you to specify the type of the elements in the array, the number of dimensions in the array, the lower bounds of each dimension, and the number of elements in each dimension. CreateInstance allocates memory for the array, saves the parameter information in the overhead portion of the array’s memory block, and returns a reference to the array. If the array has two or more dimensions, you can cast the reference returned from CreateInstance to an ElementType[] variable (where ElementType is some type name), making it easier for you to access the elements in the array. If the array has just one dimension, in C#, you have to use Array’s GetValue and SetValue methods to access the elements of the array.</p></blockquote><blockquote><p>Here’s some code that demonstrates how to dynamically create a two-dimensional array of System.Decimal values. The first dimension represents calendar years from 2005 to 2009 inclusive, and the second dimension represents quarters from 1 to 4 inclusive. The code iterates over all the elements in the dynamic array. I could have hard-coded the array’s bounds into the code, which would have given better performance, but I decided to use System.Array’s GetLowerBound and GetUpperBound methods to demonstrate their use.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DynamicArrays</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// I want a two-dimensional array [2005..2009][1..4]. </span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> lowerBounds <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">2005</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> lengths <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token class-name">Decimal<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span></span> quarterlyRevenue <span class="token operator">=</span> <span class="token punctuation">(</span>Decimal<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> Array<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Decimal</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lengths<span class="token punctuation">,</span> lowerBounds<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"&#123;0,4&#125; &#123;1,9&#125; &#123;2,9&#125; &#123;3,9&#125; &#123;4,9&#125;"</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token string">"Year"</span><span class="token punctuation">,</span> <span class="token string">"Q1"</span><span class="token punctuation">,</span> <span class="token string">"Q2"</span><span class="token punctuation">,</span> <span class="token string">"Q3"</span><span class="token punctuation">,</span> <span class="token string">"Q4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">Int32</span> firstYear <span class="token operator">=</span> quarterlyRevenue<span class="token punctuation">.</span><span class="token function">GetLowerBound</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token class-name">Int32</span> lastYear <span class="token operator">=</span> quarterlyRevenue<span class="token punctuation">.</span><span class="token function">GetUpperBound</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token class-name">Int32</span> firstQuarter <span class="token operator">=</span> quarterlyRevenue<span class="token punctuation">.</span><span class="token function">GetLowerBound</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token class-name">Int32</span> lastQuarter <span class="token operator">=</span> quarterlyRevenue<span class="token punctuation">.</span><span class="token function">GetUpperBound</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> year <span class="token operator">=</span> firstYear<span class="token punctuation">;</span> year <span class="token operator">&lt;=</span> lastYear<span class="token punctuation">;</span> year<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>year <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> quarter <span class="token operator">=</span> firstQuarter<span class="token punctuation">;</span> quarter <span class="token operator">&lt;=</span> lastQuarter<span class="token punctuation">;</span> quarter<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"&#123;0,9:C&#125; "</span><span class="token punctuation">,</span> quarterlyRevenue<span class="token punctuation">[</span>year<span class="token punctuation">,</span> quarter<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="20"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If you compile and run this code, you get the following output.</p></blockquote><pre><code class="language-cmd">Year Q1 Q2 Q3 Q4 
2005 $0.00 $0.00 $0.00 $0.00 
2006 $0.00 $0.00 $0.00 $0.00 
2007 $0.00 $0.00 $0.00 $0.00 
2008 $0.00 $0.00 $0.00 $0.00 
2009 $0.00 $0.00 $0.00 $0.00
</code></pre><p>💡小结：调用数组的静态 <code>CreateInstance</code> 方法可以动态创建和操作下限非 0 的数组。该方法有若干个重载版本，允许指定数组元素的类型、数组的维数、每一维的下限和每一维的元素数目。 <code>CreateInstance</code> 为数组分配内存，将参数信息保存到数组的内存块的开销（overload）部分，然后返回对该数组的引用。如果数组的维数是 2 或 2 以上，就可以把 <code>CreateInstance</code> 返回的引用转型为一个 <code>ElementType[]</code> 变量（ <code>ElementType</code> 要替换为类型名称），以简化对数组中的元素的访问。如果只有一维，C# 要求必须使用该 <code>Array</code> 的 <code>GetValue</code> 和 <code>SetValue</code> 方法访问数组元素。</p><h2 id="array-internals"><a class="anchor" href="#array-internals">#</a> Array Internals</h2><blockquote><p>Internally, the CLR actually supports two different kinds of arrays:</p><ul><li><p>Single-dimensional arrays with a lower bound of 0. These arrays are sometimes called SZ (for single-dimensional, zero-based) arrays or vectors.</p></li><li><p>Single-dimensional and multi-dimensional arrays with an unknown lower bound.</p></li></ul></blockquote><blockquote><p>You can actually see the different kinds of arrays by executing the following code (the output is shown in the code’s comments).</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name">Array</span> a<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Create a 1-dim, 0-based array, with no elements in it </span></pre></td></tr><tr><td data-num="6"></td><td><pre> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "System.String[]" </span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Create a 1-dim, 0-based array, with no elements in it </span></pre></td></tr><tr><td data-num="9"></td><td><pre> a <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "System.String[]" </span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Create a 1-dim, 1-based array, with no elements in it </span></pre></td></tr><tr><td data-num="13"></td><td><pre> a <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "System.String[*]" &lt;-- INTERESTING! </span></pre></td></tr><tr><td data-num="16"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token comment">// Create a 2-dim, 0-based array, with no elements in it </span></pre></td></tr><tr><td data-num="18"></td><td><pre> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="19"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "System.String[,]" </span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// Create a 2-dim, 0-based array, with no elements in it </span></pre></td></tr><tr><td data-num="21"></td><td><pre> a <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="23"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "System.String[,]" </span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token comment">// Create a 2-dim, 1-based array, with no elements in it </span></pre></td></tr><tr><td data-num="25"></td><td><pre> a <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="27"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "System.String[,]" </span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Next to each Console.WriteLine is a comment that indicates the output. For the singledimensional arrays, the zero-based arrays display a type name of System.String[], whereas the 1-based array displays a type name of System.String[<em>]. The * indicates that the CLR knows that this array is not zero-based. Note that C# does not allow you to declare a variable of type String[</em>], and therefore it is not possible to use C# syntax to access a single-dimensional, non-zero–based array. Although you can call Array’s GetValue and SetValue methods to access the elements of the array, this access will be slow due to the overhead of the method call.</p></blockquote><blockquote><p>For multi-dimensional arrays, the zero-based and 1-based arrays all display the same type name: System.String[,]. The CLR treats all multi-dimensional arrays as though they are not zero-based at run time. This would make you think that the type name should display as System.String[<em>,</em>]; however, the CLR doesn’t use the *s for multi-dimensional arrays because they would always be present, and the asterisks would just confuse most developers.</p></blockquote><blockquote><p>Accessing the elements of a single-dimensional, zero-based array is slightly faster than accessing the elements of a non-zero–based, single-dimensional array or a multi-dimensional array. There are several reasons for this. First, there are specific IL instructions—such as newarr, ldelem, ldelema, ldlen, and stelem—to manipulate single-dimensional, zero-based arrays, and these special IL instructions cause the JIT compiler to emit optimized code. For example, the JIT compiler will emit code that assumes that the array is zero-based, and this means that an offset doesn’t have to be subtracted from the specified index when accessing an element. Second, in common situations, the JIT compiler is able to hoist the index range–checking code out of the loop, causing it to execute just once. For example, look at the following commonly written code.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> a<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Do something with a[index] </span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The first thing to notice about this code is the call to the array’s Length property in the for loop’s test expression. Because Length is a property, querying the length actually represents a method call. However, the JIT compiler knows that Length is a property on the Array class, and the JIT compiler will actually generate code that calls the property just once and stores the result in a temporary variable that will be checked with each iteration of the loop. The result is that the JITted code is fast. In fact, some developers have underestimated the abilities of the JIT compiler and have tried to write “clever code” in an attempt to help the JIT compiler. However, any clever attempts that you come up with will almost certainly impact performance negatively and make your code harder to read, reducing its maintainability. You are better off leaving the call to the array’s Length property in the preceding code instead of attempting to cache it in a local variable yourself.</p></blockquote><blockquote><p>The second thing to notice about the preceding code is that the JIT compiler knows that the for loop is accessing array elements 0 through Length - 1. So the JIT compiler produces code that, at run time, tests that all array accesses will be within the array’s valid range. Specifically, the JIT compiler produces code to check if (0 &gt;= a.GetLowerBound(0)) &amp;&amp; ((Length – 1) &lt;= a.GetUpperBound(0)). This check occurs just before the loop. If the check is good, the JIT compiler will not generate code inside the loop to verify that each array access is within the valid range. This allows array access within the loop to be very fast.</p></blockquote><blockquote><p>Unfortunately, as I alluded to earlier in this chapter, accessing elements of a non-zero–based single-dimensional array or of a multi-dimensional array is much slower than a single-dimensional, zerobased array. For these array types, the JIT compiler doesn’t hoist index checking outside of loops, so each array access validates the specified indexes. In addition, the JIT compiler adds code to subtract the array’s lower bounds from the specified index, which also slows the code down, even if you’re using a multi-dimensional array that happens to be zero-based. So if performance is a concern to you, you might want to consider using an array of arrays (a jagged array) instead of a rectangular array.</p></blockquote><blockquote><p>C# and the CLR also allow you to access an array by using unsafe (non-verifiable) code, which is, in effect, a technique that allows you to turn off the index bounds checking when accessing an array. Note that this unsafe array manipulation technique is usable with arrays whose elements are SByte, Byte, Int16, UInt16, Int32, UInt32, Int64, UInt64, Char, Single, Double, Decimal, Boolean, an enumerated type, or a value type structure whose fields are any of the aforementioned types.</p></blockquote><blockquote><p>This is a very powerful feature that should be used with extreme caution because it allows you to perform direct memory accesses. If these memory accesses are outside the bounds of the array, an exception will not be thrown; instead, you will be corrupting memory, violating type safety, and possibly opening a security hole! For this reason, the assembly containing the unsafe code must either be granted full trust or at least have the Security Permission with Skip Verification turned on.</p></blockquote><blockquote><p>This is a very powerful feature that should be used with extreme caution because it allows you to perform direct memory accesses. If these memory accesses are outside the bounds of the array, an exception will not be thrown; instead, you will be corrupting memory, violating type safety, and possibly opening a security hole! For this reason, the assembly containing the unsafe code must either be granted full trust or at least have the Security Permission with Skip Verification turned on.</p></blockquote><blockquote><p>The following C# code demonstrates three techniques (safe, jagged, and unsafe), for accessing a two-dimensional array.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Diagnostics</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name">Int32</span> c_numElements <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Declare a two-dimensional array</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span></span> a2Dim <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32</span><span class="token punctuation">[</span>c_numElements<span class="token punctuation">,</span> c_numElements<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Declare a two-dimensional array as a jagged array (a vector of vectors)</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> aJagged <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32</span><span class="token punctuation">[</span>c_numElements<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> c_numElements<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre> aJagged<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32</span><span class="token punctuation">[</span>c_numElements<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// 1: Access all elements of the array using the usual, safe technique</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token function">Safe2DimArrayAccess</span><span class="token punctuation">(</span>a2Dim<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// 2: Access all elements of the array using the jagged array technique</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token function">SafeJaggedArrayAccess</span><span class="token punctuation">(</span>aJagged<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token comment">// 3: Access all elements of the array using the unsafe technique</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token function">Unsafe2DimArrayAccess</span><span class="token punctuation">(</span>a2Dim<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Int32</span> <span class="token function">Safe2DimArrayAccess</span><span class="token punctuation">(</span><span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span></span> a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token class-name">Int32</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> c_numElements<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> c_numElements<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> sum <span class="token operator">+=</span> a<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token keyword">return</span> sum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Int32</span> <span class="token function">SafeJaggedArrayAccess</span><span class="token punctuation">(</span><span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token class-name">Int32</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> c_numElements<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> c_numElements<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre> sum <span class="token operator">+=</span> a<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">y</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token keyword">return</span> sum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name">Int32</span> <span class="token function">Unsafe2DimArrayAccess</span><span class="token punctuation">(</span><span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">]</span></span> a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token class-name">Int32</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token keyword">fixed</span> <span class="token punctuation">(</span>Int32<span class="token operator">*</span> pi <span class="token operator">=</span> a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> c_numElements<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> <span class="token class-name">Int32</span> baseOfDim <span class="token operator">=</span> x <span class="token operator">*</span> c_numElements<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> c_numElements<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre> sum <span class="token operator">+=</span> pi<span class="token punctuation">[</span>baseOfDim <span class="token operator">+</span> y<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token keyword">return</span> sum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The Unsafe2DimArrayAccess method is marked with the unsafe modifier, which is required to use C#’s fixed statement. To compile this code, you’ll have to specify the /unsafe switch when invoking the C# compiler or select the Allow Unsafe Code check box on the Build tab of the Project Properties pane in Microsoft Visual Studio.</p></blockquote><blockquote><p>Obviously, the unsafe technique has a time and place when it can best be used by your own code, but beware that there are three serious downsides to using this technique:</p><ul><li><p>The code that manipulates the array elements is more complicated to read and write than that which manipulates the elements using the other techniques because you are using C#’s fixed statement and performing memory-address calculations.</p></li><li><p>If you make a mistake in the calculation, you are accessing memory that is not part of the array. This can result in an incorrect calculation, corruption of memory, a type-safety violation, and a potential security hole.</p></li><li><p>Due to the potential problems, the CLR forbids unsafe code from running in reduced-security environments (like Microsoft Silverlight).</p></li></ul></blockquote><p>💡小结：CLR 内部支持两种不同的数组，一种是 SZ 数组，另一种是下限未知的一维或多维数组。CLR 使用 * 符号表示知道该数组不是一维 0 基数组。C# 不允许声明 <code>String[*]</code> 类型的变量，因此不能使用 C# 语法来访问一维非 0 基数组。尽管可以调用 <code>Array</code> 的 <code>GetValue</code> 和 <code>SetValue</code> 方法来访问这种数组的元素，但速度会比较慢，因为有方法调用的开销。对于多维数组，0 基和 1 基数组会显式同样的类型名称： <code>System.String[,]</code> 。在运行时，CLR 将所有多维数组都视为非 0 基数组。对于多维数组，CLR 决定不使用 * 符号。访问一维 0 基数组的元素比访问非 0 基一维或多维数组的元素稍快。这是多方面的原因造成的。首先，有一些特殊 IL 指令，比如 <code>newarr</code> ， <code>ledlem</code> ， <code>ldelema</code> ， <code>ldlen</code> 和 <code>stelem</code> ，用于处理一维 0 基数组，这些特殊 IL 指令会导致 JIT 编译器生成优化代码。其次，一般情况下，JIT 编译器能将索引范围检查代码从循环中拿出，导致它只执行一次。对于非 0 基一维数组而言，JIT 编译器不会将索引检查从循环中拿出来，所以每次数组访问都要验证指定的索引。此外，JIT 编译器还要添加代码从指定索引中减去数组下限，这进一步影响了代码执行速度，即使此时使用的多维数组碰巧是 0 基数组。所以，如果很关心性能，考虑用由数组构成的数组（基骄傲错数组）代替矩形数组。C# 和 CLR 还允许使用 unsafe（不可验证）代码访问数组。这种技术实际在访问数组时关闭索引上下限检查。这种功能很强大，但使用须谨慎，因为它允许直接内存访问。访问越界（超出数组上下限）不会抛出异常，但会损坏内存中的数据，破坏类型安全性，并可能造成安全漏洞，有鉴于此，包含 unsafe 代码的程序集必须被赋予完全信任，或至少启用 “跳过验证” 安全权限。此外，unsafe 修饰符常与 fixed 关键字搭配使用。</p><h2 id="unsafe-array-access-and-fixed-size-array"><a class="anchor" href="#unsafe-array-access-and-fixed-size-array">#</a> Unsafe Array Access and Fixed-Size Array</h2><blockquote><p>Unsafe array access is very powerful because it allows you to access:</p><ul><li><p>Elements within a managed array object that resides on the heap (as the previous section demonstrated).</p></li><li><p>Elements within an array that resides on an unmanaged heap. The SecureString example in Chapter 14, “Chars, Strings, and Working with Text,” demonstrated using unsafe array access on an array returned from calling the System.Runtime.InteropServices.Marshal class’s SecureStringToCoTaskMemUnicode method.</p></li><li><p>Elements within an array that resides on the thread’s stack.</p></li></ul></blockquote><blockquote><p>In cases in which performance is extremely critical, you could avoid allocating a managed array object on the heap and instead allocate the array on the thread’s stack by using C#’s stackalloc statement (which works a lot like C’s alloca function). The stackalloc statement can be used to create a single-dimensional, zero-based array of value type elements only, and the value type must not contain any reference type fields. Really, you should think of this as allocating a block of memory that you can manipulate by using unsafe pointers, and therefore, you cannot pass the address of this memory buffer to the vast majority of FCL methods. Of course, the stack-allocated memory (array) will automatically be freed when the method returns; this is where we get the performance improvement. Using this feature also requires you to specify the /unsafe switch to the C# compiler.</p></blockquote><blockquote><p>The StackallocDemo method in the following code shows an example of how to use C#’s stackalloc statement.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token function">StackallocDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token function">InlineArrayDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">StackallocDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">unsafe</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">const</span> <span class="token class-name">Int32</span> width <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> Char<span class="token operator">*</span> pc <span class="token operator">=</span> <span class="token keyword">stackalloc</span> Char<span class="token punctuation">[</span>width<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Allocates array on stack </span></pre></td></tr><tr><td data-num="11"></td><td><pre> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">"Jeffrey Richter"</span><span class="token punctuation">;</span> <span class="token comment">// 15 characters </span></pre></td></tr><tr><td data-num="13"></td><td><pre> </pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> pc<span class="token punctuation">[</span>width <span class="token operator">-</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> s<span class="token punctuation">.</span>Length<span class="token punctuation">)</span> <span class="token punctuation">?</span> s<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token char">'.'</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token comment">// The following line displays ".....rethciR yerffeJ" </span></pre></td></tr><tr><td data-num="19"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">String</span><span class="token punctuation">(</span>pc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">InlineArrayDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token keyword">unsafe</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token class-name">CharArray</span> ca<span class="token punctuation">;</span> <span class="token comment">// Allocates array on stack </span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token class-name">Int32</span> widthInBytes <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">CharArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token class-name">Int32</span> width <span class="token operator">=</span> widthInBytes <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">"Jeffrey Richter"</span><span class="token punctuation">;</span> <span class="token comment">// 15 characters </span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="29"></td><td><pre> ca<span class="token punctuation">.</span>Characters<span class="token punctuation">[</span>width <span class="token operator">-</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> </pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> s<span class="token punctuation">.</span>Length<span class="token punctuation">)</span> <span class="token punctuation">?</span> s<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token char">'.'</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token comment">// The following line displays ".....rethciR yerffeJ" </span></pre></td></tr><tr><td data-num="33"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">String</span><span class="token punctuation">(</span>ca<span class="token punctuation">.</span>Characters<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">unsafe</span> <span class="token keyword">struct</span> <span class="token class-name">CharArray</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token comment">// This array is embedded inline inside the structure </span></pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">fixed</span> Char Characters<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Normally, because arrays are reference types, an array field defined in a structure is really just a pointer or reference to an array; the array itself lives outside of the structure’s memory. However, it is possible to embed an array directly inside a structure as shown by the CharArray structure in the preceding code. To embed an array directly inside a structure, there are several requirements:</p><ul><li><p>The type must be a structure (value type); you cannot embed an array inside a class (reference type).</p></li><li><p>The field or its defining structure must be marked with the unsafe keyword.</p></li><li><p>The array field must be marked with the fixed keyword.</p></li><li><p>The array must be single-dimensional and zero-based.</p></li><li><p>The array’s element type must be one of the following types: Boolean, Char, SByte, Byte, Int16, UInt16, Int32, UInt32, Int64, UInt64, Single, or Double.</p></li></ul></blockquote><blockquote><p>Inline arrays are typically used for scenarios that involve interoperating with unmanaged code where the unmanaged data structure also has an inline array. However, inline arrays can be used in other scenarios as well. The InlineArrayDemo method in the code shown earlier offers an example of how to use an inline array. The InlineArrayDemo method performs the same function as the StackallocDemo method; it just does it in a different way.</p></blockquote><p>💡小结：不安全的数组访问非常强大，它不仅可以访问堆上的托管数组对象中的元素，还能访问非托管堆上的数组中的元素以及线程栈上的数组中的元素。非托管堆上的数组可以参考安全字符串的例子，而在线程栈上分配数组是通过 C# 的 <code>stackalloc</code> 语句来完成的（它很大程度上类似于 C 的 <code>alloca</code> 函数）。 <code>stackalloc</code> 语句只能创建一维 0 基、由值元素构成的数组，而且值类型绝对不能包含任何引用类型的字段。实际上，应该把它的作用看成是分配一个内存块，这个内存块可以使用不安全的指针来操纵。所以，不能将这个内存缓冲区的地址传给大部分 FCL 方法。通常，由于数组是引用类型，所以结构中定义的数组字段实际只是指向数组的指针或引用；数组本身在结构的内存的外部。不过，也可以向上述例子中那样，直接将数组嵌入结构。在结构中嵌入数组需满足几个条件：1. 类型必须是结构（值类型）；不能在类（引用类型）中嵌入数组。2. 字段或其定义结构必须用 unsafe 关键字标记。3. 数组字段必须用 fixed 关键字标记。4. 数组必须是一维 0 基数组。5. 数组的元素类型必须是以下类型之一： <code>Boolean</code> ， <code>Char</code> ， <code>SByte</code> ， <code>Byte</code> ， <code>Int16</code> ， <code>Int32</code> ， <code>UInt16</code> ， <code>UInt32</code> ， <code>Int64</code> ， <code>Single</code> 或 <code>Double</code> 。要和非托管代码进行互操作，而且非托管数据结构也有一个内联数组，就特别适合使用内联的数组。</p><div class="tags"><a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag"><i class="ic i-tag"></i> 读书笔记</a> <a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C#</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2022-11-19 19:22:57" itemprop="dateModified" datetime="2022-11-19T19:22:57+08:00">2022-11-19</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Sakupinera WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/images/alipay.png" alt="Sakupinera Alipay"><p>Alipay</p></div><div><img data-src="/images/paypal.png" alt="Sakupinera PayPal"><p>PayPal</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Sakupinera <i class="ic i-at"><em>@</em></i>Sakupinera</li><li class="link"><strong>Post link: </strong><a href="http://sakupinera.github.io/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/" title="CLR via C# - Chapter 16 Arrays">http://sakupinera.github.io/2022/11/19/csharp/clr-via-csharp/Chapter 16 Arrays/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/11/17/csharp/clr-via-csharp/Chapter%2015%20Enumerated%20Types%20and%20Bit%20Flags/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;03&#x2F;08&#x2F;Z2usRnE64TXN1Lp.jpg" title="CLR via C# - Chapter 15 Enumerated Types and Bit Flags"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 15 Enumerated Types and Bit Flags</h3></a></div><div class="item right"><a href="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;03&#x2F;08&#x2F;r1VBTR45h8jQWZA.jpg" title="CLR via C# - Chapter 17 Delegates"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 17 Delegates</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#chapter-16-arrays"><span class="toc-number">1.</span> <span class="toc-text">Chapter 16 Arrays</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#initializing-array-elements"><span class="toc-number">1.1.</span> <span class="toc-text">Initializing Array Elements</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#casting-arrays"><span class="toc-number">1.2.</span> <span class="toc-text">Casting Arrays</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#all-arrays-are-implicitly-derived-from-systemarray"><span class="toc-number">1.3.</span> <span class="toc-text">All Arrays Are Implicitly Derived from System.Array</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#all-arrays-implicitly-implement-ienumerable-icollection-and-ilist"><span class="toc-number">1.4.</span> <span class="toc-text">All Arrays Implicitly Implement IEnumerable, ICollection, and IList</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#passing-and-returning-arrays"><span class="toc-number">1.5.</span> <span class="toc-text">Passing and Returning Arrays</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#creating-non-zero-lower-bound-arrays"><span class="toc-number">1.6.</span> <span class="toc-text">Creating Non-Zero Lower Bound Arrays</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#array-internals"><span class="toc-number">1.7.</span> <span class="toc-text">Array Internals</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unsafe-array-access-and-fixed-size-array"><span class="toc-number">1.8.</span> <span class="toc-text">Unsafe Array Access and Fixed-Size Array</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%201%20The%20CLR%E2%80%99s%20Execution%20Model/" rel="bookmark" title="CLR via C# - Chapter 1 The CLR’s Execution Model">CLR via C# - Chapter 1 The CLR’s Execution Model</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%202%20Building,%20Packaging,%20Deploying,%20and%20Administering%20Applications%20and%20Types/" rel="bookmark" title="CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types">CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%203%20Shared%20Assemblies%20and%20Strongly%20Named%20Assemblies/" rel="bookmark" title="CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies">CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies</a></li><li><a href="/2022/09/27/csharp/clr-via-csharp/Chapter%204%20Type%20Fundamentals/" rel="bookmark" title="CLR via C# - Chapter 4 Type Fundamentals">CLR via C# - Chapter 4 Type Fundamentals</a></li><li><a href="/2022/10/15/csharp/clr-via-csharp/Chapter%205%20Primitive,%20Reference,%20and%20Value%20%20Types/" rel="bookmark" title="CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals">CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals</a></li><li><a href="/2022/10/21/csharp/clr-via-csharp/Chapter%206%20Type%20and%20Member%20Basics/" rel="bookmark" title="CLR via C# - Chapter 6 Type and Member Basics">CLR via C# - Chapter 6 Type and Member Basics</a></li><li><a href="/2022/10/24/csharp/clr-via-csharp/Chapter%207%20Constants%20and%20Fields/" rel="bookmark" title="CLR via C# - Chapter 7 Constants and Fields">CLR via C# - Chapter 7 Constants and Fields</a></li><li><a href="/2022/10/25/csharp/clr-via-csharp/Chapter%208%20Methods/" rel="bookmark" title="CLR via C# - Chapter 8 Methods">CLR via C# - Chapter 8 Methods</a></li><li><a href="/2022/10/27/csharp/clr-via-csharp/Chapter%209%20Parameters/" rel="bookmark" title="CLR via C# - Chapter 9 Parameters">CLR via C# - Chapter 9 Parameters</a></li><li><a href="/2022/10/28/csharp/clr-via-csharp/Chapter%2010%20Properties/" rel="bookmark" title="CLR via C# - Chapter 10 Properties">CLR via C# - Chapter 10 Properties</a></li><li><a href="/2022/10/29/csharp/clr-via-csharp/Chapter%2011%20Events/" rel="bookmark" title="CLR via C# - Chapter 11 Events">CLR via C# - Chapter 11 Events</a></li><li><a href="/2022/11/02/csharp/clr-via-csharp/Chapter%2012%20Generics/" rel="bookmark" title="CLR via C# - Chapter 12 Generics">CLR via C# - Chapter 12 Generics</a></li><li><a href="/2022/11/04/csharp/clr-via-csharp/Chapter%2013%20Interfaces/" rel="bookmark" title="CLR via C# - Chapter 13 Interfaces">CLR via C# - Chapter 13 Interfaces</a></li><li><a href="/2022/11/16/csharp/clr-via-csharp/Chapter%2014%20Chars,%20Strings,%20and%20Working%20%20with%20Text/" rel="bookmark" title="CLR via C# - Chapter 14 Chars, Strings, and Working with Text">CLR via C# - Chapter 14 Chars, Strings, and Working with Text</a></li><li><a href="/2022/11/17/csharp/clr-via-csharp/Chapter%2015%20Enumerated%20Types%20and%20Bit%20Flags/" rel="bookmark" title="CLR via C# - Chapter 15 Enumerated Types and Bit Flags">CLR via C# - Chapter 15 Enumerated Types and Bit Flags</a></li><li class="active"><a href="/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/" rel="bookmark" title="CLR via C# - Chapter 16 Arrays">CLR via C# - Chapter 16 Arrays</a></li><li><a href="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/" rel="bookmark" title="CLR via C# - Chapter 17 Delegates">CLR via C# - Chapter 17 Delegates</a></li><li><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" rel="bookmark" title="CLR via C# - Chapter 18 Custom Attributes">CLR via C# - Chapter 18 Custom Attributes</a></li><li><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" rel="bookmark" title="CLR via C# - Chapter 19 Nullable Value Types">CLR via C# - Chapter 19 Nullable Value Types</a></li><li><a href="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/" rel="bookmark" title="CLR via C# - Chapter 20 Exceptions and State Management">CLR via C# - Chapter 20 Exceptions and State Management</a></li><li><a href="/2022/11/27/csharp/clr-via-csharp/Chapter%2021%20The%20Managed%20Heap%20and%20Garbage%20%20Collection/" rel="bookmark" title="CLR via C# - Chapter 21 The Managed Heap and Garbage  Collection">CLR via C# - Chapter 21 The Managed Heap and Garbage Collection</a></li><li><a href="/2022/11/28/csharp/clr-via-csharp/Chapter%2022%20CLR%20Hosting%20and%20AppDomains/" rel="bookmark" title="CLR via C# - Chapter 22 CLR Hosting and AppDomains">CLR via C# - Chapter 22 CLR Hosting and AppDomains</a></li><li><a href="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/" rel="bookmark" title="CLR via C# - Chapter 23 Assembly Loading and Reflection">CLR via C# - Chapter 23 Assembly Loading and Reflection</a></li><li><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" rel="bookmark" title="CLR via C# - Chapter 24 Runtime Serialization">CLR via C# - Chapter 24 Runtime Serialization</a></li><li><a href="/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/" rel="bookmark" title="CLR via C# - Chapter 25 Interoperating with WinRT Components">CLR via C# - Chapter 25 Interoperating with WinRT Components</a></li><li><a href="/2023/02/06/csharp/clr-via-csharp/Chapter%2026%20Thread%20Basics/" rel="bookmark" title="CLR via C# - Chapter 26 Thread Basics">CLR via C# - Chapter 26 Thread Basics</a></li><li><a href="/2023/02/07/csharp/clr-via-csharp/Chapter%2027%20Compute-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations">CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations</a></li><li><a href="/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 28 IO-Bound Asynchronous Operations">CLR via C# - Chapter 28 IO-Bound Asynchronous Operations</a></li><li><a href="/2023/02/09/csharp/clr-via-csharp/Chapter%2029%20Primitive%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 29 Primitive Thread Synchronization">CLR via C# - Chapter 29 Primitive Thread Synchronization</a></li><li><a href="/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 30 Hybrid Thread Synchronization">CLR via C# - Chapter 30 Hybrid Thread Synchronization</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Sakupinera" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Sakupinera</p><div class="description" itemprop="description">保持你的决心！</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">86</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">13</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">6</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Nha3VwaW5lcmE=" title="https:&#x2F;&#x2F;github.com&#x2F;sakupinera"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9zYWt1cGluZXJh" title="https:&#x2F;&#x2F;twitter.com&#x2F;sakupinera"><i class="ic i-twitter"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTQwNzIyOTA3MQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;407229071"><i class="ic i-cloud-music"></i></span> <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMjIzMDczOTg/c3BtX2lkX2Zyb209MzMzLjEwMDcuMC4w" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;22307398?spm_id_from&#x3D;333.1007.0.0"><i class="ic i-bilibili"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/games/" rel="section"><i class="ic i-flag"></i>Games</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-person"></i>About</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/11/17/csharp/clr-via-csharp/Chapter%2015%20Enumerated%20Types%20and%20Bit%20Flags/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/09/04/linux/learn-linux/Shell%E7%BC%96%E7%A8%8B/" title="LearnLinux - Shell编程">LearnLinux - Shell编程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/10/29/csharp/clr-via-csharp/Chapter%2011%20Events/" title="CLR via C# - Chapter 11 Events">CLR via C# - Chapter 11 Events</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/GAMES101/" title="In GAMES101">GAMES101</a></div><span><a href="/2022/10/14/computer-graphics/games101/%E6%9D%90%E8%B4%A8%E4%B8%8E%E5%A4%96%E8%A7%82/" title="GAMES101 - Materials and Appearances（材质与外观）">GAMES101 - Materials and Appearances（材质与外观）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/GAMES101/" title="In GAMES101">GAMES101</a></div><span><a href="/2022/10/03/computer-graphics/games101/%E5%87%A0%E4%BD%95/" title="GAMES101 - Geometry（几何）">GAMES101 - Geometry（几何）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/09/02/linux/learn-linux/Shell%E5%9F%BA%E7%A1%80/" title="LearnLinux - Shell基础">LearnLinux - Shell基础</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%202%20Building,%20Packaging,%20Deploying,%20and%20Administering%20Applications%20and%20Types/" title="CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types">CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CSharp-in-a-Nutshell/" title="In CSharp-in-a-Nutshell">CSharp-in-a-Nutshell</a></div><span><a href="/2022/08/30/csharp/csharp-in-a-nutshell/%E7%AC%AC8%E7%AB%A0%20LINQ%E6%9F%A5%E8%AF%A2/" title="C# in a Nutshell - 第8章 LINQ查询">C# in a Nutshell - 第8章 LINQ查询</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/08/28/linux/learn-linux/%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8Vim/" title="LearnLinux - 文本编辑器Vim">LearnLinux - 文本编辑器Vim</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" title="CLR via C# - Chapter 19 Nullable Value Types">CLR via C# - Chapter 19 Nullable Value Types</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/09/05/linux/learn-linux/%E5%90%AF%E5%8A%A8%E7%AE%A1%E7%90%86/" title="LearnLinux - 启动管理">LearnLinux - 启动管理</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Sakupinera @ Hanamai Sora</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">2.2m words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">33:30</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/11/19/csharp/clr-via-csharp/Chapter 16 Arrays/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/assets/shifuku.model.json"},display:{position:"left",width:250,height:500},mobile:{show:!1},react:{opacity:.9},log:!1})</script></body></html>