<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Sakupinera" href="http://sakupinera.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Sakupinera" href="http://sakupinera.github.io/atom.xml"><link rel="alternate" type="application/json" title="Sakupinera" href="http://sakupinera.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="è¯»ä¹¦ç¬”è®°,C#"><link rel="canonical" href="http://sakupinera.github.io/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/"><title>CLR via C# - Chapter 17 Delegates - CLR-via-CSharp - CSharp | Hanamai Sora = Sakupinera</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">CLR via C# - Chapter 17 Delegates</h1><div class="meta"><span class="item" title="Created: 2022-11-21 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2022-11-21T00:00:00+08:00">2022-11-21</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>52k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>47 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Hanamai Sora</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://s2.loli.net/2023/03/08/psd5JEM2ADHakIt.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/r1VBTR45h8jQWZA.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/lrzLEXqhHuVUcP2.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/tNhsmAqoTDncM1b.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/hub7DjxPVYvzoB4.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/Qi9cMFjDZq5V3tB.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/" itemprop="item" rel="index" title="In CSharp"><span itemprop="name">CSharp</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/CLR-via-CSharp/" itemprop="item" rel="index" title="In CLR-via-CSharp"><span itemprop="name">CLR-via-CSharp</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="http://sakupinera.github.io/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Sakupinera"><meta itemprop="description" content=", ä¿æŒä½ çš„å†³å¿ƒï¼"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sakupinera"></span><div class="body md" itemprop="articleBody"><h1 id="chapter-17-delegates"><a class="anchor" href="#chapter-17-delegates">#</a> Chapter 17 Delegates</h1><h2 id="a-first-look-at-delegates"><a class="anchor" href="#a-first-look-at-delegates">#</a> A First Look at Delegates</h2><blockquote><p>The C runtimeâ€™s qsort function takes a pointer to a callback function to sort elements within an array. In Windows, callback functions are required for window procedures, hook procedures, asynchronous procedure calls, and more. In the .NET Framework, callback methods are used for a whole slew of things. For example, you can register callback methods to get a variety of notifications such as unhandled exceptions, window state changes, menu item selections, file system changes, form control events, and completed asynchronous operations.</p></blockquote><blockquote><p>In unmanaged C/C++, the address of a non-member function is just a memory address. This address doesnâ€™t carry any additional information such as the number of parameters the function expects, the types of these parameters, the functionâ€™s return value type, and the functionâ€™s calling convention. In short, unmanaged C/C++ callback functions are not type-safe (although they are a very lightweight mechanism).</p></blockquote><blockquote><p>In the .NET Framework, callback functions are just as useful and pervasive as in unmanaged Windows programming. However, the .NET Framework provides a type-safe mechanism called delegates. Iâ€™ll start off the discussion of delegates by showing you how to use them. The following code demonstrates how to declare, create, and use delegates.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Windows<span class="token punctuation">.</span>Forms</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// Declare a delegate type; instances refer to a method that </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// takes an Int32 parameter and returns void. </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Feedback</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token function">StaticDelegateDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token function">InstanceDelegateDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token function">ChainDelegateDemo1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Program</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token function">ChainDelegateDemo2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Program</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">StaticDelegateDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"----- Static Delegate Demo -----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>Program<span class="token punctuation">.</span>FeedbackToConsole<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>FeedbackToMsgBox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "Program." is optional </span></pre></td></tr><tr><td data-num="19"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">InstanceDelegateDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="22"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"----- Instance Delegate Demo -----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token class-name">Program</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Program</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>FeedbackToFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="25"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ChainDelegateDemo1</span><span class="token punctuation">(</span><span class="token class-name">Program</span> p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="28"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"----- Chain Delegate Demo 1 -----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token class-name">Feedback</span> fb1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>FeedbackToConsole<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token class-name">Feedback</span> fb2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>FeedbackToMsgBox<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token class-name">Feedback</span> fb3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>FeedbackToFile<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token class-name">Feedback</span> fbChain <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="33"></td><td><pre> fbChain <span class="token operator">=</span> <span class="token punctuation">(</span>Feedback<span class="token punctuation">)</span> Delegate<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>fbChain<span class="token punctuation">,</span> fb1<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="34"></td><td><pre> fbChain <span class="token operator">=</span> <span class="token punctuation">(</span>Feedback<span class="token punctuation">)</span> Delegate<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>fbChain<span class="token punctuation">,</span> fb2<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="35"></td><td><pre> fbChain <span class="token operator">=</span> <span class="token punctuation">(</span>Feedback<span class="token punctuation">)</span> Delegate<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>fbChain<span class="token punctuation">,</span> fb3<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> fbChain<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="37"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="38"></td><td><pre> fbChain <span class="token operator">=</span> <span class="token punctuation">(</span>Feedback<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="39"></td><td><pre> Delegate<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>fbChain<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>FeedbackToMsgBox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="40"></td><td><pre> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> fbChain<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="41"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ChainDelegateDemo2</span><span class="token punctuation">(</span><span class="token class-name">Program</span> p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="43"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"----- Chain Delegate Demo 2 -----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token class-name">Feedback</span> fb1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>FeedbackToConsole<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token class-name">Feedback</span> fb2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>FeedbackToMsgBox<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token class-name">Feedback</span> fb3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>FeedbackToFile<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token class-name">Feedback</span> fbChain <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="48"></td><td><pre> fbChain <span class="token operator">+=</span> fb1<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="49"></td><td><pre> fbChain <span class="token operator">+=</span> fb2<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="50"></td><td><pre> fbChain <span class="token operator">+=</span> fb3<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> fbChain<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="52"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="53"></td><td><pre> fbChain <span class="token operator">-=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>FeedbackToMsgBox<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="54"></td><td><pre> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> fbChain<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="56"></td><td><pre> </pre></td></tr><tr><td data-num="57"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> from<span class="token punctuation">,</span> <span class="token class-name">Int32</span> to<span class="token punctuation">,</span> <span class="token class-name">Feedback</span> fb<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="58"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> val <span class="token operator">=</span> from<span class="token punctuation">;</span> val <span class="token operator">&lt;=</span> to<span class="token punctuation">;</span> val<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="59"></td><td><pre> <span class="token comment">// If any callbacks are specified, call them </span></pre></td></tr><tr><td data-num="60"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>fb <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="61"></td><td><pre> <span class="token function">fb</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="62"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="63"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="64"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">FeedbackToConsole</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> <span class="token keyword">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="65"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Item="</span> <span class="token operator">+</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="66"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="67"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">FeedbackToMsgBox</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> <span class="token keyword">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="68"></td><td><pre> MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"Item="</span> <span class="token operator">+</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="69"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="70"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">FeedbackToFile</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> <span class="token keyword">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="71"></td><td><pre> <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">StreamWriter</span> sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamWriter</span><span class="token punctuation">(</span><span class="token string">"Status"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="72"></td><td><pre> sw<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Item="</span> <span class="token operator">+</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="73"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="74"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Now Iâ€™ll describe what this code is doing. At the top, notice the declaration of the internal delegate, Feedback. A delegate indicates the signature of a callback method. In this example, a Feedback delegate identifies a method that takes one parameter (an Int32) and returns void. In a way, a delegate is very much like an unmanaged C/C++ typedef that represents the address of a function.</p></blockquote><blockquote><p>The Program class defines a private, static method named Counter. This method counts integers from the from argument to the to argument. The Counter method also takes an fb, which is a reference to a Feedback delegate object. Counter iterates through all of the integers, and for each integer, if the fb variable is not null, the callback method (specified by the fb variable) is called. This callback method is passed the value of the item being processed, the item number. The callback method can be designed and implemented to process each item in any manner deemed appropriate.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šåœ¨éæ‰˜ç®¡ C/C<ins> ä¸­ï¼Œéæˆå‘˜å‡½æ•°çš„åœ°å€åªæ˜¯ä¸€ä¸ªå†…å­˜åœ°å€ã€‚è¿™ä¸ªåœ°å€ä¸æºå¸¦ä»»ä½•é¢å¤–çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å‡½æ•°æœŸæœ›æ”¶åˆ°çš„å‚æ•°ä¸ªæ•°ã€å‚æ•°ç±»å‹ã€å‡½æ•°è¿”å›å€¼ç±»å‹ä»¥åŠå‡½æ•°çš„è°ƒç”¨åå®šã€‚ç®€å•åœ°è¯´ï¼Œéæ‰˜ç®¡ C/C</ins> å›è°ƒå‡½æ•°ä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼ˆä¸è¿‡å®ƒä»¬ç¡®å®æ˜¯ä¸€ç§éå¸¸è½»é‡çº§çš„æœºåˆ¶ï¼‰ã€‚.NET Framework çš„å›è°ƒå‡½æ•°å’Œéæ‰˜ç®¡ Windows ç¼–ç¨‹ç¯å¢ƒçš„å›è°ƒå‡½æ•°ä¸€æ ·æœ‰ç”¨ï¼Œä¸€æ ·æ™®éã€‚ä½†æ˜¯ï¼Œ.NET Framework æä¾›äº†ç§°ä¸ºå§”æ‰˜çš„ç±»å‹å®‰å…¨æœºåˆ¶ã€‚åœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œå§”æ‰˜å’Œéæ‰˜ç®¡ C/C++ ä¸­ä»£è¡¨å‡½æ•°åœ°å€çš„ typedef å¾ˆç›¸ä¼¼ã€‚</p><h2 id="using-delegates-to-call-back-static-methods"><a class="anchor" href="#using-delegates-to-call-back-static-methods">#</a> Using Delegates to Call Back Static Methods</h2><blockquote><p>Now that you understand how the Counter method is designed and how it works, letâ€™s see how to use delegates to call back static methods. The StaticDelegateDemo method that appears in the previous code sample is the focus of this section.</p></blockquote><blockquote><p>The StaticDelegateDemo method calls the Counter method, passing null in the third parameter, which corresponds to Counterâ€™s fb parameter. Because Counterâ€™s fb parameter receives null, each item is processed without calling any callback method.</p></blockquote><blockquote><p>Next, the StaticDelegateDemo method calls Counter a second time, passing a newly constructed Feedback delegate object in the third parameter of the method call. This delegate object is a wrapper around a method, allowing the method to be called back indirectly via the wrapper. In this example, the name of the static method, Program.FeedbackToConsole, is passed to the Feedback typeâ€™s constructor, indicating that it is the method to be wrapped. The reference returned from the new operator is passed to Counter as its third parameter. Now when Counter executes, it will call the Program typeâ€™s static FeedbackToConsole method for each item in the series. FeedbackToConsole simply writes a string to the console indicating the item being processed.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼š <code>FeedbackToConsole</code> æ–¹æ³•è¢«å®šä¹‰æˆ <code>Program</code> ç±»å‹å†…éƒ¨çš„ç§æœ‰æ–¹æ³•ï¼Œä½† <code>Counter</code> æ–¹æ³•èƒ½è°ƒç”¨ <code>Program</code> çš„ç§æœ‰æ–¹æ³•ï¼Œè¿™æ˜æ˜¾æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸º <code>Counter</code> å’Œ <code>FeedbackToConsole</code> åœ¨åŒä¸€ä¸ªç±»å‹ä¸­å®šä¹‰ã€‚ä½†å³ä½¿ <code>Counter</code> æ–¹æ³•åœ¨å¦ä¸€ä¸ªç±»å‹ä¸­å®šä¹‰ï¼Œä¹Ÿä¸ä¼šå‡ºé—®é¢˜ï¼ç®€å•åœ°è¯´ï¼Œåœ¨ä¸€ä¸ªç±»å‹ä¸­é€šè¿‡å§”æ‰˜æ¥è°ƒç”¨å¦ä¸€ä¸ªç±»å‹çš„ç§æœ‰æˆå‘˜ï¼Œåªè¦å§”æ‰˜å¯¹è±¡æ˜¯ç”±å…·æœ‰è¶³å¤Ÿå®‰å…¨æ€§ / å¯è®¿é—®æ€§çš„ä»£ç åˆ›å»ºçš„ï¼Œä¾¿æ²¡æœ‰é—®é¢˜ã€‚</p><blockquote><p>The third call to Counter in the StaticDelegateDemo method is almost identical to the second call. The only difference is that the Feedback delegate object wraps the static Program.FeedbackToMsgBox method. FeedbackToMsgBox builds a string indicating the item being processed. This string is then displayed in a message box.</p></blockquote><blockquote><p>Everything in this example is type-safe. For instance, when constructing a Feedback delegate object, the compiler ensures that the signatures of Programâ€™s FeedbackToConsole and FeedbackToMsgBox methods are compatible with the signature defined by the Feedback delegate. Specifically, both methods must take one argument (an Int32), and both methods must have the same return type (void). If FeedbackToConsole had been defined like this:</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Boolean</span> <span class="token function">FeedbackToConsole</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token keyword">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token range operator">..</span><span class="token punctuation">.</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>the C# compiler wouldnâ€™t compile the code and would issue the following error: error CS0123: No overload for 'FeedbackToConsole' matches delegate 'Feedback'.</p></blockquote><blockquote><p>Both C# and the CLR allow for covariance and contra-variance of reference types when binding a method to a delegate. Covariance means that a method can return a type that is derived from the delegateâ€™s return type. Contra-variance means that a method can take a parameter that is a base of the delegateâ€™s parameter type. For example, given a delegate defined like this:</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">delegate</span> <span class="token return-type class-name">Object</span> <span class="token function">MyCallback</span><span class="token punctuation">(</span><span class="token class-name">FileStream</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>it is possible to construct an instance of this delegate type bound to a method that is prototyped like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token return-type class-name">String</span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token class-name">Stream</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Here, SomeMethodâ€™s return type (String) is a type that is derived from the delegateâ€™s return type (Object); this covariance is allowed. SomeMethodâ€™s parameter type (Stream) is a type that is a base class of the delegateâ€™s parameter type (FileStream); this contra-variance is allowed.</p></blockquote><blockquote><p>Note that covariance and contra-variance are supported only for reference types, not for value types or for void. So, for example, I cannot bind the following method to the MyCallback delegate.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token return-type class-name">Int32</span> <span class="token function">SomeOtherMethod</span><span class="token punctuation">(</span><span class="token class-name">Stream</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Even though SomeOtherMethodâ€™s return type (Int32) is derived from MyCallbackâ€™s return type (Object), this form of covariance is not allowed because Int32 is a value type. Obviously, the reason why value types and void cannot be used for covariance and contra-variance is because the memory structure for these things varies, whereas the memory structure for reference types is always a pointer. Fortunately, the C# compiler will produce an error if you attempt to do something that is not supported.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šå§”æ‰˜å¯¹è±¡æ˜¯æ–¹æ³•çš„åŒ…è£…å™¨ï¼ˆwrapperï¼‰ï¼Œä½¿æ–¹æ³•èƒ½é€šè¿‡åŒ…è£…å™¨æ¥é—´æ¥å›è°ƒã€‚å°†æ–¹æ³•ç»‘å®šåˆ°å§”æ‰˜æ—¶ï¼ŒC# å’Œ CLR éƒ½å…è®¸å¼•ç”¨ç±»å‹çš„åå˜æ€§ï¼ˆcovarianceï¼‰å’Œé€†å˜æ€§ï¼ˆcontravarianceï¼‰ã€‚åå˜æ€§æ˜¯æŒ‡æ–¹æ³•èƒ½è¿”å›ä»å§”æ‰˜çš„è¿”å›å€¼æ´¾ç”Ÿçš„ä¸€ä¸ªç±»å‹ã€‚é€†å˜æ€§æ˜¯æŒ‡æ–¹æ³•è·å–çš„å‚æ•°å¯ä»¥æ˜¯å§”æ‰˜çš„å‚æ•°ç±»å‹çš„åŸºç±»ã€‚æ³¨æ„ï¼Œåªæœ‰å¼•ç”¨ç±»å‹æ‰æ”¯æŒåå˜æ€§å’Œé€†å˜æ€§ï¼Œå€¼ç±»å‹æˆ– void ä¸æ”¯æŒã€‚æ˜¾ç„¶ï¼Œå€¼ç±»å‹å’Œ void ä¹‹æ‰€ä»¥ä¸æ”¯æŒï¼Œæ˜¯å› ä¸ºå®ƒä»¬çš„å­˜å‚¨ç»“æ„æ˜¯å˜åŒ–çš„ï¼Œè€Œå¼•ç”¨ç±»å‹çš„å­˜å‚¨ç»“æ„å§‹ç»ˆæ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚å¹¸å¥½ï¼Œè¯•å›¾æ‰§è¡Œä¸æ”¯æŒçš„æ“ä½œï¼ŒC# ç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚</p><h2 id="using-delegates-to-call-back-instance-methods"><a class="anchor" href="#using-delegates-to-call-back-instance-methods">#</a> Using Delegates to Call Back Instance Methods</h2><blockquote><p>I just explained how delegates can be used to call static methods, but they can also be used to call instance methods for a specific object. To understand how calling back an instance method works, look at the InstanceDelegateDemo method that appears in the code shown at the beginning of this chapter.</p></blockquote><blockquote><p>Notice that a Program object named p is constructed in the InstanceDelegateDemo method. This Program object doesnâ€™t have any instance fields or properties associated with it; I created it merely for demonstration purposes. When the new Feedback delegate object is constructed in the call to the Counter method, its constructor is passed p.FeedbackToFile. This causes the delegate to wrap a reference to the FeedbackToFile method, which is an instance method (not a static method). When Counter calls the callback method identified by its fb argument, the FeedbackToFile instance method is called, and the address of the recently constructed object p will be passed as the implicit this argument to the instance method.</p></blockquote><blockquote><p>The FeedbackToFile method works as the FeedbackToConsole and FeedbackToMsgBox methods, except that it opens a file and appends the string to the end of the file. (The Status file that the method creates can be found in the applicationâ€™s AppBase directory.)</p></blockquote><blockquote><p>Again, the purpose of this example is to demonstrate that delegates can wrap calls to instance methods as well as static methods. For instance methods, the delegate needs to know the instance of the object the method is going to operate on. Wrapping an instance method is useful because code inside the object can access the objectâ€™s instance members. This means that the object can have some state that can be used while the callback method is doing its processing.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šåŒ…è£…å®ä¾‹æ–¹æ³•å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå¯¹è±¡å†…éƒ¨çš„ä»£ç å¯ä»¥è®¿é—®å¯¹è±¡çš„å®ä¾‹æˆå‘˜ã€‚è¿™æ„å‘³ç€å¯¹è±¡å¯ä»¥ç»´æŠ¤ä¸€äº›çŠ¶æ€ï¼Œå¹¶åœ¨å›è°ƒæ–¹æ³•æ‰§è¡ŒæœŸé—´åˆ©ç”¨è¿™äº›çŠ¶æ€ä¿¡æ¯ã€‚</p><h2 id="demystifying-delegates"><a class="anchor" href="#demystifying-delegates">#</a> Demystifying Delegates</h2><blockquote><p>On the surface, delegates seem easy to use: you define them by using C#â€™s delegate keyword, you construct instances of them by using the familiar new operator, and you invoke the callback by using the familiar method-call syntax (except instead of a method name, you use the variable that refers to the delegate object).</p></blockquote><blockquote><p>However, whatâ€™s really going on is quite a bit more complex than what the earlier examples illustrate. The compilers and the CLR do a lot of behind-the-scenes processing to hide the complexity. In this section, Iâ€™ll focus on how the compiler and the CLR work together to implement delegates. Having this knowledge will improve your understanding of delegates and will teach you how to use them efficiently and effectively. Iâ€™ll also touch on some additional features delegates make available.</p></blockquote><blockquote><p>Letâ€™s start by reexamining this line of code.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Feedback</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>When the compiler sees this line, it actually defines a complete class that looks something like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">Feedback</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">System<span class="token punctuation">.</span>MulticastDelegate</span></span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Constructor </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token function">Feedback</span><span class="token punctuation">(</span><span class="token class-name">Object</span> @<span class="token keyword">object</span><span class="token punctuation">,</span> <span class="token class-name">IntPtr</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Method with same prototype as specified by the source code </span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Methods allowing the callback to be called asynchronously </span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IAsyncResult</span> <span class="token function">BeginInvoke</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> <span class="token keyword">value</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token class-name">AsyncCallback</span> callback<span class="token punctuation">,</span> <span class="token class-name">Object</span> @<span class="token keyword">object</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EndInvoke</span><span class="token punctuation">(</span><span class="token class-name">IAsyncResult</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The class defined by the compiler has four methods: a constructor, Invoke, BeginInvoke, and EndInvoke. In this chapter, Iâ€™ll concentrate on the constructor and Invoke methods. The BeginInvoke and EndInvoke methods are related to the .NET Framework's Asynchronous Programming Model which is now considered obsolete and has been replaced by tasks that I discuss in Chapter 27, â€œCompute-Bound Asynchronous Operations.â€</p></blockquote><blockquote><p>In fact, you can verify that the compiler did indeed generate this class automatically by examining the resulting assembly with ILDasm.exe, as shown in Figure 17-1.</p></blockquote><p><img data-src="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/image-20221120171204938.png" alt="image-20221120171204938"></p><blockquote><p>In this example, the compiler has defined a class called Feedback that is derived from the System.MulticastDelegate type defined in the Framework Class Library (FCL). (All delegate types are derived from MulticastDelegate.)</p></blockquote><p>ğŸ’¡é‡è¦æç¤ºï¼š <code>System.MulticastDelegate</code> æ´¾ç”Ÿè‡ª <code>System.Delegate</code> ï¼Œåè€…åˆæ´¾ç”Ÿè‡ª <code>System.Object</code> ã€‚æ˜¯å†å²åŸå› é€ æˆæœ‰ä¸¤ä¸ªå§”æ‰˜ç±»ã€‚è¿™å®åœ¨æ˜¯ä»¤äººé—æ†¾ â€”â€”â€”â€” FCL æœ¬è¯¥åªæœ‰ä¸€ä¸ªå§”æ‰˜ç±»ã€‚æ²¡æœ‰åŠæ³•ï¼Œæˆ‘ä»¬å¯¹è¿™ä¸¤ä¸ªç±»éƒ½è¦æœ‰æ‰€äº†è§£ã€‚å³ä½¿åˆ›å»ºçš„æ‰€æœ‰å§”æ‰˜ç±»å‹éƒ½å°† <code>MulticastDelegate</code> ä½œä¸ºåŸºç±»ï¼Œä¸ªåˆ«æƒ…å†µä¸‹ä»ä¼šä½¿ç”¨ <code>Delegate</code> ç±» (è€Œé <code>MulticastDelegate</code> ç±») å®šä¹‰çš„æ–¹æ³•å¤„ç†è‡ªå·±çš„å§”æ‰˜ç±»å‹ã€‚ä¾‹å¦‚ï¼Œ <code>Delegate</code> ç±»çš„ä¸¤ä¸ªé™æ€æ–¹æ³• <code>Combine</code> å’Œ <code>Remove</code> (åæ–‡å°†è§£é‡Šå…¶ç”¨é€”) çš„ç­¾åéƒ½æŒ‡å‡ºè¦è·å– <code>Delegate</code> å‚æ•°ã€‚ç”±äºä½ åˆ›å»ºçš„å§”æ‰˜ç±»å‹æ´¾ç”Ÿè‡ª <code>MulticastDelegate</code> ï¼Œåè€…åˆæ´¾ç”Ÿè‡ª <code>Delegate</code> ï¼Œæ‰€ä»¥ä½ çš„å§”æ‰˜ç±»å‹çš„å®ä¾‹æ˜¯å¯ä»¥ä¼ ç»™è¿™ä¸¤ä¸ªæ–¹æ³•çš„ã€‚</p><blockquote><p>The class has private visibility because the delegate is declared as internal in the source code. If the source code had indicated public visibility, the Feedback class the compiler generated would also be public. You should be aware that delegate types can be defined within a type (nested within another type) or at global scope. Basically, because delegates are classes, a delegate can be defined anywhere a class can be defined.</p></blockquote><blockquote><p>Because all delegate types are derived from MulticastDelegate, they inherit MulticastDelegateâ€™s fields, properties, and methods. Of all of these members, three non-public fields are probably most significant. Table 17-1 describes these significant fields.</p></blockquote><p><img data-src="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/image-20221120160450648.png" alt="image-20221120160450648"></p><blockquote><p>Notice that all delegates have a constructor that takes two parameters: a reference to an object and an integer that refers to the callback method. However, if you examine the source code, youâ€™ll see that Iâ€™m passing in values such as Program.FeedbackToConsole or p.FeedbackToFile. Everything youâ€™ve learned about programming tells you that this code shouldnâ€™t compile!</p></blockquote><blockquote><p>However, the C# compiler knows that a delegate is being constructed and parses the source code to determine which object and method are being referred to. A reference to the object is passed for the constructorâ€™s object parameter, and a special IntPtr value (obtained from a MethodDef or MemberRef metadata token) that identifies the method is passed for the method parameter. For static methods, null is passed for the object parameter. Inside the constructor, these two arguments are saved in the _target and _methodPtr private fields, respectively. In addition, the constructor sets the _invocationList field to null. Iâ€™ll postpone discussing this _invocationList field until the next section, â€œUsing Delegates to Call Back Many Methods (Chaining).â€</p></blockquote><blockquote><p>So each delegate object is really a wrapper around a method and an object to be operated on when the method is called. So if I have two lines of code that look like this:</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Feedback</span> fbStatic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>Program<span class="token punctuation">.</span>FeedbackToConsole<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Feedback</span> fbInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Program</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>FeedbackToFile<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>the fbStatic and fbInstance variables refer to two separate Feedback delegate objects that are initialized, as shown in Figure 17-2.</p></blockquote><p><img data-src="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/image-20221120160548567.png" alt="image-20221120160548567"></p><blockquote><p>Now that you know how delegate objects are constructed and what their internal structure looks like, letâ€™s talk about how the callback method is invoked. For convenience, Iâ€™ve repeated the code for the Counter method here.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> from<span class="token punctuation">,</span> <span class="token class-name">Int32</span> to<span class="token punctuation">,</span> <span class="token class-name">Feedback</span> fb<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> val <span class="token operator">=</span> from<span class="token punctuation">;</span> val <span class="token operator">&lt;=</span> to<span class="token punctuation">;</span> val<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// If any callbacks are specified, call them </span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>fb <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token function">fb</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Look at the line of code just below the comment. The if statement first checks to see if fb is not null. If fb is not null, on the next line, you see the code that invokes the callback method. The null check is required because fb is really just a variable that can refer to a Feedback delegate object; it could also be null. It might seem as if Iâ€™m calling a function named fb and passing it one parameter (val). However, there is no function called fb. Again, because it knows that fb is a variable that refers to a delegate object, the compiler generates code to call the delegate objectâ€™s Invoke method. In other words, the compiler sees the following.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">fb</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>But the compiler generates code as though the source code said the following.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>fb<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>You can verify that the compiler produces code to call the delegate typeâ€™s Invoke method by using ILDasm.exe to examine the Intermediate Language (IL) code created for the Counter method. Here is the IL for the Counter method. The instruction at IL_0009 in the figure indicates the call to Feedbackâ€™s Invoke method.</p></blockquote><pre><code>.method private hidebysig static void Counter(int32 from,
 int32 'to',
 class Feedback fb) cil managed
&#123;
 // Code size 23 (0x17)
 .maxstack 2
 .locals init (int32 val)
 IL_0000: ldarg.0
 IL_0001: stloc.0
 IL_0002: br.s IL_0012
 IL_0004: ldarg.2
 IL_0005: brfalse.s IL_000e
 IL_0007: ldarg.2
 IL_0008: ldloc.0
 IL_0009: callvirt instance void Feedback::Invoke(int32)
 IL_000e: ldloc.0
 IL_000f: ldc.i4.1
 IL_0010: add
 IL_0011: stloc.0
 IL_0012: ldloc.0
 IL_0013: ldarg.1
 IL_0014: ble.s IL_0004
 IL_0016: ret
&#125; // end of method Program::Counter
</code></pre><blockquote><p>In fact, you could modify the Counter method to call Invoke explicitly, as shown here.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> from<span class="token punctuation">,</span> <span class="token class-name">Int32</span> to<span class="token punctuation">,</span> <span class="token class-name">Feedback</span> fb<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> val <span class="token operator">=</span> from<span class="token punctuation">;</span> val <span class="token operator">&lt;=</span> to<span class="token punctuation">;</span> val<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// If any callbacks are specified, call them </span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>fb <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> fb<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Youâ€™ll recall that the compiler defined the Invoke method when it defined the Feedback class. When Invoke is called, it uses the private _target and _methodPtr fields to call the desired method on the specified object. Note that the signature of the Invoke method matches the signature of the delegate; because the Feedback delegate takes one Int32 parameter and returns void, the Invoke method (as produced by the compiler) takes one Int32 parameter and returns void.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šç¼–è¯‘å™¨å’Œ CLR åœ¨å¹•ååšäº†å¤§é‡å·¥ä½œæ¥éšè—å§”æ‰˜å®ç°çš„å¤æ‚æ€§ã€‚æ¯å£°æ˜ä¸€ä¸ªå§”æ‰˜ï¼Œç¼–è¯‘å™¨ä¼šå®šä¹‰ä¸€ä¸ªå®Œæ•´çš„ç±»ï¼Œè¿™ä¸ªç±»æœ‰ 4 ä¸ªæ–¹æ³•ï¼šä¸€ä¸ªæ„é€ å™¨ã€Invokeã€BeginInvoke å’Œ EndInvokeã€‚è¿™ä¸ªç±»æ´¾ç”Ÿè‡ª FCL å®šä¹‰çš„ <code>System.MulticastDelegate</code> ç±»å‹ï¼ˆæ‰€æœ‰å§”æ‰˜ç±»å‹éƒ½æ´¾ç”Ÿè‡ª MulticastDelegateï¼‰ã€‚è¿™ä¸ªå§”æ‰˜ç±»çš„å¯è®¿é—®æ€§æ ¹æ®å§”æ‰˜åœ¨æºä»£ç ä¸­çš„å£°æ˜æ”¹å˜ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œå§”æ‰˜ç±»æ—¢å¯åµŒå¥—åœ¨ä¸€ä¸ªç±»å‹ä¸­å®šä¹‰ï¼Œä¹Ÿå¯åœ¨å…¨å±€èŒƒå›´ä¸­å®šä¹‰ã€‚ç®€å•åœ°è¯´ï¼Œç”±äºå§”æ‰˜æ˜¯ç±»ï¼Œæ‰€ä»¥å‡¡æ˜¯èƒ½å¤Ÿå®šä¹‰ç±»çš„åœ°æ–¹ï¼Œéƒ½èƒ½å®šä¹‰å§”æ‰˜ã€‚ <code>MulticastDelegate</code> æœ‰ä¸‰ä¸ªéå…¬å…±å­—æ®µæ˜¯æœ€é‡è¦çš„ï¼š <code>_target</code> ï¼Œ <code>_methodPtr</code> ï¼Œ <code>_invocationList</code> ã€‚æ‰€æœ‰å§”æ‰˜éƒ½æœ‰ä¸€ä¸ªæ„é€ å™¨ï¼Œå®ƒè·å–ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªæ˜¯å¯¹è±¡å¼•ç”¨ï¼Œå¦ä¸€ä¸ªæ˜¯å¼•ç”¨äº†å›è°ƒæ–¹æ³•çš„æ•´æ•°ã€‚C# ç¼–è¯‘å™¨çŸ¥é“è¦æ„é€ çš„æ˜¯å§”æ‰˜ï¼Œæ‰€ä»¥ä¼šåˆ†ææºä»£ç æ¥ç¡®å®šå¼•ç”¨çš„æ˜¯å“ªä¸ªå¯¹è±¡å’Œæ–¹æ³•ã€‚å¯¹è±¡å¼•ç”¨è¢«ä¼ ç»™æ„é€ å™¨çš„ object å‚æ•°ï¼Œæ ‡è¯†äº†æ–¹æ³•çš„ä¸€ä¸ªç‰¹æ®Š <code>IntPtr</code> å€¼ï¼ˆä» <code>MethodDef</code> æˆ– <code>MemberRef</code> å…ƒæ•°æ® token è·å¾—ï¼‰è¢«ä¼ ç»™æ„é€ å™¨çš„ method å‚æ•°ã€‚å¯¹äºé™æ€æ–¹æ³•ï¼Œä¼šä¸º object å‚æ•°ä¼ é€’ null å€¼ã€‚åœ¨æ„é€ å™¨å†…éƒ¨ï¼Œè¿™ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¿å­˜åœ¨ <code>_target</code> å’Œ <code>_methodPtr</code> ç§æœ‰å­—æ®µä¸­ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ„é€ å™¨è¿˜å°† <code>_invocationList</code> å­—æ®µè®¾ä¸º nullã€‚å½“ä½¿ç”¨å§”æ‰˜å¯¹è±¡çš„å˜é‡è§¦å‘å›è°ƒæ—¶ï¼Œä¼šç”Ÿæˆä»£ç ä»£ç è°ƒç”¨è¯¥å§”æ‰˜å¯¹è±¡çš„ <code>Invoke</code> æ–¹æ³•ã€‚åœ¨ <code>Invoke</code> è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä½¿ç”¨ç§æœ‰å­—æ®µ <code>_target</code> å’Œ <code>_methodPtr</code> åœ¨æŒ‡å®šå¯¹è±¡ä¸Šè°ƒç”¨åŒ…è£…å¥½çš„å›è°ƒæ–¹æ³•ã€‚æ³¨æ„ï¼Œ <code>Invoke</code> æ–¹æ³•çš„ç­¾åå’Œå§”æ‰˜çš„ç­¾ååŒ¹é…ã€‚</p><h2 id="using-delegates-to-call-back-many-methods-chaining"><a class="anchor" href="#using-delegates-to-call-back-many-methods-chaining">#</a> Using Delegates to Call Back Many Methods (Chaining)</h2><blockquote><p>By themselves, delegates are incredibly useful. But add in their support for chaining, and delegates become even more useful. Chaining is a set or collection of delegate objects, and it provides the ability to invoke, or call, all of the methods represented by the delegates in the set. To understand this, see the ChainDelegateDemo1 method that appears in the code shown at the beginning of this chapter. In this method, after the Console.WriteLine statement, I construct three delegate objects and have variablesâ€”fb1, fb2, and fb3â€”refer to each object, as shown in Figure 17-3.</p></blockquote><p><img data-src="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/image-20221120182105934.png" alt="image-20221120182105934"></p><blockquote><p>The reference variable to a Feedback delegate object, fbChain, is intended to refer to a chain or set of delegate objects that wrap methods that can be called back. Initializing fbChain to null indicates that there currently are no methods to be called back. The Delegate classâ€™s public, static Combine method is used to add a delegate to the chain.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>fbChain <span class="token operator">=</span> <span class="token punctuation">(</span>Feedback<span class="token punctuation">)</span> Delegate<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>fbChain<span class="token punctuation">,</span> fb1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>When this line of code executes, the Combine method sees that we are trying to combine null and fb1. Internally, Combine will simply return the value in fb1, and the fbChain variable will be set to refer to the same delegate object referred to by the fb1 variable, as shown in Figure 17-4.</p></blockquote><p><img data-src="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/image-20221120182154714.png" alt="image-20221120182154714"></p><blockquote><p>To add another delegate to the chain, the Combine method is called again.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>fbChain <span class="token operator">=</span> <span class="token punctuation">(</span>Feedback<span class="token punctuation">)</span> Delegate<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>fbChain<span class="token punctuation">,</span> fb2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Internally, the Combine method sees that fbChain already refers to a delegate object, so Combine will construct a new delegate object. This new delegate object initializes its private _target and _methodPtr fields to values that are not important for this discussion. However, what is important is that the _invocationList field is initialized to refer to an array of delegate objects. The first element of this array (index 0) will be initialized to refer to the delegate that wraps the FeedbackToConsole method (this is the delegate that fbChain currently refers to). The second element of the array (index 1) will be initialized to refer to the delegate that wraps the FeedbackToMsgBox method (this is the delegate that fb2 refers to). Finally, fbChain will be set to refer to the newly created delegate object, shown in Figure 17-5.</p></blockquote><blockquote><p>To add the third delegate to the chain, the Combine method is called once again.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>fbChain <span class="token operator">=</span> <span class="token punctuation">(</span>Feedback<span class="token punctuation">)</span> Delegate<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>fbChain<span class="token punctuation">,</span> fb3<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Again, Combine sees that fbChain already refers to a delegate object, and this causes a new delegate object to be constructed, as shown in Figure 17-6. As before, this new delegate object initializes the private _target and _methodPtr fields to values unimportant to this discussion, and the _invocationList field is initialized to refer to an array of delegate objects. The first and second elements of this array (indexes 0 and 1) will be initialized to refer to the same delegates the previous delegate object referred to in its array. The third element of the array (index 2) will be initialized to refer to the delegate that wraps the FeedbackToFile method (this is the delegate that fb3 refers to). Finally, fbChain will be set to refer to this newly created delegate object. Note that the previously created delegate and the array referred to by its _invocationList field are now candidates for garbage collection.</p></blockquote><p><img data-src="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/image-20221120182317707.png" alt="image-20221120182317707"></p><p><img data-src="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/image-20221120182402306-1668939842956-1.png" alt="image-20221120182402306"></p><blockquote><p>After all of the code has executed to set up the chain, the fbChain variable is then passed to the Counter method.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">Counter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> fbChain<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Inside the Counter method is the code that implicitly calls the Invoke method on the Feedback delegate object as I detailed earlier. When Invoke is called on the delegate referred to by fbChain, the delegate sees that the private _invocationList field is not null, causing it to execute a loop that iterates through all of the elements in the array, calling the method wrapped by each delegate. In this example, FeedbackToConsole will get called first, followed by FeedbackToMsgBox, followed by FeedbackToFile.</p></blockquote><blockquote><p>Feedbackâ€™s Invoke method is essentially implemented something like the following (in pseudocode).</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> <span class="token keyword">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name">Delegate<span class="token punctuation">[</span><span class="token punctuation">]</span></span> delegateSet <span class="token operator">=</span> _invocationList <span class="token keyword">as</span> <span class="token class-name">Delegate<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>delegateSet <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// This delegate's array indicates the delegates that should be called </span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Feedback</span> d <span class="token keyword">in</span> delegateSet<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token function">d</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Call each delegate </span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// This delegate identifies a single method to be called back </span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// Call the callback method on the specified target object. </span></pre></td></tr><tr><td data-num="10"></td><td><pre> _methodPtr<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>_target<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// The preceding line is an approximation of the actual code. </span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// What really happens cannot be expressed in C#. </span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Note that it is also possible to remove a delegate from a chain by calling Delegateâ€™s public, static Remove method. This is demonstrated toward the end of the ChainDelegateDemo1 method.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>fbChain <span class="token operator">=</span> <span class="token punctuation">(</span>Feedback<span class="token punctuation">)</span> Delegate<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>fbChain<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Feedback</span><span class="token punctuation">(</span>FeedbackToMsgBox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>When Remove is called, it scans the delegate array (from the end toward index 0) maintained inside the delegate object referred to by the first parameter (fbChain, in my example). Remove is looking for a delegate entry whose _target and _methodPtr fields match those in the second argument (the new Feedback delegate, in my example). If a match is found and there is only one item left in the array, that array item is returned. If a match is found and there are multiple items left in the array, a new delegate object is constructedâ€”the _invocationList array created and initialized will refer to all items in the original array except for the item being removed, of courseâ€”and a reference to this new delegate object is returned. If you are removing the only element in the chain, Remove returns null. Note that each call to Remove removes just one delegate from the chain; it does not remove all delegates that have matching _target and _methodPtr fields.</p></blockquote><blockquote><p>So far, Iâ€™ve shown examples in which my delegate type, Feedback, is defined as having a void return value. However, I could have defined my Feedback delegate as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name">Int32</span> <span class="token function">Feedback</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>If I had, its Invoke method would have internally looked like the following (again, in pseudocode).</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> <span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> <span class="token keyword">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name">Int32</span> result<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name">Delegate<span class="token punctuation">[</span><span class="token punctuation">]</span></span> delegateSet <span class="token operator">=</span> _invocationList <span class="token keyword">as</span> <span class="token class-name">Delegate<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>delegateSet <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// This delegate's array indicates the delegates that should be called </span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Feedback</span> d <span class="token keyword">in</span> delegateSet<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> result <span class="token operator">=</span> <span class="token function">d</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Call each delegate </span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// This delegate identifies a single method to be called back </span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Call the callback method on the specified target object. </span></pre></td></tr><tr><td data-num="11"></td><td><pre> result <span class="token operator">=</span> _methodPtr<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>_target<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// The preceding line is an approximation of the actual code. </span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// What really happens cannot be expressed in C#. </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">return</span> result<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>As each delegate in the array is called, its return value is saved in the result variable. When the loop is complete, the result variable will contain only the result of the last delegate called (previous return values are discarded); this value is returned to the code that called Invoke.</p></blockquote><h3 id="cs-support-for-delegate-chains"><a class="anchor" href="#cs-support-for-delegate-chains">#</a> C#â€™s Support for Delegate Chains</h3><blockquote><p>To make things easier for C# developers, the C# compiler automatically provides overloads of the += and -= operators for instances of delegate types. These operators call Delegate.Combine and Delegate.Remove, respectively. Using these operators simplifies the building of delegate chains. The ChainDelegateDemo1 and ChainDelegateDemo2 methods in the source code shown at the beginning of this chapter produce absolutely identical IL code. The only difference between the methods is that the ChainDelegateDemo2 method simplifies the source code by taking advantage of C#â€™s += and -= operators.</p></blockquote><blockquote><p>If you require proof that the resulting IL code is identical for the two methods, you can build the code and look at its IL for both methods by using ILDasm.exe. This will confirm that the C# compiler did in fact replace all += and -= operators with calls to the Delegate typeâ€™s public static Combine and Remove methods, respectively.</p></blockquote><h3 id="having-more-control-over-delegate-chain-invocation"><a class="anchor" href="#having-more-control-over-delegate-chain-invocation">#</a> Having More Control over Delegate Chain Invocation</h3><blockquote><p>At this point, you understand how to build a chain of delegate objects and how to invoke all of the objects in that chain. All items in the chain are invoked because the delegate typeâ€™s Invoke method includes code to iterate through all of the items in the array, invoking each item. This is obviously a very simple algorithm. And although this simple algorithm is good enough for a lot of scenarios, it has many limitations. For example, the return values of the callback methods are all discarded except for the last one. Using this simple algorithm, thereâ€™s no way to get the return values for all of the callback methods called. But this isnâ€™t the only limitation. What happens if one of the invoked delegates throws an exception or blocks for a very long time? Because the algorithm invoked each delegate in the chain serially, a â€œproblemâ€ with one of the delegate objects stops all of the subsequent delegates in the chain from being called. Clearly, this algorithm isnâ€™t robust.</p></blockquote><blockquote><p>For those scenarios in which this algorithm is insufficient, the MulticastDelegate class offers an instance method, GetInvocationList, that you can use to call each delegate in a chain explicitly, using any algorithm that meets your needs.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MulticastDelegate</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Delegate</span></span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Creates a delegate array where each element refers </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// to a delegate in the chain. </span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">override</span> <span class="token return-type class-name">Delegate<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">GetInvocationList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The GetInvocationList method operates on a MulticastDelegate-derived object and returns an array of Delegate references where each reference points to one of the chainâ€™s delegate objects. Internally, GetInvocationList constructs an array and initializes it with each element referring to a delegate in the chain; a reference to the array is then returned. If the _invocationList field is null, the returned array contains one element that references the only delegate in the chain: the delegate instance itself.</p></blockquote><blockquote><p>You can easily write an algorithm that explicitly calls each object in the array. The following code demonstrates.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// Define a Light component. </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Light</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// This method returns the light's status. </span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> <span class="token function">SwitchPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">return</span> <span class="token string">"The light is off"</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// Define a Fan component. </span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Fan</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// This method returns the fan's status. </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> <span class="token function">Speed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token string">"The fan broke due to overheating"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// Define a Speaker component. </span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Speaker</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// This method returns the speaker's status. </span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> <span class="token function">Volume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">return</span> <span class="token string">"The volume is loud"</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token comment">// Definition of delegate that allows querying a component's status. </span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">delegate</span> <span class="token return-type class-name">String</span> <span class="token function">GetStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token comment">// Declare an empty delegate chain. </span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token class-name">GetStatus</span> getStatus <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">// Construct the three components, and add their status methods </span></pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token comment">// to the delegate chain. </span></pre></td></tr><tr><td data-num="33"></td><td><pre> getStatus <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetStatus</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Light</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>SwitchPosition<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="34"></td><td><pre> getStatus <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetStatus</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Fan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Speed<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="35"></td><td><pre> getStatus <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetStatus</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Speaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Volume<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token comment">// Show consolidated status report reflecting </span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token comment">// the condition of the three components. </span></pre></td></tr><tr><td data-num="38"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token function">GetComponentStatusReport</span><span class="token punctuation">(</span>getStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="40"></td><td><pre> <span class="token comment">// Method that queries several components and returns a status report </span></pre></td></tr><tr><td data-num="41"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">String</span> <span class="token function">GetComponentStatusReport</span><span class="token punctuation">(</span><span class="token class-name">GetStatus</span> status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token comment">// If the chain is empty, there is nothing to do. </span></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token comment">// Use this to build the status report. </span></pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token class-name">StringBuilder</span> report <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token comment">// Get an array where each element is a delegate from the chain. </span></pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token class-name">Delegate<span class="token punctuation">[</span><span class="token punctuation">]</span></span> arrayOfDelegates <span class="token operator">=</span> status<span class="token punctuation">.</span><span class="token function">GetInvocationList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="48"></td><td><pre> <span class="token comment">// Iterate over each delegate in the array. </span></pre></td></tr><tr><td data-num="49"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">GetStatus</span> getStatus <span class="token keyword">in</span> arrayOfDelegates<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="50"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token comment">// Get a component's status string, and append it to the report. </span></pre></td></tr><tr><td data-num="52"></td><td><pre> report<span class="token punctuation">.</span><span class="token function">AppendFormat</span><span class="token punctuation">(</span><span class="token string">"&#123;0&#125;&#123;1&#125;&#123;1&#125;"</span><span class="token punctuation">,</span> <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Environment<span class="token punctuation">.</span>NewLine<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="53"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="54"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidOperationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token comment">// Generate an error entry in the report for this component. </span></pre></td></tr><tr><td data-num="56"></td><td><pre> <span class="token class-name">Object</span> component <span class="token operator">=</span> getStatus<span class="token punctuation">.</span>Target<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="57"></td><td><pre> report<span class="token punctuation">.</span><span class="token function">AppendFormat</span><span class="token punctuation">(</span> </pre></td></tr><tr><td data-num="58"></td><td><pre> <span class="token string">"Failed to get status from &#123;1&#125;&#123;2&#125;&#123;0&#125; Error: &#123;3&#125;&#123;0&#125;&#123;0&#125;"</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="59"></td><td><pre> Environment<span class="token punctuation">.</span>NewLine<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="60"></td><td><pre> <span class="token punctuation">(</span><span class="token punctuation">(</span>component <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token string">""</span> <span class="token punctuation">:</span> component<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="61"></td><td><pre> getStatus<span class="token punctuation">.</span><span class="token function">GetMethodInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="62"></td><td><pre> e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="63"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="64"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="65"></td><td><pre> <span class="token comment">// Return the consolidated report to the caller. </span></pre></td></tr><tr><td data-num="66"></td><td><pre> <span class="token keyword">return</span> report<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="67"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When you build and run this code, the following output appears.</p></blockquote><pre><code class="language-cmd">The light is off 
Failed to get status from Fan.Speed 
 Error: The fan broke due to overheating 
The volume is loud
</code></pre><p>ğŸ’¡å°ç»“ï¼š <code>Combine</code> æ–¹æ³•å‘ç°åœ¨å¼•ç”¨ä¸¤ä¸ªå§”æ‰˜å¯¹è±¡åŠä»¥ä¸Šæ—¶ä¼šæ„é€ ä¸€ä¸ªæ–°çš„å§”æ‰˜å¯¹è±¡ã€‚æ–°å§”æ‰˜å¯¹è±¡å¯¹å®ƒçš„ç§æœ‰å­—æ®µ <code>_target</code> å’Œ <code>_methodPtr</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œ <code>_invocationList</code> å­—æ®µè¢«åˆå§‹åŒ–ä¸ºå¼•ç”¨ä¸€ä¸ªå§”æ‰˜å¯¹è±¡æ•°ç»„ã€‚åœ¨ç»§ç»­å¾€å§”æ‰˜é“¾ä¸Šå¼•ç”¨æ–°çš„å§”æ‰˜æ—¶ï¼Œä¹‹å‰æ–°å»ºçš„å§”æ‰˜åŠå…¶ <code>_invocationList</code> å­—æ®µå¼•ç”¨çš„æ•°ç»„ç°åœ¨å¯ä»¥è¿›è¡Œåƒåœ¾å›æ”¶ã€‚è¿˜å¯è°ƒç”¨ <code>Delegate</code> çš„å…¬å…±é™æ€æ–¹æ³• <code>Remove</code> ä»é“¾ä¸­åˆ é™¤å§”æ‰˜ã€‚ <code>Remove</code> æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå®ƒæ‰«æç¬¬ä¸€ä¸ªå®å‚æ‰€å¼•ç”¨çš„é‚£ä¸ªå§”æ‰˜å¯¹è±¡å†…éƒ¨ç»´æŠ¤çš„å§”æ‰˜æ•°ç»„ï¼ˆä»æœ«å°¾å‘ç´¢å¼• 0 æ‰«æï¼‰ã€‚ <code>Remove</code> æŸ¥æ‰¾çš„æ˜¯å…¶ <code>_target</code> å’Œ <code>_methodPtr</code> å­—æ®µä¸ç¬¬äºŒä¸ªå®å‚ä¸­çš„å­—æ®µåŒ¹é…çš„å§”æ‰˜ã€‚å¦‚æœæ‰¾åˆ°åŒ¹é…çš„å§”æ‰˜ï¼Œå¹¶ä¸”ï¼ˆåœ¨åˆ é™¤ä¹‹åï¼‰æ•°ç»„ä¸­åªå‰©ä½™ä¸€ä¸ªæ•°æ®é¡¹ï¼Œå°±è¿”å›é‚£ä¸ªæ•°æ®é¡¹ã€‚å¦‚æœæ‰¾åˆ°åŒ¹é…çš„ä½å›¾å™¢ï¼Œå¹¶ä¸”æ•°ç»„ä¸­è¿˜å‰©ä½™å¤šä¸ªæ•°æ®é¡¹ï¼Œå°±æ–°å»ºä¸€ä¸ªå§”æ‰˜å¯¹è±¡ â€”â€” å…¶ä¸­åˆ›å»ºå¹¶åˆå§‹åŒ–çš„ <code>invocationList</code> æ•°ç»„å°†å¼•ç”¨åŸå§‹æ•°ç»„ä¸­çš„æ‰€æœ‰æ•°æ®é¡¹ï¼Œå½“ç„¶è¢«åˆ é™¤çš„æ•°æ®é¡¹é™¤å¤– â€”â€” å¹¶è¿”å›å¯¹è¿™ä¸ªæ–°å»ºå§”æ‰˜å¯¹è±¡çš„å¼•ç”¨ã€‚å¦‚æœä»é“¾ä¸­åˆ é™¤äº†ä»…æœ‰çš„ä¸€ä¸ªå…ƒç´ ï¼Œ <code>Remove</code> ä¼šè¿”å› nullã€‚æ³¨æ„ï¼Œæ¯æ¬¡ <code>Remove</code> æ–¹æ³•è°ƒç”¨åªèƒ½ä»é“¾ä¸­åˆ é™¤ä¸€ä¸ªå§”æ‰˜ï¼Œå®ƒä¸ä¼šåˆ é™¤æœ‰åŒ¹é…çš„ <code>_target</code> å’Œ <code>_methodPtr</code> å­—æ®µçš„æ‰€æœ‰å§”æ‰˜ã€‚å¦‚æœå§”æ‰˜å­˜åœ¨è¿”å›å€¼ï¼Œåœ¨å§”æ‰˜é“¾çš„è°ƒç”¨è¿‡ç¨‹ä¸­åªåŒ…å«è°ƒç”¨çš„æœ€åä¸€ä¸ªå§”æ‰˜çš„ç»“æœï¼ˆå‰é¢çš„è¿”å›å€¼ä¼šè¢«ä¸¢å¼ƒï¼‰ï¼Œè¯¥å€¼è¿”å›ç»™è°ƒç”¨ <code>Invoke</code> çš„ä»£ç ã€‚è¿™ä¸ªç®€å•çš„ç®—æ³•é¡ºåºè°ƒç”¨é“¾ä¸­çš„æ¯ä¸€ä¸ªå§”æ‰˜ï¼Œæ‰€ä»¥ä¸€ä¸ªå§”æ‰˜å¯¹è±¡å‡ºç°é—®é¢˜ï¼Œé“¾ä¸­åç»­çš„æ‰€æœ‰å¯¹è±¡éƒ½è°ƒç”¨ä¸äº†ã€‚ç”±äºè¿™ä¸ªç®—æ³•æœ‰çš„æ—¶å€™ä¸èƒœå…¶ä»»ï¼Œæ‰€ä»¥ <code>MulticastDelegate</code> ç±»æä¾›äº†ä¸€ä¸ªå®ä¾‹æ–¹æ³• <code>GetInvocationList</code> ï¼Œç”¨äºæ˜¾å¼è°ƒç”¨é“¾ä¸­çš„æ¯ä¸€ä¸ªå§”æ‰˜ï¼Œå¹¶å…è®¸ä½ ä½¿ç”¨éœ€è¦çš„ä»»ä½•ç®—æ³•ã€‚</p><h2 id="enough-with-the-delegate-definitions-already-generic-delegates"><a class="anchor" href="#enough-with-the-delegate-definitions-already-generic-delegates">#</a> Enough with the Delegate Definitions Already (Generic Delegates)</h2><blockquote><p>Many years ago, when the .NET Framework was just starting to be developed, Microsoft introduced the notion of delegates. As programmers were adding classes to the FCL, they would define new delegate types any place they introduced a callback method. Over time, many, many delegates got defined. In fact, in MSCorLib.dll alone, close to 50 delegate types are now defined. Letâ€™s just look at a few of them.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TryCode</span><span class="token punctuation">(</span><span class="token class-name">Object</span> userData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WaitCallback</span><span class="token punctuation">(</span><span class="token class-name">Object</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TimerCallback</span><span class="token punctuation">(</span><span class="token class-name">Object</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ContextCallback</span><span class="token punctuation">(</span><span class="token class-name">Object</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SendOrPostCallback</span><span class="token punctuation">(</span><span class="token class-name">Object</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ParameterizedThreadStart</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Do you notice anything similar about the few delegate definitions that I selected? They are really all the same: a variable of any of these delegate types must refer to a method that takes an Object and returns void. There is really no reason to have all of these delegate types defined; there really just needs to be one.</p></blockquote><blockquote><p>In fact, now that the .NET Framework supports generics, we really just need a few generic delegates (defined in the System namespace) that represent methods that take up to 16 arguments.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// OK, this one is not generic</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">Action</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">T</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">Action</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T1<span class="token punctuation">,</span> T2<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">T1</span> arg1<span class="token punctuation">,</span> <span class="token class-name">T2</span> arg2<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">Action</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T1<span class="token punctuation">,</span> T2<span class="token punctuation">,</span> T3<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">T1</span> arg1<span class="token punctuation">,</span> <span class="token class-name">T2</span> arg2<span class="token punctuation">,</span> <span class="token class-name">T3</span> arg3<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token range operator">..</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">Action</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T1<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> T16<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">T1</span> arg1<span class="token punctuation">,</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token class-name">T16</span> arg16<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>So the .NET Framework now ships with 17 Action delegates that range from having no arguments to having 16 arguments. If you ever need to call a method that has more than 16 arguments, you will be forced to define your own delegate type, but this is very unlikely.</p></blockquote><blockquote><p>In addition to the Action delegates, the .NET Framework ships with 17 Func delegates, which allow the callback method to return a value</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name">TResult</span> <span class="token generic-method"><span class="token function">Func</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name">TResult</span> <span class="token generic-method"><span class="token function">Func</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">T</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name">TResult</span> <span class="token generic-method"><span class="token function">Func</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T1<span class="token punctuation">,</span> T2<span class="token punctuation">,</span> TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">T1</span> arg1<span class="token punctuation">,</span> <span class="token class-name">T2</span> arg2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name">TResult</span> <span class="token generic-method"><span class="token function">Func</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T1<span class="token punctuation">,</span> T2<span class="token punctuation">,</span> T3<span class="token punctuation">,</span> TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">T1</span> arg1<span class="token punctuation">,</span> <span class="token class-name">T2</span> arg2<span class="token punctuation">,</span> <span class="token class-name">T3</span> arg3<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token range operator">..</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name">TResult</span> <span class="token generic-method"><span class="token function">Func</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T1<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> T16<span class="token punctuation">,</span> TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">T1</span> arg1<span class="token punctuation">,</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token class-name">T16</span> arg16<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>It is now recommended that these delegate types be used wherever possible instead of developers defining even more delegate types in their code. This reduces the number of types in the system and also simplifies coding. However, you might have to define your own delegate if you need to pass an argument by reference using the ref or out keyword.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Bar</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">Int32</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>You may also have to do this if you want your delegate to take a variable number of arguments via C#â€™s params keyword, if you want to specify any default values for any of your delegateâ€™s arguments, or if you need to constrain a delegateâ€™s generic type argument.</p></blockquote><blockquote><p>When using delegates that take generic arguments and return values, contra-variance and covariance come into play, and it is recommended that you always take advantage of these features because they have no ill effects and enable your delegates to be used in more scenarios. For more information about this, see the â€œDelegate and Interface Contra-variant and Covariant Generic Type Argumentsâ€ section in Chapter 12, â€œGenerics.â€</p></blockquote><p>ğŸ’¡å°ç»“ï¼š.NET Framework ç°åœ¨æ”¯æŒæ³›å‹ï¼Œæ‰€ä»¥å®é™…åªéœ€å‡ ä¸ªæ³›å‹å§”æ‰˜ï¼ˆåœ¨ <code>System</code> å‘½åç©ºé—´ä¸­å®šä¹‰ï¼‰ã€‚.NET Framework å°±æä¾›äº† 17 ä¸ª <code>Action</code> å§”æ‰˜ï¼Œå®ƒä»¬ä»æ— å‚æ•°åˆ°æœ€å¤š 16 ä¸ªå‚æ•°ã€‚é™¤äº† <code>Action</code> å§”æ‰˜ï¼Œ.NET Framework è¿˜æä¾›äº† 17 ä¸ª <code>Func</code> å‡½æ•°ï¼Œå…è®¸å›è°ƒæ–¹æ³•è¿”å›å€¼ã€‚å»ºè®®å°½é‡ä½¿ç”¨è¿™äº›å§”æ‰˜ç±»å‹ï¼Œè€Œä¸æ˜¯åœ¨ä»£ç ä¸­å®šä¹‰æ›´å¤šçš„å§”æ‰˜ç±»å‹ã€‚è¿™æ ·å¯å‡å°‘ç³»ç»Ÿä¸­çš„ç±»å‹æ•°é‡ï¼ŒåŒæ—¶ç®€åŒ–ç¼–ç ã€‚ç„¶è€Œï¼Œå¦‚éœ€ä½¿ç”¨ ref æˆ– out å…³é”®å­—ä»¥ä¼ å¼•ç”¨çš„æ–¹å¼ä¼ é€’å‚æ•°ï¼Œå°±å¯èƒ½ä¸å¾—ä¸å®šä¹‰è‡ªå·±çš„å§”æ‰˜ã€‚å¦‚æœå§”æ‰˜è¦é€šè¿‡ C# çš„ <code>params</code> å…³é”®å­—è·å–æ•°é‡å¯å˜çš„å‚æ•°ï¼Œè¦ä¸ºå§”æ‰˜çš„ä»»ä½•ç±»å‹æŒ‡å®šé»˜è®¤å€¼ï¼Œæˆ–è€…è¦å¯¹å§”æ‰˜çš„æ³›å‹ç±»å‹å‚æ•°è¿›è¡Œçº¦æŸï¼Œä¹Ÿå¿…é¡»å®šä¹‰è‡ªå·±çš„å§”æ‰˜ç±»å‹ã€‚è·å–æ³›å‹å®å‚å¹¶è¿”å›å€¼çš„å§”æ‰˜æ”¯æŒé€†å˜å’Œåå˜ï¼Œè€Œä¸”å»ºè®®æ€»æ˜¯åˆ©ç”¨è¿™äº›åŠŸèƒ½ï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰å‰¯ä½œç”¨ï¼Œè€Œä¸”ä½¿ä½ çš„å§”æ‰˜é€‚ç”¨äºæ›´å¤šæƒ…å½¢ã€‚</p><h2 id="cs-syntactical-sugar-for-delegates"><a class="anchor" href="#cs-syntactical-sugar-for-delegates">#</a> C#â€™s Syntactical Sugar for Delegates</h2><blockquote><p>Most programmers find working with delegates to be cumbersome because the syntax is so strange. For example, take this line of code.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>button1<span class="token punctuation">.</span>Click <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EventHandler</span><span class="token punctuation">(</span>button1_Click<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>where button1_Click is a method that looks something like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">button1_Click</span><span class="token punctuation">(</span><span class="token class-name">Object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Do something, the button was clicked... </span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The idea behind the first line of code is to register the address of the button1_Click method with a button control so that when the button is clicked, the method will be called. To most programmers, it feels quite unnatural to construct an EventHandler delegate object just to specify the address of the button1_Click method. However, constructing the EventHandler delegate object is required for the CLR because this object provides a wrapper that ensures that the method can be called only in a type-safe fashion. The wrapper also allows the calling of instance methods and chaining. Unfortunately, most programmers donâ€™t want to think about these details. Programmers would prefer to write the preceding code as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>button1<span class="token punctuation">.</span>Click <span class="token operator">+=</span> button1_Click<span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Fortunately, Microsoftâ€™s C# compiler offers programmers some syntax shortcuts when working with delegates. Iâ€™ll explain all of these shortcuts in this section. One last point before we begin: what Iâ€™m about to describe really boils down to C# syntactical sugar; these new syntax shortcuts are really just giving programmers an easier way to produce the IL that must be generated so that the CLR and other programming languages can work with delegates. This also means that what Iâ€™m about to describe is specific to C#; other compilers might not offer the additional delegate syntax shortcuts.</p></blockquote><h3 id="syntactical-shortcut-1-no-need-to-construct-a-delegate-object"><a class="anchor" href="#syntactical-shortcut-1-no-need-to-construct-a-delegate-object">#</a> Syntactical Shortcut #1: No Need to Construct a Delegate Object</h3><blockquote><p>As demonstrated already, C# allows you to specify the name of a callback method without having to construct a delegate object wrapper. Here is another example.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AClass</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CallbackWithoutNewingADelegateObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> ThreadPool<span class="token punctuation">.</span><span class="token function">QueueUserWorkItem</span><span class="token punctuation">(</span>SomeAsyncTask<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeAsyncTask</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Here, the ThreadPool classâ€™s static QueueUserWorkItem method expects a reference to a WaitCallback delegate object that contains a reference to the SomeAsyncTask method. Because the C# compiler is capable of inferring this on its own, it allows me to omit code that constructs the WaitCallback delegate object, making the code much more readable and understandable. Of course, when the code is compiled, the C# compiler does produce IL that does, in fact, new up the WaitCallback delegate objectâ€”we just got a syntactical shortcut.</p></blockquote><h3 id="syntactical-shortcut-2-no-need-to-define-a-callback-method-lambda-expressions"><a class="anchor" href="#syntactical-shortcut-2-no-need-to-define-a-callback-method-lambda-expressions">#</a> Syntactical Shortcut #2: No Need to Define a Callback Method (Lambda Expressions)</h3><blockquote><p>In the preceding code, the name of the callback method, SomeAsyncTask, is passed to the ThreadPoolâ€™s QueueUserWorkItem method. C# allows you to write the code for the callback method inline so it doesnâ€™t have to be written inside its very own method. For example, the preceding code could be rewritten as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AClass</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CallbackWithoutNewingADelegateObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> ThreadPool<span class="token punctuation">.</span><span class="token function">QueueUserWorkItem</span><span class="token punctuation">(</span> obj <span class="token operator">=></span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Notice that the first â€œargumentâ€ to the QueueUserWorkItem method is code (which I italicized)! More formally, the italicized code is called a C# lambda expression, and it is easy to detect due to the use of C#'s lambda expression operator: =&gt;. You may use a lambda expression in your code where the compiler would normally expect to see a delegate. And, when the compiler sees the use of this lambda expression, the compiler automatically defines a new private method in the class (AClass, in this example). This new method is called an anonymous function because the compiler creates the name of the method for you automatically, and normally, you wouldnâ€™t know its name. However, you could use a tool such as ILDasm.exe to examine the compiler-generated code. After I wrote the preceding code and compiled it, I was able to see, by using ILDasm.exe, that the C# compiler decided to name this method b__0 and ensured that this method took a single Object argument and returned void.</p></blockquote><blockquote><p>The compiler chose to start the method name with a &lt; sign because in C#, an identifier cannot contain a &lt; sign; this ensures that you will not accidentally define a method that coincides with the name the compiler has chosen for you. Incidentally, while C# forbids identifiers to contain a &lt; sign, the CLR allows it, and that is why this works. Also, note that although you could access the method via reflection by passing the method name as a string, the C# language specification states that there is no guarantee of how the compiler generates the name. For example, each time you compile the code, the compiler could produce a different name for the method.</p></blockquote><blockquote><p>Using ILDasm.exe, you might also notice that the C# compiler applies the System.Runtime. CompilerServices.CompilerGeneratedAttribute attribute to this method to indicate to various tools and utilities that this method was produced by a compiler as opposed to a programmer. The code to the right of the =&gt; operator is then placed in this compiler-generated method.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šå†™ lambda è¡¨è¾¾å¼æ—¶æ²¡æœ‰åŠæ³•å‘ç¼–è¯‘å™¨ç”Ÿæˆçš„æ–¹æ³•åº”ç”¨å®šåˆ¶ç‰¹æ€§ã€‚æ­¤å¤–ï¼Œä¸èƒ½å‘æ–¹æ³•åº”ç”¨ä»»ä½•æ–¹æ³•ä¿®é¥°ç¬¦ (æ¯”å¦‚ <code>unsafe</code> )ã€‚ä½†è¿™ä¸€èˆ¬ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸ºç¼–è¯‘å™¨ç”Ÿæˆçš„åŒ¿åå‡½æ•°æ€»æ˜¯ç§æœ‰æ–¹æ³•ï¼Œè€Œä¸”æ–¹æ³•è¦ä¹ˆæ˜¯é™æ€çš„ï¼Œè¦ä¹ˆæ˜¯éé™æ€çš„ï¼Œå…·ä½“å–å†³äºæ–¹æ³•æ˜¯å¦è®¿é—®äº†ä»»ä½•å®ä¾‹æˆå‘˜ã€‚æ‰€ä»¥ï¼Œæ²¡å¿…è¦å‘æ–¹æ³•åº”ç”¨ <code>public</code> ï¼Œ <code>protected</code> ï¼Œ <code>internal</code> ï¼Œ <code>virtual</code> ï¼Œ <code>sealed</code> ï¼Œ <code>override</code> æˆ– <code>abstract</code> ä¹‹ç±»çš„ä¿®é¥°ç¬¦ã€‚</p><blockquote><p>Finally, if you write the preceding code and compile it, itâ€™s as if the C# compiler rewrote your code to look like the following (comments inserted by me).</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AClass</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// This private field is created to cache the delegate object. </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Pro: CallbackWithoutNewingADelegateObject will not create </span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// a new object each time it is called. </span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Con: The cached object never gets garbage collected </span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">[</span>CompilerGenerated<span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> WaitCallback <span class="token operator">&lt;</span><span class="token operator">></span>9__CachedAnonymousMethodDelegate1<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CallbackWithoutNewingADelegateObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token operator">></span>9__CachedAnonymousMethodDelegate1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// First time called, create the delegate object and cache it. </span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token operator">&lt;</span><span class="token operator">></span>9__CachedAnonymousMethodDelegate1 <span class="token operator">=</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitCallback</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>CallbackWithoutNewingADelegateObject<span class="token operator">></span>b__0<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre> ThreadPool<span class="token punctuation">.</span><span class="token function">QueueUserWorkItem</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token operator">></span>9__CachedAnonymousMethodDelegate1<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CompilerGenerated</span></span><span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">&lt;</span>CallbackWithoutNewingADelegateObject<span class="token operator">></span><span class="token function">b__0</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The lambda expression must match that of the WaitCallback delegate: it returns void and takes an Object parameter. However, I specified the name of the parameter by simply putting obj to the left of the =&gt; operator. On the right of the =&gt; operator, Console.WriteLine happens to return void. However, if I had placed an expression that did not return void, the compiler-generated code would just ignore the return value because the method that the compiler generates must have a void return type to satisfy the WaitCallback delegate.</p></blockquote><blockquote><p>It is also worth noting that the anonymous function is marked as private; this forbids any code not defined within the type from accessing the method (although reflection will reveal that the method does exist). Also, note that the anonymous method is marked as static; this is because the code doesnâ€™t access any instance members (which it canâ€™t because CallbackWithoutNewingADelegateObject is itself a static method. However, the code can reference any static fields or static methods defined within the class. Here is an example.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AClass</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> sm_name<span class="token punctuation">;</span> <span class="token comment">// A static field </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CallbackWithoutNewingADelegateObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> ThreadPool<span class="token punctuation">.</span><span class="token function">QueueUserWorkItem</span><span class="token punctuation">(</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// The callback code can reference static members. </span></pre></td></tr><tr><td data-num="6"></td><td><pre> obj <span class="token operator">=></span>Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>sm_name <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> obj<span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If the CallbackWithoutNewingADelegateObject method had not been static, the anonymous methodâ€™s code could contain references to instance members. If it doesnâ€™t contain references to instance members, the compiler will still produce a static anonymous method because this is more efficient than an instance method because the additional this parameter is not necessary. But, if the anonymous methodâ€™s code does reference an instance member, the compiler will produce a nonstatic anonymous method.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AClass</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">String</span> m_name<span class="token punctuation">;</span> <span class="token comment">// An instance field </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// An instance method </span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CallbackWithoutNewingADelegateObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> ThreadPool<span class="token punctuation">.</span><span class="token function">QueueUserWorkItem</span><span class="token punctuation">(</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// The callback code can reference instance members. </span></pre></td></tr><tr><td data-num="7"></td><td><pre> obj <span class="token operator">=></span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>m_name <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> obj<span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>On the left side of the =&gt; operator is where you specify the names of any arguments that are to be passed to the lambda expression. There are some rules you must follow here. See the following examples.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// If the delegate takes no arguments, use ()</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Func<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span></span> f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"Jeff"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// If the delegate takes 1+ arguments, you can explicitly specify the types</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">Func<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> f2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> n<span class="token punctuation">)</span> <span class="token operator">=></span> n<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token class-name">Func<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">,</span> Int32<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> f3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> n1<span class="token punctuation">,</span> <span class="token class-name">Int32</span> n2<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>n1 <span class="token operator">+</span> n2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// If the delegate takes 1+ arguments, the compiler can infer the types</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token class-name">Func<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> f4 <span class="token operator">=</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=></span> n<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token class-name">Func<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">,</span> Int32<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> f5 <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>n1 <span class="token operator">+</span> n2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// If the delegate takes 1 argument, you can omit the ()s</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token class-name">Func<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> f6 <span class="token operator">=</span> n <span class="token operator">=></span> n<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// If the delegate has ref/out arguments, you must explicitly specify ref/out and the type</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token class-name">Bar</span> b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">Int32</span> n<span class="token punctuation">)</span> <span class="token operator">=></span> n <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>For the last example, assume that Bar is defined as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Bar</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">Int32</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>On the right side of the =&gt; operator is where you specify the anonymous function body. It is very common for the body to consist of a simple or complex expression that ultimately returns a nonvoid value. In the preceding code, I was assigning lambda expressions that returned Strings to all the Func delegate variables. It is also quite common for the body to consist of a single statement. An example of this is when I called ThreadPool.QueueUserWorkItem, passing it a lambda expression that called Console.WriteLine (which returns void).</p></blockquote><blockquote><p>If you want the body to consist of two or more statements, then you must enclose it in curly braces. And if the delegate expects a return value, then you must have a return statement inside the body. Here is an example.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Func<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">,</span> Int32<span class="token punctuation">,</span> String<span class="token punctuation">></span></span> f7 <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token class-name">Int32</span> sum <span class="token operator">=</span> n1 <span class="token operator">+</span> n2<span class="token punctuation">;</span> <span class="token keyword">return</span> sum<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>ğŸ’¡é‡è¦æç¤ºï¼šlambda è¡¨è¾¾å¼çš„ä¸»è¦ä¼˜åŠ¿åœ¨äºï¼Œå®ƒä»ä½ çš„æºä»£ç ä¸­ç§»é™¤äº†ä¸€ä¸ª â€œé—´æ¥å±‚â€(a level of indirection)ï¼Œæˆ–è€…è¯´é¿å…äº†è¿‚å›ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¿…é¡»å†™ä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•ï¼Œå‘½åè¯¥æ–¹æ³•ï¼Œå†åœ¨éœ€è¦å§”æ‰˜çš„åœ°æ–¹ä¼ é€’è¿™ä¸ªæ–¹æ³•åã€‚æ–¹æ³•åæä¾›äº†å¼•ç”¨ä»£ç ä¸»ä½“çš„ä¸€ç§æ–¹å¼ï¼Œå¦‚æœè¦åœ¨å¤šä¸ªåœ°æ–¹å¼•ç”¨åŒä¸€ä¸ªä»£ç ä¸»ä½“ï¼Œå•ç‹¬å†™ä¸€ä¸ªæ–¹æ³•å¹¶å‘½åç¡®å®æ˜¯ç†æƒ³çš„æ–¹æ¡ˆã€‚ä½†å¦‚æœåªéœ€åœ¨ä»£ç ä¸­å¼•ç”¨è¿™ä¸ªä¸»ä½“ä¸€æ¬¡ï¼Œé‚£ä¹ˆ lambda è¡¨è¾¾å¼å…è®¸ç›´æ¥å†…è”é‚£äº›ä»£ç ï¼Œä¸å¿…ä¸ºå®ƒåˆ†é…åç§°ï¼Œä»è€Œæé«˜äº†ç¼–ç¨‹æ•ˆç‡ã€‚</p><p>ğŸ’¡æ³¨æ„ï¼šC# 2.0 é—®ä¸–æ—¶å¼•å…¥äº†ä¸€ä¸ªç§°ä¸ºåŒ¿åæ–¹æ³•çš„åŠŸèƒ½ã€‚å’Œ C# 3.0 å¼•å…¥çš„ lambda è¡¨è¾¾å¼ç›¸ä¼¼ï¼ŒåŒ¿åæ–¹æ³•æè¿°çš„ä¹Ÿæ˜¯åˆ›å»ºåŒ¿åå‡½æ•°çš„è¯­æ³•ã€‚æ–°è§„èŒƒ (C# è¯­è¨€è§„èŒƒ 7.14 èŠ‚) å»ºè®®å¼€å‘äººå‘˜ä½¿ç”¨æ–°çš„ lambda è¡¨è¾¾å¼è¯­æ³•ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æ—§çš„åŒ¿åæ–¹æ³•è¯­æ³•ï¼Œå› ä¸º lambda è¡¨è¾¾å¼è¯­æ³•æ›´ç®€æ´ï¼Œä»£ç æ›´å®¹æ˜“å†™ã€è¯»å’Œç»´æŠ¤ã€‚å½“ç„¶ï¼ŒMicrosoft C# ç¼–è¯‘å™¨ä»ç„¶æ”¯æŒç”¨è¿™ä¸¤ç§è¯­æ³•åˆ›å»ºåŒ¿åå‡½æ•°ï¼Œä»¥å…¼å®¹å½“å¹´ä¸º C# 2.0 å†™çš„ä»£ç ã€‚åœ¨æœ¬ä¹¦ä¸­ï¼Œæˆ‘åªè§£é‡Šå¹¶ä½¿ç”¨ lambda è¡¨è¾¾å¼è¯­æ³•ã€‚</p><h3 id="syntactical-shortcut-3-no-need-to-wrap-local-variables-in-a-class-manually-to-pass-them-to-a-callback-method"><a class="anchor" href="#syntactical-shortcut-3-no-need-to-wrap-local-variables-in-a-class-manually-to-pass-them-to-a-callback-method">#</a> Syntactical Shortcut #3: No Need to Wrap Local Variables in a Class Manually to Pass Them to a Callback Method</h3><blockquote><p>Iâ€™ve already shown how the callback code can reference other members defined in the class. However, sometimes, you might like the callback code to reference local parameters or variables that exist in the defining method. Hereâ€™s an interesting example.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AClass</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UsingLocalVariablesInTheCallbackCode</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> numToDo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Some local variables </span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> squares <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32</span><span class="token punctuation">[</span>numToDo<span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token class-name">AutoResetEvent</span> done <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoResetEvent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Do a bunch of tasks on other threads </span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> squares<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> ThreadPool<span class="token punctuation">.</span><span class="token function">QueueUserWorkItem</span><span class="token punctuation">(</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> obj <span class="token operator">=></span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token class-name">Int32</span> num <span class="token operator">=</span> <span class="token punctuation">(</span>Int32<span class="token punctuation">)</span> obj<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// This task would normally be more time consuming </span></pre></td></tr><tr><td data-num="12"></td><td><pre> squares<span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token operator">=</span> num <span class="token operator">*</span> num<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> </pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// If last task, let main thread continue running </span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>Interlocked<span class="token punctuation">.</span><span class="token function">Decrement</span><span class="token punctuation">(</span><span class="token keyword">ref</span> numToDo<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> done<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="18"></td><td><pre> n<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// Wait for all the other threads to finish </span></pre></td></tr><tr><td data-num="21"></td><td><pre> done<span class="token punctuation">.</span><span class="token function">WaitOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token comment">// Show the results </span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> squares<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="24"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Index &#123;0&#125;, Square=&#123;1&#125;"</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> squares<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>This example really shows off how easy C# makes implementing what used to be a pretty complex task. The preceding method defines one parameter, numToDo, and two local variables, squares and done. And the body of the lambda expression refers to these variables.</p></blockquote><blockquote><p>Now imagine that the code in the body of the lambda expression is placed in a separate method (as is required by the CLR). How would the values of the variables be passed to the separate method? The only way to do this is to define a new helper class that also defines a field for each value that you want passed to the callback code. In addition, the callback code would have to be defined as an instance method in this helper class. Then, the UsingLocalVariablesInTheCallbackCode method would have to construct an instance of the helper class, initialize the fields from the values in its local variables, and then construct the delegate object bound to the helper object/instance method.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šå½“ lambda è¡¨è¾¾å¼é€ æˆç¼–è¯‘å™¨ç”Ÿæˆä¸€ä¸ªç±»ï¼Œè€Œä¸”å‚æ•° / å±€éƒ¨å˜é‡è¢«è½¬å˜æˆè¯¥ç±»çš„å­—æ®µåï¼Œå˜é‡å¼•ç”¨çš„å¯¹è±¡çš„ç”Ÿå­˜æœŸè¢«å»¶é•¿äº†ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œåœ¨æ–¹æ³•æ‰¾ä¸­æœ€åä¸€æ¬¡ä½¿ç”¨ / å±€éƒ¨å˜é‡ä¹‹åï¼Œè¿™ä¸ªå‚æ•° / å±€éƒ¨å˜é‡å°±ä¼š â€œç¦»å¼€ä½œç”¨åŸŸâ€ï¼Œç»“æŸå…¶ç”Ÿå‘½æœŸã€‚ä½†æ˜¯ï¼Œå°†å˜é‡è½¬å˜æˆå­—æ®µåï¼Œåªè¦åŒ…å«å­—æ®µçš„é‚£ä¸ªå¯¹è±¡ä¸ â€œæ­»â€ï¼Œå­—æ®µå¼•ç”¨çš„å¯¹è±¡ä¹Ÿä¸ä¼š â€œæ­»â€ã€‚è¿™åœ¨å¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸­ä¸æ˜¯å¤§é—®é¢˜ï¼Œä½†æœ‰æ—¶è¦æ³¨æ„ä¸€ä¸‹ã€‚</p><blockquote><p>This is very tedious and error-prone work, and, of course, the C# compiler does all this for you automatically. When you write the preceding code, itâ€™s as if the C# compiler rewrites your code so that it looks something like the following (comments inserted by me).</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AClass</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UsingLocalVariablesInTheCallbackCode</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> numToDo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Some local variables </span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name">WaitCallback</span> callback1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Construct an instance of the helper class </span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token operator">&lt;</span><span class="token operator">></span><span class="token class-name">c__DisplayClass2</span> class1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token operator">&lt;</span><span class="token operator">></span><span class="token function">c__DisplayClass2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// Initialize the helper class's fields </span></pre></td></tr><tr><td data-num="8"></td><td><pre> class1<span class="token punctuation">.</span>numToDo <span class="token operator">=</span> numToDo<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> class1<span class="token punctuation">.</span>squares <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32</span><span class="token punctuation">[</span>class1<span class="token punctuation">.</span>numToDo<span class="token punctuation">]</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> class1<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoResetEvent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// Do a bunch of tasks on other threads </span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> class1<span class="token punctuation">.</span>squares<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>callback1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// New up delegate object bound to the helper object and </span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token comment">// its anonymous instance method </span></pre></td></tr><tr><td data-num="16"></td><td><pre> callback1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitCallback</span><span class="token punctuation">(</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> class1<span class="token punctuation">.</span><span class="token operator">&lt;</span>UsingLocalVariablesInTheCallbackCode<span class="token operator">></span>b__0<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="19"></td><td><pre> ThreadPool<span class="token punctuation">.</span><span class="token function">QueueUserWorkItem</span><span class="token punctuation">(</span>callback1<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token comment">// Wait for all the other threads to finish </span></pre></td></tr><tr><td data-num="22"></td><td><pre> class1<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">WaitOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token comment">// Show the results </span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> class1<span class="token punctuation">.</span>squares<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="25"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Index &#123;0&#125;, Square=&#123;1&#125;"</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> class1<span class="token punctuation">.</span>squares<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token comment">// The helper class is given a strange name to avoid potential </span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">// conflicts and is private to forbid access from outside AClass </span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token punctuation">[</span>CompilerGenerated<span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token operator">&lt;</span><span class="token operator">></span>c__DisplayClass2 <span class="token punctuation">:</span> Object <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">// One public field per local variable used in the callback code </span></pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token keyword">public</span> <span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> squares<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token keyword">public</span> <span class="token class-name">Int32</span> numToDo<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token keyword">public</span> <span class="token class-name">AutoResetEvent</span> done<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token comment">// public parameterless constructor </span></pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token keyword">public</span> <span class="token operator">&lt;</span><span class="token operator">></span>c__DisplayClass2 <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token comment">// Public instance method containing the callback code </span></pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token operator">&lt;</span>UsingLocalVariablesInTheCallbackCode<span class="token operator">></span><span class="token function">b__0</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token class-name">Int32</span> num <span class="token operator">=</span> <span class="token punctuation">(</span>Int32<span class="token punctuation">)</span> obj<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="40"></td><td><pre> squares<span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token operator">=</span> num <span class="token operator">*</span> num<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="41"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>Interlocked<span class="token punctuation">.</span><span class="token function">Decrement</span><span class="token punctuation">(</span><span class="token keyword">ref</span> numToDo<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="42"></td><td><pre> done<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>ğŸ’¡é‡è¦æç¤º æ¯«æ— ç–‘é—®ï¼ŒC# çš„ lambda è¡¨è¾¾å¼åŠŸèƒ½å¾ˆå®¹æ˜“è¢«ç¨‹åºå‘˜æ»¥ç”¨ã€‚æˆ‘å¼€å§‹ä½¿ç”¨ lambda è¡¨è¾¾å¼æ—¶ï¼Œç»å¯¹æ˜¯èŠ±äº†ä¸€äº›æ—¶é—´æ¥ç†Ÿæ‚‰å®ƒçš„ã€‚æ¯•ç«Ÿï¼Œä½ åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­å†™çš„ä»£ç å®é™…ä¸åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ã€‚é™¤äº†æœ‰è¿ç›´è§‰ï¼Œè¿˜ä½¿è°ƒè¯•å’Œå•æ­¥æ‰§è¡Œå˜å¾—æ¯”è¾ƒæœ‰æŒ‘æˆ˜æ€§ã€‚ä½†äº‹å®ä¸Šï¼ŒVisual Studio è°ƒè¯•å™¨è¿˜æ˜¯éå¸¸ä¸é”™çš„ã€‚æˆ‘å¯¹è‡ªå·±æºä»£ç ä¸­çš„ lambda è¡¨è¾¾å¼è¿›è¡Œå•æ­¥æµ‹è¯•æ—¶ï¼Œå®ƒå¤„ç†å¾—ç›¸å½“å¥½ã€‚</p><p>æˆ‘ä¸ºè‡ªå·±è®¾å®šäº†ä¸€ä¸ªè§„åˆ™ï¼šå¦‚æœéœ€è¦åœ¨å›åˆ°æ–¹æ³•ä¸­åŒ…å« 3 è¡Œä»¥ä¸Šçš„ä»£ç ï¼Œå°±ä¸ä½¿ç”¨ lambda è¡¨è¾¾å¼ã€‚ç›¸åï¼Œæˆ‘ä¼šæ‰‹åŠ¨å†™ä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸ºå…¶åˆ†é…è‡ªå·±çš„åç§°ã€‚ä½†å¦‚æœä½¿ç”¨å¾—å½“ï¼ŒåŒ¿åæ–¹æ³•ç¡®å®èƒ½æ˜¾è‘—æé«˜å¼€å‘äººå‘˜çš„æ•ˆç‡å’Œä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚åœ¨ä»¥ä¸‹ä»£ç ä¸­ï¼Œä½¿ç”¨ lambda è¡¨è¾¾å¼æ„Ÿè§‰éå¸¸è‡ªç„¶ã€‚æ²¡æœ‰å®ƒä»¬ï¼Œè¿™æ ·çš„ä»£ç ä¼šå¾ˆéš¾å†™ã€è¯»å’Œç»´æŠ¤ã€‚</p><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Create and initialize a String array </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">String<span class="token punctuation">[</span><span class="token punctuation">]</span></span> names <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">"Jeff"</span><span class="token punctuation">,</span> <span class="token string">"Kristin"</span><span class="token punctuation">,</span> <span class="token string">"Aidan"</span><span class="token punctuation">,</span> <span class="token string">"Grant"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// Get just the names that have a lowercase 'a' in them. </span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">Char</span> charToFind <span class="token operator">=</span> <span class="token char">'a'</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>names <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">FindAll</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> name <span class="token operator">=></span> name<span class="token punctuation">.</span><span class="token function">IndexOf</span><span class="token punctuation">(</span>charToFind<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// Convert each string's characters to uppercase </span></pre></td></tr><tr><td data-num="7"></td><td><pre>names <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">ConvertAll</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> name <span class="token operator">=></span> name<span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">// Display the results </span></pre></td></tr><tr><td data-num="9"></td><td><pre>Array<span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> Console<span class="token punctuation">.</span>WriteLine<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>ğŸ’¡å°ç»“ï¼šMicrosoft C# ç¼–è¯‘å™¨ä¸ºç¨‹åºå‘˜æä¾›äº†ç”¨äºå¤„ç†å§”æ‰˜çš„ä¸€äº›ç®€åŒ–è¯­æ³•ã€‚è¿™äº›åŸºæœ¬ä¸Šåªæ˜¯ C# çš„è¯­æ³•ç³–ï¼Œè¿™äº›ç®€åŒ–è¯­æ³•ä¸ºç¨‹åºå‘˜æä¾›äº†ä¸€ç§æ›´ç®€å•çš„æ–¹å¼ç”Ÿæˆ CLR å’Œå…¶ä»–ç¼–ç¨‹è¯­è¨€å¤„ç†å§”æ‰˜æ—¶æ‰€å¿…éœ€çš„ IL ä»£ç ã€‚ç®€åŒ–è¯­æ³• 1ï¼šC# å…è®¸æŒ‡å®šå›è°ƒæ–¹æ³•çš„åç§°ï¼Œä¸å¿…å»æ„é€ å§”æ‰˜å¯¹è±¡åŒ…è£…å™¨ï¼Œç¼–è¯‘å™¨èƒ½è‡ªå·±è¿›è¡Œæ¨æ–­ï¼Œä½¿ä»£ç çš„å¯è¯»æ€§æ›´ä½³ï¼Œä¹Ÿæ›´å®¹æ˜“ç†è§£ã€‚ç®€æ˜“è¯­æ³• 2ï¼šä¸éœ€è¦å®šä¹‰å›è°ƒæ–¹æ³•ï¼ˆlambda è¡¨è¾¾å¼ï¼‰ã€‚ç¼–è¯‘å™¨çœ‹åˆ° lambda è¡¨è¾¾å¼ä¹‹åï¼Œä¼šåœ¨ç±»ä¸­è‡ªåŠ¨å®šä¹‰ä¸€ä¸ªæ–°çš„ç§æœ‰æ–¹æ³•ã€‚è¿™ä¸ªæ–°æ–¹æ³•ç§°ä¸ºåŒ¿åå‡½æ•°ï¼Œå› ä¸ºæ–¹æ³•åç§°ç”±ç¼–è¯‘å™¨è‡ªåŠ¨åˆ›å»ºï¼Œè€Œä¸”ä½ ä¸€èˆ¬ä¸çŸ¥é“è¿™ä¸ªåç§°ã€‚ç¼–è¯‘å™¨é€‰æ‹©çš„æ–¹æ³•åä»¥ &lt; ç¬¦å·å¼€å¤´ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ C# ä¸­ï¼Œæ ‡è¯†ç¬¦æ˜¯ä¸èƒ½åŒ…å« &lt; ç¬¦å·çš„ï¼›è¿™å°±ç¡®ä¿äº†ä½ ä¸ä¼šç¢°å·§å®šä¹‰ä¸€ä¸ªç¼–è¯‘å™¨è‡ªåŠ¨é€‰æ‹©çš„åç§°ã€‚è™½ç„¶ C# ç¦æ­¢æ ‡è¯†ç¬¦åŒ…å« &lt; ç¬¦å·ï¼Œä½† CLR å…è®¸ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆä¸ä¼šå‡ºé”™çš„åŸå› ã€‚è™½ç„¶å¯å°†æ–¹æ³•åä½œä¸ºå­—ç¬¦ä¸²æ¥ä¼ é€’ï¼Œé€šè¿‡åå°„æ¥è®¿é—®æ–¹æ³•ï¼Œä½† C# è¯­è¨€è§„èŒƒæŒ‡å‡ºï¼Œç¼–è¯‘å™¨ç”Ÿæˆåç§°çš„æ–¹å¼æ˜¯æ²¡æœ‰ä»»ä½•ä¿è¯çš„ã€‚ä¾‹å¦‚ï¼Œæ¯æ¬¡ç¼–è¯‘ä»£ç ï¼Œç¼–è¯‘å™¨éƒ½å¯èƒ½ä¸ºæ–¹æ³•ç”Ÿæˆä¸€ä¸ªä¸åŒçš„åç§°ã€‚ç¼–è¯‘å™¨å‘æ–¹æ³•åº”ç”¨äº† <code>System.Runtime.CompilerServices.CompilerGeneratedAttribute</code> ç‰¹æ€§ï¼ŒæŒ‡å‡ºè¯¥æ–¹æ³•ç”±ç¼–è¯‘å™¨ç”Ÿæˆï¼Œè€Œéç¨‹åºå‘˜å†™çš„ã€‚=&gt; æ“ä½œç¬¦å³ä¾§çš„ä»£ç è¢«æ”¾å…¥ç¼–è¯‘å™¨ç”Ÿæˆçš„æ–¹æ³•ä¸­ã€‚å¦å¤–è¿˜è¦æ³¨æ„ï¼ŒåŒ¿åå‡½æ•°è¢«æ ‡è®°ä¸º <code>private</code> ï¼Œç¦æ­¢éç±»å‹å†…å®šä¹‰çš„ä»£ç è®¿é—®ï¼ˆå°½ç®¡åå°„èƒ½æ­ç¤ºå‡ºæ–¹æ³•ç¡®å®å­˜åœ¨ï¼‰ã€‚å¦å¤–ï¼ŒåŒ¿åå‡½æ•°å¦‚æœæ²¡æœ‰è®¿é—®ä»»ä½•å®ä¾‹æˆå‘˜ä¼šè¢«æ ‡è®°ä¸º <code>static</code> ï¼Œå› ä¸ºå®ƒçš„æ•ˆç‡æ¯”å®ä¾‹æ–¹æ³•é«˜ã€‚ä¹‹æ‰€ä»¥æ›´é«˜æ•ˆï¼Œæ˜¯å› ä¸ºä¸éœ€è¦é¢å¤–çš„ this å‚æ•°ã€‚ä½†æ˜¯ï¼Œå¦‚æœåŒ¿åå‡½æ•°çš„ä»£ç ç¡®å®å¼•ç”¨äº†å®ä¾‹æˆå‘˜ï¼Œç¼–è¯‘å™¨å°±ä¼šç”Ÿæˆéé™æ€åŒ¿åå‡½æ•°ã€‚=&gt; æ“ä½œç¬¦å³ä¾§ä¾›æŒ‡å®šåŒ¿åå‡½æ•°ä¸»ä½“ï¼Œå¦‚æœä¸»ä½“ç”±ä¸¤ä¸ªæˆ–å¤šä¸ªè¯­å¥æ„æˆï¼Œå¿…é¡»ç”¨å¤§æ‹¬å·å°†è¯­å¥å°é—­ã€‚åœ¨ç”¨äº†å¤§æ‹¬å·çš„æƒ…å†µä¸‹ï¼Œå¦‚æœå§”æ‰˜æœŸå¾…è¿”å›å€¼ï¼Œè¿˜å¿…é¡»åœ¨ä¸»ä½“ä¸­æ·»åŠ  return è¯­å¥ã€‚ç®€åŒ–è¯­æ³• 3ï¼šå±€éƒ¨å˜é‡ä¸éœ€è¦æ‰‹åŠ¨åŒ…è£…åˆ°ç±»ä¸­å³å¯ä¼ ç»™å›è°ƒæ–¹æ³•ã€‚Lambda è¡¨è¾¾å¼æ‰€å¼•ç”¨çš„å¤–éƒ¨å˜é‡ç§°ä¸ºæ•è·å˜é‡ã€‚å«æœ‰æ•è·å˜é‡çš„è¡¨è¾¾å¼ç§°ä¸ºé—­åŒ…ã€‚æ•è·å˜é‡ä¼šåœ¨çœŸæ­£è°ƒç”¨å§”æ‰˜æ—¶èµ‹å€¼ï¼Œè€Œä¸æ˜¯åœ¨æ•è·æ—¶èµ‹å€¼ã€‚æ•è·å˜é‡çš„ç”Ÿå‘½å‘¨æœŸå»¶ä¼¸åˆ°äº†å’Œå§”æ‰˜çš„å£°æ˜å‘¨æœŸä¸€è‡´ã€‚</p><h2 id="delegates-and-reflection"><a class="anchor" href="#delegates-and-reflection">#</a> Delegates and Reflection</h2><blockquote><p>So far in this chapter, the use of delegates has required the developer to know up front the prototype of the method that is to be called back. For example, if fb is a variable that references a Feedback delegate (see this chapterâ€™s first program listing), to invoke the delegate, the code would look like the following.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">fb</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// item is defined as Int32</span></pre></td></tr></table></figure><blockquote><p>As you can see, the developer must know when coding how many parameters the callback method requires and the types of those parameters. Fortunately, the developer almost always has this information, so writing code like the preceding code isnâ€™t a problem.</p></blockquote><blockquote><p>In some rare circumstances, however, the developer doesnâ€™t have this information at compile time. I showed an example of this in Chapter 11, â€œEvents,â€ when I discussed the EventSet type. In this example, a dictionary maintained a set of different delegate types. At run time, to raise an event, one of the delegates was looked up in the dictionary and invoked. At compile time, it wasnâ€™t possible to know exactly which delegate would be called and which parameters were necessary to pass to the delegateâ€™s callback method.</p></blockquote><blockquote><p>Fortunately, System.Reflection.MethodInfo offers a CreateDelegate method that allows you to create a delegate when you just donâ€™t have all the necessary information about the delegate at compile time. Here are the method overloads that MethodInfo defines.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MethodInfo</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MethodBase</span></span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Construct a delegate wrapping a static method. </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Delegate</span> <span class="token function">CreateDelegate</span><span class="token punctuation">(</span><span class="token class-name">Type</span> delegateType<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Construct a delegate wrapping an instance method; target refers to the â€˜thisâ€™ argument. </span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Delegate</span> <span class="token function">CreateDelegate</span><span class="token punctuation">(</span><span class="token class-name">Type</span> delegateType<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>After youâ€™ve created the delegate, you can call it by using Delegateâ€™s DynamicInvoke method, which looks like the following.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Delegate</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Invoke a delegate passing it parameters </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Object</span> <span class="token function">DynamicInvoke</span><span class="token punctuation">(</span><span class="token keyword">params</span> <span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Using reflection APIs (discussed in Chapter 23, â€œAssembly Loading and Reflectionâ€), you must first acquire a MethodInfo object referring to the method you want to create a delegate to. Then, you call the CreateDelegate method to have it construct a new object of a Delegate-derived type identified by the first parameter, delegateType. If the delegate wraps an instance method, you will also pass to CreateDelegate a target parameter indicating the object that should be passed as the this parameter to the instance method.</p></blockquote><blockquote><p>System.Delegateâ€™s DynamicInvoke method allows you to invoke a delegate objectâ€™s callback method, passing a set of parameters that you determine at run time. When you call DynamicInvoke, it internally ensures that the parameters you pass are compatible with the parameters the callback method expects. If theyâ€™re compatible, the callback method is called. If theyâ€™re not, an ArgumentException is thrown. DynamicInvoke returns the object the callback method returned.</p></blockquote><blockquote><p>The following code shows how to use the CreateDelegate and DynamicInvoke methods.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// Here are some different delegate definitions </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">delegate</span> <span class="token return-type class-name">Object</span> <span class="token function">TwoInt32s</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> n1<span class="token punctuation">,</span> <span class="token class-name">Int32</span> n2<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">delegate</span> <span class="token return-type class-name">Object</span> <span class="token function">OneString</span><span class="token punctuation">(</span><span class="token class-name">String</span> s1<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DelegateReflection</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name">String<span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>Length <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token class-name">String</span> usage <span class="token operator">=</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token string">@"Usage:"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token string">"&#123;0&#125; delType methodName [Arg1] [Arg2]"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token string">"&#123;0&#125; where delType must be TwoInt32s or OneString"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token string">"&#123;0&#125; if delType is TwoInt32s, methodName must be Add or Subtract"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token string">"&#123;0&#125; if delType is OneString, methodName must be NumChars or Reverse"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token string">"&#123;0&#125;"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token string">"&#123;0&#125;Examples:"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token string">"&#123;0&#125; TwoInt32s Add 123 321"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token string">"&#123;0&#125; TwoInt32s Subtract 123 321"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token string">"&#123;0&#125; OneString NumChars \"Hello there\""</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token string">"&#123;0&#125; OneString Reverse \"Hello there\""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>usage<span class="token punctuation">,</span> Environment<span class="token punctuation">.</span>NewLine<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token comment">// Convert the delType argument to a delegate type</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token class-name">Type</span> delType <span class="token operator">=</span> Type<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>delType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Invalid delType argument: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token class-name">Delegate</span> d<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token comment">// Convert the Arg1 argument to a method</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token class-name">MethodInfo</span> mi <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">DelegateReflection</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredMethod</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token comment">// Create a delegate object that wraps the static method</span></pre></td></tr><tr><td data-num="36"></td><td><pre> d <span class="token operator">=</span> mi<span class="token punctuation">.</span><span class="token function">CreateDelegate</span><span class="token punctuation">(</span>delType<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgumentException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Invalid methodName argument: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre> <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token comment">// Create an array that that will contain just the arguments</span></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token comment">// to pass to the method via the delegate object</span></pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> callbackArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object</span><span class="token punctuation">[</span>args<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TwoInt32s</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token comment">// Convert the String arguments to Int32 arguments</span></pre></td></tr><tr><td data-num="48"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> a <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> a<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre> callbackArgs<span class="token punctuation">[</span>a <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> Int32<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FormatException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Parameters must be integers."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre> <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">OneString</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre> <span class="token comment">// Just copy the String argument</span></pre></td></tr><tr><td data-num="58"></td><td><pre> Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> callbackArgs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> callbackArgs<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre> <span class="token comment">// Invoke the delegate and show the result</span></pre></td></tr><tr><td data-num="62"></td><td><pre> <span class="token class-name">Object</span> result <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">DynamicInvoke</span><span class="token punctuation">(</span>callbackArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Result = "</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TargetParameterCountException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Incorrect number of parameters specified."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="69"></td><td><pre> <span class="token comment">// This callback method takes 2 Int32 arguments </span></pre></td></tr><tr><td data-num="70"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Object</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> n1<span class="token punctuation">,</span> <span class="token class-name">Int32</span> n2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="71"></td><td><pre> <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="72"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="73"></td><td><pre> <span class="token comment">// This callback method takes 2 Int32 arguments </span></pre></td></tr><tr><td data-num="74"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Object</span> <span class="token function">Subtract</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> n1<span class="token punctuation">,</span> <span class="token class-name">Int32</span> n2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="75"></td><td><pre> <span class="token keyword">return</span> n1 <span class="token operator">-</span> n2<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="76"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="77"></td><td><pre> <span class="token comment">// This callback method takes 1 String argument </span></pre></td></tr><tr><td data-num="78"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Object</span> <span class="token function">NumChars</span><span class="token punctuation">(</span><span class="token class-name">String</span> s1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="79"></td><td><pre> <span class="token keyword">return</span> s1<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="80"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="81"></td><td><pre> <span class="token comment">// This callback method takes 1 String argument </span></pre></td></tr><tr><td data-num="82"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Object</span> <span class="token function">Reverse</span><span class="token punctuation">(</span><span class="token class-name">String</span> s1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="83"></td><td><pre> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">String</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">Reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>ğŸ’¡å°ç»“ï¼š <code>System.Delegate.MethodInfo</code> æä¾›äº†ä¸€ä¸ª <code>CreateDelegate</code> æ–¹æ³•ï¼Œå…è®¸åœ¨ç¼–è¯‘æ—¶ä¸çŸ¥é“å§”æ‰˜çš„æ‰€æœ‰å¿…è¦ä¿¡æ¯çš„å‰æä¸‹åˆ›å»ºå§”æ‰˜ã€‚ä½¿ç”¨åå°„ APIï¼Œé¦–å…ˆå¿…é¡»è·å–å¼•ç”¨äº†å›è°ƒæ–¹æ³•çš„ä¸€ä¸ª <code>MethodInfo</code> å¯¹è±¡ã€‚ç„¶åï¼Œè°ƒç”¨ <code>CreateDelegate</code> æ–¹æ³•æ¥æ„é€ ç”±ç¬¬ä¸€ä¸ªå‚æ•° <code>delegateType</code> æ‰€æ ‡è¯†çš„ <code>Delegate</code> æ´¾ç”Ÿç±»å‹çš„å¯¹è±¡ã€‚å¦‚æœå§”æ‰˜åŒ…è£…äº†å®ä¾‹æ–¹æ³•ï¼Œè¿˜è¦å‘ <code>CreateDelegate</code> ä¼ é€’ä¸€ä¸ª <code>target</code> å‚æ•°ï¼ŒæŒ‡å®šä½œä¸º <code>this</code> å‚æ•°ä¼ ç»™å®ä¾‹æ–¹æ³•çš„éƒ½è¥¿æ˜‚ã€‚ <code>System.Delegate</code> çš„ <code>DynamicInvoke</code> æ–¹æ³•å…è®¸è°ƒç”¨å§”æ‰˜å¯¹è±¡çš„å›è°ƒæ–¹æ³•ï¼Œä¼ é€’ä¸€ç»„åœ¨è¿è¡Œæ—¶ç¡®å®šçš„å‚æ•°ã€‚è°ƒç”¨ <code>DynamicInvoke</code> æ–¹æ³•ä½¿ï¼Œå®ƒä¼šåœ¨å†…éƒ¨ä¿è¯ä¼ é€’çš„å‚æ•°ä¸å›è°ƒæ–¹æ³•æœŸæœ›çš„å‚æ•°å…¼å®¹ã€‚å¦‚æœå…¼å®¹ï¼Œå°±è°ƒç”¨å›è°ƒæ–¹æ³•ï¼›å¦åˆ™æŠ›å‡º <code>ArgumentException</code> å¼‚å¸¸ã€‚ <code>DynamicInvoke</code> è¿”å›å›è°ƒæ–¹æ³•æ‰€è¿”å›çš„å¯¹è±¡ã€‚</p><div class="tags"><a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag"><i class="ic i-tag"></i> è¯»ä¹¦ç¬”è®°</a> <a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C#</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2022-11-21 15:46:18" itemprop="dateModified" datetime="2022-11-21T15:46:18+08:00">2022-11-21</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(ï¿£â–½ï¿£)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Sakupinera WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/images/alipay.png" alt="Sakupinera Alipay"><p>Alipay</p></div><div><img data-src="/images/paypal.png" alt="Sakupinera PayPal"><p>PayPal</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Sakupinera <i class="ic i-at"><em>@</em></i>Sakupinera</li><li class="link"><strong>Post link: </strong><a href="http://sakupinera.github.io/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/" title="CLR via C# - Chapter 17 Delegates">http://sakupinera.github.io/2022/11/21/csharp/clr-via-csharp/Chapter 17 Delegates/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;03&#x2F;08&#x2F;cNIvjwsl174ibOo.png" title="CLR via C# - Chapter 16 Arrays"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 16 Arrays</h3></a></div><div class="item right"><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;03&#x2F;08&#x2F;lrzLEXqhHuVUcP2.jpg" title="CLR via C# - Chapter 18 Custom Attributes"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 18 Custom Attributes</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#chapter-17-delegates"><span class="toc-number">1.</span> <span class="toc-text">Chapter 17 Delegates</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#a-first-look-at-delegates"><span class="toc-number">1.1.</span> <span class="toc-text">A First Look at Delegates</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#using-delegates-to-call-back-static-methods"><span class="toc-number">1.2.</span> <span class="toc-text">Using Delegates to Call Back Static Methods</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#using-delegates-to-call-back-instance-methods"><span class="toc-number">1.3.</span> <span class="toc-text">Using Delegates to Call Back Instance Methods</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#demystifying-delegates"><span class="toc-number">1.4.</span> <span class="toc-text">Demystifying Delegates</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#using-delegates-to-call-back-many-methods-chaining"><span class="toc-number">1.5.</span> <span class="toc-text">Using Delegates to Call Back Many Methods (Chaining)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cs-support-for-delegate-chains"><span class="toc-number">1.5.1.</span> <span class="toc-text">C#â€™s Support for Delegate Chains</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#having-more-control-over-delegate-chain-invocation"><span class="toc-number">1.5.2.</span> <span class="toc-text">Having More Control over Delegate Chain Invocation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#enough-with-the-delegate-definitions-already-generic-delegates"><span class="toc-number">1.6.</span> <span class="toc-text">Enough with the Delegate Definitions Already (Generic Delegates)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cs-syntactical-sugar-for-delegates"><span class="toc-number">1.7.</span> <span class="toc-text">C#â€™s Syntactical Sugar for Delegates</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#syntactical-shortcut-1-no-need-to-construct-a-delegate-object"><span class="toc-number">1.7.1.</span> <span class="toc-text">Syntactical Shortcut #1: No Need to Construct a Delegate Object</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#syntactical-shortcut-2-no-need-to-define-a-callback-method-lambda-expressions"><span class="toc-number">1.7.2.</span> <span class="toc-text">Syntactical Shortcut #2: No Need to Define a Callback Method (Lambda Expressions)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#syntactical-shortcut-3-no-need-to-wrap-local-variables-in-a-class-manually-to-pass-them-to-a-callback-method"><span class="toc-number">1.7.3.</span> <span class="toc-text">Syntactical Shortcut #3: No Need to Wrap Local Variables in a Class Manually to Pass Them to a Callback Method</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#delegates-and-reflection"><span class="toc-number">1.8.</span> <span class="toc-text">Delegates and Reflection</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%201%20The%20CLR%E2%80%99s%20Execution%20Model/" rel="bookmark" title="CLR via C# - Chapter 1 The CLRâ€™s Execution Model">CLR via C# - Chapter 1 The CLRâ€™s Execution Model</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%202%20Building,%20Packaging,%20Deploying,%20and%20Administering%20Applications%20and%20Types/" rel="bookmark" title="CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types">CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%203%20Shared%20Assemblies%20and%20Strongly%20Named%20Assemblies/" rel="bookmark" title="CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies">CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies</a></li><li><a href="/2022/09/27/csharp/clr-via-csharp/Chapter%204%20Type%20Fundamentals/" rel="bookmark" title="CLR via C# - Chapter 4 Type Fundamentals">CLR via C# - Chapter 4 Type Fundamentals</a></li><li><a href="/2022/10/15/csharp/clr-via-csharp/Chapter%205%20Primitive,%20Reference,%20and%20Value%20%20Types/" rel="bookmark" title="CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals">CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals</a></li><li><a href="/2022/10/21/csharp/clr-via-csharp/Chapter%206%20Type%20and%20Member%20Basics/" rel="bookmark" title="CLR via C# - Chapter 6 Type and Member Basics">CLR via C# - Chapter 6 Type and Member Basics</a></li><li><a href="/2022/10/24/csharp/clr-via-csharp/Chapter%207%20Constants%20and%20Fields/" rel="bookmark" title="CLR via C# - Chapter 7 Constants and Fields">CLR via C# - Chapter 7 Constants and Fields</a></li><li><a href="/2022/10/25/csharp/clr-via-csharp/Chapter%208%20Methods/" rel="bookmark" title="CLR via C# - Chapter 8 Methods">CLR via C# - Chapter 8 Methods</a></li><li><a href="/2022/10/27/csharp/clr-via-csharp/Chapter%209%20Parameters/" rel="bookmark" title="CLR via C# - Chapter 9 Parameters">CLR via C# - Chapter 9 Parameters</a></li><li><a href="/2022/10/28/csharp/clr-via-csharp/Chapter%2010%20Properties/" rel="bookmark" title="CLR via C# - Chapter 10 Properties">CLR via C# - Chapter 10 Properties</a></li><li><a href="/2022/10/29/csharp/clr-via-csharp/Chapter%2011%20Events/" rel="bookmark" title="CLR via C# - Chapter 11 Events">CLR via C# - Chapter 11 Events</a></li><li><a href="/2022/11/02/csharp/clr-via-csharp/Chapter%2012%20Generics/" rel="bookmark" title="CLR via C# - Chapter 12 Generics">CLR via C# - Chapter 12 Generics</a></li><li><a href="/2022/11/04/csharp/clr-via-csharp/Chapter%2013%20Interfaces/" rel="bookmark" title="CLR via C# - Chapter 13 Interfaces">CLR via C# - Chapter 13 Interfaces</a></li><li><a href="/2022/11/16/csharp/clr-via-csharp/Chapter%2014%20Chars,%20Strings,%20and%20Working%20%20with%20Text/" rel="bookmark" title="CLR via C# - Chapter 14 Chars, Strings, and Working with Text">CLR via C# - Chapter 14 Chars, Strings, and Working with Text</a></li><li><a href="/2022/11/17/csharp/clr-via-csharp/Chapter%2015%20Enumerated%20Types%20and%20Bit%20Flags/" rel="bookmark" title="CLR via C# - Chapter 15 Enumerated Types and Bit Flags">CLR via C# - Chapter 15 Enumerated Types and Bit Flags</a></li><li><a href="/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/" rel="bookmark" title="CLR via C# - Chapter 16 Arrays">CLR via C# - Chapter 16 Arrays</a></li><li class="active"><a href="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/" rel="bookmark" title="CLR via C# - Chapter 17 Delegates">CLR via C# - Chapter 17 Delegates</a></li><li><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" rel="bookmark" title="CLR via C# - Chapter 18 Custom Attributes">CLR via C# - Chapter 18 Custom Attributes</a></li><li><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" rel="bookmark" title="CLR via C# - Chapter 19 Nullable Value Types">CLR via C# - Chapter 19 Nullable Value Types</a></li><li><a href="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/" rel="bookmark" title="CLR via C# - Chapter 20 Exceptions and State Management">CLR via C# - Chapter 20 Exceptions and State Management</a></li><li><a href="/2022/11/27/csharp/clr-via-csharp/Chapter%2021%20The%20Managed%20Heap%20and%20Garbage%20%20Collection/" rel="bookmark" title="CLR via C# - Chapter 21 The Managed Heap and Garbage  Collection">CLR via C# - Chapter 21 The Managed Heap and Garbage Collection</a></li><li><a href="/2022/11/28/csharp/clr-via-csharp/Chapter%2022%20CLR%20Hosting%20and%20AppDomains/" rel="bookmark" title="CLR via C# - Chapter 22 CLR Hosting and AppDomains">CLR via C# - Chapter 22 CLR Hosting and AppDomains</a></li><li><a href="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/" rel="bookmark" title="CLR via C# - Chapter 23 Assembly Loading and Reflection">CLR via C# - Chapter 23 Assembly Loading and Reflection</a></li><li><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" rel="bookmark" title="CLR via C# - Chapter 24 Runtime Serialization">CLR via C# - Chapter 24 Runtime Serialization</a></li><li><a href="/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/" rel="bookmark" title="CLR via C# - Chapter 25 Interoperating with WinRT Components">CLR via C# - Chapter 25 Interoperating with WinRT Components</a></li><li><a href="/2023/02/06/csharp/clr-via-csharp/Chapter%2026%20Thread%20Basics/" rel="bookmark" title="CLR via C# - Chapter 26 Thread Basics">CLR via C# - Chapter 26 Thread Basics</a></li><li><a href="/2023/02/07/csharp/clr-via-csharp/Chapter%2027%20Compute-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations">CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations</a></li><li><a href="/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 28 IO-Bound Asynchronous Operations">CLR via C# - Chapter 28 IO-Bound Asynchronous Operations</a></li><li><a href="/2023/02/09/csharp/clr-via-csharp/Chapter%2029%20Primitive%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 29 Primitive Thread Synchronization">CLR via C# - Chapter 29 Primitive Thread Synchronization</a></li><li><a href="/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 30 Hybrid Thread Synchronization">CLR via C# - Chapter 30 Hybrid Thread Synchronization</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Sakupinera" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Sakupinera</p><div class="description" itemprop="description">ä¿æŒä½ çš„å†³å¿ƒï¼</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">86</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">13</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">6</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Nha3VwaW5lcmE=" title="https:&#x2F;&#x2F;github.com&#x2F;sakupinera"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9zYWt1cGluZXJh" title="https:&#x2F;&#x2F;twitter.com&#x2F;sakupinera"><i class="ic i-twitter"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTQwNzIyOTA3MQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;407229071"><i class="ic i-cloud-music"></i></span> <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMjIzMDczOTg/c3BtX2lkX2Zyb209MzMzLjEwMDcuMC4w" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;22307398?spm_id_from&#x3D;333.1007.0.0"><i class="ic i-bilibili"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/games/" rel="section"><i class="ic i-flag"></i>Games</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-person"></i>About</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/08/28/linux/learn-linux/%E7%94%A8%E6%88%B7%E5%92%8C%E7%94%A8%E6%88%B7%E7%BB%84%E7%AE%A1%E7%90%86/" title="LearnLinux - ç”¨æˆ·å’Œç”¨æˆ·ç»„ç®¡ç†">LearnLinux - ç”¨æˆ·å’Œç”¨æˆ·ç»„ç®¡ç†</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/08/28/linux/learn-linux/Linux%E7%B3%BB%E7%BB%9F%E7%AE%80%E4%BB%8B/" title="LearnLinux - Linuxç³»ç»Ÿç®€ä»‹">LearnLinux - Linuxç³»ç»Ÿç®€ä»‹</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2023/01/07/cpp/cpp-primer/Chapter%2015%20Object-Oriented%20Programming/" title="C++ Primer - Chapter 15 Object-Oriented Programming">C++ Primer - Chapter 15 Object-Oriented Programming</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/" title="CLR via C# - Chapter 30 Hybrid Thread Synchronization">CLR via C# - Chapter 30 Hybrid Thread Synchronization</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/GAMES101/" title="In GAMES101">GAMES101</a></div><span><a href="/2022/10/14/computer-graphics/games101/%E6%9D%90%E8%B4%A8%E4%B8%8E%E5%A4%96%E8%A7%82/" title="GAMES101 - Materials and Appearancesï¼ˆæè´¨ä¸å¤–è§‚ï¼‰">GAMES101 - Materials and Appearancesï¼ˆæè´¨ä¸å¤–è§‚ï¼‰</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2023/01/10/cpp/cpp-primer/Chapter%2018%20Tools%20for%20Large%20Programs/" title="C++ Primer - Chapter 18 Tools for Large Programs">C++ Primer - Chapter 18 Tools for Large Programs</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/10/25/csharp/clr-via-csharp/Chapter%208%20Methods/" title="CLR via C# - Chapter 8 Methods">CLR via C# - Chapter 8 Methods</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/10/29/csharp/clr-via-csharp/Chapter%2011%20Events/" title="CLR via C# - Chapter 11 Events">CLR via C# - Chapter 11 Events</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%201%20The%20CLR%E2%80%99s%20Execution%20Model/" title="CLR via C# - Chapter 1 The CLRâ€™s Execution Model">CLR via C# - Chapter 1 The CLRâ€™s Execution Model</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2023/01/02/cpp/cpp-primer/Chapter%2010%20Generic%20Algorithms/" title="C++ Primer - Chapter 10 Generic Algorithms">C++ Primer - Chapter 10 Generic Algorithms</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 â€“ <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Sakupinera @ Hanamai Sora</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">2.2m words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">33:30</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/11/21/csharp/clr-via-csharp/Chapter 17 Delegates/",favicon:{show:"ï¼ˆâ—Â´3ï½€â—ï¼‰Goooood",hide:"(Â´Ğ”ï½€)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/assets/shifuku.model.json"},display:{position:"left",width:250,height:500},mobile:{show:!1},react:{opacity:.9},log:!1})</script></body></html>