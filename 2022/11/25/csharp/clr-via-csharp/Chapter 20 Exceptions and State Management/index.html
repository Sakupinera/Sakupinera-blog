<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Sakupinera" href="http://sakupinera.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Sakupinera" href="http://sakupinera.github.io/atom.xml"><link rel="alternate" type="application/json" title="Sakupinera" href="http://sakupinera.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="è¯»ä¹¦ç¬”è®°,C#"><link rel="canonical" href="http://sakupinera.github.io/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/"><title>CLR via C# - Chapter 20 Exceptions and State Management - CLR-via-CSharp - CSharp | Hanamai Sora = Sakupinera</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">CLR via C# - Chapter 20 Exceptions and State Management</h1><div class="meta"><span class="item" title="Created: 2022-11-25 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2022-11-25T00:00:00+08:00">2022-11-25</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>107k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>1:38</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Hanamai Sora</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giph4baakhj20zk0m8h5q.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giciszlczyj20zk0m816d.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giciryrr3rj20zk0m8nhk.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipexj2jgzj20zk0m8b09.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipex2cdtbj20zk0m8x6p.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicm0fdw5cj20zk0m8hdt.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/" itemprop="item" rel="index" title="In CSharp"><span itemprop="name">CSharp</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/CLR-via-CSharp/" itemprop="item" rel="index" title="In CLR-via-CSharp"><span itemprop="name">CLR-via-CSharp</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="http://sakupinera.github.io/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Sakupinera"><meta itemprop="description" content=", ä¿æŒä½ çš„å†³å¿ƒï¼"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sakupinera"></span><div class="body md" itemprop="articleBody"><h1 id="chapter-20-exceptions-and-state-management"><a class="anchor" href="#chapter-20-exceptions-and-state-management">#</a> Chapter 20 Exceptions and State Management</h1><h2 id="defining-exception"><a class="anchor" href="#defining-exception">#</a> Defining â€œExceptionâ€</h2><blockquote><p>When designing a type, you first imagine the various situations in which the type will be used. The type name is usually a noun, such as FileStream or StringBuilder. Then you define the properties, methods, events, and so on for the type. The way you define these members (property data types, method parameters, return values, and so forth) becomes the programmatic interface for your type. These members indicate actions that can be performed by the type itself or on an instance of the type. These action members are usually verbs such as Read, Write, Flush, Append, Insert, Remove, etc. When an action member cannot complete its task, the member should throw an exception.</p></blockquote><p>ğŸ’¡é‡è¦æç¤ºï¼šå¼‚å¸¸æ—¶æŒ‡æˆå‘˜æ²¡æœ‰å®Œæˆå®ƒçš„åç§°æ‰€å®£ç§°çš„è¡ŒåŠ¨ã€‚</p><blockquote><p>Look at the following class definition.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Transfer</span><span class="token punctuation">(</span><span class="token class-name">Account</span> from<span class="token punctuation">,</span> <span class="token class-name">Account</span> to<span class="token punctuation">,</span> <span class="token class-name">Decimal</span> amount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> from <span class="token operator">-=</span> amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> to <span class="token operator">+=</span> amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The Transfer method accepts two Account objects and a Decimal value that identifies an amount of money to transfer between accounts. Obviously, the goal of the Transfer method is to subtract money from one account and add money to another. The Transfer method could fail for many reasons: the from or to argument might be null; the from or to argument might not refer to an open account; the from account might have insufficient funds; the to account might have so much money in it that adding more would cause it to overflow; or the amount argument might be 0, negative, or have more than two digits after the decimal place.</p></blockquote><blockquote><p>When the Transfer method is called, its code must check for all of these possibilities, and if any of them are detected, it cannot transfer the money and should notify the caller that it failed by throwing an exception. In fact, notice that the Transfer methodâ€™s return type is void. This is because the Transfer method has no meaningful value to return; if it returns at all, it was successful. If it fails, it throws a meaningful exception.</p></blockquote><blockquote><p>Object-oriented programming allows developers to be very productive because you get to write code like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Boolean</span> f <span class="token operator">=</span> <span class="token string">"Jeff"</span><span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">EndsWith</span><span class="token punctuation">(</span><span class="token string">"E"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span></pre></td></tr></table></figure><blockquote><p>Here Iâ€™m composing my intent by chaining several operations together.1 This code was easy for me to write and is easy for others to read and maintain because the intent is obvious: take a string, grab a portion of it, uppercase that portion, and see if it ends with an â€œE.â€ This is great, but there is a big assumption being made here: no operation fails. But, of course, errors are always possible, so we need a way to handle those errors. In fact, there are many object-oriented constructsâ€”constructors, getting/setting a property, adding/removing an event, calling an operator overload, calling a conversion operatorâ€”that have no way to return error codes, but these constructs must still be able to report an error. The mechanism provided by the Microsoft .NET Framework and all programming languages that support it is called exception handling.</p></blockquote><p>ğŸ’¡é‡è¦æç¤º è®¸å¤šå¼€å‘äººå‘˜éƒ½é”™è¯¯åœ°è®¤ä¸ºå¼‚å¸¸å’ŒæŸä»¶äº‹ä»¶çš„å‘ç”Ÿé¢‘ç‡æœ‰å…³ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªè®¾è®¡æ–‡ä»¶ <code>Read</code> æ–¹æ³•çš„å¼€å‘äººå‘˜å¯èƒ½ä¼šè¿™æ ·æƒ³ï¼šâ€ è¯»å–æ–‡ä»¶æœ€ç»ˆä¼šæŠµè¾¾æ–‡ä»¶å°¾ã€‚ç”±äºæŠµè¾¾æ–‡ä»¶å°¾éƒ¨æ˜¯ä¼šå‘ç”Ÿï¼Œæ‰€ä»¥æˆ‘è®¾è®¡è¿™ä¸ª <code>Read</code> æ–¹æ³•è¿”å›ä¸€ä¸ªç‰¹æ®Šå€¼æ¥æŠ¥å‘ŠæŠµè¾¾äº†æ–‡ä»¶å°¾ï¼›æˆ‘ä¸è®©å®ƒæŠ›å‡ºå¼‚å¸¸ã€‚â€œ<br>é—®é¢˜åœ¨äºï¼Œè¿™æ˜¯è®¾è®¡ <code>Read</code> æ–¹æ³•çš„å¼€å‘äººå‘˜çš„æƒ³æ³•ï¼Œè€Œéè°ƒç”¨ <code>Read</code> æ–¹æ³•çš„å¼€å‘äººå‘˜çš„æƒ³æ³•ã€‚</p><p>è®¾è®¡ <code>Read</code> æ–¹æ³•çš„å¼€å‘äººå‘˜ä¸å¯èƒ½çŸ¥é“è¿™ä¸ªæ–¹æ³•çš„æ‰€æœ‰è°ƒç”¨æƒ…å½¢ã€‚æ‰€ä»¥ï¼Œå¼€å‘äººå‘˜ä¸å¯èƒ½çŸ¥é“ <code>Read</code> çš„è°ƒç”¨è€…æ˜¯ä¸æ˜¯æ¯æ¬¡éƒ½ä¼šä¸€è·¯è¯»å–åˆ°æ–‡ä»¶å°¾ã€‚äº‹å®ä¸Šï¼Œç”±äºå¤§å¤šæ•°æ–‡ä»¶åŒ…å«çš„éƒ½æ˜¯ç»“æ„åŒ–æ•°æ®ï¼Œæ‰€ä»¥ä¸€è·¯è¯»å–ç›´è‡³æ–‡ä»¶å°¾çš„æƒ…å†µæ˜¯å¾ˆå°‘å‘ç”Ÿçš„ã€‚</p><p>ğŸ’¡å°ç»“ï¼šè®¸å¤šé¢å‘å¯¹è±¡çš„æ„é€  â€”â€” æ„é€ å™¨ã€è·å–å’Œè®¾ç½®å±æ€§ã€æ·»åŠ å’Œåˆ é™¤äº‹ä»¶ã€è°ƒç”¨æ“ä½œç¬¦é‡è½½å’Œè°ƒç”¨è½¬æ¢æ“ä½œç¬¦ç­‰ â€”â€” éƒ½æ²¡åŠæ³•è¿”å›é”™è¯¯ä»£ç ï¼Œä½†å®ƒä»¬ä»ç„¶éœ€è¦æŠ¥å‘Šé”™è¯¯ã€‚Microsoft .NET Framework å’Œæ‰€æœ‰ç¼–ç¨‹è¯­è¨€é€šè¿‡å¼‚å¸¸å¤„ç†æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h2 id="exception-handling-mechanics"><a class="anchor" href="#exception-handling-mechanics">#</a> Exception-Handling Mechanics</h2><blockquote><p>In this section, Iâ€™ll introduce the mechanics and C# constructs needed in order to use exception handling, but itâ€™s not my intention to explain them in great detail. The purpose of this chapter is to offer useful guidelines for when and how to use exception handling in your code. If you want more information about the mechanics and language constructs for using exception handling, see the .NET Framework documentation and the C# language specification. Also, the .NET Framework exceptionhandling mechanism is built using the Structured Exception Handling (SEH) mechanism offered by Windows. SEH has been discussed in many resources, including the book, Windows via C/C++, Fifth Edition, by myself and Christophe Nasarre (Microsoft Press, 2007), which contains three chapters devoted to SEH.</p></blockquote><blockquote><p>The following C# code shows a standard usage of the exception-handling mechanism. This code gives you an idea of what exception-handling blocks look like and what their purpose is. In the subsections after the code, Iâ€™ll formally describe the try, catch, and finally blocks and their purpose and provide some notes about their use.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Put code requiring graceful recovery and/or cleanup operations here...</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidOperationException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Put code that recovers from an InvalidOperationException here...</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// Put code that recovers from an IOException here...</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Put code that recovers from any kind of exception other than those preceding this...</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// When catching any exception, you usually re-throw the exception.</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// I explain re-throwing later in this chapter. </span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">throw</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token comment">// Put code that cleans up any operations started within the try block here...</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">// The code in here ALWAYS executes, regardless of whether an exception is thrown. </span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token comment">// Code below the finally block executes if no exception is thrown within the try block</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token comment">// or if a catch block catches the exception and doesn't throw or re-throw an exception. </span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>This code demonstrates one possible way to use exception-handling blocks. Donâ€™t let the code scare youâ€”most methods have simply a try block matched with a single finally block or a try block matched with a single catch block. Itâ€™s unusual to have as many catch blocks as in this example. I put them there for illustration purposes.</p></blockquote><h3 id="the-try-block"><a class="anchor" href="#the-try-block">#</a> The try Block</h3><blockquote><p>A try block contains code that requires common cleanup operations, exception-recovery operations, or both. The cleanup code should be placed in a single finally block. A try block can also contain code that might potentially throw an exception. The exception-recovery code should be placed in one or more catch blocks. You create one catch block for each kind of exception that your application can safely recover from. A try block must be associated with at least one catch or finally block; it makes no sense to have a try block that stands by itself, and C# will prevent you from doing this.</p></blockquote><p>ğŸ’¡é‡è¦æç¤ºï¼šå¼€å‘äººå‘˜æœ‰æ—¶ä¸çŸ¥é“åº”è¯¥åœ¨ä¸€ä¸ª <code>try</code> å—ä¸­æ”¾å…¥å¤šå°‘ä»£ç ã€‚è¿™æ®å›¾å–å†³äºçŠ¶æ€ç®¡ç†ã€‚å¦‚æœåœ¨ä¸€ä¸ª <code>try</code> å—ä¸­æ‰§è¡Œå¤šä¸ªå¯èƒ½æŠ›å‡ºåŒä¸€ä¸ªå¼‚å¸¸ç±»å‹çš„æ“ä½œï¼Œä½†ä¸åŒçš„æ“ä½œæœ‰ä¸åŒçš„å¼‚å¸¸æ¢å¤æªæ–½ï¼Œå°±åº”è¯¥å°†æ¯ä¸ªæ“ä½œéƒ½æ”¾åˆ°å®ƒè‡ªå·±çš„ <code>try</code> å—ä¸­ï¼Œè¿™æ ·æ‰èƒ½æ­£ç¡®åœ°æ¢å¤çŠ¶æ€ã€‚</p><h3 id="the-catch-block"><a class="anchor" href="#the-catch-block">#</a> The catch Block</h3><blockquote><p>A catch block contains code to execute in response to an exception. A try block can have zero or more catch blocks associated with it. If the code in a try block doesnâ€™t cause an exception to be thrown, the CLR will never execute the code contained within any of its catch blocks. The thread will simply skip over all of the catch blocks and execute the code in the finally block (if one exists). After the code in the finally block executes, execution continues with the statement following the finally block.</p></blockquote><blockquote><p>The parenthetical expression appearing after the catch keyword is called the catch type. In C#, you must specify a catch type of System.Exception or a type derived from System.Exception. For example, the previous code contains catch blocks for handling an InvalidOperationException (or any exception derived from it) and an IOException (or any exception derived from it). The last catch block (which doesnâ€™t specify a catch type) handles any exception except for the exception type specified by earlier catch blocks; this is equivalent to having a catch block that specifies a catch type of System.Exception except that you cannot access the exception information via code inside the catch blockâ€™s braces.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šç”¨ Microsoft Visual Studio è°ƒè¯• <code>catch</code> å—æ—¶ï¼Œå¯åœ¨ç›‘è§†çª—å£ä¸­æ·»åŠ ç‰¹æ®Šå˜é‡åç§° <code>$Exception</code> æ¥æŸ¥çœ‹å½“å‰æŠ›å‡ºçš„å¼‚å¸¸å¯¹è±¡ã€‚</p><blockquote><p>The CLR searches from top to bottom for a matching catch type, and therefore you should place the more specific exception types at the top. The most-derived exception types should appear first, followed by their base types (if any), down to System.Exception (or an exception block that doesnâ€™t specify a catch type). In fact, the C# compiler generates an error if more specific catch blocks appear closer to the bottom because the catch block would be unreachable.</p></blockquote><blockquote><p>If an exception is thrown by code executing within the try block (or any method called from within the try block), the CLR starts searching for catch blocks whose catch type is the same type as or a base type of the thrown exception. If none of the catch types matches the exception, the CLR continues searching up the call stack looking for a catch type that matches the exception. If after reaching the top of the call stack, no catch block is found with a matching catch type, an unhandled exception occurs. Iâ€™ll talk more about unhandled exceptions later in this chapter.</p></blockquote><blockquote><p>After the CLR locates a catch block with a matching catch type, it executes the code in all inner finally blocks, starting from within the try block whose code threw the exception and stopping with the catch block that matched the exception. Note that any finally block associated with the catch block that matched the exception is not executed yet. The code in this finally block wonâ€™t execute until after the code in the handling catch block has executed.</p></blockquote><blockquote><p>After all the code in the inner finally blocks has executed, the code in the handling catch block executes. This code typically performs some operations to deal with the exception. At the end of the catch block, you have three choices:</p><ul><li><p>Re-throw the same exception, notifying code higher up in the call stack of the exception.</p></li><li><p>Throw a different exception, giving richer exception information to code higher up in the call stack.</p></li><li><p>Let the thread fall out of the bottom of the catch block.</p></li></ul></blockquote><blockquote><p>Later in this chapter, Iâ€™ll offer some guidelines for when you should use each of these techniques. If you choose either of the first two techniques, youâ€™re throwing an exception, and the CLR behaves just as it did before: it walks up the call stack looking for a catch block whose type matches the type of the exception thrown.</p></blockquote><blockquote><p>If you pick the last technique, when the thread falls out of the bottom of the catch block, it immediately starts executing code contained in the finally block (if one exists). After all of the code in the finally block executes, the thread drops out of the finally block and starts executing the statements immediately following the finally block. If no finally block exists, the thread continues execution at the statement following the last catch block.</p></blockquote><blockquote><p>In C#, you can specify a variable name after a catch type. When an exception is caught, this variable refers to the System.Exception-derived object that was thrown. The catch blockâ€™s code can reference this variable to access information specific to the exception (such as the stack trace leading up to the exception). Although itâ€™s possible to modify this object, you shouldnâ€™t; consider the object to be read-only. Iâ€™ll explain the Exception type and what you can do with it later in this chapter.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šä½ çš„ä»£ç å¯å‘ <code>AppDomain</code> çš„ <code>FirstChanceException</code> äº‹ä»¶ç™»è®°ï¼Œè¿™æ ·åªè¦ AppDomain ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œå°±ä¼šæ”¶åˆ°é€šçŸ¥ã€‚è¿™ä¸ªé€šçŸ¥æ˜¯åœ¨ CLR å¼€å§‹æœç´¢ä»»ä½• <code>catch</code> å—ä¹‹å‰å‘ç”Ÿçš„ã€‚æ¬²çŸ¥è¯¥äº‹ä»¶çš„è¯¦æƒ…ï¼Œè¯·å‚è§ç¬¬ 22 ç«  â€CLR å¯„å®¿å’Œ AppDomainâ€ã€‚</p><h3 id="the-finally-block"><a class="anchor" href="#the-finally-block">#</a> The finally Block</h3><blockquote><p>A finally block contains code thatâ€™s guaranteed to execute.2 Typically, the code in a finally block performs the cleanup operations required by actions taken in the try block. For example, if you open a file in a try block, youâ€™d put the code to close the file in a finally block.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ReadData</span><span class="token punctuation">(</span><span class="token class-name">String</span> pathname<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name">FileStream</span> fs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> fs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Open<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">// Process the data in the file...</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Put code that recovers from an IOException here...</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// Make sure that the file gets closed. </span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>fs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> fs<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If the code in the try block executes without throwing an exception, the file is guaranteed to be closed. If the code in the try block does throw an exception, the code in the finally block still executes, and the file is guaranteed to be closed, regardless of whether the exception is caught. Itâ€™s improper to put the statement to close the file after the finally block; the statement wouldnâ€™t execute if an exception were thrown and not caught, which would result in the file being left open (until the next garbage collection).</p></blockquote><blockquote><p>A try block doesnâ€™t require a finally block associated with it; sometimes the code in a try block just doesnâ€™t require any cleanup code. However, if you do have a finally block, it must appear after any and all catch blocks. A try block can have no more than one finally block associated with it.</p></blockquote><blockquote><p>When a thread reaches the end of the code contained in a finally block, the thread simply starts executing the statements immediately following the finally block. Remember that the code in the finally block is cleanup code. This code should execute only what is necessary to clean up operations initiated in the try block. The code inside catch and finally blocks should be very short and should have a high likelihood of succeeding without itself throwing an exception. Usually the code in these blocks is just one or two lines of code.</p></blockquote><blockquote><p>It is always possible that exception-recovery code or cleanup code could fail and throw an exception. Although possible, it is unlikely and if it does happen it usually means that there is something very wrong somewhere. Most likely some state has gotten corrupted somewhere. If an exception is inadvertently thrown within a catch or finally block, the world will not come to an endâ€”the CLRâ€™s exception mechanism will execute as though the exception were thrown after the finally block. However, the CLR does not keep track of the first exception that was thrown in the corresponding try block (if any), and you will lose any and all information (such as the stack trace) available about the first exception. Probably (and hopefully), this new exception will not be handled by your code and the exception will turn into an unhandled exception. The CLR will then terminate your process, which is good because all the corrupted state will now be destroyed. This is much better than having your application continue to run with unpredictable results and possible security holes.</p></blockquote><blockquote><p>Personally, I think the C# team should have chosen different language keywords for the exceptionhandling mechanism. What programmers want to do is try to execute some piece of code. And then, if something fails, either recover from the failure and move on or compensate to undo some state change and continue to report the failure up to a caller. Programmers also want to have guaranteed cleanup no matter what happens.</p></blockquote><blockquote><p>The code on the left is what you have to write to make the C# compiler happy, but the code on the right is the way I prefer to think about it.</p></blockquote><p><img data-src="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/image-20221124102617217.png" alt="image-20221124102617217"></p><p><strong>CLS å’Œé CLS å¼‚å¸¸</strong></p><p>æ‰€æœ‰é¢å‘ CLR çš„ç¼–ç¨‹è¯­è¨€éƒ½å¿…é¡»æ”¯æŒæŠ›å‡ºä» <code>Exception</code> æ´¾ç”Ÿçš„å¯¹è±¡ï¼Œå› ä¸ºå…¬å…±è¯­è¨€è§„èŒƒ (Common Language Specification, CLS) å¯¹æ­¤è¿›è¡Œäº†ç¡¬æ€§è§„å®šã€‚ä½†æ˜¯ï¼ŒCLR å®é™…å…è®¸æŠ›å‡ºä»»ä½•ç±»å‹çš„å®ä¾‹ï¼Œè€Œä¸”æœ‰äº›ç¼–ç¨‹è¯­è¨€å…è®¸ä»£ç æŠ›å‡ºé CLS ç›¸å®¹çš„å¼‚å¸¸å¯¹è±¡ï¼Œæ¯”å¦‚ä¸€ä¸ª <code>String</code> ï¼Œ <code>Int32</code> å’Œ <code>DateTime</code> ç­‰ã€‚C# ç¼–è¯‘å™¨åªå…è®¸ä»£ç æŠ›å‡ºä» <code>Exception</code> æ´¾ç”Ÿçš„å¯¹è±¡ï¼Œè€Œç”¨å…¶ä»–ä¸€äº›è¯­è¨€å†™çš„ä»£ç ä¸ä»…å…è®¸æŠ›å‡º <code>Exception</code> æ´¾ç”Ÿå¯¹è±¡ï¼Œè¿˜å…è®¸æŠ›å‡ºé <code>Exception</code> æ´¾ç”Ÿå¯¹è±¡ã€‚</p><p>è®¸å¤šç¨‹åºå‘˜æ²¡æœ‰æ„è¯†åˆ° CLR å…è®¸æŠ›å‡ºä»»ä½•å¯¹è±¡æ¥æŠ¥å‘Šå¼‚å¸¸ã€‚å¤§å¤šæ•°å¼€å‘äººå‘˜ä»¥ä¸ºåªæœ‰æ´¾ç”Ÿè‡ª <code>Exception</code> çš„å¯¹è±¡æ‰èƒ½æŠ›å‡ºã€‚åœ¨ CLR çš„ 2.0 ç‰ˆæœ¬ä¹‹å‰ï¼Œç¨‹åºå‘˜å†™ <code>catch</code> å—æ¥æ•æ‰å¼‚å¸¸æ—¶ï¼Œåªèƒ½æ•æ‰ CLS ç›¸å®¹çš„å¼‚å¸¸ã€‚å¦‚æœä¸€ä¸ª C# æ–¹æ³•è°ƒç”¨äº†ç”¨å¦ä¸€ç§ç¼–ç¨‹è¯­è¨€å†™çš„æ–¹æ³•ï¼Œè€Œä¸”é‚£ä¸ªæ–¹æ³•æŠ›å‡ºä¸€ä¸ªé CLS ç›¸å®¹çš„å¼‚å¸¸ï¼Œé‚£ä¹ˆ C# ä»£ç æ ¹æœ¬ä¸èƒ½æ•æ‰è¿™ä¸ªå¼‚å¸¸ï¼Œä»è€Œé€ æˆä¸€äº›å®‰å…¨éšæ‚£ã€‚</p><p>åœ¨ CLR çš„ 2.0 ç‰ˆæœ¬ä¸­ï¼ŒMicrosoft å¼•å…¥äº†æ–°çš„ <code>RuntimeWrappedException</code> ç±» (åœ¨å‘½åç©ºé—´ <code>System.Runtime.CompilerServices</code> ä¸­å®šä¹‰)ã€‚è¯¥ç±»æ´¾ç”Ÿè‡ª <code>Exception</code> ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ª CLS ç›¸å®¹çš„å¼‚å¸¸ç±»å‹ã€‚ <code>RuntimeWrappedException</code> ç±»å«æœ‰ä¸€ä¸ª <code>Object</code> ç±»å‹çš„ä¸€ä¸ª CLS ç›¸å®¹çš„å¼‚å¸¸ç±»å‹ã€‚ <code>RuntimeWrappedException</code> ç±»å«æœ‰ä¸€ä¸ª <code>Object</code> ç±»å‹çš„ç§æœ‰å­—æ®µ (å¯é€šè¿‡ <code>RuntimeWrappedException</code> ç±»çš„åªè¯»å±æ€§ <code>WrappedException</code> æ¥è®¿é—®)ã€‚åœ¨ CLR 2.0 ä¸­ï¼Œé CLS ç›¸å®¹çš„ä¸€ä¸ªå¼‚å¸¸è¢«æŠ›å‡ºæ—¶ï¼ŒCLR ä¼šè‡ªåŠ¨æ„é€  <code>RuntimeWrappedException</code> ç±»çš„å®ä¾‹ï¼Œå¹¶åˆå§‹åŒ–è¯¥å®ä¾‹çš„ç§æœ‰å­—æ®µï¼Œä½¿ä¹‹å¼•ç”¨å®é™…æŠ›å‡ºçš„å¯¹è±¡ã€‚è¿™æ · CLR å°±å°†é CLS ç›¸å®¹çš„å¼‚å¸¸è½¬å˜æˆäº† CLS ç›¸å®¹çš„å¼‚å¸¸ã€‚æ‰€ä»¥ï¼Œä»»ä½•èƒ½æ•æ‰ <code>Exception</code> ç±»å‹çš„ä»£ç ï¼Œç°åœ¨éƒ½èƒ½æ•æ‰é CLS ç›¸å®¹çš„å¼‚å¸¸ï¼Œä»è€Œæ¶ˆé™¤äº†æ½œåœ¨çš„å®‰å…¨éšæ‚£ã€‚</p><p>è™½ç„¶ C# ç¼–è¯‘å™¨åªå…è®¸å¼€å‘äººå‘˜æŠ›å‡ºæ´¾ç”Ÿè‡ª <code>Exception</code> çš„å¯¹è±¡ï¼Œä½†åœ¨ C# çš„ 2.0 ç‰ˆæœ¬ä¹‹å‰ï¼ŒC# ç¼–è¯‘å™¨ç¡®å®å…è®¸å¼€å‘äººå‘˜ä½¿ç”¨ä»¥ä¸‹å½¢å¼çš„ä»£ç æ•æ‰é CLS ç›¸å®¹çš„å¼‚å¸¸ï¼š</p><pre><code class="language-C#">private void SomeMethod() &#123;
    try &#123;
        // éœ€è¦å¾—ä½“åœ°è¿›è¡Œæ¢å¤å’Œ/æˆ–æ¸…ç†çš„ä»£ç æ”¾åœ¨è¿™é‡Œ
    &#125;
    catch (Exception e) &#123;
        // C# 2.0 ä»¥å‰ï¼Œè¿™ä¸ªå—åªèƒ½æ•æ‰ CLS ç›¸å®¹çš„å¼‚å¸¸ï¼š
        // è€Œç°åœ¨ï¼Œè¿™ä¸ªå—èƒ½æ•æ‰ CLS ç›¸å®¹å’Œä¸ç›¸å®¹çš„å¼‚å¸¸
        throw;   // é‡æ–°æŠ›å‡ºæ•æ‰åˆ°çš„ä»»ä½•ä¸œè¥¿
    &#125;
    catch &#123;
        // åœ¨æ‰€æœ‰ç‰ˆæœ¬çš„ C# ä¸­ï¼Œè¿™ä¸ªå—å¯ä»¥æ•æ‰ CLS ç›¸å®¹å’Œä¸ç›¸å®¹çš„å¼‚å¸¸
        throw;  // é‡æ–°æŠ›å‡ºæ•æ‰åˆ°çš„ä»»ä½•ä¸œè¥¿
    &#125;
&#125;
</code></pre><p>ç°åœ¨ï¼Œä¸€äº›å¼€å‘äººå‘˜æ³¨æ„åˆ° CLR åŒæ—¶æ”¯æŒç›¸å®¹å’Œä¸ç›¸å®¹äº CLS çš„å¼‚å¸¸ï¼Œä»–ä»¬å¯èƒ½åƒä¸Šé¢å±•ç¤ºçš„é‚£æ ·å†™ä¸¤ä¸ª <code>catch</code> å—æ¥æ•æ‰è¿™ä¸¤ç§å¼‚å¸¸ã€‚ä¸º CLR 2.0 æˆ–æ›´é«˜ç‰ˆæœ¬é‡æ–°ç¼–è¯‘ä¸Šè¿°ä»£ç ï¼Œç¬¬äºŒä¸ª <code>catch</code> å—æ°¸è¿œæ‰§è¡Œä¸åˆ°ï¼ŒC# ç¼–è¯‘å™¨æ˜¾ç¤ºä»¥ä¸‹è­¦å‘Šæ¶ˆæ¯ï¼š</p><p>CS1058: ä¸Šä¸€ä¸ª catch å­å¥å·²æ•è·æ‰€æœ‰å¼‚å¸¸ã€‚å¼•å‘çš„æ‰€æœ‰éå¼‚å¸¸å‡è¢«åŒ…è£…åœ¨ <code>System.Runtime.CompilerServices.RuntimeWrappedException</code> ä¸­ã€‚</p><p>å¼€å‘äººå‘˜æœ‰ä¸¤ä¸ªåŠæ³•è¿ç§» .NET Framework 2.0 ä¹‹å‰çš„ä»£ç ã€‚é¦–å…ˆï¼Œä¸¤ä¸ª <code>catch</code> å—ä¸­çš„ä»£ç å¯ä»¥åˆå¹¶åˆ°ä¸€ä¸ª <code>catch</code> å—ä¸­ï¼Œå¹¶åˆ é™¤å…¶ä¸­çš„ä¸€ä¸ª <code>catch</code> å—ä¸­ï¼Œå¹¶åˆ é™¤å…¶ä¸­çš„ä¸€ä¸ª <code>catch</code> å—ã€‚è¿™æ˜¯æ¨èçš„åŠæ³•ã€‚å¦å¤–ï¼Œè¿˜å¯ä»¥å‘ CLR è¯´æ˜ç¨‹åºé›†ä¸­çš„ä»£ç æƒ³æŒ‰ç…§æ—§çš„è§„åˆ™è¡Œäº‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘Šè¯‰ CLR ä½ çš„ <code>catch(Exception)</code> å—ä¸åº”æ•æ‰æ–°çš„ <code>RuntimeWrappedException</code> ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒCLR ä¸ä¼šå°†é CLS ç›¸å®¹çš„å¯¹è±¡åŒ…è£…åˆ°ä¸€ä¸ª <code>RuntimeWrappedException</code> å®ä¾‹ä¸­ï¼Œè€Œä¸”åªæœ‰åœ¨ä½ æä¾›äº†ä¸€ä¸ªæ²¡æœ‰æŒ‡å®šä»»ä½•ç±»å‹çš„ <code>catch</code> å—æ—¶æ‰è°ƒç”¨ä½ çš„ä»£ç ã€‚ä¸ºäº†å‘Šè¯‰ CLR éœ€è¦æ—§çš„è¡Œä¸ºï¼Œå¯å‘ä½ çš„ç¨‹åºé›†åº”ç”¨ <code>RuntimeCompatibilityAttribute</code> ç±»çš„å®ä¾‹ï¼š</p><pre><code class="language-C#">using System.Runtime.CompilerServices;
[assembly:RuntimeCompatibility(WrapNonExceptionThrows = false)]
</code></pre><p>æ³¨æ„ï¼Œè¯¥ç‰¹æ€§å½±å“çš„æ˜¯æ•´ä¸ªç¨‹åºé›†ã€‚åœ¨åŒä¸€ä¸ªç¨‹åºé›†ä¸­ï¼ŒåŒ…è£…å’Œä¸åŒ…è£…å¼‚å¸¸è¿™ä¸¤ç§å¤„ç†æ–¹å¼ä¸èƒ½åŒæ—¶å­˜åœ¨ã€‚å‘åŒ…å«æ—§ä»£ç çš„ç¨‹åºé›† (å‡å¦‚ CLR ä¸æ”¯æŒåœ¨å…¶ä¸­åŒ…è£…å¼‚å¸¸) æ·»åŠ æ–°ä»£ç  (å¸Œæœ› CLR åŒ…è£…å¼‚å¸¸) æ—¶è¦ç‰¹åˆ«å°å¿ƒã€‚</p><p>ğŸ’¡å°ç»“ï¼š.NET Framework å¼‚å¸¸å¤„ç†æœºåˆ¶æ˜¯ç”¨ Microsoft Windows æä¾›çš„ç»“æ„åŒ–å¼‚å¸¸å¤„ç†ï¼ˆStructured Exception Handlingï¼ŒSEHï¼‰æœºåˆ¶æ„å»ºçš„ã€‚ä¸€ä¸ª try å—è‡³å°‘è¦æœ‰ä¸€ä¸ªå…³è”çš„ catch å—æˆ– finally å—ï¼Œå•ç‹¬ä¸€ä¸ª try å—æ²¡æœ‰æ„ä¹‰ï¼ŒC# ä¹Ÿä¸å…è®¸ã€‚ä¸€ä¸ª <code>try</code> å—å¯ä»¥å…³è” 0 ä¸ªæˆ–å¤šä¸ª <code>catch</code> å—ã€‚ <code>catch</code> å…³é”®å­—åçš„åœ†æ‹¬å·ä¸­çš„è¡¨è¾¾å¼ç§°ä¸º<strong>æ•æ‰ç±»å‹</strong>ã€‚C# è¦æ±‚æ•æ‰ç±»å‹å¿…é¡»æ˜¯ <code>System.Exception</code> æˆ–è€…å®ƒçš„æ´¾ç”Ÿç±»å‹ã€‚CLR è‡ªä¸Šè€Œä¸‹æœç´¢åŒ¹é…çš„ <code>catch</code> å—ï¼Œæ‰€ä»¥åº”è¯¥å°†å…·ä½“çš„å¼‚å¸¸æ”¾åœ¨é¡¶éƒ¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé¦–å…ˆå‡ºç°çš„æ˜¯æ´¾ç”Ÿç¨‹åº¦æœ€å¤§çš„å¼‚å¸¸ç±»å‹ï¼Œæ¥ç€æ˜¯å®ƒä»¬çš„åŸºç±»å‹ (å¦‚æœæœ‰çš„è¯)ï¼Œæœ€åæ˜¯ <code>System.Exception</code> (æˆ–è€…æ²¡æœ‰æŒ‡å®šä»»ä½•æ•æ‰ç±»å‹çš„ <code>catch</code> å—)ã€‚äº‹å®ä¸Šï¼Œå¦‚æœå¼„åäº†è¿™ä¸ªé¡ºåºï¼Œå°†è¾ƒå…·ä½“çš„ <code>catch</code> å—æ”¾åœ¨é è¿‘åº•éƒ¨çš„ä½ç½®ï¼ŒC# ç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œå› ä¸ºè¿™æ ·çš„ <code>catch</code> å—æ˜¯ä¸å¯è¾¾çš„ã€‚åœ¨ <code>try</code> å—çš„ä»£ç  (æˆ–è€…ä» <code>try</code> å—è°ƒç”¨çš„ä»»ä½•æ–¹æ³•) ä¸­æŠ›å‡ºå¼‚å¸¸ï¼ŒCLR å°†æœç´¢æ•æ‰ç±»å‹ä¸æŠ›å‡ºçš„å¼‚å¸¸ç›¸åŒ (æˆ–è€…æ˜¯å®ƒçš„åŸºç±») çš„ <code>catch</code> å—ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•æ•æ‰ç±»å‹ä¸æŠ›å‡ºå¼‚å¸¸åŒ¹é…ï¼ŒCLR ä¼šå»è°ƒç”¨æ ˆ &lt;sup&gt;â‘ &lt;/sup &gt; æ›´é«˜çš„ä¸€å±‚æœç´¢ä¸å¼‚å¸¸åŒ¹é…çš„æ•æ‰ç±»å‹ã€‚å¦‚æœéƒ½åˆ°äº†è°ƒç”¨æ ˆçš„é¡¶éƒ¨ï¼Œè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ <code>catch</code> å—ï¼Œå°±ä¼šå‘ç”Ÿæœªå¤„ç†çš„å¼‚å¸¸ã€‚ä¸€æ—¦ CLR æ‰¾åˆ°åŒ¹é…çš„ <code>catch</code> å—ï¼Œå°±ä¼šæ‰§è¡Œå†…å±‚æ‰€æœ‰ <code>finally</code> å—ä¸­çš„ä»£ç ã€‚æ‰€è°“ â€œå†…å­˜ <code>finally</code> å—â€ æ˜¯æŒ‡ä»æŠ›å‡ºå¼‚å¸¸çš„ <code>try</code> å—å¼€å§‹ï¼Œåˆ°åŒ¹é…å¼‚å¸¸çš„ <code>catch</code> å—ä¹‹é—´çš„æ‰€æœ‰ <code>finally</code> å—ã€‚æ³¨æ„ï¼ŒåŒ¹é…å¼‚å¸¸çš„é‚£ä¸ª <code>catch</code> å—æ‰€å…³è”çš„ <code>finally</code> å—å°šæœªæ‰§è¡Œï¼Œè¯¥ <code>finally</code> å—ä¸­çš„ä»£ç ä¸€ç›´è¦ç­‰åˆ°è¿™ä¸ª <code>catch</code> å—ä¸­çš„ä»£ç æ‰§è¡Œå®Œæ¯•æ‰ä¼šæ‰§è¡Œã€‚æ‰€æœ‰å†…å±‚ <code>finally</code> å—æ‰§è¡Œå®Œæ¯•ä¹‹åï¼ŒåŒ¹é…å¼‚å¸¸çš„é‚£ä¸ª <code>catch</code> å—ä¸­çš„ä»£ç æ‰å¼€å§‹æ‰§è¡Œã€‚C# å…è®¸åœ¨æ•æ‰ç±»å‹åæŒ‡å®šä¸€ä¸ªå˜é‡ã€‚æ•æ‰åˆ°å¼‚å¸¸æ—¶ï¼Œè¯¥å˜é‡å°†å¼•ç”¨æŠ›å‡ºçš„ <code>System.Exception</code> æ´¾ç”Ÿå¯¹è±¡ã€‚ <code>catch</code> å—çš„ä»£ç å¯é€šè¿‡å¼•ç”¨è¯¥å˜é‡æ¥è®¿é—®å¼‚å¸¸çš„å…·ä½“ä¿¡æ¯ã€‚è™½ç„¶è¿™ä¸ªå¯¹è±¡å¯ä»¥ä¿®æ”¹ï¼Œä½†æœ€å¥½ä¸è¦è¿™ä¹ˆåšï¼Œè€Œåº”æŠŠå®ƒå½“æˆæ˜¯åªè¯»çš„ã€‚ <code>finally</code> å—åŒ…å«çš„æ˜¯ä¿è¯ä¼šæ‰§è¡Œçš„ä»£ç ã€‚ä¸€èˆ¬åœ¨ <code>finally</code> å—ä¸­æ‰§è¡Œ <code>try</code> å—çš„è¡ŒåŠ¨æ‰€è¦æ±‚çš„èµ„æºæ¸…ç†æ“ä½œã€‚ç»ˆæ­¢çº¿ç¨‹æˆ–å¸è½½ AppDomain ä¼šé€ æˆ CLR æŠ›å‡ºä¸€ä¸ª <code>ThreadAbortException</code> ï¼Œä½¿ <code>finally</code> å—èƒ½å¤Ÿæ‰§è¡Œã€‚å¦‚æœç›´æ¥ç”¨ Win32 å‡½æ•° <code>TerminateThread</code> æ€æ­»çº¿ç¨‹ï¼Œæˆ–è€…ç”¨ Win32 å‡½æ•° <code>TerminateProcess</code> æˆ– <code>System.Environment</code> çš„ <code>FailFast</code> æ–¹æ³•æ€æ­»è¿›ç¨‹ï¼Œ <code>finally</code> å—ä¸ä¼šæ‰§è¡Œã€‚å½“ç„¶ï¼Œè¿›ç¨‹ç»ˆæ­¢åï¼Œ Windows ä¼šæ¸…ç†è¯¥è¿›ç¨‹ä½¿ç”¨çš„æ‰€æœ‰èµ„æºã€‚å³ä½¿ <code>catch</code> æˆ– <code>finally</code> å—å†…éƒ¨æŠ›å‡ºäº†å¼‚å¸¸ä¹Ÿä¸æ˜¯ä¸–ç•Œæœ«æ—¥ â€”â€” CLR çš„å¼‚å¸¸æœºåˆ¶ä»ä¼šæ­£å¸¸è¿è½¬ï¼Œå¥½åƒå¼‚å¸¸æ˜¯åœ¨ <code>finally</code> å—ä¹‹åæŠ›å‡ºçš„ç¬¬ä¸€ä¸ªå¼‚å¸¸ï¼Œå…³äºç¬¬ä¸€ä¸ªå¼‚å¸¸çš„æ‰€æœ‰ä¿¡æ¯ (ä¾‹å¦‚å †æ ˆè·Ÿè¸ª) éƒ½å°†ä¸¢å¤±<br>ã€‚è¿™ä¸ªæ–°å¼‚å¸¸å¯èƒ½ (è€Œä¸”ææœ‰å¯èƒ½) ä¸ä¼šç”±ä½ çš„ä»£ç å¤„ç†ï¼Œæœ€ç»ˆå˜æˆä¸€ä¸ªæœªå¤„ç†çš„å¼‚å¸¸ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒCLR ä¼šç»ˆæ­¢ä½ çš„è¿›ç¨‹ã€‚è¿™æ˜¯ä»¶å¥½äº‹æƒ…ï¼Œå› ä¸ºæŸåçš„æ‰€æœ‰çŠ¶æ€ç°åœ¨éƒ½ä¼šè¢«é”€æ¯ã€‚ç›¸è¾ƒäºè®©åº”ç”¨ç¨‹åºç»§ç»­è¿è¡Œï¼Œé€ æˆä¸å¯é¢„çŸ¥çš„ç»“æœä»¥åŠå¯èƒ½çš„å®‰å…¨æ¼æ´ï¼Œè¿™æ ·å¤„ç†è¦å¥½å¾—å¤šã€‚</p><h2 id="the-systemexception-class"><a class="anchor" href="#the-systemexception-class">#</a> The System.Exception Class</h2><blockquote><p>The CLR allows an instance of any type to be thrown for an exceptionâ€”from an Int32 to a String and beyond. However, Microsoft decided against forcing all programming languages to throw and catch exceptions of any type, so they defined the System.Exception type and decreed that all CLScompliant programming languages must be able to throw and catch exceptions whose type is derived from this type. Exception types that are derived from System.Exception are said to be CLS-compliant. C# and many other language compilers allow your code to throw only CLS-compliant exceptions.</p></blockquote><blockquote><p>The System.Exception type is a very simple type that contains the properties described in Table 20-1. Usually, you will not write any code to query or access these properties in any way. Instead, when your application terminates due to an unhandled exception, you will look at these properties in the debugger or in a report that gets generated and written out to the Windows Application event log or crash dump.</p></blockquote><p><img data-src="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/image-20221124111323255.png" alt="image-20221124111323255"></p><p><img data-src="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/image-20221124111347671.png" alt="image-20221124111347671"></p><blockquote><p>Iâ€™d like to say a few words about System.Exceptionâ€™s read-only StackTrace property. A catch block can read this property to obtain the stack trace indicating what methods were called that led up to the exception. This information can be extremely valuable when youâ€™re trying to detect the cause of an exception so that you can correct your code. When you access this property, youâ€™re actually calling into code in the CLR; the property doesnâ€™t simply return a string. When you construct a new object of an Exception-derived type, the StackTrace property is initialized to null. If you were to read the property, you wouldnâ€™t get back a stack trace; you would get back null.</p></blockquote><blockquote><p>When an exception is thrown, the CLR internally records where the throw instruction occurred. When a catch block accepts the exception, the CLR records where the exception was caught. If, inside a catch block, you now access the thrown exception objectâ€™s StackTrace property, the code that implements the property calls into the CLR, which builds a string identifying all of the methods between the place where the exception was thrown and the filter that caught the exception.</p></blockquote><p>ğŸ’¡é‡è¦æç¤ºï¼šæŠ›å‡ºå¼‚å¸¸æ—¶ï¼ŒCLR ä¼šé‡ç½®å¼‚å¸¸èµ·ç‚¹ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼ŒCLR åªè®°å½•æœ€æ–°çš„å¼‚å¸¸å¯¹è±¡çš„æŠ›å‡ºä½ç½®ã€‚</p><blockquote><p>The following code throws the same exception object that it caught and causes the CLR to reset its starting point for the exception.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token range operator">..</span><span class="token punctuation">.</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token comment">// CLR thinks this is where exception originated. </span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// FxCop reports this as an error </span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>In contrast, if you re-throw an exception object by using the throw keyword by itself, the CLR doesnâ€™t reset the stackâ€™s starting point. The following code re-throws the same exception object that it caught, causing the CLR to not reset its starting point for the exception.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token range operator">..</span><span class="token punctuation">.</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">throw</span><span class="token punctuation">;</span> <span class="token comment">// This has no effect on where the CLR thinks the exception </span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// originated. FxCop does NOT report this as an error </span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>In fact, the only difference between these two code fragments is what the CLR thinks is the original location where the exception was thrown. Unfortunately, when you throw or re-throw an exception, Windows does reset the stackâ€™s starting point. So if the exception becomes unhandled, the stack location that gets reported to Windows Error Reporting is the location of the last throw or re-throw, even though the CLR knows the stack location where the original exception was thrown. This is unfortunate because it makes debugging applications that have failed in the field much more difficult. Some developers have found this so intolerable that they have chosen a different way to implement their code to ensure that the stack trace truly reflects the location where an exception was originally thrown.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name">Boolean</span> trySucceeds <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token range operator">..</span><span class="token punctuation">.</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> trySucceeds <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trySucceeds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* catch code goes in here */</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The string returned from the StackTrace property doesnâ€™t include any of the methods in the call stack that are above the point where the catch block accepted the exception object. If you want the complete stack trace from the start of the thread up to the exception handler, you can use the System.Diagnostics.StackTrace type. This type defines some properties and methods that allow a developer to programmatically manipulate a stack trace and the frames that make up the stack trace.</p></blockquote><blockquote><p>You can construct a StackTrace object by using several different constructors. Some constructors build the frames from the start of the thread to the point where the StackTrace object is constructed. Other constructors initialize the frames of the StackTrace object by using an Exceptionderived object passed as an argument.</p></blockquote><blockquote><p>If the CLR can find debug symbols (located in the .pdb files) for your assemblies, the string returned by System.Exceptionâ€™s StackTrace property or System.Diagnostics.StackTraceâ€™s ToString method will include source code file paths and line numbers. This information is incredibly useful for debugging.</p></blockquote><blockquote><p>Whenever you obtain a stack trace, you might find that some methods in the actual call stack donâ€™t appear in the stack trace string. There are two reasons for this. First, the stack is really a record of where the thread should return to, not where the thread has come from. Second, the just-in-time (JIT) compiler can inline methods to avoid the overhead of calling and returning from a separate method. Many compilers (including the C# compiler) offer a /debug command-line switch. When this switch is used, these compilers embed information into the resulting assembly to tell the JIT compiler not to inline any of the assemblyâ€™s methods, making stack traces more complete and meaningful to the developer debugging the code.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šJIT ç¼–è¯‘å™¨ä¼šæ£€æŸ¥åº”ç”¨äºç¨‹åºé›†çš„ <code>System.Diagnostics.Debuggabletrribute</code> å®šåˆ¶ç‰¹æ€§ã€‚C# ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åº”ç”¨è¯¥ç‰¹æ€§ã€‚å¦‚æœè¯¥ç‰¹æ€§æŒ‡å®šäº† <code>DisableOptimizations</code> æ ‡å¿—ï¼ŒJIT ç¼–è¯‘å™¨å°±ä¸ä¼šå¯¹ç¨‹åºé›†çš„æ–¹æ³•è¿›è¡Œå†…è”ã€‚ä½¿ç”¨ C# ç¼–è¯‘å™¨çš„ <code>/debug</code> å¼€å…³å°±ä¼šè®¾ç½®è¿™ä¸ªæ ‡å¿—ã€‚å¦å¤–ï¼Œå‘æ–¹æ³•åº”ç”¨å®šåˆ¶ç‰¹æ€§ <code>System.Runtime.CompilerServices.MethodImplAttribute</code> å°†ç¦æ­¢ JIT ç¼–è¯‘å™¨åœ¨è°ƒè¯•å’Œå‘å¸ƒç”Ÿæˆ (debug and release build) æ—¶å¯¹è¯¥æ–¹æ³•è¿›è¡Œå†…è”å¤„ç†ï¼Œä»¥ä¸‹æ–¹æ³•å®šä¹‰ç¤ºèŒƒäº†å¦‚ä½•ç¦æ­¢æ–¹æ³•å†…è”ï¼š</p><pre><code class="language-C#">using System;
using System.Runtime.CompilerServices;

internal sealed class SomeType &#123;
    
    [MethodImpl(MethodImplOptions.NoInlining)]
    public void SomeMethod() &#123;
        ...
    &#125;
&#125;
</code></pre><p>ğŸ’¡å°ç»“ï¼šCLR å…è®¸å¼‚å¸¸æŠ›å‡ºä»»ä½•ç±»å‹çš„å®ä¾‹ â€”â€” ä» <code>Int32</code> åˆ° <code>String</code> éƒ½å¯ä»¥ã€‚è€Œ C# å®šä¹‰äº† <code>System.Exception</code> ç±»å‹ï¼Œå¹¶è§„å®šæ‰€æœ‰ CLS ç›¸å®¹çš„ç¼–ç¨‹è¯­è¨€éƒ½å¿…é¡»èƒ½æŠ›å‡ºå’Œæ•æ‰æ´¾ç”Ÿè‡ªè¯¥ç±»å‹çš„å¼‚å¸¸ã€‚æ´¾ç”Ÿè‡ª <code>System.Exception</code> çš„å¼‚å¸¸ç±»å‹è¢«è®¤ä¸ºæ˜¯ CLS ç›¸å®¹çš„ã€‚C# å’Œå…¶ä»–è®¸å¤šè¯­è¨€çš„ç¼–è¯‘å™¨éƒ½åªå…è®¸æŠ›å‡º CLS ç›¸å®¹çš„å¼‚å¸¸ã€‚ <code>System.Exception</code> å®šä¹‰äº†ä¸€äº›å±æ€§ã€‚ä½†ä¸€èˆ¬ä¸è¦å†™ä»»ä½•ä»£ç ä»¥ä»»ä½•æ–¹å¼æŸ¥è¯¢æˆ–è®¿é—®è¿™äº›å±æ€§ã€‚ç›¸åï¼Œå½“åº”ç”¨ç¨‹åºå› ä¸ºæœªå¤„ç†çš„å¼‚å¸¸è€Œç»ˆæ­¢æ—¶ï¼Œå¯ä»¥åœ¨è°ƒè¯•å™¨ä¸­æŸ¥çœ‹è¿™äº›å±æ€§ï¼Œæˆ–è€…åœ¨ Windows åº”ç”¨ç¨‹åºäº‹ä»¶æ—¥å¿—æˆ–å´©æºƒè½¬å‚¨ (crash dump) ä¸­æŸ¥çœ‹ã€‚æ„é€  <code>Exception</code> æ´¾ç”Ÿç±»å‹çš„æ–°å¯¹è±¡æ—¶ï¼Œ <code>StackTrace</code> å±æ€§è¢«åˆå§‹åŒ–ä¸º <code>null</code> ã€‚å¦‚æœæ­¤æ—¶è¯»å–è¯¥å±æ€§ï¼Œå¾—åˆ°çš„ä¸æ˜¯å †æ ˆè·Ÿè¸ªï¼Œè€Œæ˜¯ä¸€ä¸ª <code>null</code> ã€‚ä¸€ä¸ªå¼‚å¸¸æŠ›å‡ºæ—¶ï¼ŒCLR åœ¨å†…éƒ¨è®°å½• <code>throw</code> æŒ‡ä»¤çš„ä½ç½® (æŠ›å‡ºä½ç½®)ã€‚ä¸€ä¸ª <code>catch</code> å—æ•æ‰åˆ°è¯¥å¼‚å¸¸æ—¶ï¼ŒCLR è®°å½•æ•æ‰ä½ç½®ã€‚åœ¨ <code>catch</code> å—å†…è®¿é—®è¢«æŠ›å‡ºçš„å¼‚å¸¸å¯¹è±¡çš„ <code>StackTrace</code> å±æ€§ï¼Œè´Ÿè´£å®ç°è¯¥å±æ€§çš„ä»£ç ä¼šè°ƒç”¨ CLR å†…éƒ¨çš„ä»£ç ï¼Œåè€…åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²æ¥æŒ‡å‡ºä»å¼‚å¸¸æŠ›å‡ºä½ç½®åˆ°å¼‚å¸¸æ•æ‰ä½ç½®çš„æ‰€æœ‰æ–¹æ³•ã€‚ä½†å¦‚æœä»…ä»…ä½¿ç”¨ <code>throw</code> å…³é”®å­—æœ¬èº« (åˆ é™¤åé¢çš„ <code>e</code> ) æ¥é‡æ–°æŠ›å‡ºå¼‚å¸¸å¯¹è±¡ï¼ŒCLR å°±ä¸ä¼šé‡ç½®å †æ ˆçš„èµ·ç‚¹ã€‚ä»¥ä¸‹ä»£ç é‡æ–°æŠ›å‡ºå®ƒæ•æ‰åˆ°çš„å¼‚å¸¸ï¼Œä½†ä¸ä¼šå¯¼è‡´ CLR é‡ç½®èµ·ç‚¹ã€‚é—æ†¾çš„æ˜¯ï¼Œä¸ç®¡æŠ›å‡ºè¿˜æ˜¯é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼ŒWindows éƒ½ä¼šé‡ç½®æ ˆçš„èµ·ç‚¹ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªå¼‚å¸¸æˆä¸ºæœªå¤„ç†çš„å¼‚å¸¸ï¼Œé‚£ä¹ˆå‘ Windows Error Reporting æŠ¥å‘Šçš„æ ˆä½ç½®å°±æ˜¯æœ€åä¸€æ¬¡æŠ›å‡ºæˆ–é‡æ–°æŠ›å‡ºçš„ä½ç½® (å³ä½¿ CLR çŸ¥é“å¼‚å¸¸çš„åŸå§‹æŠ›å‡ºä½ç½®)ã€‚ <code>StackTrace</code> å±æ€§è¿”å›çš„å­—ç¬¦ä¸²ä¸åŒ…å«è°ƒç”¨æ ˆä¸­æ¯”è¾ƒå—å¼‚å¸¸å¯¹è±¡çš„é‚£ä¸ª <code>catch</code> å—é«˜çš„ä»»ä½•æ–¹æ³•ï¼ˆæ ˆé¡¶ç§»åŠ¨å³ â€œå‡é«˜â€ï¼Œå‘æ ˆåº•ç§»åŠ¨å³ â€œé™ä½â€ï¼‰ã€‚è¦è·å¾—ä»çº¿ç¨‹èµ·å§‹å¤„åˆ°å¼‚å¸¸å¤„ç†ç¨‹åºï¼ˆcatch å—ï¼‰ä¹‹é—´çš„å®Œæ•´å †æ ˆè¿½è¸ªï¼Œéœ€è¦ä½¿ç”¨ <code>System.Diagnostics.StackTrace</code> ç±»å‹ã€‚è¯¥ç±»å‹å®šä¹‰äº†ä¸€äº›å±æ€§å’Œæ–¹æ³•ï¼Œå…è®¸å¼€å‘äººå‘˜ç¨‹åºåŒ–åœ°å¤„ç†å †æ ˆè·Ÿè¸ªä»¥åŠæ„æˆå †æ ˆè·Ÿè¸ªçš„æ ˆæ¡¢ï¼ˆæ ˆæ¡¢ (stack frame) ä»£è¡¨å½“å‰çº¿ç¨‹çš„è°ƒç”¨æ ˆä¸­çš„ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ã€‚æ‰§è¡Œçº¿ç¨‹çš„è¿‡ç¨‹ä¸­è¿›è¡Œçš„æ¯ä¸ªæ–¹æ³•è°ƒç”¨éƒ½ä¼šåœ¨è°ƒç”¨æ ˆä¸­åˆ›å»ºå¹¶å‹å…¥ä¸€ä¸ª <code>StackFrame</code> ï¼‰ã€‚å¦‚æœ CLR èƒ½æ‰¾åˆ°ä½ çš„ç¨‹åºé›†çš„è°ƒè¯•ç¬¦å· (å­˜å‚¨åœ¨.pdb æ–‡ä»¶ä¸­)ï¼Œé‚£ä¹ˆåœ¨ <code>System.Exception</code> çš„ <code>StackTrace</code> å±æ€§æˆ–è€… <code>System.Diagnostics.StackTrace</code> çš„ <code>ToString</code> æ–¹æ³•è¿”å›çš„å­—ç¬¦ä¸²ä¸­ï¼Œå°†åŒ…æ‹¬æºä»£ç æ–‡ä»¶è·¯å¾„å’Œä»£ç è¡Œå·ï¼Œè¿™äº›ä¿¡æ¯å¯¹äºè°ƒè¯•æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚è·å¾—å †æ ˆè·Ÿè¸ªåï¼Œå¯èƒ½å‘ç°å®é™…è°ƒç”¨æ ˆä¸­çš„ä¸€äº›æ–¹æ³•æ²¡æœ‰å‡ºç°åœ¨å †æ ˆè·Ÿè¸ªå­—ç¬¦ä¸²ä¸­ã€‚è¿™å¯èƒ½æœ‰ä¸¤æ–¹é¢çš„åŸå› ã€‚é¦–å…ˆï¼Œè°ƒç”¨æ ˆè®°å½•çš„æ˜¯çº¿ç¨‹çš„è¿”å›ä½ç½® (è€Œéæ¥æºä½ç½®)ã€‚å…¶æ¬¡ï¼Œ JIT ç¼–è¯‘å™¨å¯èƒ½è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå°†ä¸€äº›æ–¹æ³•å†…è” (inline)ï¼Œä»¥é¿å…è°ƒç”¨å•ç‹¬çš„æ–¹æ³•å¹¶ä»ä¸­è¿”å›çš„å¼€é”€ã€‚è®¸å¤šç¼–è¯‘å™¨ (åŒ…æ‹¬ C# ç¼–è¯‘å™¨) éƒ½æ”¯æŒ <code>/debug</code> å‘½ä»¤è¡Œå¼€å…³ã€‚ä½¿ç”¨è¿™ä¸ªå¼€å…³ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç”Ÿæˆçš„ç¨‹åºé›†ä¸­åµŒå…¥ä¿¡æ¯ï¼Œå‘Šè¯‰ JIT ç¼–è¯‘å™¨ä¸è¦å†…è”ç¨‹åºé›†çš„ä»»ä½•æ–¹æ³•ï¼Œç¡®ä¿è°ƒè¯•äººå‘˜è·å¾—æ›´å®Œæ•´ã€æ›´æœ‰æ„ä¹‰çš„å †æ ˆè·Ÿè¸ªã€‚</p><h2 id="fcl-defined-exception-classes"><a class="anchor" href="#fcl-defined-exception-classes">#</a> FCL-Defined Exception Classes</h2><blockquote><p>The Framework Class Library (FCL) defines many exception types (all ultimately derived from System. Exception). The following hierarchy shows the exception types defined in the MSCorLib.dll assembly; other assemblies define even more exception types. (The application used to obtain this hierarchy is shown in Chapter 23, â€œAssembly Loading and Reflection.â€)</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>System<span class="token punctuation">.</span>Exception</pre></td></tr><tr><td data-num="2"></td><td><pre> System<span class="token punctuation">.</span>AggregateException</pre></td></tr><tr><td data-num="3"></td><td><pre> System<span class="token punctuation">.</span>ApplicationException</pre></td></tr><tr><td data-num="4"></td><td><pre>     System<span class="token punctuation">.</span>Reflection<span class="token punctuation">.</span>InvalidFilterCriteriaException</pre></td></tr><tr><td data-num="5"></td><td><pre>     System<span class="token punctuation">.</span>Reflection<span class="token punctuation">.</span>TargetException</pre></td></tr><tr><td data-num="6"></td><td><pre>     System<span class="token punctuation">.</span>Reflection<span class="token punctuation">.</span>TargetInvocationException</pre></td></tr><tr><td data-num="7"></td><td><pre>     System<span class="token punctuation">.</span>Reflection<span class="token punctuation">.</span>TargetParameterCountException</pre></td></tr><tr><td data-num="8"></td><td><pre>     System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>WaitHandleCannotBeOpenedException</pre></td></tr><tr><td data-num="9"></td><td><pre> System<span class="token punctuation">.</span>Diagnostics<span class="token punctuation">.</span>Tracing<span class="token punctuation">.</span>EventSourceException</pre></td></tr><tr><td data-num="10"></td><td><pre> System<span class="token punctuation">.</span>InvalidTimeZoneException</pre></td></tr><tr><td data-num="11"></td><td><pre> System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>IsolatedStorage<span class="token punctuation">.</span>IsolatedStorageException</pre></td></tr><tr><td data-num="12"></td><td><pre> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>LockRecursionException</pre></td></tr><tr><td data-num="13"></td><td><pre> System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>CompilerServices<span class="token punctuation">.</span>RuntimeWrappedException</pre></td></tr><tr><td data-num="14"></td><td><pre> System<span class="token punctuation">.</span>SystemException</pre></td></tr><tr><td data-num="15"></td><td><pre>     System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>AbandonedMutexException</pre></td></tr><tr><td data-num="16"></td><td><pre>     System<span class="token punctuation">.</span>AccessViolationException</pre></td></tr><tr><td data-num="17"></td><td><pre>     System<span class="token punctuation">.</span>Reflection<span class="token punctuation">.</span>AmbiguousMatchException</pre></td></tr><tr><td data-num="18"></td><td><pre>     System<span class="token punctuation">.</span>AppDomainUnloadedException</pre></td></tr><tr><td data-num="19"></td><td><pre>     System<span class="token punctuation">.</span>ArgumentException</pre></td></tr><tr><td data-num="20"></td><td><pre>         System<span class="token punctuation">.</span>ArgumentNullException</pre></td></tr><tr><td data-num="21"></td><td><pre>         System<span class="token punctuation">.</span>ArgumentOutOfRangeException</pre></td></tr><tr><td data-num="22"></td><td><pre>         System<span class="token punctuation">.</span>Globalization<span class="token punctuation">.</span>CultureNotFoundException</pre></td></tr><tr><td data-num="23"></td><td><pre>         System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>DecoderFallbackException</pre></td></tr><tr><td data-num="24"></td><td><pre>         System<span class="token punctuation">.</span>DuplicateWaitObjectException</pre></td></tr><tr><td data-num="25"></td><td><pre>         System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>EncoderFallbackException</pre></td></tr><tr><td data-num="26"></td><td><pre>	 System<span class="token punctuation">.</span>ArithmeticException</pre></td></tr><tr><td data-num="27"></td><td><pre>         System<span class="token punctuation">.</span>DivideByZeroException</pre></td></tr><tr><td data-num="28"></td><td><pre>         System<span class="token punctuation">.</span>NotFiniteNumberException</pre></td></tr><tr><td data-num="29"></td><td><pre>         System<span class="token punctuation">.</span>OverflowException</pre></td></tr><tr><td data-num="30"></td><td><pre>     System<span class="token punctuation">.</span>ArrayTypeMismatchException</pre></td></tr><tr><td data-num="31"></td><td><pre>     System<span class="token punctuation">.</span>BadImageFormatException</pre></td></tr><tr><td data-num="32"></td><td><pre>     System<span class="token punctuation">.</span>CannotUnloadAppDomainException</pre></td></tr><tr><td data-num="33"></td><td><pre>     System<span class="token punctuation">.</span>ContextMarshalException</pre></td></tr><tr><td data-num="34"></td><td><pre>     System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Cryptography<span class="token punctuation">.</span>CryptographicException</pre></td></tr><tr><td data-num="35"></td><td><pre> 	 	 System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Cryptography<span class="token punctuation">.</span>CryptographicUnexpectedOperationException</pre></td></tr><tr><td data-num="36"></td><td><pre>     System<span class="token punctuation">.</span>DataMisalignedException</pre></td></tr><tr><td data-num="37"></td><td><pre>     System<span class="token punctuation">.</span>ExecutionEngineException</pre></td></tr><tr><td data-num="38"></td><td><pre>     System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>ExternalException</pre></td></tr><tr><td data-num="39"></td><td><pre>         System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>COMException</pre></td></tr><tr><td data-num="40"></td><td><pre>         System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>SEHException</pre></td></tr><tr><td data-num="41"></td><td><pre> 	System<span class="token punctuation">.</span>FormatException</pre></td></tr><tr><td data-num="42"></td><td><pre> 		 System<span class="token punctuation">.</span>Reflection<span class="token punctuation">.</span>CustomAttributeFormatException</pre></td></tr><tr><td data-num="43"></td><td><pre>     System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>HostProtectionException</pre></td></tr><tr><td data-num="44"></td><td><pre>     System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Principal<span class="token punctuation">.</span>IdentityNotMappedException</pre></td></tr><tr><td data-num="45"></td><td><pre>     System<span class="token punctuation">.</span>IndexOutOfRangeException </pre></td></tr><tr><td data-num="46"></td><td><pre>     System<span class="token punctuation">.</span>InsufficientExecutionStackException</pre></td></tr><tr><td data-num="47"></td><td><pre>     System<span class="token punctuation">.</span>InvalidCastException</pre></td></tr><tr><td data-num="48"></td><td><pre>     System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>InvalidComObjectException</pre></td></tr><tr><td data-num="49"></td><td><pre>     System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>InvalidOleVariantTypeException</pre></td></tr><tr><td data-num="50"></td><td><pre>     System<span class="token punctuation">.</span>InvalidOperationException</pre></td></tr><tr><td data-num="51"></td><td><pre> 		 System<span class="token punctuation">.</span>ObjectDisposedException</pre></td></tr><tr><td data-num="52"></td><td><pre>     System<span class="token punctuation">.</span>InvalidProgramException</pre></td></tr><tr><td data-num="53"></td><td><pre>     System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>IOException</pre></td></tr><tr><td data-num="54"></td><td><pre>         System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>DirectoryNotFoundException</pre></td></tr><tr><td data-num="55"></td><td><pre>         System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>DriveNotFoundException</pre></td></tr><tr><td data-num="56"></td><td><pre>         System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>EndOfStreamException</pre></td></tr><tr><td data-num="57"></td><td><pre>         System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>FileLoadException</pre></td></tr><tr><td data-num="58"></td><td><pre>         System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>FileNotFoundException</pre></td></tr><tr><td data-num="59"></td><td><pre>         System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>PathTooLongException</pre></td></tr><tr><td data-num="60"></td><td><pre>     System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">.</span>KeyNotFoundException</pre></td></tr><tr><td data-num="61"></td><td><pre>     System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>MarshalDirectiveException</pre></td></tr><tr><td data-num="62"></td><td><pre>     System<span class="token punctuation">.</span>MemberAccessException</pre></td></tr><tr><td data-num="63"></td><td><pre>         System<span class="token punctuation">.</span>FieldAccessException</pre></td></tr><tr><td data-num="64"></td><td><pre>         System<span class="token punctuation">.</span>MethodAccessException</pre></td></tr><tr><td data-num="65"></td><td><pre>         System<span class="token punctuation">.</span>MissingMemberException</pre></td></tr><tr><td data-num="66"></td><td><pre>             System<span class="token punctuation">.</span>MissingFieldException</pre></td></tr><tr><td data-num="67"></td><td><pre>             System<span class="token punctuation">.</span>MissingMethodException</pre></td></tr><tr><td data-num="68"></td><td><pre>     System<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>MissingManifestResourceException</pre></td></tr><tr><td data-num="69"></td><td><pre>     System<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>MissingSatelliteAssemblyException</pre></td></tr><tr><td data-num="70"></td><td><pre>     System<span class="token punctuation">.</span>MulticastNotSupportedException</pre></td></tr><tr><td data-num="71"></td><td><pre>     System<span class="token punctuation">.</span>NotImplementedException</pre></td></tr><tr><td data-num="72"></td><td><pre>     System<span class="token punctuation">.</span>NotSupportedException</pre></td></tr><tr><td data-num="73"></td><td><pre>		 System<span class="token punctuation">.</span>PlatformNotSupportedException</pre></td></tr><tr><td data-num="74"></td><td><pre>     System<span class="token punctuation">.</span>NullReferenceException</pre></td></tr><tr><td data-num="75"></td><td><pre>     System<span class="token punctuation">.</span>OperationCanceledException</pre></td></tr><tr><td data-num="76"></td><td><pre>		 System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">.</span>TaskCanceledException</pre></td></tr><tr><td data-num="77"></td><td><pre>	 System<span class="token punctuation">.</span>OutOfMemoryException</pre></td></tr><tr><td data-num="78"></td><td><pre>		 System<span class="token punctuation">.</span>InsufficientMemoryException</pre></td></tr><tr><td data-num="79"></td><td><pre>     System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Policy<span class="token punctuation">.</span>PolicyException</pre></td></tr><tr><td data-num="80"></td><td><pre>     System<span class="token punctuation">.</span>RankException</pre></td></tr><tr><td data-num="81"></td><td><pre>     System<span class="token punctuation">.</span>Reflection<span class="token punctuation">.</span>ReflectionTypeLoadException</pre></td></tr><tr><td data-num="82"></td><td><pre>     System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Remoting<span class="token punctuation">.</span>RemotingException</pre></td></tr><tr><td data-num="83"></td><td><pre>		 System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Remoting<span class="token punctuation">.</span>RemotingTimeoutException</pre></td></tr><tr><td data-num="84"></td><td><pre>     System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>SafeArrayRankMismatchException</pre></td></tr><tr><td data-num="85"></td><td><pre>     System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>SafeArrayTypeMismatchException</pre></td></tr><tr><td data-num="86"></td><td><pre>     System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>SecurityException</pre></td></tr><tr><td data-num="87"></td><td><pre>     System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>SemaphoreFullException</pre></td></tr><tr><td data-num="88"></td><td><pre>     System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Serialization<span class="token punctuation">.</span>SerializationException</pre></td></tr><tr><td data-num="89"></td><td><pre>     System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Remoting<span class="token punctuation">.</span>ServerException</pre></td></tr><tr><td data-num="90"></td><td><pre>     System<span class="token punctuation">.</span>StackOverflowException</pre></td></tr><tr><td data-num="91"></td><td><pre>     System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>SynchronizationLockException</pre></td></tr><tr><td data-num="92"></td><td><pre>     System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>ThreadAbortException</pre></td></tr><tr><td data-num="93"></td><td><pre>     System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>ThreadInterruptedException</pre></td></tr><tr><td data-num="94"></td><td><pre>     System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>ThreadStartException</pre></td></tr><tr><td data-num="95"></td><td><pre>     System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>ThreadStateException</pre></td></tr><tr><td data-num="96"></td><td><pre>     System<span class="token punctuation">.</span>TimeoutException</pre></td></tr><tr><td data-num="97"></td><td><pre>     System<span class="token punctuation">.</span>TypeInitializationException</pre></td></tr><tr><td data-num="98"></td><td><pre>     System<span class="token punctuation">.</span>TypeLoadException</pre></td></tr><tr><td data-num="99"></td><td><pre>         System<span class="token punctuation">.</span>DllNotFoundException</pre></td></tr><tr><td data-num="100"></td><td><pre>         System<span class="token punctuation">.</span>EntryPointNotFoundException</pre></td></tr><tr><td data-num="101"></td><td><pre>         System<span class="token punctuation">.</span>TypeAccessException</pre></td></tr><tr><td data-num="102"></td><td><pre>     System<span class="token punctuation">.</span>TypeUnloadedException</pre></td></tr><tr><td data-num="103"></td><td><pre>     System<span class="token punctuation">.</span>UnauthorizedAccessException</pre></td></tr><tr><td data-num="104"></td><td><pre>		 System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>AccessControl<span class="token punctuation">.</span>PrivilegeNotHeldException</pre></td></tr><tr><td data-num="105"></td><td><pre>     System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>VerificationException</pre></td></tr><tr><td data-num="106"></td><td><pre>     System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>XmlSyntaxException</pre></td></tr><tr><td data-num="107"></td><td><pre> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">.</span>TaskSchedulerException</pre></td></tr><tr><td data-num="108"></td><td><pre> System<span class="token punctuation">.</span>TimeZoneNotFoundException</pre></td></tr></table></figure><p>ğŸ’¡å°ç»“ï¼šMicrosoft æœ¬æ¥æ˜¯æ‰“ç®—å°† <code>System.Exception</code> ç±»å‹ä½œä¸ºæ‰€æœ‰å¼‚å¸¸çš„åŸºç±»å‹ï¼Œè€Œå¦å¤–ä¸¤ä¸ªç±»å‹ <code>System.SystemException</code> å’Œ <code>System.ApplicationException</code> æ˜¯å”¯ä¸€ç›´æ¥ä» <code>Exception</code> æ´¾ç”Ÿçš„ç±»å‹ã€‚å¦å¤–ï¼ŒCLR æŠ›å‡ºçš„æ‰€æœ‰å¼‚å¸¸éƒ½ä» <code>SystemException</code> æ´¾ç”Ÿï¼Œåº”ç”¨ç¨‹åºæŠ›å‡ºçš„æ‰€æœ‰å¼‚å¸¸éƒ½ä» <code>ApplicationException</code> æ´¾ç”Ÿã€‚è¿™æ ·å°±å¯ä»¥å†™ä¸€ä¸ª <code>catch</code> å—æ¥æ•æ‰ CLR æŠ›å‡ºçš„æ‰€æœ‰å¼‚å¸¸æˆ–è€…åº”ç”¨ç¨‹åºæŠ›å‡ºçš„æ‰€æœ‰å¼‚å¸¸ã€‚ä½†å®é™…ä¸Šè§„åˆ™æ²¡æœ‰å¾—åˆ°ä¸¥æ ¼éµå®ˆï¼Œå› æ­¤ç»“æ„ä¸€å›¢ç³Ÿã€‚</p><h2 id="throwing-an-exception"><a class="anchor" href="#throwing-an-exception">#</a> Throwing an Exception</h2><blockquote><p>When implementing your own methods, you should throw an exception when the method cannot complete its task as indicated by its name. When you want to throw an exception, there are two issues that you really need to think about and consider.</p></blockquote><blockquote><p>The first issue is about which Exception-derived type you are going to throw. You really want to select a type that is meaningful here. Consider the code that is higher up the call stack and how that code might want to determine that a method failed in order to execute some graceful recovery code. You can use a type that is already defined in the FCL, but there may not be one in the FCL that matches your exact semantics. So youâ€™ll probably need to define your own type, ultimately derived from System.Exception.</p></blockquote><blockquote><p>If you want to define an exception type hierarchy, it is highly recommended that the hierarchy be shallow and wide in order to create as few base classes as possible. The reason is that base classes act as a way of treating lots of errors as one error, and this is usually dangerous. Along these lines, you should never throw a <code>System.Exception</code> object, and you should use extreme caution if you throw any other base class exception type.</p></blockquote><p>ğŸ’¡é‡è¦æç¤ºï¼šè¿˜è¦è€ƒè™‘ç‰ˆæœ¬é—®é¢˜ã€‚å¦‚æœå®šä¹‰ä»ç°æœ‰å¼‚å¸¸ç±»å‹æ´¾ç”Ÿçš„ä¸€ä¸ªæ–°å¼‚å¸¸ç±»å‹ï¼Œæ•æ‰ç°æœ‰åŸºç±»å‹çš„æ‰€æœ‰ä»£ç ä¹Ÿèƒ½æ•æ‰æ–°ç±»å‹ã€‚è¿™æœ‰æ—¶å¯èƒ½æ­£å¥½æ˜¯ä½ æœŸæœ›çš„ï¼Œä½†æœ‰æ—¶ä¹Ÿå¯èƒ½ä¸æ˜¯ï¼Œå…·ä½“å–å†³äºæ•æ‰åŸºç±»çš„ä»£ç ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼å“åº”å¼‚å¸¸ç±»å‹åŠå…¶æ´¾ç”Ÿç±»å‹ã€‚ä»æœªé¢„æ–™åˆ°ä¼šæœ‰æ–°å¼‚å¸¸çš„ä»£ç ç°åœ¨å¯èƒ½å‡ºç°éé¢„æœŸçš„è¡Œä¸ºï¼Œå¹¶å¯èƒ½ç•™ä¸‹å®‰å…¨éšæ‚£ã€‚è€Œå®šä¹‰æ–°å¼‚å¸¸ç±»å‹çš„äººä¸€èˆ¬ä¸çŸ¥é“åŸºå¼‚å¸¸çš„æ‰€æœ‰æ•æ‰ä½ç½®ä»¥åŠå…·ä½“å¤„ç†æ–¹å¼ã€‚æ‰€ä»¥è¿™é‡Œäº‹å®ä¸å¯èƒ½åšå‡ºé¢é¢ä¿±åˆ°çš„å†³å®šã€‚</p><blockquote><p>The second issue is about deciding what string message you are going to pass to the exception typeâ€™s constructor. When you throw an exception, you should include a string message with detailed information indicating why the method couldnâ€™t complete its task. If the exception is caught and handled, this string message is not seen. However, if the exception becomes an unhandled exception, this message is usually logged. An unhandled exception indicates a true bug in the application, and a developer must get involved to fix the bug. An end user will not have the source code or the ability to fix the code and recompile it. In fact, this string message should not be shown to an end user. So these string messages can be very technically detailed and as geeky as is necessary to help developers fix their code.</p></blockquote><blockquote><p>Furthermore, because all developers have to speak English (at least to some degree, because programming languages and the FCL classes and methods are in English), there is usually no need to localize exception string messages. However, you may want to localize the strings if you are building a class library that will be used by developers who speak different languages. Microsoft localizes the exception messages thrown by the FCL, because developers all over the world will be using this class library.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šå¼ºçƒˆå»ºè®®å®šä¹‰æµ…è€Œå®½çš„å¼‚å¸¸ç±»å‹å±‚æ¬¡ç»“æ„ &lt;sup&gt;â‘ &lt;/sup&gt;ï¼Œä»¥åˆ›å»ºå°½é‡å°‘çš„åŸºç±»ã€‚åŸå› æ˜¯åŸºç±»çš„ä¸»è¦ä½œç”¨å°±æ˜¯å°†å¤§é‡é”™è¯¯å½“ä½œä¸€ä¸ªé”™è¯¯ï¼Œè€Œè¿™é€šå¸¸æ˜¯å±é™©çš„ã€‚åŸºäºåŒæ ·çš„è€ƒè™‘ï¼Œæ°¸è¿œéƒ½ä¸è¦æŠ›å‡ºä¸€ä¸ª <code>System.Exception</code> å¯¹è±¡ &lt;sup&gt;â‘¡&lt;/sup&gt;ï¼ŒæŠ›å‡ºå…¶ä»–ä»»ä½•åŸºç±»å¼‚å¸¸ç±»å‹æ—¶ä¹Ÿè¦ç‰¹åˆ«è°¨æ…ã€‚å‘å¼‚å¸¸ç±»å‹ä¼ é€’çš„å­—ç¬¦ä¸²ä¿¡æ¯åº”è¯¦ç»†è¯´æ˜æ–¹æ³•ä¸ºä»€ä¹ˆæ— æ³•å®Œæˆä»»åŠ¡ã€‚å¦‚æœå¼‚å¸¸è¢«æ•æ‰åˆ°å¹¶è¿›è¡Œäº†å¤„ç†ï¼Œç”¨æˆ·å°±çœ‹ä¸åˆ°è¯¥å­—ç¬¦ä¸²çš„ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆä¸ºæœªå¤„ç†çš„å¼‚å¸¸ï¼Œæ¶ˆæ¯é€šå¸¸ä¼šè¢«å†™å…¥æ—¥å¿—ã€‚è¿™ä¸ªå­—ç¬¦ä¸²æ¶ˆæ¯æ ¹æœ¬ä¸åº”è¯¥å‘æœ€ç»ˆç”¨æˆ·æ˜¾å¼ï¼Œæ‰€ä»¥ï¼Œå­—ç¬¦ä¸²æ¶ˆæ¯å¯ä»¥åŒ…å«éå¸¸è¯¦ç»†çš„æŠ€æœ¯ç»†èŠ‚ï¼Œä»¥å¸®åŠ©å¼€å‘äººå‘˜ä¿®æ­£ä»£ç ã€‚</p><h2 id="defining-your-own-exception-class"><a class="anchor" href="#defining-your-own-exception-class">#</a> Defining Your Own Exception Class</h2><blockquote><p>Unfortunately, designing your own exception is tedious and error prone. The main reason for this is because all Exception-derived types should be serializable so that they can cross an AppDomain boundary or be written to a log or database. There are many issues related to serialization and they are discussed in Chapter 24, â€œRuntime Serialization.â€ So, in an effort to simplify things, I made my own generic Exception class, which is defined as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Serializable</span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Exception<span class="token punctuation">&lt;</span>TExceptionArgs<span class="token punctuation">></span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Exception</span><span class="token punctuation">,</span> <span class="token class-name">ISerializable</span></span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">where</span> <span class="token class-name">TExceptionArgs</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ExceptionArgs</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name">String</span> c_args <span class="token operator">=</span> <span class="token string">"Args"</span><span class="token punctuation">;</span> <span class="token comment">// For (de)serialization</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">TExceptionArgs</span> m_args<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">TExceptionArgs</span> Args <span class="token punctuation">&#123;</span> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> m_args<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token function">Exception</span><span class="token punctuation">(</span><span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">Exception</span> innerException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> innerException<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token function">Exception</span><span class="token punctuation">(</span><span class="token class-name">TExceptionArgs</span> args<span class="token punctuation">,</span> <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token class-name">Exception</span> innerException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> innerException<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> m_args <span class="token operator">=</span> args<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// This constructor is for deserialization; since the class is sealed, the constructor is</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// private. If this class were not sealed, this constructor should be protected </span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token punctuation">[</span><span class="token function">SecurityPermission</span><span class="token punctuation">(</span>SecurityAction<span class="token punctuation">.</span>LinkDemand<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre> Flags<span class="token operator">=</span>SecurityPermissionFlag<span class="token punctuation">.</span>SerializationFormatter<span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">private</span> <span class="token function">Exception</span><span class="token punctuation">(</span><span class="token class-name">SerializationInfo</span> info<span class="token punctuation">,</span> <span class="token class-name">StreamingContext</span> context<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> m_args <span class="token operator">=</span> <span class="token punctuation">(</span>TExceptionArgs<span class="token punctuation">)</span>info<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>c_args<span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TExceptionArgs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">// This method is for serialization; itâ€™s public because of the ISerializable interface</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token punctuation">[</span><span class="token function">SecurityPermission</span><span class="token punctuation">(</span>SecurityAction<span class="token punctuation">.</span>LinkDemand<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre> Flags<span class="token operator">=</span>SecurityPermissionFlag<span class="token punctuation">.</span>SerializationFormatter<span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">GetObjectData</span><span class="token punctuation">(</span><span class="token class-name">SerializationInfo</span> info<span class="token punctuation">,</span> <span class="token class-name">StreamingContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> info<span class="token punctuation">.</span><span class="token function">AddValue</span><span class="token punctuation">(</span>c_args<span class="token punctuation">,</span> m_args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">GetObjectData</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">String</span> Message <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token class-name">String</span> baseMsg <span class="token operator">=</span> <span class="token keyword">base</span><span class="token punctuation">.</span>Message<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token keyword">return</span> <span class="token punctuation">(</span>m_args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">?</span> baseMsg <span class="token punctuation">:</span> baseMsg <span class="token operator">+</span> <span class="token string">" ("</span> <span class="token operator">+</span> m_args<span class="token punctuation">.</span>Message <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token class-name">Exception<span class="token punctuation">&lt;</span>TExceptionArgs<span class="token punctuation">></span></span> other <span class="token operator">=</span> obj <span class="token keyword">as</span> <span class="token class-name">Exception<span class="token punctuation">&lt;</span>TExceptionArgs<span class="token punctuation">></span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>other <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>m_args<span class="token punctuation">,</span> other<span class="token punctuation">.</span>m_args<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>And the ExceptionArgs base class that TExceptionArgs is constrained to is very simple and looks like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Serializable</span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionArgs</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">String</span> Message <span class="token punctuation">&#123;</span> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> String<span class="token punctuation">.</span>Empty<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Now, with these two classes defined, I can trivially define more exception classes when I need to. To define an exception type indicating the disk is full, I simply do the following.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Serializable</span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">DiskFullExceptionArgs</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ExceptionArgs</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">String</span> m_diskpath<span class="token punctuation">;</span> <span class="token comment">// private field set at construction time</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token function">DiskFullExceptionArgs</span><span class="token punctuation">(</span><span class="token class-name">String</span> diskpath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> m_diskpath <span class="token operator">=</span> diskpath<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Public read-only property that returns the field</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> DiskPath <span class="token punctuation">&#123;</span> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> m_diskpath<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// Override the Message property to include our field (if set)</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">String</span> Message <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">return</span> <span class="token punctuation">(</span>m_diskpath <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token keyword">base</span><span class="token punctuation">.</span>Message <span class="token punctuation">:</span> <span class="token string">"DiskPath="</span> <span class="token operator">+</span> m_diskpath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>And, if I have no additional data that I want to put inside the class, it gets as simple as the following.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Serializable</span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">DiskFullExceptionArgs</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ExceptionArgs</span></span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>And now I can write code like this, which throws and catches one of these.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TestException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception<span class="token punctuation">&lt;</span>DiskFullExceptionArgs<span class="token punctuation">></span></span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DiskFullExceptionArgs</span><span class="token punctuation">(</span><span class="token string">@"C:\"), "</span>The disk <span class="token keyword">is</span> <span class="token class-name">full</span>"<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception<span class="token punctuation">&lt;</span>DiskFullExceptionArgs<span class="token punctuation">></span></span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>ğŸ’¡æ³¨æ„ï¼šæˆ‘çš„ <code>Exception&lt;TExceptionArgs&gt;</code> ç±»æœ‰ä¸¤ä¸ªé—®é¢˜éœ€è¦æ³¨æ„ã€‚ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œç”¨å®ƒå®šä¹‰çš„ä»»ä½•å¼‚å¸¸ç±»å‹éƒ½æ€»æ˜¯æ´¾ç”Ÿè‡ª <code>System.Exception</code> ã€‚è¿™åœ¨å¤§å¤šæ•°æ—¶å€™éƒ½ä¸æ˜¯é—®é¢˜ï¼Œè€Œä¸”æµ…è€Œå®½çš„å¼‚å¸¸ç±»å‹å±‚æ¬¡ç»“æ„è¿˜æ˜¯ä¸€ä»¶å¥½äº‹ã€‚ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼ŒVisual Studio çš„æœªå¤„ç†å¼‚å¸¸å¯¹è¯æ¡†ä¸ä¼šæ˜¾ç¤º <code>Exception&lt;T&gt;</code> ç±»å‹çš„æ³›å‹ç±»å‹å‚æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img data-src="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/image-20221125132316254.png" alt="image-20221125132316254"></p><p>ğŸ’¡å°ç»“ï¼šè®¾è®¡è‡ªå·±çš„å¼‚å¸¸ä¸ä»…ç¹çï¼Œè¿˜å®¹æ˜“å‡ºé”™ã€‚ä¸»è¦åŸå› æ˜¯ä» <code>Exception</code> æ´¾ç”Ÿçš„æ‰€æœ‰ç±»å‹éƒ½åº”è¯¥æ˜¯å¯åºåˆ—åŒ–çš„ï¼ˆserializableï¼‰ï¼Œä½¿å®ƒä»¬èƒ½ç©¿è¶Š <code>AppDomain</code> è¾¹ç•Œæˆ–è€…å†™å…¥æ—¥å¿— / æ•°æ®åº“ã€‚</p><h2 id="trading-reliability-for-productivity"><a class="anchor" href="#trading-reliability-for-productivity">#</a> Trading Reliability for Productivity</h2><blockquote><p>I started writing software in 1975. I did a fair amount of BASIC programming, and as I got more interested in hardware, I switched to assembly language. Over time, I switched to the C programming language because it allowed me access to hardware with a much higher level of abstraction, making my programming easier. My background is in writing operating systemsâ€™ code and platform/library code, so I always work hard to make my code as small and as fast as possible, because applications can only be as good as the operating system and libraries they consume.</p></blockquote><blockquote><p>In addition to creating small and fast code, I always focused on error recovery. When allocating memory (by using C++â€™s new operator or by calling malloc, HeapAlloc, VirtualAlloc, etc.), I would always check the return value to ensure that the memory I requested was actually given to me. And, if the memory request failed, I always had an alternate code path ensuring that the rest of the programâ€™s state was unaffected and would let any of my callers know that I failed so that the calling code can take corrective measures too.</p></blockquote><blockquote><p>For some reason that I canâ€™t quite explain, this attention to detail is not done when writing code for the .NET Framework. Getting an out-of-memory situation is always possible and yet I almost never see any code containing a catch block to recover from an OutOfMemoryException. In fact, Iâ€™ve even had some developers tell me that the CLR doesnâ€™t let a program catch an OutOfMemoryException. For the record, this is absolutely not true; you can catch this exception. In fact, there are many errors that are possible when executing managed code and I hardly ever see developers write code that attempts to recover from these potential failures. In this section, Iâ€™d like to point out some of the potential failures and why it has become culturally acceptable to ignore them. Iâ€™d also like to point out some of the significant problems that can occur when ignoring these failures and suggest some ways to help mitigate these problems.</p></blockquote><blockquote><p>Object-oriented programming allows developers to be very productive. A big part of this is composability which makes it easy to write, read and maintain code. Take this line of code, for example.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Boolean</span> f <span class="token operator">=</span> <span class="token string">"Jeff"</span><span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">EndsWith</span><span class="token punctuation">(</span><span class="token string">"E"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>There is a big assumption being made with the preceding code: no errors occur. But, of course, errors are always possible, and so we need a way to handle those errors. This is what the exception handling constructs and mechanisms are all about and why we need them as opposed to having methods that return true/false or an HRESULT to indicate success/failure the way that Win32 and COM functions do.</p></blockquote><blockquote><p>In addition to code composability, we are productive due to all kinds of great features provided by our compilers. For example, the compiler implicitly:</p><ul><li><p>Inserts optional parameters when calling a method.</p></li><li><p>Boxes value type instances.</p></li><li><p>Constructs/initializes parameter arrays.</p></li><li><p>Binds to members of dynamic variables and expressions.</p></li><li><p>Binds to extension methods.</p></li><li><p>Binds/invokes overloaded operators.</p></li><li><p>Constructs delegate objects.</p></li><li><p>Infers types when calling generic methods, declaring a local variable, and using a lambda expression.</p></li><li><p>Defines/constructs closure classes for lambda expressions and iterators.</p></li><li><p>Defines/constructs/initializes anonymous types and instances of them.</p></li><li><p>Rewrites code to support Language Integrated Queries (LINQs; query expressions and expression trees).</p></li></ul></blockquote><blockquote><p>And, the CLR itself does all kinds of great things for developers to make our lives even easier. For example, the CLR implicitly:</p><ul><li><p>Invokes virtual methods and interface methods.</p></li><li><p>Loads assemblies and JIT-compiles methods that can potentially throw FileLoadException, BadImageFormatException, InvalidProgramException, FieldAccessException, MethodAccessException, MissingFieldException, MissingMethodException, and VerificationException.</p></li><li><p>Transitions across AppDomain boundaries when accessing an object of a MarshalByRefObject-derived type which can potentially throw AppDomainUnloadedException.</p></li><li><p>Serializes and deserializes objects when crossing an AppDomain boundary.</p></li><li><p>Causes thread(s) to throw a ThreadAbortException when Thread.Abort or AppDomain.Unload is called.</p></li><li><p>Invokes Finalize methods after a garbage collection before objects have their memory reclaimed.</p></li><li><p>Creates type objects in the loader heap when using generic types.</p></li><li><p>Invokes a typeâ€™s static constructor potential throwing of TypeInitializationException.</p></li><li><p>Throws various exceptions, including OutOfMemoryException, DivideByZeroException, NullReferenceException, RuntimeWrappedException, TargetInvocationException, OverflowException, NotFiniteNumberException, ArrayTypeMismatchException, DataMisalignedException, IndexOutOfRangeException, InvalidCastException, RankException, SecurityException, and more.</p></li></ul></blockquote><blockquote><p>And, of course, the .NET Framework ships with a massive class library that contains tens of thousands of types, each type encapsulating common, reusable functionality. There are types for building web form applications, web services, rich GUI applications, working with security, manipulation of images, speech recognition, and the list goes on and on. Any of this code could throw an exception, indicating failure. And future versions could introduce new exception types derived from existing exception types and now your catch blocks catch exception types that never existed before.</p></blockquote><blockquote><p>All of this stuffâ€”object-oriented programming, compiler features, CLR features, and the enormous class libraryâ€”is what makes the .NET Framework such a compelling software development platform.4 My point is that all of this stuff introduces points of failure into your code, which you have little control over. As long as everything is working great, all is well: we write code easily, the code is easy to read and maintain. But, when something goes wrong, it is nearly impossible to fully understand what went wrong and why.</p></blockquote><blockquote><p>Here is an example that should really help get my point across.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Object</span> <span class="token function">OneStatement</span><span class="token punctuation">(</span><span class="token class-name">Stream</span> stream<span class="token punctuation">,</span> <span class="token class-name">Char</span> charToFind<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">return</span> <span class="token punctuation">(</span>charToFind <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> stream<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> String<span class="token punctuation">.</span>Empty <span class="token operator">+</span> <span class="token punctuation">(</span>stream<span class="token punctuation">.</span>Position <span class="token operator">+</span> <span class="token number">512M</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>c<span class="token operator">=></span>c <span class="token operator">==</span> charToFind<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>This slightly contrived method contains just one C# statement in it, but this statement does an awful lot of work. In fact, here is the Intermediate Language (IL) the C# compiler produced for this method. (Iâ€™ve put some lines in boldface italics that are potential points of failure due to implicit operations that are occurring.)</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">.</span>method <span class="token keyword">private</span> hidebysig <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">OneStatement</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">class</span> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span><span class="token class-name">System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>Stream</span> stream<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">char</span></span> charToFind<span class="token punctuation">)</span> <span class="token return-type class-name">cil</span> managed <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token punctuation">.</span>maxstack <span class="token number">4</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">.</span><span class="token return-type class-name">locals</span> init <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">class</span> <span class="token class-name">Program</span><span class="token operator">/</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token class-name">c__DisplayClass1</span> V_0<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> V_1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre> IL_0000<span class="token punctuation">:</span> newobj instance <span class="token keyword">void</span> Program<span class="token operator">/</span><span class="token operator">&lt;</span><span class="token operator">></span>c__DisplayClass1<span class="token punctuation">::</span><span class="token punctuation">.</span><span class="token function">ctor</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre> IL_0005<span class="token punctuation">:</span> stloc<span class="token punctuation">.</span><span class="token number">0</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> IL_0006<span class="token punctuation">:</span> ldloc<span class="token punctuation">.</span><span class="token number">0</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> IL_0007<span class="token punctuation">:</span> ldarg<span class="token punctuation">.</span><span class="token number">1</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> IL_0008<span class="token punctuation">:</span> stfld <span class="token keyword">char</span> Program<span class="token operator">/</span><span class="token operator">&lt;</span><span class="token operator">></span>c__DisplayClass1<span class="token punctuation">::</span><span class="token class-name">charToFind</span></pre></td></tr><tr><td data-num="12"></td><td><pre> IL_000d<span class="token punctuation">:</span> ldc<span class="token punctuation">.</span>i4<span class="token punctuation">.</span><span class="token number">5</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> IL_000e<span class="token punctuation">:</span> newarr <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span><span class="token class-name">System<span class="token punctuation">.</span>Object</span></pre></td></tr><tr><td data-num="14"></td><td><pre> IL_0013<span class="token punctuation">:</span> stloc<span class="token punctuation">.</span><span class="token number">1</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> IL_0014<span class="token punctuation">:</span> ldloc<span class="token punctuation">.</span><span class="token number">1</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> IL_0015<span class="token punctuation">:</span> ldc<span class="token punctuation">.</span>i4<span class="token punctuation">.</span><span class="token number">0</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> IL_0016<span class="token punctuation">:</span> ldloc<span class="token punctuation">.</span><span class="token number">0</span> </pre></td></tr><tr><td data-num="18"></td><td><pre> IL_0017<span class="token punctuation">:</span> ldfld <span class="token keyword">char</span> Program<span class="token operator">/</span><span class="token operator">&lt;</span><span class="token operator">></span>c__DisplayClass1<span class="token punctuation">::</span><span class="token class-name">charToFind</span></pre></td></tr><tr><td data-num="19"></td><td><pre> IL_001c<span class="token punctuation">:</span> box <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span><span class="token class-name">System<span class="token punctuation">.</span>Char</span></pre></td></tr><tr><td data-num="20"></td><td><pre> IL_0021<span class="token punctuation">:</span> <span class="token class-name">stelem<span class="token punctuation">.</span><span class="token keyword">ref</span></span> </pre></td></tr><tr><td data-num="21"></td><td><pre> IL_0022<span class="token punctuation">:</span> ldloc<span class="token punctuation">.</span><span class="token number">1</span> </pre></td></tr><tr><td data-num="22"></td><td><pre> IL_0023<span class="token punctuation">:</span> ldc<span class="token punctuation">.</span>i4<span class="token punctuation">.</span><span class="token number">1</span> </pre></td></tr><tr><td data-num="23"></td><td><pre> IL_0024<span class="token punctuation">:</span> ldstr <span class="token string">": "</span></pre></td></tr><tr><td data-num="24"></td><td><pre> IL_0029<span class="token punctuation">:</span> <span class="token class-name">stelem<span class="token punctuation">.</span><span class="token keyword">ref</span></span> </pre></td></tr><tr><td data-num="25"></td><td><pre> IL_002a<span class="token punctuation">:</span> ldloc<span class="token punctuation">.</span><span class="token number">1</span> </pre></td></tr><tr><td data-num="26"></td><td><pre> IL_002b<span class="token punctuation">:</span> ldc<span class="token punctuation">.</span>i4<span class="token punctuation">.</span><span class="token number">2</span> </pre></td></tr><tr><td data-num="27"></td><td><pre> IL_002c<span class="token punctuation">:</span> ldarg<span class="token punctuation">.</span><span class="token number">0</span> </pre></td></tr><tr><td data-num="28"></td><td><pre> IL_002d<span class="token punctuation">:</span> callvirt instance <span class="token keyword">class</span> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Type <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Object<span class="token punctuation">::</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre> IL_0032<span class="token punctuation">:</span> <span class="token class-name">stelem<span class="token punctuation">.</span><span class="token keyword">ref</span></span> </pre></td></tr><tr><td data-num="30"></td><td><pre> IL_0033<span class="token punctuation">:</span> ldloc<span class="token punctuation">.</span><span class="token number">1</span> </pre></td></tr><tr><td data-num="31"></td><td><pre> IL_0034<span class="token punctuation">:</span> ldc<span class="token punctuation">.</span>i4<span class="token punctuation">.</span><span class="token number">3</span> </pre></td></tr><tr><td data-num="32"></td><td><pre> IL_0035<span class="token punctuation">:</span> ldsfld <span class="token keyword">string</span> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>String<span class="token punctuation">::</span><span class="token class-name">Empty</span></pre></td></tr><tr><td data-num="33"></td><td><pre> IL_003a<span class="token punctuation">:</span> <span class="token class-name">stelem<span class="token punctuation">.</span><span class="token keyword">ref</span></span> </pre></td></tr><tr><td data-num="34"></td><td><pre> IL_003b<span class="token punctuation">:</span> ldloc<span class="token punctuation">.</span><span class="token number">1</span> </pre></td></tr><tr><td data-num="35"></td><td><pre> IL_003c<span class="token punctuation">:</span> ldc<span class="token punctuation">.</span>i4<span class="token punctuation">.</span><span class="token number">4</span> </pre></td></tr><tr><td data-num="36"></td><td><pre> IL_003d<span class="token punctuation">:</span> ldarg<span class="token punctuation">.</span><span class="token number">0</span></pre></td></tr><tr><td data-num="37"></td><td><pre> IL_003e<span class="token punctuation">:</span> callvirt instance int64 <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>Stream<span class="token punctuation">::</span><span class="token function">get_Position</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre> IL_0043<span class="token punctuation">:</span> call valuetype <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Decimal</pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Decimal<span class="token punctuation">::</span><span class="token function">op_Implicit</span><span class="token punctuation">(</span>int64<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre> IL_0048<span class="token punctuation">:</span> ldc<span class="token punctuation">.</span>i4 <span class="token number">0x200</span></pre></td></tr><tr><td data-num="41"></td><td><pre> IL_004d<span class="token punctuation">:</span> newobj instance <span class="token keyword">void</span> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Decimal<span class="token punctuation">::</span><span class="token punctuation">.</span><span class="token function">ctor</span><span class="token punctuation">(</span>int32<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre> IL_0052<span class="token punctuation">:</span> call valuetype <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Decimal <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Decimal<span class="token punctuation">::</span>op_Addition</pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token punctuation">(</span>valuetype <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Decimal<span class="token punctuation">,</span> valuetype <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Decimal<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre> IL_0057<span class="token punctuation">:</span> box <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span><span class="token class-name">System<span class="token punctuation">.</span>Decimal</span></pre></td></tr><tr><td data-num="45"></td><td><pre> IL_005c<span class="token punctuation">:</span> <span class="token class-name">stelem<span class="token punctuation">.</span><span class="token keyword">ref</span></span> </pre></td></tr><tr><td data-num="46"></td><td><pre> IL_005d<span class="token punctuation">:</span> ldloc<span class="token punctuation">.</span><span class="token number">1</span> </pre></td></tr><tr><td data-num="47"></td><td><pre> IL_005e<span class="token punctuation">:</span> call <span class="token keyword">string</span> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>String<span class="token punctuation">::</span><span class="token function">Concat</span><span class="token punctuation">(</span><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre> IL_0063<span class="token punctuation">:</span> ldloc<span class="token punctuation">.</span><span class="token number">0</span> </pre></td></tr><tr><td data-num="49"></td><td><pre> IL_0064<span class="token punctuation">:</span> ldftn instance <span class="token keyword">bool</span> Program<span class="token operator">/</span><span class="token operator">&lt;</span><span class="token operator">></span>c__DisplayClass1<span class="token punctuation">::</span><span class="token operator">&lt;</span>OneStatement<span class="token operator">></span><span class="token function">b__0</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre> IL_006a<span class="token punctuation">:</span> newobj instance </pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token keyword">void</span> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Func`<span class="token number">2</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token punctuation">.</span>ctor<span class="token class-name"><span class="token punctuation">(</span><span class="token keyword">object</span><span class="token punctuation">,</span> native <span class="token keyword">int</span><span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="52"></td><td><pre> IL_006f<span class="token punctuation">:</span> call <span class="token keyword">class</span> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">.</span>IEnumerable`<span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">!</span><span class="token number">0</span><span class="token operator">></span></pre></td></tr><tr><td data-num="53"></td><td><pre> <span class="token punctuation">[</span>System<span class="token punctuation">.</span>Core<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Linq<span class="token punctuation">.</span>Enumerable<span class="token punctuation">::</span><span class="token generic-method"><span class="token function">Where</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">char</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="54"></td><td><pre> <span class="token keyword">class</span> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">.</span>IEnumerable`<span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">!</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token keyword">class</span> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Func`<span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre> IL_0074<span class="token punctuation">:</span> call <span class="token operator">!</span><span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>Core</span></span><span class="token punctuation">]</span>System<span class="token punctuation">.</span>Linq<span class="token punctuation">.</span>Enumerable<span class="token punctuation">::</span><span class="token generic-method"><span class="token function">ToArray</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">char</span><span class="token punctuation">></span></span></span></pre></td></tr><tr><td data-num="57"></td><td><pre> <span class="token punctuation">(</span><span class="token keyword">class</span> <span class="token punctuation">[</span>mscorlib<span class="token punctuation">]</span>System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">.</span>IEnumerable`<span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">!</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre> IL_0079<span class="token punctuation">:</span> ret </pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>As you can see, an OutOfMemoryException is possible when constructing the &lt;&gt;c__DisplayClass1 class (a compiler-generated type), the Object[] array, the Func delegate, and boxing the char and Decimal. Memory is also allocated internally when Concat, Where, and ToArray are called. Constructing the Decimal instance could cause its type constructor to be invoked, resulting in a TypeInitializationException.5 And then, there are the implicit calls to Decimalâ€™s op_Implicit operator and its op_Addition operator methods, which could do anything, including throwing an OverflowException.</p></blockquote><blockquote><p>Querying Streamâ€™s Position property is interesting. First, it is a virtual property and so my OneStatement method has no idea what code will actually execute which could throw any exception at all. Second, Stream is derived from MarshalByRefObject, so the stream argument could actually refer to a proxy object which itself refers to an object in another AppDomain. The other AppDomain could be unloaded, so an AppDomainUnloadedException could also be thrown here.</p></blockquote><blockquote><p>Of course, all the methods that are being called are methods that I personally have no control over because they are produced by Microsoft. And itâ€™s entirely possible that Microsoft might change how these methods are implemented in the future, so they could throw new exception types that I could not possibly know about on the day I wrote the OneStatement method. How can I possibly write my OneStatement method to be completely robust against all possible failures? By the way, the opposite is also a problem: a catch block could catch an exception type derived from the specified exception type and now Iâ€™m executing recovery code for a different kind of failure.</p></blockquote><blockquote><p>So now that you have a sense of all the possible failures, you can probably see why it has become culturally acceptable to not write truly robust and reliable code: it is simply impractical. Moreover, one could argue that it is actually impossible. The fact that errors do not occur frequently is another reason why it has become culturally acceptable. Because errors (like OutOfMemoryException) occur very infrequently, the community has decided to trade truly reliable code for programmer productivity.</p></blockquote><blockquote><p>One of the nice things about exceptions is that an unhandled one causes your application to terminate. This is nice because during testing, you will discover problems quickly and the information you get with an unhandled exception (error message and stack trace) are usually enough to allow you to fix your code. Of course, a lot of companies donâ€™t want their application to just terminate after it has been tested and deployed, so a lot of developers insert code to catch System.Exception, the base class of all exception types. However, the problem with catching System.Exception and allowing the application to continue running is that state may be corrupted.</p></blockquote><blockquote><p>Earlier in this chapter, I showed an Account class that defines a Transfer method whose job is to transfer money from one account to another account. What if, when this Transfer method is called, it successfully subtracts money from the from account and then throws an exception before it adds money to the to account? If calling code catches System.Exception and continues running, then the state of the application is corrupted: both the from and to accounts have less money in them then they should. Because we are talking about money here, this state corruption wouldnâ€™t just be considered a simple bug, it would definitely be considered a security bug. If the application continues running, it will attempt to perform more transfers to and from various accounts and now state corruption is running rampant within the application.</p></blockquote><blockquote><p>One could say that the Transfer method itself should catch System.Exception and restore money back into the from account. And this might actually work out OK if the Transfer method is simple enough. But if the Transfer method produces an audit record of the withdrawn money or if other threads are manipulating the same account at the same time, then attempting to undo the operation could fail as well, producing yet another thrown exception. And now, state corruption is getting worse, not better.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šæœ‰äººæˆ–è®¸ä¼šè¯´ï¼ŒçŸ¥é“å“ªé‡Œå‡ºé”™ï¼Œæ¯”çŸ¥é“å‡ºäº†ä»€ä¹ˆé”™æ›´æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œæ›´æœ‰ç”¨çš„æ˜¯çŸ¥é“ä»ä¸€ä¸ªè´¦æˆ·è½¬è´¦å¤±è´¥ï¼Œè€Œä¸æ˜¯çŸ¥é“ <code>Transfer</code> ç”±äº <code>SecurityException</code> æˆ– <code>OutOfMemoryException</code> è€Œå¤±è´¥ã€‚äº‹å®ä¸Šï¼Œ Win32 é”™è¯¯æ¨¡å‹å°±æ˜¯è¿™ä¹ˆè®¾è®¡çš„ï¼Œæ–¹æ³•æ˜¯è¿”å› <code>true/false</code> æ¥æŒ‡æ˜æˆåŠŸ / å¤±è´¥ï¼Œä½¿ä½ çŸ¥é“å“ªä¸ªæ–¹æ³•å¤±è´¥ã€‚ç„¶åï¼Œå¦‚æœç¨‹åºå…³å¿ƒå¤±è´¥çš„åŸå› ï¼Œå¯è°ƒç”¨ Win32 å‡½æ•° <code>GetLastError</code> ã€‚ <code>System.Exception</code> ç¡®å®æœ‰ä¸€ä¸ª <code>Source</code> å±æ€§å¯ä»¥å‘Šè¯‰ä½ å¤±è´¥çš„æ–¹æ³•ã€‚ä½†è¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªä½ å¿…é¡»è¿›è¡Œè§£æçš„ <code>String</code> ï¼Œè€Œä¸”å‡å¦‚ä¸¤ä¸ªæ–¹æ³•åœ¨å†…éƒ¨è°ƒç”¨åŒä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå•å‡­ <code>Source</code> å±æ€§æ˜¯çœ‹ä¸å‡ºå“ªä¸ªæ–¹æ³•å¤±è´¥çš„ã€‚ç›¸åï¼Œå¿…é¡»è§£æä» <code>Exception</code> çš„ <code>StackTrace</code> å±æ€§è¿”å›çš„ <code>String</code> æ¥è·å–è¿™ä¸ªä¿¡æ¯ã€‚è¿™å®åœ¨æ˜¯å¤ªéš¾äº†ï¼Œæˆ‘ä»æœªè§è¿‡ä»»ä½•äººçœŸçš„å†™ä»£ç è¿™æ ·åšã€‚</p><blockquote><p>There are several things you can do to help mitigate state corruption:</p><ul><li>The CLR doesnâ€™t allow a thread to be aborted when executing code inside a catch or finally block. So, we could make the Transfer method more robust simply by doing the following.</li></ul></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Transfer</span><span class="token punctuation">(</span><span class="token class-name">Account</span> from<span class="token punctuation">,</span> <span class="token class-name">Account</span> to<span class="token punctuation">,</span> <span class="token class-name">Decimal</span> amount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* do nothing in here */</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> from <span class="token operator">-=</span> amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Now, a thread abort (due to Thread.Abort/AppDomain.Unload) canâ€™t happen here</span></pre></td></tr><tr><td data-num="6"></td><td><pre> to <span class="token operator">+=</span> amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>However, it is absolutely not recommended that you write all your code in finally blocks! You should only use this technique for modifying extremely sensitive state.</p><ul><li><p>You can use the System.Diagnostics.Contracts.Contract class to apply code contracts to your methods. Code contracts give you a way to validate arguments and other variables before you attempt to modify state by using these arguments/variables. If the arguments/ variables meet the contract, then the chance of corrupted state is minimized (not completely eliminated). If a contract fails, then an exception is thrown before any state has been modified. I will talk about code contracts later in this chapter.</p></li><li><p>You can use constrained execution regions (CERs), which give you a way to take some CLR uncertainty out of the picture. For example, before entering a try block, you can have the CLR load any assemblies needed by code in any associated catch and finally blocks. In addition, the CLR will compile all the code in the catch and finally blocks including all the methods called from within those blocks. This will eliminate a bunch of potential exceptions (including FileLoadException, BadImageFormatException, InvalidProgramException, FieldAccessException, MethodAccessException, MissingFieldException, and MissingMethodException) from occurring when trying to execute error recovery code (in catch blocks) or cleanup code (in the finally block). It will also reduce the potential for OutOfMemoryException and some other exceptions as well. I talk about CERs later in this chapter.</p></li><li><p>Depending on where the state lives, you can use transactions which ensure that all state is modified or no state is modified. If the data is in a database, for example, transactions work well. Windows also now supports transacted registry and file operations (on an NTFS volume only), so you might be able to use this; however, the .NET Framework doesnâ€™t expose this functionality directly today. You will have to P/Invoke to native code to leverage it. See the System.Transactions.TransactionScope class for more details about this.</p></li><li><p>You can design your methods to be more explicit. For example, the Monitor class is typically used for taking/releasing a thread synchronization lock as follows.</p></li></ul></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SomeType</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> s_myLockObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> SomeMethod <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>s_myLockObject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// If this throws, did the lock get taken or </span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// not? If it did, then it won't get released!</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// Do thread-safe operation here...</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>s_myLockObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// ...</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Due to the problem just shown, the overload of the preceding Monitorâ€™s Enter method used is now discouraged, and it is recommended that you rewrite the preceding code as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SomeType</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> s_myLockObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> SomeMethod <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name">Boolean</span> lockTaken <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// Assume the lock was not taken</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// This works whether an exception is thrown or not! </span></pre></td></tr><tr><td data-num="7"></td><td><pre> Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>s_myLockObject<span class="token punctuation">,</span> <span class="token keyword">ref</span> lockTaken<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Do thread-safe operation here...</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// If the lock was taken, release it</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>lockTaken<span class="token punctuation">)</span> Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>s_myLockObject<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token comment">// ...</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Although the explicitness in this code is an improvement, in the case of thread synchronization locks, the recommendation now is to not use them with exception handling at all. See Chapter 30, â€œHybrid Thread Synchronization Constructs,â€ for more details about this.</p></blockquote><blockquote><p>If, in your code, you have determined that state has already been corrupted beyond repair, then you should destroy any corrupted state so that it can cause no additional harm. Then, restart your application so your state initializes itself to a good condition and hopefully, the state corruption will not happen again. Because managed state cannot leak outside of an AppDomain, you can destroy any corrupted state that lives within an AppDomain by unloading the entire AppDomain by calling AppDomainâ€™s Unload method (see Chapter 22 for details).</p></blockquote><blockquote><p>And, if you feel that your state is so bad that the whole process should be terminated, then you can call Environmentâ€™s static FailFast method.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">FailFast</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">FailFast</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>This method terminates the process without running any active try/finally blocks or Finalize methods. This is good because executing more code while state is corrupted could easily make matters worse. However, FailFast will allow any CriticalFinalizerObject-derived objects, discussed in Chapter 21, â€œThe Managed Heap and Garbage Collection,â€ a chance to clean up. This is usually OK because they tend to just close native resources, and Windows state is probably fine even if the CLRâ€™s state or your applicationâ€™s state is corrupted. The FailFast method writes the message string and optional exception (usually the exception captured in a catch block) to the Windows Application event log, produces a Windows error report, creates a memory dump of your application, and then terminates the current process.</p></blockquote><p>ğŸ’¡é‡è¦æç¤ºï¼šå‘ç”Ÿæ„æ–™ä¹‹å¤–çš„å¼‚å¸¸æ—¶ï¼ŒMicrosoft çš„å¤§å¤šæ•° FCL ä»£ç éƒ½ä¸ä¿è¯çŠ¶æ€ä¿æŒè‰¯å¥½ã€‚å¦‚æœä½ çš„ä»£ç æ•æ‰ä» FCL ä»£ç é‚£é‡Œ â€œæ¼â€ è¿‡æ¥çš„å¼‚å¸¸å¹¶ç»§ç»­ä½¿ç”¨ FCL çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡çš„è¡Œä¸ºæœ‰å¯èƒ½å˜å¾—æ— æ³•é¢„æµ‹ã€‚ä»¤äººéš¾å ªçš„æ˜¯ï¼Œç°åœ¨è¶Šæ¥è¶Šå¤šçš„ FCL å¯¹è±¡åœ¨é¢å¯¹éé¢„æœŸçš„å¼‚å¸¸æ—¶ä¸èƒ½æ›´å¥½åœ°ç»´æŠ¤çŠ¶æ€æˆ–è€…åœ¨çŠ¶æ€æ— æ³•æ¢å¤æ—¶è°ƒç”¨ <code>FailFast</code> ã€‚</p><blockquote><p>The point of this discussion is to make you aware of the potential problems related to using the CLRâ€™s exception-handling mechanism. Most applications cannot tolerate running with a corrupted state because it leads to incorrect data and possible security holes. If you are writing an application that cannot tolerate terminating (like an operating system or database engine), then managed code is not a good technology to use. And although Microsoft Exchange Server is largely written in managed code, it uses a native database to store email messages. The native database is called the Extensible Storage Engine; it ships with Windows, and can usually be found at C:\Windows\System32\EseNT.dll. Your applications can also use this engine if youâ€™d like; search for â€œExtensible Storage Engineâ€ on the Microsoft MSDN website.</p></blockquote><blockquote><p>Managed code is a good choice for applications that can tolerate an application terminating when state corruption has possibly occurred. There are many applications that fall into this category. Also, it takes significantly more resources and skills to write a robust native class library or application; for many applications, managed code is the better choice because it greatly enhances programmer productivity.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šä¸ºä½•ä¸å»è¿½æ±‚å®Œå…¨å¥å£®å’Œå¯é çš„ä»£ç ï¼šå› ä¸ºä¸åˆ‡å®é™…ï¼ˆæ›´æç«¯çš„è¯´æ³•æ˜¯æ ¹æœ¬ä¸å¯èƒ½ï¼‰ã€‚ä¸å»è¿½æ±‚å®Œå…¨çš„å¥å£®æ€§å’Œå¯é æ€§ï¼Œå¦ä¸€ä¸ªåŸå› æ˜¯é”™è¯¯ä¸ç»å¸¸å‘ç”Ÿã€‚ç”±äºé”™è¯¯ï¼ˆæ¯”å¦‚ <code>OutOfMemoryException</code> ï¼‰åŠå…¶ç½•è§ï¼Œæ‰€ä»¥å¼€å‘äººå‘˜å†³å®šä¸å»è¿½æ±‚å®Œå…¨å¯é çš„ä»£ç ï¼Œç‰ºç‰²ä¸€å®šçš„å¯é æ€§æ¥æ¢å–ç¨‹åºå‘˜å¼€å‘æ•ˆç‡çš„æå‡ã€‚å¼‚å¸¸çš„å¥½å¤„åœ¨äºï¼Œæœªå¤„ç†çš„å¼‚å¸¸ä¼šé€ æˆåº”ç”¨ç¨‹åºç»ˆæ­¢ã€‚ä¹‹æ‰€ä»¥æ˜¯å¥½äº‹ï¼Œæ˜¯å› ä¸ºå¯åœ¨æµ‹è¯•æœŸé—´ææ—©å‘ç°é—®é¢˜ã€‚åˆ©ç”¨ç”±æœªå¤„ç†å¼‚å¸¸æä¾›çš„ä¿¡æ¯ï¼ˆé”™è¯¯ä¿¡æ¯å’Œå †æ ˆè¿½è¸ªï¼‰ï¼Œé€šå¸¸è¶³ä»¥å®Œæˆå¯¹ä»£ç çš„ä¿®æ­£ã€‚å½“ç„¶ï¼Œè®¸å¤šå…¬å¸ä¸å¸Œæœ›åº”ç”¨ç¨‹åºåœ¨æµ‹è¯•å’Œéƒ¨ç½²ä¹‹åè¿˜å‘ç”Ÿæ„å¤–ç»ˆæ­¢çš„æƒ…å†µï¼Œæ‰€ä»¥ä¼šæ’å…¥ä»£ç æ¥æ•æ‰ <code>System.Exception</code> ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰å¼‚å¸¸ç±»å‹çš„åŸºç±»ã€‚ä½†å¦‚æœæ•æ‰ <code>System.Exception</code> å¹¶å…è®¸åº”ç”¨ç¨‹åºç»§ç»­è¿è¡Œï¼Œä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜æ˜¯çŠ¶æ€å¯èƒ½é­å—ç ´åã€‚æ‰§è¡Œ <code>catch</code> æˆ– <code>finally</code> å—ä¸­çš„ä»£ç æ—¶ï¼ŒCLR ä¸å…è®¸çº¿ç¨‹ç»ˆæ­¢ã€‚ä½†ç»å¯¹ä¸å»ºè®®å°†æ‰€æœ‰ä»£ç éƒ½æ”¾åˆ° <code>finally</code> å—ä¸­ï¼è¿™ä¸ªæŠ€æœ¯åªé€‚åˆä¿®æ”¹æå…¶æ•æ„Ÿçš„çŠ¶æ€ã€‚å¯ä»¥ç”¨ <code>System.Diagnostics.Contrancts.Contract</code> ç±»å‘æ–¹æ³•åº”ç”¨ä»£ç åå®šã€‚é€šè¿‡ä»£ç åå®šï¼Œåœ¨ç”¨å®å‚å’Œå…¶ä»–å˜é‡å¯¹çŠ¶æ€è¿›è¡Œä¿®æ”¹ä¹‹å‰ï¼Œå¯ä»¥å…ˆå¯¹è¿™äº›å®å‚ / å˜é‡è¿›è¡ŒéªŒè¯ã€‚å¦‚æœå®å‚ / å˜é‡éµå®ˆåå®šï¼ŒçŠ¶æ€è¢«ç ´åçš„å¯èƒ½æ€§å°†å¤§å¹…é™ä½ (ä½†ä¸èƒ½å®Œå…¨æ¶ˆé™¤)ã€‚å¦‚æœä¸éµå®ˆåå®šï¼Œé‚£ä¹ˆå¼‚å¸¸ä¼šåœ¨ä»»ä½•çŠ¶æ€è¢«ä¿®æ”¹ä¹‹å‰æŠ›å‡ºã€‚å¯ä»¥ä½¿ç”¨çº¦æŸæ‰§è¡ŒåŒºåŸŸ (Constrained Execution Regionï¼ŒCER)ï¼Œå®ƒèƒ½æ¶ˆé™¤ CLR çš„æŸäº›ä¸ç¡®å®šæ€§ã€‚å–å†³äºçŠ¶æ€å­˜åœ¨äºä½•å¤„ï¼Œå¯åˆ©ç”¨äº‹åŠ¡ (transaction) æ¥ç¡®ä¿çŠ¶æ€è¦ä¹ˆéƒ½ä¿®æ”¹ï¼Œè¦ä¹ˆéƒ½ä¸ä¿®æ”¹ã€‚åœ¨ä½ çš„ä»£ç ä¸­ï¼Œå¦‚æœç¡®å®šçŠ¶æ€å·²æŸååˆ°æ— æ³•ä¿®å¤çš„ç¨‹åº¦ï¼Œå°±åº”é”€æ¯æ‰€æœ‰æŸåçš„çŠ¶æ€ï¼Œé˜²æ­¢å®ƒé€ æˆæ›´å¤šçš„ä¼¤å®³ã€‚ç„¶åï¼Œé‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œå°†çŠ¶æ€åˆå§‹åŒ–åˆ°è‰¯å¥½çŠ¶æ€ï¼Œå¹¶å¯„å¸Œæœ›äºçŠ¶æ€ä¸å†æŸåã€‚ç”±äºæ‰˜ç®¡çš„çŠ¶æ€æ³„éœ²ä¸åˆ° AppDomain çš„å¤–éƒ¨ï¼Œæ‰€ä»¥ä¸ºäº†é”€æ¯ AppDomain ä¸­æ‰€æœ‰æŸåçš„çŠ¶æ€ï¼Œå¯è°ƒç”¨ <code>AppDomain</code> çš„ <code>Unload</code> æ–¹æ³•æ¥å¸è½½æ•´ä¸ª AppDomainã€‚å¦‚æœè§‰å¾—çŠ¶æ€è¿‡äºç³Ÿç³•ï¼Œä»¥è‡³äºæ•´ä¸ªè¿›ç¨‹éƒ½åº”è¯¥ç»ˆæ­¢ï¼Œé‚£ä¹ˆåº”è¯¥è°ƒç”¨ <code>Environment</code> çš„é™æ€ <code>FailFast</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•åœ¨ç»ˆæ­¢è¿›ç¨‹æ—¶ï¼Œä¸ä¼šè¿è¡Œä»»ä½•æ´»åŠ¨çš„ <code>try/finally</code> å—æˆ–è€… <code>Finalize</code> æ–¹æ³•ã€‚ä¹‹æ‰€ä»¥è¿™æ ·åšï¼Œæ˜¯å› ä¸ºåœ¨çŠ¶æ€å·²æŸåçš„å‰æä¸‹æ‰§è¡Œæ›´å¤šçš„ä»£ç ï¼Œå¾ˆå®¹æ˜“ä½¿å±€é¢å˜å¾—æ›´åã€‚ä¸è¿‡ï¼Œ <code>FailFast</code> ä¸ºä» <code>CriticalFinalizerObject</code> æ´¾ç”Ÿçš„ä»»ä½•å¯¹è±¡æä¾›äº†è¿›è¡Œæ¸…ç†çš„æœºä¼šï¼Œå› ä¸ºå®ƒä»¬ä¸€èˆ¬åªæ˜¯å…³é—­æœ¬æœºèµ„æºï¼›è€Œå³ä½¿ CLR æˆ–è€…ä½ çš„åº”ç”¨ç¨‹åºçš„çŠ¶æ€å‘ç”ŸæŸåï¼ŒWindows çŠ¶æ€ä¹Ÿå¯èƒ½æ˜¯å¥½çš„ã€‚ <code>FailFast</code> æ–¹æ³•å°†æ¶ˆæ¯å­—ç¬¦ä¸²å’Œå¯é€‰çš„å¼‚å¸¸ (é€šå¸¸æ˜¯ <code>catch</code> å—ä¸­æ•æ‰çš„å¼‚å¸¸) å†™å…¥ Windows Application äº‹ä»¶æ—¥å¿—ï¼Œç”Ÿæˆ Windows é”™è¯¯æŠ¥å‘Šï¼Œåˆ›å»ºåº”ç”¨ç¨‹åºçš„å†…å­˜è½¬å‚¨ (dump)ï¼Œç„¶åç»ˆæ­¢å½“å‰è¿›ç¨‹ã€‚å¤§å¤šæ•°åº”ç”¨ç¨‹åºéƒ½ä¸èƒ½å®¹å¿çŠ¶æ€å—æŸè€Œç»§ç»­è¿è¡Œï¼Œå› ä¸ºè¿™å¯èƒ½é€ æˆä¸æ­£ç¡®çš„æ•°æ®ï¼Œè®¾ç½®å¯èƒ½é€ æˆå®‰å…¨æ¼æ´ã€‚å¦‚æœåº”ç”¨ç¨‹åºä¸æ–¹ä¾¿ç»ˆæ­¢ (æ¯”å¦‚æ“ä½œç³»ç»Ÿæˆ–æ•°æ®åº“å¼•æ“)ï¼Œæ‰˜ç®¡ä»£ç å°±ä¸æ˜¯ä¸€ä¸ªå¥½çš„æŠ€æœ¯ã€‚å¦‚æœåº”ç”¨ç¨‹åº â€œåœ¨çŠ¶æ€å¯èƒ½æŸåæ—¶ç»ˆæ­¢â€ ä¸ä¼šé€ æˆä¸¥é‡åæœï¼Œå°±é€‚åˆç”¨æ‰˜ç®¡ä»£ç æ¥å†™ã€‚æœ‰è®¸å¤šåº”ç”¨ç¨‹åºéƒ½æ»¡è¶³è¿™ä¸ªè¦æ±‚ã€‚æ­¤å¤–ï¼Œéœ€è¦å¤šå¾—å¤šçš„èµ„æºå’ŒæŠ€èƒ½ï¼Œæ‰èƒ½å†™å‡ºå¥å£®çš„æœ¬æœº (native) ç±»åº“æˆ–åº”ç”¨ç¨‹åºã€‚å¯¹äºè®¸å¤šåº”ç”¨ç¨‹åºï¼Œæ‰˜ç®¡ä»£ç æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒæå¤§æå‡äº†å¼€å‘æ•ˆç‡ã€‚</p><h2 id="guidelines-and-best-practices"><a class="anchor" href="#guidelines-and-best-practices">#</a> Guidelines and Best Practices</h2><blockquote><p>Understanding the exception mechanism is certainly important. It is equally important to understand how to use exceptions wisely. All too often, I see library developers catching all kinds of exceptions, preventing the application developer from knowing that a problem occurred. In this section, I offer some guidelines for developers to be aware of when using exceptions.</p></blockquote><p>ğŸ’¡é‡è¦æç¤ºï¼šå¦‚æœä½ æ˜¯ç±»åº“å¼€å‘äººå‘˜ï¼Œè¦è®¾è®¡ä¾›å…¶ä»–å¼€å‘äººå‘˜ä½¿ç”¨çš„ç±»å‹ï¼Œé‚£ä¹ˆä¸€å®šè¦ä¸¥æ ¼æŒ‰ç…§è¿™äº›è§„èŒƒè¡Œäº‹ï¼Œä½ çš„è´£ä»»å¾ˆé‡å¤§ï¼Œè¦ç²¾å¿ƒè®¾è®¡ç±»åº“ä¸­çš„ç±»å‹ï¼Œé‚£ä¹ˆä¸€å®šè¦æ›´ä¸¥æ ¼æŒ‰ç…§è¿™äº›è§„èŒƒè¡Œäº‹ã€‚ä½ çš„è´£ä»»å¾ˆé‡å¤§ï¼Œè¦ç²¾å¿ƒè®¾è®¡ç±»åº“ä¸­çš„ç±»å‹ï¼Œä½¿ä¹‹é€‚ç”¨äºå„ç§å„æ ·çš„åº”ç”¨ç¨‹åºã€‚è®°ä½ï¼Œä½ æ— æ³•åšåˆ°å¯¹è¦å›è°ƒçš„ä»£ç  (é€šè¿‡å§”æ‰˜ã€è™šæ–¹æ³•æˆ–æ¥å£æ–¹æ³•) äº†å¦‚æŒ‡æŒï¼Œä¹Ÿä¸çŸ¥é“å“ªäº›ä»£ç ä¼šè°ƒç”¨ä½  (çš„ä»£ç )ã€‚ç”±äºæ— æ³•é¢„çŸ¥ä½¿ç”¨ç±»å‹çš„æ¯ä¸€ç§æƒ…å½¢ï¼Œæ‰€ä»¥ä¸è¦åšå‡ºä»»ä½•ç­–ç•¥æŠ‰æ‹© (é‡è§åˆ°å…·ä½“å¼‚å¸¸å¹¶ç›¸åº”å¤„ç†)ã€‚æ¢è¨€ä¹‹ï¼Œä½ çš„ä»£ç ä¸€å®šä¸èƒ½æƒ³å½“ç„¶åœ°å†³å®šä¸€äº›é”™è¯¯æƒ…å½¢ï¼›åº”è¯¥è®©è°ƒç”¨è€…è‡ªå·±å†³å®šã€‚</p><p>æ­¤å¤–ï¼Œè¦ä¸¥å¯†ç›‘è§†çŠ¶æ€ï¼Œå°½é‡ä¸è¦ç ´åå®ƒã€‚ä½¿ç”¨ä»£ç åå®š (æœ¬ç« ç¨åè®¨è®º) éªŒè¯ä¼ ç»™æ–¹æ³•çš„å®å‚ã€‚å°è¯•å®Œå…¨ä¸å»ä¿®æ”¹çŠ¶æ€ã€‚å¦‚æœä¸å¾—ä¸ä¿®æ”¹çŠ¶æ€ï¼Œå°±åšå¥½å‡ºé”™çš„å‡†å¤‡ï¼Œå¹¶åœ¨å‡ºé”™åå°è¯•æ¢å¤çŠ¶æ€ã€‚éµç…§æœ¬ç« çš„è®¾è®¡è§„èŒƒè¡Œäº‹ï¼Œåº”ç”¨ç¨‹åºçš„å¼€å‘äººå‘˜å°±å¯ä»¥é¡ºç•…åœ°ä½¿ç”¨ä½ çš„ç±»åº“ä¸­çš„ç±»å‹ã€‚</p><p>å¦‚æœä½ æ˜¯åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ï¼Œå¯å®šä¹‰è‡ªå·±è®¤ä¸ºåˆé€‚çš„ä»»ä½•ç­–ç•¥ï¼ŒæŒ‰ç…§æœ¬ç« çš„è§„èŒƒè¡Œäº‹ï¼Œæœ‰åŠ©äºåœ¨åº”ç”¨ç¨‹åºå‘å¸ƒå‰å‘ç°å¹¶ä¿®å¤ä»£ç ä¸­çš„é—®é¢˜ï¼Œä½¿åº”ç”¨ç¨‹åºæ›´å¥å£®ï¼Œä½†ç»æ·±æ€ç†Ÿè™‘ä¹‹åï¼Œä¹Ÿå¯ä»¥ä¸æŒ‰è¿™äº›è§„èŒƒè¡Œäº‹ã€‚ä½ è¦è®¾ç½®è‡ªå·±çš„ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œåº”ç”¨ç¨‹åºä»£ç åœ¨æ•æ‰å¼‚å¸¸æ–¹é¢å¯ä»¥æ¯”ç±»åº“ä»£ç æ›´æ¿€è¿›ä¸€äº›ã€‚</p><h3 id="use-finally-blocks-liberally"><a class="anchor" href="#use-finally-blocks-liberally">#</a> Use finally Blocks Liberally</h3><blockquote><p>I think finally blocks are awesome! They allow you to specify a block of code thatâ€™s guaranteed to execute no matter what kind of exception the thread throws. You should use finally blocks to clean up from any operation that successfully started before returning to your caller or allowing code following the finally block to execute. You also frequently use finally blocks to explicitly dispose of any objects to avoid resource leaking. Hereâ€™s an example that has all cleanup code (closing the file) in a finally block.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">SomeType</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token class-name">FileStream</span> fs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">(</span><span class="token string">@"C:\Data.bin "</span><span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Open<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// Display 100 divided by the first byte in the file. </span></pre></td></tr><tr><td data-num="8"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">/</span> fs<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// Put cleanup code in a finally block to ensure that the file gets closed regardless</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// of whether or not an exception occurs (for example, the first byte was 0). </span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>fs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> fs<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Ensuring that cleanup code always executes is so important that many programming languages offer constructs that make writing cleanup code easier. For example, the C# language automatically emits try/finally blocks whenever you use the lock, using, and foreach statements. The C# compiler also emits try/finally blocks whenever you override a classâ€™s destructor (the Finalize method). When using these constructs, the compiler puts the code youâ€™ve written inside the try block and automatically puts the cleanup code inside the finally block. Specifically:</p><ul><li><p>When you use the lock statement, the lock is released inside a finally block.</p></li><li><p>When you use the using statement, the object has its Dispose method called inside a finally block.</p></li><li><p>When you use the foreach statement, the IEnumerator object has its Dispose method called inside a finally block.</p></li><li><p>When you define a destructor method, the base classâ€™s Finalize method is called inside a finally block.</p></li></ul></blockquote><blockquote><p>For example, the following C# code takes advantage of the using statement. This code is shorter than the code shown in the previous example, but the code that the compiler generates is identical to the code generated in the previous example.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">SomeType</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">FileStream</span> fs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">(</span><span class="token string">@"C:\Data.bin"</span><span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Open<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Display 100 divided by the first byte in the file. </span></pre></td></tr><tr><td data-num="7"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">/</span> fs<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>For more about the using statement, see Chapter 21; and for more about the lock statement, see Chapter 30.</p></blockquote><h3 id="dont-catch-everything"><a class="anchor" href="#dont-catch-everything">#</a> Donâ€™t Catch Everything</h3><blockquote><p>A ubiquitous mistake made by developers who have not been properly trained on the proper use of exceptions is to use catch blocks too often and improperly. When you catch an exception, youâ€™re stating that you expected this exception, you understand why it occurred, and you know how to deal with it. In other words, youâ€™re defining a policy for the application. This all goes back to the â€œTrading Reliability for Productivityâ€œ section earlier in this chapter.</p></blockquote><blockquote><p>All too often, I see code like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">try</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// try to execute code that the programmer knows might fail... </span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token range operator">..</span><span class="token punctuation">.</span> </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>This code indicates that it was expecting any and all exceptions and knows how to recover from any and all situations. How can this possibly be? A type thatâ€™s part of a class library should never, ever, under any circumstance catch and swallow all exceptions because there is no way for the type to know exactly how the application intends to respond to an exception. In addition, the type will frequently call out to application code via a delegate, virtual method, or interface method. If the application code throws an exception, another part of the application is probably expecting to catch this exception. The exception should be allowed to filter its way up the call stack and let the application code handle the exception as it sees fit.</p></blockquote><blockquote><p>If the exception is unhandled, the CLR terminates the process. Iâ€™ll discuss unhandled exceptions later in this chapter. Most unhandled exceptions will be discovered during testing of your code. To fix these unhandled exceptions, you will either modify the code to look for a specific exception, or you will rewrite the code to eliminate the conditions that cause the exception to be thrown. The final version of the code that will be running in a production environment should see very few unhandled exceptions and will be extremely robust.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šæœ‰æ—¶ï¼Œä¸èƒ½å®Œæˆä»»åŠ¡çš„ä¸€ä¸ªæ–¹æ³•æ£€æµ‹åˆ°å¯¹è±¡çŠ¶æ€å·²ç»æŸåï¼Œè€Œä¸”çŠ¶æ€æ— æ³•æ¢å¤ã€‚å‡å¦‚å…è®¸åº”ç”¨ç¨‹åºç»§ç»­è¿è¡Œï¼Œå¯èƒ½é€ æˆä¸å¯é¢„æµ‹çš„è¡Œä¸ºæˆ–å®‰å…¨éšæ‚£ã€‚æ£€æµ‹åˆ°è¿™ç§æƒ…å†µï¼Œæ–¹æ³•ä¸åº”æŠ›å‡ºå¼‚å¸¸ã€‚ç›¸åï¼Œåº”è°ƒç”¨ <code>System.Environment</code> çš„ <code>FailFast</code> æ–¹æ³•å¼ºè¿«è¿›ç¨‹ç»ˆæ­¢ã€‚</p><blockquote><p>By the way, it is OK to catch System.Exception and execute some code inside the catch blockâ€™s braces as long as you re-throw the exception at the bottom of that code. Catching System.Exception and swallowing the exception (not re-throwing it) should never be done because it hides failures that allow the application to run with unpredictable results and potential security vulnerabilities. Visual Studioâ€™s code analysis tool (FxCopCmd.exe) will flag any code that contains a catch (Exception) block unless there is a throw statement included in the blockâ€™s code. The â€œBacking Out of a Partially Completed Operation When an Unrecoverable Exception Occursâ€”Maintaining Stateâ€ section, coming shortly in this chapter, will discuss this pattern.</p></blockquote><blockquote><p>Finally, it is OK to catch an exception occurring in one thread and re-throw the exception in another thread. The Asynchronous Programming Model (discussed in Chapter 28, â€œI/O-Bound Asynchronous Operationsâ€) supports this. For example, if a thread pool thread executes code that throws an exception, the CLR catches and swallows the exception and allows the thread to return to the thread pool. Later, a thread should call an EndXxx method to determine the result of the asynchronous operation. The EndXxx method will throw the same exception object that was thrown by the thread pool thread that did the actual work. In this scenario, the exception is being swallowed by the first thread; however, the exception is being re-thrown by the thread that called the EndXxx method, so it is not being hidden from the application.</p></blockquote><h3 id="recovering-gracefully-from-an-exception"><a class="anchor" href="#recovering-gracefully-from-an-exception">#</a> Recovering Gracefully from an Exception</h3><blockquote><p>Sometimes you call a method knowing in advance some of the exceptions that the method might throw. Because you expect these exceptions, you might want to have some code that allows your application to recover gracefully from the situation and continue running. Hereâ€™s an example in pseudocode.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token return-type class-name">String</span> <span class="token function">CalculateSpreadsheetCell</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> row<span class="token punctuation">,</span> <span class="token class-name">Int32</span> column<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name">String</span> result<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> result <span class="token operator">=</span> <span class="token comment">/* Code to calculate value of a spreadsheet's cell */</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DivideByZeroException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> result <span class="token operator">=</span> <span class="token string">"Can't show value: Divide by zero"</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OverflowException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> result <span class="token operator">=</span> <span class="token string">"Can't show value: Too big"</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">return</span> result<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>This pseudocode calculates the contents of a cell in a spreadsheet and returns a string representing the value to the caller so that the caller can display the string in the applicationâ€™s window. However, a cellâ€™s contents might be the result of dividing one cell by another cell. If the cell containing the denominator contains 0, the CLR will throw a DivideByZeroException object. In this case, the method catches this specific exception and returns a special string that will be displayed to the user. Similarly, a cellâ€™s contents might be the result of multiplying one cell by another. If the multiplied value doesnâ€™t fit in the number of bits allowed, the CLR will throw an OverflowException object, and again, a special string will be displayed to the user.</p></blockquote><blockquote><p>When you catch specific exceptions, fully understand the circumstances that cause the exception to be thrown, and know what exception types are derived from the exception type youâ€™re catching. Donâ€™t catch and handle System.Exception (without re-throwing) because itâ€™s not feasible for you to know all of the possible exceptions that could be thrown within your try block (especially if you consider the OutOfMemoryException or the StackOverflowException, to name two).</p></blockquote><h3 id="backing-out-of-a-partially-completed-operation-when-an-unrecoverable-exception-occursmaintaining-state"><a class="anchor" href="#backing-out-of-a-partially-completed-operation-when-an-unrecoverable-exception-occursmaintaining-state">#</a> Backing Out of a Partially Completed Operation When an Unrecoverable Exception Occursâ€”Maintaining State</h3><blockquote><p>Usually, methods call several other methods to perform a single abstract operation. Some of the individual methods might complete successfully, and some might not. For example, letâ€™s say that youâ€™re serializing a set of objects to a disk file. After serializing 10 objects, an exception is thrown. (Perhaps the disk is full or the next object to be serialized isnâ€™t marked with the Serializable custom attribute.) At this point, the exception should filter up to the caller, but what about the state of the disk file? The file is now corrupted because it contains a partially serialized object graph. It would be great if the application could back out of the partially completed operation so that the file would be in the state it was in before any objects were serialized into it. The following code demonstrates the correct way to implement this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SerializeObjectGraph</span><span class="token punctuation">(</span><span class="token class-name">FileStream</span> fs<span class="token punctuation">,</span> <span class="token class-name">IFormatter</span> formatter<span class="token punctuation">,</span> <span class="token class-name">Object</span> rootObj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Save the current position of the file. </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name">Int64</span> beforeSerialization <span class="token operator">=</span> fs<span class="token punctuation">.</span>Position<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Attempt to serialize the object graph to the file. </span></pre></td></tr><tr><td data-num="6"></td><td><pre> formatter<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>fs<span class="token punctuation">,</span> rootObj<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Catch any and all exceptions. </span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// If ANYTHING goes wrong, reset the file back to a good state. </span></pre></td></tr><tr><td data-num="10"></td><td><pre> fs<span class="token punctuation">.</span>Position <span class="token operator">=</span> beforeSerialization<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// Truncate the file. </span></pre></td></tr><tr><td data-num="12"></td><td><pre> fs<span class="token punctuation">.</span><span class="token function">SetLength</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>Position<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// NOTE: The preceding code isn't in a finally block because </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// the stream should be reset only when serialization fails. </span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token comment">// Let the caller(s) know what happened by re-throwing the SAME exception. </span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">throw</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>To properly back out of the partially completed operation, write code that catches all exceptions. Yes, catch all exceptions here because you donâ€™t care what kind of error occurred; you need to put your data structures back into a consistent state. After youâ€™ve caught and handled the exception, donâ€™t swallow itâ€”let the caller know that the exception occurred. You do this by re-throwing the same exception. In fact, C# and many other languages make this easy. Just use C#â€™s throw keyword without specifying anything after throw, as shown in the previous code.</p></blockquote><blockquote><p>Notice that the catch block in the previous example doesnâ€™t specify any exception type because I want to catch any and all exceptions. In addition, the code in the catch block doesnâ€™t need to know exactly what kind of exception was thrown, just that something went wrong. Fortunately, C# lets me do this easily just by not specifying any exception type and by making the throw statement re-throw whatever object is caught.</p></blockquote><h3 id="hiding-an-implementation-detail-to-maintain-a-contract"><a class="anchor" href="#hiding-an-implementation-detail-to-maintain-a-contract">#</a> Hiding an Implementation Detail to Maintain a â€œContractâ€</h3><blockquote><p>In some situations, you might find it useful to catch one exception and re-throw a different exception. The only reason to do this is to maintain the meaning of a methodâ€™s contract. Also, the new exception type that you throw should be a specific exception (an exception thatâ€™s not used as the base type of any other exception type). Imagine a PhoneBook type that defines a method that looks up a phone number from a name, as shown in the following pseudocode.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">PhoneBook</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">String</span> m_pathname<span class="token punctuation">;</span> <span class="token comment">// path name of file containing the address book </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Other methods go here. </span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> <span class="token function">GetPhoneNumber</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token class-name">String</span> phone<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token class-name">FileStream</span> fs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> fs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileStream</span><span class="token punctuation">(</span>m_pathname<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Open<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// Code to read from fs until name is found goes here </span></pre></td></tr><tr><td data-num="10"></td><td><pre> phone <span class="token operator">=</span> <span class="token comment">/* the phone # found */</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// Throw a different exception containing the name, and </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token comment">// set the originating exception as the inner exception. </span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NameNotFoundException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token comment">// Throw a different exception containing the name, and </span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">// set the originating exception as the inner exception. </span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NameNotFoundException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>fs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> fs<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token keyword">return</span> phone<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The phone book data is obtained from a file (versus a network connection or database). However, the user of the PhoneBook type doesnâ€™t know this because this is an implementation detail that could change in the future. So if the file isnâ€™t found or canâ€™t be read for any reason, the caller would see a FileNotFoundException or IOException, which wouldnâ€™t be anticipated. In other words, the fileâ€™s existence and ability to be read is not part of the methodâ€™s implied contract: there is no way the caller could have guessed this. So the GetPhoneNumber method catches these two exception types and throws a new NameNotFoundException.</p></blockquote><blockquote><p>When using this technique, you should catch specific exceptions that you fully understand the circumstances that cause the exception to be thrown. And, you should also know what exception types are derived from the exception type youâ€™re catching.</p></blockquote><blockquote><p>Throwing an exception still lets the caller know that the method cannot complete its task, and the NameNotFoundException type gives the caller an abstracted view as to why. Setting the inner exception to FileNotFoundException or IOException is important so that the real cause of the exception isnâ€™t lost. Besides, knowing what caused the exception could be useful to the developer of the PhoneBook type and possibly to a developer using the PhoneBook type.</p></blockquote><p>ğŸ’¡é‡è¦æç¤ºï¼šä½¿ç”¨è¿™ä¸ªæŠ€æœ¯æ—¶ï¼Œå®é™…æ˜¯åœ¨ä¸¤ä¸ªæ–¹é¢æ¬ºéª—äº†è°ƒç”¨è€…ã€‚é¦–å…ˆï¼Œåœ¨å®é™…å‘ç”Ÿçš„é”™è¯¯ä¸Šæ¬ºéª—äº†è°ƒç”¨è€…ã€‚æœ¬ä¾‹æ˜¯æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè€ŒæŠ¥å‘Šçš„æ˜¯æ²¡æœ‰æ‰¾åˆ°æŒ‡å®šçš„å§“åã€‚å…¶æ¬¡ï¼Œåœ¨é”™è¯¯å‘ç”Ÿçš„ä½ç½®ä¸Šæ¬ºéª—äº†è°ƒç”¨è€…ã€‚å¦‚æœå…è®¸ <code>FileNotFoundException</code> å¼‚å¸¸åœ¨æ‰åº”è¯¥èƒ½æ ˆä¸­å‘ä¸Šä¼ é€’ï¼Œå®ƒçš„ <code>StackTrace</code> å±æ€§æ˜¾ç¤ºé”™è¯¯åœ¨ <code>FileStream</code> çš„æ„é€ å™¨å‘ç”Ÿã€‚ä½†ç”±äºç°åœ¨æ˜¯ â€œåå™¬â€ è¯¥å¼‚å¸¸å¹¶é‡æ–°æŠ›å‡ºæ–°çš„ <code>NameNotFoundException</code> å¼‚å¸¸ï¼Œæ‰€ä»¥å †æ ˆè·Ÿè¸ªä¼šæ˜¾ç¤ºé”™è¯¯åœ¨ <code>catch</code> å—ä¸­å‘ç”Ÿï¼Œç¦»å¼‚å¸¸å®é™…å‘ç”Ÿçš„ä½ç½®æœ‰å¥½å‡ è¡Œè¿œã€‚è¿™ä¼šä½¿è°ƒè¯•å˜å¾—å›°éš¾ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªæŠ€æœ¯åŠ¡å¿…æ…ç”¨ã€‚</p><blockquote><p>Now letâ€™s say that the PhoneBook type was implemented a little differently. Assume that the type offers a public PhoneBookPathname property that allows the user to set or get the path name of the file in which to look up a phone number. Because the user is aware of the fact that the phone book data comes from a file, I would modify the GetPhoneNumber method so that it doesnâ€™t catch any exceptions; instead, I let whatever exception is thrown propagate out of the method. Note that Iâ€™m not changing any parameters of the GetPhoneNumber method, but I am changing how itâ€™s abstracted to users of the PhoneBook type. Users now expect a path to be part of the PhoneBookâ€™s contract.</p></blockquote><blockquote><p>Sometimes developers catch one exception and throw a new exception in order to add additional data or context to an exception. However, if this is all you want to do, you should just catch the exception type you want, add data to the exception objectâ€™s Data property collection, and then re-throw the same exception object.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Do whatevere here...</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Add the filename to the IOException object</span></pre></td></tr><tr><td data-num="7"></td><td><pre> e<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Filename"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">throw</span><span class="token punctuation">;</span> <span class="token comment">// re-throw the same exception object that now has additional data in it</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Here is a good use of this technique: when a type constructor throws an exception that is not caught within the type constructor method, the CLR internally catches that exception and throws a new TypeInitializationException instead. This is useful because the CLR emits code within your methods to implicitly call type constructors.6 If the type constructor threw a DivideByZeroException, your code might try to catch it and recover from it but you didnâ€™t even know you were invoking the type constructor. So the CLR converts the DivideByZeroException into a TypeInitializationException so that you know clearly that the exception occurred due to a type constructor failing; the problem wasnâ€™t with your code.</p></blockquote><blockquote><p>On the other hand, here is a bad use of this technique: when you invoke a method via reflection, the CLR internally catches any exception thrown by the method and converts it to a TargetInvocationException. This is incredibly annoying because you must now catch the TargetInvocationException object and look at its InnerException property to discern the real reason for the failure. In fact, when using reflection, it is common to see code that looks like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Reflection</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Invoke a DoSomething method on this object</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> mi <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span><span class="token string">"DoSomething"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> mi<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// The DoSomething method might throw an exception</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>Reflection<span class="token punctuation">.</span>TargetInvocationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// The CLR converts reflection-produced exceptions to TargetInvocationException</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">throw</span> e<span class="token punctuation">.</span>InnerException<span class="token punctuation">;</span> <span class="token comment">// Re-throw what was originally thrown</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>I have good news though: if you use C#â€™s dynamic primitive type (discussed in Chapter 5, â€œPrimitive, Reference, and Value Typesâ€) to invoke a member, the compiler-generated code does not catch any and all exceptions and throw a TargetInvocationException object; the originally thrown exception object simply walks up the stack. For many developers, this is a good reason to prefer using C#â€™s dynamic primitive type rather than reflection.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šç¡®ä¿æ¸…ç†ä»£ç çš„æ‰§è¡Œæ—¶å¦‚æ­¤é‡è¦ï¼Œä»¥è‡³äºè®¸å¤šç¼–ç¨‹è¯­è¨€éƒ½æä¾›äº†ä¸€äº›æ„é€ æ¥ç®€åŒ–è¿™ç§ä»£ç çš„ç¼–å†™ã€‚ä¾‹å¦‚ï¼Œåªè¦ä½¿ç”¨äº† <code>lock</code> ï¼Œ <code>using</code> å’Œ <code>foreach</code> è¯­å¥ï¼ŒC# ç¼–è¯‘å™¨å°±ä¼šè‡ªåŠ¨ç”Ÿæˆ <code>try/finally</code> å—ï¼Œå¦å¤–ï¼Œé‡å†™ç±»çš„ææ„å™¨ ( <code>Finalize</code> æ–¹æ³•) æ—¶ï¼ŒC# ç¼–è¯‘å™¨ä¹Ÿä¼šè‡ªåŠ¨ç”Ÿæˆ <code>try/finally</code> å—ã€‚ä½¿ç”¨è¿™äº›æ„é€ æ—¶ï¼Œç¼–è¯‘å™¨å°†ä½ å†™çš„ä»£ç æ”¾åˆ° <code>try</code> å—å†…éƒ¨ï¼Œå¹¶å°†æ¸…ç†ä»£ç æ”¾åˆ° <code>finally</code> å—ä¸­ã€‚å¦‚æœç±»å‹æ˜¯ç±»åº“çš„ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆä»»ä½•æƒ…å†µä¸‹éƒ½ç»å¯¹ä¸å…è®¸æ•æ‰å¹¶ â€œåå™¬â€ æ‰€æœ‰å¼‚å¸¸ï¼Œå› ä¸ºå®ƒä¸å¯èƒ½å‡†ç¡®é¢„çŸ¥åº”ç”¨ç¨‹åºå°†å¦‚ä½•å“åº”ä¸€ä¸ªå¼‚å¸¸ã€‚æ­¤å¤–ï¼Œç±»å‹ç»å¸¸é€šè¿‡å§”æ‰˜ã€è™šæ–¹æ³•æˆ–æ¥å£æ–¹æ³•è°ƒç”¨åº”ç”¨ç¨‹åºä»£ç ã€‚åº”ç”¨ç¨‹åºä»£ç æŠ›å‡ºå¼‚å¸¸ï¼Œåº”ç”¨ç¨‹åºçš„å¦ä¸€éƒ¨åˆ†å¯èƒ½é¢„æœŸè¦æ•æ‰è¯¥å¼‚å¸¸ã€‚æ‰€ä»¥ï¼Œç»å¯¹ä¸è¦å†™ â€œå¤§å°é€šåƒâ€ çš„ç±»å‹ï¼Œæ‚„æ‚„åœ° â€œåå™¬â€ å¼‚å¸¸ï¼Œè€Œæ˜¯åº”è¯¥å…è®¸å¼‚å¸¸åœ¨è°ƒç”¨æ ˆä¸­å‘ä¸Šç§»åŠ¨ï¼Œè®©åº”ç”¨ç¨‹åºä»£ç é’ˆå¯¹æ€§åœ°å¤„ç†å®ƒã€‚å¦‚æœå¼‚å¸¸æœªå¾—åˆ°å¤„ç†ï¼ŒCLR ä¼šç»ˆæ­¢è¿›ç¨‹ã€‚å¤§å¤šæ•°æœªå¤„ç†å¼‚å¸¸éƒ½èƒ½åœ¨ä»£ç æµ‹è¯•æœŸé—´å‘ç°ã€‚ä¸ºäº†ä¿®æ­£è¿™äº›æœªå¤„ç†çš„å¼‚å¸¸ï¼Œè¦ä¹ˆä¿®æ”¹ä»£ç æ¥æ•æ‰ç‰¹å®šå¼‚å¸¸ï¼Œè¦ä¹ˆé‡å†™ä»£ç æ’é™¤ä¼šé€ æˆå¼‚å¸¸çš„å‡ºé”™æ¡ä»¶ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œçš„æœ€ç»ˆç‰ˆæœ¬åº”è¯¥æå°‘å‡ºç°æœªå¤„ç†çš„å¼‚å¸¸ï¼Œè€Œä¸”åº”è¯¥ç›¸å½“å¥å£®ã€‚å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ•æ‰å¼‚å¸¸ï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­é‡æ–°æŠ›å‡ºå¼‚å¸¸ã€‚ä¸ºæ­¤æä¾›æ”¯æŒçš„æ˜¯å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ã€‚ä¸ºäº†æ­£ç¡®å›æ»šå·²éƒ¨åˆ†å®Œæˆçš„æ“ä½œï¼Œä»£ç åº”æ•æ‰æ‰€æœ‰å¼‚å¸¸ã€‚æ˜¯çš„ï¼Œè¿™é‡Œè¦æ•æ‰æ‰€æœ‰å¼‚å¸¸ï¼Œå› ä¸ºä½ ä¸å…³å¿ƒå‘ç”Ÿäº†ä»€ä¹ˆé”™è¯¯ï¼Œåªå…³å¿ƒå¦‚ä½•å°†æ•°æ®ç»“æ„æ¢å¤ä¸ºä¸€è‡´çŠ¶æ€ã€‚æ•æ‰å¹¶å¤„ç†å¥½å¼‚å¸¸åï¼Œä¸è¦æŠŠå®ƒ â€œåå™¬â€(å‡è£…å®ƒæ²¡æœ‰å‘ç”Ÿ)ã€‚ç›¸åï¼Œè¦è®©è°ƒç”¨è€…çŸ¥é“å‘ç”Ÿäº†å¼‚å¸¸ã€‚ä¸ºæ­¤ï¼Œåªéœ€é‡æ–°æŠ›å‡ºç›¸åŒçš„å¼‚å¸¸ã€‚äº‹å®ä¸Šï¼ŒC# å’Œè®¸å¤šå…¶ä»–è¯­è¨€éƒ½ç®€åŒ–äº†è¿™é¡¹ä»»åŠ¡ï¼Œåªéœ€åƒä¸Šè¿°ä»£ç é‚£æ ·å•ç‹¬ä½¿ç”¨ C# çš„ <code>throw</code> å…³é”®å­—ï¼Œä¸åœ¨ <code>throw</code> åæŒ‡å®šä»»ä½•ä¸œè¥¿ã€‚æœ‰æ—¶ï¼Œå¼€å‘äººå‘˜ä¹‹æ‰€ä»¥æ•æ‰ä¸€ä¸ªå¼‚å¸¸å¹¶æŠ›å‡ºä¸€ä¸ªæ–°å¼‚å¸¸ï¼Œç›®çš„æ˜¯åœ¨å¼‚å¸¸ä¸­æ·»åŠ é¢å¤–çš„æ•°æ®æˆ–ä¸Šä¸‹æ–‡ã€‚ç„¶è€Œï¼Œå¦‚æœè¿™æ˜¯ä½ å”¯ä¸€çš„ç›®çš„ï¼Œé‚£ä¹ˆåªéœ€æ•æ‰å¸Œæœ›çš„å¼‚å¸¸ç±»å‹ï¼Œåœ¨å¼‚å¸¸å¯¹è±¡çš„ <code>Data</code> å±æ€§ (ä¸€ä¸ªé”® / å€¼å¯¹çš„é›†åˆ) ä¸­æ·»åŠ æ•°æ®ï¼Œç„¶åé‡æ–°æŠ›å‡ºç›¸åŒçš„å¼‚å¸¸å¯¹è±¡ã€‚ä½¿ç”¨ C# çš„ <code>dynamic</code> åŸºå…ƒç±»å‹æ¥è°ƒç”¨æˆå‘˜ï¼Œæœ€åˆæŠ›å‡ºçš„å¼‚å¸¸å¯¹è±¡ä¼šæ­£å¸¸åœ°åœ¨è°ƒç”¨æ ˆä¸­å‘ä¸Šä¼ é€’ã€‚å¯¹äºå¤§å¤šæ•°å¼€å‘äººå‘˜ï¼Œè¿™æ˜¯ä½¿ç”¨ C# çš„ <code>dynamic</code> åŸºå…ƒç±»å‹æ¥ä»£æ›¿åå°„çš„ä¸€ä¸ªå¾ˆå¥½çš„ç†ç”±ã€‚</p><h2 id="unhandled-exceptions"><a class="anchor" href="#unhandled-exceptions">#</a> Unhandled Exceptions</h2><blockquote><p>When an exception is thrown, the CLR climbs up the call stack looking for catch blocks that match the type of the exception object being thrown. If no catch block matches the thrown exception type, an unhandled exception occurs. When the CLR detects that any thread in the process has had an unhandled exception, the CLR terminates the process. An unhandled exception identifies a situation that the application didnâ€™t anticipate and is considered to be a true bug in the application. At this point, the bug should be reported back to the company that publishes the application. Hopefully, the publisher will fix the bug and distribute a new version of the application.</p></blockquote><blockquote><p>Class library developers should not even think about unhandled exceptions. Only application developers need to concern themselves with unhandled exceptions, and the application should have a policy in place for dealing with unhandled exceptions. Microsoft actually recommends that application developers just accept the CLRâ€™s default policy. That is, when an application gets an unhandled exception, Windows writes an entry to the systemâ€™s event log. You can see this entry by opening the Event Viewer application and then looking under the Windows Logs â” Application node in the tree, as shown in Figure 20-1.</p></blockquote><p><img data-src="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/image-20221127161945517.png" alt="image-20221127161945517"></p><p><strong>FIGURE 20-1</strong> Windows Event log showing an application that terminated due to an unhandled exception.</p><blockquote><p>However, you can get more interesting details about the problem by using the Windows Reliability Monitor applet. To start Reliability Monitor, open the Windows Control Panel and search for â€œreliability historyâ€. From here, you can see the applications that have terminated due to an unhandled exception in the bottom pane, as shown in Figure 20-2.</p></blockquote><p><img data-src="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/image-20221127162114003.png" alt="image-20221127162114003"></p><p><strong>FIGURE 20-2</strong> Reliability Monitor showing an application that terminated due to an unhandled exception.</p><blockquote><p>To see more details about the terminated application, double-click a terminated application in Reliability Monitor. The details will look something like Figure 20-3 and the meaning of the problem signatures are described in Table 20-2. All unhandled exceptions produced by managed applications are placed in the CLR20r3 bucket.</p></blockquote><p><img data-src="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/image-20221127162227127.png" alt="image-20221127162227127"></p><p><strong>FIGURE 20-3</strong> Reliability Monitor showing more details about the failed application.</p><p><img data-src="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/image-20221125094825099.png" alt="image-20221125094825099"></p><blockquote><p>After recording information about the failing application, Windows displays the message box allowing the end user to send information about the failing application to Microsoft servers.7 This is called Windows Error Reporting, and more information about it can be found at the Windows Quality website (<span class="exturl" data-url="aHR0cDovL1dpblF1YWwuTWljcm9zb2Z0LmNvbQ==">http://WinQual.Microsoft.com</span>).</p></blockquote><blockquote><p>Companies can optionally sign up with Microsoft to view this information about their own applications and components. Signing up is free, but it does require that your assemblies be signed with a VeriSign ID (also called a Software Publisherâ€™s Digital ID for Authenticode).</p></blockquote><blockquote><p>Naturally, you could also develop your own system for getting unhandled exception information back to you so that you can fix bugs in your code. When your application initializes, you can inform the CLR that you have a method that you want to be called whenever any thread in your application experiences an unhandled exception.</p></blockquote><blockquote><p>Unfortunately, every application model Microsoft produces has its own way of tapping into unhandled exceptions. The members that you want to look up in the FCL documentation are.</p><ul><li><p>For many applications, look at System.AppDomainâ€™s UnhandledException event. Windows Store applications and Microsoft Silverlight applications cannot access this event. 4</p></li><li><p>For a Windows Store App, look at Windows.UI.Xaml.Applicationâ€™s UnhandledException event.</p></li><li><p>For a Windows Forms application, look at System.Windows.Forms.NativeWindowâ€™s OnThreadException virtual method, System.Windows.Forms.Applicationâ€™s OnThreadException virtual method, and System.Windows.Forms.Applicationâ€™s ThreadException event.</p></li><li><p>For a Windows Presentation Foundation (WPF) application, look at System.Windows. Applicationâ€™s DispatcherUnhandledException event and System.Windows. Threading.Dispatcherâ€™s UnhandledException and UnhandledExceptionFilter events.</p></li><li><p>For Silverlight, look at System.Windows.Applicationâ€™s UnhandledException event.</p></li><li><p>For an <span class="exturl" data-url="aHR0cDovL0FTUC5ORVQ=">ASP.NET</span> Web Form application, look at System.Web.UI.TemplateControlâ€™s Error event. TemplateControl is the base class of the System.Web.UI.Page and System.Web.UI.UserControl classes. Furthermore, you should also look at System. Web.HttpApplicationâ€™s Error event.</p></li><li><p>For a Windows Communication Foundation application, look at System.ServiceModel. Dispatcher.ChannelDispatcherâ€™s ErrorHandlers property.</p></li></ul></blockquote><blockquote><p>Before I leave this section, Iâ€™d like to say a few words about unhandled exceptions that could occur in a distributed application such as a website or web service. In an ideal world, a server application that experiences an unhandled exception should log it, send some kind of notification back to the client indicating that the requested operation could not complete, and then the server should terminate. Unfortunately, we donâ€™t live in an ideal world, and therefore, it may not be possible to send a failure notification back to the client. For some stateful servers (such as Microsoft SQL Server), it may not be practical to terminate the server and start a brand new instance.</p></blockquote><blockquote><p>For a server application, information about the unhandled exception should not be returned to the client because there is little a client could do about it, especially if the client is implemented by a different company. Furthermore, the server should divulge as little information about itself as possible to its clients to reduce that potential of the server being hacked.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šCLR è®¤ä¸ºæœ¬æœºä»£ç  (native code) æŠ›å‡ºçš„ä¸€äº›å¼‚å¸¸æ—¶æŸåçŠ¶æ€å¼‚å¸¸ (corrupted state exceptions, CSE) å¼‚å¸¸ï¼Œå› ä¸ºå®ƒä»¬ä¸€èˆ¬ç”± CLR è‡ªèº«çš„ bug é€ æˆï¼Œæˆ–è€…ç”±æ‰˜ç®¡å¼€å‘äººå‘˜æ— æ³•æ§åˆ¶çš„æœ¬æœºä»£ç çš„ bug é€ æˆã€‚CLR é»˜è®¤ä¸è®©æ‰˜ç®¡ä»£ç æ•æ‰è¿™äº›å¼‚å¸¸ï¼Œ <code>finally</code> å—ä¹Ÿä¸ä¼šæ‰§è¡Œã€‚ä»¥ä¸‹æœ¬æœº Win32 å¼‚å¸¸è¢«è®¤ä¸ºæ˜¯ CSEï¼š</p><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>EXCEPTION_ACCESS_VIOLATION EXCEPTION_STACK_OVERFLOW</pre></td></tr><tr><td data-num="2"></td><td><pre>EXCEPTION_ILLEGAL_INSTRUCTION EXCEPTION_IN_PAGE_ERROR</pre></td></tr><tr><td data-num="3"></td><td><pre>EXCEPTION_INVALID_DISPOSITION EXCEPTION_NONCONTINUABLE_EXCEPTION</pre></td></tr><tr><td data-num="4"></td><td><pre>EXCEPTION_PRIV_INSTRUCTION STATUS_UNWIND_CONSOLIDATE<span class="token punctuation">.</span></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œå•ç‹¬çš„æ‰˜ç®¡æ–¹æ³•å¯ä»¥è¦†ç›–é»˜è®¤è®¾ç½®æ¥æ•æ‰è¿™äº›å¼‚å¸¸ï¼Œè¿™éœ€è¦å‘æ–¹æ³•åº”ç”¨ <code>System.Runtime.ExceptionServices.HandleProcessCorruptedStateExceptionsAttribute</code> ã€‚æ–¹æ³•è¿˜è¦åº”ç”¨ <code>System.Security.SecurityCriticalAttribute</code> ã€‚è¦è¦†ç›–æ•´ä¸ªè¿›ç¨‹çš„é»˜è®¤è®¾ç½®ï¼Œå¯åœ¨åº”ç”¨ç¨‹åºçš„ XML é…ç½®æ–‡ä»¶ä¸­å°† <code>legacyCorruptedStateExceptionPolicy</code> å…ƒç´ è®¾ä¸º <code>true</code> ã€‚CLR å°†ä¸Šè¿°å¤§å¤šæ•°å¼‚å¸¸éƒ½è½¬æ¢æˆä¸€ä¸ª <code>System.Runtime.InteropServices.SEHException</code> å¯¹è±¡ï¼Œä½†æœ‰ä¸¤ä¸ªå¼‚å¸¸ä¾‹å¤–ï¼š <code>EXCEPTION_ACCESS_VIOLATION</code> è¢«è½¬æ¢æˆ <code>System.AccessViolationException</code> å¯¹è±¡ï¼Œ <code>EXCEPTION_STACK_OVERFLOW</code> è¢«è½¬æ¢æˆ <code>System.StackOverflowException</code> å¯¹è±¡ã€‚</p><p>ğŸ’¡æ³¨æ„ï¼šè°ƒç”¨æ–¹æ³•å‰ï¼Œå¯è°ƒç”¨ <code>RuntimeHelper</code> ç±»çš„ <code>EnsureSufficientExecutionStack</code> æ£€æŸ¥æ ˆç©ºé—´æ˜¯å¦å¤Ÿç”¨ã€‚è¯¥æ–¹æ³•æ£€æŸ¥è°ƒç”¨çº¿ç¨‹æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ ˆç©ºé—´æ¥æ‰§è¡Œä¸€èˆ¬æ€§çš„æ–¹æ³• (å®šä¹‰å¾—æ¯”è¾ƒéšä¾¿çš„æ–¹æ³•)ã€‚æ ˆç©ºé—´ä¸å¤Ÿï¼Œæ–¹æ³•ä¼šæŠ›å‡ºä¸€ä¸ª <code>InsufficientExecutionStackException</code> ï¼Œä½ å¯ä»¥æ•æ‰è¿™ä¸ªå¼‚å¸¸ã€‚ <code>EnsureSufficientExecutionStack</code> æ–¹æ³•ä¸æ¥å—ä»»ä½•å®å‚ï¼Œè¿”å›å€¼æ˜¯ <code>void</code> ã€‚ é€’å½’æ–¹æ³•ç‰¹åˆ«è¦ç”¨å¥½è¿™ä¸ªæ–¹æ³•ã€‚</p><p>ğŸ’¡å°ç»“ï¼šå¼‚å¸¸æŠ›å‡ºæ—¶ï¼ŒCLR åœ¨è°ƒç”¨æ ˆä¸­å‘ä¸ŠæŸ¥æ‰¾ä¸æŠ›å‡ºçš„å¼‚å¸¸å¯¹è±¡çš„ç±»å‹åŒ¹é…çš„ <code>catch</code> å—ã€‚æ²¡æœ‰ä»»ä½• <code>catch</code> å—åŒ¹é…æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹ï¼Œå°±å‘ç”Ÿä¸€ä¸ªæœªå¤„ç†çš„å¼‚å¸¸ã€‚åº”ç”¨ç¨‹åºå‘ç”Ÿæœªå¤„ç†çš„å¼‚å¸¸æ—¶ï¼ŒWindows ä¼šå‘äº‹ä»¶æ—¥å¿—å†™ä¸€æ¡è®°å½•ã€‚è®°å½•å¥½å‡ºé”™çš„åº”ç”¨ç¨‹åºæœ‰å…³çš„ä¿¡æ¯åï¼ŒWindows æ˜¾ç¤ºä¸€ä¸ªæ¶ˆæ¯æ¡†ï¼Œå…è®¸ç”¨æˆ·å°†ä¸å‡ºé”™çš„åº”ç”¨ç¨‹åºæœ‰å…³çš„ä¿¡æ¯å‘é€ç»™ Microsoft çš„æœåŠ¡å™¨ã€‚è¿™ç§°ä¸º â€œWindows é”™è¯¯æŠ¥å‘Šâ€(Windows Error Reporting)ã€‚ä½œä¸ºå…¬å¸ï¼Œå¯ä»¥å‘ Microsoft æ³¨å†ŒæŸ¥çœ‹ä¸å®ƒä»¬è‡ªå·±çš„åº”ç”¨ç¨‹åºå’Œç»„ä»¶æœ‰å…³çš„ä¿¡æ¯ã€‚æ³¨å†Œæ˜¯å…è´¹çš„ï¼Œä½†è¦æ±‚ç¨‹åºé›†ç”¨ VeriSign ID (ä¹Ÿç§°ä¸º Software Publisher Digital ID for Authenticode) è¿›è¡Œç­¾åã€‚å½“ç„¶ä¹Ÿå¯ä»¥å¼€å‘è‡ªå·±çš„ç³»ç»Ÿï¼Œå°†æœªå¤„ç†å¼‚å¸¸çš„ä¿¡æ¯ä¼ å›ç»™ä½ è‡ªå·±ï¼Œä»¥ä¾¿ä¿®æ­£ä»£ç ä¸­çš„ bugã€‚åº”ç”¨ç¨‹åºåˆå§‹åŒ–æ—¶ï¼Œå¯å‘Šè¯‰ CLR å½“åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•çº¿ç¨‹å‘ç”Ÿä¸€ä¸ªæœªå¤„ç†çš„å¼‚å¸¸æ—¶ï¼Œéƒ½è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ã€‚æœ€åè®²ä¸€ä¸‹åˆ†å¸ƒå¼åº”ç”¨ç¨‹åº (ä¾‹å¦‚ Web ç«™ç‚¹æˆ– Web æœåŠ¡) ä¸­å‘ç”Ÿçš„æœªå¤„ç†å¼‚å¸¸ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨åº”ç”¨ç¨‹åºå‘ç”Ÿæœªå¤„ç†å¼‚å¸¸ï¼Œåº”è¯¥å…ˆæŠŠå®ƒè®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œå†å‘å®¢æˆ·ç«¯å‘é€é€šçŸ¥ï¼Œè¡¨æ˜æ‰€è¯·æ±‚çš„æ“ä½œæ— æ³•å®Œæˆï¼Œæœ€åç»ˆæ­¢æœåŠ¡å™¨åº”ç”¨ç¨‹åºã€‚é—æ†¾çš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶éç”Ÿæ´»åœ¨ç†æƒ³ä¸–ç•Œä¸­ã€‚å› æ­¤ï¼Œä¹Ÿè®¸ä¸å¯èƒ½å‘å®¢æˆ·ç«¯å‘é€å¤±è´¥é€šçŸ¥ã€‚å¯¹äºæŸäº› â€œæœ‰çŠ¶æ€â€ çš„æœåŠ¡å™¨ (æ¯”å¦‚ Microsoft SQL Server)ï¼Œç»ˆæ­¢æœåŠ¡å™¨å¹¶é‡æ–°å¯åŠ¨æœåŠ¡å™¨çš„æ–°å®ä¾‹æ˜¯ä¸åˆ‡å®é™…çš„ã€‚å¯¹äºæœåŠ¡å™¨åº”ç”¨ç¨‹åºï¼Œä¸æœªå¤„ç†å¼‚å¸¸æœ‰å…³çš„ä¿¡æ¯ä¸åº”è¿”å›å®¢æˆ·ç«¯ï¼Œå› ä¸ºå®¢æˆ·ç«¯å¯¹è¿™ç§ä¿¡æ¯åŸºæœ¬ä¸Šæ˜¯æŸæ‰‹æ— ç­–çš„ï¼Œå°¤å…¶æ˜¯å‡å¦‚å®¢æˆ·ç«¯ç”±ä¸åŒçš„å…¬å¸å®ç°ã€‚å¦å¤–ï¼ŒæœåŠ¡å™¨åº”å°½é‡å°‘æš´éœ²è‡ªå·±çš„ç›¸å…³ä¿¡æ¯ï¼Œå‡å°‘è‡ªå·±è¢« â€œé»‘â€ çš„å‡ ç‡ã€‚</p><h2 id="debugging-exceptions"><a class="anchor" href="#debugging-exceptions">#</a> Debugging Exceptions</h2><blockquote><p>The Visual Studio debugger offers special support for exceptions. With a solution open, choose Exceptions from the Debug menu, and youâ€™ll see the dialog box shown in Figure 20-4.</p></blockquote><p><img data-src="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/image-20221127163155842.png" alt="image-20221127163155842"></p><p><strong>FIGURE 20-4</strong> The Exceptions dialog box, showing the different kinds of exceptions.</p><blockquote><p>This dialog box shows the different kinds of exceptions that Visual Studio is aware of. For Common Language Runtime Exceptions, expanding the corresponding branch in the dialog box, as in Figure 20-5, shows the set of namespaces that the Visual Studio debugger is aware of.</p></blockquote><p><img data-src="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/image-20221127163255164.png" alt="image-20221127163255164"></p><p><strong>FIGURE 20-5</strong> The Exceptions dialog box, showing CLR exceptions by namespace.</p><blockquote><p>If you expand a namespace, youâ€™ll see all of the System.Exception-derived types defined within that namespace. For example, Figure 20-6 shows what youâ€™ll see if you open the System namespace.</p></blockquote><blockquote><p>For any exception type, if its Thrown check box is selected, the debugger will break as soon as that exception is thrown. At this point, the CLR has not tried to find any matching catch blocks. This is useful if you want to debug your code that catches and handles an exception. It is also useful when you suspect that a component or library may be swallowing or re-throwing exceptions, and you are uncertain where exactly to set a break point to catch it in the act.</p></blockquote><p><img data-src="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/image-20221127163445451.png" alt="image-20221127163445451"></p><p><strong>FIGURE 20-6</strong> The Exceptions dialog box, showing CLR exceptions defined in the System namespace.</p><blockquote><p>If an exception typeâ€™s Thrown check box is not selected, the debugger will also break where the exception was thrown, but only if the exception type was not handled. Developers usually leave the Thrown check box cleared because a handled exception indicates that the application anticipated the situation and dealt with it; the application continues running normally.</p></blockquote><blockquote><p>If you define your own exception types, you can add them to this dialog box by clicking Add. This causes the dialog box in Figure 20-7 to appear.</p></blockquote><p><img data-src="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/image-20221127163606140.png" alt="image-20221127163606140"></p><p><strong>FIGURE 20-7</strong> Making Visual Studio aware of your own exception type: the New Exception dialog box.</p><blockquote><p>In this dialog box, you first select the type of exception to be Common Language Runtime Exceptions, and then you can enter the fully qualified name of your own exception type. Note that the type you enter doesnâ€™t have to be a type derived from System.Exception; nonâ€“CLS-compliant types are fully supported. If you have two or more types with the same name but in different assemblies, there is no way to distinguish the types from one another. Fortunately, this situation rarely happens.</p></blockquote><blockquote><p>If your assembly defines several exception types, you must add them one at a time. In the future, Iâ€™d like to see this dialog box allow me to browse for an assembly and automatically import all Exception-derived types into Visual Studioâ€™s debugger. Each type could then be identified by assembly as well, which would fix the problem of having two types with the same name in different assemblies.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šå¯¹äºä»»ä½•å¼‚å¸¸ç±»å‹ï¼Œå¦‚æœå‹¾é€‰äº† â€œå¼•å‘â€ é€‰é¡¹æ¡†ï¼Œè°ƒè¯•å™¨å°±ä¼šåœ¨æŠ›å‡ºè¯¥å¼‚å¸¸æ—¶ä¸­æ–­ã€‚æ³¨æ„åœ¨ä¸­æ–­æ—¶ï¼ŒCLR è¿˜æ²¡æœ‰å°è¯•å»æŸ¥æ‰¾ä»»ä½•åŒ¹é…çš„ <code>catch</code> å—ã€‚è¦å¯¹æ•æ‰å’Œå¤„ç†ä¸€ä¸ªå¼‚å¸¸çš„ä»£ç è¿›è¡Œè°ƒè¯•ï¼Œè¿™ä¸ªåŠŸèƒ½ç›¸å½“æœ‰ç”¨ã€‚å¦å¤–ï¼Œå¦‚æœæ€€ç–‘ä¸€ä¸ªç»„ä»¶æˆ–åº“ â€œåå™¬â€ äº†å¼‚å¸¸æˆ–è€…é‡æ–°æŠ›å‡ºäº†å¼‚å¸¸ï¼Œä½†ä¸ç¡®å®šåœ¨ä»€ä¹ˆä½ç½®è®¾ç½®æ–­ç‚¹æ¥æ•æ‰å®ƒï¼Œè¿™ä¸ªåŠŸèƒ½ä¹Ÿå¾ˆæœ‰ç”¨ã€‚å¦‚æœå¼‚å¸¸ç±»å‹çš„ â€œå¼•å‘â€ æ¡†æ²¡æœ‰å‹¾é€‰ï¼Œè°ƒè¯•å™¨åªæœ‰åœ¨è¯¥å¼‚å¸¸ç±»å‹æœªå¾—åˆ°å¤„ç†æ—¶æ‰ä¸­æ–­ã€‚å¼€å‘äººå‘˜ä¸€èˆ¬éƒ½ä¿æŒ â€œå¼•å‘â€ é€‰é¡¹æ¡†çš„æœªå‹¾é€‰çŠ¶æ€ï¼Œå› ä¸ºçš„åˆ°å¤„ç†çš„å¼‚å¸¸è¡¨æ˜åº”ç”¨ç¨‹åºå·²é¢„è§åˆ°äº†å¼‚å¸¸ï¼Œå¹¶ä¼šå¯¹å®ƒè¿›è¡Œå¤„ç†ï¼›åº”ç”¨ç¨‹åºèƒ½ç»§ç»­æ­£å¸¸è¿è¡Œã€‚</p><h2 id="exception-handling-performance-considerations"><a class="anchor" href="#exception-handling-performance-considerations">#</a> Exception-Handling Performance Considerations</h2><blockquote><p>The developer community actively debates the performance of exception handling. Some people claim that exception handling performance is so bad that they refuse to even use exception handling. However, I contend that in an object-oriented platform, exception handling is not an option; it is mandatory. And besides, if you didnâ€™t use it, what would you use instead? Would you have your methods return true/false to indicate success/failure or perhaps some error code enum type? Well, if you did this, then you have the worst of both worlds: the CLR and the class library code will throw exceptions and your code will return error codes. Youâ€™d have to now deal with both of these in your code.</p></blockquote><blockquote><p>Itâ€™s difficult to compare performance between exception handling and the more conventional means of reporting exceptions (such as HRESULTs, special return codes, and so forth). If you write code to check the return value of every method call and filter the return value up to your own callers, your applicationâ€™s performance will be seriously affected. But performance aside, the amount of additional coding you must do and the potential for mistakes is incredibly high when you write code to check the return value of every method. Exception handling is a much better alternative.</p></blockquote><blockquote><p>However, exception handling has a price: unmanaged C++ compilers must generate code to track which objects have been constructed successfully. The compiler must also generate code that, when an exception is caught, calls the destructor of each successfully constructed object. Itâ€™s great that the compiler takes on this burden, but it generates a lot of bookkeeping code in your application, adversely affecting code size and execution time.</p></blockquote><blockquote><p>On the other hand, managed compilers have it much easier because managed objects are allocated in the managed heap, which is monitored by the garbage collector. If an object is successfully constructed and an exception is thrown, the garbage collector will eventually free the objectâ€™s memory. Compilers donâ€™t need to emit any bookkeeping code to track which objects are constructed successfully and donâ€™t need to ensure that a destructor has been called. Compared to unmanaged C++, this means that less code is generated by the compiler, and less code has to execute at run time, resulting in better performance for your application.</p></blockquote><blockquote><p>Over the years, Iâ€™ve used exception handling in different programming languages, different operating systems, and different CPU architectures. In each case, exception handling is implemented differently with each implementation having its pros and cons with respect to performance. Some implementations compile exception handling constructs directly into a method, whereas other implementations store information related to exception handling in a data table associated with the methodâ€”this table is accessed only if an exception is thrown. Some compilers canâ€™t inline methods that contain exception handlers, and some compilers wonâ€™t enregister variables if the method contains exception handlers.</p></blockquote><blockquote><p>The point is that you canâ€™t determine how much additional overhead is added to an application when using exception handling. In the managed world, itâ€™s even more difficult to tell because your assemblyâ€™s code can run on any platform that supports the .NET Framework. So the code produced by the JIT compiler to manage exception handling when your assembly is running on an x86 machine will be very different from the code produced by the JIT compiler when your code is running on an x64 or ARM processor. Also, JIT compilers associated with other CLR implementations (such as Microsoftâ€™s .NET Compact Framework or the open-source Mono project) are likely to produce different code.</p></blockquote><blockquote><p>Actually, Iâ€™ve been able to test some of my own code with a few different JIT compilers that Microsoft has internally, and the difference in performance that Iâ€™ve observed has been quite dramatic and surprising. The point is that you must test your code on the various platforms that you expect your users to run on, and make changes accordingly. Again, I wouldnâ€™t worry about the performance of using exception handling; the benefits typically far outweigh any negative performance impact.</p></blockquote><blockquote><p>If youâ€™re interested in seeing how exception handling impacts the performance of your code, you can use the Performance Monitor tool that comes with Windows. The screen in Figure 20-8 shows the exception-related counters that are installed along with the .NET Framework.</p></blockquote><blockquote><p>Occasionally, you come across a method that you call frequently that has a high failure rate. In this situation, the performance hit of having exceptions thrown can be intolerable. For example, Microsoft heard back from several customers who were calling Int32â€™s Parse method, frequently passing in data entered from an end user that could not be parsed. Because Parse was called frequently, the performance hit of throwing and catching the exceptions was taking a large toll on the applicationâ€™s overall performance.</p></blockquote><p>FIGURE 20-8 Performance Monitor showing the .NET CLR Exceptions counters.</p><blockquote><p>To address customersâ€™ concerns and to satisfy all the guidelines described in this chapter, Microsoft added a new method to the Int32 class. This new method is called TryParse, and it has two overloads that look like the following.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryParse</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name">Int32</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Boolean</span> <span class="token function">TryParse</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">NumberStyles</span> styles<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> IFormatProvider<span class="token punctuation">,</span> provider<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name">Int32</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Youâ€™ll notice that these methods return a Boolean that indicates whether the String passed in contains characters that can be parsed into an Int32. These methods also return an output parameter named result. If the methods return true, result will contain the result of parsing the string into a 32-bit integer. If the methods return false, result will contain 0, but you really shouldnâ€™t execute any code that looks at it anyway.</p></blockquote><blockquote><p>One thing I want to make absolutely clear: A TryXxx methodâ€™s Boolean return value returns false to indicate one and only one type of failure. The method should still throw exceptions for any other type of failure. For example, Int32â€™s TryParse throws an ArgumentException if the styleâ€™s argument is not valid, and it is certainly still possible to have an OutOfMemoryException thrown when calling TryParse.</p></blockquote><blockquote><p>I also want to make it clear that object-oriented programming allows programmers to be productive. One way that it does this is by not exposing error codes in a typeâ€™s members. In other words, constructors, methods, properties, etc. are all defined with the idea that calling them wonâ€™t fail. And, if defined correctly, for most uses of a member, it will not fail, and there will be no performance hit because an exception will not be thrown.</p></blockquote><blockquote><p>When defining types and their members, you should define the members so that it is unlikely that they will fail for the common scenarios in which you expect your types to be used. If you later hear from users that they are dissatisfied with the performance due to exceptions being thrown, then and only then should you consider adding TryXxx methods. In other words, you should produce the best object model first and then, if users push back, add some TryXxx methods to your type so that the users who experience performance trouble can benefit. Users who are not experiencing performance trouble should continue to use the non-TryXxx versions of the methods because this is the better object model.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šå¼‚å¸¸å¤„ç†å’Œè¾ƒå¸¸è§„çš„å¼‚å¸¸æŠ¥å‘Šæ–¹å¼ ( <code>HRESULT</code> å’Œ ç‰¹æ®Šè¿”å›ç ç­‰) ç›¸æ¯”ï¼Œå¾ˆéš¾çœ‹å‡ºä¸¤è€…åœ¨æ€§èƒ½ä¸Šçš„å·®å¼‚ã€‚å¦‚æœå†™ä»£ç æ£€æŸ¥æ¯ä¸ªæ–¹æ³•è°ƒç”¨çš„è¿”å›å€¼å¹¶å°†è¿”å›å€¼ â€œæ¼â€ ç»™è°ƒç”¨è€…ï¼Œåº”ç”¨ç¨‹åºæ€§èƒ½å°†å—åˆ°ä¸¥é‡å½±å“ã€‚å°±ç®—ä¸è€ƒè™‘æ€§èƒ½ï¼Œç”±äºè¦å†™ä»£ç æ£€æŸ¥æ¯ä¸ªæ–¹æ³•çš„è¿”å›å€¼ï¼Œä¹Ÿå¿…é¡»è¿›è¡Œå¤§é‡é¢å¤–çš„ç¼–ç¨‹ï¼Œè€Œä¸”å‡ºé”™å‡ ç‡ä¹Ÿä¼šå¤§å¢ã€‚å¼‚å¸¸å¤„ç†çš„ä¼˜é€‰æ–¹æ¡ˆã€‚ä½†å¼‚å¸¸å¤„ç†ä¹Ÿæ˜¯æœ‰ä»£ä»·çš„ï¼šéæ‰˜ç®¡ C++ ç¼–è¯‘å™¨å¿…é¡»ç”Ÿæˆä»£ç æ¥è·Ÿè¸ªå“ªäº›å¯¹è±¡è¢«æˆåŠŸæ„é€ ã€‚ç¼–è¯‘å™¨è¿˜å¿…é¡»ç”Ÿæˆä»£ç ï¼Œä»¥ä¾¿åœ¨ä¸€ä¸ªå¼‚å¸¸è¢«æ•æ‰åˆ°çš„æ—¶å€™ï¼Œè°ƒç”¨æ¯ä¸ªå·²æˆåŠŸæ„é€ çš„å¯¹è±¡çš„ææ„å™¨ã€‚ç”±ç¼–è¯‘å™¨æ‹…è´Ÿè¿™ä¸ªè´£ä»»æ˜¯å¾ˆå¥½çš„ï¼Œä½†ä¼šåœ¨åº”ç”¨ç¨‹åºä¸­ç”Ÿæˆå¤§é‡è–„è®° (bookkeeping) ä»£ç ï¼Œå¯¹ä»£ç çš„å¤§å°å’Œæ‰§è¡Œæ—¶é—´é€ æˆè´Ÿé¢å½±å“ã€‚å¦ä¸€æ–¹é¢ï¼Œæ‰˜ç®¡ç¼–è¯‘å™¨å°±è¦è½»æ¾å¾—å¤šï¼Œå› ä¸ºæ‰˜ç®¡å¯¹è±¡åœ¨æ‰˜ç®¡å †ä¸­åˆ†é…ï¼Œè€Œæ‰˜ä¹±å †å—åƒåœ¾å›æ”¶å™¨çš„ç›‘è§†ã€‚å¦‚å¯¹è±¡æˆåŠŸæ„é€ ï¼Œè€Œä¸”æŠ›å‡ºäº†å¼‚å¸¸ï¼Œåƒåœ¾å›æ”¶å™¨æœ€ç»ˆä¼šé‡Šæ”¾å¯¹è±¡çš„å†…å­˜ã€‚ç¼–è¯‘å™¨æ— éœ€ç”Ÿæˆä»»ä½•è–„è®°ä»£ç æ¥è·Ÿè¸ªæˆåŠŸæ„é€ çš„å¯¹è±¡ï¼Œä¹Ÿæ— éœ€ä¿è¯ææ„å™¨çš„è°ƒç”¨ã€‚æ€»ä¹‹ï¼Œä¸å¥½åˆ¤æ–­å¼‚å¸¸å¤„ç†åˆ°åº•ä¼šä½¿åº”ç”¨ç¨‹åºå¢å¤§å¤šå°‘é¢å¤–çš„å¼€é”€ã€‚åœ¨æ‰˜ç®¡ä¸–ç•Œé‡Œæ›´ä¸å¥½è¯´ï¼Œå› ä¸ºç¨‹åºé›†çš„ä»£ç å­åœ¨æ”¯æŒ .NET Framework çš„ä»»ä½•å¹³å°ä¸Šéƒ½èƒ½è¿è¡Œã€‚æ‰€ä»¥ï¼Œå½“ç¨‹åºé›†åœ¨ x86 å¤„ç†å™¨ä¸Šè¿è¡Œæ—¶ï¼ŒJIT ç¼–è¯‘å™¨ç”Ÿæˆçš„ç”¨äºç®¡ç†å¼‚å¸¸å¤„ç†çš„ä»£ç ä¹Ÿä¼šæ˜¾è‘—æœ‰åˆ«äºç¨‹åºé›†åœ¨ x64 æˆ– ARM å¤„ç†å™¨ä¸Šè¿è¡Œæ—¶ç”Ÿæˆçš„ä»£ç ã€‚å¦å¤–ï¼Œä¸å…¶ä»– CLR å®ç° (æ¯”å¦‚ Microsoft çš„ .NET Compact Framework æˆ–è€…å¼€æº Mono é¡¹ç›®) å…³è”çš„ JIT ç¼–è¯‘å™¨ä¹Ÿæœ‰å¯èƒ½ç”Ÿæˆä¸åŒçš„ä»£ç ã€‚å®šä¹‰ç±»å‹çš„æˆå‘˜æ—¶ï¼Œåº”ç¡®ä¿åœ¨ä¸€èˆ¬ä½¿ç”¨æƒ…å½¢ä¸­ä¸ä¼šå¤±è´¥ã€‚åªæœ‰ç”¨æˆ·ä»¥åå› ä¸ºæŠ›å‡ºå¼‚å¸¸é¢å¯¹æ€§èƒ½ä¸æ»¡æ„æ—¶ï¼Œæ‰åº”è€ƒè™‘æ·»åŠ ä¸€äº› <code>TryXXX</code> æ–¹æ³•ã€‚æ¢è¨€ä¹‹ï¼Œé¦–å…ˆåº”å»ºç«‹ä¸€ä¸ªæœ€ä½³çš„å¯¹è±¡æ¨¡å‹ã€‚ç„¶åï¼Œåªæœ‰åœ¨ç”¨æˆ·æŠ±æ€¨çš„æ—¶å€™ï¼Œæ‰åœ¨ç±»å‹ä¸­æ·»åŠ ä¸€äº› <code>TryXXX</code> æ–¹æ³•ï¼Œå¸®åŠ©é­é‡æ€§èƒ½é—®é¢˜çš„ç”¨æˆ·æ”¹å–„æ€§èƒ½ã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰é‡åˆ°æ€§èƒ½é—®é¢˜ï¼Œé‚£ä¹ˆåº”ç»§ç»­ä½¿ç”¨æ–¹æ³•çš„é <code>TryXXX</code> ç‰ˆæœ¬ï¼Œå› ä¸ºé‚£æ˜¯æ›´ä½³çš„å¯¹è±¡æ¨¡å‹ã€‚</p><h2 id="constrained-execution-regions-cers"><a class="anchor" href="#constrained-execution-regions-cers">#</a> Constrained Execution Regions (CERs)</h2><blockquote><p>Many applications donâ€™t need to be robust and recover from any and all kinds of failures. This is true of many client applications like Notepad.exe and Calc.exe. And, of course, many of us have seen Microsoft Office applications like WinWord.exe, Excel.exe, and Outlook.exe terminate due to unhandled exceptions. Also, many server-side applications, like web servers, are stateless and are automatically restarted if they fail due to an unhandled exception. Of course some servers, like SQL Server, are all about state management and having data lost due to an unhandled exception is potentially much more disastrous.</p></blockquote><blockquote><p>In the CLR, we have AppDomains (discussed in Chapter 22), which contain state. When an AppDomain is unloaded, all its state is unloaded. And so, if a thread in an AppDomain experiences an unhandled exception, it is OK to unload the AppDomain (which destroys all its state) without terminating the whole process.</p></blockquote><blockquote><p>By definition, a CER is a block of code that must be resilient to failure. Because AppDomains can be unloaded, destroying their state, CERs are typically used to manipulate any state that is shared by multiple AppDomains or processes. CERs are useful when trying to maintain state in the face of exceptions that get thrown unexpectedly. Sometimes we refer to these kinds of exceptions as asynchronous exceptions. For example, when calling a method, the CLR has to load an assembly, create a type object in the AppDomainâ€™s loader heap, call the typeâ€™s static constructor, JIT IL into native code, and so on. Any of these operations could fail, and the CLR reports the failure by throwing an exception.</p></blockquote><blockquote><p>If any of these operations fail within a catch or finally block, then your error recovery or cleanup code wonâ€™t execute in its entirety. Here is an example of code that exhibits the potential problem.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Demo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"In try"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Type1â€™s static constructor is implicitly called in here</span></pre></td></tr><tr><td data-num="7"></td><td><pre> Type1<span class="token punctuation">.</span><span class="token function">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Type1</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">static</span> <span class="token function">Type1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// if this throws an exception, M wonâ€™t get called</span></pre></td></tr><tr><td data-num="13"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Type1's static ctor called"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When I run the preceding code, I get the following output.</p></blockquote><pre><code class="language-cmd">In try
Type1's static ctor called
</code></pre><blockquote><p>What we want is to not even start executing the code in the preceding try block unless we know that the code in the associated catch and finally blocks is guaranteed (or as close as we can get to guaranteed) to execute. We can accomplish this by modifying the code as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Demo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Force the code in the finally to be eagerly prepared</span></pre></td></tr><tr><td data-num="3"></td><td><pre> RuntimeHelpers<span class="token punctuation">.</span><span class="token function">PrepareConstrainedRegions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// System.Runtime.CompilerServices namespace</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"In try"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Type2â€™s static constructor is implicitly called in here</span></pre></td></tr><tr><td data-num="9"></td><td><pre> Type2<span class="token punctuation">.</span><span class="token function">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Type2</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">static</span> <span class="token function">Type2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Type2's static ctor called"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token comment">// Use this attribute defined in the System.Runtime.ConstrainedExecution namespace</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">[</span><span class="token function">ReliabilityContract</span><span class="token punctuation">(</span>Consistency<span class="token punctuation">.</span>WillNotCorruptState<span class="token punctuation">,</span> Cer<span class="token punctuation">.</span>Success<span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Now, when I run this version of the code, I get the following output.</p></blockquote><pre><code class="language-cmd">Type2's static ctor called
In try
</code></pre><blockquote><p>The PrepareConstrainedRegions method is a very special method. When the JIT compiler sees this method being called immediately before a try block, it will eagerly compile the code in the tryâ€™s catch and finally blocks. The JIT compiler will load any assemblies, create any type objects, invoke any static constructors, and JIT any methods. If any of these operations result in an exception, then the exception occurs before the thread enters the try block.</p></blockquote><blockquote><p>When the JIT compiler eagerly prepares methods, it also walks the entire call graph eagerly preparing called methods. However, the JIT compiler only prepares methods that have the ReliabilityContractAttribute applied to them with either Consistency.WillNotCorruptState or Consistency.MayCorruptInstance because the CLR canâ€™t make any guarantees about methods that might corrupt AppDomain or process state. Inside a catch or finally block that you are protecting with a call to PrepareConstrainedRegions, you want to make sure that you only call methods with the ReliabillityContractAttribute set as Iâ€™ve just described.</p></blockquote><blockquote><p>The ReliabilityContractAttribute looks like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">ReliabilityContractAttribute</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token function">ReliabilityContractAttribute</span><span class="token punctuation">(</span><span class="token class-name">Consistency</span> consistencyGuarantee<span class="token punctuation">,</span> <span class="token class-name">Cer</span> cer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Cer</span> Cer <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Consistency</span> ConsistencyGuarantee <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>This attribute lets a developer document the reliability contract of a particular method to the methodâ€™s potential callers. Both the Cer and Consistency types are enumerated types defined as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">enum</span> <span class="token class-name">Consistency</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> MayCorruptProcess<span class="token punctuation">,</span> MayCorruptAppDomain<span class="token punctuation">,</span> MayCorruptInstance<span class="token punctuation">,</span> WillNotCorruptState</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">enum</span> <span class="token class-name">Cer</span> <span class="token punctuation">&#123;</span> None<span class="token punctuation">,</span> MayFail<span class="token punctuation">,</span> Success <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If the method you are writing promises not to corrupt any state, use Consistency.WillNotCorruptState. Otherwise, document what your method does by using one of the other three possible values that match whatever state your method might corrupt. If the method that you are writing promises not to fail, use Cer.Success. Otherwise, use Cer.MayFail. Any method that does not have the ReliabiiltyContractAttribute applied to it is equivalent to being marked like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ReliabilityContract</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Consistency<span class="token punctuation">.</span>MayCorruptProcess<span class="token punctuation">,</span> Cer<span class="token punctuation">.</span>None<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span></pre></td></tr></table></figure><blockquote><p>The Cer.None value indicates that the method makes no CER guarantees. In other words, it wasnâ€™t written with CERs in mind; therefore, it may fail and it may or may not report that it failed. Remember that most of these settings are giving a method a way to document what it offers to potential callers so that they know what to expect. The CLR and JIT compiler do not use this information.</p></blockquote><blockquote><p>When you want to write a reliable method, make it small and constrain what it does. Make sure that it doesnâ€™t allocate any objects (no boxing, for example), donâ€™t call any virtual methods or interface methods, use any delegates, or use reflection because the JIT compiler canâ€™t tell what method will actually be called. However, you can manually prepare these methods by calling one of these methods defined by the RuntimeHelpersâ€™s class.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">PrepareMethod</span><span class="token punctuation">(</span><span class="token class-name">RuntimeMethodHandle</span> method<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">PrepareMethod</span><span class="token punctuation">(</span><span class="token class-name">RuntimeMethodHandle</span> method<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name">RuntimeTypeHandle<span class="token punctuation">[</span><span class="token punctuation">]</span></span> instantiation<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">PrepareDelegate</span><span class="token punctuation">(</span><span class="token class-name">Delegate</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">PrepareContractedDelegate</span><span class="token punctuation">(</span><span class="token class-name">Delegate</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Note that the compiler and the CLR do nothing to verify that youâ€™ve written your method to actually live up to the guarantees you document via the ReliabiltyContractAttribute. If you do something wrong, then state corruption is possible.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šå³ä½¿æ‰€æœ‰æ–¹æ³•éƒ½æå‰å‡†å¤‡å¥½ï¼Œæ–¹æ³•è°ƒç”¨ä»æœ‰å¯èƒ½é€ æˆ <code>StackOverflowException</code> ã€‚åœ¨ CLR æ²¡æœ‰å¯„å®¿çš„å‰æä¸‹ï¼Œ <code>StackOverflowException</code> ä¼šé€ æˆ CLR åœ¨å†…éƒ¨è°ƒç”¨ <code>Environment.FailFast</code> æ¥ç«‹å³ç»ˆæ­¢è¿›ç¨‹ã€‚åœ¨å·²ç»å¯„å®¿çš„å‰æä¸‹ï¼Œ <code>PrepareConstrainedRegions</code> æ–¹æ³•æ£€æŸ¥æ˜¯å¦å‰©ä¸‹çº¦ 48 KB çš„æ ˆç©ºé—´ã€‚æ ˆç©ºé—´ä¸è¶³ï¼Œå°±åœ¨è¿›å…¥ <code>try</code> å—å‰æŠ›å‡º <code>StackOverflowException</code> ã€‚</p><blockquote><p>You should also look at RuntimeHelperâ€™s ExecuteCodeWithGuaranteedCleanup method, which is another way to execute code with guaranteed cleanup.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ExecuteCodeWithGuaranteedCleanup</span><span class="token punctuation">(</span><span class="token class-name">TryCode</span> code<span class="token punctuation">,</span> <span class="token class-name">CleanupCode</span> backoutCode<span class="token punctuation">,</span> <span class="token class-name">Object</span> userData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>When calling this method, you pass the body of the try and finally block as callback methods whose prototypes match these two delegates respectively.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TryCode</span><span class="token punctuation">(</span><span class="token class-name">Object</span> userData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CleanupCode</span><span class="token punctuation">(</span><span class="token class-name">Object</span> userData<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> exceptionThrown<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>And finally, another way to get guaranteed code execution is to use the CriticalFinalizerObject class, which is explained in great detail in Chapter 21.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šè®¸å¤šæœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åº (æ¯”å¦‚ Web æœåŠ¡å™¨) éƒ½æ˜¯æ— çŠ¶æ€çš„ï¼Œä¼šåœ¨å› ä¸ºæœªå¤„ç†çš„å¼‚å¸¸è€Œå¤±è´¥æ—¶è‡ªåŠ¨é‡å¯ã€‚å½“ç„¶ï¼ŒæŸäº›æœåŠ¡å™¨ (æ¯”å¦‚ SQL Server) æœ¬æ¥å°±æ˜¯ä¸ºçŠ¶æ€ç®¡ç†è€Œè®¾è®¡çš„ã€‚è¿™ç§ç¨‹åºå‡å¦‚å› ä¸ºæœªå¤„ç†çš„å¼‚å¸¸è€Œå‘ç”Ÿæ•°æ®ä¸¢å¤±ï¼Œåæœå°†æ˜¯ç¾éš¾æ€§çš„ã€‚åœ¨ CLR ä¸­ï¼Œæˆ‘ä»¬æœ‰åŒ…å«äº†çŠ¶æ€çš„ AppDomainã€‚AppDomain å¸è½½æ—¶ï¼Œå®ƒçš„æ‰€æœ‰çŠ¶æ€éƒ½ä¼šå¸è½½ã€‚æ‰€ä»¥ï¼Œå¦‚æœ AppDomain ä¸­çš„ä¸€ä¸ªçº¿ç¨‹é­é‡æœªå¤„ç†çš„å¼‚å¸¸ï¼Œå¯ä»¥åœ¨ä¸ç»ˆæ­¢æ•´ä¸ªè¿›ç¨‹çš„æƒ…å†µä¸‹å¸è½½ AppDomainã€‚æ ¹æ®å®šä¹‰ï¼ŒCER æ˜¯å¿…é¡»å¯¹é”™è¯¯æœ‰é€‚åº”åŠ›çš„ä»£ç å—ã€‚ç”±äº AppDomain å¯èƒ½è¢«å¸è½½ï¼Œé€ æˆå®ƒçš„çŠ¶æ€è¢«é”€æ¯ï¼Œæ‰€ä»¥ä¸€èˆ¬ç”¨ CER å¤„ç†ç”±å¤šä¸ª AppDomain æˆ–è¿›ç¨‹å…±äº«çš„çŠ¶æ€ã€‚å¦‚æœè¦åœ¨æŠ›å‡ºäº†éé¢„æœŸçš„å¼‚å¸¸æ—¶ç»´æŠ¤çŠ¶æ€ï¼ŒCER å°±éå¸¸æœ‰ç”¨ã€‚æœ‰æ—¶å€™è¿™äº›å¼‚å¸¸ç§°å¼‚æ­¥å¼‚å¸¸ã€‚ <code>PrepareConstrainedRegions</code> æ˜¯ä¸€ä¸ªå¾ˆç‰¹åˆ«çš„æ–¹æ³•ã€‚JIT ç¼–è¯‘å™¨å¦‚æœå‘ç°åœ¨ä¸€ä¸ª <code>try</code> å—ä¹‹å‰è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œå°±ä¼šæå‰ç¼–è¯‘ä¸ <code>try</code> å…³è”çš„ <code>catch</code> å’Œ <code>finally</code> å—ä¸­çš„ä»£ç ã€‚JIT ç¼–è¯‘å™¨ä¼šåŠ è½½ä»»ä½•ç¨‹åºé›†ï¼Œåˆ›å»ºä»»ä½•ç±»å‹å¯¹è±¡ï¼Œè°ƒç”¨ä»»ä½•é™æ€æ„é€ å™¨ï¼Œå¹¶å¯¹ä»»ä½•æ–¹æ³•è¿›è¡Œ JIT ç¼–è¯‘ã€‚å¦‚æœå…¶ä¸­ä»»ä½•æ“ä½œåšæˆå¼‚å¸¸ï¼Œè¿™ä¸ªå¼‚å¸¸ä¼šåœ¨çº¿ç¨‹è¿›å…¥ <code>try</code> å—ä¹‹å‰å‘ç”Ÿã€‚JIT ç¼–è¯‘å™¨æå‰å‡†å¤‡æ–¹æ³•æ—¶ï¼Œè¿˜ä¼šéå†æ•´ä¸ªè°ƒç”¨å›¾ï¼Œæå‰å‡†å¤‡è¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œå‰ææ˜¯è¿™äº›æ–¹æ³•åº”ç”¨äº† <code>ReliabilityContractAttribute</code> ï¼Œè€Œä¸”å‘è¿™ä¸ªç‰¹æ€§å®ä¾‹çš„æ„é€ å™¨ä¼ é€’çš„æ˜¯ <code>Consistency.WillNotCorruptState</code> æˆ–è€… <code>Consistency.MayCorruptInstance</code> æšä¸¾æˆå‘˜ã€‚è¿™æ˜¯ç”±äºå‡å¦‚æ–¹æ³•ä¼šæŸå AppDomain æˆ–è¿›ç¨‹çš„çŠ¶æ€ï¼ŒCLR ä¾¿æ— æ³•å¯¹çŠ¶æ€ä¸€è‡´æ€§åšå‡ºä»»ä½•ä¿è¯ã€‚åœ¨é€šè¿‡ä¸€ä¸ª <code>PrepareConstrainedRegions</code> è°ƒç”¨æ¥ä¿æŠ¤çš„ä¸€ä¸ª <code>catch</code> æˆ– <code>finally</code> å—ä¸­ï¼Œè¯·ç¡®ä¿åªè°ƒç”¨æ ¹æ®åˆšæ‰çš„æè¿°è®¾ç½®äº† <code>ReliabilityContractAttribute</code> çš„æ–¹æ³•ã€‚ <code>ReliabilityContractAttribute</code> ç‰¹æ€§å…è®¸å¼€å‘è€…å‘æ–¹æ³•çš„æ½œåœ¨è°ƒç”¨è€…ç”³æ˜æ–¹æ³•çš„å¯é æ€§åå®š (reliability contract)ã€‚ <code>Cer</code> å’Œ <code>Consistency</code> éƒ½æ˜¯æšä¸¾ç±»å‹ã€‚ <code>Cer.None</code> è¿™ä¸ªå€¼è¡¨æ˜æ–¹æ³•ä¸è¿›è¡Œ CER ä¿è¯ã€‚æ¢è¨€ä¹‹ï¼Œæ–¹æ³•æ²¡æœ‰ CER çš„æ¦‚å¿µã€‚å› æ­¤ï¼Œè¿™ä¸ªæ–¹æ³•å¯èƒ½å¤±è´¥ï¼Œè€Œä¸”å¯èƒ½ä¼šã€ä¹Ÿå¯èƒ½ä¸ä¼šæŠ¥å‘Šå¤±è´¥ã€‚è®°ä½ï¼Œå¤§å¤šæ•°è¿™äº›è®¾ç½®éƒ½ä¸ºæ–¹æ³•æä¾›äº†ä¸€ç§æ–¹å¼æ¥ç”³æ˜å®ƒå‘æ½œåœ¨çš„è°ƒç”¨è€…æä¾›çš„ä¸œè¥¿ï¼Œä½¿è°ƒç”¨è€…çŸ¥é“ä»€ä¹ˆå¯ä»¥æœŸå¾…ã€‚CLR å’Œ JIT ç¼–è¯‘å™¨ä¸ä½¿ç”¨è¿™ç§ä¿¡æ¯ã€‚å¦‚æœæƒ³å†™ä¸€ä¸ªå¯é çš„æ–¹æ³•ï¼ŒåŠ¡å¿…ä¿æŒå®ƒçš„çŸ­å°ç²¾æ‚ï¼ŒåŒæ—¶çº¦æŸå®ƒåšçš„äº‹æƒ…ã€‚è¦ä¿è¯å®ƒä¸åˆ†é…ä»»ä½•å¯¹è±¡ (ä¾‹å¦‚ä¸è£…ç®±)ã€‚å¦å¤–ï¼Œä¸è°ƒç”¨ä»»ä½•è™šæ–¹æ³•æˆ–æ¥å£æ–¹æ³•ï¼Œä¸ä½¿ç”¨ä»»ä½•å§”æ‰˜ï¼Œä¹Ÿä¸ä½¿ç”¨åå°„ï¼Œå› ä¸º JIT ç¼–è¯‘å™¨ä¸çŸ¥é“å®é™…ä¼šè°ƒç”¨å“ªä¸ªæ–¹æ³•ã€‚ç„¶è€Œï¼Œå¯ä»¥è°ƒç”¨ <code>RuntimeHelper</code> ç±»å®šä¹‰æ–¹æ³•ä¹‹ä¸€ï¼Œä»è€Œæ‰‹åŠ¨å‡†å¤‡è¿™äº›æ–¹æ³•ã€‚æ³¨æ„ï¼Œç¼–è¯‘å™¨å’Œ CLR å¹¶ä¸éªŒè¯ä½ å†™çš„æ–¹æ³•çœŸçš„ç¬¦åˆé€šè¿‡ <code>ReliabilityContractAttribute</code> æ¥ä½œå‡ºçš„ä¿è¯ã€‚æ‰€ä»¥ï¼Œå¦‚æœçŠ¯äº†é”™è¯¯ï¼ŒçŠ¶æ€ä»æœ‰å¯èƒ½æŸåã€‚è¿˜åº”è¯¥å…³æ³¨ä¸€ä¸‹ <code>RuntimeHelper</code> çš„ <code>ExecuteCodeWithGuaranteedCleanup</code> æ–¹æ³•ï¼Œå®ƒçš„èµ„æºä¿è¯å¾—åˆ°æ¸…ç†çš„å‰æä¸‹æ‰æ‰§è¡Œä»£ç ã€‚æœ€åï¼Œå¦ä¸€ç§ä¿è¯ä»£ç å¾—ä»¥æ‰§è¡Œçš„æ–¹å¼æ˜¯ä½¿ç”¨ <code>CriticalFinalizerObject</code> ç±»ã€‚</p><h2 id="code-contracts"><a class="anchor" href="#code-contracts">#</a> Code Contracts</h2><blockquote><p>Code contracts provide a way for you to declaratively document design decisions that youâ€™ve made about your code within the code itself. The contracts take the form of the following:</p><ul><li><p>Preconditions Typically used to validate arguments</p></li><li><p>Postconditions Used to validate state when a method terminates either due to a normal return or due to throwing an exception</p></li><li><p>Object Invariants Used to ensure an objectâ€™s fields remain in a good state through an objectâ€™s entire lifetime</p></li></ul></blockquote><blockquote><p>Code contracts facilitate code usage, understanding, evolution, testing, documentation, and early error detection.10 You can think of preconditions, postconditions, and object invariants as parts of a methodâ€™s signature. As such, you can loosen a contract with a new version of your code, but you cannot make a contract stricter with a new version without breaking backward compatibility.</p></blockquote><blockquote><p>At the heart of the code contracts is the static System.Diagnostics.Contracts.Contract class.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Contract</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Precondition methods: [Conditional("CONTRACTS_FULL")]</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Requires</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EndContractBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Preconditions: Always</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">Requires</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TException<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> condition<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TException</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Exception</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// Postcondition methods: [Conditional("CONTRACTS_FULL")]</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Ensures</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">EnsuresOnThrow</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TException<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> condition<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">where</span> <span class="token class-name">TException</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Exception</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// Special Postcondition methods: Always</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">Result</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">OldValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">T</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">ValueAtReturn</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">T</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token comment">// Object Invariant methods: [Conditional("CONTRACTS_FULL")]</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Invariant</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token comment">// Quantifier methods: Always</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Boolean</span> <span class="token generic-method"><span class="token function">Exists</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> collection<span class="token punctuation">,</span> <span class="token class-name">Predicate<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> predicate<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Exists</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> fromInclusive<span class="token punctuation">,</span> <span class="token class-name">Int32</span> toExclusive<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token class-name">Predicate<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">></span></span> predicate<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Boolean</span> <span class="token generic-method"><span class="token function">ForAll</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> collection<span class="token punctuation">,</span> <span class="token class-name">Predicate<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> predicate<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Boolean</span> <span class="token function">ForAll</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> fromInclusive<span class="token punctuation">,</span> <span class="token class-name">Int32</span> toExclusive<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token class-name">Predicate<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">></span></span> predicate<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token comment">// Helper methods: [Conditional("CONTRACTS_FULL")] or [Conditional("DEBUG")]</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Assert</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Assume</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token comment">// Infrastructure event: usually your code will not use this event </span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler<span class="token punctuation">&lt;</span>ContractFailedEventArgs<span class="token punctuation">></span></span> ContractFailed<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>As previously indicated, many of these static methods have the [Conditional(&quot;CONTRACTS_ FULL&quot;)] attribute applied to them. Some of the helper methods also have the [ConditionalÂ­ (&quot;DEBUG&quot;)] attribute applied to them. This means that the compiler will ignore any code you write that calls these methods unless the appropriate symbol is defined when compiling your code. Any methods marked with â€œAlwaysâ€ mean that the compiler always emits code to call the method. Also, the Requires, Requires, Ensures, EnsuresOnThrow, Invariant, Assert, and Assume methods have an additional overload (not shown) that takes a String message argument so you can explicitly specify a string message that should appear when the contract is violated.</p></blockquote><blockquote><p>By default, contracts merely serve as documentation because you would not define the CONTRACTS_FULL symbol when you build your project. In order to get some additional value out of using contracts, you must download additional tools and a Visual Studio property pane from <span class="exturl" data-url="aHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9kZXZsYWJzL2RkNDkxOTkyLmFzcHg=">http://msdn.microsoft.com/en-us/devlabs/dd491992.aspx</span>. The reason why all the code contract tools are not included with Visual Studio is because this technology is being improved rapidly. The Microsoft DevLabs website can offer new versions and improvements more quickly than Visual Studio itself. After downloading and installing the additional tools, you will see your projects have a new property pane available to them, as shown in Figure 20-9.</p></blockquote><p><strong>FIGURE 20-9</strong> The Code Contracts pane for a Visual Studio project.</p><blockquote><p>To turn on code contract features, select the Perform Runtime Contract Checking check box and select Full from the combo box next to it. This defines the CONTRACTS_FULL symbol when you build your project and invokes the appropriate tools (described shortly) after building your project. Now, at run time, when a contract is violated, Contractâ€™s ContractFailed event is raised. Usually, developers do not register any methods with this event, but if you do, then any methods you register will receive a ContractFailedEventArgs object that looks like this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">ContractFailedEventArgs</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">EventArgs</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token function">ContractFailedEventArgs</span><span class="token punctuation">(</span><span class="token class-name">ContractFailureKind</span> failureKind<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> condition<span class="token punctuation">,</span> <span class="token class-name">Exception</span> originalException<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">ContractFailureKind</span> FailureKind <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> Message <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> Condition <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Exception</span> OriginalException <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> Handled <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// true if any handler called SetHandled</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetHandled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Call to ignore the violation; sets Handled to true</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Boolean</span> Unwind <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// true if any handler called SetUnwind or threw</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetUnwind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Call to force ContractException; set Unwind to true</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Multiple event handler methods can be registered with this event. Each method can process the contract violation any way it chooses. For example, a handler can log the violation, ignore the violation (by calling SetHandled), or terminate the process. If any method calls SetHandled, then the violation will be considered handled and, after all the handler methods return, the application code is allowed to continue running unless any handler calls SetUnwind. If a handler calls SetUnwind, then, after all the handler methods have completed running, a System.Diagnostics.Contracts. ContractException is thrown. Note that this type is internal to MSCorLib.dll and therefore you cannot write a catch block to catch it explicitly. Also note that if any handler method throws an unhandled exception, then the remaining handler methods are invoked and then a ContractException is thrown.</p></blockquote><blockquote><p>If there are no event handlers or if none of them call SetHandled, SetUnwind, or throw an unhandled exception, then default processing of the contract violation happens next. If the CLR is being hosted, then the host is notified that a contract failed. If the CLR is running an application on a non-interactive window station (which would be the case for a Windows service application), then Environment.FailFast is called to instantly terminate the process. If you compile with the Assert On Contract Failure check box selected, then an assert dialog box will appear allowing you to connect a debugger to your application. If this option is not selected, then a ContractException is thrown.</p></blockquote><blockquote><p>Letâ€™s look at a sample class that is using code contracts.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Item</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingCart</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>Item<span class="token punctuation">></span></span> m_cart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Item<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">Decimal</span> m_totalCost <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token function">ShoppingCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddItem</span><span class="token punctuation">(</span><span class="token class-name">Item</span> item<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token function">AddItemHelper</span><span class="token punctuation">(</span>m_cart<span class="token punctuation">,</span> item<span class="token punctuation">,</span> <span class="token keyword">ref</span> m_totalCost<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddItemHelper</span><span class="token punctuation">(</span><span class="token class-name">List<span class="token punctuation">&lt;</span>Item<span class="token punctuation">></span></span> m_cart<span class="token punctuation">,</span> <span class="token class-name">Item</span> newItem<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">ref</span> <span class="token class-name">Decimal</span> totalCost<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Preconditions: </span></pre></td></tr><tr><td data-num="13"></td><td><pre> Contract<span class="token punctuation">.</span><span class="token function">Requires</span><span class="token punctuation">(</span>newItem <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> Contract<span class="token punctuation">.</span><span class="token function">Requires</span><span class="token punctuation">(</span>Contract<span class="token punctuation">.</span><span class="token function">ForAll</span><span class="token punctuation">(</span>m_cart<span class="token punctuation">,</span> s <span class="token operator">=></span> s <span class="token operator">!=</span> newItem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token comment">// Postconditions:</span></pre></td></tr><tr><td data-num="16"></td><td><pre> Contract<span class="token punctuation">.</span><span class="token function">Ensures</span><span class="token punctuation">(</span>Contract<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>m_cart<span class="token punctuation">,</span> s <span class="token operator">=></span> s <span class="token operator">==</span> newItem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> Contract<span class="token punctuation">.</span><span class="token function">Ensures</span><span class="token punctuation">(</span>totalCost <span class="token operator">>=</span> Contract<span class="token punctuation">.</span><span class="token function">OldValue</span><span class="token punctuation">(</span>totalCost<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> Contract<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">EnsuresOnThrow</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IOException<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>totalCost <span class="token operator">==</span> Contract<span class="token punctuation">.</span><span class="token function">OldValue</span><span class="token punctuation">(</span>totalCost<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">// Do some stuff (which could throw an IOException)...</span></pre></td></tr><tr><td data-num="20"></td><td><pre> m_cart<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>newItem<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> totalCost <span class="token operator">+=</span> <span class="token number">1.00M</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token comment">// Object invariant</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token punctuation">[</span>ContractInvariantMethod<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ObjectInvariant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> Contract<span class="token punctuation">.</span><span class="token function">Invariant</span><span class="token punctuation">(</span>m_totalCost <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The AddItemHelper method defines a bunch of code contracts. The preconditions indicate that newItem must not be null and that the item being added to the cart is not already in the cart. The postconditions indicate that the new item must be in the cart and that the total cost must be at least as much as it was before the item was added to the cart. The postconditions also indicate that if AddItemHelper were to throw an IOException for some reason, then totalCost is unchanged from what it was when the method started to execute. The ObjectInvariant method is just a private method that, when called, makes sure that the objectâ€™s m_totalCost field never contains a negative value.</p></blockquote><p>ğŸ’¡é‡è¦æç¤ºï¼šå‰æ¡ä»¶ã€åæ¡ä»¶æˆ–ä¸å˜æ€§æµ‹è¯•ä¸­å¼•ç”¨çš„ä»»ä½•æˆå‘˜éƒ½ä¸€å®šä¸èƒ½æœ‰å‰¯ä½œç”¨ (æ”¹å˜å¯¹è±¡çš„çŠ¶æ€)ã€‚è¿™æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºæµ‹è¯•æ¡ä»¶ä¸åº”æ”¹å˜å¯¹è±¡æœ¬èº«çš„çŠ¶æ€ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå‰æ¡ä»¶æµ‹è¯•ä¸­å¼•ç”¨çš„æ‰€æœ‰æˆå‘˜çš„å¯è®¿é—®æ€§éƒ½è‡³å°‘è¦å’Œå®šä¹‰å‰æ¡ä»¶çš„æ–¹æ³•ä¸€æ ·ã€‚è¿™æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºæ–¹æ³•çš„è°ƒç”¨è€…åº”è¯¥èƒ½åœ¨è°ƒç”¨æ–¹æ³•ä¹‹å‰éªŒè¯å®ƒä»¬ç¬¦åˆæ‰€æœ‰å‰æ¡ä»¶ã€‚å¦ä¸€æ–¹é¢ï¼Œåæ¡ä»¶æˆ–ä¸å˜æ€§æµ‹è¯•ä¸­å¼•ç”¨çš„æˆå‘˜å¯å…·æœ‰ä»»ä½•å¯è®¿é—®æ€§ï¼Œåªè¦ä»£ç èƒ½ç¼–è¯‘å°±è¡Œã€‚å¯è®¿é—®æ€§ä¹‹æ‰€ä»¥ä¸é‡è¦ï¼Œæ˜¯å› ä¸ºåæ¡ä»¶å’Œä¸å˜æ€§æµ‹è¯•ä¸å½±å“è°ƒç”¨è€…æ­£ç¡®è°ƒç”¨æ–¹æ³•çš„èƒ½åŠ›ã€‚</p><p>ğŸ’¡é‡è¦æç¤ºï¼šæ¶‰åŠç»§æ‰¿æ—¶ï¼Œæ´¾ç”Ÿç±»å‹ä¸èƒ½é‡å†™å¹¶æ›´æ”¹åŸºç±»å‹ä¸­å®šä¹‰çš„è™šæˆå‘˜çš„å‰æ¡ä»¶ã€‚ç±»ä¼¼åœ°ï¼Œå®ç°äº†æ¥å£æˆå‘˜çš„ç±»å‹ä¸èƒ½æ›´æ”¹æ¥å£æˆå‘˜å®šä¹‰çš„å‰æ¡ä»¶ã€‚å¦‚æœä¸€ä¸ªæˆå‘˜æ²¡æœ‰å®šä¹‰æ˜¾å¼çš„åå®šï¼Œé‚£ä¹ˆæˆå‘˜å°†è·å¾—ä¸€ä¸ªéšå¼åå®šï¼Œé€»è¾‘ä¸Šè¿™æ ·è¡¨ç¤ºï¼š</p><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>Contract<span class="token punctuation">.</span><span class="token function">Requires</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>ç”±äºåå®šä¸èƒ½åœ¨æ–°ç‰ˆæœ¬ä¸­å˜å¾—æ›´ä¸¥æ ¼ (å¦åˆ™ä¼šç ´åå…¼å®¹æ€§)ï¼Œæ‰€ä»¥åœ¨å¼•å…¥æ–°çš„è™š / æŠ½è±¡ / æ¥å£æˆå‘˜æ—¶ï¼Œåº”ä»”ç»†è€ƒè™‘å¥½å‰æ¡ä»¶ã€‚å¯¹äºåæ¡ä»¶å’Œå¯¹è±¡ä¸å˜æ€§ï¼Œåå®šå¯ä»¥éšæ„æ·»åŠ å’Œåˆ é™¤ï¼Œå› ä¸ºè™š / æŠ½è±¡ / æ¥å£æˆå‘˜ä¸­è¡¨ç¤ºçš„æ¡ä»¶å’Œé‡å†™æˆå‘˜ä¸­è¡¨ç¤ºçš„æ¡ä»¶ä¼š â€œé€»è¾‘ ANDâ€ åˆ°ä¸€èµ·ã€‚</p><blockquote><p>So now you see how to declare contracts. Letâ€™s now talk about how they function at run time. You get to declare all your precondition and postcondition contracts at the top of your methods where they are easy to find. Of course, the precondition contracts will validate their tests when the method is invoked. However, we donâ€™t want the postcondition contracts to validate their tests until the method returns. In order to get the desired behavior, the assembly produced by the C# compiler must be processed by the Code Contract Rewriter tool (CCRewrite.exe, found in C:\Program Files (x86)\Microsoft\Contracts\Bin), which produces a modified version of the assembly. After you select the Perform Runtime Contract Checking check box for your project, Visual Studio will invoke this tool for you automatically whenever you build the project. This tool analyzes the IL in all your methods and it rewrites the IL so that any postcondition contracts are executed at the end of each method. If your method has multiple return points inside it, then the CCRewrite.exe tool modifies the methodâ€™s IL code so that all return points execute the postcondition code prior to the method returning.</p></blockquote><blockquote><p>The CCRewrite.exe tool looks in the type for any method marked with the [ContractInvariantMethod] attribute. The method can have any name but, by convention, people usually name the method ObjectInvariant and mark the method as private (as Iâ€™ve just done). The method must accept no arguments and have a void return type. When the CCRewrite.exe tool sees a method marked with this attribute, it inserts IL code at the end of every public instance method to call the ObjectInvariant method. This way, the objectâ€™s state is checked as each method returns to ensure that no method has violated the contract. Note that the CCRewrite.exe tool does not modify a Finalize method or an IDisposableâ€™s Dispose method to call the ObjectInvariant method because it is OK for an objectâ€™s state to be altered if it is considered to be destroyed or disposed. Also note that a single type can define multiple methods with the [ContractInvariantMethod] attribute; this is useful when working with partial types. The CCRewrite.exe tool will modify the IL to call all of these methods (in an undefined order) at the end of each public method.</p></blockquote><blockquote><p>The Assert and Assume methods are unlike the other methods. First, you should not consider them to be part of the methodâ€™s signature, and you do not have to put them at the beginning of a method. At run time, these two methods perform identically: they just verify that the condition passed to them is true and throw an exception if it is not. However, there is another tool, the Code Contract Checker (CCCheck.exe), which analyzes the IL produced by the C# compiler in an attempt to statically verify that no code in the method violates a contract. This tool will attempt to prove that any condition passed to Assert is true, but it will just assume that any condition passed to Assume is true and the tool will add the expression to its body of facts known to be true. Usually, you will use Assert and then change an Assert to an Assume if the CCCheck.exe tool canâ€™t statically prove that the expression is true.</p></blockquote><blockquote><p>Letâ€™s walk through an example. Assume that I have the following type definition.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">SomeType</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> s_name <span class="token operator">=</span> <span class="token string">"Jeffrey"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ShowFirstLetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>s_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// warning: requires unproven: index &lt; this.Length</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When I build this code with the Perform Static Contract Checking function turned on, the CCCheck.exe tool produces the warning shown as a comment in the preceding code. This warning is notifying me that querying the first letter of s_name may fail and throw an exception because it is unproven that s_name always refers to a string consisting of at least one character.</p></blockquote><blockquote><p>Therefore, what weâ€™d like to do is add an assertion to the ShowFirstLetter method.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ShowFirstLetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> Contract<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>s_name<span class="token punctuation">.</span>Length <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// warning: assert unproven</span></pre></td></tr><tr><td data-num="3"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>s_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Unfortunately, when the CCCheck.exe tool analyzes this code, it is still unable to validate that s_name always refers to a string containing at least one letter, so the tool produces a similar warning. Sometimes the tool is unable to validate assertions due to limitations in the tool; future versions of the tool will be able to perform a more complete analysis.</p></blockquote><blockquote><p>To override shortcomings in the tool or to claim that something is true that the tool would never be able to prove, we can change Assert to Assume. If we know for a fact that no other code will modify s_name, then we can change ShowFirstLetter to this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ShowFirstLetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> Contract<span class="token punctuation">.</span><span class="token function">Assume</span><span class="token punctuation">(</span>s_name<span class="token punctuation">.</span>Length <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// No warning at all now!</span></pre></td></tr><tr><td data-num="3"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>s_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>With this version of the code, the CCCheck.exe tool just takes our word for it and concludes that s_name always refers to a string containing at least one letter. This version of the ShowFirstLetter method passes the code contract static checker without any warnings at all.</p></blockquote><blockquote><p>Now, letâ€™s talk about the Code Contract Reference Assembly Generator tool (CCRefGen.exe). Running the CCRewrite.exe tool to enable contract checking helps you find bugs more quickly, but all the code emitted during contract checking makes your assembly bigger and hurts its run-time performance. To improve this situation, you use the CCRefGen.exe tool to create a separate contract reference assembly. Visual Studio invokes this tool for you automatically if you set the Contract Reference Assembly combo box to Build. Contract assemblies are usually named AssemName.Contracts.dll (for example, MSCorLib.Contracts.dll), and these assemblies contain only metadata and the IL that describes the contractsâ€”nothing else. You can identify a contract reference assembly because it will have the System.Diagnostics.Contracts.ContractReferenceAssemblyAttribute applied to the assemblyâ€™s assembly definition metadata table. The CCRewrite.exe tool and the CCCheck.exe tool can use contract reference assemblies as input when these tools are performing their instrumentation and analysis.</p></blockquote><blockquote><p>The last tool, the Code Contract Document Generator tool (CCDocGen.exe), adds contract information to the XML documentation files already produced by the C# compiler when you use the compilerâ€™s /doc:file switch. This XML file, enhanced by the CCDocGen.exe tool, can be processed by Microsoftâ€™s Sandcastle tool to produce MSDN-style documentation that will now include contract information.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šä»£ç åå®š (code contract) æä¾›äº†ç›´çº¿åœ¨ä»£ç ä¸­å£°æ˜ä»£ç è®¾è®¡å†³ç­–çš„ä¸€ç§æ–¹å¼ã€‚ä»£ç åå®šæœ‰åˆ©äºä»£ç çš„ä½¿ç”¨ã€ç†è§£ã€è¿›åŒ–ã€æµ‹è¯•ã€æ–‡æ¡£å’Œæ—©æœŸé”™è¯¯æ£€æµ‹ã€‚å¯å°†å‰æ¡ä»¶ã€åæ¡ä»¶å’Œå¯¹è±¡ä¸å˜æ€§æƒ³è±¡ä¸ºæ–¹æ³•ç­¾åçš„ä¸€éƒ¨åˆ†ã€‚æ‰€ä»¥ï¼Œä»£ç æ–°ç‰ˆæœ¬çš„åå®šå¯ä»¥å˜å¾—æ›´å®½æ¾ã€‚ä½†ä¸èƒ½å˜å¾—æ›´ä¸¥æ ¼ï¼Œå¦åˆ™ä¼šç ´åå‘åå…¼å®¹æ€§ã€‚ä»£ç åå®šçš„æ ¸å¿ƒæ˜¯é™æ€ç±» <code>System.Diagnostics.Contracts.Contract</code> ã€‚å…¶ä¸­è®¸å¤šé™æ€æ–¹æ³•éƒ½åº”ç”¨äº† <code>[Conditional(&quot;CONTRACTS_FULL&quot;)]</code> ç‰¹æ€§ã€‚æœ‰çš„è¾…åŠ©æ–¹æ³•è¿˜åº”ç”¨äº† <code>[Conditional(&quot;DEBUG&quot;)]</code> ï¼Œæ„å‘³ç€é™¤éå®šä¹‰äº†æ°å½“çš„ç¬¦å·ï¼Œå¦åˆ™ç¼–è¯‘å™¨ä¼šå¿½ç•¥è°ƒç”¨è¿™äº›æ–¹æ³•çš„ä»»ä½•ä»£ç ã€‚æ ‡è®° â€œAlwaysâ€ çš„ä»»ä½•æ–¹æ³•æ„å‘³ç€ç¼–è¯‘å™¨æ€»æ˜¯ç”Ÿæˆè°ƒç”¨æ–¹æ³•çš„ä»£ç ã€‚å¦å¤–ï¼Œ <code>Requires</code> ï¼Œ <code>Requires&lt;TException&gt;</code> ï¼Œ <code>Ensures</code> ï¼Œ <code>EnsuresOnThrow</code> ï¼Œ <code>Invariant</code> ï¼Œ <code>Assert</code> å’Œ <code>Assume</code> æ–¹æ³•æœ‰ä¸€ä¸ªé¢å¤–çš„é‡è½½ç‰ˆæœ¬ (è¿™é‡Œæ²¡æœ‰åˆ—å‡º)ï¼Œå®ƒè·å–ä¸€ä¸ª <code>String</code> å®å‚ï¼Œç”¨äºæ˜¾å¼æŒ‡å®šè¿ååå®šæ—¶æ˜¾ç¤ºçš„å­—ç¬¦ä¸²æ¶ˆæ¯ã€‚åå®šé»˜è®¤åªä½œä¸ºæ–‡æ¡£ä½¿ç”¨ï¼Œå› ä¸ºç”Ÿæˆé¡¹ç›®æ—¶æ²¡æœ‰å®šä¹‰ <code>CONTRACTS_FULL</code> ç¬¦å·ã€‚ä¸ºäº†å‘æ˜åå®šçš„é™„åŠ ä»·å€¼ï¼Œå¿…é¡»ä¸‹è½½é¢å¤–çš„å·¥å…·å’Œä¸€ä¸ª Visual Studio å±æ€§çª—æ ¼ï¼Œç½‘å€æ˜¯ <span class="exturl" data-url="aHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9kZXZsYWJzL2RkNDkxOTkyLmFzcHglRTMlODAlODI=">http://msdn.microsoft.com/en-us/devlabs/dd491992.aspxã€‚</span></p><div class="tags"><a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag"><i class="ic i-tag"></i> è¯»ä¹¦ç¬”è®°</a> <a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C#</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2022-11-27 16:58:41" itemprop="dateModified" datetime="2022-11-27T16:58:41+08:00">2022-11-27</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(ï¿£â–½ï¿£)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Sakupinera WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/images/alipay.png" alt="Sakupinera Alipay"><p>Alipay</p></div><div><img data-src="/images/paypal.png" alt="Sakupinera PayPal"><p>PayPal</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Sakupinera <i class="ic i-at"><em>@</em></i>Sakupinera</li><li class="link"><strong>Post link: </strong><a href="http://sakupinera.github.io/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/" title="CLR via C# - Chapter 20 Exceptions and State Management">http://sakupinera.github.io/2022/11/25/csharp/clr-via-csharp/Chapter 20 Exceptions and State Management/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclh5u05ej20zk0m87df.jpg" title="CLR via C# - Chapter 19 Nullable Value Types"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 19 Nullable Value Types</h3></a></div><div class="item right"><a href="/2022/11/27/csharp/clr-via-csharp/Chapter%2021%20The%20Managed%20Heap%20and%20Garbage%20%20Collection/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipex2cdtbj20zk0m8x6p.jpg" title="CLR via C# - Chapter 21 The Managed Heap and Garbage  Collection"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 21 The Managed Heap and Garbage Collection</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#chapter-20-exceptions-and-state-management"><span class="toc-number">1.</span> <span class="toc-text">Chapter 20 Exceptions and State Management</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#defining-exception"><span class="toc-number">1.1.</span> <span class="toc-text">Defining â€œExceptionâ€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exception-handling-mechanics"><span class="toc-number">1.2.</span> <span class="toc-text">Exception-Handling Mechanics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#the-try-block"><span class="toc-number">1.2.1.</span> <span class="toc-text">The try Block</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-catch-block"><span class="toc-number">1.2.2.</span> <span class="toc-text">The catch Block</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-finally-block"><span class="toc-number">1.2.3.</span> <span class="toc-text">The finally Block</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-systemexception-class"><span class="toc-number">1.3.</span> <span class="toc-text">The System.Exception Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fcl-defined-exception-classes"><span class="toc-number">1.4.</span> <span class="toc-text">FCL-Defined Exception Classes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#throwing-an-exception"><span class="toc-number">1.5.</span> <span class="toc-text">Throwing an Exception</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#defining-your-own-exception-class"><span class="toc-number">1.6.</span> <span class="toc-text">Defining Your Own Exception Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#trading-reliability-for-productivity"><span class="toc-number">1.7.</span> <span class="toc-text">Trading Reliability for Productivity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#guidelines-and-best-practices"><span class="toc-number">1.8.</span> <span class="toc-text">Guidelines and Best Practices</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#use-finally-blocks-liberally"><span class="toc-number">1.8.1.</span> <span class="toc-text">Use finally Blocks Liberally</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dont-catch-everything"><span class="toc-number">1.8.2.</span> <span class="toc-text">Donâ€™t Catch Everything</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#recovering-gracefully-from-an-exception"><span class="toc-number">1.8.3.</span> <span class="toc-text">Recovering Gracefully from an Exception</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#backing-out-of-a-partially-completed-operation-when-an-unrecoverable-exception-occursmaintaining-state"><span class="toc-number">1.8.4.</span> <span class="toc-text">Backing Out of a Partially Completed Operation When an Unrecoverable Exception Occursâ€”Maintaining State</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hiding-an-implementation-detail-to-maintain-a-contract"><span class="toc-number">1.8.5.</span> <span class="toc-text">Hiding an Implementation Detail to Maintain a â€œContractâ€</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unhandled-exceptions"><span class="toc-number">1.9.</span> <span class="toc-text">Unhandled Exceptions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#debugging-exceptions"><span class="toc-number">1.10.</span> <span class="toc-text">Debugging Exceptions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exception-handling-performance-considerations"><span class="toc-number">1.11.</span> <span class="toc-text">Exception-Handling Performance Considerations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#constrained-execution-regions-cers"><span class="toc-number">1.12.</span> <span class="toc-text">Constrained Execution Regions (CERs)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#code-contracts"><span class="toc-number">1.13.</span> <span class="toc-text">Code Contracts</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%201%20The%20CLR%E2%80%99s%20Execution%20Model/" rel="bookmark" title="CLR via C# - Chapter 1 The CLRâ€™s Execution Model">CLR via C# - Chapter 1 The CLRâ€™s Execution Model</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%202%20Building,%20Packaging,%20Deploying,%20and%20Administering%20Applications%20and%20Types/" rel="bookmark" title="CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types">CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%203%20Shared%20Assemblies%20and%20Strongly%20Named%20Assemblies/" rel="bookmark" title="CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies">CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies</a></li><li><a href="/2022/09/27/csharp/clr-via-csharp/Chapter%204%20Type%20Fundamentals/" rel="bookmark" title="CLR via C# - Chapter 4 Type Fundamentals">CLR via C# - Chapter 4 Type Fundamentals</a></li><li><a href="/2022/10/15/csharp/clr-via-csharp/Chapter%205%20Primitive,%20Reference,%20and%20Value%20%20Types/" rel="bookmark" title="CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals">CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals</a></li><li><a href="/2022/10/21/csharp/clr-via-csharp/Chapter%206%20Type%20and%20Member%20Basics/" rel="bookmark" title="CLR via C# - Chapter 6 Type and Member Basics">CLR via C# - Chapter 6 Type and Member Basics</a></li><li><a href="/2022/10/24/csharp/clr-via-csharp/Chapter%207%20Constants%20and%20Fields/" rel="bookmark" title="CLR via C# - Chapter 7 Constants and Fields">CLR via C# - Chapter 7 Constants and Fields</a></li><li><a href="/2022/10/25/csharp/clr-via-csharp/Chapter%208%20Methods/" rel="bookmark" title="CLR via C# - Chapter 8 Methods">CLR via C# - Chapter 8 Methods</a></li><li><a href="/2022/10/27/csharp/clr-via-csharp/Chapter%209%20Parameters/" rel="bookmark" title="CLR via C# - Chapter 9 Parameters">CLR via C# - Chapter 9 Parameters</a></li><li><a href="/2022/10/28/csharp/clr-via-csharp/Chapter%2010%20Properties/" rel="bookmark" title="CLR via C# - Chapter 10 Properties">CLR via C# - Chapter 10 Properties</a></li><li><a href="/2022/10/29/csharp/clr-via-csharp/Chapter%2011%20Events/" rel="bookmark" title="CLR via C# - Chapter 11 Events">CLR via C# - Chapter 11 Events</a></li><li><a href="/2022/11/02/csharp/clr-via-csharp/Chapter%2012%20Generics/" rel="bookmark" title="CLR via C# - Chapter 12 Generics">CLR via C# - Chapter 12 Generics</a></li><li><a href="/2022/11/04/csharp/clr-via-csharp/Chapter%2013%20Interfaces/" rel="bookmark" title="CLR via C# - Chapter 13 Interfaces">CLR via C# - Chapter 13 Interfaces</a></li><li><a href="/2022/11/16/csharp/clr-via-csharp/Chapter%2014%20Chars,%20Strings,%20and%20Working%20%20with%20Text/" rel="bookmark" title="CLR via C# - Chapter 14 Chars, Strings, and Working with Text">CLR via C# - Chapter 14 Chars, Strings, and Working with Text</a></li><li><a href="/2022/11/17/csharp/clr-via-csharp/Chapter%2015%20Enumerated%20Types%20and%20Bit%20Flags/" rel="bookmark" title="CLR via C# - Chapter 15 Enumerated Types and Bit Flags">CLR via C# - Chapter 15 Enumerated Types and Bit Flags</a></li><li><a href="/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/" rel="bookmark" title="CLR via C# - Chapter 16 Arrays">CLR via C# - Chapter 16 Arrays</a></li><li><a href="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/" rel="bookmark" title="CLR via C# - Chapter 17 Delegates">CLR via C# - Chapter 17 Delegates</a></li><li><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" rel="bookmark" title="CLR via C# - Chapter 18 Custom Attributes">CLR via C# - Chapter 18 Custom Attributes</a></li><li><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" rel="bookmark" title="CLR via C# - Chapter 19 Nullable Value Types">CLR via C# - Chapter 19 Nullable Value Types</a></li><li class="active"><a href="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/" rel="bookmark" title="CLR via C# - Chapter 20 Exceptions and State Management">CLR via C# - Chapter 20 Exceptions and State Management</a></li><li><a href="/2022/11/27/csharp/clr-via-csharp/Chapter%2021%20The%20Managed%20Heap%20and%20Garbage%20%20Collection/" rel="bookmark" title="CLR via C# - Chapter 21 The Managed Heap and Garbage  Collection">CLR via C# - Chapter 21 The Managed Heap and Garbage Collection</a></li><li><a href="/2022/11/28/csharp/clr-via-csharp/Chapter%2022%20CLR%20Hosting%20and%20AppDomains/" rel="bookmark" title="CLR via C# - Chapter 22 CLR Hosting and AppDomains">CLR via C# - Chapter 22 CLR Hosting and AppDomains</a></li><li><a href="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/" rel="bookmark" title="CLR via C# - Chapter 23 Assembly Loading and Reflection">CLR via C# - Chapter 23 Assembly Loading and Reflection</a></li><li><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" rel="bookmark" title="CLR via C# - Chapter 24 Runtime Serialization">CLR via C# - Chapter 24 Runtime Serialization</a></li><li><a href="/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/" rel="bookmark" title="CLR via C# - Chapter 25 Interoperating with WinRT Components">CLR via C# - Chapter 25 Interoperating with WinRT Components</a></li><li><a href="/2023/02/06/csharp/clr-via-csharp/Chapter%2026%20Thread%20Basics/" rel="bookmark" title="CLR via C# - Chapter 26 Thread Basics">CLR via C# - Chapter 26 Thread Basics</a></li><li><a href="/2023/02/07/csharp/clr-via-csharp/Chapter%2027%20Compute-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations">CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations</a></li><li><a href="/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 28 IO-Bound Asynchronous Operations">CLR via C# - Chapter 28 IO-Bound Asynchronous Operations</a></li><li><a href="/2023/02/09/csharp/clr-via-csharp/Chapter%2029%20Primitive%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 29 Primitive Thread Synchronization">CLR via C# - Chapter 29 Primitive Thread Synchronization</a></li><li><a href="/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 30 Hybrid Thread Synchronization">CLR via C# - Chapter 30 Hybrid Thread Synchronization</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Sakupinera" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Sakupinera</p><div class="description" itemprop="description">ä¿æŒä½ çš„å†³å¿ƒï¼</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">89</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">17</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">8</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Nha3VwaW5lcmE=" title="https:&#x2F;&#x2F;github.com&#x2F;sakupinera"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9zYWt1cGluZXJh" title="https:&#x2F;&#x2F;twitter.com&#x2F;sakupinera"><i class="ic i-twitter"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTQwNzIyOTA3MQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;407229071"><i class="ic i-cloud-music"></i></span> <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMjIzMDczOTg/c3BtX2lkX2Zyb209MzMzLjEwMDcuMC4w" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;22307398?spm_id_from&#x3D;333.1007.0.0"><i class="ic i-bilibili"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/games/" rel="section"><i class="ic i-flag"></i>games</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-person"></i>About</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/11/27/csharp/clr-via-csharp/Chapter%2021%20The%20Managed%20Heap%20and%20Garbage%20%20Collection/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CSharp-in-a-Nutshell/" title="In CSharp-in-a-Nutshell">CSharp-in-a-Nutshell</a></div><span><a href="/2022/09/01/csharp/csharp-in-a-nutshell/%E7%AC%AC12%E7%AB%A0%20%E5%AF%B9%E8%B1%A1%E9%94%80%E6%AF%81%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" title="C# in a Nutshell - ç¬¬12ç«  å¯¹è±¡é”€æ¯ä¸åƒåœ¾å›æ”¶">C# in a Nutshell - ç¬¬12ç«  å¯¹è±¡é”€æ¯ä¸åƒåœ¾å›æ”¶</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/UnityShader/" title="In UnityShader">UnityShader</a></div><span><a href="/2022/09/19/computer-graphics/unityshader/%E6%B8%B2%E6%9F%93%E6%B5%81%E6%B0%B4%E7%BA%BF/" title="UnityShader - æ¸²æŸ“æµæ°´çº¿">UnityShader - æ¸²æŸ“æµæ°´çº¿</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/08/28/linux/learn-linux/Linux%E7%B3%BB%E7%BB%9F%E7%AE%80%E4%BB%8B/" title="LearnLinux - Linuxç³»ç»Ÿç®€ä»‹">LearnLinux - Linuxç³»ç»Ÿç®€ä»‹</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/10/25/csharp/clr-via-csharp/Chapter%208%20Methods/" title="CLR via C# - Chapter 8 Methods">CLR via C# - Chapter 8 Methods</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/10/28/csharp/clr-via-csharp/Chapter%2010%20Properties/" title="CLR via C# - Chapter 10 Properties">CLR via C# - Chapter 10 Properties</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/" title="CLR via C# - Chapter 23 Assembly Loading and Reflection">CLR via C# - Chapter 23 Assembly Loading and Reflection</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2022/12/17/cpp/cpp-primer/Chapter%209%20Sequential%20Containers/" title="C++ Primer - Chapter 9 Sequential Containers">C++ Primer - Chapter 9 Sequential Containers</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/27/csharp/clr-via-csharp/Chapter%2021%20The%20Managed%20Heap%20and%20Garbage%20%20Collection/" title="CLR via C# - Chapter 21 The Managed Heap and Garbage  Collection">CLR via C# - Chapter 21 The Managed Heap and Garbage Collection</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/10/24/csharp/clr-via-csharp/Chapter%207%20Constants%20and%20Fields/" title="CLR via C# - Chapter 7 Constants and Fields">CLR via C# - Chapter 7 Constants and Fields</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" title="CLR via C# - Chapter 24 Runtime Serialization">CLR via C# - Chapter 24 Runtime Serialization</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 â€“ <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Sakupinera @ Hanamai Sora</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">2.2m words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">34:05</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/11/25/csharp/clr-via-csharp/Chapter 20 Exceptions and State Management/",favicon:{show:"ï¼ˆâ—Â´3ï½€â—ï¼‰Goooood",hide:"(Â´Ğ”ï½€)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/assets/shifuku.model.json"},display:{position:"left",width:250,height:500},mobile:{show:!1},react:{opacity:.9},log:!1})</script></body></html>