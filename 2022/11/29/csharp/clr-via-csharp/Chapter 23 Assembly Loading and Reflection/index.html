<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Sakupinera" href="http://sakupinera.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Sakupinera" href="http://sakupinera.github.io/atom.xml"><link rel="alternate" type="application/json" title="Sakupinera" href="http://sakupinera.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="è¯»ä¹¦ç¬”è®°,C#"><link rel="canonical" href="http://sakupinera.github.io/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/"><title>CLR via C# - Chapter 23 Assembly Loading and Reflection - CLR-via-CSharp - CSharp | Hanamai Sora = Sakupinera</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">CLR via C# - Chapter 23 Assembly Loading and Reflection</h1><div class="meta"><span class="item" title="Created: 2022-11-29 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2022-11-29T00:00:00+08:00">2022-11-29</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>62k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>56 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Hanamai Sora</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://s2.loli.net/2023/03/08/r1VBTR45h8jQWZA.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/W1a6ViLoBQPTj2C.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/Z2usRnE64TXN1Lp.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/R9PEJQ54o7HMAis.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/dhkXYZz7ENHoCeL.png"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/hr2Sybs5CRvjFdI.png"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/" itemprop="item" rel="index" title="In CSharp"><span itemprop="name">CSharp</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/CLR-via-CSharp/" itemprop="item" rel="index" title="In CLR-via-CSharp"><span itemprop="name">CLR-via-CSharp</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="http://sakupinera.github.io/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Sakupinera"><meta itemprop="description" content=", ä¿æŒä½ çš„å†³å¿ƒï¼"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sakupinera"></span><div class="body md" itemprop="articleBody"><h1 id="chapter-23-assembly-loading-and-reflection"><a class="anchor" href="#chapter-23-assembly-loading-and-reflection">#</a> Chapter 23 Assembly Loading and Reflection</h1><h2 id="assembly-loading"><a class="anchor" href="#assembly-loading">#</a> Assembly Loading</h2><blockquote><p>As you know, when the just-in-time (JIT) compiler compiles the Intermediate Language (IL) for a method, it sees what types are referenced in the IL code. Then at run time, the JIT compiler uses the assemblyâ€™s TypeRef and AssemblyRef metadata tables to determine what assembly defines the type being referenced. The AssemblyRef metadata table entry contains all of the parts that make up the strong name of the assembly. The JIT compiler grabs all of these partsâ€”name (without extension or path), version, culture, and public key tokenâ€”concatenates them into a string, and then attempts to load an assembly matching this identity into the AppDomain (assuming that itâ€™s not already loaded). If the assembly being loaded is weakly named, the identity is just the name of the assembly (no version, culture, or public key token information).</p></blockquote><blockquote><p>Internally, the CLR attempts to load this assembly by using the System.Reflection.Assembly classâ€™s static Load method. This method is publicly documented, and you can call it to explicitly load an assembly into your AppDomain. This method is the CLR equivalent of Win32â€™s LoadLibrary function. There are actually several overloaded versions of Assemblyâ€™s Load method. Here are the prototypes of the more commonly used overloads.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Assembly</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Assembly</span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token class-name">AssemblyName</span> assemblyRef<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Assembly</span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token class-name">String</span> assemblyString<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Less commonly used overloads of Load are not shown </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Internally, Load causes the CLR to apply a version-binding redirection policy to the assembly and looks for the assembly in the global assembly cache (GAC), followed by the applicationâ€™s base directory, private path subdirectories, and codebase locations. If you call Load by passing a weakly named assembly, Load doesnâ€™t apply a version-binding redirection policy to the assembly, and the CLR wonâ€™t look in the GAC for the assembly. If Load finds the specified assembly, it returns a reference to an Assembly object that represents the loaded assembly. If Load fails to find the specified assembly, it throws a System.IO.FileNotFoundException.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šä¸€äº›æç½•è§çš„æƒ…å†µå¯èƒ½éœ€è¦åŠ è½½ä¸ºç‰¹å®š CPU æ¶æ„ç”Ÿæˆçš„ç¨‹åºé›†ã€‚è¿™æ—¶åœ¨æŒ‡å®šç¨‹åºé›†çš„æ ‡è¯†æ—¶ï¼Œè¿˜å¯åŒ…æ‹¬ä¸€ä¸ªè¿›ç¨‹æ¶æ„éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œå‡å®š GAC ä¸­åŒæ—¶åŒ…å«äº†ä¸€ä¸ªç¨‹åºé›†çš„ IL ä¸­ç«‹ç‰ˆæœ¬å’Œ x86 ä¸“ç”¨ç‰ˆæœ¬ï¼ŒCLR ä¼šé»˜è®¤é€‰æ‹© x86 ä¸“ç”¨ç‰ˆæœ¬ (å‚è§ ç¬¬ 3 ç«  â€œå…±äº«ç¨‹åºé›†å’Œå¼ºå‘½åç¨‹åºé›†â€)ã€‚ä½†æ˜¯ï¼Œä¸ºäº†å¼ºè¿« CLR åŠ è½½ IL ä¸­ç«‹çš„ç‰ˆæœ¬ï¼Œå¯ä»¥å‘ <code>Assembly</code> çš„ <code>Load</code> æ–¹æ³•ä¼ é€’ä»¥ä¸‹å­—ç¬¦ä¸²ï¼š</p><p><code>&quot;SomeAssembly, Version=2.0.0.0, Culture=neutral, PublicKeyToken=01234567890abcde, ProcessorArchitecture=MSIL&quot;</code></p><p>CLR ç›®å‰å…è®¸ <code>ProcessorArchitecture</code> å– 5 ä¸ªå€¼ä¹‹ä¸€ï¼š <code>MSIL</code> (Microsoft IL)ã€ <code>X86</code> ã€ <code>IA64</code> ï¼Œ <code>AMD64</code> ä»¥åŠ <code>Arm</code> ã€‚</p><p>ğŸ’¡é‡è¦æç¤ºï¼šä¸€äº›å¼€å‘äººå‘˜å¯èƒ½æ³¨æ„åˆ° <code>System.AppDomain</code> æä¾›äº† <code>Load</code> æ–¹æ³•ã€‚å’Œ <code>Assembly</code> çš„é™æ€ <code>Load</code> æ–¹æ³•ä¸åŒï¼Œ <code>AppDomain</code> çš„ <code>Load</code> æ˜¯å®ä¾‹æ–¹æ³•ï¼Œå®ƒå…è®¸å°†ç¨‹åºé›†åŠ è½½åˆ°æŒ‡å®šçš„ AppDomain ä¸­ã€‚è¯¥æ–¹æ³•è®¾è®¡ç”±éæ‰˜ç®¡è°ƒç”¨ï¼Œå…è®¸å®¿ä¸»å°†ç¨‹åºé›† â€œæ³¨å…¥â€ ç‰¹å®š AppDomain ä¸­ã€‚æ‰˜ç®¡ä»£ç çš„å¼€å‘äººå‘˜ä¸€èˆ¬æƒ…å†µä¸‹ä¸åº”è°ƒç”¨å®ƒï¼Œå› ä¸ºè°ƒç”¨ <code>AppDomain</code> çš„ <code>Load</code> æ–¹æ³•æ—¶éœ€è¦ä¼ é€’ä¸€ä¸ªæ ‡è¯†äº†ç¨‹åºé›†çš„å­—ç¬¦ä¸²ã€‚è¯¥æ–¹æ³•éšåä¼šåº”ç”¨ç­–ç•¥ï¼Œå¹¶åœ¨ä¸€äº›å¸¸è§„ä½ç½®æœç´¢ç¨‹åºé›†ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒAppDomain å…³è”äº†ä¸€äº›å‘Šè¯‰ CLR å¦‚ä½•æŸ¥æ‰¾ç¨‹åºé›†çš„è®¾ç½®ã€‚ä¸ºäº†åŠ è½½è¿™ä¸ªç¨‹åºé›†ï¼ŒCLR å°†ä½¿ç”¨ä¸æŒ‡å®š AppDomain å…³è”çš„è®¾ç½®ï¼Œè€Œéä¸å‘å‡ºè°ƒç”¨ä¹‹ AppDomain å…³è”çš„è®¾ç½®ã€‚</p><p>ä½† <code>AppDomain</code> çš„ <code>Load</code> æ–¹æ³•ä¼šè¿”å›å¯¹ç¨‹åºé›†çš„å¼•ç”¨ã€‚ç”±äº <code>System.Assembly</code> ç±»ä¸æ˜¯ä» <code>System.MarshalByRefObject</code> æ´¾ç”Ÿçš„ï¼Œæ‰€ä»¥ç¨‹åºé›†å¯¹è±¡å¿…é¡»æŒ‰å€¼å°é€å›å‘å‡ºè°ƒç”¨çš„é‚£ä¸ª AppDomainã€‚ä½†æ˜¯ï¼Œç°åœ¨ CLR å°±ä¼šç”¨å‘å‡ºè°ƒç”¨çš„é‚£ä¸ª AppDomain çš„è®¾ç½®æ¥å®šä½å¹¶åŠ è½½ç¨‹åºé›†ã€‚å¦‚æœä½¿ç”¨å‘å‡ºè°ƒç”¨çš„é‚£ä¸ª AppDomain çš„ç­–ç•¥å’Œæœç´¢ä½ç½®æ‰¾ä¸åˆ°æŒ‡å®šçš„ç¨‹åºé›†ï¼Œå°±ä¼šæŠ›å‡ºä¸€ä¸ª <code>FileNotFoundException</code> ã€‚ è¿™ä¸ªè¡Œä¸ºä¸€èˆ¬ä¸æ˜¯ä½ æ‰€æœŸæœ›çš„ï¼Œæ‰€ä»¥åº”è¯¥é¿å…ä½¿ç”¨ <code>AppDomain</code> çš„ <code>Load</code> æ–¹æ³•ã€‚</p><blockquote><p>In most dynamically extensible applications, Assemblyâ€™s Load method is the preferred way of loading an assembly into an AppDomain. However, it does require that you have all of the pieces that make up an assemblyâ€™s identity. Frequently, developers write tools or utilities (such as ILDasm.exe, PEVerify.exe, CorFlags.exe, GACUtil.exe, SGen.exe, SN.exe, XSD.exe) that perform some kind of processing on an assembly. All of these tools take a command-line argument that refers to the path name of an assembly file (including file extension).</p></blockquote><blockquote><p>To load an assembly specifying a path name, you call Assemblyâ€™s LoadFrom method.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Assembly</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Assembly</span> <span class="token function">LoadFrom</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Less commonly used overloads of LoadFrom are not shown </span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Internally, LoadFrom first calls System.Reflection.AssemblyNameâ€™s static GetAssemblyName method, which opens the specified file, finds the AssemblyDef metadata tableâ€™s entry, and extracts the assembly identity information and returns it in a System.Reflection.AssemblyName object (the file is also closed). Then, LoadFrom internally calls Assemblyâ€™s Load method, passing it the AssemblyName object. At this point, the CLR applies a version-binding redirection policy and searches the various locations looking for a matching assembly. If Load finds the assembly, it will load it, and an Assembly object that represents the loaded assembly will be returned; LoadFrom returns this value. If Load fails to find an assembly, LoadFrom loads the assembly at the path name specified in LoadFromâ€™s argument. Of course, if an assembly with the same identity is already loaded, LoadFrom simply returns an Assembly object that represents the already loaded assembly.</p></blockquote><blockquote><p>By the way, the LoadFrom method allows you to pass a URL as the argument. Here is an example.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Assembly</span> a <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">LoadFrom</span><span class="token punctuation">(</span><span class="token string">@"http://Wintellect.com/SomeAssembly.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>When you pass an Internet location, the CLR downloads the file, installs it into the userâ€™s download cache, and loads the file from there. Note that you must be online or an exception will be thrown. However, if the file has been downloaded previously, and if Windows Internet Explorer has been set to work offline (see Internet Explorerâ€™s Work Offline menu item in its File menu), the previously downloaded file will be used, and no exception will be thrown. You can also call UnsafeLoadFrom, which can load a web-downloaded assembly, bypassing some security checks.</p></blockquote><p>ğŸ’¡é‡è¦æç¤ºï¼šä¸€å°æœºå™¨å¯èƒ½åŒæ—¶å­˜åœ¨å…·æœ‰ç›¸åŒæ ‡è¯†çš„å¤šä¸ªç¨‹åºé›†ã€‚ç”±äº <code>LoadFrom</code> ä¼šåœ¨å†…éƒ¨è°ƒç”¨ <code>Load</code> ï¼Œæ‰€ä»¥ CLR æœ‰å¯èƒ½ä¸æ˜¯åŠ è½½ä½ æŒ‡å®šçš„æ–‡ä»¶ï¼Œè€Œæ˜¯åŠ è½½ä¸€ä¸ªä¸åŒçš„æ–‡ä»¶ï¼Œä»è€Œé€ æˆéé¢„æœŸçš„è¡Œä¸ºã€‚å¼ºçƒˆå»ºè®®æ¯æ¬¡ç”Ÿæˆç¨‹åºé›†æ—¶éƒ½æ›´æ”¹ç‰ˆæœ¬å·ï¼Œç¡®ä¿æ¯ä¸ªç‰ˆæœ¬éƒ½æœ‰è‡ªå·±çš„å”¯ä¸€æ€§æ ‡è¯†ï¼Œç¡®ä¿ <code>LoadFrom</code> æ–¹æ³•çš„è¡Œä¸ºç¬¦åˆé¢„æœŸã€‚</p><blockquote><p>Microsoft Visual Studioâ€™s UI designers and other tools typically use Assemblyâ€™s LoadFile method. This method can load an assembly from any path and can be used to load an assembly with the same identity multiple times into a single AppDomain. This can happen as changes to an applicationâ€™s UI are made in the designer/tool and the user rebuilds the assembly. When loading an assembly via LoadFile, the CLR will not resolve any dependencies automatically; your code must register with AppDomainâ€™s AssemblyResolve event and have your event callback method explicitly load any dependent assemblies.</p></blockquote><blockquote><p>If you are building a tool that simply analyzes an assemblyâ€™s metadata via reflection (as discussed later in this chapter), and you want to ensure that none of the code contained inside the assembly executes, the best way for you to load an assembly is to use Assemblyâ€™s ReflectionOnlyLoadFrom method, or in some rarer cases, Assemblyâ€™s ReflectionOnlyLoad method. Here are the prototypes of both methods.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Assembly</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Assembly</span> <span class="token function">ReflectionOnlyLoadFrom</span><span class="token punctuation">(</span><span class="token class-name">String</span> assemblyFile<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Assembly</span> <span class="token function">ReflectionOnlyLoad</span><span class="token punctuation">(</span><span class="token class-name">String</span> assemblyString<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Less commonly used overload of ReflectionOnlyLoad is not shown </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The ReflectionOnlyLoadFrom method will load the file specified by the path; the strongname identity of the file is not obtained, and the file is not searched for in the GAC or elsewhere. The ReflectionOnlyLoad method will search for the specified assembly looking in the GAC, application base directory, private paths, and codebases. However, unlike the Load method, the ReflectionOnlyLoad method does not apply versioning policies, so you will get the exact version that you specify. If you want to apply versioning policy yourself to an assembly identity, you can pass the string into AppDomainâ€™s ApplyPolicy method.</p></blockquote><blockquote><p>When an assembly is loaded with ReflectionOnlyLoadFrom or ReflectionOnlyLoad, the CLR forbids any code in the assembly from executing; any attempt to execute code in an assembly loaded with either of these methods causes the CLR to throw an InvalidOperationException. These methods allow a tool to load an assembly that was delay-signed, would normally require security permissions that prevent it from loading, or was created for a different CPU architecture.</p></blockquote><blockquote><p>Frequently, when using reflection to analyze an assembly loaded with one of these two methods, the code will have to register a callback method with AppDomainâ€™s ReflectionOnlyAssemblyResolve event to manually load any referenced assemblies (calling AppDomainâ€™s ApplyPolicy method, if desired); the CLR doesnâ€™t do it automatically for you. When the callback method is invoked, it must call Assemblyâ€™s ReflectionOnlyLoadFrom or ReflectionOnlyLoad method to explicitly load a referenced assembly and return a reference to this assembly.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šç»å¸¸æœ‰äººé—®åˆ°ç¨‹åºé›†å¸è½½çš„é—®é¢˜ã€‚é—æ†¾çš„æ˜¯ï¼ŒCLR ä¸æä¾›å¸è½½å•ç‹¬ç¨‹åºé›†çš„èƒ½åŠ›ã€‚å¦‚æœ CLR å…è®¸è¿™æ ·åšï¼Œé‚£ä¹ˆä¸€æ—¦çº¿ç¨‹ä»æŸä¸ªæ–¹æ³•è¿”å›è‡³å·²å¸è½½çš„ä¸€ä¸ªç¨‹åºé›†ä¸­çš„ä»£ç ï¼Œå¦‚æœå…è®¸åº”ç”¨ç¨‹åºä»¥è¿™æ ·çš„ä¸€ç§æ–¹å¼å´©æºƒï¼Œå°±å’Œå®ƒçš„è®¾è®¡åˆè¡·èƒŒé“è€Œé©°äº†ã€‚å¸è½½ç¨‹åºé›†å¿…é¡»å¸è½½åŒ…å«å®ƒçš„æ•´ä¸ª AppDomainã€‚è¿™æ–¹é¢çš„è¯¦æƒ…å·²åœ¨ç¬¬ 22 ç«  â€œCLR å¯„å®¿å’Œ AppDomainâ€ è¿›è¡Œäº†è®¨è®ºã€‚</p><p>ä½¿ç”¨ <code>ReflectionOnlyLoadFrom</code> æˆ– <code>ReflectionOnlyLoad</code> æ–¹æ³•åŠ è½½çš„ç¨‹åºé›†è¡¨é¢ä¸Šæ˜¯å¯ä»¥å¸è½½çš„ã€‚æ¯•ç«Ÿï¼Œè¿™äº›ç¨‹åºé›†ä¸­çš„ä»£ç æ˜¯ä¸å…è®¸æ‰§è¡Œçš„ã€‚ä½† CLR ä¸€æ ·ä¸å…è®¸æ‰§è¡Œçš„ã€‚ä½† CLR ä¸€æ ·ä¸å…è®¸å¸è½½ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•åŠ è½½çš„ç¨‹åºé›†ã€‚å› ä¸ºç”¨è¿™ä¸¤ä¸ªæ–¹æ³•åŠ è½½äº†ç¨‹åºé›†ä¹‹åï¼Œä»ç„¶å¯ä»¥åˆ©ç”¨åå°„æ¥åˆ›å»ºå¯¹è±¡ï¼Œä»¥ä¾¿å¼•ç”¨è¿™äº›ç¨‹åºé›†ä¸­å®šä¹‰çš„å…ƒæ•°æ®ã€‚å¦‚æœå¸è½½ç¨‹åºé›†ï¼Œå°±å¿…é¡»é€šè¿‡æŸç§æ–¹å¼ä½¿è¿™äº›å¯¹è±¡ï¼Œä»¥ä¾¿å¼•ç”¨è¿™äº›ç¨‹åºé›†ä¸­å®šä¹‰çš„å…ƒæ•°æ®ã€‚ä»ç„¶å¯ä»¥åˆ©ç”¨åå°„æ¥åˆ›å»ºå¯¹è±¡ï¼Œä»¥ä¾¿å¼•ç”¨è¿™äº›ç¨‹åºé›†ä¸­å®šä¹‰çš„å…ƒæ•°æ®ã€‚å¦‚æœå¸è½½ç¨‹åºé›†ï¼Œå°±å¿…é¡»é€šè¿‡æŸç§æ–¹å¼ä½¿è¿™äº›å¯¹è±¡å¤±æ•ˆã€‚æ— è®ºæ˜¯å®ç°çš„å¤æ‚æ€§ï¼Œè¿˜æ˜¯æ‰§è¡Œé€Ÿåº¦ï¼Œè·Ÿè¸ªè¿™äº›å¯¹è±¡çš„çŠ¶æ€éƒ½æ˜¯å¾—ä¸å¿å¤±çš„ã€‚</p><blockquote><p>Many applications consist of an EXE file that depends on many DLL files. When deploying this application, all the files must be deployed. However, there is a technique that you can use to deploy just a single EXE file. First, identify all the DLL files that your EXE file depends on that do not ship as part of the Microsoft .NET Framework itself. Then add these DLLs to your Visual Studio project. For each DLL file you add, display its properties and change its Build Action to Embedded Resource. This causes the C# compiler to embed the DLL file(s) into your EXE file, and you can deploy this one EXE file.</p></blockquote><blockquote><p>At run time, the CLR wonâ€™t be able to find the dependent DLL assemblies, which is a problem. To fix this, when your application initializes, register a callback method with the AppDomainâ€™s ResolveAssembly event. The callback methodâ€™s code should look something like the following.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Assembly</span> <span class="token function">ResolveEventHandler</span><span class="token punctuation">(</span><span class="token class-name">Object</span> sender<span class="token punctuation">,</span> <span class="token class-name">ResolveEventArgs</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name">String</span> dllName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AssemblyName</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">.</span>Name <span class="token operator">+</span> <span class="token string">".dll"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> assem <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">GetExecutingAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name">String</span> resourceName <span class="token operator">=</span> assem<span class="token punctuation">.</span><span class="token function">GetManifestResourceNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>rn <span class="token operator">=></span> </pre></td></tr><tr><td data-num="5"></td><td><pre>rn<span class="token punctuation">.</span><span class="token function">EndsWith</span><span class="token punctuation">(</span>dllName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Not found, maybe another handler will find it</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> stream <span class="token operator">=</span> assem<span class="token punctuation">.</span><span class="token function">GetManifestResourceStream</span><span class="token punctuation">(</span>resourceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> assemblyData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Byte</span><span class="token punctuation">[</span>stream<span class="token punctuation">.</span>Length<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> stream<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>assemblyData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> assemblyData<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">return</span> Assembly<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>assemblyData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Now, the first time a thread calls a method that references a type in a dependent DLL file, the AssemblyResolve event will be raised and the preceding callback code will find the embedded DLL resource desired and load it by calling an overload of Assemblyâ€™s Load method that takes a Byte[] as an argument. Although I love the technique of embedding dependent DLLs inside another assembly, you should be aware that this does increase the memory used by your application at run time.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šJIT ç¼–è¯‘å™¨å°†æ–¹æ³•çš„ IL ä»£ç ç¼–è¯‘æˆæœ¬æœºä»£ç æ—¶ï¼Œä¼šæŸ¥çœ‹ IL ä»£ç ä¸­å¼•ç”¨äº†å“ªäº›ç±»å‹ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒJIT ç¼–è¯‘å™¨åˆ©ç”¨ç¨‹åºé›†çš„ TypeRef å’Œ AssemblyRef å…ƒæ•°æ®è¡¨æ¥ç¡®å®šå“ªä¸€ä¸ªç¨‹åºé›†å®šä¹‰äº†æ‰€å¼•ç”¨çš„ç±»å‹ã€‚åœ¨ AssemblyRef å…ƒæ•°æ®è¡¨çš„è®°å½•é¡¹ä¸­ï¼ŒåŒ…å«äº†æ„æˆç¨‹åºé›†å¼ºåç§°çš„å„ä¸ªéƒ¨åˆ†ã€‚JIT ç¼–è¯‘å™¨å°è¯•å°†ä¸è¯¥æ ‡è¯†åŒ¹é…çš„ç¨‹åºé›†åŠ è½½åˆ° AppDomain ä¸­ (å¦‚æœè¿˜æ²¡æœ‰åŠ è½½çš„è¯)ã€‚å¦‚æœè¢«åŠ è½½çš„ç¨‹åºé›†æ˜¯å¼±å‘½åçš„ï¼Œé‚£ä¹ˆæ ‡è¯†ä¸­å°±åªåŒ…å«ç¨‹åºé›†çš„åç§° (ä¸åŒ…å«ç‰ˆæœ¬ã€è¯­è¨€æ–‡åŒ–åŠå…¬é’¥æ ‡è®°ä¿¡æ¯)ã€‚åœ¨å†…éƒ¨ï¼ŒCLR ä½¿ç”¨ <code>System.Reflection.Assembly</code> ç±»çš„é™æ€ <code>Load</code> æ–¹æ³•å°è¯•åŠ è½½è¿™ä¸ªç¨‹åºé›†ã€‚è¯¥æ–¹æ³•åœ¨ .NET Framework SDK æ–‡æ¡£ä¸­æ˜¯å…¬å¼€çš„ï¼Œå¯è°ƒç”¨å®ƒæ˜¾å¼åœ°å°†ç¨‹åºé›†åŠ è½½åˆ° AppDomain ä¸­ã€‚è¯¥æ–¹æ³•æ˜¯ CLR çš„ä¸ Win32 <code>LoadLibrary</code> å‡½æ•°ç­‰ä»·çš„æ–¹æ³•ã€‚åœ¨å†…éƒ¨ï¼Œ <code>Load</code> å¯¼è‡´ CLR å‘ç¨‹åºé›†åº”ç”¨ä¸€ä¸ªç‰ˆæœ¬ç»‘å®šé‡å®šå‘ç­–ç•¥ï¼Œå¹¶åœ¨ GAC (å…¨å±€ç¨‹åºé›†ç¼“å­˜) ä¸­æŸ¥æ‰¾ç¨‹åºé›†ã€‚å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°±æ¥ç€å»åº”ç”¨ç¨‹åºçš„åŸºç›®å½•ã€ç§æœ‰è·¯å¾„å­ç›®å½•å’Œ <code>codebase</code> ä½ç½®æŸ¥æ‰¾ã€‚å¦‚æœè°ƒç”¨ <code>Load</code> æ—¶ä¼ é€’çš„æ˜¯å¼±å‘½åç¨‹åºé›†ï¼Œ <code>Load</code> å°±ä¸ä¼šå‘ç¨‹åºé›†åº”ç”¨ç‰ˆæœ¬ç»‘å®šé‡å®šå‘ç­–ç•¥ï¼ŒCLR ä¹Ÿä¸ä¼šå» GAC æŸ¥æ‰¾ç¨‹åºé›†ã€‚å¦‚æœ <code>Load</code> æ‰¾åˆ°æŒ‡å®šçš„ç¨‹åºé›†ï¼Œä¼šè¿”å›å¯¹ä»£è¡¨å·²åŠ è½½çš„é‚£ä¸ªç¨‹åºé›†çš„ä¸€ä¸ª <code>Assembly</code> å¯¹è±¡çš„å¼•ç”¨ã€‚å¦‚æœ <code>Load</code> æ²¡æœ‰æ‰¾åˆ°æŒ‡å®šç¨‹åºé›†ï¼Œä¼šæŠ›å‡ºä¸€ä¸ª <code>System.IO.FileNotFoundException</code> å¼‚å¸¸ã€‚è°ƒç”¨ <code>Assembly</code> çš„ <code>LoadFrom</code> æ–¹æ³•å¯ä»¥åŠ è½½æŒ‡å®šäº†è·¯å¾„åçš„ç¨‹åºé›†ã€‚åœ¨å†…éƒ¨ <code>LoadFrom</code> é¦–å…ˆè°ƒç”¨ <code>System.Refection.AssemblyName</code> ç±»çš„é™æ€ <code>GetAssemblyName</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ‰“å¼€æŒ‡å®šçš„æ–‡ä»¶ï¼Œæ‰¾åˆ° <code>AssemblyRef</code> å…ƒæ•°æ®è¡¨çš„è®°å½•é¡¹ï¼Œæå–ç¨‹åºé›†æ ‡è¯†ä¿¡æ¯ï¼Œç„¶åä»¥ä¸€ä¸ª <code>System.Reflection.AssemblyName</code> å¯¹è±¡çš„å½¢å¼è¿”å›è¿™äº›ä¿¡æ¯ (æ–‡ä»¶åŒæ—¶ä¼šå…³é—­)ã€‚éšåï¼Œ <code>LoadFrom</code> æ–¹æ³•åœ¨å†…éƒ¨è°ƒç”¨ <code>Assembly</code> çš„ <code>Load</code> æ–¹æ³•ï¼Œå°† <code>AssemblyName</code> å¯¹è±¡ä¼ ç»™å®ƒã€‚ç„¶åï¼ŒCLR åº”ç”¨ç‰ˆæœ¬ç»‘å®šé‡å®šå‘ç­–ç•¥ï¼Œå¹¶åœ¨å„ä¸ªä½ç½®æŸ¥æ‰¾åŒ¹é…çš„ç¨‹åºé›†ã€‚ <code>Load</code> æ‰¾åˆ°åŒ¹é…ç¨‹åºé›†ä¼šåŠ è½½å®ƒï¼Œå¹¶è¿”å›ä»£è¡¨å·²åŠ è½½ç¨‹åºé›†çš„ <code>Assembly</code> å¯¹è±¡ï¼› <code>LoadFrom</code> æ–¹æ³•å°†è¿”å›è¿™ä¸ªå€¼ã€‚å¦‚æœ <code>Load</code> æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç¨‹åºé›†ï¼Œ <code>LoadFrom</code> ä¼šåŠ è½½é€šè¿‡ <code>LoadFrom</code> çš„å®å‚ä¼ é€’çš„è·¯å¾„ä¸­çš„ç¨‹åºé›†ã€‚å½“ç„¶ï¼Œå¦‚æœå·²åŠ è½½äº†å…·æœ‰ç›¸åŒæ ‡è¯†çš„ç¨‹åºé›†ï¼Œ <code>LoadFrom</code> æ–¹æ³•å°±ä¼šç›´æ¥è¿”å›ä»£è¡¨å·²åŠ è½½ç¨‹åºé›†çš„ <code>Assembly</code> å¯¹è±¡ã€‚Microsoft Visual Studio çš„ UI è®¾è®¡äººå‘˜å’Œå…¶ä»–å·¥å…·ä¸€èˆ¬ç”¨çš„æ˜¯ <code>Assembly</code> çš„ <code>LoadFile</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»ä»»æ„è·¯å¾„åŠ è½½ç¨‹åºé›†ï¼Œè€Œä¸”å¯ä»¥å°†å…·æœ‰ç›¸åŒæ ‡è¯†çš„ç¨‹åºé›†å¤šæ¬¡åŠ è½½åˆ°ä¸€ä¸ª AppDomain ä¸­ã€‚åœ¨è®¾è®¡å™¨ / å·¥å…·ä¸­å¯¹åº”ç”¨ç¨‹åºçš„ UI è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œä¸”ç”¨æˆ·é‡æ–°ç”Ÿæˆäº†ç¨‹åºé›†æ—¶ï¼Œä¾¿æœ‰å¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µã€‚é€šè¿‡ <code>LoadFile</code> åŠ è½½ç¨‹åºé›†æ—¶ï¼ŒCLR ä¸ä¼šè‡ªåŠ¨è§£æä»»ä½•ä¾èµ–æ€§é—®é¢˜ï¼›ä½ çš„ä»£ç å¿…é¡»å‘ <code>AppDomain</code> çš„ <code>AssemblyResolve</code> äº‹ä»¶ç™»è®°ï¼Œå¹¶è®©äº‹ä»¶å›è°ƒæ–¹æ³•æ˜¾å¼åœ°åŠ è½½ä»»ä½•ä¾èµ–çš„ç¨‹åºé›†ã€‚æœä½ æ„å»ºçš„ä¸€ä¸ªå·¥å…·åªæƒ³é€šè¿‡åå°„ (æœ¬ç« ç¨åè¿›è¡Œè®¨è®º) æ¥åˆ†æç¨‹åºé›†çš„å…ƒæ•°æ®ï¼Œå¹¶å¸Œæœ›ç¡®ä¿ç¨‹åºé›†ä¸­çš„ä»»ä½•ä»£ç éƒ½ä¸ä¼šæ‰§è¡Œï¼Œé‚£ä¹ˆåŠ è½½ç¨‹åºé›†çš„æœ€ä½³æ–¹å¼å°±æ˜¯ä½¿ç”¨ <code>Assembly</code> çš„ <code>ReflectionOnlyLoadFrom</code> æ–¹æ³•æˆ–è€…ä½¿ç”¨ <code>Assembly</code> çš„ <code>ReflectionOnlyLoad</code> æ–¹æ³• (åè€…æ¯”è¾ƒå°‘è§)ã€‚ <code>ReflectionOnlyLoadFrom</code> æ–¹æ³•åŠ è½½ç”±è·¯å¾„æŒ‡å®šçš„æ–‡ä»¶ï¼›æ–‡ä»¶çš„å¼ºåç§°æ ‡è¯†ä¸ä¼šè·å–ï¼Œä¹Ÿä¸ä¼šåœ¨ GAC å’Œå…¶ä»–ä½ç½®æœç´¢æ–‡ä»¶ã€‚ <code>ReflectionOnlyLoad</code> æ–¹æ³•ä¼šåœ¨ GACã€åº”ç”¨ç¨‹åºåŸºç›®å½•ã€ç§æœ‰è·¯å¾„å’Œ <code>codebase</code> æŒ‡å®šçš„ä½ç½®æœç´¢æŒ‡å®šçš„ç¨‹åºé›†ã€‚ä½†å’Œ <code>Load</code> æ–¹æ³•ä¸åŒçš„æ˜¯ï¼Œ <code>ReflectionOnlyLoad</code> æ–¹æ³•ä¸ä¼šåº”ç”¨ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥ï¼Œæ‰€ä»¥ä½ æŒ‡å®šçš„æ˜¯å“ªä¸ªç‰ˆæœ¬ï¼Œè·å¾—çš„å°±æ˜¯å“ªä¸ªç‰ˆæœ¬ã€‚è¦è‡ªè¡Œå‘ç¨‹åºé›†æ ‡è¯†åº”ç”¨ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥ï¼Œå¯å°†å­—ç¬¦ä¸²ä¼ ç»™ <code>AppDomain</code> çš„ <code>ApplyPolicy</code> æ–¹æ³•ã€‚ç”¨ <code>ReflectionOnlyLoadFrom</code> æˆ– <code>ReflectionOnlyLoad</code> æ–¹æ³•åŠ è½½ç¨‹åºé›†æ—¶ï¼ŒCLR ç¦æ­¢ç¨‹åºé›†ä¸­çš„ä»»ä½•ä»£ç æ‰§è¡Œï¼›è¯•å›¾æ‰§è¡Œç”±è¿™ä¸¤ä¸ªæ–¹æ³•åŠ è½½çš„ç¨‹åºé›†ä¸­çš„ä»£ç ï¼Œä¼šå¯¼è‡´ CLR æŠ›å‡ºä¸€ä¸ª <code>InvalidOperationException</code> å¼‚å¸¸ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•å…è®¸å·¥å…·åŠ è½½å»¶è¿Ÿç­¾åçš„ç¨‹åºé›†ï¼Œè¿™ç§ç¨‹åºé›†æ­£å¸¸æƒ…å†µä¸‹ä¼šå› ä¸ºå®‰å…¨æƒé™ä¸å¤Ÿè€Œæ— æ³•åŠ è½½ã€‚å¦å¤–ï¼Œè¿™ç§ç¨‹åºé›†ä¹Ÿå¯èƒ½æ˜¯ä¸ºä¸åŒçš„ CPU æ¶æ„è€Œåˆ›å»ºçš„ã€‚åˆ©ç”¨åå°„æ¥åˆ†æç”±è¿™ä¸¤ä¸ªæ–¹æ³•ä¹‹ä¸€åŠ è½½çš„ç¨‹åºé›†æ—¶ï¼Œä»£ç ç»å¸¸éœ€è¦å‘ <code>AppDomain</code> çš„ <code>ReflectionOnlyAssemblyResolve</code> äº‹ä»¶æ³¨å†Œä¸€ä¸ªå›è°ƒæ–¹æ³•ï¼Œä»¥ä¾¿æ‰‹åŠ¨åŠ è½½ä»»ä½•å¼•ç”¨çš„ç¨‹åºé›† (å¦‚æœå¿…è¦ï¼Œè¿˜éœ€è¦è°ƒç”¨ <code>AppDomain</code> çš„ <code>ApplyPolicy</code> æ–¹æ³•)ï¼›CLR ä¸ä¼šè‡ªåŠ¨å¸®ä½ åšè¿™ä¸ªäº‹æƒ…ã€‚å›è°ƒæ–¹æ³•è¢«è°ƒç”¨ (invoke) æ—¶ï¼Œå®ƒå¿…é¡»è°ƒç”¨ (call) <code>Assembly</code> çš„ <code>ReflectionOnlyLoadFrom</code> æˆ– <code>ReflectionOnlyLoad</code> æ–¹æ³•æ¥æ˜¾å¼åŠ è½½å¼•ç”¨çš„ç¨‹åºé›†ï¼Œå¹¶è¿”å›å¯¹è¯¥ç¨‹åºé›†çš„å¼•ç”¨ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒCLR ä¼šæ‰¾ä¸åˆ°ä¾èµ–çš„ DLL ç¨‹åºé›†ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå½“åº”ç”¨ç¨‹åºåˆå§‹åŒ–æ—¶ï¼Œå¯ä»¥å‘ <code>AppDomain</code> çš„ <code>ResolveAssembly</code> äº‹ä»¶ç™»è®°ä¸€ä¸ªå›è°ƒæ–¹æ³•ã€‚</p><h2 id="using-reflection-to-build-a-dynamically-extensible-application"><a class="anchor" href="#using-reflection-to-build-a-dynamically-extensible-application">#</a> Using Reflection to Build a Dynamically Extensible Application</h2><blockquote><p>As you know, metadata is stored in a bunch of tables. When you build an assembly or a module, the compiler that youâ€™re using creates a type definition table, a field definition table, a method definition table, and so on. The System.Reflection namespace contains several types that allow you to write code that reflects over (or parses) these metadata tables. In effect, the types in this namespace offer an object model over the metadata contained in an assembly or a module.</p></blockquote><blockquote><p>Using these object model types, you can easily enumerate all of the types in a type definition metadata table. Then for each type, you can obtain its base type, the interfaces it implements, and the flags that are associated with the type. Additional types in the System.Reflection namespace allow you to query the typeâ€™s fields, methods, properties, and events by parsing the corresponding metadata tables. You can also discover any custom attributes (covered in Chapter 18, â€œCustom Attributesâ€) that have been applied to any of the metadata entities. There are even classes that let you determine referenced assemblies and methods that return the IL byte stream for a method. With all of this information, you could easily build a tool very similar to Microsoftâ€™s ILDasm.exe.</p></blockquote><p>ğŸ’¡æ³¨æ„ï¼šæœ‰çš„åå°„ç±»å‹åŠå…¶æˆå‘˜æ—¶ä¸“é—¨ç”± CLR ç¼–è¯‘å™¨çš„å¼€å‘äººå‘˜ä½¿ç”¨çš„ã€‚åº”ç”¨ç¨‹åºçš„å¼€å‘äººå‘˜ä¸€èˆ¬ç”¨ä¸ç€ã€‚FCL æ–‡æ¡£æ²¡æœ‰æ˜ç¡®æŒ‡å‡ºå“ªäº›ç±»å‹å’Œæˆå‘˜ä¾›ç¼–è¯‘å™¨å¼€å‘äººå‘˜ (è€Œéåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜) ä½¿ç”¨ï¼Œä½†åªè¦æ„è¯†åˆ°æœ‰äº›åå°„ç±»å‹åŠå…¶æˆå‘˜ä¸é€‚åˆæ‰€æœ‰äººä½¿ç”¨ï¼Œè¯¥æ–‡æ¡£æ—¶å°±ä¼šæ›´æ¸…é†’ä¸€äº›ã€‚</p><blockquote><p>In reality, very few applications will have the need to use the reflection types. Reflection is typically used by class libraries that need to understand a typeâ€™s definition in order to provide some rich functionality. For example, the FCLâ€™s serialization mechanism (discussed in Chapter 24, â€œRuntime Serializationâ€) uses reflection to determine what fields a type defines. The serialization formatter can then obtain the values of these fields and write them into a byte stream that is used for sending across the Internet, saving to a file, or copying to the clipboard. Similarly, Visual Studioâ€™s designers use reflection to determine which properties should be shown to developers when laying out controls on their Web Forms or Windows Forms at design time.</p></blockquote><blockquote><p>Reflection is also used when an application needs to load a specific type from a specific assembly at run time to accomplish some task. For example, an application might ask the user to provide the name of an assembly and a type. The application could then explicitly load the assembly, construct an instance of the type, and call methods defined in the type. This usage is conceptually similar to calling Win32â€™s LoadLibrary and GetProcAddress functions. Binding to types and calling methods in this way is frequently referred to as late binding. (Early binding is when the types and methods used by an application are determined at compile time.)</p></blockquote><p>ğŸ’¡å°ç»“ï¼šå…ƒæ•°æ®æ˜¯ç”¨ä¸€ç³»åˆ—è¡¨æ¥å­˜å‚¨çš„ã€‚ç”Ÿæˆç¨‹åºé›†æˆ–æ¨¡å—æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåˆ›å»ºä¸€ä¸ªç±»å‹å®šä¹‰è¡¨ã€ä¸€ä¸ªå­—æ®µå®šä¹‰è¡¨ã€ä¸€ä¸ªæ–¹æ³•å®šä¹‰è¡¨ä»¥åŠå…¶ä»–è¡¨ã€‚åˆ©ç”¨ <code>System.Reflection</code> å‘½åç©ºé—´ä¸­çš„å…¶ä»–ç±»å‹ï¼Œå¯ä»¥å†™ä»£ç æ¥åå°„ (æˆ–è€…è¯´â€ è§£æ â€œ) è¿™äº›å…ƒæ•°æ®è¡¨ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªå‘½åç©ºé—´ä¸­ç±»å‹ä¸ºç¨‹åºé›†æˆ–æ¨¡å—ä¸­åŒ…å«çš„å…ƒæ•°æ®æä¾›äº†ä¸€ä¸ªå¯¹è±¡æ¨¡å‹ã€‚åˆ©ç”¨å¯¹è±¡æ¨¡å‹ä¸­çš„ç±»å‹ï¼Œå¯ä»¥è½»æ¾æšä¸¾ç±»å‹å®šä¹‰å…ƒæ•°æ®è¡¨ä¸­çš„æ‰€æœ‰ç±»å‹ï¼Œè€Œé’ˆå¯¹æ¯ä¸ªç±»å‹éƒ½å¯è·å–å®ƒçš„åŸºç±»å‹ã€å®ƒå®ç°çš„æ¥å£ä»¥åŠä¸ç±»å‹å…³è”çš„æ ‡å¿— (flag)ã€‚åˆ©ç”¨ <code>System.Reflection</code> å‘½åç©ºé—´ä¸­çš„å…¶ä»–ç±»å‹ï¼Œè¿˜å¯è§£æå¯¹åº”çš„å…ƒæ•°æ®è¡¨æ¥æŸ¥è¯¢ç±»å‹çš„å­—æ®µã€æ–¹æ³•ã€å±æ€§å’Œäº‹ä»¶ã€‚è¿˜å¯å‘ç°åº”ç”¨äºä»»ä½•å…ƒæ•°æ®å®ä½“çš„å®šåˆ¶ç‰¹æ€§ (è¯¦æƒ…å‚è§ç¬¬ 18 ç« â€ å®šåˆ¶ç‰¹æ€§ â€œ)ã€‚ç”šè‡³æœ‰äº›ç±»å…è®¸åˆ¤æ–­å¼•ç”¨çš„ç¨‹åºé›†ï¼›è¿˜æœ‰ä¸€äº›æ–¹æ³•èƒ½è¿”å›ä¸€ä¸ªæ–¹æ³•çš„ IL å­—èŠ‚æµã€‚äº‹å®ä¸Šï¼Œåªæœ‰æå°‘æ•°åº”ç”¨ç¨‹åºæ‰éœ€ä½¿ç”¨åå°„ç±»å‹ã€‚å¦‚æœç±»åº“éœ€è¦ç†è§£ç±»å‹çš„å®šä¹‰æ‰èƒ½æä¾›ä¸°å¯Œçš„åŠŸèƒ½ï¼Œå°±é€‚åˆä½¿ç”¨åå°„ã€‚åœ¨è¿è¡Œæ—¶ï¼Œå½“åº”ç”¨ç¨‹åºéœ€è¦ä»ç‰¹å®šç¨‹åºé›†ä¸­åŠ è½½ç‰¹å®šç±»å‹ä»¥æ‰§è¡Œç‰¹å®šä»»åŠ¡æ—¶ï¼Œä¹Ÿè¦ä½¿ç”¨åå°„ã€‚ä¾‹å¦‚ï¼Œåº”ç”¨ç¨‹åºå¯è¦æ±‚ç”¨æˆ·æä¾›ç¨‹åºé›†å’Œç±»åˆ«åã€‚ç„¶åï¼Œåº”ç”¨ç¨‹åºå¯æ˜¾å¼åŠ è½½ç¨‹åºé›†ï¼Œæ„é€ ç±»å‹çš„å®ä¾‹ï¼Œå†è°ƒç”¨ç±»å‹ä¸­å®šä¹‰çš„æ–¹æ³•ã€‚è¿™ç§ç”¨æ³•åœ¨æ¦‚å¿µä¸Šç±»ä¼¼äºè°ƒç”¨ Win32 <code>LoadLibrary</code> å’Œ <code>GetProcAddress</code> å‡½æ•°ã€‚ä»¥è¿™ç§ç”¨æ³•åœ¨æ¦‚å¿µä¸Šç±»ä¼¼äºè°ƒç”¨ Win32 <code>LoadLibrary</code> å’Œ <code>GetProAddress</code> å‡½æ•°ã€‚ä»¥è¿™ç§æ–¹å¼ç»‘å®šåˆ°ç±»å‹å¹¶è°ƒç”¨æ–¹æ³•ç§°ä¸ºæ™šæœŸç»‘å®šã€‚(å¯¹åº”çš„ï¼Œæ—©æœŸç»‘å®šæ˜¯æŒ‡åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šåº”ç”¨ç¨‹åºè¦ä½¿ç”¨çš„ç±»å‹å’Œæ–¹æ³•ã€‚)</p><h2 id="reflection-performance"><a class="anchor" href="#reflection-performance">#</a> Reflection Performance</h2><blockquote><p>Reflection is an extremely powerful mechanism because it allows you to discover and use types and members at run time that you did not know about at compile time. This power does come with two main drawbacks:</p><ul><li><p>Reflection prevents type safety at compile time. Because reflection uses strings heavily, you lose type safety at compile time. For example, if you call Type.GetType(&quot;int&quot;); to ask reflection to find a type called â€œintâ€, the code compiles but returns null at run time because the CLR knows the â€œintâ€ type as â€œSystem.Int32â€.</p></li><li><p>Reflection is slow. When using reflection, the names of types and their members are not known at compile time; you discover them at run time by using a string name to identify each type and member. This means that reflection is constantly performing string searches as the types in the System.Reflection namespace scan through an assemblyâ€™s metadata. Often, the string searches are case-insensitive comparisons, which can slow this down even more.</p></li></ul></blockquote><blockquote><p>Invoking a member by using reflection will also hurt performance. When using reflection to invoke a method, you must first package the arguments into an array; internally, reflection must unpack these on to the threadâ€™s stack. Also, the CLR must check that the arguments are of the correct data type before invoking a method. Finally, the CLR ensures that the caller has the proper security permission to access the member being invoked.</p></blockquote><blockquote><p>For all of these reasons, itâ€™s best to avoid using reflection to access a field or invoke a method/ property. If youâ€™re writing an application that will dynamically discover and construct type instances, you should take one of the following approaches:</p><ul><li><p>Have the types derive from a base type that is known at compile time. At run time, construct an instance of the derived type, place the reference in a variable that is of the base type (by way of a cast), and call virtual methods defined by the base type.</p></li><li><p>Have the type implement an interface that is known at compile time. At run time, construct an instance of the type, place the reference in a variable that is of the interface type (by way of a cast), and call the methods defined by the interface.</p></li></ul></blockquote><blockquote><p>I tend to prefer using the interface technique over the base type technique because the base type technique doesnâ€™t allow the developer to choose the base type that works best in a particular situation. Although the base type technique works better in versioning scenarios, because you could always add a member to the base type and the derived types just inherit it; you canâ€™t add a member to an interface without forcing all types that implement the interface to modify their code and recompile it.</p></blockquote><blockquote><p>When you use either of these two techniques, I strongly suggest that the interface or base type be defined in its own assembly. This will reduce versioning issues. For more information about how to do this, see the section titled â€œDesigning an Application That Supports Add-Insâ€ later in this chapter.</p></blockquote><h3 id="discovering-types-defined-in-an-assembly"><a class="anchor" href="#discovering-types-defined-in-an-assembly">#</a> Discovering Types Defined in an Assembly</h3><blockquote><p>Reflection is frequently used to determine what types an assembly defines. The FCL offers many APIs to get this information. By far, the most commonly used API is Assemblyâ€™s ExportedTypes. property. Here is an example of code that loads an assembly and shows the names of all of the publicly exported types defined in it.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token class-name">String</span> dataAssembly <span class="token operator">=</span> <span class="token string">"System.Data, version=4.0.0.0, "</span> <span class="token operator">+</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token string">"culture=neutral, PublicKeyToken=b77a5c561934e089"</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token function">LoadAssemAndShowPublicTypes</span><span class="token punctuation">(</span>dataAssembly<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LoadAssemAndShowPublicTypes</span><span class="token punctuation">(</span><span class="token class-name">String</span> assemId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Explicitly load an assembly in to this AppDomain </span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">Assembly</span> a <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>assemId<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Execute this loop once for each Type </span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// publicly-exported from the loaded assembly </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Type</span> t <span class="token keyword">in</span> a<span class="token punctuation">.</span>ExportedTypes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token comment">// Display the full name of the type </span></pre></td></tr><tr><td data-num="16"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>FullName<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="what-exactly-is-a-type-object"><a class="anchor" href="#what-exactly-is-a-type-object">#</a> What Exactly Is a Type Object?</h3><blockquote><p>Notice that the previous code iterates over a sequence of System.Type objects. The System.Type type is your starting point for doing type and object manipulations. A System.Type object represents a type reference (as opposed to a type definition).</p></blockquote><blockquote><p>Recall that System.Object defines a public, nonvirtual instance method named GetType. When you call this method, the CLR determines the specified objectâ€™s type and returns a reference to its Type object. Because there is only one Type object per type in an AppDomain, you can use equality and inequality operators to see whether two objects are of the same type.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Boolean</span> <span class="token function">AreObjectsTheSameType</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o1<span class="token punctuation">,</span> <span class="token class-name">Object</span> o2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">return</span> o1<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> o2<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>In addition to calling Objectâ€™s GetType method, the FCL offers several more ways to obtain a Type object:</p><ul><li><p>The System.Type type offers several overloaded versions of the static GetType method. All versions of this method take a String. The string must specify the full name of the type (including its namespace). Note that the primitive type names supported by the compiler (such as C#â€™s int, string, bool, and so on) arenâ€™t allowed because these names mean nothing to the CLR. If the string is simply the name of a type, the method checks the calling assembly to see whether it defines a type of the specified name. If it does, a reference to the appropriate Type object is returned. If the calling assembly doesnâ€™t define the specified type, the types defined by MSCorLib.dll are checked. If a type with a matching name still canâ€™t be found, null is returned or a System. TypeLoadException is thrown, depending on which overload of the GetType method you called and what parameters you passed to it. The FCL documentation fully explains this method. You can pass an assembly-qualified type string, such as â€œSystem.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089â€, to GetType. In this case, GetType will look for the type in the specified assembly (loading the assembly if necessary).</p></li><li><p>The System.Type type offers a static ReflectionOnlyGetType method. This method behaves similarly to the GetType method mentioned in the previous bullet, except that the type is loaded so that it can be reflected over but cannot be executed.</p></li><li><p>The System.TypeInfo type offers the following instance members: DeclaredNestedTypes and GetDeclaredNestedType.</p></li><li><p>The System.Reflection.Assembly type offers the following instance members: GetType, DefinedTypes, and ExportedTypes.</p></li></ul></blockquote><p>ğŸ’¡æ³¨æ„ï¼šæ„é€ ä¼ ç»™åå°„æ–¹æ³•çš„å­—ç¬¦ä¸²æ—¶ï¼Œè¦ä½¿ç”¨ç±»å‹åç§°æˆ–é™å®šäº†ç¨‹åºé›†çš„ç±»å‹åç§°ã€‚Microsoft ä¸ºè¿™äº›åç§°å®šä¹‰äº†å·´å…‹æ–¯ â€”â€” è¯ºå°”èŒƒå¼ (Backus-MaurFormï¼Œ BNF) è¯­æ³•ã€‚ä½¿ç”¨åå°„æ—¶ï¼Œäº†è§£è¿™ç§è¯­æ³•å¯¹ä½ å¾ˆæœ‰å¸®åŠ©ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†åµŒå¥—ç±»å‹ã€æ³›å‹ç±»å‹ã€æ³›å‹ç±»å‹ã€å¼•ç”¨å‚æ•°æˆ–è€…æ•°ç»„çš„æ—¶å€™ã€‚è¦æƒ³äº†è§£å®Œæ•´è¯­æ³•ï¼Œè¯·å‚è€ƒæ–‡æ¡£æˆ–è€… Google â€œBNF ç±»å‹åç§°â€ã€‚è¿˜å¯å‚è€ƒ <code>Type</code> å’Œ <code>TypeInfo</code> çš„ <code>MakeArrayType,MakeByRefType,MakeGenericType</code> å’Œ <code>MakePointerType</code> æ–¹æ³•ã€‚</p><blockquote><p>Many programming languages also offer an operator that allows you to obtain a Type object from a type name that is known at compile time. When possible, you should use this operator to obtain a reference to a Type instead of using any of the methods in the preceding list, because the operator generally produces faster code. In C#, the operator is called typeof, and you use this operator typically to compare late-bound type information with early-bound (known at compile time) type information. The following code demonstrates an example of its use.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// GetType returns the type of the object at runtime (late-bound) </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// typeof returns the type of the specified class (early-bound) </span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">FileInfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">DirectoryInfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>ğŸ’¡æ³¨æ„ï¼šä¸Šè¿°ä»£ç çš„ç¬¬ä¸€ä¸ª <code>if</code> è¯­å¥æ£€æŸ¥å˜é‡ <code>o</code> æ˜¯å¦å¼•ç”¨äº† <code>FileInfo</code> ç±»å‹çš„å¯¹è±¡ï¼›å®ƒä¸æ£€æŸ¥ <code>o</code> æ˜¯å¦å¼•ç”¨ä» <code>FileInfo</code> ç±»å‹æ´¾ç”Ÿçš„å¯¹è±¡ã€‚æ¢è¨€ä¹‹ï¼Œä¸Šè¿°ä»£ç æµ‹è¯•çš„æ˜¯ç²¾ç¡®åŒ¹é…ï¼Œè€Œéå…¼å®¹åŒ¹é…ï¼Œ(ä½¿ç”¨è½¬å‹æˆ– C# çš„ <code>is/as</code> æ“ä½œç¬¦æ—¶ï¼Œæµ‹è¯•çš„å°±æ˜¯å…¼å®¹åŒ¹é…ã€‚)</p><blockquote><p>As mentioned earlier, a Type object represents a type reference that is a lightweight object. If you want to learn more about the type itself, then you must acquire a TypeInfo object, which represents a type definition. You can convert a Type object to a TypeInfo object by calling System.Reflection.IntrospectionExtensionsâ€™ GetTypeInfo extension method.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Type</span> typeReference <span class="token operator">=</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">// For example: o.GetType() or typeof(Object)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">TypeInfo</span> typeDefinition <span class="token operator">=</span> typeReference<span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>And, although less useful, you can convert a TypeInfo object to a Type object by calling TypeInfoâ€™s AsType method</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">TypeInfo</span> typeDefinition <span class="token operator">=</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Type</span> typeReference <span class="token operator">=</span> typeDefinition<span class="token punctuation">.</span><span class="token function">AsType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Obtaining a TypeInfo object forces the CLR to resolve the type by ensuring that the assembly that defines the type is loaded. This can be an expensive operation that can be avoided if all you need are type references (Type objects). However, after you have a TypeInfo object, you can query many of the typeâ€™s properties to learn more about it. Most of the properties, such as IsPublic, IsSealed, IsAbstract, IsClass, IsValueType, and so on, indicate flags associated with the type. Other properties, such as Assembly, AssemblyQualifiedName, FullName, Module, and so on, return the name of the typeâ€™s defining assembly or module and the full name of the type. You can also query the BaseType property to obtain a reference to the typeâ€™s base type, and a slew of members will give you even more information about the type. The FCL documentation describes all of the methods and properties that TypeInfo exposes.</p></blockquote><h3 id="building-a-hierarchy-of-exception-derived-types"><a class="anchor" href="#building-a-hierarchy-of-exception-derived-types">#</a> Building a Hierarchy of Exception-Derived Types</h3><blockquote><p>The following code uses many of the concepts discussed already in this chapter to load a bunch of assemblies into the AppDomain and display all of the classes that are ultimately derived from System. Exception. By the way, this is the program I wrote to build the exception hierarchy displayed in the â€œFCL-Defined Exception Classesâ€ section in Chapter 20, â€œExceptions and State Management.â€</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Explicitly load the assemblies that we want to reflect over</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token function">LoadAssemblies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Filter &amp; sort all the types</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> allTypes <span class="token operator">=</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">(</span><span class="token keyword">from</span> a <span class="token keyword">in</span> AppDomain<span class="token punctuation">.</span>CurrentDomain<span class="token punctuation">.</span><span class="token function">GetAssemblies</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">from</span> t <span class="token keyword">in</span> a<span class="token punctuation">.</span>ExportedTypes</pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">where</span> <span class="token class-name">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Exception</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">orderby</span> t<span class="token punctuation">.</span>Name</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">select</span> t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// Build the inheritance hierarchy tree and show it</span></pre></td></tr><tr><td data-num="12"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token function">WalkInheritanceHierarchy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Exception</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="13"></td><td><pre>allTypes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">StringBuilder</span> <span class="token function">WalkInheritanceHierarchy</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token class-name">StringBuilder</span> sb<span class="token punctuation">,</span> <span class="token class-name">Int32</span> indent<span class="token punctuation">,</span> <span class="token class-name">Type</span> baseType<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>Type<span class="token punctuation">></span></span> allTypes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token class-name">String</span> spaces <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">String</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">,</span> indent <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> sb<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span>spaces <span class="token operator">+</span> baseType<span class="token punctuation">.</span>FullName<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> t <span class="token keyword">in</span> allTypes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BaseType <span class="token operator">!=</span> baseType<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token function">WalkInheritanceHierarchy</span><span class="token punctuation">(</span>sb<span class="token punctuation">,</span> indent <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> allTypes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token keyword">return</span> sb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LoadAssemblies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token class-name">String<span class="token punctuation">[</span><span class="token punctuation">]</span></span> assemblies <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token string">"System, PublicKeyToken=&#123;0&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token string">"System.Core, PublicKeyToken=&#123;0&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token string">"System.Data, PublicKeyToken=&#123;0&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token string">"System.Design, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token string">"System.DirectoryServices, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token string">"System.Drawing, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token string">"System.Drawing.Design, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token string">"System.Management, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token string">"System.Messaging, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token string">"System.Runtime.Remoting, PublicKeyToken=&#123;0&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token string">"System.Security, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token string">"System.ServiceProcess, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token string">"System.Web, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre> <span class="token string">"System.Web.RegularExpressions, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre> <span class="token string">"System.Web.Services, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token string">"System.Xml, PublicKeyToken=&#123;0&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token class-name">String</span> EcmaPublicKeyToken <span class="token operator">=</span> <span class="token string">"b77a5c561934e089"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token class-name">String</span> MSPublicKeyToken <span class="token operator">=</span> <span class="token string">"b03f5f7f11d50a3a"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token comment">// Get the version of the assembly containing System.Object</span></pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token comment">// We'll assume the same version for all the other assemblies</span></pre></td></tr><tr><td data-num="48"></td><td><pre> <span class="token class-name">Version</span> version <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">System<span class="token punctuation">.</span>Object</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Version<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre> <span class="token comment">// Explicitly load the assemblies that we want to reflect over</span></pre></td></tr><tr><td data-num="50"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">String</span> a <span class="token keyword">in</span> assemblies<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token class-name">String</span> AssemblyIdentity <span class="token operator">=</span> </pre></td></tr><tr><td data-num="52"></td><td><pre> String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> EcmaPublicKeyToken<span class="token punctuation">,</span> MSPublicKeyToken<span class="token punctuation">)</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="53"></td><td><pre> <span class="token string">", Culture=neutral, Version="</span> <span class="token operator">+</span> version<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre> Assembly<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>AssemblyIdentity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="constructing-an-instance-of-a-type"><a class="anchor" href="#constructing-an-instance-of-a-type">#</a> Constructing an Instance of a Type</h3><blockquote><p>After you have a reference to a Type-derived object, you might want to construct an instance of this type. The FCL offers several mechanisms to accomplish this:</p><ul><li><p><strong>System.Activatorâ€™s CreateInstance methods</strong> The Activator class offers several overloads of its static CreateInstance method. When you call this method, you can pass either a reference to a Type object or a String that identifies the type of object you want to create. The versions that take a type are simpler. You get to pass a set of arguments for the typeâ€™s constructor, and the method returns a reference to the new object.</p><p>The versions of this method in which you specify the desired type by using a string are a bit more complex. First, you must also specify a string identifying the assembly that defines the type. Second, these methods allow you to construct a remote object if you have remoting options configured properly. Third, these versions donâ€™t return a reference to the new object. Instead, they return a System.Runtime.Remoting.ObjectHandle (which is derived from System.MarshalByRefObject).</p><p>An ObjectHandle is a type that allows an object created in one AppDomain to be passed around to other AppDomains without forcing the object to materialize. When youâ€™re ready to materialize the object, you call ObjectHandleâ€™s Unwrap method. This method loads the assembly that defines the type being materialized in the AppDomain where Unwrap is called. If the object is being marshaled by reference, the proxy type and object are created. If the object is being marshaled by value, the copy is deserialized.</p></li><li><p><strong>System.Activatorâ€™s CreateInstanceFrom methods</strong> The Activator class also offers a set of static CreateInstanceFrom methods. These methods behave just as the CreateInstance method, except that you must always specify the type and its assembly via string parameters. The assembly is loaded into the calling AppDomain by using Assemblyâ€™s LoadFrom method (instead of Load). Because none of these methods takes a Type parameter, all of the CreateInstanceFrom methods return a reference to an ObjectHandle, which must be unwrapped.</p></li><li><p><strong>System.AppDomainâ€™s methods</strong> The AppDomain type offers four instance methods (each with several overloads) that construct an instance of a type: CreateInstance, CreateInstanceAndUnwrap, CreateInstanceFrom, and CreateInstanceFromAndUnwrap. These methods work just as Activatorâ€™s methods except that these methods are instance methods, allowing you to specify which AppDomain the object should be constructed in. The methods that end with Unwrap exist for convenience so that you donâ€™t have to make an additional method call.</p></li><li><p><strong>System.Reflection.ConstructorInfoâ€™s Invoke instance method</strong> Using a reference to a TypeInfo object, you can bind to a particular constructor and obtain a reference to the constructorâ€™s ConstructorInfo object. Then you can use the reference to the ConstructorInfo object to call its Invoke method. The type is always created in the calling AppDomain, and a reference to the new object is returned. Iâ€™ll also discuss this method in more detail later in this chapter.</p></li></ul></blockquote><p>ğŸ’¡æ³¨æ„ï¼šCLR ä¸è¦æ±‚å€¼ç±»å‹å®šä¹‰ä»»ä½•æ„é€ å™¨ã€‚ä½†è¿™ä¼šé€ æˆä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºä¸Šè¿°åˆ—è¡¨ä¸­çš„æ‰€æœ‰æœºåˆ¶éƒ½è¦æ±‚è°ƒç”¨æ„é€ å™¨æ¥æ„é€ å¯¹è±¡ã€‚ç„¶è€Œï¼Œ <code>Activator</code> çš„ <code>CreateInstance</code> æ–¹æ³•å…è®¸åœ¨ä¸è°ƒç”¨æ„é€ å™¨çš„æƒ…å†µä¸‹åˆ›å»ºå€¼ç±»å‹çš„å®ä¾‹ã€‚è¦åœ¨ä¸è°ƒç”¨æ„é€ å™¨çš„æƒ…å†µä¸‹åˆ›å»ºå€¼ç±»å‹çš„å®ä¾‹ï¼Œå¿…é¡»è°ƒç”¨ <code>CreateInstance</code> æ–¹æ³•è·å–å•ä¸ª <code>Type</code> å‚æ•°çš„ç‰ˆæœ¬æˆ–è€…è·å– <code>Type</code> å’Œ <code>Boolean</code> å‚æ•°çš„ç‰ˆæœ¬ã€‚</p><blockquote><p>The mechanisms just listed allow you to create an object for all types except for arrays (System. Array-derived types) and delegates (System.MulticastDelegate-derived types). To create an array, you should call Arrayâ€™s static CreateInstance method (several overloaded versions exist). The first parameter to all versions of CreateInstance is a reference to the Type of elements you want in the array. CreateInstanceâ€™s other parameters allow you to specify various combinations of dimensions and bounds. To create a delegate, you should call MethodInfoâ€™s CreateDelegate method. The first parameter to all versions of CreateDelegate is a reference to the Type of delegate you want to create. CreateDelegateâ€™s other parameter allows you to specify which object should be passed as the this parameter when calling an instance method.</p></blockquote><blockquote><p>To construct an instance of a generic type, first get a reference to the open type, and then call Typeâ€™s MakeGenericType method, passing in an array of types that you want to use as the type arguments. Then, take the returned Type object and pass it into one of the various methods previously listed. Here is an example.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span>TKey<span class="token punctuation">,</span> TValue<span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Get a reference to the generic type's type object </span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token class-name">Type</span> openType <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token punctuation">,</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Close the generic type by using TKey=String, TValue=Int32 </span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token class-name">Type</span> closedType <span class="token operator">=</span> openType<span class="token punctuation">.</span><span class="token function">MakeGenericType</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Int32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Construct an instance of the closed type </span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">Object</span> o <span class="token operator">=</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>closedType<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Prove it worked </span></pre></td></tr><tr><td data-num="13"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If you compile the preceding code and run it, you get the following output.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>Dictionary`<span class="token number">2</span><span class="token punctuation">[</span>System<span class="token punctuation">.</span>String<span class="token punctuation">,</span>System<span class="token punctuation">.</span>Int32<span class="token punctuation">]</span></pre></td></tr></table></figure><h2 id="designing-an-application-that-supports-add-ins"><a class="anchor" href="#designing-an-application-that-supports-add-ins">#</a> Designing an Application That Supports Add-Ins</h2><blockquote><p>When youâ€™re building extensible applications, interfaces should be the centerpiece. You could use a base class instead of an interface, but in general, an interface is preferred because it allows add-in developers to choose their own base class. Suppose, for example, that youâ€™re writing an application and you want others to be able to create types that your application can load and use seamlessly.</p></blockquote><blockquote><p>Hereâ€™s the way to design this application:</p><ul><li>Create a Host SDK assembly that defines an interface whose methods are used as the communication mechanism between the host application and the add-in components. When defining the parameters and return types for the interface methods, try to use other interfaces or types defined in MSCorLib.dll. If you want to pass and return your own data types, define them in this Host SDK assembly, too. After you settle on your interface definitions, give this assembly a strong name (discussed in Chapter 3), and then package and deploy it to your partners and users. Once published, you should really avoid making any kind of breaking changes to the types in this assembly. For example, do not change the interface in any way. However, if you define any data types, it is OK to add new members. If you make any modifications to the assembly, youâ€™ll probably want to deploy it with a publisher policy file (also discussed in Chapter 3).</li></ul></blockquote><p>ğŸ’¡æ³¨æ„ï¼šä¹‹æ‰€ä»¥èƒ½ä½¿ç”¨ MSCorLib.dll ä¸­å®šä¹‰çš„ç±»å‹ï¼Œæ˜¯å› ä¸º CLR æ€»æ˜¯åŠ è½½ä¸ CLR æœ¬èº«çš„ç‰ˆæœ¬åŒ¹é…çš„é‚£ä¸ªç‰ˆæœ¬çš„ MSCorLib.dllã€‚æ­¤å¤–ï¼Œä¸€ä¸ª CLR å®ä¾‹åªä¼šåŠ è½½ä¸€ä¸ªç‰ˆæœ¬çš„ MSCorLib.dll ã€‚æ¢è¨€ä¹‹ï¼Œæ°¸è¿œä¸ä¼šå‡ºç°å¤šä¸ªä¸åŒç‰ˆæœ¬çš„ MSCorLib.dll éƒ½åŠ è½½çš„æƒ…å†µ (è¯¦è§ç¬¬ 3 ç« )ã€‚æœ€åç»“æœå°±æ˜¯ï¼Œç»ä¸ä¼šå‡ºç°ç±»å‹ç‰ˆæœ¬ä¸åŒ¹é…çš„æƒ…å†µã€‚è¿™è¿˜æœ‰åŠ©äºå‡å°‘åº”ç”¨ç¨‹åºå¯¹å†…å­˜çš„éœ€æ±‚ã€‚</p><blockquote><ul><li><p>The add-in developers will, of course, define their own types in their own Add-In assembly. Their Add-In assembly will reference the types in your Host SDK assembly. The add-in developers are able to put out a new version of their assembly as often as theyâ€™d like, and the host application will be able to consume the add-in types without any problem whatsoever.</p></li><li><p>Create a separate Host Application assembly containing your applicationâ€™s types. This assembly will obviously reference the Host SDK assembly and use the types defined in it. Feel free to modify the code in the Host Application assembly to your heartâ€™s desire. Because the add-in developers donâ€™t reference the Host Application assembly, you can put out a new version of it every hour if you want to and not affect any of the add-in developers.</p></li></ul></blockquote><blockquote><p>This section contains some very important information. When using types across assemblies, you need to be concerned with assembly-versioning issues. Take your time to architect this cleanly by isolating the types that you use for communication across assembly boundaries into their own assembly. Avoid mutating or changing these type definitions. However, if you really need to modify the type definitions, make sure that you change the assemblyâ€™s version number and create a publisher policy file for the new version.</p></blockquote><blockquote><p>Iâ€™ll now walk through a very simple scenario that puts all of this together. First, here is the code for the HostSDK.dll assembly.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">namespace</span> <span class="token namespace">Wintellect<span class="token punctuation">.</span>HostSDK</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IAddIn</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token return-type class-name">String</span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Second, here is the code for an AddInTypes.dll assembly defining two public types that implement the HostSDKâ€™s interface. To build this assembly, the HostSDK.dll assembly must be referenced.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">Wintellect<span class="token punctuation">.</span>HostSDK</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AddIn_A</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAddIn</span></span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token function">AddIn_A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">return</span> <span class="token string">"AddIn_A: "</span> <span class="token operator">+</span> x<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AddIn_B</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAddIn</span></span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">public</span> <span class="token function">AddIn_B</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">return</span> <span class="token string">"AddIn_B: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Third, here is the code for a simple Host.exe assembly (a console application). To build this assembly, the HostSDK.dll assembly must be referenced. To discover usable add-in types, this host code assumes that the types are defined in assemblies ending with a .dll file extension and that these assemblies are deployed into the same directory as the hostâ€™s EXE file. Microsoftâ€™s Managed Extensibility Framework (MEF) is built on top of the various mechanisms that I show here, and it also offers add-in registration and discovery mechanisms. I urge you to check MEF out if you are building a dynamically extensible application, because it can simplify some of the material in this chapter.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">Wintellect<span class="token punctuation">.</span>HostSDK</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Find the directory that contains the Host exe</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token class-name">String</span> AddInDir <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">GetDirectoryName</span><span class="token punctuation">(</span>Assembly<span class="token punctuation">.</span><span class="token function">GetEntryAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Location<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Assume AddIn assemblies are in same directory as host's EXE file</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> AddInAssemblies <span class="token operator">=</span> Directory<span class="token punctuation">.</span><span class="token function">EnumerateFiles</span><span class="token punctuation">(</span>AddInDir<span class="token punctuation">,</span> <span class="token string">"*.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Create a collection of Add-In Types usable by the host</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> AddInTypes <span class="token operator">=</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">from</span> file <span class="token keyword">in</span> AddInAssemblies</pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">let</span> assembly <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">from</span> t <span class="token keyword">in</span> assembly<span class="token punctuation">.</span>ExportedTypes <span class="token comment">// Publicly-exported types</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token comment">// Type is usable if it is a class that implements IAddIn </span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">where</span> <span class="token class-name">t</span><span class="token punctuation">.</span>IsClass <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">IAddIn</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">select</span> t<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// Initialization complete: the host has discovered the usable Add-Ins</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token comment">// Here's how the host can construct Add-In objects and use them</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Type</span> t <span class="token keyword">in</span> AddInTypes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token class-name">IAddIn</span> ai <span class="token operator">=</span> <span class="token punctuation">(</span>IAddIn<span class="token punctuation">)</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span><span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The simple host/add-in scenario just shown doesnâ€™t use AppDomains. However, in a real-life scenario, you will likely create each add-in in its own AppDomain with its own security and configuration settings. And of course, each AppDomain could be unloaded if you wanted to remove an add-in from memory. To communicate across the AppDomain boundary, youâ€™d either tell the add-in developers to derive their add-in types from MarshalByRefObject or, more likely, have the host application define its own internal type that is derived from MarshalByRefObject. As each AppDomain is created, the host would create an instance of its own MarshalByRefObject-derived type in the new AppDomain. The hostâ€™s code (in the default AppDomain) would communicate with its own type (in the other AppDomains) to have it load add-in assemblies and create and use instances of the add-in types.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šåå°„æ˜¯ç›¸å½“å¼ºå¤§çš„æœºåˆ¶ï¼Œå…è®¸åœ¨è¿è¡Œå‘ç°å¹¶ä½¿ç”¨ç¼–è¯‘æ—¶è¿˜ä¸äº†è§£çš„ç±»å‹åŠå…¶æˆå‘˜ã€‚ä½†æ˜¯ï¼Œå®ƒä¹Ÿæœ‰ä¸‹é¢ä¸¤ä¸ªç¼ºç‚¹ã€‚åå°„é€ æˆç¼–è¯‘æ—¶æ— æ³•ä¿è¯ç±»å‹å®‰å…¨æ€§ã€‚ç”±äºåå°„ä¸¥é‡ä¾èµ–å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¼šä¸§å¤±ç¼–è¯‘æ—¶çš„ç±»å‹å®‰å…¨æ€§ã€‚åå°„é€Ÿåº¦æ…¢ã€‚ä½¿ç”¨åå°„æ—¶ï¼Œç±»å‹åŠå…¶æˆå‘˜çš„åç§°åœ¨ç¼–è¯‘æ—¶æœªçŸ¥ï¼›ä½ è¦ç”¨å­—ç¬¦ä¸²åç§°æ ‡è¯†æ¯ä¸ªç±»å‹åŠå…¶æˆå‘˜ï¼Œç„¶ååœ¨è¿è¡Œæ—¶å‘ç°å®ƒä»¬ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨ <code>System.Reflection</code> å‘½åç©ºé—´ä¸­çš„ç±»å‹æ‰«æç¨‹åºé›†çš„å…ƒæ•°æ®æ—¶ï¼Œåå°„æœºåˆ¶ä¼šä¸åœåœ°æ‰§è¡Œå­—ç¬¦ä¸²æœç´¢ã€‚é€šå¸¸ï¼Œå­—ç¬¦ä¸²æœç´¢æ‰§è¡Œçš„æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„æ¯”è¾ƒï¼Œè¿™ä¼šè¿›ä¸€æ­¥å½±å“é€Ÿåº¦ã€‚ä½¿ç”¨åå°„è°ƒç”¨æˆå‘˜ä¹Ÿä¼šå½±å“æ€§èƒ½ã€‚ç”¨åå°„è°ƒç”¨æ–¹æ³•æ—¶ï¼Œé¦–å…ˆå¿…é¡»å°†å®å‚æ‰“åŒ… (pack) æˆæ•°ç»„ï¼›åœ¨å†…éƒ¨ï¼Œåå°„å¿…é¡»å°†è¿™äº›å®å‚è§£åŒ… (unpack) åˆ°çº¿ç¨‹æ ˆä¸Šã€‚æ­¤å¤–ï¼Œåœ¨è°ƒç”¨æ–¹æ³•å‰ï¼ŒCLR å¿…é¡»æ£€æŸ¥å®å‚å…·æœ‰æ­£ç¡®çš„æ•°æ®ç±»å‹ã€‚æœ€åï¼ŒCLR å¿…é¡»ç¡®ä¿è°ƒç”¨è€…æœ‰æ­£ç¡®çš„å®‰å…¨æƒé™æ¥è®¿é—®è¢«è°ƒç”¨çš„æˆå‘˜ã€‚åŸºäºä¸Šè¿°æ‰€æœ‰åŸå› ï¼Œæœ€å¥½é¿å…åˆ©ç”¨åå°„æ¥è®¿é—®å­—æ®µæˆ–è°ƒç”¨æ–¹æ³• / å±æ€§ã€‚åº”è¯¥åˆ©ç”¨ä¸€ä¸‹ä¸¤ç§æŠ€æœ¯ä¹‹ä¸€å¼€å‘åº”ç”¨ç¨‹åºæ¥åŠ¨æ€å‘ç°å’Œæ„é€ ç±»å‹å®ä¾‹ã€‚è®©ç±»å‹ä»ç¼–è¯‘æ—¶å·²çŸ¥çš„åŸºç±»å‹æ´¾ç”Ÿã€‚åœ¨è¿è¡Œæ—¶æ„é€ æ´¾ç”Ÿç±»å‹çš„å®ä¾‹ï¼Œå°†å¯¹å®ƒçš„å¼•ç”¨æ–¹æ³•æ”¾åˆ°åŸºç±»å‹çš„å˜é‡ä¸­ (åˆ©ç”¨è½¬å‹)ï¼Œå†è°ƒç”¨åŸºç±»å‹å®šä¹‰çš„è™šæ–¹æ³•ã€‚è®©ç±»å‹å®ç°ç¼–è¯‘æ—¶å·²çŸ¥çš„æ¥å£ã€‚åœ¨è¿è¡Œæ—¶æ„é€ ç±»å‹çš„å®ä¾‹ï¼Œå°†å¯¹å®ƒçš„å¼•ç”¨æ”¾åˆ°æ¥å£ç±»å‹çš„å˜é‡ä¸­ (åˆ©ç”¨è½¬å‹)ï¼Œå†è°ƒç”¨æ¥å£å®šä¹‰çš„æ–¹æ³•ã€‚ä½¿ç”¨è¿™ä¸¤ç§æŠ€æœ¯æ—¶ï¼Œå¼ºçƒˆå»ºè®®æ¥å£æˆ–åŸºç±»å‹åœ¨å®ƒä»¬è‡ªå·±çš„ç¨‹åºé›†ä¸­å®šä¹‰ï¼Œè¿™æœ‰åŠ©äºç¼“è§£ç‰ˆæœ¬æ§åˆ¶é—®é¢˜ã€‚ <code>System.Type</code> ç±»å‹æ˜¯æ‰§è¡Œç±»å‹å’Œå¯¹è±¡æ“ä½œçš„èµ·ç‚¹ã€‚ <code>System.Type</code> å¯¹è±¡ä»£è¡¨ä¸€ä¸ªç±»å‹å¼•ç”¨ (è€Œä¸æ˜¯ç±»å‹å®šä¹‰)ã€‚ <code>System.Object</code> å®šä¹‰äº†å…¬å…±éè™šå®ä¾‹æ–¹æ³• <code>GetType</code> ã€‚è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼ŒCLR ä¼šåˆ¤æ–­æŒ‡å®šå¯¹è±¡çš„ç±»å‹ï¼Œå¹¶è¿”å›å¯¹è¯¥ç±»å‹çš„ <code>Type</code> å¯¹è±¡çš„å¼•ç”¨ã€‚ç”±äºåœ¨ä¸€ä¸ª AppDomain ä¸­ï¼Œæ¯ä¸ªç±»å‹åªæœ‰ä¸€ä¸ª <code>Type</code> å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ç›¸ç­‰å’Œä¸ç­‰æ“ä½œç¬¦æ¥åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯ä¸æ˜¯ç›¸åŒçš„ç±»å‹ã€‚é™¤äº†è°ƒç”¨ <code>Object</code> çš„ <code>GetType</code> æ–¹æ³•ï¼Œ FCL è¿˜æä¾›äº†è·å¾— <code>Type</code> å¯¹è±¡çš„å…¶ä»–å‡ ç§æ–¹å¼ã€‚ <code>System.Type</code> ç±»å‹æä¾›äº†é™æ€ <code>GetType</code> æ–¹æ³•çš„å‡ ä¸ªé‡è½½ç‰ˆæœ¬ã€‚æ‰€æœ‰ç‰ˆæœ¬éƒ½æ¥æ”¶ä¸€ä¸ª <code>String</code> å‚æ•°ã€‚å­—ç¬¦ä¸²å¿…é¡»æŒ‡å®šç±»å‹çš„å…¨å (åŒ…æ‹¬å®ƒçš„å‘½åç©ºé—´)ã€‚æ³¨æ„ä¸å…è®¸ä½¿ç”¨ç¼–è¯‘å™¨æ”¯æŒçš„åŸºå…ƒç±»å‹ (æ¯”å¦‚ C# çš„ <code>int</code> ï¼Œ <code>string</code> ï¼Œ <code>bool</code> ç­‰)ï¼Œè¿™äº›åç§°å¯¹äº CLR æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚å¦‚æœä¼ é€’çš„åªæ˜¯ä¸€ä¸ªç±»å‹åç§°ï¼Œæ–¹æ³•å°†æ£€æŸ¥è°ƒç”¨ç¨‹åºé›†ï¼Œçœ‹å®ƒæ˜¯å¦å®šä¹‰äº†æŒ‡å®šåç§°çš„ç±»å‹ã€‚å¦‚æœæ˜¯ï¼Œå°±è¿”å›å¯¹æ°å½“ <code>Type</code> å¯¹è±¡çš„å¼•ç”¨ã€‚å¦‚æœè°ƒç”¨ç¨‹åºé›†æ²¡æœ‰å®šä¹‰æŒ‡å®šçš„ç±»å‹ï¼Œå°±æ£€æŸ¥ MSCorLib.dll å®šä¹‰çš„ç±»å‹ã€‚å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±è¿”å› <code>null</code> æˆ–æŠ›å‡º <code>System.TypeLoadException</code> (å–å†³äºè°ƒç”¨çš„æ˜¯ <code>GetType</code> æ–¹æ³•çš„å“ªä¸ªé‡è½½ï¼Œä»¥åŠä¼ é€’çš„æ˜¯ä»€ä¹ˆå‚æ•°)ã€‚ <code>System.Type</code> ç±»å‹æä¾›äº†é™æ€ <code>ReflectionOnlyGetType</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¸ä¸Šä¸€æ¡æåˆ°çš„ <code>GetType</code> æ–¹æ³•åœ¨è¡Œä¸ºä¸Šç›¸ä¼¼ï¼Œåªæ˜¯ç±»å‹ä¼šä»¥ â€œä»…åå°„â€ çš„æ–¹å¼åŠ è½½ï¼Œä¸èƒ½æ‰§è¡Œã€‚ <code>System.TypeInfo</code> ç±»å‹æä¾›äº†å®ä¾‹æˆå‘˜ <code>DeclaredNestedTypes</code> å’Œ <code>GetDeclaredNestedType</code> ã€‚ <code>System.Reflection.Assembly</code> ç±»å‹æä¾›äº†å®ä¾‹æˆå‘˜ <code>GetType</code> ï¼Œ <code>DefinedTypes</code> å’Œ <code>ExportedTypes</code> ã€‚è®¸å¤šç¼–ç¨‹è¯­è¨€éƒ½å…è®¸ä½¿ç”¨ä¸€ä¸ªæ“ä½œç¬¦å¹¶æ ¹æ®ç¼–è¯‘æ—¶å·²çŸ¥çš„ç±»å‹åç§°æ¥è·å¾— <code>Type</code> å¯¹è±¡ã€‚å°½é‡ç”¨è¿™ä¸ªæ“ä½œç¬¦è·å¾— <code>Type</code> å¼•ç”¨ï¼Œè€Œä¸è¦ä½¿ç”¨ä¸Šè¿°åˆ—è¡¨ä¸­çš„ä»»ä½•æ–¹æ³•ï¼Œå› ä¸ºæ“ä½œç¬¦ç”Ÿæˆçš„ä»£ç é€šå¸¸æ›´å¿«ã€‚C# çš„è¿™ä¸ªæ“ä½œç¬¦ç§°ä¸º <code>typeof</code> ï¼Œé€šå¸¸ç”¨å®ƒå°†æ™šæœŸç»‘å®šçš„ç±»å‹ä¿¡æ¯ä¸æ—©æœŸç»‘å®š (ç¼–è¯‘æ—¶å·²çŸ¥) çš„ç±»å‹ä¿¡æ¯è¿›è¡Œæ¯”è¾ƒã€‚ <code>Type</code> å¯¹è±¡æ˜¯è½»é‡çº§çš„å¯¹è±¡å¼•ç”¨ã€‚è¦æ›´å¤šåœ°äº†è§£ç±»å‹æœ¬èº«ï¼Œå¿…é¡»è·å–ä¸€ä¸ª <code>TypeInfo</code> å¯¹è±¡ï¼Œåè€…æ‰ä»£è¡¨ç±»å‹å®šä¹‰ã€‚å¯è°ƒç”¨ <code>System.Reflection.IntrospectionExtensions</code> çš„ <code>GetTypeInfo</code> æ‰©å±•æ–¹æ³•å°† <code>Type</code> å¯¹è±¡è½¬æ¢æˆ <code>TypeInfo</code> å¯¹è±¡ã€‚å¦å¤–ï¼Œè™½ç„¶ä½œç”¨ä¸å¤§ï¼Œä½†è¿˜å¯è°ƒç”¨ <code>TypeInfo</code> çš„ <code>AsType</code> æ–¹æ³•å°† <code>TypeInfo</code> å¯¹è±¡è½¬æ¢æˆ <code>Type</code> å¯¹è±¡ã€‚è·å– <code>TypeInfo</code> å¯¹è±¡ä¼šå¼ºè¿« CLR ç¡®ä¿å·²åŠ è½½ç±»å‹çš„å®šä¹‰ç¨‹åºé›†ï¼Œä»è€Œå¯¹ç±»å‹è¿›è¡Œè§£æã€‚è¿™ä¸ªæ“ä½œå¯èƒ½ä»£ä»·é«˜æ˜‚ã€‚å¦‚æœåªéœ€è¦ç±»å‹å¼•ç”¨ ( <code>Type</code> å¯¹è±¡)ï¼Œå°±åº”é¿å…è¿™ä¸ªæ“ä½œã€‚ä½†ä¸€æ—¦è·å¾—äº† <code>TypeInfo</code> å¯¹è±¡ï¼Œå°±å¯æŸ¥è¯¢ç±»å‹çš„è®¸å¤šå±æ€§è¿›ä¸€æ­¥äº†è§£å®ƒã€‚å¤§å¤šæ•°å±æ€§ï¼Œæ¯”å¦‚ <code>IsPublic</code> ï¼Œ <code>IsSealed</code> ï¼Œ <code>IsAbstract</code> ï¼Œ <code>IsClass</code> å’Œ <code>IsValueType</code> ç­‰ï¼Œéƒ½æŒ‡æ˜äº†ä¸ç±»å‹å…³è”çš„æ ‡å¿—ã€‚å¦ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚ <code>Assembly</code> ï¼Œ <code>AssemblyQualifiedName</code> , <code>FullName</code> å’Œ <code>Module</code> ç­‰ï¼Œåˆ™è¿”å›å®šä¹‰è¯¥ç±»å‹çš„ç¨‹åºé›†æˆ–æ¨¡å—çš„åç§°ä»¥åŠç±»å‹çš„å…¨åã€‚è¿˜å¯æŸ¥è¯¢ <code>BaseType</code> å±æ€§æ¥è·å–å¯¹ç±»å‹çš„åŸºç±»å‹çš„å¼•ç”¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰è®¸å¤šæ–¹æ³•èƒ½æä¾›å…³äºç±»å‹çš„æ›´å¤šä¿¡æ¯ã€‚è·å¾—å¯¹ <code>Type</code> æ´¾ç”Ÿå¯¹è±¡çš„å¼•ç”¨ä¹‹åï¼Œå°±å¯ä»¥æ„é€ è¯¥ç±»å‹çš„å®ä¾‹äº†ã€‚FCL æä¾›äº†ä»¥ä¸‹å‡ ä¸ªæœºåˆ¶ã€‚ <code>Activator</code> ç±»æä¾›äº†é™æ€ <code>CreateInstance</code> æ–¹æ³•çš„å‡ ä¸ªé‡è½½ç‰ˆæœ¬ã€‚è°ƒç”¨æ–¹æ³•æ—¶æ—¢å¯ä¼ é€’ä¸€ä¸ª <code>Type</code> å¯¹è±¡å¼•ç”¨ï¼Œä¹Ÿå¯ä¼ é€’æ ‡è¯†äº†ç±»å‹çš„ <code>String</code> ã€‚ç›´æ¥è·å–ç±»å‹å¯¹è±¡çš„å‡ ä¸ªç‰ˆæœ¬è¾ƒä¸ºç®€å•ã€‚ä½ è¦ä¸ºç±»å‹çš„æ„é€ å™¨ä¼ é€’ä¸€ç»„å®å‚ï¼Œæ–¹æ³•è¿”å›å¯¹æ–°å¯¹è±¡çš„å¼•ç”¨ã€‚ç”¨å­—ç¬¦ä¸²æ¥æŒ‡å®šç±»å‹çš„å‡ ä¸ªç‰ˆæœ¬åˆ™ç¨å¾®å¤æ‚ä¸€äº›ã€‚é¦–å…ˆå¿…é¡»æŒ‡å®šå¦ä¸€ä¸ªå­—ç¬¦ä¸²æ¥æ ‡è¯†å®šä¹‰äº†ç±»å‹çš„ç¨‹åºé›†ã€‚å…¶æ¬¡ï¼Œå¦‚æœæ­£ç¡®åŒ¹é…äº†è¿œç¨‹è®¿é—® (remoting) é€‰é¡¹ï¼Œè¿™äº›æ–¹æ³•è¿˜å…è®¸æ„é€ è¿œç¨‹å¯¹è±¡ã€‚ç¬¬ä¸‰ï¼Œè¿™æ¬¡ç‰ˆæœ¬è¿”å›çš„ä¸æ˜¯å¯¹æ–°å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œæ˜¯ä¸€ä¸ª <code>System.Runtime.Remoting.ObjectHandle</code> å¯¹è±¡ (ä» <code>System.MarshalByRefObject</code> æ´¾ç”Ÿ)ã€‚ <code>ObjectHandle</code> ç±»å‹å…è®¸å°†ä¸€ä¸ª AppDomain ä¸­åˆ›å»ºçš„å¯¹è±¡ä¼ è‡³å…¶ä»– AppDomainï¼ŒæœŸé—´ä¸å¼ºè¿«å¯¹è±¡å…·ä½“åŒ– (materialize)ã€‚å‡†å¤‡å¥½å…·ä½“åŒ–è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œè¯·è°ƒç”¨ <code>ObjectHandle</code> çš„ <code>Unwrap</code> æ–¹æ³•ã€‚åœ¨ä¸€ä¸ª AppDomain ä¸­è°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œå®ƒå°†å®šä¹‰äº†è¦å…·ä½“åŒ–çš„ç±»å‹çš„ç¨‹åºé›†åŠ è½½åˆ°è¿™ä¸ª AppDomain ä¸­ã€‚å¦‚æœå¯¹è±¡æŒ‰å¼•ç”¨å°é€ï¼Œä¼šåˆ›å»ºä»£ç†ç±»å‹å’Œå¯¹è±¡ã€‚å¦‚æœå¯¹è±¡æŒ‰å€¼å°é€ï¼Œå¯¹è±¡çš„å‰¯æœ¬ä¼šè¢«ååºåˆ—åŒ–ã€‚ <code>Activator</code> ç±»è¿˜æä¾›äº†ä¸€ç»„é™æ€ <code>CreateInstanceFrom</code> æ–¹æ³•ã€‚å®ƒä»¬ä¸ <code>CreateInstance</code> çš„è¡Œä¸ºç›¸ä¼¼ï¼Œåªæ˜¯å¿…é¡»é€šè¿‡å­—ç¬¦ä¸²å‚æ•°æ¥æŒ‡å®šç±»å‹åŠå…¶ç¨‹åºé›†ã€‚ç¨‹åºé›†ç”¨ <code>Assembly</code> çš„ <code>LoadFrom</code> (è€Œé Load) æ–¹æ³•åŠ è½½åˆ°è°ƒç”¨ <code>AppDomain</code> ä¸­ã€‚ç”±äºéƒ½ä¸æ¥å— Type å‚æ•°ï¼Œæ‰€ä»¥è¿”å›çš„éƒ½ä¼šä¸€ä¸ª <code>ObjectHandle</code> å¯¹è±¡å¼•ç”¨ï¼Œå¿…é¡»è°ƒç”¨ <code>ObjectHandle</code> çš„ <code>Unwrap</code> æ–¹æ³•è¿›è¡Œå…·ä½“åŒ–ã€‚ <code>AppDomain</code> ç±»å‹æä¾›äº† 4 ä¸ªç”¨äºæ„é€ ç±»å‹å®ä¾‹çš„å®ä¾‹æ–¹æ³• (æ¯ä¸ªéƒ½æœ‰å‡ ä¸ªé‡è½½ç‰ˆæœ¬)ï¼ŒåŒ…æ‹¬ <code>CreateInstance</code> ï¼Œ <code>CreateInstanceAndUnwrap</code> ï¼Œ <code>CreateInstanceFrom</code> å’Œ <code>CreateInstanceFromAndUnwrap</code> ã€‚è¿™äº›æ–¹æ³•çš„è¡Œä¸ºå’Œ <code>Activator</code> ç±»çš„æ–¹æ³•ç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨äºå®ƒä»¬éƒ½æ˜¯å®ä¾‹æ–¹æ³•ï¼Œå…è®¸æŒ‡å®šåœ¨å“ªä¸ª AppDomain ä¸­æ„é€ å¯¹è±¡ã€‚å¦å¤–ï¼Œå¸¦ <code>Unwrap</code> åç¼€çš„æ–¹æ³•è¿˜èƒ½ç®€åŒ–æ“ä½œï¼Œä¸å¿…æ‰§è¡Œé¢å¤–çš„æ–¹æ³•è°ƒç”¨ã€‚ä½¿ç”¨ä¸€ä¸ª <code>Type</code> å¯¹è±¡å¼•ç”¨ï¼Œå¯ä»¥ç»‘å®šåˆ°ä¸€ä¸ªç‰¹å®šçš„æ„é€ å™¨ï¼Œå¹¶è·å–å¯¹æ„é€ å™¨çš„ <code>ConstructorInfo</code> å¯¹è±¡çš„å¼•ç”¨ã€‚ç„¶åï¼Œå¯åˆ©ç”¨ <code>ConstructorInfo</code> å¯¹è±¡å¼•ç”¨æ¥è°ƒç”¨å®ƒçš„ <code>Invoke</code> æ–¹æ³•ã€‚ç±»å‹æ€»æ˜¯åœ¨è°ƒç”¨ AppDomain ä¸­åˆ›å»ºï¼Œè¿”å›çš„æ˜¯å¯¹æ–°å¯¹è±¡çš„å¼•ç”¨ã€‚åˆ©ç”¨å‰é¢åˆ—å‡ºçš„æœºåˆ¶ï¼Œå¯ä¸ºå‡ºæ•°ç»„ ( <code>System.Array</code> æ´¾ç”Ÿç±»å‹) å’Œå§”æ‰˜ ( <code>System.MulticastDelegate</code> æ´¾ç”Ÿç±»å‹) ä¹‹å¤–çš„æ‰€æœ‰ç±»å‹åˆ›å»ºå¯¹è±¡ã€‚åˆ›å»ºæ•°ç»„éœ€è¦è°ƒç”¨ <code>Array</code> çš„é™æ€ <code>CreateInstance</code> æ–¹æ³• (æœ‰å‡ ä¸ªé‡è½½çš„ç‰ˆæœ¬)ã€‚æ‰€æœ‰ç‰ˆæœ¬çš„ <code>CreateInstance</code> æ–¹æ³•è·å–çš„ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯å¯¹æ•°ç»„å…ƒæ•° <code>Type</code> çš„å¼•ç”¨ã€‚ <code>CreateInstance</code> çš„å…¶ä»–å‚æ•°å…è®¸æŒ‡å®šæ•°ç»„ç»´æ•°å’Œä¸Šä¸‹é™çš„å„ç§ç»„åˆã€‚åˆ›å»ºå§”æ‰˜åˆ™è¦è°ƒç”¨ <code>Delegate</code> çš„é™æ€ <code>CreateDelegate</code> æ–¹æ³•ã€‚æ‰€æœ‰ç‰ˆæœ¬çš„ <code>CreateDelegate</code> æ–¹æ³•è·å–çš„ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯å¯¹å§”æ‰˜ <code>Type</code> çš„å¼•ç”¨ã€‚ <code>CreateDelegate</code> æ–¹æ³•çš„å…¶ä»–å‚æ•°å…è®¸æŒ‡å®šåœ¨è°ƒç”¨å®ä¾‹æ–¹æ³•æ—¶åº”å°†å“ªä¸ªå¯¹è±¡ä½œä¸º <code>this</code> å‚æ•°ä¼ é€’ã€‚æ„å»ºå¯æ‰©å±•åº”ç”¨ç¨‹åºæ—¶ï¼Œæ¥å£æ˜¯ä¸­å¿ƒã€‚å¯ç”¨åŸºç±»ä»£æ›¿æ¥å£ï¼Œä½†æ¥å£é€šå¸¸æ˜¯é¦–é€‰çš„ï¼Œå› ä¸ºå®ƒå…è®¸åŠ è½½é¡¹å¼€å‘äººå‘˜é€‰æ‹©ä»–ä»¬è‡ªå·±çš„åŸºç±»ã€‚è·¨ç¨‹åºé›†ä½¿ç”¨ç±»å‹æ—¶ï¼Œéœ€è¦å…³æ³¨ç¨‹åºé›†çš„ç‰ˆæœ¬æ§åˆ¶é—®é¢˜ã€‚è¦èŠ±ä¸€äº›æ—¶é—´ç²¾å¿ƒå»ºæ„ï¼Œå°†è·¨ç¨‹åºé›†é€šä¿¡çš„ç±»å‹éš”ç¦»åˆ°å®ƒä»¬è‡ªå·±çš„ç¨‹åºé›†ä¸­ã€‚è¦é¿å…ä»¥åæ›´æ”¹è¿™äº›ç±»å‹çš„å®šä¹‰ã€‚ä½†æ˜¯ï¼Œå¦‚æœçœŸçš„è¦ä¿®æ”¹ç±»å‹å®šä¹‰ï¼Œä¸€å®šè¦ä¿®æ”¹ç¨‹åºé›†çš„ç‰ˆæœ¬å·ï¼Œå¹¶ä¸ºæ–°ç‰ˆæœ¬çš„ç¨‹åºé›†åˆ›å»ºå‘å¸ƒè€…ç­–ç•¥æ–‡ä»¶ã€‚ä¸ºäº†è·¨ AppDomain è¾¹ç•Œé€šä¿¡ï¼Œå¯å‘Šè¯‰åŠ è½½é¡¹å¼€å‘äººå‘˜ä» <code>MarshalByRefObject</code> æ´¾ç”Ÿå‡ºä»–ä»¬è‡ªå·±çš„åŠ è½½ç±»å‹ã€‚ä½†å¦ä¸€ä¸ªæ›´å¸¸è§çš„åŠæ³•æ˜¯è®©å®¿ä¸»åº”ç”¨ç¨‹åºå®šä¹‰è‡ªå·±çš„ã€ä» <code>MarshalByRefObject</code> æ´¾ç”Ÿçš„å†…éƒ¨ç±»å‹ã€‚æ¯ä¸ª AppDomain åˆ›å»ºå¥½åï¼Œå®¿ä¸»è¦åœ¨æ–° AppDomain ä¸­åˆ›å»ºå®ƒè‡ªå·±çš„ <code>MarshalByRefObject</code> æ´¾ç”Ÿç±»å‹å®ä¾‹ã€‚å®¿ä¸»çš„ä»£ç  (ä½äºé»˜è®¤ AppDomain ä¸­) å°†ä¸å®ƒè‡ªå·±çš„ç±»å‹ (ä½äºå…¶ä»– AppDomain ä¸­) é€šä¿¡ï¼Œè®©åè€…è½½å…¥åŠ è½½é¡¹ç¨‹åºé›†ï¼Œå¹¶åˆ›å»ºå’Œä½¿ç”¨åŠ è½½çš„ç±»å‹çš„å®ä¾‹ã€‚</p><h2 id="using-reflection-to-discover-a-types-members"><a class="anchor" href="#using-reflection-to-discover-a-types-members">#</a> Using Reflection to Discover a Typeâ€™s Members</h2><blockquote><p>So far, this chapter has focused on the parts of reflectionâ€”assembly loading, type discovery, and object constructionâ€”necessary to build a dynamically extensible application. In order to have good performance and compile-time type safety, you want to avoid using reflection as much as possible. In the dynamically extensible application scenario, after an object is constructed, the host code typically casts the object to an interface type or a base class that is known at compile time; this allows the objectâ€™s members to be accessed in a high-performance and compile-time type-safe way.</p></blockquote><blockquote><p>In the remainder of this chapter, Iâ€™m going to focus on some other aspects of reflection that you can use to discover and then invoke a typeâ€™s members. The ability to discover and invoke a typeâ€™s members is typically used to create developer tools and utilities that analyze an assembly by looking for certain programming patterns or uses of certain members. Examples of tools/utilities that do this are ILDasm.exe, FxCopCmd.exe, and Visual Studioâ€™s Windows Forms, Windows Presentation Foundation, and Web Forms designers. In addition, some class libraries use the ability to discover and invoke a typeâ€™s members in order to offer rich functionality as a convenience to developers. Examples of class libraries that do so are serialization/deserialization and simple data binding.</p></blockquote><h3 id="discovering-a-types-members"><a class="anchor" href="#discovering-a-types-members">#</a> Discovering a Typeâ€™s Members</h3><blockquote><p>Fields, constructors, methods, properties, events, and nested types can all be defined as members within a type. The FCL contains a type called System.Reflection.MemberInfo. This class is an abstract base class that encapsulates a bunch of properties common to all type members. Derived from MemberInfo are a bunch of classes; each class encapsulates some more properties related to a specific type member. Figure 23-1 shows the hierarchy of these types.</p></blockquote><p><img data-src="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/image-20221202202124953.png" alt="image-20221202202124953"></p><blockquote><p>The following program demonstrates how to query a typeâ€™s members and display some information about them. This code processes all of the public types defined in all assemblies loaded in the calling AppDomain. For each type, the DeclaredMembers property is called and returns a collection of MemberInfo-derived objects; each object refers to a single member defined within the type. Then, for each member, its kind (field, constructor, method, property, etc.) and its string value (obtained by calling ToString) is shown.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Loop through all assemblies loaded in this AppDomain </span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token class-name">Assembly<span class="token punctuation">[</span><span class="token punctuation">]</span></span> assemblies <span class="token operator">=</span> AppDomain<span class="token punctuation">.</span>CurrentDomain<span class="token punctuation">.</span><span class="token function">GetAssemblies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Assembly</span> a <span class="token keyword">in</span> assemblies<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Assembly: &#123;0&#125;"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// Find Types in the assembly</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Type</span> t <span class="token keyword">in</span> a<span class="token punctuation">.</span>ExportedTypes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Type: &#123;0&#125;"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Discover the type's members</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">MemberInfo</span> mi <span class="token keyword">in</span> t<span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DeclaredMembers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token class-name">String</span> typeName <span class="token operator">=</span> String<span class="token punctuation">.</span>Empty<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>mi <span class="token keyword">is</span> <span class="token class-name">Type</span><span class="token punctuation">)</span> typeName <span class="token operator">=</span> <span class="token string">"(Nested) Type"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>mi <span class="token keyword">is</span> <span class="token class-name">FieldInfo</span><span class="token punctuation">)</span> typeName <span class="token operator">=</span> <span class="token string">"FieldInfo"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>mi <span class="token keyword">is</span> <span class="token class-name">MethodInfo</span><span class="token punctuation">)</span> typeName <span class="token operator">=</span> <span class="token string">"MethodInfo"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>mi <span class="token keyword">is</span> <span class="token class-name">ConstructorInfo</span><span class="token punctuation">)</span> typeName <span class="token operator">=</span> <span class="token string">"ConstructoInfo"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>mi <span class="token keyword">is</span> <span class="token class-name">PropertyInfo</span><span class="token punctuation">)</span> typeName <span class="token operator">=</span> <span class="token string">"PropertyInfo"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>mi <span class="token keyword">is</span> <span class="token class-name">EventInfo</span><span class="token punctuation">)</span> typeName <span class="token operator">=</span> <span class="token string">"EventInfo"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"&#123;0&#125;: &#123;1&#125;"</span><span class="token punctuation">,</span> typeName<span class="token punctuation">,</span> mi<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> indent<span class="token punctuation">,</span> <span class="token class-name">String</span> format<span class="token punctuation">,</span> <span class="token keyword">params</span> <span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="26"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">String</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> indent<span class="token punctuation">)</span> <span class="token operator">+</span> format<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When you compile and run this code, a ton of output is produced. Here is a small sampling of what it looks like.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>Assembly<span class="token punctuation">:</span> mscorlib<span class="token punctuation">,</span> Version<span class="token operator">=</span><span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">,</span> Culture<span class="token operator">=</span>neutral<span class="token punctuation">,</span> PublicKeyToken<span class="token operator">=</span><span class="token class-name">b77a5c561934e089</span></pre></td></tr><tr><td data-num="2"></td><td><pre> Type<span class="token punctuation">:</span> <span class="token class-name">System<span class="token punctuation">.</span>Object</span></pre></td></tr><tr><td data-num="3"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">System<span class="token punctuation">.</span>String</span> <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Equals</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Object<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> Equals<span class="token class-name"><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> System<span class="token punctuation">.</span>Object<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> ReferenceEquals<span class="token class-name"><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> System<span class="token punctuation">.</span>Object<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Int32</span> <span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">System<span class="token punctuation">.</span>Type</span> <span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Void</span> <span class="token function">Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">System<span class="token punctuation">.</span>Object</span> <span class="token function">MemberwiseClone</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Void</span> FieldSetter<span class="token class-name"><span class="token punctuation">(</span>System<span class="token punctuation">.</span>String<span class="token punctuation">,</span> System<span class="token punctuation">.</span>String<span class="token punctuation">,</span> System<span class="token punctuation">.</span>Object<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Void</span> FieldGetter<span class="token class-name"><span class="token punctuation">(</span>System<span class="token punctuation">.</span>String<span class="token punctuation">,</span> System<span class="token punctuation">.</span>String<span class="token punctuation">,</span> System<span class="token punctuation">.</span>Object ByRef<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="13"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">System<span class="token punctuation">.</span>Reflection<span class="token punctuation">.</span>FieldInfo</span> GetFieldInfo<span class="token class-name"><span class="token punctuation">(</span>System<span class="token punctuation">.</span>String<span class="token punctuation">,</span> System<span class="token punctuation">.</span>String<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre> ConstructoInfo<span class="token punctuation">:</span> Void <span class="token punctuation">.</span><span class="token function">ctor</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre> Type<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">.</span>IComparer`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Int32</span> Compare<span class="token class-name"><span class="token punctuation">(</span>T<span class="token punctuation">,</span> T<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="17"></td><td><pre> Type<span class="token punctuation">:</span> <span class="token class-name">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>IEnumerator</span></pre></td></tr><tr><td data-num="18"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> <span class="token function">MoveNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">System<span class="token punctuation">.</span>Object</span> <span class="token function">get_Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Void</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre> PropertyInfo<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Object <span class="token class-name">Current</span></pre></td></tr><tr><td data-num="22"></td><td><pre> Type<span class="token punctuation">:</span> <span class="token class-name">System<span class="token punctuation">.</span>IDisposable</span></pre></td></tr><tr><td data-num="23"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre> Type<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">.</span>IEnumerator`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">T</span> <span class="token function">get_Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre> PropertyInfo<span class="token punctuation">:</span> T <span class="token class-name">Current</span></pre></td></tr><tr><td data-num="27"></td><td><pre> Type<span class="token punctuation">:</span> System<span class="token punctuation">.</span>ArraySegment`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="28"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">get_Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Int32</span> <span class="token function">get_Offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Int32</span> <span class="token function">get_Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Int32</span> <span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Equals</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Object<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Equals</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>ArraySegment`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> <span class="token function">op_Equality</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>ArraySegment`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span> System<span class="token punctuation">.</span>ArraySegment`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> <span class="token function">op_Inequality</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>ArraySegment`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span> System<span class="token punctuation">.</span>ArraySegment`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre> ConstructoInfo<span class="token punctuation">:</span> Void <span class="token punctuation">.</span><span class="token function">ctor</span><span class="token punctuation">(</span>T<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre> ConstructoInfo<span class="token punctuation">:</span> Void <span class="token punctuation">.</span>ctor<span class="token class-name"><span class="token punctuation">(</span>T<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Int32<span class="token punctuation">,</span> Int32<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="38"></td><td><pre> PropertyInfo<span class="token punctuation">:</span> T<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">Array</span></pre></td></tr><tr><td data-num="39"></td><td><pre> PropertyInfo<span class="token punctuation">:</span> Int32 <span class="token class-name">Offset</span></pre></td></tr><tr><td data-num="40"></td><td><pre> PropertyInfo<span class="token punctuation">:</span> Int32 <span class="token class-name">Count</span></pre></td></tr><tr><td data-num="41"></td><td><pre> FieldInfo<span class="token punctuation">:</span> T<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">_array</span></pre></td></tr><tr><td data-num="42"></td><td><pre> FieldInfo<span class="token punctuation">:</span> Int32 _offset</pre></td></tr></table></figure><blockquote><p>Because MemberInfo is the root of the member hierarchy, it makes sense for us to discuss it a bit more. Table 23-1 shows several read-only properties and methods offered by the MemberInfo class. These properties and methods are common to all members of a type. Donâ€™t forget that System. TypeInfo is derived from MemberInfo, and therefore, TypeInfo also offers all of the properties shown in Table 23-1.</p></blockquote><p><img data-src="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/image-20221202202228344.png" alt="image-20221202202228344"></p><blockquote><p>Each element of the collection returned by querying DeclaredMembers is a reference to one of the concrete types in the hierarchy. Although TypeInfoâ€™s DeclaredMembers property returns all of the typeâ€™s members, TypeInfo also offers methods that return specific member types for a specified string name. For example, TypeInfo offers GetDeclaredNestedType, GetDeclaredField, GetDeclaredMethod, GetDeclaredProperty, and GetDeclaredEvent. These methods all return a reference to a TypeInfo object, FieldInfo object, MethodInfo object, PropertyInfo object, or EventInfo object, respectively. There is also a GetDeclaredMethods method that returns a collection of MethodInfo objects describing the methods matching the specified string name.</p></blockquote><blockquote><p>Figure 23-2 summarizes the types used by an application to walk reflectionâ€™s object model. From an AppDomain, you can discover the assemblies loaded into it. From an assembly, you can discover the modules that make it up. From an assembly or a module, you can discover the types that it defines. From a type, you can discover its nested types, fields, constructors, methods, properties, and events. Namespaces are not part of this hierarchy because they are simply syntactical gatherings of types. If you want to list all of the namespaces defined in an assembly, you need to enumerate all of the types in this assembly and take a look at their Namespace property.</p></blockquote><blockquote><p>From a type, it is also possible to discover the interfaces it implements. And from a constructor, method, property accessor method, or event add/remove method, you can call the GetParameters method to obtain an array of ParameterInfo objects, which tells you the types of the memberâ€™s parameters. You can also query the read-only ReturnParameter property to get a ParameterInfo object for detailed information about a memberâ€™s return type. For a generic type or method, you can call the GetGenericArguments method to get the set of type parameters. Finally, for any of these items, you can query the CustomAttributes property to obtain the set of custom attributes applied to them.</p></blockquote><p><img data-src="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/image-20221202202318687.png" alt="image-20221202202318687"></p><h3 id="invoking-a-types-members"><a class="anchor" href="#invoking-a-types-members">#</a> Invoking a Typeâ€™s Members</h3><blockquote><p>Now that you know how to discover the members defined by a type, you may want to invoke one of these members. What invoke means depends on the kind of member being invoked. Table 23-2 shows which method to call for each kind of member to invoke that member.</p></blockquote><p><img data-src="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/image-20221202202419107.png" alt="image-20221202202419107"></p><blockquote><p>The PropertyInfo type represents metadata information about a property (as discussed in Chapter 10, â€œPropertiesâ€); that is, PropertyInfo offers CanRead, CanWrite, and PropertyType read-only properties. These properties indicate whether a property is readable or writeable and what data type the property is. PropertyInfo also has read-only GetMethod and SetMethod properties, which return MethodInfo objects representing the methods that get and set a propertyâ€™s value.</p></blockquote><blockquote><p>PropertyInfoâ€™s GetValue and SetValue methods exist for convenience; internally, they invoke the appropriate MethodInfo object. To support parameterful properties (C# indexers), the GetValue and SetValue methods offer an index parameter of Object[] type.</p></blockquote><blockquote><p>The EventInfo type represents metadata information about an event (as discussed in Chapter 11, â€œEventsâ€). The EventInfo type offers a read-only EventHandlerType property that returns the Type of the eventâ€™s underlying delegate. The EventInfo type also has read-only AddMethod and RemoveMethod properties, which return the MethodInfo objects corresponding to the methods that add or remove a delegate to/from the event. To add or remove a delegate, you can invoke these MethodInfo objects, or you can call EventInfoâ€™s more convenient AddEventHandler and RemoveEventHandler methods.</p></blockquote><blockquote><p>The following sample application demonstrates the various ways to use reflection to access a typeâ€™s members. The SomeType class represents a type that has various members: a private field (m_someField), a public constructor (SomeType) that takes an Int32 argument passed by reference, a public method (ToString), a public property (SomeProp), and a public event (SomeEvent). Having defined the SomeType type, I offer three different methods that use reflection to access SomeTypeâ€™s members. Each method uses reflection in a different way to accomplish the same thing.</p><ul><li><p>The BindToMemberThenInvokeTheMember method demonstrates how to bind to a member and invoke it later.</p></li><li><p>The BindToMemberCreateDelegateToMemberThenInvokeTheMember method demonstrates how to bind to an object or member, and then it creates a delegate that refers to that object or member. Calling through the delegate is very fast, and this technique yields faster performance if you intend to invoke the same member on the same object multiple times.</p></li><li><p>The UseDynamicToBindAndInvokeTheMember method demonstrates how to use C# dynamic primitive type (discussed at the end of Chapter 5, â€œPrimitive, Reference, and Value Typesâ€) to simplify the syntax for accessing members. In addition, this technique can give reasonably good performance if you intend to invoke the same member on different objects that are all of the same type because the binding will happen once per type and be cached so that it can be invoked multiple times quickly. You can also use this technique to invoke a member on objects of different types.</p></li></ul></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>CSharp<span class="token punctuation">.</span>RuntimeBinder</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// This class is used to demonstrate reflection </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// It has a field, constructor, method, property, and an event </span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">SomeType</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">Int32</span> m_someField<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token function">SomeType</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">Int32</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">String</span> <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> m_someField<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> SomeProp <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> m_someField<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">set</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentOutOfRangeException</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> m_someField <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler</span> SomeEvent<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NoCompilerWarnings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> SomeEvent<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token class-name">Type</span> t <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">SomeType</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token function">BindToMemberThenInvokeTheMember</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token function">BindToMemberCreateDelegateToMemberThenInvokeTheMember</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token function">UseDynamicToBindAndInvokeTheMember</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BindToMemberThenInvokeTheMember</span><span class="token punctuation">(</span><span class="token class-name">Type</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"BindToMemberThenInvokeTheMember"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token comment">// Construct an instance</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token class-name">Type</span> ctorArgument <span class="token operator">=</span> Type<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token string">"System.Int32&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// or typeof(Int32).MakeByRefType();</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token class-name">ConstructorInfo</span> ctor <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DeclaredConstructors<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="36"></td><td><pre> c <span class="token operator">=></span> c<span class="token punctuation">.</span><span class="token function">GetParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ParameterType <span class="token operator">==</span> ctorArgument<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">12</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Constructor arguments</span></pre></td></tr><tr><td data-num="38"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"x before constructor called: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token class-name">Object</span> obj <span class="token operator">=</span> ctor<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Type: "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"x after constructor returns: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token comment">// Read and write to a field</span></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token class-name">FieldInfo</span> fi <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredField</span><span class="token punctuation">(</span><span class="token string">"m_someField"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre> fi<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"someField: "</span> <span class="token operator">+</span> fi<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token comment">// Call a method</span></pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token class-name">MethodInfo</span> mi <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"ToString"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre> <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span>mi<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ToString: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre> <span class="token comment">// Read and write a property</span></pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token class-name">PropertyInfo</span> pi <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredProperty</span><span class="token punctuation">(</span><span class="token string">"SomeProp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre> pi<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TargetInvocationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>InnerException<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ArgumentOutOfRangeException</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Property set catch."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre> pi<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"SomeProp: "</span> <span class="token operator">+</span> pi<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre> <span class="token comment">// Add and remove a delegate from the event</span></pre></td></tr><tr><td data-num="62"></td><td><pre> <span class="token class-name">EventInfo</span> ei <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredEvent</span><span class="token punctuation">(</span><span class="token string">"SomeEvent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre> <span class="token class-name">EventHandler</span> eh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EventHandler</span><span class="token punctuation">(</span>EventCallback<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// See ei.EventHandlerType</span></pre></td></tr><tr><td data-num="64"></td><td><pre> ei<span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> eh<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre> ei<span class="token punctuation">.</span><span class="token function">RemoveEventHandler</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> eh<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre> <span class="token comment">// Callback method added to the event</span></pre></td></tr><tr><td data-num="68"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EventCallback</span><span class="token punctuation">(</span><span class="token class-name">Object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BindToMemberCreateDelegateToMemberThenInvokeTheMember</span><span class="token punctuation">(</span><span class="token class-name">Type</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"BindToMemberCreateDelegateToMemberThenInvokeTheMember"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre> <span class="token comment">// Construct an instance (You can't create a delegate to a constructor)</span></pre></td></tr><tr><td data-num="72"></td><td><pre> <span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">12</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Constructor arguments</span></pre></td></tr><tr><td data-num="73"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"x before constructor called: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre> <span class="token class-name">Object</span> obj <span class="token operator">=</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Type: "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"x after constructor returns: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre> <span class="token comment">// NOTE: You can't create a delegate to a field</span></pre></td></tr><tr><td data-num="78"></td><td><pre> <span class="token comment">// Call a method</span></pre></td></tr><tr><td data-num="79"></td><td><pre> <span class="token class-name">MethodInfo</span> mi <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"ToString"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> toString <span class="token operator">=</span> mi<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateDelegate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre> <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ToString: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre> <span class="token comment">// Read and write a property</span></pre></td></tr><tr><td data-num="84"></td><td><pre> <span class="token class-name">PropertyInfo</span> pi <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredProperty</span><span class="token punctuation">(</span><span class="token string">"SomeProp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> setSomeProp <span class="token operator">=</span> pi<span class="token punctuation">.</span>SetMethod<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateDelegate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Action<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre> <span class="token function">setSomeProp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgumentOutOfRangeException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Property set catch."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre> <span class="token function">setSomeProp</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> getSomeProp <span class="token operator">=</span> pi<span class="token punctuation">.</span>GetMethod<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateDelegate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"SomeProp: "</span> <span class="token operator">+</span> <span class="token function">getSomeProp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre> <span class="token comment">// Add and remove a delegate from the event</span></pre></td></tr><tr><td data-num="96"></td><td><pre> <span class="token class-name">EventInfo</span> ei <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredEvent</span><span class="token punctuation">(</span><span class="token string">"SomeEvent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> addSomeEvent <span class="token operator">=</span> ei<span class="token punctuation">.</span>AddMethod<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateDelegate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Action<span class="token punctuation">&lt;</span>EventHandler<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre> <span class="token function">addSomeEvent</span><span class="token punctuation">(</span>EventCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> removeSomeEvent <span class="token operator">=</span> ei<span class="token punctuation">.</span>RemoveMethod<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateDelegate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Action<span class="token punctuation">&lt;</span>EventHandler<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre> <span class="token function">removeSomeEvent</span><span class="token punctuation">(</span>EventCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="102"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UseDynamicToBindAndInvokeTheMember</span><span class="token punctuation">(</span><span class="token class-name">Type</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"UseDynamicToBindAndInvokeTheMember"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre> <span class="token comment">// Construct an instance (You can't use dynamic to call a constructor)</span></pre></td></tr><tr><td data-num="105"></td><td><pre> <span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">12</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Constructor arguments</span></pre></td></tr><tr><td data-num="106"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"x before constructor called: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre> <span class="token class-name"><span class="token keyword">dynamic</span></span> obj <span class="token operator">=</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Type: "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"x after constructor returns: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre> <span class="token comment">// Read and write to a field </span></pre></td></tr><tr><td data-num="111"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="112"></td><td><pre> obj<span class="token punctuation">.</span>m_someField <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre> <span class="token class-name">Int32</span> v <span class="token operator">=</span> <span class="token punctuation">(</span>Int32<span class="token punctuation">)</span>obj<span class="token punctuation">.</span>m_someField<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"someField: "</span> <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="116"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeBinderException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="117"></td><td><pre> <span class="token comment">// We get here because the field is private</span></pre></td></tr><tr><td data-num="118"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Failed to access field: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre> <span class="token comment">// Call a method</span></pre></td></tr><tr><td data-num="121"></td><td><pre> <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ToString: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre> <span class="token comment">// Read and write a property</span></pre></td></tr><tr><td data-num="124"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="125"></td><td><pre> obj<span class="token punctuation">.</span>SomeProp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="127"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgumentOutOfRangeException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="128"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Property set catch."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="130"></td><td><pre> obj<span class="token punctuation">.</span>SomeProp <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre> <span class="token class-name">Int32</span> val <span class="token operator">=</span> <span class="token punctuation">(</span>Int32<span class="token punctuation">)</span>obj<span class="token punctuation">.</span>SomeProp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"SomeProp: "</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre> <span class="token comment">// Add and remove a delegate from the event</span></pre></td></tr><tr><td data-num="134"></td><td><pre> obj<span class="token punctuation">.</span>SomeEvent <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EventHandler</span><span class="token punctuation">(</span>EventCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre> obj<span class="token punctuation">.</span>SomeEvent <span class="token operator">-=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EventHandler</span><span class="token punctuation">(</span>EventCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="136"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ReflectionExtensions</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="139"></td><td><pre> <span class="token comment">// Helper extension method to simplify syntax to create a delegate</span></pre></td></tr><tr><td data-num="140"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">TDelegate</span> <span class="token generic-method"><span class="token function">CreateDelegate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TDelegate<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">MethodInfo</span> mi<span class="token punctuation">,</span> <span class="token class-name">Object</span> target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="141"></td><td><pre> <span class="token keyword">return</span> <span class="token punctuation">(</span>TDelegate<span class="token punctuation">)</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>mi<span class="token punctuation">.</span><span class="token function">CreateDelegate</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TDelegate</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If you build and run this code, youâ€™ll see the following output.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>BindToMemberThenInvokeTheMember</pre></td></tr><tr><td data-num="2"></td><td><pre>x before <span class="token class-name">constructor</span> called<span class="token punctuation">:</span> <span class="token number">12</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Type<span class="token punctuation">:</span> SomeType</pre></td></tr><tr><td data-num="4"></td><td><pre>x after <span class="token class-name">constructor</span> returns<span class="token punctuation">:</span> <span class="token number">24</span></pre></td></tr><tr><td data-num="5"></td><td><pre>someField<span class="token punctuation">:</span> <span class="token number">33</span></pre></td></tr><tr><td data-num="6"></td><td><pre>ToString<span class="token punctuation">:</span> <span class="token number">33</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Property <span class="token keyword">set</span> <span class="token keyword">catch</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="8"></td><td><pre>SomeProp<span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="9"></td><td><pre>BindToMemberCreateDelegateToMemberThenInvokeTheMember</pre></td></tr><tr><td data-num="10"></td><td><pre>x before <span class="token class-name">constructor</span> called<span class="token punctuation">:</span> <span class="token number">12</span></pre></td></tr><tr><td data-num="11"></td><td><pre>Type<span class="token punctuation">:</span> SomeType</pre></td></tr><tr><td data-num="12"></td><td><pre>x after <span class="token class-name">constructor</span> returns<span class="token punctuation">:</span> <span class="token number">24</span></pre></td></tr><tr><td data-num="13"></td><td><pre>ToString<span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="14"></td><td><pre>Property <span class="token keyword">set</span> <span class="token keyword">catch</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="15"></td><td><pre>SomeProp<span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="16"></td><td><pre>UseDynamicToBindAndInvokeTheMember</pre></td></tr><tr><td data-num="17"></td><td><pre>x before <span class="token class-name">constructor</span> called<span class="token punctuation">:</span> <span class="token number">12</span></pre></td></tr><tr><td data-num="18"></td><td><pre>Type<span class="token punctuation">:</span> SomeType</pre></td></tr><tr><td data-num="19"></td><td><pre>x after <span class="token class-name">constructor</span> returns<span class="token punctuation">:</span> <span class="token number">24</span></pre></td></tr><tr><td data-num="20"></td><td><pre>Failed to <span class="token class-name">access</span> field<span class="token punctuation">:</span> 'SomeType<span class="token punctuation">.</span>m_someField' <span class="token keyword">is</span> <span class="token class-name">inaccessible</span> due to its protection <span class="token class-name">level</span></pre></td></tr><tr><td data-num="21"></td><td><pre>ToString<span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="22"></td><td><pre>Property <span class="token keyword">set</span> <span class="token keyword">catch</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="23"></td><td><pre>SomeProp<span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr></table></figure><blockquote><p>Notice that SomeTypeâ€™s constructor takes an Int32 by reference as its only parameter. The previous code shows how to call this constructor and how to examine the modified Int32 value after the constructor returns. Near the top of the BindToMemberThenInvokeTheMember method, I show how to accomplish this by calling Typeâ€™s GetType method passing in a string of &quot;System.Int32&amp;&quot;. The ampersand (&amp;) in the string allows me to identify a parameter passed by reference. This ampersand is part of the Backus-Naur Form grammar for type names, which you can look up in the FCL documentation. The code also shows how to accomplish the same thing using Typeâ€™s MakeByRefType method.</p></blockquote><h3 id="using-binding-handles-to-reduce-your-processs-memory-consumption"><a class="anchor" href="#using-binding-handles-to-reduce-your-processs-memory-consumption">#</a> Using Binding Handles to Reduce Your Processâ€™s Memory Consumption</h3><blockquote><p>Many applications bind to a bunch of types (Type objects) or type members (MemberInfo-derived objects) and save these objects in a collection of some sort. Then later, the application searches the collection for a particular object and then invokes this object. This is a fine way of doing things except for one small issue: Type and MemberInfo-derived objects require a lot of memory. So if an application holds on to too many of these objects and invokes them occasionally, the applicationâ€™s memory consumption increases dramatically, having an adverse effect on the applicationâ€™s performance.</p></blockquote><blockquote><p>Internally, the CLR has a more compact way of representing this information. The CLR creates these objects for our applications only to make things easier for developers. The CLR doesnâ€™t need these big objects itself in order to run. Developers who are saving/caching a lot of Type and MemberInfoderived objects can reduce their working set by using run-time handles instead of objects. The FCL defines three runtime handle types (all defined in the System namespace): RuntimeTypeHandle, RuntimeFieldHandle, and RuntimeMethodHandle. All of these types are value types that contain just one field, an IntPtr; this makes instances of these types cheap (memory-wise). The IntPtr field is a handle that refers to a type, field, or method in an AppDomainâ€™s loader heap. So what you need now is an easy and efficient way to convert a heavyweight Type/MemberInfo object to a lightweight run-time handle instance and vice versa. Fortunately, this is easy using the following conversion methods and properties:</p><ul><li><p>To convert a Type object to a RuntimeTypeHandle, call Typeâ€™s static GetTypeHandle method passing in the reference to the Type object.</p></li><li><p>To convert a RuntimeTypeHandle to a Type object, call Typeâ€™s static GetTypeFromHandle method passing in the RuntimeTypeHandle.</p></li><li><p>To convert a FieldInfo object to a RuntimeFieldHandle, query FieldInfoâ€™s instance read-only FieldHandle property.</p></li><li><p>To convert a RuntimeFieldHandle to a FieldInfo object, call FieldInfoâ€™s static GetFieldFromHandle method.</p></li><li><p>To convert a MethodInfo object to a RuntimeMethodHandle, query MethodInfoâ€™s instance read-only MethodHandle property.</p></li><li><p>To convert a RuntimeMethodHandle to a MethodInfo object, call MethodInfoâ€™s static GetMethodFromHandle method.</p></li></ul></blockquote><blockquote><p>The following program sample acquires a lot of MethodInfo objects, converts them to RuntimeMethodHandle instances, and shows the working set difference.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name">BindingFlags</span> c_bf <span class="token operator">=</span> BindingFlags<span class="token punctuation">.</span>FlattenHierarchy <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>Instance <span class="token operator">|</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> BindingFlags<span class="token punctuation">.</span>Static <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>Public <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>NonPublic<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Show size of heap before doing any reflection stuff</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"Before doing anything"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Build cache of MethodInfo objects for all methods in MSCorlib.dll</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">List<span class="token punctuation">&lt;</span>MethodBase<span class="token punctuation">></span></span> methodInfos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>MethodBase<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Type</span> t <span class="token keyword">in</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Object</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">.</span><span class="token function">GetExportedTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// Skip over any generic types</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>IsGenericTypeDefinition<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token class-name">MethodBase<span class="token punctuation">[</span><span class="token punctuation">]</span></span> mb <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">GetMethods</span><span class="token punctuation">(</span>c_bf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> methodInfos<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>mb<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token comment">// Show number of methods and size of heap after binding to all methods</span></pre></td></tr><tr><td data-num="19"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"# of methods=&#123;0:N0&#125;"</span><span class="token punctuation">,</span> methodInfos<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"After building cache of MethodInfo objects"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token comment">// Build cache of RuntimeMethodHandles for all MethodInfo objects</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token class-name">List<span class="token punctuation">&lt;</span>RuntimeMethodHandle<span class="token punctuation">></span></span> methodHandles <span class="token operator">=</span> </pre></td></tr><tr><td data-num="23"></td><td><pre> methodInfos<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConvertAll</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RuntimeMethodHandle<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>mb <span class="token operator">=></span> mb<span class="token punctuation">.</span>MethodHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"Holding MethodInfo and RuntimeMethodHandle cache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> GC<span class="token punctuation">.</span><span class="token function">KeepAlive</span><span class="token punctuation">(</span>methodInfos<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Prevent cache from being GC'd early</span></pre></td></tr><tr><td data-num="26"></td><td><pre> methodInfos <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Allow cache to be GC'd now</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"After freeing MethodInfo objects"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre> methodInfos <span class="token operator">=</span> methodHandles<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConvertAll</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MethodBase<span class="token punctuation">></span></span></span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="29"></td><td><pre> rmh<span class="token operator">=></span> MethodBase<span class="token punctuation">.</span><span class="token function">GetMethodFromHandle</span><span class="token punctuation">(</span>rmh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"Size of heap after re-creating MethodInfo objects"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre> GC<span class="token punctuation">.</span><span class="token function">KeepAlive</span><span class="token punctuation">(</span>methodHandles<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Prevent cache from being GC'd early</span></pre></td></tr><tr><td data-num="32"></td><td><pre> GC<span class="token punctuation">.</span><span class="token function">KeepAlive</span><span class="token punctuation">(</span>methodInfos<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Prevent cache from being GC'd early</span></pre></td></tr><tr><td data-num="33"></td><td><pre> methodHandles <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Allow cache to be GC'd now</span></pre></td></tr><tr><td data-num="34"></td><td><pre> methodInfos <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Allow cache to be GC'd now</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"After freeing MethodInfos and RuntimeMethodHandles"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When I compiled and executed this program, I got the following output.</p></blockquote><pre><code class="language-cmd">Heap size= 85,000 - Before doing anything
# of methods=48,467
Heap size= 7,065,632 - After building cache of MethodInfo objects
Heap size= 7,453,496 - Holding MethodInfo and RuntimeMethodHandle cache
Heap size= 6,732,704 - After freeing MethodInfo objects
Heap size= 7,372,704 - Size of heap after re-creating MethodInfo objects
Heap size= 192,232 - After freeing MethodInfos and RuntimeMethodHandles

</code></pre><p>ğŸ’¡å°ç»“ï¼šå­—æ®µã€æ„é€ å™¨ã€æ–¹æ³•ã€å±æ€§ã€äº‹ä»¶å’ŒåµŒå¥—ç±»å‹éƒ½å¯ä»¥å®šä¹‰æˆç±»å‹çš„æˆå‘˜ã€‚FCL åŒ…å«æŠ½è±¡åŸºç±» <code>System.Reflection.MemberInfo</code> ï¼Œå°è£…äº†æ‰€æœ‰ç±»å‹æˆå‘˜éƒ½é€šç”¨çš„ä¸€ç»„å±æ€§ã€‚ <code>MemberInfo</code> æœ‰è®¸å¤šæ´¾ç”Ÿç±»ï¼Œæ¯ä¸ªéƒ½å°è£…äº†ä¸ç‰¹å®šç±»å‹æˆå‘˜ç›¸å…³çš„æ›´å¤šå±æ€§ã€‚ç”±äº <code>MemberInfo</code> ç±»æ˜¯æˆå‘˜å±‚æ¬¡ç»“æ„çš„æ ¹ï¼Œæ‰€ä»¥æœ‰å¿…è¦æ›´æ·±å…¥åœ°ç ”ç©¶ä¸€ä¸‹å®ƒï¼Œå®ƒæä¾›çš„å±æ€§å’Œæ–¹æ³•æ˜¯ä¸€ä¸ªç±»å‹çš„æ‰€æœ‰æˆå‘˜éƒ½é€šç”¨çš„ã€‚ä¸è¦å¿˜äº† <code>System.TypeInfo</code> ä» <code>MemberInfo</code> æ´¾ç”Ÿã€‚åœ¨æŸ¥è¯¢ <code>DeclaredMemebers</code> å±æ€§æ‰€è¿”å›çš„é›†åˆä¸­ï¼Œæ¯ä¸ªå…ƒç´ éƒ½ä¼šå¯¹å±‚æ¬¡ç»“æ„ä¸­çš„ä¸€ä¸ªå…·ä½“ç±»å‹çš„å¼•ç”¨ã€‚è™½ç„¶ <code>TypeInfo</code> çš„ <code>DeclaredMembers</code> å±æ€§èƒ½è¿”å›ç±»å‹çš„æ‰€æœ‰æˆå‘˜ï¼Œä½†è¿˜å¯åˆ©ç”¨ <code>TypeInfo</code> æä¾›çš„ä¸€äº›æ–¹æ³•è¿”å›å…·æœ‰æŒ‡å®šå­—ç¬¦ä¸²åç§°çš„æˆå‘˜ç±»å‹ã€‚ä¾‹å¦‚ï¼Œåˆ©ç”¨ <code>TypeInfo</code> çš„ <code>GetDeclaredNestedType</code> ï¼Œ <code>GetDeclaredField</code> ï¼Œ <code>GetDeclaredMethod</code> ï¼Œ <code>GetDeclaredProperty</code> å’Œ <code>GetDeclaredEvent</code> æ–¹æ³•ï¼Œå¯åˆ†åˆ«è¿”å›ä¸€ä¸ª <code>TypeInfo</code> ã€ <code>FieldInfo</code> ã€ <code>MethodInfo</code> ã€ <code>PropertyInfo</code> å’Œ <code>EventInfo</code> å¯¹è±¡å¼•ç”¨ã€‚è€Œåˆ©ç”¨ <code>GetDeclaredMethods</code> æ–¹æ³•èƒ½è¿”å›ç”± <code>MethodInfo</code> å¯¹è±¡æ„æˆçš„é›†åˆï¼Œè¿™äº›å¯¹è±¡æè¿°äº†å’ŒæŒ‡å®šå­—ç¬¦ä¸²åç§°åŒ¹é…çš„ä¸€ä¸ª (å¤šä¸ª) æ–¹æ³•ã€‚åŸºäº AppDomainï¼Œå¯å‘ç°å…¶ä¸­åŠ è½½çš„æ‰€æœ‰ç¨‹åºé›†ã€‚åŸºäºç¨‹åºé›†ï¼Œå¯å‘ç°æ„æˆå®ƒçš„æ‰€æœ‰æ¨¡å—ã€‚åŸºäºç¨‹åºé›†æˆ–æ¨¡å—ï¼Œå¯å‘ç°å®ƒå®šä¹‰çš„æ‰€æœ‰ç±»å‹ã€‚åŸºäºç±»å‹ï¼Œå¯å‘ç°å®ƒçš„åµŒå¥—ç±»å‹ã€å­—æ®µã€æ„é€ å™¨ã€æ–¹æ³•ã€å±æ€§å’Œäº‹ä»¶ã€‚å‘½åç©ºé—´ä¸æ˜¯è¿™ä¸ªå±‚æ¬¡ç»“æ„çš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯ä»è¯­æ³•è§’åº¦å°†ç›¸å…³ç±»å‹èšé›†åˆ°ä¸€èµ·ã€‚CLR ä¸çŸ¥é“ä»€ä¹ˆæ˜¯å‘½åç©ºé—´ã€‚è¦åˆ—å‡ºç¨‹åºé›†ä¸­å®šä¹‰çš„æ‰€æœ‰å‘½åç©ºé—´ï¼Œéœ€æšä¸¾ç¨‹åºé›†ä¸­çš„æ‰€æœ‰ç±»å‹ï¼Œå¹¶æŸ¥çœ‹å…¶ <code>Namespace</code> å±æ€§ã€‚åŸºäºä¸€ä¸ªç±»å‹ï¼Œè¿˜å¯å‘ç°å®ƒå®ç°çš„æ¥å£ã€‚åŸºäºæ„é€ å™¨ã€æ–¹æ³•ã€å±æ€§è®¿é—®å™¨æ–¹æ³•æˆ–è€…äº‹ä»¶çš„æ·»åŠ  / åˆ é™¤æ–¹æ³•ï¼Œå¯è°ƒç”¨ <code>GetParameters</code> æ–¹æ³•æ¥è·å–ç”± <code>ParameterInfo</code> å¯¹è±¡æ„æˆçš„æ•°ç»„ï¼Œä»è€Œäº†è§£æˆå‘˜çš„å‚æ•°çš„ç±»å‹ã€‚è¿˜å¯æŸ¥è¯¢åªè¯»å±æ€§ <code>ReturnParameter</code> è·å¾—ä¸€ä¸ª <code>ParameterInfo</code> å¯¹è±¡ï¼Œå®ƒè¯¦ç»†æè¿°äº†æˆå‘˜çš„è¿”å›ç±»å‹ã€‚å¯¹äºæ³›å‹ç±»å‹æˆ–æ–¹æ³•ï¼Œå¯è°ƒç”¨ <code>GetGenericArguments</code> æ–¹æ³•æ¥è·å¾—ç±»å‹å‚æ•°çš„é›†åˆã€‚æœ€åï¼Œé’ˆå¯¹ä¸Šè¿°ä»»ä½•ä¸€é¡¹ï¼Œéƒ½å¯æŸ¥è¯¢ <code>CustomAttributes</code> å±æ€§æ¥è·å¾—åº”ç”¨äºå®ƒä»¬çš„è‡ªå®šä¹‰å®šåˆ¶ç‰¹æ€§çš„é›†åˆã€‚å‘ç°ç±»å‹å®šä¹‰çš„æˆå‘˜åå¯è°ƒç”¨å®ƒä»¬ã€‚â€œè°ƒç”¨â€(invoke) çš„ç¡®åˆ‡å«ä¹‰å–å†³äºè¦è°ƒç”¨çš„æˆå‘˜çš„ç§ç±»ã€‚ <code>PropertyInfo</code> ç±»å‹ä»£è¡¨ä¸å±æ€§æœ‰å…³çš„å…ƒæ•°æ®ä¿¡æ¯ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œ <code>PropertyInfo</code> æä¾›äº† <code>CanRead</code> ã€ <code>CanWrite</code> ã€å’Œ <code>PropertyType</code> åªè¯»å±æ€§ï¼Œå®ƒä»¬æŒ‡å‡ºå±æ€§æ˜¯å¦å¯è¯»å’Œå¯å†™ï¼Œä»¥åŠå±æ€§çš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆã€‚ <code>PropertyInfo</code> è¿˜æä¾›äº†åªè¯» <code>GetMethod</code> å’Œ <code>SetMethod</code> å±æ€§ï¼Œå®ƒä»¬è¿”å›ä»£è¡¨å±æ€§ <code>get</code> å’Œ <code>set</code> è®¿é—®å™¨æ–¹æ³•çš„ <code>MethodInfo</code> å¯¹è±¡ã€‚ <code>PropertyInfo</code> çš„ <code>GetValue</code> å’Œ <code>SetValue</code> æ–¹æ³•åªæ˜¯ä¸ºäº†æä¾›æ–¹æ³•ï¼›åœ¨å†…éƒ¨ï¼Œå®ƒä»¬ä¼šè‡ªå·±è°ƒç”¨åˆé€‚çš„ <code>MethodInfo</code> å¯¹è±¡ã€‚ä¸ºäº†æ”¯æŒæœ‰å‚å±æ€§ (C# çš„ç´¢å¼•å™¨)ï¼Œ <code>GetValue</code> å’Œ <code>SetValue</code> æ–¹æ³•æä¾›äº†ä¸€ä¸ª <code>Object[]</code> ç±»å‹çš„ <code>index</code> å‚æ•°ã€‚ <code>EventInfo</code> ç±»å‹ä»£è¡¨ä¸äº‹ä»¶æœ‰å…³çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚ <code>EventInfo</code> ç±»å‹æä¾›äº†åªè¯» <code>EventHandlerType</code> å±æ€§ï¼Œè¿”å›äº‹ä»¶çš„åŸºç¡€å§”æ‰˜çš„ <code>Type</code> ã€‚ <code>EventInfo</code> ç±»å‹è¿˜æä¾›äº†åªè¯» <code>AddMethod</code> å’Œ <code>RemoveMethod</code> å±æ€§ï¼Œè¿”å›ä¸ºäº‹ä»¶å¢åˆ å§”æ‰˜çš„æ–¹æ³•çš„ <code>MethodInfo</code> å¯¹è±¡ã€‚å¢åˆ å§”æ‰˜å¯è°ƒç”¨è¿™äº› <code>MethodInfo</code> å¯¹è±¡ï¼Œä¹Ÿå¯è°ƒç”¨ <code>EventInfo</code> ç±»å‹æä¾›çš„æ›´å¥½ç”¨çš„ <code>AddEventHandler</code> å’Œ <code>RemoveEventHandler</code> æ–¹æ³•ã€‚è®¸å¤šåº”ç”¨ç¨‹åºéƒ½ç»‘å®šäº†ä¸€ç»„ç±»å‹ ( <code>Type</code> å¯¹è±¡) æˆ–ç±»å‹æˆå‘˜ ( <code>MemeberInfo</code> æ´¾ç”Ÿå¯¹è±¡)ï¼Œå¹¶å°†è¿™äº›å¯¹è±¡ä¿å­˜åœ¨æŸç§å½¢å¼çš„é›†åˆä¸­ã€‚ä»¥åï¼Œåº”ç”¨ç¨‹åºæœç´¢è¿™ä¸ªé›†åˆï¼ŒæŸ¥æ‰¾ç‰¹å®šå¯¹è±¡ï¼Œç„¶åè°ƒç”¨ (invoke) è¿™ä¸ªå¯¹è±¡ã€‚è¿™ä¸ªæœºåˆ¶å¾ˆå¥½ï¼Œåªæ˜¯æœ‰ä¸ªå°é—®é¢˜ï¼š <code>Type</code> å’Œ <code>MemberInfo</code> æ´¾ç”Ÿå¯¹è±¡éœ€è¦å¤§é‡å†…å­˜ã€‚æ‰€ä»¥ï¼Œå¦‚æœåº”ç”¨ç¨‹åºå®¹çº³äº†å¤ªå¤šè¿™æ ·çš„å¯¹è±¡ï¼Œä½†åªæ˜¯å¶å°”è°ƒç”¨ï¼Œåº”ç”¨ç¨‹åºæ¶ˆè€—çš„å†…å­˜å°±ä¼šæ€¥å‰§å¢åŠ ï¼Œå¯¹åº”ç”¨ç¨‹åºçš„æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ã€‚CLR å†…éƒ¨ç”¨æ›´ç²¾ç®€çš„æ–¹å¼è¡¨ç¤ºè¿™ç§ä¿¡æ¯ã€‚CLR ä¹‹æ‰€ä»¥ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºè¿™äº›å¯¹è±¡ï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿å¼€å‘äººå‘˜ã€‚CLR ä¸éœ€è¦è¿™äº›å¤§å¯¹è±¡å°±èƒ½è¿è¡Œã€‚å¦‚æœéœ€è¦ä¿å­˜ / ç¼“å­˜å¤§é‡ <code>Type</code> å’Œ <code>MemberInfo</code> æ´¾ç”Ÿå¯¹è±¡ï¼Œå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨è¿è¡Œæ—¶å¥æŸ„ (runtime handle) ä»£æ›¿å¯¹è±¡ä»¥å‡å°å·¥ä½œé›† (å ç”¨çš„å†…å­˜)ã€‚FCL å®šä¹‰äº†ä¸‰ä¸ªè¿è¡Œæ—¶å¥æŸ„ (å…¨éƒ¨éƒ½åœ¨ <code>System</code> å‘½åç©ºé—´ä¸­)ï¼ŒåŒ…æ‹¬ <code>RuntimeTypeHandle</code> ï¼Œ <code>RuntimeFieldHandle</code> å’Œ <code>RuntimeMethodHandle</code> ã€‚ä¸‰ä¸ªç±»å‹éƒ½æ˜¯å€¼ç±»å‹ï¼Œéƒ½åªåŒ…å«ä¸€ä¸ªå­—æ®µï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª <code>IntPtr</code> ï¼›è¿™ä½¿ç±»å‹çš„å®ä¾‹æ˜¾å¾—ç›¸å½“ç²¾ç®€ (ç›¸å½“çœå†…å­˜)ã€‚ <code>IntPtr</code> å­—æ®µæ˜¯ä¸€ä¸ªå¥æŸ„ï¼Œå¼•ç”¨äº† AppDomain çš„ Loader å †ä¸­çš„ä¸€ä¸ªç±»å‹ã€å­—æ®µæˆ–æ–¹æ³•ã€‚å› æ­¤ï¼Œç°åœ¨éœ€è¦ä»¥ä¸€ç§ç®€å•ã€é«˜æ•ˆçš„æ–¹å¼å°†é‡é‡çº§çš„ <code>Type</code> æˆ– <code>MemberInfo</code> å¯¹è±¡è½¬æ¢ä¸ºè½»é‡çº§çš„è¿è¡Œæ—¶å¥æŸ„å®ä¾‹ï¼Œåä¹‹äº¦ç„¶ã€‚å¹¸å¥½ï¼Œä½¿ç”¨ä»¥ä¸‹è½¬æ¢æ–¹æ³•å’Œå±æ€§å¯è½»æ¾è¾¾åˆ°ç›®çš„ã€‚è¦å°† Type å¯¹è±¡è½¬æ¢ä¸ºä¸€ä¸ª <code>RuntimeTypeHandle</code> ï¼Œè°ƒç”¨ <code>Type</code> çš„é™æ€ <code>GetTypeHandle</code> æ–¹æ³•å¹¶ä¼ é€’é‚£ä¸ª <code>Type</code> å¯¹è±¡å¼•ç”¨ã€‚è¦å°†ä¸€ä¸ª <code>RuntimeTypeHandle</code> è½¬æ¢ä¸º <code>Type</code> å¯¹è±¡ï¼Œè°ƒç”¨ <code>Type</code> çš„é™æ€æ–¹æ³• <code>GetTypeFromHandle</code> ï¼Œå¹¶ä¼ é€’é‚£ä¸ª <code>RuntimeTypeHandle</code> ã€‚è¦å°† <code>FieldInfo</code> å¯¹è±¡è½¬æ¢ä¸ºä¸€ä¸ª <code>RuntimeFieldHandle</code> ï¼ŒæŸ¥è¯¢ <code>FieldInfo</code> çš„å®ä¾‹åªè¯»å±æ€§ <code>FieldHandle</code> ã€‚è¦å°†ä¸€ä¸ª <code>RuntimeFieldHandle</code> è½¬æ¢ä¸º <code>FieldInfo</code> å¯¹è±¡ï¼Œè°ƒç”¨ <code>FieldInfo</code> çš„é™æ€æ–¹æ³• <code>GetFieldFromHandle</code> ã€‚è¦å°† <code>MethodInfo</code> å¯¹è±¡è½¬æ¢ä¸ºä¸€ä¸ª <code>RuntimeMethodHandle</code> ï¼ŒæŸ¥è¯¢ <code>MethodInfo</code> çš„å®ä¾‹åªè¯»å±æ€§ <code>MethodHandle</code> ã€‚è¦å°†ä¸€ä¸ª <code>RuntimeMethodHandle</code> è½¬æ¢ä¸ºä¸€ä¸ª <code>MethodInfo</code> å¯¹è±¡ï¼Œè°ƒç”¨ MethodInfo çš„é™æ€æ–¹æ³• <code>GetMethodFromHandle</code> ã€‚</p><div class="tags"><a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag"><i class="ic i-tag"></i> è¯»ä¹¦ç¬”è®°</a> <a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C#</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2022-12-05 14:45:57" itemprop="dateModified" datetime="2022-12-05T14:45:57+08:00">2022-12-05</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(ï¿£â–½ï¿£)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Sakupinera WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/images/alipay.png" alt="Sakupinera Alipay"><p>Alipay</p></div><div><img data-src="/images/paypal.png" alt="Sakupinera PayPal"><p>PayPal</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Sakupinera <i class="ic i-at"><em>@</em></i>Sakupinera</li><li class="link"><strong>Post link: </strong><a href="http://sakupinera.github.io/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/" title="CLR via C# - Chapter 23 Assembly Loading and Reflection">http://sakupinera.github.io/2022/11/29/csharp/clr-via-csharp/Chapter 23 Assembly Loading and Reflection/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/11/28/csharp/clr-via-csharp/Chapter%2022%20CLR%20Hosting%20and%20AppDomains/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;03&#x2F;08&#x2F;Z2usRnE64TXN1Lp.jpg" title="CLR via C# - Chapter 22 CLR Hosting and AppDomains"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 22 CLR Hosting and AppDomains</h3></a></div><div class="item right"><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;03&#x2F;08&#x2F;mOQfkxXNYp8VGng.png" title="CLR via C# - Chapter 24 Runtime Serialization"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 24 Runtime Serialization</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#chapter-23-assembly-loading-and-reflection"><span class="toc-number">1.</span> <span class="toc-text">Chapter 23 Assembly Loading and Reflection</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#assembly-loading"><span class="toc-number">1.1.</span> <span class="toc-text">Assembly Loading</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#using-reflection-to-build-a-dynamically-extensible-application"><span class="toc-number">1.2.</span> <span class="toc-text">Using Reflection to Build a Dynamically Extensible Application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reflection-performance"><span class="toc-number">1.3.</span> <span class="toc-text">Reflection Performance</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#discovering-types-defined-in-an-assembly"><span class="toc-number">1.3.1.</span> <span class="toc-text">Discovering Types Defined in an Assembly</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#what-exactly-is-a-type-object"><span class="toc-number">1.3.2.</span> <span class="toc-text">What Exactly Is a Type Object?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#building-a-hierarchy-of-exception-derived-types"><span class="toc-number">1.3.3.</span> <span class="toc-text">Building a Hierarchy of Exception-Derived Types</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructing-an-instance-of-a-type"><span class="toc-number">1.3.4.</span> <span class="toc-text">Constructing an Instance of a Type</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#designing-an-application-that-supports-add-ins"><span class="toc-number">1.4.</span> <span class="toc-text">Designing an Application That Supports Add-Ins</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#using-reflection-to-discover-a-types-members"><span class="toc-number">1.5.</span> <span class="toc-text">Using Reflection to Discover a Typeâ€™s Members</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#discovering-a-types-members"><span class="toc-number">1.5.1.</span> <span class="toc-text">Discovering a Typeâ€™s Members</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#invoking-a-types-members"><span class="toc-number">1.5.2.</span> <span class="toc-text">Invoking a Typeâ€™s Members</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#using-binding-handles-to-reduce-your-processs-memory-consumption"><span class="toc-number">1.5.3.</span> <span class="toc-text">Using Binding Handles to Reduce Your Processâ€™s Memory Consumption</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%201%20The%20CLR%E2%80%99s%20Execution%20Model/" rel="bookmark" title="CLR via C# - Chapter 1 The CLRâ€™s Execution Model">CLR via C# - Chapter 1 The CLRâ€™s Execution Model</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%202%20Building,%20Packaging,%20Deploying,%20and%20Administering%20Applications%20and%20Types/" rel="bookmark" title="CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types">CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%203%20Shared%20Assemblies%20and%20Strongly%20Named%20Assemblies/" rel="bookmark" title="CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies">CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies</a></li><li><a href="/2022/09/27/csharp/clr-via-csharp/Chapter%204%20Type%20Fundamentals/" rel="bookmark" title="CLR via C# - Chapter 4 Type Fundamentals">CLR via C# - Chapter 4 Type Fundamentals</a></li><li><a href="/2022/10/15/csharp/clr-via-csharp/Chapter%205%20Primitive,%20Reference,%20and%20Value%20%20Types/" rel="bookmark" title="CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals">CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals</a></li><li><a href="/2022/10/21/csharp/clr-via-csharp/Chapter%206%20Type%20and%20Member%20Basics/" rel="bookmark" title="CLR via C# - Chapter 6 Type and Member Basics">CLR via C# - Chapter 6 Type and Member Basics</a></li><li><a href="/2022/10/24/csharp/clr-via-csharp/Chapter%207%20Constants%20and%20Fields/" rel="bookmark" title="CLR via C# - Chapter 7 Constants and Fields">CLR via C# - Chapter 7 Constants and Fields</a></li><li><a href="/2022/10/25/csharp/clr-via-csharp/Chapter%208%20Methods/" rel="bookmark" title="CLR via C# - Chapter 8 Methods">CLR via C# - Chapter 8 Methods</a></li><li><a href="/2022/10/27/csharp/clr-via-csharp/Chapter%209%20Parameters/" rel="bookmark" title="CLR via C# - Chapter 9 Parameters">CLR via C# - Chapter 9 Parameters</a></li><li><a href="/2022/10/28/csharp/clr-via-csharp/Chapter%2010%20Properties/" rel="bookmark" title="CLR via C# - Chapter 10 Properties">CLR via C# - Chapter 10 Properties</a></li><li><a href="/2022/10/29/csharp/clr-via-csharp/Chapter%2011%20Events/" rel="bookmark" title="CLR via C# - Chapter 11 Events">CLR via C# - Chapter 11 Events</a></li><li><a href="/2022/11/02/csharp/clr-via-csharp/Chapter%2012%20Generics/" rel="bookmark" title="CLR via C# - Chapter 12 Generics">CLR via C# - Chapter 12 Generics</a></li><li><a href="/2022/11/04/csharp/clr-via-csharp/Chapter%2013%20Interfaces/" rel="bookmark" title="CLR via C# - Chapter 13 Interfaces">CLR via C# - Chapter 13 Interfaces</a></li><li><a href="/2022/11/16/csharp/clr-via-csharp/Chapter%2014%20Chars,%20Strings,%20and%20Working%20%20with%20Text/" rel="bookmark" title="CLR via C# - Chapter 14 Chars, Strings, and Working with Text">CLR via C# - Chapter 14 Chars, Strings, and Working with Text</a></li><li><a href="/2022/11/17/csharp/clr-via-csharp/Chapter%2015%20Enumerated%20Types%20and%20Bit%20Flags/" rel="bookmark" title="CLR via C# - Chapter 15 Enumerated Types and Bit Flags">CLR via C# - Chapter 15 Enumerated Types and Bit Flags</a></li><li><a href="/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/" rel="bookmark" title="CLR via C# - Chapter 16 Arrays">CLR via C# - Chapter 16 Arrays</a></li><li><a href="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/" rel="bookmark" title="CLR via C# - Chapter 17 Delegates">CLR via C# - Chapter 17 Delegates</a></li><li><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" rel="bookmark" title="CLR via C# - Chapter 18 Custom Attributes">CLR via C# - Chapter 18 Custom Attributes</a></li><li><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" rel="bookmark" title="CLR via C# - Chapter 19 Nullable Value Types">CLR via C# - Chapter 19 Nullable Value Types</a></li><li><a href="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/" rel="bookmark" title="CLR via C# - Chapter 20 Exceptions and State Management">CLR via C# - Chapter 20 Exceptions and State Management</a></li><li><a href="/2022/11/27/csharp/clr-via-csharp/Chapter%2021%20The%20Managed%20Heap%20and%20Garbage%20%20Collection/" rel="bookmark" title="CLR via C# - Chapter 21 The Managed Heap and Garbage  Collection">CLR via C# - Chapter 21 The Managed Heap and Garbage Collection</a></li><li><a href="/2022/11/28/csharp/clr-via-csharp/Chapter%2022%20CLR%20Hosting%20and%20AppDomains/" rel="bookmark" title="CLR via C# - Chapter 22 CLR Hosting and AppDomains">CLR via C# - Chapter 22 CLR Hosting and AppDomains</a></li><li class="active"><a href="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/" rel="bookmark" title="CLR via C# - Chapter 23 Assembly Loading and Reflection">CLR via C# - Chapter 23 Assembly Loading and Reflection</a></li><li><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" rel="bookmark" title="CLR via C# - Chapter 24 Runtime Serialization">CLR via C# - Chapter 24 Runtime Serialization</a></li><li><a href="/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/" rel="bookmark" title="CLR via C# - Chapter 25 Interoperating with WinRT Components">CLR via C# - Chapter 25 Interoperating with WinRT Components</a></li><li><a href="/2023/02/06/csharp/clr-via-csharp/Chapter%2026%20Thread%20Basics/" rel="bookmark" title="CLR via C# - Chapter 26 Thread Basics">CLR via C# - Chapter 26 Thread Basics</a></li><li><a href="/2023/02/07/csharp/clr-via-csharp/Chapter%2027%20Compute-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations">CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations</a></li><li><a href="/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 28 IO-Bound Asynchronous Operations">CLR via C# - Chapter 28 IO-Bound Asynchronous Operations</a></li><li><a href="/2023/02/09/csharp/clr-via-csharp/Chapter%2029%20Primitive%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 29 Primitive Thread Synchronization">CLR via C# - Chapter 29 Primitive Thread Synchronization</a></li><li><a href="/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 30 Hybrid Thread Synchronization">CLR via C# - Chapter 30 Hybrid Thread Synchronization</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Sakupinera" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Sakupinera</p><div class="description" itemprop="description">ä¿æŒä½ çš„å†³å¿ƒï¼</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">86</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">13</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">6</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Nha3VwaW5lcmE=" title="https:&#x2F;&#x2F;github.com&#x2F;sakupinera"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9zYWt1cGluZXJh" title="https:&#x2F;&#x2F;twitter.com&#x2F;sakupinera"><i class="ic i-twitter"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTQwNzIyOTA3MQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;407229071"><i class="ic i-cloud-music"></i></span> <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMjIzMDczOTg/c3BtX2lkX2Zyb209MzMzLjEwMDcuMC4w" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;22307398?spm_id_from&#x3D;333.1007.0.0"><i class="ic i-bilibili"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/games/" rel="section"><i class="ic i-flag"></i>Games</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-person"></i>About</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/11/28/csharp/clr-via-csharp/Chapter%2022%20CLR%20Hosting%20and%20AppDomains/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/GAMES101/" title="In GAMES101">GAMES101</a></div><span><a href="/2022/10/14/computer-graphics/games101/%E6%9D%90%E8%B4%A8%E4%B8%8E%E5%A4%96%E8%A7%82/" title="GAMES101 - Materials and Appearancesï¼ˆæè´¨ä¸å¤–è§‚ï¼‰">GAMES101 - Materials and Appearancesï¼ˆæè´¨ä¸å¤–è§‚ï¼‰</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/09/05/linux/learn-linux/Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86/" title="LearnLinux - Linuxç³»ç»Ÿç®¡ç†">LearnLinux - Linuxç³»ç»Ÿç®¡ç†</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" title="CLR via C# - Chapter 19 Nullable Value Types">CLR via C# - Chapter 19 Nullable Value Types</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/10/15/csharp/clr-via-csharp/Chapter%205%20Primitive,%20Reference,%20and%20Value%20%20Types/" title="CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals">CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%203%20Shared%20Assemblies%20and%20Strongly%20Named%20Assemblies/" title="CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies">CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/09/04/linux/learn-linux/Shell%E7%BC%96%E7%A8%8B/" title="LearnLinux - Shellç¼–ç¨‹">LearnLinux - Shellç¼–ç¨‹</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/GAMES101/" title="In GAMES101">GAMES101</a></div><span><a href="/2022/10/31/computer-graphics/games101/%E7%9B%B8%E6%9C%BA%EF%BC%8C%E9%80%8F%E9%95%9C%E5%92%8C%E5%85%89%E5%9C%BA/" title="GAMES101 - Cameras, Lenses and Light Fieldsï¼ˆç›¸æœºï¼Œé€é•œå’Œå…‰åœºï¼‰">GAMES101 - Cameras, Lenses and Light Fieldsï¼ˆç›¸æœºï¼Œé€é•œå’Œå…‰åœºï¼‰</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2023/01/05/cpp/cpp-primer/Chapter%2013%20Copy%20Control/" title="C++ Primer - Chapter 13 Copy Control">C++ Primer - Chapter 13 Copy Control</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/GAMES101/" title="In GAMES101">GAMES101</a></div><span><a href="/2022/09/06/computer-graphics/games101/%E5%90%91%E9%87%8F%E5%92%8C%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/" title="GAMES101 - å‘é‡å’Œçº¿æ€§ä»£æ•°">GAMES101 - å‘é‡å’Œçº¿æ€§ä»£æ•°</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" title="CLR via C# - Chapter 18 Custom Attributes">CLR via C# - Chapter 18 Custom Attributes</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 â€“ <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Sakupinera @ Hanamai Sora</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">2.2m words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">33:30</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/11/29/csharp/clr-via-csharp/Chapter 23 Assembly Loading and Reflection/",favicon:{show:"ï¼ˆâ—Â´3ï½€â—ï¼‰Goooood",hide:"(Â´Ğ”ï½€)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/assets/shifuku.model.json"},display:{position:"left",width:250,height:500},mobile:{show:!1},react:{opacity:.9},log:!1})</script></body></html>