<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Sakupinera" href="http://sakupinera.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Sakupinera" href="http://sakupinera.github.io/atom.xml"><link rel="alternate" type="application/json" title="Sakupinera" href="http://sakupinera.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="读书笔记,C#"><link rel="canonical" href="http://sakupinera.github.io/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/"><title>CLR via C# - Chapter 23 Assembly Loading and Reflection - CLR-via-CSharp - CSharp | Hanamai Sora = Sakupinera</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">CLR via C# - Chapter 23 Assembly Loading and Reflection</h1><div class="meta"><span class="item" title="Created: 2022-11-29 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2022-11-29T00:00:00+08:00">2022-11-29</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>62k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>56 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Hanamai Sora</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://s2.loli.net/2023/03/08/r1VBTR45h8jQWZA.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/W1a6ViLoBQPTj2C.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/Z2usRnE64TXN1Lp.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/R9PEJQ54o7HMAis.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/dhkXYZz7ENHoCeL.png"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/hr2Sybs5CRvjFdI.png"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/" itemprop="item" rel="index" title="In CSharp"><span itemprop="name">CSharp</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/CLR-via-CSharp/" itemprop="item" rel="index" title="In CLR-via-CSharp"><span itemprop="name">CLR-via-CSharp</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="http://sakupinera.github.io/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Sakupinera"><meta itemprop="description" content=", 保持你的决心！"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sakupinera"></span><div class="body md" itemprop="articleBody"><h1 id="chapter-23-assembly-loading-and-reflection"><a class="anchor" href="#chapter-23-assembly-loading-and-reflection">#</a> Chapter 23 Assembly Loading and Reflection</h1><h2 id="assembly-loading"><a class="anchor" href="#assembly-loading">#</a> Assembly Loading</h2><blockquote><p>As you know, when the just-in-time (JIT) compiler compiles the Intermediate Language (IL) for a method, it sees what types are referenced in the IL code. Then at run time, the JIT compiler uses the assembly’s TypeRef and AssemblyRef metadata tables to determine what assembly defines the type being referenced. The AssemblyRef metadata table entry contains all of the parts that make up the strong name of the assembly. The JIT compiler grabs all of these parts—name (without extension or path), version, culture, and public key token—concatenates them into a string, and then attempts to load an assembly matching this identity into the AppDomain (assuming that it’s not already loaded). If the assembly being loaded is weakly named, the identity is just the name of the assembly (no version, culture, or public key token information).</p></blockquote><blockquote><p>Internally, the CLR attempts to load this assembly by using the System.Reflection.Assembly class’s static Load method. This method is publicly documented, and you can call it to explicitly load an assembly into your AppDomain. This method is the CLR equivalent of Win32’s LoadLibrary function. There are actually several overloaded versions of Assembly’s Load method. Here are the prototypes of the more commonly used overloads.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Assembly</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Assembly</span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token class-name">AssemblyName</span> assemblyRef<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Assembly</span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token class-name">String</span> assemblyString<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Less commonly used overloads of Load are not shown </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Internally, Load causes the CLR to apply a version-binding redirection policy to the assembly and looks for the assembly in the global assembly cache (GAC), followed by the application’s base directory, private path subdirectories, and codebase locations. If you call Load by passing a weakly named assembly, Load doesn’t apply a version-binding redirection policy to the assembly, and the CLR won’t look in the GAC for the assembly. If Load finds the specified assembly, it returns a reference to an Assembly object that represents the loaded assembly. If Load fails to find the specified assembly, it throws a System.IO.FileNotFoundException.</p></blockquote><p>💡注意：一些极罕见的情况可能需要加载为特定 CPU 架构生成的程序集。这时在指定程序集的标识时，还可包括一个进程架构部分。例如，假定 GAC 中同时包含了一个程序集的 IL 中立版本和 x86 专用版本，CLR 会默认选择 x86 专用版本 (参见 第 3 章 “共享程序集和强命名程序集”)。但是，为了强迫 CLR 加载 IL 中立的版本，可以向 <code>Assembly</code> 的 <code>Load</code> 方法传递以下字符串：</p><p><code>&quot;SomeAssembly, Version=2.0.0.0, Culture=neutral, PublicKeyToken=01234567890abcde, ProcessorArchitecture=MSIL&quot;</code></p><p>CLR 目前允许 <code>ProcessorArchitecture</code> 取 5 个值之一： <code>MSIL</code> (Microsoft IL)、 <code>X86</code> 、 <code>IA64</code> ， <code>AMD64</code> 以及 <code>Arm</code> 。</p><p>💡重要提示：一些开发人员可能注意到 <code>System.AppDomain</code> 提供了 <code>Load</code> 方法。和 <code>Assembly</code> 的静态 <code>Load</code> 方法不同， <code>AppDomain</code> 的 <code>Load</code> 是实例方法，它允许将程序集加载到指定的 AppDomain 中。该方法设计由非托管调用，允许宿主将程序集 “注入” 特定 AppDomain 中。托管代码的开发人员一般情况下不应调用它，因为调用 <code>AppDomain</code> 的 <code>Load</code> 方法时需要传递一个标识了程序集的字符串。该方法随后会应用策略，并在一些常规位置搜索程序集。我们知道，AppDomain 关联了一些告诉 CLR 如何查找程序集的设置。为了加载这个程序集，CLR 将使用与指定 AppDomain 关联的设置，而非与发出调用之 AppDomain 关联的设置。</p><p>但 <code>AppDomain</code> 的 <code>Load</code> 方法会返回对程序集的引用。由于 <code>System.Assembly</code> 类不是从 <code>System.MarshalByRefObject</code> 派生的，所以程序集对象必须按值封送回发出调用的那个 AppDomain。但是，现在 CLR 就会用发出调用的那个 AppDomain 的设置来定位并加载程序集。如果使用发出调用的那个 AppDomain 的策略和搜索位置找不到指定的程序集，就会抛出一个 <code>FileNotFoundException</code> 。 这个行为一般不是你所期望的，所以应该避免使用 <code>AppDomain</code> 的 <code>Load</code> 方法。</p><blockquote><p>In most dynamically extensible applications, Assembly’s Load method is the preferred way of loading an assembly into an AppDomain. However, it does require that you have all of the pieces that make up an assembly’s identity. Frequently, developers write tools or utilities (such as ILDasm.exe, PEVerify.exe, CorFlags.exe, GACUtil.exe, SGen.exe, SN.exe, XSD.exe) that perform some kind of processing on an assembly. All of these tools take a command-line argument that refers to the path name of an assembly file (including file extension).</p></blockquote><blockquote><p>To load an assembly specifying a path name, you call Assembly’s LoadFrom method.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Assembly</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Assembly</span> <span class="token function">LoadFrom</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// Less commonly used overloads of LoadFrom are not shown </span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Internally, LoadFrom first calls System.Reflection.AssemblyName’s static GetAssemblyName method, which opens the specified file, finds the AssemblyDef metadata table’s entry, and extracts the assembly identity information and returns it in a System.Reflection.AssemblyName object (the file is also closed). Then, LoadFrom internally calls Assembly’s Load method, passing it the AssemblyName object. At this point, the CLR applies a version-binding redirection policy and searches the various locations looking for a matching assembly. If Load finds the assembly, it will load it, and an Assembly object that represents the loaded assembly will be returned; LoadFrom returns this value. If Load fails to find an assembly, LoadFrom loads the assembly at the path name specified in LoadFrom’s argument. Of course, if an assembly with the same identity is already loaded, LoadFrom simply returns an Assembly object that represents the already loaded assembly.</p></blockquote><blockquote><p>By the way, the LoadFrom method allows you to pass a URL as the argument. Here is an example.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Assembly</span> a <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">LoadFrom</span><span class="token punctuation">(</span><span class="token string">@"http://Wintellect.com/SomeAssembly.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>When you pass an Internet location, the CLR downloads the file, installs it into the user’s download cache, and loads the file from there. Note that you must be online or an exception will be thrown. However, if the file has been downloaded previously, and if Windows Internet Explorer has been set to work offline (see Internet Explorer’s Work Offline menu item in its File menu), the previously downloaded file will be used, and no exception will be thrown. You can also call UnsafeLoadFrom, which can load a web-downloaded assembly, bypassing some security checks.</p></blockquote><p>💡重要提示：一台机器可能同时存在具有相同标识的多个程序集。由于 <code>LoadFrom</code> 会在内部调用 <code>Load</code> ，所以 CLR 有可能不是加载你指定的文件，而是加载一个不同的文件，从而造成非预期的行为。强烈建议每次生成程序集时都更改版本号，确保每个版本都有自己的唯一性标识，确保 <code>LoadFrom</code> 方法的行为符合预期。</p><blockquote><p>Microsoft Visual Studio’s UI designers and other tools typically use Assembly’s LoadFile method. This method can load an assembly from any path and can be used to load an assembly with the same identity multiple times into a single AppDomain. This can happen as changes to an application’s UI are made in the designer/tool and the user rebuilds the assembly. When loading an assembly via LoadFile, the CLR will not resolve any dependencies automatically; your code must register with AppDomain’s AssemblyResolve event and have your event callback method explicitly load any dependent assemblies.</p></blockquote><blockquote><p>If you are building a tool that simply analyzes an assembly’s metadata via reflection (as discussed later in this chapter), and you want to ensure that none of the code contained inside the assembly executes, the best way for you to load an assembly is to use Assembly’s ReflectionOnlyLoadFrom method, or in some rarer cases, Assembly’s ReflectionOnlyLoad method. Here are the prototypes of both methods.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Assembly</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Assembly</span> <span class="token function">ReflectionOnlyLoadFrom</span><span class="token punctuation">(</span><span class="token class-name">String</span> assemblyFile<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Assembly</span> <span class="token function">ReflectionOnlyLoad</span><span class="token punctuation">(</span><span class="token class-name">String</span> assemblyString<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Less commonly used overload of ReflectionOnlyLoad is not shown </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The ReflectionOnlyLoadFrom method will load the file specified by the path; the strongname identity of the file is not obtained, and the file is not searched for in the GAC or elsewhere. The ReflectionOnlyLoad method will search for the specified assembly looking in the GAC, application base directory, private paths, and codebases. However, unlike the Load method, the ReflectionOnlyLoad method does not apply versioning policies, so you will get the exact version that you specify. If you want to apply versioning policy yourself to an assembly identity, you can pass the string into AppDomain’s ApplyPolicy method.</p></blockquote><blockquote><p>When an assembly is loaded with ReflectionOnlyLoadFrom or ReflectionOnlyLoad, the CLR forbids any code in the assembly from executing; any attempt to execute code in an assembly loaded with either of these methods causes the CLR to throw an InvalidOperationException. These methods allow a tool to load an assembly that was delay-signed, would normally require security permissions that prevent it from loading, or was created for a different CPU architecture.</p></blockquote><blockquote><p>Frequently, when using reflection to analyze an assembly loaded with one of these two methods, the code will have to register a callback method with AppDomain’s ReflectionOnlyAssemblyResolve event to manually load any referenced assemblies (calling AppDomain’s ApplyPolicy method, if desired); the CLR doesn’t do it automatically for you. When the callback method is invoked, it must call Assembly’s ReflectionOnlyLoadFrom or ReflectionOnlyLoad method to explicitly load a referenced assembly and return a reference to this assembly.</p></blockquote><p>💡注意：经常有人问到程序集卸载的问题。遗憾的是，CLR 不提供卸载单独程序集的能力。如果 CLR 允许这样做，那么一旦线程从某个方法返回至已卸载的一个程序集中的代码，如果允许应用程序以这样的一种方式崩溃，就和它的设计初衷背道而驰了。卸载程序集必须卸载包含它的整个 AppDomain。这方面的详情已在第 22 章 “CLR 寄宿和 AppDomain” 进行了讨论。</p><p>使用 <code>ReflectionOnlyLoadFrom</code> 或 <code>ReflectionOnlyLoad</code> 方法加载的程序集表面上是可以卸载的。毕竟，这些程序集中的代码是不允许执行的。但 CLR 一样不允许执行的。但 CLR 一样不允许卸载用这两个方法加载的程序集。因为用这两个方法加载了程序集之后，仍然可以利用反射来创建对象，以便引用这些程序集中定义的元数据。如果卸载程序集，就必须通过某种方式使这些对象，以便引用这些程序集中定义的元数据。仍然可以利用反射来创建对象，以便引用这些程序集中定义的元数据。如果卸载程序集，就必须通过某种方式使这些对象失效。无论是实现的复杂性，还是执行速度，跟踪这些对象的状态都是得不偿失的。</p><blockquote><p>Many applications consist of an EXE file that depends on many DLL files. When deploying this application, all the files must be deployed. However, there is a technique that you can use to deploy just a single EXE file. First, identify all the DLL files that your EXE file depends on that do not ship as part of the Microsoft .NET Framework itself. Then add these DLLs to your Visual Studio project. For each DLL file you add, display its properties and change its Build Action to Embedded Resource. This causes the C# compiler to embed the DLL file(s) into your EXE file, and you can deploy this one EXE file.</p></blockquote><blockquote><p>At run time, the CLR won’t be able to find the dependent DLL assemblies, which is a problem. To fix this, when your application initializes, register a callback method with the AppDomain’s ResolveAssembly event. The callback method’s code should look something like the following.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Assembly</span> <span class="token function">ResolveEventHandler</span><span class="token punctuation">(</span><span class="token class-name">Object</span> sender<span class="token punctuation">,</span> <span class="token class-name">ResolveEventArgs</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name">String</span> dllName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AssemblyName</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">.</span>Name <span class="token operator">+</span> <span class="token string">".dll"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> assem <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">GetExecutingAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name">String</span> resourceName <span class="token operator">=</span> assem<span class="token punctuation">.</span><span class="token function">GetManifestResourceNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>rn <span class="token operator">=></span> </pre></td></tr><tr><td data-num="5"></td><td><pre>rn<span class="token punctuation">.</span><span class="token function">EndsWith</span><span class="token punctuation">(</span>dllName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Not found, maybe another handler will find it</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> stream <span class="token operator">=</span> assem<span class="token punctuation">.</span><span class="token function">GetManifestResourceStream</span><span class="token punctuation">(</span>resourceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> assemblyData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Byte</span><span class="token punctuation">[</span>stream<span class="token punctuation">.</span>Length<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> stream<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>assemblyData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> assemblyData<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">return</span> Assembly<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>assemblyData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Now, the first time a thread calls a method that references a type in a dependent DLL file, the AssemblyResolve event will be raised and the preceding callback code will find the embedded DLL resource desired and load it by calling an overload of Assembly’s Load method that takes a Byte[] as an argument. Although I love the technique of embedding dependent DLLs inside another assembly, you should be aware that this does increase the memory used by your application at run time.</p></blockquote><p>💡小结：JIT 编译器将方法的 IL 代码编译成本机代码时，会查看 IL 代码中引用了哪些类型。在运行时，JIT 编译器利用程序集的 TypeRef 和 AssemblyRef 元数据表来确定哪一个程序集定义了所引用的类型。在 AssemblyRef 元数据表的记录项中，包含了构成程序集强名称的各个部分。JIT 编译器尝试将与该标识匹配的程序集加载到 AppDomain 中 (如果还没有加载的话)。如果被加载的程序集是弱命名的，那么标识中就只包含程序集的名称 (不包含版本、语言文化及公钥标记信息)。在内部，CLR 使用 <code>System.Reflection.Assembly</code> 类的静态 <code>Load</code> 方法尝试加载这个程序集。该方法在 .NET Framework SDK 文档中是公开的，可调用它显式地将程序集加载到 AppDomain 中。该方法是 CLR 的与 Win32 <code>LoadLibrary</code> 函数等价的方法。在内部， <code>Load</code> 导致 CLR 向程序集应用一个版本绑定重定向策略，并在 GAC (全局程序集缓存) 中查找程序集。如果没找到，就接着去应用程序的基目录、私有路径子目录和 <code>codebase</code> 位置查找。如果调用 <code>Load</code> 时传递的是弱命名程序集， <code>Load</code> 就不会向程序集应用版本绑定重定向策略，CLR 也不会去 GAC 查找程序集。如果 <code>Load</code> 找到指定的程序集，会返回对代表已加载的那个程序集的一个 <code>Assembly</code> 对象的引用。如果 <code>Load</code> 没有找到指定程序集，会抛出一个 <code>System.IO.FileNotFoundException</code> 异常。调用 <code>Assembly</code> 的 <code>LoadFrom</code> 方法可以加载指定了路径名的程序集。在内部 <code>LoadFrom</code> 首先调用 <code>System.Refection.AssemblyName</code> 类的静态 <code>GetAssemblyName</code> 方法，该方法打开指定的文件，找到 <code>AssemblyRef</code> 元数据表的记录项，提取程序集标识信息，然后以一个 <code>System.Reflection.AssemblyName</code> 对象的形式返回这些信息 (文件同时会关闭)。随后， <code>LoadFrom</code> 方法在内部调用 <code>Assembly</code> 的 <code>Load</code> 方法，将 <code>AssemblyName</code> 对象传给它。然后，CLR 应用版本绑定重定向策略，并在各个位置查找匹配的程序集。 <code>Load</code> 找到匹配程序集会加载它，并返回代表已加载程序集的 <code>Assembly</code> 对象； <code>LoadFrom</code> 方法将返回这个值。如果 <code>Load</code> 没有找到匹配的程序集， <code>LoadFrom</code> 会加载通过 <code>LoadFrom</code> 的实参传递的路径中的程序集。当然，如果已加载了具有相同标识的程序集， <code>LoadFrom</code> 方法就会直接返回代表已加载程序集的 <code>Assembly</code> 对象。Microsoft Visual Studio 的 UI 设计人员和其他工具一般用的是 <code>Assembly</code> 的 <code>LoadFile</code> 方法。这个方法可从任意路径加载程序集，而且可以将具有相同标识的程序集多次加载到一个 AppDomain 中。在设计器 / 工具中对应用程序的 UI 进行了修改，而且用户重新生成了程序集时，便有可能发生这种情况。通过 <code>LoadFile</code> 加载程序集时，CLR 不会自动解析任何依赖性问题；你的代码必须向 <code>AppDomain</code> 的 <code>AssemblyResolve</code> 事件登记，并让事件回调方法显式地加载任何依赖的程序集。果你构建的一个工具只想通过反射 (本章稍后进行讨论) 来分析程序集的元数据，并希望确保程序集中的任何代码都不会执行，那么加载程序集的最佳方式就是使用 <code>Assembly</code> 的 <code>ReflectionOnlyLoadFrom</code> 方法或者使用 <code>Assembly</code> 的 <code>ReflectionOnlyLoad</code> 方法 (后者比较少见)。 <code>ReflectionOnlyLoadFrom</code> 方法加载由路径指定的文件；文件的强名称标识不会获取，也不会在 GAC 和其他位置搜索文件。 <code>ReflectionOnlyLoad</code> 方法会在 GAC、应用程序基目录、私有路径和 <code>codebase</code> 指定的位置搜索指定的程序集。但和 <code>Load</code> 方法不同的是， <code>ReflectionOnlyLoad</code> 方法不会应用版本控制策略，所以你指定的是哪个版本，获得的就是哪个版本。要自行向程序集标识应用版本控制策略，可将字符串传给 <code>AppDomain</code> 的 <code>ApplyPolicy</code> 方法。用 <code>ReflectionOnlyLoadFrom</code> 或 <code>ReflectionOnlyLoad</code> 方法加载程序集时，CLR 禁止程序集中的任何代码执行；试图执行由这两个方法加载的程序集中的代码，会导致 CLR 抛出一个 <code>InvalidOperationException</code> 异常。这两个方法允许工具加载延迟签名的程序集，这种程序集正常情况下会因为安全权限不够而无法加载。另外，这种程序集也可能是为不同的 CPU 架构而创建的。利用反射来分析由这两个方法之一加载的程序集时，代码经常需要向 <code>AppDomain</code> 的 <code>ReflectionOnlyAssemblyResolve</code> 事件注册一个回调方法，以便手动加载任何引用的程序集 (如果必要，还需要调用 <code>AppDomain</code> 的 <code>ApplyPolicy</code> 方法)；CLR 不会自动帮你做这个事情。回调方法被调用 (invoke) 时，它必须调用 (call) <code>Assembly</code> 的 <code>ReflectionOnlyLoadFrom</code> 或 <code>ReflectionOnlyLoad</code> 方法来显式加载引用的程序集，并返回对该程序集的引用。在运行时，CLR 会找不到依赖的 DLL 程序集。为了解决这个问题，当应用程序初始化时，可以向 <code>AppDomain</code> 的 <code>ResolveAssembly</code> 事件登记一个回调方法。</p><h2 id="using-reflection-to-build-a-dynamically-extensible-application"><a class="anchor" href="#using-reflection-to-build-a-dynamically-extensible-application">#</a> Using Reflection to Build a Dynamically Extensible Application</h2><blockquote><p>As you know, metadata is stored in a bunch of tables. When you build an assembly or a module, the compiler that you’re using creates a type definition table, a field definition table, a method definition table, and so on. The System.Reflection namespace contains several types that allow you to write code that reflects over (or parses) these metadata tables. In effect, the types in this namespace offer an object model over the metadata contained in an assembly or a module.</p></blockquote><blockquote><p>Using these object model types, you can easily enumerate all of the types in a type definition metadata table. Then for each type, you can obtain its base type, the interfaces it implements, and the flags that are associated with the type. Additional types in the System.Reflection namespace allow you to query the type’s fields, methods, properties, and events by parsing the corresponding metadata tables. You can also discover any custom attributes (covered in Chapter 18, “Custom Attributes”) that have been applied to any of the metadata entities. There are even classes that let you determine referenced assemblies and methods that return the IL byte stream for a method. With all of this information, you could easily build a tool very similar to Microsoft’s ILDasm.exe.</p></blockquote><p>💡注意：有的反射类型及其成员时专门由 CLR 编译器的开发人员使用的。应用程序的开发人员一般用不着。FCL 文档没有明确指出哪些类型和成员供编译器开发人员 (而非应用程序开发人员) 使用，但只要意识到有些反射类型及其成员不适合所有人使用，该文档时就会更清醒一些。</p><blockquote><p>In reality, very few applications will have the need to use the reflection types. Reflection is typically used by class libraries that need to understand a type’s definition in order to provide some rich functionality. For example, the FCL’s serialization mechanism (discussed in Chapter 24, “Runtime Serialization”) uses reflection to determine what fields a type defines. The serialization formatter can then obtain the values of these fields and write them into a byte stream that is used for sending across the Internet, saving to a file, or copying to the clipboard. Similarly, Visual Studio’s designers use reflection to determine which properties should be shown to developers when laying out controls on their Web Forms or Windows Forms at design time.</p></blockquote><blockquote><p>Reflection is also used when an application needs to load a specific type from a specific assembly at run time to accomplish some task. For example, an application might ask the user to provide the name of an assembly and a type. The application could then explicitly load the assembly, construct an instance of the type, and call methods defined in the type. This usage is conceptually similar to calling Win32’s LoadLibrary and GetProcAddress functions. Binding to types and calling methods in this way is frequently referred to as late binding. (Early binding is when the types and methods used by an application are determined at compile time.)</p></blockquote><p>💡小结：元数据是用一系列表来存储的。生成程序集或模块时，编译器会创建一个类型定义表、一个字段定义表、一个方法定义表以及其他表。利用 <code>System.Reflection</code> 命名空间中的其他类型，可以写代码来反射 (或者说” 解析 “) 这些元数据表。实际上，这个命名空间中类型为程序集或模块中包含的元数据提供了一个对象模型。利用对象模型中的类型，可以轻松枚举类型定义元数据表中的所有类型，而针对每个类型都可获取它的基类型、它实现的接口以及与类型关联的标志 (flag)。利用 <code>System.Reflection</code> 命名空间中的其他类型，还可解析对应的元数据表来查询类型的字段、方法、属性和事件。还可发现应用于任何元数据实体的定制特性 (详情参见第 18 章” 定制特性 “)。甚至有些类允许判断引用的程序集；还有一些方法能返回一个方法的 IL 字节流。事实上，只有极少数应用程序才需使用反射类型。如果类库需要理解类型的定义才能提供丰富的功能，就适合使用反射。在运行时，当应用程序需要从特定程序集中加载特定类型以执行特定任务时，也要使用反射。例如，应用程序可要求用户提供程序集和类别名。然后，应用程序可显式加载程序集，构造类型的实例，再调用类型中定义的方法。这种用法在概念上类似于调用 Win32 <code>LoadLibrary</code> 和 <code>GetProcAddress</code> 函数。以这种用法在概念上类似于调用 Win32 <code>LoadLibrary</code> 和 <code>GetProAddress</code> 函数。以这种方式绑定到类型并调用方法称为晚期绑定。(对应的，早期绑定是指在编译时就确定应用程序要使用的类型和方法。)</p><h2 id="reflection-performance"><a class="anchor" href="#reflection-performance">#</a> Reflection Performance</h2><blockquote><p>Reflection is an extremely powerful mechanism because it allows you to discover and use types and members at run time that you did not know about at compile time. This power does come with two main drawbacks:</p><ul><li><p>Reflection prevents type safety at compile time. Because reflection uses strings heavily, you lose type safety at compile time. For example, if you call Type.GetType(&quot;int&quot;); to ask reflection to find a type called “int”, the code compiles but returns null at run time because the CLR knows the “int” type as “System.Int32”.</p></li><li><p>Reflection is slow. When using reflection, the names of types and their members are not known at compile time; you discover them at run time by using a string name to identify each type and member. This means that reflection is constantly performing string searches as the types in the System.Reflection namespace scan through an assembly’s metadata. Often, the string searches are case-insensitive comparisons, which can slow this down even more.</p></li></ul></blockquote><blockquote><p>Invoking a member by using reflection will also hurt performance. When using reflection to invoke a method, you must first package the arguments into an array; internally, reflection must unpack these on to the thread’s stack. Also, the CLR must check that the arguments are of the correct data type before invoking a method. Finally, the CLR ensures that the caller has the proper security permission to access the member being invoked.</p></blockquote><blockquote><p>For all of these reasons, it’s best to avoid using reflection to access a field or invoke a method/ property. If you’re writing an application that will dynamically discover and construct type instances, you should take one of the following approaches:</p><ul><li><p>Have the types derive from a base type that is known at compile time. At run time, construct an instance of the derived type, place the reference in a variable that is of the base type (by way of a cast), and call virtual methods defined by the base type.</p></li><li><p>Have the type implement an interface that is known at compile time. At run time, construct an instance of the type, place the reference in a variable that is of the interface type (by way of a cast), and call the methods defined by the interface.</p></li></ul></blockquote><blockquote><p>I tend to prefer using the interface technique over the base type technique because the base type technique doesn’t allow the developer to choose the base type that works best in a particular situation. Although the base type technique works better in versioning scenarios, because you could always add a member to the base type and the derived types just inherit it; you can’t add a member to an interface without forcing all types that implement the interface to modify their code and recompile it.</p></blockquote><blockquote><p>When you use either of these two techniques, I strongly suggest that the interface or base type be defined in its own assembly. This will reduce versioning issues. For more information about how to do this, see the section titled “Designing an Application That Supports Add-Ins” later in this chapter.</p></blockquote><h3 id="discovering-types-defined-in-an-assembly"><a class="anchor" href="#discovering-types-defined-in-an-assembly">#</a> Discovering Types Defined in an Assembly</h3><blockquote><p>Reflection is frequently used to determine what types an assembly defines. The FCL offers many APIs to get this information. By far, the most commonly used API is Assembly’s ExportedTypes. property. Here is an example of code that loads an assembly and shows the names of all of the publicly exported types defined in it.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token class-name">String</span> dataAssembly <span class="token operator">=</span> <span class="token string">"System.Data, version=4.0.0.0, "</span> <span class="token operator">+</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token string">"culture=neutral, PublicKeyToken=b77a5c561934e089"</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token function">LoadAssemAndShowPublicTypes</span><span class="token punctuation">(</span>dataAssembly<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LoadAssemAndShowPublicTypes</span><span class="token punctuation">(</span><span class="token class-name">String</span> assemId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Explicitly load an assembly in to this AppDomain </span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">Assembly</span> a <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>assemId<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Execute this loop once for each Type </span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// publicly-exported from the loaded assembly </span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Type</span> t <span class="token keyword">in</span> a<span class="token punctuation">.</span>ExportedTypes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token comment">// Display the full name of the type </span></pre></td></tr><tr><td data-num="16"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>FullName<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="what-exactly-is-a-type-object"><a class="anchor" href="#what-exactly-is-a-type-object">#</a> What Exactly Is a Type Object?</h3><blockquote><p>Notice that the previous code iterates over a sequence of System.Type objects. The System.Type type is your starting point for doing type and object manipulations. A System.Type object represents a type reference (as opposed to a type definition).</p></blockquote><blockquote><p>Recall that System.Object defines a public, nonvirtual instance method named GetType. When you call this method, the CLR determines the specified object’s type and returns a reference to its Type object. Because there is only one Type object per type in an AppDomain, you can use equality and inequality operators to see whether two objects are of the same type.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Boolean</span> <span class="token function">AreObjectsTheSameType</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o1<span class="token punctuation">,</span> <span class="token class-name">Object</span> o2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">return</span> o1<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> o2<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>In addition to calling Object’s GetType method, the FCL offers several more ways to obtain a Type object:</p><ul><li><p>The System.Type type offers several overloaded versions of the static GetType method. All versions of this method take a String. The string must specify the full name of the type (including its namespace). Note that the primitive type names supported by the compiler (such as C#’s int, string, bool, and so on) aren’t allowed because these names mean nothing to the CLR. If the string is simply the name of a type, the method checks the calling assembly to see whether it defines a type of the specified name. If it does, a reference to the appropriate Type object is returned. If the calling assembly doesn’t define the specified type, the types defined by MSCorLib.dll are checked. If a type with a matching name still can’t be found, null is returned or a System. TypeLoadException is thrown, depending on which overload of the GetType method you called and what parameters you passed to it. The FCL documentation fully explains this method. You can pass an assembly-qualified type string, such as “System.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089”, to GetType. In this case, GetType will look for the type in the specified assembly (loading the assembly if necessary).</p></li><li><p>The System.Type type offers a static ReflectionOnlyGetType method. This method behaves similarly to the GetType method mentioned in the previous bullet, except that the type is loaded so that it can be reflected over but cannot be executed.</p></li><li><p>The System.TypeInfo type offers the following instance members: DeclaredNestedTypes and GetDeclaredNestedType.</p></li><li><p>The System.Reflection.Assembly type offers the following instance members: GetType, DefinedTypes, and ExportedTypes.</p></li></ul></blockquote><p>💡注意：构造传给反射方法的字符串时，要使用类型名称或限定了程序集的类型名称。Microsoft 为这些名称定义了巴克斯 —— 诺尔范式 (Backus-MaurForm， BNF) 语法。使用反射时，了解这种语法对你很有帮助，尤其是在处理嵌套类型、泛型类型、泛型类型、引用参数或者数组的时候。要想了解完整语法，请参考文档或者 Google “BNF 类型名称”。还可参考 <code>Type</code> 和 <code>TypeInfo</code> 的 <code>MakeArrayType,MakeByRefType,MakeGenericType</code> 和 <code>MakePointerType</code> 方法。</p><blockquote><p>Many programming languages also offer an operator that allows you to obtain a Type object from a type name that is known at compile time. When possible, you should use this operator to obtain a reference to a Type instead of using any of the methods in the preceding list, because the operator generally produces faster code. In C#, the operator is called typeof, and you use this operator typically to compare late-bound type information with early-bound (known at compile time) type information. The following code demonstrates an example of its use.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// GetType returns the type of the object at runtime (late-bound) </span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token comment">// typeof returns the type of the specified class (early-bound) </span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">FileInfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">DirectoryInfo</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>💡注意：上述代码的第一个 <code>if</code> 语句检查变量 <code>o</code> 是否引用了 <code>FileInfo</code> 类型的对象；它不检查 <code>o</code> 是否引用从 <code>FileInfo</code> 类型派生的对象。换言之，上述代码测试的是精确匹配，而非兼容匹配，(使用转型或 C# 的 <code>is/as</code> 操作符时，测试的就是兼容匹配。)</p><blockquote><p>As mentioned earlier, a Type object represents a type reference that is a lightweight object. If you want to learn more about the type itself, then you must acquire a TypeInfo object, which represents a type definition. You can convert a Type object to a TypeInfo object by calling System.Reflection.IntrospectionExtensions’ GetTypeInfo extension method.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Type</span> typeReference <span class="token operator">=</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">// For example: o.GetType() or typeof(Object)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">TypeInfo</span> typeDefinition <span class="token operator">=</span> typeReference<span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>And, although less useful, you can convert a TypeInfo object to a Type object by calling TypeInfo’s AsType method</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">TypeInfo</span> typeDefinition <span class="token operator">=</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Type</span> typeReference <span class="token operator">=</span> typeDefinition<span class="token punctuation">.</span><span class="token function">AsType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>Obtaining a TypeInfo object forces the CLR to resolve the type by ensuring that the assembly that defines the type is loaded. This can be an expensive operation that can be avoided if all you need are type references (Type objects). However, after you have a TypeInfo object, you can query many of the type’s properties to learn more about it. Most of the properties, such as IsPublic, IsSealed, IsAbstract, IsClass, IsValueType, and so on, indicate flags associated with the type. Other properties, such as Assembly, AssemblyQualifiedName, FullName, Module, and so on, return the name of the type’s defining assembly or module and the full name of the type. You can also query the BaseType property to obtain a reference to the type’s base type, and a slew of members will give you even more information about the type. The FCL documentation describes all of the methods and properties that TypeInfo exposes.</p></blockquote><h3 id="building-a-hierarchy-of-exception-derived-types"><a class="anchor" href="#building-a-hierarchy-of-exception-derived-types">#</a> Building a Hierarchy of Exception-Derived Types</h3><blockquote><p>The following code uses many of the concepts discussed already in this chapter to load a bunch of assemblies into the AppDomain and display all of the classes that are ultimately derived from System. Exception. By the way, this is the program I wrote to build the exception hierarchy displayed in the “FCL-Defined Exception Classes” section in Chapter 20, “Exceptions and State Management.”</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Explicitly load the assemblies that we want to reflect over</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token function">LoadAssemblies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Filter &amp; sort all the types</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> allTypes <span class="token operator">=</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">(</span><span class="token keyword">from</span> a <span class="token keyword">in</span> AppDomain<span class="token punctuation">.</span>CurrentDomain<span class="token punctuation">.</span><span class="token function">GetAssemblies</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">from</span> t <span class="token keyword">in</span> a<span class="token punctuation">.</span>ExportedTypes</pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">where</span> <span class="token class-name">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Exception</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">orderby</span> t<span class="token punctuation">.</span>Name</pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">select</span> t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// Build the inheritance hierarchy tree and show it</span></pre></td></tr><tr><td data-num="12"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token function">WalkInheritanceHierarchy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Exception</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="13"></td><td><pre>allTypes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">StringBuilder</span> <span class="token function">WalkInheritanceHierarchy</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token class-name">StringBuilder</span> sb<span class="token punctuation">,</span> <span class="token class-name">Int32</span> indent<span class="token punctuation">,</span> <span class="token class-name">Type</span> baseType<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>Type<span class="token punctuation">></span></span> allTypes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token class-name">String</span> spaces <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">String</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">,</span> indent <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> sb<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span>spaces <span class="token operator">+</span> baseType<span class="token punctuation">.</span>FullName<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> t <span class="token keyword">in</span> allTypes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BaseType <span class="token operator">!=</span> baseType<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token function">WalkInheritanceHierarchy</span><span class="token punctuation">(</span>sb<span class="token punctuation">,</span> indent <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> allTypes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token keyword">return</span> sb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LoadAssemblies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token class-name">String<span class="token punctuation">[</span><span class="token punctuation">]</span></span> assemblies <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token string">"System, PublicKeyToken=&#123;0&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token string">"System.Core, PublicKeyToken=&#123;0&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token string">"System.Data, PublicKeyToken=&#123;0&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token string">"System.Design, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token string">"System.DirectoryServices, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token string">"System.Drawing, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token string">"System.Drawing.Design, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token string">"System.Management, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token string">"System.Messaging, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token string">"System.Runtime.Remoting, PublicKeyToken=&#123;0&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token string">"System.Security, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token string">"System.ServiceProcess, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token string">"System.Web, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre> <span class="token string">"System.Web.RegularExpressions, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre> <span class="token string">"System.Web.Services, PublicKeyToken=&#123;1&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token string">"System.Xml, PublicKeyToken=&#123;0&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token class-name">String</span> EcmaPublicKeyToken <span class="token operator">=</span> <span class="token string">"b77a5c561934e089"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token class-name">String</span> MSPublicKeyToken <span class="token operator">=</span> <span class="token string">"b03f5f7f11d50a3a"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token comment">// Get the version of the assembly containing System.Object</span></pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token comment">// We'll assume the same version for all the other assemblies</span></pre></td></tr><tr><td data-num="48"></td><td><pre> <span class="token class-name">Version</span> version <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">System<span class="token punctuation">.</span>Object</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Version<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre> <span class="token comment">// Explicitly load the assemblies that we want to reflect over</span></pre></td></tr><tr><td data-num="50"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">String</span> a <span class="token keyword">in</span> assemblies<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token class-name">String</span> AssemblyIdentity <span class="token operator">=</span> </pre></td></tr><tr><td data-num="52"></td><td><pre> String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> EcmaPublicKeyToken<span class="token punctuation">,</span> MSPublicKeyToken<span class="token punctuation">)</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="53"></td><td><pre> <span class="token string">", Culture=neutral, Version="</span> <span class="token operator">+</span> version<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre> Assembly<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>AssemblyIdentity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="constructing-an-instance-of-a-type"><a class="anchor" href="#constructing-an-instance-of-a-type">#</a> Constructing an Instance of a Type</h3><blockquote><p>After you have a reference to a Type-derived object, you might want to construct an instance of this type. The FCL offers several mechanisms to accomplish this:</p><ul><li><p><strong>System.Activator’s CreateInstance methods</strong> The Activator class offers several overloads of its static CreateInstance method. When you call this method, you can pass either a reference to a Type object or a String that identifies the type of object you want to create. The versions that take a type are simpler. You get to pass a set of arguments for the type’s constructor, and the method returns a reference to the new object.</p><p>The versions of this method in which you specify the desired type by using a string are a bit more complex. First, you must also specify a string identifying the assembly that defines the type. Second, these methods allow you to construct a remote object if you have remoting options configured properly. Third, these versions don’t return a reference to the new object. Instead, they return a System.Runtime.Remoting.ObjectHandle (which is derived from System.MarshalByRefObject).</p><p>An ObjectHandle is a type that allows an object created in one AppDomain to be passed around to other AppDomains without forcing the object to materialize. When you’re ready to materialize the object, you call ObjectHandle’s Unwrap method. This method loads the assembly that defines the type being materialized in the AppDomain where Unwrap is called. If the object is being marshaled by reference, the proxy type and object are created. If the object is being marshaled by value, the copy is deserialized.</p></li><li><p><strong>System.Activator’s CreateInstanceFrom methods</strong> The Activator class also offers a set of static CreateInstanceFrom methods. These methods behave just as the CreateInstance method, except that you must always specify the type and its assembly via string parameters. The assembly is loaded into the calling AppDomain by using Assembly’s LoadFrom method (instead of Load). Because none of these methods takes a Type parameter, all of the CreateInstanceFrom methods return a reference to an ObjectHandle, which must be unwrapped.</p></li><li><p><strong>System.AppDomain’s methods</strong> The AppDomain type offers four instance methods (each with several overloads) that construct an instance of a type: CreateInstance, CreateInstanceAndUnwrap, CreateInstanceFrom, and CreateInstanceFromAndUnwrap. These methods work just as Activator’s methods except that these methods are instance methods, allowing you to specify which AppDomain the object should be constructed in. The methods that end with Unwrap exist for convenience so that you don’t have to make an additional method call.</p></li><li><p><strong>System.Reflection.ConstructorInfo’s Invoke instance method</strong> Using a reference to a TypeInfo object, you can bind to a particular constructor and obtain a reference to the constructor’s ConstructorInfo object. Then you can use the reference to the ConstructorInfo object to call its Invoke method. The type is always created in the calling AppDomain, and a reference to the new object is returned. I’ll also discuss this method in more detail later in this chapter.</p></li></ul></blockquote><p>💡注意：CLR 不要求值类型定义任何构造器。但这会造成一个问题，因为上述列表中的所有机制都要求调用构造器来构造对象。然而， <code>Activator</code> 的 <code>CreateInstance</code> 方法允许在不调用构造器的情况下创建值类型的实例。要在不调用构造器的情况下创建值类型的实例，必须调用 <code>CreateInstance</code> 方法获取单个 <code>Type</code> 参数的版本或者获取 <code>Type</code> 和 <code>Boolean</code> 参数的版本。</p><blockquote><p>The mechanisms just listed allow you to create an object for all types except for arrays (System. Array-derived types) and delegates (System.MulticastDelegate-derived types). To create an array, you should call Array’s static CreateInstance method (several overloaded versions exist). The first parameter to all versions of CreateInstance is a reference to the Type of elements you want in the array. CreateInstance’s other parameters allow you to specify various combinations of dimensions and bounds. To create a delegate, you should call MethodInfo’s CreateDelegate method. The first parameter to all versions of CreateDelegate is a reference to the Type of delegate you want to create. CreateDelegate’s other parameter allows you to specify which object should be passed as the this parameter when calling an instance method.</p></blockquote><blockquote><p>To construct an instance of a generic type, first get a reference to the open type, and then call Type’s MakeGenericType method, passing in an array of types that you want to use as the type arguments. Then, take the returned Type object and pass it into one of the various methods previously listed. Here is an example.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span>TKey<span class="token punctuation">,</span> TValue<span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Get a reference to the generic type's type object </span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token class-name">Type</span> openType <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token punctuation">,</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Close the generic type by using TKey=String, TValue=Int32 </span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token class-name">Type</span> closedType <span class="token operator">=</span> openType<span class="token punctuation">.</span><span class="token function">MakeGenericType</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Int32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Construct an instance of the closed type </span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">Object</span> o <span class="token operator">=</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>closedType<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Prove it worked </span></pre></td></tr><tr><td data-num="13"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If you compile the preceding code and run it, you get the following output.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>Dictionary`<span class="token number">2</span><span class="token punctuation">[</span>System<span class="token punctuation">.</span>String<span class="token punctuation">,</span>System<span class="token punctuation">.</span>Int32<span class="token punctuation">]</span></pre></td></tr></table></figure><h2 id="designing-an-application-that-supports-add-ins"><a class="anchor" href="#designing-an-application-that-supports-add-ins">#</a> Designing an Application That Supports Add-Ins</h2><blockquote><p>When you’re building extensible applications, interfaces should be the centerpiece. You could use a base class instead of an interface, but in general, an interface is preferred because it allows add-in developers to choose their own base class. Suppose, for example, that you’re writing an application and you want others to be able to create types that your application can load and use seamlessly.</p></blockquote><blockquote><p>Here’s the way to design this application:</p><ul><li>Create a Host SDK assembly that defines an interface whose methods are used as the communication mechanism between the host application and the add-in components. When defining the parameters and return types for the interface methods, try to use other interfaces or types defined in MSCorLib.dll. If you want to pass and return your own data types, define them in this Host SDK assembly, too. After you settle on your interface definitions, give this assembly a strong name (discussed in Chapter 3), and then package and deploy it to your partners and users. Once published, you should really avoid making any kind of breaking changes to the types in this assembly. For example, do not change the interface in any way. However, if you define any data types, it is OK to add new members. If you make any modifications to the assembly, you’ll probably want to deploy it with a publisher policy file (also discussed in Chapter 3).</li></ul></blockquote><p>💡注意：之所以能使用 MSCorLib.dll 中定义的类型，是因为 CLR 总是加载与 CLR 本身的版本匹配的那个版本的 MSCorLib.dll。此外，一个 CLR 实例只会加载一个版本的 MSCorLib.dll 。换言之，永远不会出现多个不同版本的 MSCorLib.dll 都加载的情况 (详见第 3 章)。最后结果就是，绝不会出现类型版本不匹配的情况。这还有助于减少应用程序对内存的需求。</p><blockquote><ul><li><p>The add-in developers will, of course, define their own types in their own Add-In assembly. Their Add-In assembly will reference the types in your Host SDK assembly. The add-in developers are able to put out a new version of their assembly as often as they’d like, and the host application will be able to consume the add-in types without any problem whatsoever.</p></li><li><p>Create a separate Host Application assembly containing your application’s types. This assembly will obviously reference the Host SDK assembly and use the types defined in it. Feel free to modify the code in the Host Application assembly to your heart’s desire. Because the add-in developers don’t reference the Host Application assembly, you can put out a new version of it every hour if you want to and not affect any of the add-in developers.</p></li></ul></blockquote><blockquote><p>This section contains some very important information. When using types across assemblies, you need to be concerned with assembly-versioning issues. Take your time to architect this cleanly by isolating the types that you use for communication across assembly boundaries into their own assembly. Avoid mutating or changing these type definitions. However, if you really need to modify the type definitions, make sure that you change the assembly’s version number and create a publisher policy file for the new version.</p></blockquote><blockquote><p>I’ll now walk through a very simple scenario that puts all of this together. First, here is the code for the HostSDK.dll assembly.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">namespace</span> <span class="token namespace">Wintellect<span class="token punctuation">.</span>HostSDK</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IAddIn</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token return-type class-name">String</span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Second, here is the code for an AddInTypes.dll assembly defining two public types that implement the HostSDK’s interface. To build this assembly, the HostSDK.dll assembly must be referenced.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">Wintellect<span class="token punctuation">.</span>HostSDK</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AddIn_A</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAddIn</span></span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token function">AddIn_A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">return</span> <span class="token string">"AddIn_A: "</span> <span class="token operator">+</span> x<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AddIn_B</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAddIn</span></span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">public</span> <span class="token function">AddIn_B</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">return</span> <span class="token string">"AddIn_B: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Third, here is the code for a simple Host.exe assembly (a console application). To build this assembly, the HostSDK.dll assembly must be referenced. To discover usable add-in types, this host code assumes that the types are defined in assemblies ending with a .dll file extension and that these assemblies are deployed into the same directory as the host’s EXE file. Microsoft’s Managed Extensibility Framework (MEF) is built on top of the various mechanisms that I show here, and it also offers add-in registration and discovery mechanisms. I urge you to check MEF out if you are building a dynamically extensible application, because it can simplify some of the material in this chapter.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">Wintellect<span class="token punctuation">.</span>HostSDK</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Find the directory that contains the Host exe</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token class-name">String</span> AddInDir <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">GetDirectoryName</span><span class="token punctuation">(</span>Assembly<span class="token punctuation">.</span><span class="token function">GetEntryAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Location<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Assume AddIn assemblies are in same directory as host's EXE file</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> AddInAssemblies <span class="token operator">=</span> Directory<span class="token punctuation">.</span><span class="token function">EnumerateFiles</span><span class="token punctuation">(</span>AddInDir<span class="token punctuation">,</span> <span class="token string">"*.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Create a collection of Add-In Types usable by the host</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> AddInTypes <span class="token operator">=</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">from</span> file <span class="token keyword">in</span> AddInAssemblies</pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">let</span> assembly <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">from</span> t <span class="token keyword">in</span> assembly<span class="token punctuation">.</span>ExportedTypes <span class="token comment">// Publicly-exported types</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token comment">// Type is usable if it is a class that implements IAddIn </span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">where</span> <span class="token class-name">t</span><span class="token punctuation">.</span>IsClass <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">IAddIn</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">select</span> t<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// Initialization complete: the host has discovered the usable Add-Ins</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token comment">// Here's how the host can construct Add-In objects and use them</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Type</span> t <span class="token keyword">in</span> AddInTypes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token class-name">IAddIn</span> ai <span class="token operator">=</span> <span class="token punctuation">(</span>IAddIn<span class="token punctuation">)</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span><span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The simple host/add-in scenario just shown doesn’t use AppDomains. However, in a real-life scenario, you will likely create each add-in in its own AppDomain with its own security and configuration settings. And of course, each AppDomain could be unloaded if you wanted to remove an add-in from memory. To communicate across the AppDomain boundary, you’d either tell the add-in developers to derive their add-in types from MarshalByRefObject or, more likely, have the host application define its own internal type that is derived from MarshalByRefObject. As each AppDomain is created, the host would create an instance of its own MarshalByRefObject-derived type in the new AppDomain. The host’s code (in the default AppDomain) would communicate with its own type (in the other AppDomains) to have it load add-in assemblies and create and use instances of the add-in types.</p></blockquote><p>💡小结：反射是相当强大的机制，允许在运行发现并使用编译时还不了解的类型及其成员。但是，它也有下面两个缺点。反射造成编译时无法保证类型安全性。由于反射严重依赖字符串，所以会丧失编译时的类型安全性。反射速度慢。使用反射时，类型及其成员的名称在编译时未知；你要用字符串名称标识每个类型及其成员，然后在运行时发现它们。也就是说，使用 <code>System.Reflection</code> 命名空间中的类型扫描程序集的元数据时，反射机制会不停地执行字符串搜索。通常，字符串搜索执行的是不区分大小写的比较，这会进一步影响速度。使用反射调用成员也会影响性能。用反射调用方法时，首先必须将实参打包 (pack) 成数组；在内部，反射必须将这些实参解包 (unpack) 到线程栈上。此外，在调用方法前，CLR 必须检查实参具有正确的数据类型。最后，CLR 必须确保调用者有正确的安全权限来访问被调用的成员。基于上述所有原因，最好避免利用反射来访问字段或调用方法 / 属性。应该利用一下两种技术之一开发应用程序来动态发现和构造类型实例。让类型从编译时已知的基类型派生。在运行时构造派生类型的实例，将对它的引用方法放到基类型的变量中 (利用转型)，再调用基类型定义的虚方法。让类型实现编译时已知的接口。在运行时构造类型的实例，将对它的引用放到接口类型的变量中 (利用转型)，再调用接口定义的方法。使用这两种技术时，强烈建议接口或基类型在它们自己的程序集中定义，这有助于缓解版本控制问题。 <code>System.Type</code> 类型是执行类型和对象操作的起点。 <code>System.Type</code> 对象代表一个类型引用 (而不是类型定义)。 <code>System.Object</code> 定义了公共非虚实例方法 <code>GetType</code> 。调用这个方法时，CLR 会判断指定对象的类型，并返回对该类型的 <code>Type</code> 对象的引用。由于在一个 AppDomain 中，每个类型只有一个 <code>Type</code> 对象，所以可以使用相等和不等操作符来判断两个对象是不是相同的类型。除了调用 <code>Object</code> 的 <code>GetType</code> 方法， FCL 还提供了获得 <code>Type</code> 对象的其他几种方式。 <code>System.Type</code> 类型提供了静态 <code>GetType</code> 方法的几个重载版本。所有版本都接收一个 <code>String</code> 参数。字符串必须指定类型的全名 (包括它的命名空间)。注意不允许使用编译器支持的基元类型 (比如 C# 的 <code>int</code> ， <code>string</code> ， <code>bool</code> 等)，这些名称对于 CLR 没有任何意义。如果传递的只是一个类型名称，方法将检查调用程序集，看它是否定义了指定名称的类型。如果是，就返回对恰当 <code>Type</code> 对象的引用。如果调用程序集没有定义指定的类型，就检查 MSCorLib.dll 定义的类型。如果还是没有找到，就返回 <code>null</code> 或抛出 <code>System.TypeLoadException</code> (取决于调用的是 <code>GetType</code> 方法的哪个重载，以及传递的是什么参数)。 <code>System.Type</code> 类型提供了静态 <code>ReflectionOnlyGetType</code> 方法。该方法与上一条提到的 <code>GetType</code> 方法在行为上相似，只是类型会以 “仅反射” 的方式加载，不能执行。 <code>System.TypeInfo</code> 类型提供了实例成员 <code>DeclaredNestedTypes</code> 和 <code>GetDeclaredNestedType</code> 。 <code>System.Reflection.Assembly</code> 类型提供了实例成员 <code>GetType</code> ， <code>DefinedTypes</code> 和 <code>ExportedTypes</code> 。许多编程语言都允许使用一个操作符并根据编译时已知的类型名称来获得 <code>Type</code> 对象。尽量用这个操作符获得 <code>Type</code> 引用，而不要使用上述列表中的任何方法，因为操作符生成的代码通常更快。C# 的这个操作符称为 <code>typeof</code> ，通常用它将晚期绑定的类型信息与早期绑定 (编译时已知) 的类型信息进行比较。 <code>Type</code> 对象是轻量级的对象引用。要更多地了解类型本身，必须获取一个 <code>TypeInfo</code> 对象，后者才代表类型定义。可调用 <code>System.Reflection.IntrospectionExtensions</code> 的 <code>GetTypeInfo</code> 扩展方法将 <code>Type</code> 对象转换成 <code>TypeInfo</code> 对象。另外，虽然作用不大，但还可调用 <code>TypeInfo</code> 的 <code>AsType</code> 方法将 <code>TypeInfo</code> 对象转换成 <code>Type</code> 对象。获取 <code>TypeInfo</code> 对象会强迫 CLR 确保已加载类型的定义程序集，从而对类型进行解析。这个操作可能代价高昂。如果只需要类型引用 ( <code>Type</code> 对象)，就应避免这个操作。但一旦获得了 <code>TypeInfo</code> 对象，就可查询类型的许多属性进一步了解它。大多数属性，比如 <code>IsPublic</code> ， <code>IsSealed</code> ， <code>IsAbstract</code> ， <code>IsClass</code> 和 <code>IsValueType</code> 等，都指明了与类型关联的标志。另一些属性，比如 <code>Assembly</code> ， <code>AssemblyQualifiedName</code> , <code>FullName</code> 和 <code>Module</code> 等，则返回定义该类型的程序集或模块的名称以及类型的全名。还可查询 <code>BaseType</code> 属性来获取对类型的基类型的引用。除此之外，还有许多方法能提供关于类型的更多信息。获得对 <code>Type</code> 派生对象的引用之后，就可以构造该类型的实例了。FCL 提供了以下几个机制。 <code>Activator</code> 类提供了静态 <code>CreateInstance</code> 方法的几个重载版本。调用方法时既可传递一个 <code>Type</code> 对象引用，也可传递标识了类型的 <code>String</code> 。直接获取类型对象的几个版本较为简单。你要为类型的构造器传递一组实参，方法返回对新对象的引用。用字符串来指定类型的几个版本则稍微复杂一些。首先必须指定另一个字符串来标识定义了类型的程序集。其次，如果正确匹配了远程访问 (remoting) 选项，这些方法还允许构造远程对象。第三，这次版本返回的不是对新对象的引用，而是一个 <code>System.Runtime.Remoting.ObjectHandle</code> 对象 (从 <code>System.MarshalByRefObject</code> 派生)。 <code>ObjectHandle</code> 类型允许将一个 AppDomain 中创建的对象传至其他 AppDomain，期间不强迫对象具体化 (materialize)。准备好具体化这个对象时，请调用 <code>ObjectHandle</code> 的 <code>Unwrap</code> 方法。在一个 AppDomain 中调用该方法时，它将定义了要具体化的类型的程序集加载到这个 AppDomain 中。如果对象按引用封送，会创建代理类型和对象。如果对象按值封送，对象的副本会被反序列化。 <code>Activator</code> 类还提供了一组静态 <code>CreateInstanceFrom</code> 方法。它们与 <code>CreateInstance</code> 的行为相似，只是必须通过字符串参数来指定类型及其程序集。程序集用 <code>Assembly</code> 的 <code>LoadFrom</code> (而非 Load) 方法加载到调用 <code>AppDomain</code> 中。由于都不接受 Type 参数，所以返回的都会一个 <code>ObjectHandle</code> 对象引用，必须调用 <code>ObjectHandle</code> 的 <code>Unwrap</code> 方法进行具体化。 <code>AppDomain</code> 类型提供了 4 个用于构造类型实例的实例方法 (每个都有几个重载版本)，包括 <code>CreateInstance</code> ， <code>CreateInstanceAndUnwrap</code> ， <code>CreateInstanceFrom</code> 和 <code>CreateInstanceFromAndUnwrap</code> 。这些方法的行为和 <code>Activator</code> 类的方法相似，区别在于它们都是实例方法，允许指定在哪个 AppDomain 中构造对象。另外，带 <code>Unwrap</code> 后缀的方法还能简化操作，不必执行额外的方法调用。使用一个 <code>Type</code> 对象引用，可以绑定到一个特定的构造器，并获取对构造器的 <code>ConstructorInfo</code> 对象的引用。然后，可利用 <code>ConstructorInfo</code> 对象引用来调用它的 <code>Invoke</code> 方法。类型总是在调用 AppDomain 中创建，返回的是对新对象的引用。利用前面列出的机制，可为出数组 ( <code>System.Array</code> 派生类型) 和委托 ( <code>System.MulticastDelegate</code> 派生类型) 之外的所有类型创建对象。创建数组需要调用 <code>Array</code> 的静态 <code>CreateInstance</code> 方法 (有几个重载的版本)。所有版本的 <code>CreateInstance</code> 方法获取的第一个参数都是对数组元数 <code>Type</code> 的引用。 <code>CreateInstance</code> 的其他参数允许指定数组维数和上下限的各种组合。创建委托则要调用 <code>Delegate</code> 的静态 <code>CreateDelegate</code> 方法。所有版本的 <code>CreateDelegate</code> 方法获取的第一个参数都是对委托 <code>Type</code> 的引用。 <code>CreateDelegate</code> 方法的其他参数允许指定在调用实例方法时应将哪个对象作为 <code>this</code> 参数传递。构建可扩展应用程序时，接口是中心。可用基类代替接口，但接口通常是首选的，因为它允许加载项开发人员选择他们自己的基类。跨程序集使用类型时，需要关注程序集的版本控制问题。要花一些时间精心建构，将跨程序集通信的类型隔离到它们自己的程序集中。要避免以后更改这些类型的定义。但是，如果真的要修改类型定义，一定要修改程序集的版本号，并为新版本的程序集创建发布者策略文件。为了跨 AppDomain 边界通信，可告诉加载项开发人员从 <code>MarshalByRefObject</code> 派生出他们自己的加载类型。但另一个更常见的办法是让宿主应用程序定义自己的、从 <code>MarshalByRefObject</code> 派生的内部类型。每个 AppDomain 创建好后，宿主要在新 AppDomain 中创建它自己的 <code>MarshalByRefObject</code> 派生类型实例。宿主的代码 (位于默认 AppDomain 中) 将与它自己的类型 (位于其他 AppDomain 中) 通信，让后者载入加载项程序集，并创建和使用加载的类型的实例。</p><h2 id="using-reflection-to-discover-a-types-members"><a class="anchor" href="#using-reflection-to-discover-a-types-members">#</a> Using Reflection to Discover a Type’s Members</h2><blockquote><p>So far, this chapter has focused on the parts of reflection—assembly loading, type discovery, and object construction—necessary to build a dynamically extensible application. In order to have good performance and compile-time type safety, you want to avoid using reflection as much as possible. In the dynamically extensible application scenario, after an object is constructed, the host code typically casts the object to an interface type or a base class that is known at compile time; this allows the object’s members to be accessed in a high-performance and compile-time type-safe way.</p></blockquote><blockquote><p>In the remainder of this chapter, I’m going to focus on some other aspects of reflection that you can use to discover and then invoke a type’s members. The ability to discover and invoke a type’s members is typically used to create developer tools and utilities that analyze an assembly by looking for certain programming patterns or uses of certain members. Examples of tools/utilities that do this are ILDasm.exe, FxCopCmd.exe, and Visual Studio’s Windows Forms, Windows Presentation Foundation, and Web Forms designers. In addition, some class libraries use the ability to discover and invoke a type’s members in order to offer rich functionality as a convenience to developers. Examples of class libraries that do so are serialization/deserialization and simple data binding.</p></blockquote><h3 id="discovering-a-types-members"><a class="anchor" href="#discovering-a-types-members">#</a> Discovering a Type’s Members</h3><blockquote><p>Fields, constructors, methods, properties, events, and nested types can all be defined as members within a type. The FCL contains a type called System.Reflection.MemberInfo. This class is an abstract base class that encapsulates a bunch of properties common to all type members. Derived from MemberInfo are a bunch of classes; each class encapsulates some more properties related to a specific type member. Figure 23-1 shows the hierarchy of these types.</p></blockquote><p><img data-src="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/image-20221202202124953.png" alt="image-20221202202124953"></p><blockquote><p>The following program demonstrates how to query a type’s members and display some information about them. This code processes all of the public types defined in all assemblies loaded in the calling AppDomain. For each type, the DeclaredMembers property is called and returns a collection of MemberInfo-derived objects; each object refers to a single member defined within the type. Then, for each member, its kind (field, constructor, method, property, etc.) and its string value (obtained by calling ToString) is shown.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Loop through all assemblies loaded in this AppDomain </span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token class-name">Assembly<span class="token punctuation">[</span><span class="token punctuation">]</span></span> assemblies <span class="token operator">=</span> AppDomain<span class="token punctuation">.</span>CurrentDomain<span class="token punctuation">.</span><span class="token function">GetAssemblies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Assembly</span> a <span class="token keyword">in</span> assemblies<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Assembly: &#123;0&#125;"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// Find Types in the assembly</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Type</span> t <span class="token keyword">in</span> a<span class="token punctuation">.</span>ExportedTypes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Type: &#123;0&#125;"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Discover the type's members</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">MemberInfo</span> mi <span class="token keyword">in</span> t<span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DeclaredMembers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token class-name">String</span> typeName <span class="token operator">=</span> String<span class="token punctuation">.</span>Empty<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>mi <span class="token keyword">is</span> <span class="token class-name">Type</span><span class="token punctuation">)</span> typeName <span class="token operator">=</span> <span class="token string">"(Nested) Type"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>mi <span class="token keyword">is</span> <span class="token class-name">FieldInfo</span><span class="token punctuation">)</span> typeName <span class="token operator">=</span> <span class="token string">"FieldInfo"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>mi <span class="token keyword">is</span> <span class="token class-name">MethodInfo</span><span class="token punctuation">)</span> typeName <span class="token operator">=</span> <span class="token string">"MethodInfo"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>mi <span class="token keyword">is</span> <span class="token class-name">ConstructorInfo</span><span class="token punctuation">)</span> typeName <span class="token operator">=</span> <span class="token string">"ConstructoInfo"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>mi <span class="token keyword">is</span> <span class="token class-name">PropertyInfo</span><span class="token punctuation">)</span> typeName <span class="token operator">=</span> <span class="token string">"PropertyInfo"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>mi <span class="token keyword">is</span> <span class="token class-name">EventInfo</span><span class="token punctuation">)</span> typeName <span class="token operator">=</span> <span class="token string">"EventInfo"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"&#123;0&#125;: &#123;1&#125;"</span><span class="token punctuation">,</span> typeName<span class="token punctuation">,</span> mi<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> indent<span class="token punctuation">,</span> <span class="token class-name">String</span> format<span class="token punctuation">,</span> <span class="token keyword">params</span> <span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="26"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">String</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> indent<span class="token punctuation">)</span> <span class="token operator">+</span> format<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When you compile and run this code, a ton of output is produced. Here is a small sampling of what it looks like.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>Assembly<span class="token punctuation">:</span> mscorlib<span class="token punctuation">,</span> Version<span class="token operator">=</span><span class="token number">4.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">,</span> Culture<span class="token operator">=</span>neutral<span class="token punctuation">,</span> PublicKeyToken<span class="token operator">=</span><span class="token class-name">b77a5c561934e089</span></pre></td></tr><tr><td data-num="2"></td><td><pre> Type<span class="token punctuation">:</span> <span class="token class-name">System<span class="token punctuation">.</span>Object</span></pre></td></tr><tr><td data-num="3"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">System<span class="token punctuation">.</span>String</span> <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Equals</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Object<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> Equals<span class="token class-name"><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> System<span class="token punctuation">.</span>Object<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> ReferenceEquals<span class="token class-name"><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> System<span class="token punctuation">.</span>Object<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Int32</span> <span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">System<span class="token punctuation">.</span>Type</span> <span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Void</span> <span class="token function">Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">System<span class="token punctuation">.</span>Object</span> <span class="token function">MemberwiseClone</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Void</span> FieldSetter<span class="token class-name"><span class="token punctuation">(</span>System<span class="token punctuation">.</span>String<span class="token punctuation">,</span> System<span class="token punctuation">.</span>String<span class="token punctuation">,</span> System<span class="token punctuation">.</span>Object<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Void</span> FieldGetter<span class="token class-name"><span class="token punctuation">(</span>System<span class="token punctuation">.</span>String<span class="token punctuation">,</span> System<span class="token punctuation">.</span>String<span class="token punctuation">,</span> System<span class="token punctuation">.</span>Object ByRef<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="13"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">System<span class="token punctuation">.</span>Reflection<span class="token punctuation">.</span>FieldInfo</span> GetFieldInfo<span class="token class-name"><span class="token punctuation">(</span>System<span class="token punctuation">.</span>String<span class="token punctuation">,</span> System<span class="token punctuation">.</span>String<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre> ConstructoInfo<span class="token punctuation">:</span> Void <span class="token punctuation">.</span><span class="token function">ctor</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre> Type<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">.</span>IComparer`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Int32</span> Compare<span class="token class-name"><span class="token punctuation">(</span>T<span class="token punctuation">,</span> T<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="17"></td><td><pre> Type<span class="token punctuation">:</span> <span class="token class-name">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>IEnumerator</span></pre></td></tr><tr><td data-num="18"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> <span class="token function">MoveNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">System<span class="token punctuation">.</span>Object</span> <span class="token function">get_Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Void</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre> PropertyInfo<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Object <span class="token class-name">Current</span></pre></td></tr><tr><td data-num="22"></td><td><pre> Type<span class="token punctuation">:</span> <span class="token class-name">System<span class="token punctuation">.</span>IDisposable</span></pre></td></tr><tr><td data-num="23"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre> Type<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">.</span>IEnumerator`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">T</span> <span class="token function">get_Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre> PropertyInfo<span class="token punctuation">:</span> T <span class="token class-name">Current</span></pre></td></tr><tr><td data-num="27"></td><td><pre> Type<span class="token punctuation">:</span> System<span class="token punctuation">.</span>ArraySegment`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="28"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">get_Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Int32</span> <span class="token function">get_Offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Int32</span> <span class="token function">get_Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Int32</span> <span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Equals</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Object<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> <span class="token function">Equals</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>ArraySegment`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> <span class="token function">op_Equality</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>ArraySegment`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span> System<span class="token punctuation">.</span>ArraySegment`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre> MethodInfo<span class="token punctuation">:</span> <span class="token return-type class-name">Boolean</span> <span class="token function">op_Inequality</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>ArraySegment`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span> System<span class="token punctuation">.</span>ArraySegment`<span class="token number">1</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre> ConstructoInfo<span class="token punctuation">:</span> Void <span class="token punctuation">.</span><span class="token function">ctor</span><span class="token punctuation">(</span>T<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre> ConstructoInfo<span class="token punctuation">:</span> Void <span class="token punctuation">.</span>ctor<span class="token class-name"><span class="token punctuation">(</span>T<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Int32<span class="token punctuation">,</span> Int32<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="38"></td><td><pre> PropertyInfo<span class="token punctuation">:</span> T<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">Array</span></pre></td></tr><tr><td data-num="39"></td><td><pre> PropertyInfo<span class="token punctuation">:</span> Int32 <span class="token class-name">Offset</span></pre></td></tr><tr><td data-num="40"></td><td><pre> PropertyInfo<span class="token punctuation">:</span> Int32 <span class="token class-name">Count</span></pre></td></tr><tr><td data-num="41"></td><td><pre> FieldInfo<span class="token punctuation">:</span> T<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">_array</span></pre></td></tr><tr><td data-num="42"></td><td><pre> FieldInfo<span class="token punctuation">:</span> Int32 _offset</pre></td></tr></table></figure><blockquote><p>Because MemberInfo is the root of the member hierarchy, it makes sense for us to discuss it a bit more. Table 23-1 shows several read-only properties and methods offered by the MemberInfo class. These properties and methods are common to all members of a type. Don’t forget that System. TypeInfo is derived from MemberInfo, and therefore, TypeInfo also offers all of the properties shown in Table 23-1.</p></blockquote><p><img data-src="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/image-20221202202228344.png" alt="image-20221202202228344"></p><blockquote><p>Each element of the collection returned by querying DeclaredMembers is a reference to one of the concrete types in the hierarchy. Although TypeInfo’s DeclaredMembers property returns all of the type’s members, TypeInfo also offers methods that return specific member types for a specified string name. For example, TypeInfo offers GetDeclaredNestedType, GetDeclaredField, GetDeclaredMethod, GetDeclaredProperty, and GetDeclaredEvent. These methods all return a reference to a TypeInfo object, FieldInfo object, MethodInfo object, PropertyInfo object, or EventInfo object, respectively. There is also a GetDeclaredMethods method that returns a collection of MethodInfo objects describing the methods matching the specified string name.</p></blockquote><blockquote><p>Figure 23-2 summarizes the types used by an application to walk reflection’s object model. From an AppDomain, you can discover the assemblies loaded into it. From an assembly, you can discover the modules that make it up. From an assembly or a module, you can discover the types that it defines. From a type, you can discover its nested types, fields, constructors, methods, properties, and events. Namespaces are not part of this hierarchy because they are simply syntactical gatherings of types. If you want to list all of the namespaces defined in an assembly, you need to enumerate all of the types in this assembly and take a look at their Namespace property.</p></blockquote><blockquote><p>From a type, it is also possible to discover the interfaces it implements. And from a constructor, method, property accessor method, or event add/remove method, you can call the GetParameters method to obtain an array of ParameterInfo objects, which tells you the types of the member’s parameters. You can also query the read-only ReturnParameter property to get a ParameterInfo object for detailed information about a member’s return type. For a generic type or method, you can call the GetGenericArguments method to get the set of type parameters. Finally, for any of these items, you can query the CustomAttributes property to obtain the set of custom attributes applied to them.</p></blockquote><p><img data-src="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/image-20221202202318687.png" alt="image-20221202202318687"></p><h3 id="invoking-a-types-members"><a class="anchor" href="#invoking-a-types-members">#</a> Invoking a Type’s Members</h3><blockquote><p>Now that you know how to discover the members defined by a type, you may want to invoke one of these members. What invoke means depends on the kind of member being invoked. Table 23-2 shows which method to call for each kind of member to invoke that member.</p></blockquote><p><img data-src="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/image-20221202202419107.png" alt="image-20221202202419107"></p><blockquote><p>The PropertyInfo type represents metadata information about a property (as discussed in Chapter 10, “Properties”); that is, PropertyInfo offers CanRead, CanWrite, and PropertyType read-only properties. These properties indicate whether a property is readable or writeable and what data type the property is. PropertyInfo also has read-only GetMethod and SetMethod properties, which return MethodInfo objects representing the methods that get and set a property’s value.</p></blockquote><blockquote><p>PropertyInfo’s GetValue and SetValue methods exist for convenience; internally, they invoke the appropriate MethodInfo object. To support parameterful properties (C# indexers), the GetValue and SetValue methods offer an index parameter of Object[] type.</p></blockquote><blockquote><p>The EventInfo type represents metadata information about an event (as discussed in Chapter 11, “Events”). The EventInfo type offers a read-only EventHandlerType property that returns the Type of the event’s underlying delegate. The EventInfo type also has read-only AddMethod and RemoveMethod properties, which return the MethodInfo objects corresponding to the methods that add or remove a delegate to/from the event. To add or remove a delegate, you can invoke these MethodInfo objects, or you can call EventInfo’s more convenient AddEventHandler and RemoveEventHandler methods.</p></blockquote><blockquote><p>The following sample application demonstrates the various ways to use reflection to access a type’s members. The SomeType class represents a type that has various members: a private field (m_someField), a public constructor (SomeType) that takes an Int32 argument passed by reference, a public method (ToString), a public property (SomeProp), and a public event (SomeEvent). Having defined the SomeType type, I offer three different methods that use reflection to access SomeType’s members. Each method uses reflection in a different way to accomplish the same thing.</p><ul><li><p>The BindToMemberThenInvokeTheMember method demonstrates how to bind to a member and invoke it later.</p></li><li><p>The BindToMemberCreateDelegateToMemberThenInvokeTheMember method demonstrates how to bind to an object or member, and then it creates a delegate that refers to that object or member. Calling through the delegate is very fast, and this technique yields faster performance if you intend to invoke the same member on the same object multiple times.</p></li><li><p>The UseDynamicToBindAndInvokeTheMember method demonstrates how to use C# dynamic primitive type (discussed at the end of Chapter 5, “Primitive, Reference, and Value Types”) to simplify the syntax for accessing members. In addition, this technique can give reasonably good performance if you intend to invoke the same member on different objects that are all of the same type because the binding will happen once per type and be cached so that it can be invoked multiple times quickly. You can also use this technique to invoke a member on objects of different types.</p></li></ul></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>CSharp<span class="token punctuation">.</span>RuntimeBinder</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// This class is used to demonstrate reflection </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// It has a field, constructor, method, property, and an event </span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">SomeType</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">Int32</span> m_someField<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token function">SomeType</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">Int32</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">String</span> <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> m_someField<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> SomeProp <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">get</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> m_someField<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">set</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentOutOfRangeException</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> m_someField <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler</span> SomeEvent<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NoCompilerWarnings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> SomeEvent<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token class-name">Type</span> t <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">SomeType</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token function">BindToMemberThenInvokeTheMember</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token function">BindToMemberCreateDelegateToMemberThenInvokeTheMember</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token function">UseDynamicToBindAndInvokeTheMember</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BindToMemberThenInvokeTheMember</span><span class="token punctuation">(</span><span class="token class-name">Type</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"BindToMemberThenInvokeTheMember"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token comment">// Construct an instance</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token class-name">Type</span> ctorArgument <span class="token operator">=</span> Type<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token string">"System.Int32&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// or typeof(Int32).MakeByRefType();</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token class-name">ConstructorInfo</span> ctor <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DeclaredConstructors<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="36"></td><td><pre> c <span class="token operator">=></span> c<span class="token punctuation">.</span><span class="token function">GetParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ParameterType <span class="token operator">==</span> ctorArgument<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">12</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Constructor arguments</span></pre></td></tr><tr><td data-num="38"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"x before constructor called: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token class-name">Object</span> obj <span class="token operator">=</span> ctor<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Type: "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"x after constructor returns: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token comment">// Read and write to a field</span></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token class-name">FieldInfo</span> fi <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredField</span><span class="token punctuation">(</span><span class="token string">"m_someField"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre> fi<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"someField: "</span> <span class="token operator">+</span> fi<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token comment">// Call a method</span></pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token class-name">MethodInfo</span> mi <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"ToString"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre> <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span>mi<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ToString: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre> <span class="token comment">// Read and write a property</span></pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token class-name">PropertyInfo</span> pi <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredProperty</span><span class="token punctuation">(</span><span class="token string">"SomeProp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre> pi<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TargetInvocationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>InnerException<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ArgumentOutOfRangeException</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Property set catch."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre> pi<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"SomeProp: "</span> <span class="token operator">+</span> pi<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre> <span class="token comment">// Add and remove a delegate from the event</span></pre></td></tr><tr><td data-num="62"></td><td><pre> <span class="token class-name">EventInfo</span> ei <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredEvent</span><span class="token punctuation">(</span><span class="token string">"SomeEvent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre> <span class="token class-name">EventHandler</span> eh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EventHandler</span><span class="token punctuation">(</span>EventCallback<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// See ei.EventHandlerType</span></pre></td></tr><tr><td data-num="64"></td><td><pre> ei<span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> eh<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre> ei<span class="token punctuation">.</span><span class="token function">RemoveEventHandler</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> eh<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre> <span class="token comment">// Callback method added to the event</span></pre></td></tr><tr><td data-num="68"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EventCallback</span><span class="token punctuation">(</span><span class="token class-name">Object</span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BindToMemberCreateDelegateToMemberThenInvokeTheMember</span><span class="token punctuation">(</span><span class="token class-name">Type</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"BindToMemberCreateDelegateToMemberThenInvokeTheMember"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre> <span class="token comment">// Construct an instance (You can't create a delegate to a constructor)</span></pre></td></tr><tr><td data-num="72"></td><td><pre> <span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">12</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Constructor arguments</span></pre></td></tr><tr><td data-num="73"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"x before constructor called: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre> <span class="token class-name">Object</span> obj <span class="token operator">=</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Type: "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"x after constructor returns: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre> <span class="token comment">// NOTE: You can't create a delegate to a field</span></pre></td></tr><tr><td data-num="78"></td><td><pre> <span class="token comment">// Call a method</span></pre></td></tr><tr><td data-num="79"></td><td><pre> <span class="token class-name">MethodInfo</span> mi <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"ToString"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> toString <span class="token operator">=</span> mi<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateDelegate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>String<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre> <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ToString: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre> <span class="token comment">// Read and write a property</span></pre></td></tr><tr><td data-num="84"></td><td><pre> <span class="token class-name">PropertyInfo</span> pi <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredProperty</span><span class="token punctuation">(</span><span class="token string">"SomeProp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> setSomeProp <span class="token operator">=</span> pi<span class="token punctuation">.</span>SetMethod<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateDelegate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Action<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre> <span class="token function">setSomeProp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgumentOutOfRangeException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Property set catch."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre> <span class="token function">setSomeProp</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> getSomeProp <span class="token operator">=</span> pi<span class="token punctuation">.</span>GetMethod<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateDelegate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"SomeProp: "</span> <span class="token operator">+</span> <span class="token function">getSomeProp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre> <span class="token comment">// Add and remove a delegate from the event</span></pre></td></tr><tr><td data-num="96"></td><td><pre> <span class="token class-name">EventInfo</span> ei <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetDeclaredEvent</span><span class="token punctuation">(</span><span class="token string">"SomeEvent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> addSomeEvent <span class="token operator">=</span> ei<span class="token punctuation">.</span>AddMethod<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateDelegate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Action<span class="token punctuation">&lt;</span>EventHandler<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre> <span class="token function">addSomeEvent</span><span class="token punctuation">(</span>EventCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> removeSomeEvent <span class="token operator">=</span> ei<span class="token punctuation">.</span>RemoveMethod<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateDelegate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Action<span class="token punctuation">&lt;</span>EventHandler<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre> <span class="token function">removeSomeEvent</span><span class="token punctuation">(</span>EventCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="102"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UseDynamicToBindAndInvokeTheMember</span><span class="token punctuation">(</span><span class="token class-name">Type</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"UseDynamicToBindAndInvokeTheMember"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre> <span class="token comment">// Construct an instance (You can't use dynamic to call a constructor)</span></pre></td></tr><tr><td data-num="105"></td><td><pre> <span class="token class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">12</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Constructor arguments</span></pre></td></tr><tr><td data-num="106"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"x before constructor called: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre> <span class="token class-name"><span class="token keyword">dynamic</span></span> obj <span class="token operator">=</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Type: "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"x after constructor returns: "</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre> <span class="token comment">// Read and write to a field </span></pre></td></tr><tr><td data-num="111"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="112"></td><td><pre> obj<span class="token punctuation">.</span>m_someField <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre> <span class="token class-name">Int32</span> v <span class="token operator">=</span> <span class="token punctuation">(</span>Int32<span class="token punctuation">)</span>obj<span class="token punctuation">.</span>m_someField<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"someField: "</span> <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="116"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeBinderException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="117"></td><td><pre> <span class="token comment">// We get here because the field is private</span></pre></td></tr><tr><td data-num="118"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Failed to access field: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre> <span class="token comment">// Call a method</span></pre></td></tr><tr><td data-num="121"></td><td><pre> <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ToString: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre> <span class="token comment">// Read and write a property</span></pre></td></tr><tr><td data-num="124"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="125"></td><td><pre> obj<span class="token punctuation">.</span>SomeProp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="127"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgumentOutOfRangeException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="128"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Property set catch."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="130"></td><td><pre> obj<span class="token punctuation">.</span>SomeProp <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre> <span class="token class-name">Int32</span> val <span class="token operator">=</span> <span class="token punctuation">(</span>Int32<span class="token punctuation">)</span>obj<span class="token punctuation">.</span>SomeProp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"SomeProp: "</span> <span class="token operator">+</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre> <span class="token comment">// Add and remove a delegate from the event</span></pre></td></tr><tr><td data-num="134"></td><td><pre> obj<span class="token punctuation">.</span>SomeEvent <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EventHandler</span><span class="token punctuation">(</span>EventCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre> obj<span class="token punctuation">.</span>SomeEvent <span class="token operator">-=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EventHandler</span><span class="token punctuation">(</span>EventCallback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="136"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ReflectionExtensions</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="139"></td><td><pre> <span class="token comment">// Helper extension method to simplify syntax to create a delegate</span></pre></td></tr><tr><td data-num="140"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">TDelegate</span> <span class="token generic-method"><span class="token function">CreateDelegate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TDelegate<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">MethodInfo</span> mi<span class="token punctuation">,</span> <span class="token class-name">Object</span> target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="141"></td><td><pre> <span class="token keyword">return</span> <span class="token punctuation">(</span>TDelegate<span class="token punctuation">)</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>mi<span class="token punctuation">.</span><span class="token function">CreateDelegate</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TDelegate</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>If you build and run this code, you’ll see the following output.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>BindToMemberThenInvokeTheMember</pre></td></tr><tr><td data-num="2"></td><td><pre>x before <span class="token class-name">constructor</span> called<span class="token punctuation">:</span> <span class="token number">12</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Type<span class="token punctuation">:</span> SomeType</pre></td></tr><tr><td data-num="4"></td><td><pre>x after <span class="token class-name">constructor</span> returns<span class="token punctuation">:</span> <span class="token number">24</span></pre></td></tr><tr><td data-num="5"></td><td><pre>someField<span class="token punctuation">:</span> <span class="token number">33</span></pre></td></tr><tr><td data-num="6"></td><td><pre>ToString<span class="token punctuation">:</span> <span class="token number">33</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Property <span class="token keyword">set</span> <span class="token keyword">catch</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="8"></td><td><pre>SomeProp<span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="9"></td><td><pre>BindToMemberCreateDelegateToMemberThenInvokeTheMember</pre></td></tr><tr><td data-num="10"></td><td><pre>x before <span class="token class-name">constructor</span> called<span class="token punctuation">:</span> <span class="token number">12</span></pre></td></tr><tr><td data-num="11"></td><td><pre>Type<span class="token punctuation">:</span> SomeType</pre></td></tr><tr><td data-num="12"></td><td><pre>x after <span class="token class-name">constructor</span> returns<span class="token punctuation">:</span> <span class="token number">24</span></pre></td></tr><tr><td data-num="13"></td><td><pre>ToString<span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="14"></td><td><pre>Property <span class="token keyword">set</span> <span class="token keyword">catch</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="15"></td><td><pre>SomeProp<span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="16"></td><td><pre>UseDynamicToBindAndInvokeTheMember</pre></td></tr><tr><td data-num="17"></td><td><pre>x before <span class="token class-name">constructor</span> called<span class="token punctuation">:</span> <span class="token number">12</span></pre></td></tr><tr><td data-num="18"></td><td><pre>Type<span class="token punctuation">:</span> SomeType</pre></td></tr><tr><td data-num="19"></td><td><pre>x after <span class="token class-name">constructor</span> returns<span class="token punctuation">:</span> <span class="token number">24</span></pre></td></tr><tr><td data-num="20"></td><td><pre>Failed to <span class="token class-name">access</span> field<span class="token punctuation">:</span> 'SomeType<span class="token punctuation">.</span>m_someField' <span class="token keyword">is</span> <span class="token class-name">inaccessible</span> due to its protection <span class="token class-name">level</span></pre></td></tr><tr><td data-num="21"></td><td><pre>ToString<span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="22"></td><td><pre>Property <span class="token keyword">set</span> <span class="token keyword">catch</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="23"></td><td><pre>SomeProp<span class="token punctuation">:</span> <span class="token number">2</span></pre></td></tr></table></figure><blockquote><p>Notice that SomeType’s constructor takes an Int32 by reference as its only parameter. The previous code shows how to call this constructor and how to examine the modified Int32 value after the constructor returns. Near the top of the BindToMemberThenInvokeTheMember method, I show how to accomplish this by calling Type’s GetType method passing in a string of &quot;System.Int32&amp;&quot;. The ampersand (&amp;) in the string allows me to identify a parameter passed by reference. This ampersand is part of the Backus-Naur Form grammar for type names, which you can look up in the FCL documentation. The code also shows how to accomplish the same thing using Type’s MakeByRefType method.</p></blockquote><h3 id="using-binding-handles-to-reduce-your-processs-memory-consumption"><a class="anchor" href="#using-binding-handles-to-reduce-your-processs-memory-consumption">#</a> Using Binding Handles to Reduce Your Process’s Memory Consumption</h3><blockquote><p>Many applications bind to a bunch of types (Type objects) or type members (MemberInfo-derived objects) and save these objects in a collection of some sort. Then later, the application searches the collection for a particular object and then invokes this object. This is a fine way of doing things except for one small issue: Type and MemberInfo-derived objects require a lot of memory. So if an application holds on to too many of these objects and invokes them occasionally, the application’s memory consumption increases dramatically, having an adverse effect on the application’s performance.</p></blockquote><blockquote><p>Internally, the CLR has a more compact way of representing this information. The CLR creates these objects for our applications only to make things easier for developers. The CLR doesn’t need these big objects itself in order to run. Developers who are saving/caching a lot of Type and MemberInfoderived objects can reduce their working set by using run-time handles instead of objects. The FCL defines three runtime handle types (all defined in the System namespace): RuntimeTypeHandle, RuntimeFieldHandle, and RuntimeMethodHandle. All of these types are value types that contain just one field, an IntPtr; this makes instances of these types cheap (memory-wise). The IntPtr field is a handle that refers to a type, field, or method in an AppDomain’s loader heap. So what you need now is an easy and efficient way to convert a heavyweight Type/MemberInfo object to a lightweight run-time handle instance and vice versa. Fortunately, this is easy using the following conversion methods and properties:</p><ul><li><p>To convert a Type object to a RuntimeTypeHandle, call Type’s static GetTypeHandle method passing in the reference to the Type object.</p></li><li><p>To convert a RuntimeTypeHandle to a Type object, call Type’s static GetTypeFromHandle method passing in the RuntimeTypeHandle.</p></li><li><p>To convert a FieldInfo object to a RuntimeFieldHandle, query FieldInfo’s instance read-only FieldHandle property.</p></li><li><p>To convert a RuntimeFieldHandle to a FieldInfo object, call FieldInfo’s static GetFieldFromHandle method.</p></li><li><p>To convert a MethodInfo object to a RuntimeMethodHandle, query MethodInfo’s instance read-only MethodHandle property.</p></li><li><p>To convert a RuntimeMethodHandle to a MethodInfo object, call MethodInfo’s static GetMethodFromHandle method.</p></li></ul></blockquote><blockquote><p>The following program sample acquires a lot of MethodInfo objects, converts them to RuntimeMethodHandle instances, and shows the working set difference.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name">BindingFlags</span> c_bf <span class="token operator">=</span> BindingFlags<span class="token punctuation">.</span>FlattenHierarchy <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>Instance <span class="token operator">|</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> BindingFlags<span class="token punctuation">.</span>Static <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>Public <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>NonPublic<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Show size of heap before doing any reflection stuff</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"Before doing anything"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// Build cache of MethodInfo objects for all methods in MSCorlib.dll</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token class-name">List<span class="token punctuation">&lt;</span>MethodBase<span class="token punctuation">></span></span> methodInfos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>MethodBase<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Type</span> t <span class="token keyword">in</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Object</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">.</span><span class="token function">GetExportedTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token comment">// Skip over any generic types</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>IsGenericTypeDefinition<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token class-name">MethodBase<span class="token punctuation">[</span><span class="token punctuation">]</span></span> mb <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">GetMethods</span><span class="token punctuation">(</span>c_bf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> methodInfos<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>mb<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token comment">// Show number of methods and size of heap after binding to all methods</span></pre></td></tr><tr><td data-num="19"></td><td><pre> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"# of methods=&#123;0:N0&#125;"</span><span class="token punctuation">,</span> methodInfos<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"After building cache of MethodInfo objects"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token comment">// Build cache of RuntimeMethodHandles for all MethodInfo objects</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token class-name">List<span class="token punctuation">&lt;</span>RuntimeMethodHandle<span class="token punctuation">></span></span> methodHandles <span class="token operator">=</span> </pre></td></tr><tr><td data-num="23"></td><td><pre> methodInfos<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConvertAll</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RuntimeMethodHandle<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>mb <span class="token operator">=></span> mb<span class="token punctuation">.</span>MethodHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"Holding MethodInfo and RuntimeMethodHandle cache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> GC<span class="token punctuation">.</span><span class="token function">KeepAlive</span><span class="token punctuation">(</span>methodInfos<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Prevent cache from being GC'd early</span></pre></td></tr><tr><td data-num="26"></td><td><pre> methodInfos <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Allow cache to be GC'd now</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"After freeing MethodInfo objects"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre> methodInfos <span class="token operator">=</span> methodHandles<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConvertAll</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MethodBase<span class="token punctuation">></span></span></span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="29"></td><td><pre> rmh<span class="token operator">=></span> MethodBase<span class="token punctuation">.</span><span class="token function">GetMethodFromHandle</span><span class="token punctuation">(</span>rmh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"Size of heap after re-creating MethodInfo objects"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre> GC<span class="token punctuation">.</span><span class="token function">KeepAlive</span><span class="token punctuation">(</span>methodHandles<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Prevent cache from being GC'd early</span></pre></td></tr><tr><td data-num="32"></td><td><pre> GC<span class="token punctuation">.</span><span class="token function">KeepAlive</span><span class="token punctuation">(</span>methodInfos<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Prevent cache from being GC'd early</span></pre></td></tr><tr><td data-num="33"></td><td><pre> methodHandles <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Allow cache to be GC'd now</span></pre></td></tr><tr><td data-num="34"></td><td><pre> methodInfos <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Allow cache to be GC'd now</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"After freeing MethodInfos and RuntimeMethodHandles"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When I compiled and executed this program, I got the following output.</p></blockquote><pre><code class="language-cmd">Heap size= 85,000 - Before doing anything
# of methods=48,467
Heap size= 7,065,632 - After building cache of MethodInfo objects
Heap size= 7,453,496 - Holding MethodInfo and RuntimeMethodHandle cache
Heap size= 6,732,704 - After freeing MethodInfo objects
Heap size= 7,372,704 - Size of heap after re-creating MethodInfo objects
Heap size= 192,232 - After freeing MethodInfos and RuntimeMethodHandles

</code></pre><p>💡小结：字段、构造器、方法、属性、事件和嵌套类型都可以定义成类型的成员。FCL 包含抽象基类 <code>System.Reflection.MemberInfo</code> ，封装了所有类型成员都通用的一组属性。 <code>MemberInfo</code> 有许多派生类，每个都封装了与特定类型成员相关的更多属性。由于 <code>MemberInfo</code> 类是成员层次结构的根，所以有必要更深入地研究一下它，它提供的属性和方法是一个类型的所有成员都通用的。不要忘了 <code>System.TypeInfo</code> 从 <code>MemberInfo</code> 派生。在查询 <code>DeclaredMemebers</code> 属性所返回的集合中，每个元素都会对层次结构中的一个具体类型的引用。虽然 <code>TypeInfo</code> 的 <code>DeclaredMembers</code> 属性能返回类型的所有成员，但还可利用 <code>TypeInfo</code> 提供的一些方法返回具有指定字符串名称的成员类型。例如，利用 <code>TypeInfo</code> 的 <code>GetDeclaredNestedType</code> ， <code>GetDeclaredField</code> ， <code>GetDeclaredMethod</code> ， <code>GetDeclaredProperty</code> 和 <code>GetDeclaredEvent</code> 方法，可分别返回一个 <code>TypeInfo</code> 、 <code>FieldInfo</code> 、 <code>MethodInfo</code> 、 <code>PropertyInfo</code> 和 <code>EventInfo</code> 对象引用。而利用 <code>GetDeclaredMethods</code> 方法能返回由 <code>MethodInfo</code> 对象构成的集合，这些对象描述了和指定字符串名称匹配的一个 (多个) 方法。基于 AppDomain，可发现其中加载的所有程序集。基于程序集，可发现构成它的所有模块。基于程序集或模块，可发现它定义的所有类型。基于类型，可发现它的嵌套类型、字段、构造器、方法、属性和事件。命名空间不是这个层次结构的一部分，因为它们只是从语法角度将相关类型聚集到一起。CLR 不知道什么是命名空间。要列出程序集中定义的所有命名空间，需枚举程序集中的所有类型，并查看其 <code>Namespace</code> 属性。基于一个类型，还可发现它实现的接口。基于构造器、方法、属性访问器方法或者事件的添加 / 删除方法，可调用 <code>GetParameters</code> 方法来获取由 <code>ParameterInfo</code> 对象构成的数组，从而了解成员的参数的类型。还可查询只读属性 <code>ReturnParameter</code> 获得一个 <code>ParameterInfo</code> 对象，它详细描述了成员的返回类型。对于泛型类型或方法，可调用 <code>GetGenericArguments</code> 方法来获得类型参数的集合。最后，针对上述任何一项，都可查询 <code>CustomAttributes</code> 属性来获得应用于它们的自定义定制特性的集合。发现类型定义的成员后可调用它们。“调用”(invoke) 的确切含义取决于要调用的成员的种类。 <code>PropertyInfo</code> 类型代表与属性有关的元数据信息；也就是说， <code>PropertyInfo</code> 提供了 <code>CanRead</code> 、 <code>CanWrite</code> 、和 <code>PropertyType</code> 只读属性，它们指出属性是否可读和可写，以及属性的数据类型是什么。 <code>PropertyInfo</code> 还提供了只读 <code>GetMethod</code> 和 <code>SetMethod</code> 属性，它们返回代表属性 <code>get</code> 和 <code>set</code> 访问器方法的 <code>MethodInfo</code> 对象。 <code>PropertyInfo</code> 的 <code>GetValue</code> 和 <code>SetValue</code> 方法只是为了提供方法；在内部，它们会自己调用合适的 <code>MethodInfo</code> 对象。为了支持有参属性 (C# 的索引器)， <code>GetValue</code> 和 <code>SetValue</code> 方法提供了一个 <code>Object[]</code> 类型的 <code>index</code> 参数。 <code>EventInfo</code> 类型代表与事件有关的元数据信息。 <code>EventInfo</code> 类型提供了只读 <code>EventHandlerType</code> 属性，返回事件的基础委托的 <code>Type</code> 。 <code>EventInfo</code> 类型还提供了只读 <code>AddMethod</code> 和 <code>RemoveMethod</code> 属性，返回为事件增删委托的方法的 <code>MethodInfo</code> 对象。增删委托可调用这些 <code>MethodInfo</code> 对象，也可调用 <code>EventInfo</code> 类型提供的更好用的 <code>AddEventHandler</code> 和 <code>RemoveEventHandler</code> 方法。许多应用程序都绑定了一组类型 ( <code>Type</code> 对象) 或类型成员 ( <code>MemeberInfo</code> 派生对象)，并将这些对象保存在某种形式的集合中。以后，应用程序搜索这个集合，查找特定对象，然后调用 (invoke) 这个对象。这个机制很好，只是有个小问题： <code>Type</code> 和 <code>MemberInfo</code> 派生对象需要大量内存。所以，如果应用程序容纳了太多这样的对象，但只是偶尔调用，应用程序消耗的内存就会急剧增加，对应用程序的性能产生负面影响。CLR 内部用更精简的方式表示这种信息。CLR 之所以为应用程序创建这些对象，只是为了方便开发人员。CLR 不需要这些大对象就能运行。如果需要保存 / 缓存大量 <code>Type</code> 和 <code>MemberInfo</code> 派生对象，开发人员可以使用运行时句柄 (runtime handle) 代替对象以减小工作集 (占用的内存)。FCL 定义了三个运行时句柄 (全部都在 <code>System</code> 命名空间中)，包括 <code>RuntimeTypeHandle</code> ， <code>RuntimeFieldHandle</code> 和 <code>RuntimeMethodHandle</code> 。三个类型都是值类型，都只包含一个字段，也就是一个 <code>IntPtr</code> ；这使类型的实例显得相当精简 (相当省内存)。 <code>IntPtr</code> 字段是一个句柄，引用了 AppDomain 的 Loader 堆中的一个类型、字段或方法。因此，现在需要以一种简单、高效的方式将重量级的 <code>Type</code> 或 <code>MemberInfo</code> 对象转换为轻量级的运行时句柄实例，反之亦然。幸好，使用以下转换方法和属性可轻松达到目的。要将 Type 对象转换为一个 <code>RuntimeTypeHandle</code> ，调用 <code>Type</code> 的静态 <code>GetTypeHandle</code> 方法并传递那个 <code>Type</code> 对象引用。要将一个 <code>RuntimeTypeHandle</code> 转换为 <code>Type</code> 对象，调用 <code>Type</code> 的静态方法 <code>GetTypeFromHandle</code> ，并传递那个 <code>RuntimeTypeHandle</code> 。要将 <code>FieldInfo</code> 对象转换为一个 <code>RuntimeFieldHandle</code> ，查询 <code>FieldInfo</code> 的实例只读属性 <code>FieldHandle</code> 。要将一个 <code>RuntimeFieldHandle</code> 转换为 <code>FieldInfo</code> 对象，调用 <code>FieldInfo</code> 的静态方法 <code>GetFieldFromHandle</code> 。要将 <code>MethodInfo</code> 对象转换为一个 <code>RuntimeMethodHandle</code> ，查询 <code>MethodInfo</code> 的实例只读属性 <code>MethodHandle</code> 。要将一个 <code>RuntimeMethodHandle</code> 转换为一个 <code>MethodInfo</code> 对象，调用 MethodInfo 的静态方法 <code>GetMethodFromHandle</code> 。</p><div class="tags"><a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag"><i class="ic i-tag"></i> 读书笔记</a> <a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C#</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2022-12-05 14:45:57" itemprop="dateModified" datetime="2022-12-05T14:45:57+08:00">2022-12-05</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Sakupinera WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/images/alipay.png" alt="Sakupinera Alipay"><p>Alipay</p></div><div><img data-src="/images/paypal.png" alt="Sakupinera PayPal"><p>PayPal</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Sakupinera <i class="ic i-at"><em>@</em></i>Sakupinera</li><li class="link"><strong>Post link: </strong><a href="http://sakupinera.github.io/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/" title="CLR via C# - Chapter 23 Assembly Loading and Reflection">http://sakupinera.github.io/2022/11/29/csharp/clr-via-csharp/Chapter 23 Assembly Loading and Reflection/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/11/28/csharp/clr-via-csharp/Chapter%2022%20CLR%20Hosting%20and%20AppDomains/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;03&#x2F;08&#x2F;Z2usRnE64TXN1Lp.jpg" title="CLR via C# - Chapter 22 CLR Hosting and AppDomains"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 22 CLR Hosting and AppDomains</h3></a></div><div class="item right"><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;03&#x2F;08&#x2F;mOQfkxXNYp8VGng.png" title="CLR via C# - Chapter 24 Runtime Serialization"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 24 Runtime Serialization</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#chapter-23-assembly-loading-and-reflection"><span class="toc-number">1.</span> <span class="toc-text">Chapter 23 Assembly Loading and Reflection</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#assembly-loading"><span class="toc-number">1.1.</span> <span class="toc-text">Assembly Loading</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#using-reflection-to-build-a-dynamically-extensible-application"><span class="toc-number">1.2.</span> <span class="toc-text">Using Reflection to Build a Dynamically Extensible Application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reflection-performance"><span class="toc-number">1.3.</span> <span class="toc-text">Reflection Performance</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#discovering-types-defined-in-an-assembly"><span class="toc-number">1.3.1.</span> <span class="toc-text">Discovering Types Defined in an Assembly</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#what-exactly-is-a-type-object"><span class="toc-number">1.3.2.</span> <span class="toc-text">What Exactly Is a Type Object?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#building-a-hierarchy-of-exception-derived-types"><span class="toc-number">1.3.3.</span> <span class="toc-text">Building a Hierarchy of Exception-Derived Types</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructing-an-instance-of-a-type"><span class="toc-number">1.3.4.</span> <span class="toc-text">Constructing an Instance of a Type</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#designing-an-application-that-supports-add-ins"><span class="toc-number">1.4.</span> <span class="toc-text">Designing an Application That Supports Add-Ins</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#using-reflection-to-discover-a-types-members"><span class="toc-number">1.5.</span> <span class="toc-text">Using Reflection to Discover a Type’s Members</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#discovering-a-types-members"><span class="toc-number">1.5.1.</span> <span class="toc-text">Discovering a Type’s Members</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#invoking-a-types-members"><span class="toc-number">1.5.2.</span> <span class="toc-text">Invoking a Type’s Members</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#using-binding-handles-to-reduce-your-processs-memory-consumption"><span class="toc-number">1.5.3.</span> <span class="toc-text">Using Binding Handles to Reduce Your Process’s Memory Consumption</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%201%20The%20CLR%E2%80%99s%20Execution%20Model/" rel="bookmark" title="CLR via C# - Chapter 1 The CLR’s Execution Model">CLR via C# - Chapter 1 The CLR’s Execution Model</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%202%20Building,%20Packaging,%20Deploying,%20and%20Administering%20Applications%20and%20Types/" rel="bookmark" title="CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types">CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%203%20Shared%20Assemblies%20and%20Strongly%20Named%20Assemblies/" rel="bookmark" title="CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies">CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies</a></li><li><a href="/2022/09/27/csharp/clr-via-csharp/Chapter%204%20Type%20Fundamentals/" rel="bookmark" title="CLR via C# - Chapter 4 Type Fundamentals">CLR via C# - Chapter 4 Type Fundamentals</a></li><li><a href="/2022/10/15/csharp/clr-via-csharp/Chapter%205%20Primitive,%20Reference,%20and%20Value%20%20Types/" rel="bookmark" title="CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals">CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals</a></li><li><a href="/2022/10/21/csharp/clr-via-csharp/Chapter%206%20Type%20and%20Member%20Basics/" rel="bookmark" title="CLR via C# - Chapter 6 Type and Member Basics">CLR via C# - Chapter 6 Type and Member Basics</a></li><li><a href="/2022/10/24/csharp/clr-via-csharp/Chapter%207%20Constants%20and%20Fields/" rel="bookmark" title="CLR via C# - Chapter 7 Constants and Fields">CLR via C# - Chapter 7 Constants and Fields</a></li><li><a href="/2022/10/25/csharp/clr-via-csharp/Chapter%208%20Methods/" rel="bookmark" title="CLR via C# - Chapter 8 Methods">CLR via C# - Chapter 8 Methods</a></li><li><a href="/2022/10/27/csharp/clr-via-csharp/Chapter%209%20Parameters/" rel="bookmark" title="CLR via C# - Chapter 9 Parameters">CLR via C# - Chapter 9 Parameters</a></li><li><a href="/2022/10/28/csharp/clr-via-csharp/Chapter%2010%20Properties/" rel="bookmark" title="CLR via C# - Chapter 10 Properties">CLR via C# - Chapter 10 Properties</a></li><li><a href="/2022/10/29/csharp/clr-via-csharp/Chapter%2011%20Events/" rel="bookmark" title="CLR via C# - Chapter 11 Events">CLR via C# - Chapter 11 Events</a></li><li><a href="/2022/11/02/csharp/clr-via-csharp/Chapter%2012%20Generics/" rel="bookmark" title="CLR via C# - Chapter 12 Generics">CLR via C# - Chapter 12 Generics</a></li><li><a href="/2022/11/04/csharp/clr-via-csharp/Chapter%2013%20Interfaces/" rel="bookmark" title="CLR via C# - Chapter 13 Interfaces">CLR via C# - Chapter 13 Interfaces</a></li><li><a href="/2022/11/16/csharp/clr-via-csharp/Chapter%2014%20Chars,%20Strings,%20and%20Working%20%20with%20Text/" rel="bookmark" title="CLR via C# - Chapter 14 Chars, Strings, and Working with Text">CLR via C# - Chapter 14 Chars, Strings, and Working with Text</a></li><li><a href="/2022/11/17/csharp/clr-via-csharp/Chapter%2015%20Enumerated%20Types%20and%20Bit%20Flags/" rel="bookmark" title="CLR via C# - Chapter 15 Enumerated Types and Bit Flags">CLR via C# - Chapter 15 Enumerated Types and Bit Flags</a></li><li><a href="/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/" rel="bookmark" title="CLR via C# - Chapter 16 Arrays">CLR via C# - Chapter 16 Arrays</a></li><li><a href="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/" rel="bookmark" title="CLR via C# - Chapter 17 Delegates">CLR via C# - Chapter 17 Delegates</a></li><li><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" rel="bookmark" title="CLR via C# - Chapter 18 Custom Attributes">CLR via C# - Chapter 18 Custom Attributes</a></li><li><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" rel="bookmark" title="CLR via C# - Chapter 19 Nullable Value Types">CLR via C# - Chapter 19 Nullable Value Types</a></li><li><a href="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/" rel="bookmark" title="CLR via C# - Chapter 20 Exceptions and State Management">CLR via C# - Chapter 20 Exceptions and State Management</a></li><li><a href="/2022/11/27/csharp/clr-via-csharp/Chapter%2021%20The%20Managed%20Heap%20and%20Garbage%20%20Collection/" rel="bookmark" title="CLR via C# - Chapter 21 The Managed Heap and Garbage  Collection">CLR via C# - Chapter 21 The Managed Heap and Garbage Collection</a></li><li><a href="/2022/11/28/csharp/clr-via-csharp/Chapter%2022%20CLR%20Hosting%20and%20AppDomains/" rel="bookmark" title="CLR via C# - Chapter 22 CLR Hosting and AppDomains">CLR via C# - Chapter 22 CLR Hosting and AppDomains</a></li><li class="active"><a href="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/" rel="bookmark" title="CLR via C# - Chapter 23 Assembly Loading and Reflection">CLR via C# - Chapter 23 Assembly Loading and Reflection</a></li><li><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" rel="bookmark" title="CLR via C# - Chapter 24 Runtime Serialization">CLR via C# - Chapter 24 Runtime Serialization</a></li><li><a href="/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/" rel="bookmark" title="CLR via C# - Chapter 25 Interoperating with WinRT Components">CLR via C# - Chapter 25 Interoperating with WinRT Components</a></li><li><a href="/2023/02/06/csharp/clr-via-csharp/Chapter%2026%20Thread%20Basics/" rel="bookmark" title="CLR via C# - Chapter 26 Thread Basics">CLR via C# - Chapter 26 Thread Basics</a></li><li><a href="/2023/02/07/csharp/clr-via-csharp/Chapter%2027%20Compute-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations">CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations</a></li><li><a href="/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 28 IO-Bound Asynchronous Operations">CLR via C# - Chapter 28 IO-Bound Asynchronous Operations</a></li><li><a href="/2023/02/09/csharp/clr-via-csharp/Chapter%2029%20Primitive%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 29 Primitive Thread Synchronization">CLR via C# - Chapter 29 Primitive Thread Synchronization</a></li><li><a href="/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 30 Hybrid Thread Synchronization">CLR via C# - Chapter 30 Hybrid Thread Synchronization</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Sakupinera" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Sakupinera</p><div class="description" itemprop="description">保持你的决心！</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">86</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">13</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">6</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Nha3VwaW5lcmE=" title="https:&#x2F;&#x2F;github.com&#x2F;sakupinera"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9zYWt1cGluZXJh" title="https:&#x2F;&#x2F;twitter.com&#x2F;sakupinera"><i class="ic i-twitter"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTQwNzIyOTA3MQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;407229071"><i class="ic i-cloud-music"></i></span> <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMjIzMDczOTg/c3BtX2lkX2Zyb209MzMzLjEwMDcuMC4w" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;22307398?spm_id_from&#x3D;333.1007.0.0"><i class="ic i-bilibili"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/games/" rel="section"><i class="ic i-flag"></i>Games</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-person"></i>About</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/11/28/csharp/clr-via-csharp/Chapter%2022%20CLR%20Hosting%20and%20AppDomains/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/GAMES101/" title="In GAMES101">GAMES101</a></div><span><a href="/2022/10/14/computer-graphics/games101/%E6%9D%90%E8%B4%A8%E4%B8%8E%E5%A4%96%E8%A7%82/" title="GAMES101 - Materials and Appearances（材质与外观）">GAMES101 - Materials and Appearances（材质与外观）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/09/05/linux/learn-linux/Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86/" title="LearnLinux - Linux系统管理">LearnLinux - Linux系统管理</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" title="CLR via C# - Chapter 19 Nullable Value Types">CLR via C# - Chapter 19 Nullable Value Types</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/10/15/csharp/clr-via-csharp/Chapter%205%20Primitive,%20Reference,%20and%20Value%20%20Types/" title="CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals">CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%203%20Shared%20Assemblies%20and%20Strongly%20Named%20Assemblies/" title="CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies">CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/09/04/linux/learn-linux/Shell%E7%BC%96%E7%A8%8B/" title="LearnLinux - Shell编程">LearnLinux - Shell编程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/GAMES101/" title="In GAMES101">GAMES101</a></div><span><a href="/2022/10/31/computer-graphics/games101/%E7%9B%B8%E6%9C%BA%EF%BC%8C%E9%80%8F%E9%95%9C%E5%92%8C%E5%85%89%E5%9C%BA/" title="GAMES101 - Cameras, Lenses and Light Fields（相机，透镜和光场）">GAMES101 - Cameras, Lenses and Light Fields（相机，透镜和光场）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2023/01/05/cpp/cpp-primer/Chapter%2013%20Copy%20Control/" title="C++ Primer - Chapter 13 Copy Control">C++ Primer - Chapter 13 Copy Control</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Computer-Graphics/" title="In Computer-Graphics">Computer-Graphics</a> <i class="ic i-angle-right"></i> <a href="/categories/Computer-Graphics/GAMES101/" title="In GAMES101">GAMES101</a></div><span><a href="/2022/09/06/computer-graphics/games101/%E5%90%91%E9%87%8F%E5%92%8C%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/" title="GAMES101 - 向量和线性代数">GAMES101 - 向量和线性代数</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" title="CLR via C# - Chapter 18 Custom Attributes">CLR via C# - Chapter 18 Custom Attributes</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Sakupinera @ Hanamai Sora</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">2.2m words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">33:30</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/11/29/csharp/clr-via-csharp/Chapter 23 Assembly Loading and Reflection/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/assets/shifuku.model.json"},display:{position:"left",width:250,height:500},mobile:{show:!1},react:{opacity:.9},log:!1})</script></body></html>