<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Sakupinera" href="http://sakupinera.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Sakupinera" href="http://sakupinera.github.io/atom.xml"><link rel="alternate" type="application/json" title="Sakupinera" href="http://sakupinera.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="è¯»ä¹¦ç¬”è®°,C#"><link rel="canonical" href="http://sakupinera.github.io/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/"><title>CLR via C# - Chapter 25 Interoperating with WinRT Components - CLR-via-CSharp - CSharp | Hanamai Sora = Sakupinera</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">CLR via C# - Chapter 25 Interoperating with WinRT Components</h1><div class="meta"><span class="item" title="Created: 2022-12-06 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2022-12-06T00:00:00+08:00">2022-12-06</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>51k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>46 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Hanamai Sora</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://s2.loli.net/2023/03/08/jV3gF2wSUYTdtsp.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/EXaiHD39BF7QWok.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/AK1D84aqsYghTOC.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/DFUCvo21fTb5mwG.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/Z2usRnE64TXN1Lp.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2023/03/08/J4XewNCOu8fzIy9.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/" itemprop="item" rel="index" title="In CSharp"><span itemprop="name">CSharp</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CSharp/CLR-via-CSharp/" itemprop="item" rel="index" title="In CLR-via-CSharp"><span itemprop="name">CLR-via-CSharp</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="http://sakupinera.github.io/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Sakupinera"><meta itemprop="description" content=", ä¿æŒä½ çš„å†³å¿ƒï¼"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sakupinera"></span><div class="body md" itemprop="articleBody"><h1 id="chapter-25-interoperating-with-winrt-components"><a class="anchor" href="#chapter-25-interoperating-with-winrt-components">#</a> Chapter 25 Interoperating with WinRT Components</h1><blockquote><p>Windows 8 comes with a new class library allowing applications to access operating system functionality. The formal name for this class library is the Windows Runtime (WinRT) and its components are accessible using the WinRT type system. WinRT has many of the same goals that the Common Language Runtime (CLR) had when it was first introduced, such as simplifying application development and allowing code implemented in different programming languages to easily interoperate with one another. Specifically, Microsoft supports consuming WinRT components from native C/C++, JavaScript (when using Microsoftâ€™s â€œChakraâ€ JavaScript virtual machine), as well as C# and Visual Basic via the CLR.</p></blockquote><blockquote><p>Figure 25-1 shows the kinds of features exposed by Windowsâ€™s WinRT components and the various languages that Microsoft supports to access them. For applications implemented with native C/C++, the developer must compile his or her code for each CPU architecture (x86, x64, and ARM). But Microsoft .NET Framework developers need to compile their code just once into Intermediate Language (IL) and then the CLR compiles that into the native code specific to the host CPU. JavaScript developers actually ship the source code to their application and the â€œChakraâ€ virtual machine parses the source code and compiles it into native code specific to the host machineâ€™s CPU. Other companies can produce languages and environments that support interoperating with WinRT components too.</p></blockquote><blockquote><p>Windows Store Apps and desktop applications can leverage operating system functionality by using these WinRT components. Today, the number of WinRT components that ship as part of Windows is relatively tiny when compared to the size of the .NET Frameworkâ€™s class library. However, this is by design, because the components are focused on exposing what an operating system does best: abstracting hardware and cross-application facilities to application developers. So, most of the WinRT components expose features, such as storage, networking, graphics, media, security, threading, and so on. Other core language services (like string manipulation) and more complex frameworks (like language integrated query) are not offered by the operating system and are instead provided by the language being used to access the operating systemâ€™s WinRT components.</p></blockquote><p><img data-src="/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/image-20221205200521173.png" alt="image-20221205200521173"></p><blockquote><p>WinRT components are internally implemented as Component Object Model (COM) components, which is a technology that Microsoft introduced in 1993. At the time, COM was considered a complicated model with a lot of arcane rules and a very tedious programming model. However, there are a lot of good ideas in COM, and over the years, Microsoft has tweaked it in an effort to greatly simplify it. For WinRT components, Microsoft made a very significant tweak: instead of using type libraries to describe a COM componentâ€™s API, they now use metadata. Thatâ€™s right, WinRT components describe their API using the same .NET metadata format (ECMA-335) as was standardized by the ECMA committee. This is the same metadata format Iâ€™ve been discussing throughout this whole book.</p></blockquote><blockquote><p>Metadata is much richer than type libraries and the CLR already has a complete understanding of metadata. In addition, the CLR has supported interoperating with COM components via Runtime Callable Wrappers (RCWs) and COM Callable Wrappers (CCWs) because its inception. For the most part, this allows languages (like C#) running on top of the CLR to seamlessly interoperate with WinRT types and components.</p></blockquote><blockquote><p>In C#, when you have a reference to a WinRT object, you really have a reference to an RCW that internally refers to the WinRT object. Similarly, if you pass a CLR object to a WinRT API, you are really passing a reference to a CCW to the WinRT API and the CCW holds a reference to your CLR object.</p></blockquote><blockquote><p>WinRT components have their metadata embedded in files with a .winmd file extension. The WinRT components that ship with Windows have their metadata in the various Windows.*.winmd files, which can be found in the %WinDir%\System32\WinMetadata directory. When building an app, you would reference the one Windows.winmd file that the Windows SDK installs here.</p></blockquote><pre><code class="language-cmd">%ProgramFiles(x86)%\Windows Kits\8.0\References\CommonConfiguration\Neutral\Windows.winmd
</code></pre><blockquote><p>A major design goal of the Windows Runtime type system is to enable developers to be successful in writing apps by using the technologies, tools, practices, and conventions that are already familiar and well-known to them. In order to achieve this, some WinRT features are projected to the respective development technologies. For .NET Framework developers, there are two kinds of projections:</p><ul><li><p>CLR projections CLR projections are mappings performed implicitly by the CLR, usually related to reinterpreting metadata. The next section focuses on the WinRT Component Type System Rules and how the CLR projects these rules to the .NET Framework developer.</p></li><li><p>Framework projections Framework projections are mappings performed explicitly in your code by leveraging new APIs introduced into the Framework Class Library. Framework projections are required when the impedance mismatch between the WinRT type system and the CLRâ€™s type system is too great for the CLR to do it implicitly. Framework projections are discussed later in this chapter.</p></li></ul></blockquote><p>ğŸ’¡å°ç»“ï¼šWindows 8/8.1 å¸¦æ¥äº†ä¸€ä¸ªæ–°ç±»åº“ï¼Œåº”ç”¨ç¨‹åºå¯é€šè¿‡å®ƒè®¿é—®æ“ä½œç³»ç»ŸåŠŸèƒ½ã€‚ç±»åº“æ­£å¼åç§°æ˜¯ Windows è¿è¡Œæ—¶ (Windows Runtimeï¼Œ WinRT)ï¼Œå…¶ç»„ä»¶é€šè¿‡ WinRT ç±»å‹ç³»ç»Ÿè®¿é—®ã€‚å¯¹äºåŸç”Ÿ C/C++ å®ç°çš„åº”ç”¨ç¨‹åºï¼Œå¼€å‘äººå‘˜å¿…é¡»ä¸ºæ¯ç§ CPU æ¶æ„ (x86ï¼Œx64 å’Œ ARM) å•ç‹¬ç¼–è¯‘ä»£ç ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œ.NET å¼€å‘äººå‘˜åªéœ€ç¼–è¯‘ä¸€æ¬¡ (ç¼–è¯‘æˆ ILï¼ŒCLR è‡ªè¡Œå°†å…¶ç¼–è¯‘æˆä¸ä¸»æœº CPU å¯¹åº”çš„æœ¬æœºä»£ç )ã€‚JavaScript åº”ç”¨ç¨‹åºåˆ™è‡ªå¸¦äº†æºä»£ç ï¼Œâ€œChakraâ€ è™šæ‹Ÿæœºè§£æè¿™äº›æºä»£ç ï¼ŒæŠŠå®ƒç¼–è¯‘æˆä¸ä¸»æœº CPU å¯¹åº”çš„æœ¬æœºä»£ç ã€‚Windows é…å¥—æä¾›çš„ WinRT ç»„ä»¶æ•°é‡æ¯” .NET Framework ç±»åº“å°å¤šäº†ã€‚ä½†è®¾è®¡å°±æ˜¯è¿™æ ·çš„ï¼Œç»„ä»¶çš„ç›®çš„æ˜¯å…¬å¼€æ“ä½œç³»ç»Ÿæœ€æ“…é•¿çš„äº‹æƒ…ï¼Œä¹Ÿå°±æ˜¯å¯¹ç¡¬ä»¶å’Œè·¨åº”ç”¨ç¨‹åºçš„åŠŸèƒ½è¿›è¡ŒæŠ½è±¡ã€‚æ‰€ä»¥ï¼Œå¤§å¤šæ•° WinRT ç»„ä»¶éƒ½åªæ˜¯å…¬å¼€äº†åŠŸèƒ½ï¼Œæ¯”å¦‚å­˜å‚¨ã€è”ç½‘ã€å›¾å½¢ã€åª’ä½“ã€å®‰å…¨æ€§ã€çº¿ç¨‹å¤„ç†ç­‰ã€‚è€Œå…¶ä»–æ ¸å¿ƒè¯­è¨€æœåŠ¡ (æ¯”å¦‚å­—ç¬¦ä¸²æ“ä½œ) å’Œè¾ƒå¤æ‚çš„æ¡†æ¶ (æ¯”å¦‚ LINQ) ä¸æ˜¯ç”±æ“ä½œç³»ç»Ÿæä¾›ï¼Œè€Œæ˜¯ç”±è®¿é—® WinRT ç»„ä»¶çš„è¯­è¨€æä¾›ã€‚WinRT ç»„ä»¶å†…éƒ¨ä½œä¸º â€œç»„ä»¶å¯¹è±¡æ¨¡å‹â€(Component Object Modelï¼ŒCOM) ç»„ä»¶æ¥å®ç°ï¼Œåè€…æ˜¯ Microsoft 1993 å¹´æ¨å‡ºçš„æŠ€æœ¯ã€‚COM å½“å¹´è¢«è®¤ä¸ºè¿‡äºå¤æ‚ï¼Œè§„åˆ™è¿‡äºéš¾è§£ï¼Œæ˜¯ä¸€ä¸ªå¾ˆè®©äººå¤´ç–¼çš„ç¼–ç¨‹æ¨¡å‹ã€‚ä½† COM å®é™…æ˜¯æœ‰è®¸å¤šäº®ç‚¹çš„ã€‚å¤šå¹´æ¥ï¼ŒMicrosoft å¯¹å…¶è¿›è¡Œäº†å¤§é‡ä¿®è®¢ï¼Œæ˜¾è‘—åœ°è¿›è¡Œäº†ç®€åŒ–ã€‚Microsoft å¯¹ WinRT ç»„ä»¶è¿›è¡Œäº†ä¸€ä¸ªå¾ˆå¤§çš„è°ƒæ•´ï¼Œä¸æ˜¯ä½¿ç”¨ç±»åº“æ¥æè¿° COM ç»„ä»¶çš„ APIï¼Œè€Œæ˜¯ä½¿ç”¨å…ƒæ•°æ®ã€‚ä½ æ²¡æœ‰çœ‹é”™ï¼ŒWinRT ç»„ä»¶ä½¿ç”¨ç”± ECMA åä¼šæ ‡å‡†åŒ–çš„ .NET å…ƒæ•°æ®æ ¼å¼ (ECMA-335) æ¥æè¿°å…¶ APIã€‚è¿™ä¸ªå…ƒæ•°æ®æ ¼å¼æ­£æ˜¯æœ¬ä¹¦ä¸€ç›´åœ¨è®¨è®ºçš„ã€‚å…ƒæ•°æ®æ¯”ç±»åº“æ›´æœ‰è¡¨ç°åŠ›ï¼Œè€Œä¸” CLR å·²ç»å¯¹å…ƒæ•°æ®æœ‰äº†å…¨é¢ç†è§£ã€‚æ­¤å¤–ï¼ŒCLR ä¸€å¼€å§‹å°±é€šè¿‡è¿è¡Œæ—¶å¯è°ƒç”¨åŒ…è£…å™¨ (Runtime Callable Wrapperï¼ŒRCW) å’Œ COM å¯è°ƒç”¨åŒ…è£…å™¨ (COM Callable Wrapperï¼ŒCCW) å®ç°äº†ä¸ COM ç»„ä»¶çš„äº’æ“ä½œã€‚è¿™ä½¿åœ¨ CLR é¡¶éƒ¨è¿è¡Œçš„è¯­è¨€ (å¦‚ C#) èƒ½æ— ç¼åœ°ä¸ WinRT ç±»å‹å’Œç»„ä»¶è¿›è¡Œäº’æ“ä½œã€‚åœ¨ C# ä¸­å¼•ç”¨ WinRT å¯¹è±¡ï¼Œå®é™…è·å¾—çš„æ˜¯å¯¹ä¸€ä¸ª RCW çš„å¼•ç”¨ï¼ŒRCW å†…éƒ¨å¼•ç”¨äº† WinRT ç»„ä»¶ã€‚ç±»ä¼¼åœ°ï¼Œå°†ä¸€ä¸ª CLR å¯¹è±¡ä¼ ç»™ WinRT APIï¼Œå®é™…ä¼ é€’çš„æ˜¯ä¸€ä¸ª CCW å¼•ç”¨ï¼ŒCCW å†…éƒ¨å®¹çº³äº†å¯¹ CLR å¯¹è±¡çš„å¼•ç”¨ã€‚WinRT ç»„ä»¶å°†å…ƒæ•°æ®åµŒå…¥æ‰©å±•åä¸º .winmd çš„æ–‡ä»¶ä¸­ (winmd ä»£è¡¨ Windows MetaData)ã€‚Windows æ­è½½çš„ WinRT ç»„ä»¶å°†å…ƒæ•°æ®å­˜å‚¨åˆ°å„ç§ Windows.*.winmd æ–‡ä»¶ä¸­ï¼Œè¿™äº›æ–‡ä»¶å¯åœ¨ % WinDir%\System32\WinMetadata ç›®å½•ä¸­æ‰¾åˆ°ã€‚Windows Runtime ç±»å‹ç³»ç»Ÿçš„ä¸€ä¸ªä¸»è¦è®¾è®¡ç›®æ ‡æ˜¯ä½¿å¼€å‘äººå‘˜èƒ½ä½¿ç”¨ä»–ä»¬æ“…é•¿çš„æŠ€æœ¯ã€å·¥å…·ã€å®è·µä»¥åŠçº¦å®šå†™åº”ç”¨ã€‚ä¸ºæ­¤ï¼Œæœ‰çš„ WinRT åŠŸèƒ½è¢«æŠ•å°„ &lt; sup&gt;â‘¡&lt;/sup &gt; æˆå¯¹åº”çš„å¼€å‘æŠ€æœ¯ã€‚<span class="exturl" data-url="aHR0cDovL3huLS1jZXQxOTJrLk5FVA==">é’ˆå¯¹.NET</span> Framework å¼€å‘äººå‘˜ä¸»è¦æœ‰ä¸¤ç§æŠ•å°„ï¼šCLR æŠ•å°„å’Œ Framework æŠ•å°„ã€‚CLR æŠ•å°„ç”± CLR éšå¼æ‰§è¡Œï¼Œé€šå¸¸å’Œå…ƒæ•°æ®çš„é‡å†™è§£é‡Šæœ‰å…³ã€‚Framework æŠ•å°„ç”±ä½ çš„ä»£ç æ˜¾å¼æ‰§è¡Œï¼Œè¿™æ˜¯é€šè¿‡ FCL æ–°å¼•å…¥çš„ API æ¥æ‰§è¡Œçš„ã€‚å¦‚æœ WinRT ç±»å‹ç³»ç»Ÿå’Œ CLR ç±»å‹ç³»ç»Ÿå·®å¼‚å¤ªå¤§ï¼Œé€ æˆ CLR ä¸èƒ½éšå¼åœ°æŠ•å°„ï¼Œå°±éœ€è¦ç”¨åˆ° Framework æŠ•å°„ã€‚</p><h2 id="clr-projections-and-winrt-component-type-system-rules"><a class="anchor" href="#clr-projections-and-winrt-component-type-system-rules">#</a> CLR Projections and WinRT Component Type System Rules</h2><blockquote><p>WinRT components conform to a type system similar to how the CLR enforces a type system. When the CLR sees a WinRT type, it usually allows that type to be used via the CLRs normal COM interop technologies. But, in some cases, the CLR hides the WinRT type (by dynamically setting it to private) and then the CLR exposes the type via a different type. Internally, the CLR is looking for certain types (via metadata) and then mapping these types to types in the Framework Class Library. For the complete list of WinRT types that the CLR implicitly projects to Framework Class Library types, see http:// <span class="exturl" data-url="aHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L3dpbmRvd3MvYXBwcy9oaDk5NTA1MC5hc3B4">msdn.microsoft.com/en-us/library/windows/apps/hh995050.aspx</span>.</p></blockquote><h3 id="winrt-type-system-core-concepts"><a class="anchor" href="#winrt-type-system-core-concepts">#</a> WinRT Type System Core Concepts</h3><blockquote><p>The WinRT type system is not as feature rich as the CLRâ€™s type system. This bulleted list describes the WinRT type systemâ€™s core concepts and how the CLR projects them:</p><ul><li><p>File names and namespaces The name of the .winmd file itself must match the name of the namespace containing the WinRT components. For example, a file named Wintellect. WindowsStore.winmd must have WinRT components defined in a Wintellect.WindowsStore namespace or in a sub-namespace of Wintellect.WindowsStore. Because the Windows file system is case insensitive, namespaces that differ by case only are not allowed. Also, a WinRT component cannot have the same name as a namespace.</p></li><li><p>Common base type WinRT components do not share a common base class. When the CLR projects a WinRT type, it appears as if the WinRT type is derived from System.Object and therefore all WinRT types inherit public methods like ToString, GetHashCode, Equals, and GetType. So, when using a WinRT object via C#, the object will look like it is derived from System.Object, and you can pass WinRT objects throughout your code. You can also call the â€œinheritedâ€ methods such as ToString.</p></li><li><p>Core data types The WinRT type system supports the core data types such as Boolean, unsigned byte, 16-bit, 32-bit, and 64-bit signed and unsigned integer numbers, single-precision and double-precision floating-point numbers, 16-bit character, strings, and void.1 Like in the CLR, all other data types are composed from these core data types.</p></li><li><p>Classes WinRT is an object-oriented type system, meaning that WinRT components support data abstraction, inheritance, and polymorphism.2 However, some languages (like JavaScript) do not support type inheritance and in order to cater to these languages, almost no WinRT components take advantage of inheritance. This means they also do not take advantage of polymorphism. In fact, only WinRT components consumable from non-JavaScript languages leverage inheritance and polymorphism. For the WinRT components that ship with Windows, only the XAML components (for building user interfaces) take advantage of inheritance and polymorphism. Applications written in JavaScript use HTML and CSS to produce their user interface instead.</p></li><li><p>Structures WinRT supports structures (value types), and instances of these are marshaled by value across the COM interoperability boundary. Unlike CLR value types, WinRT structures can only have public fields of the core data types or of another WinRT structure.3 In addition, WinRT structures cannot have any constructors or helper methods. For convenience, the CLR projects some operating system WinRT structures as some native CLR types, which do offer constructors and helper methods. These projected types feel more natural to the CLR developer. Examples include the Point, Rect, Size, and TimeSpan structures all defined in the Windows.Foundation namespace.</p></li><li><p>Nullable Structures WinRT APIs can expose nullable structures (value types). The CLR projects the WinRTâ€™s Windows.Foundation.IReference interface as the CLRâ€™s System.Nullable type.</p></li><li><p>Enumerations An enumeration value is simply passed as a signed or unsigned 32-bit integer. If you define an enumeration type in C#, the underlying type must be either int or uint. Also, signed 32-bit integer enums are considered to be discreet values, whereas unsigned 32-bit enums are considered to be flags capable of being ORâ€™d together.</p></li><li><p>Interfaces A WinRT interfaceâ€™s members must specify only WinRT-compatible types for parameters and return types.</p></li><li><p>Methods WinRT has limited support for method overloading. Specifically, because JavaScript has dynamic typing, it canâ€™t distinguish between methods that differ only by the types of their parameters. For example, JavaScript will happily pass a number to a method expecting a string. However, JavaScript can distinguish between a method that takes one parameter and a method that takes two parameters. In addition, WinRT does not support operator overload methods and default argument values. Furthermore, arguments can only be marshaled in or out; never in and out. This means you canâ€™t apply ref to a method argument but out is OK. For more information about this, see the â€œArraysâ€ bullet point in the next list.</p></li><li><p>Properties WinRT properties must specify only WinRT-compatible types for their data type. WinRT does not support parameterful properties or write-only properties.</p></li><li><p>Delegates WinRT delegate types must specify only WinRT components for parameter types and return types. When passing a delegate to a WinRT component, the delegate object is wrapped with a CCW and will not get garbage collected until the CCW is released by the WinRT component consuming it. WinRT delegates do not have BeginInvoke and EndInvoke methods.</p></li><li><p>Events WinRT components can expose events by using a WinRT delegate type. Because most WinRT components are sealed (no inheritance), WinRT defines a TypedEventHandler delegate where the sender parameter is a generic type (as opposed to System.Object).</p></li></ul></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">TypedEventHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TSender<span class="token punctuation">,</span> TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">TSender</span> sender<span class="token punctuation">,</span> <span class="token class-name">TResult</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><blockquote><p>There is also a Windows.Foundation.EventHandler WinRT delegate type that the CLR projects as the .NET Frameworkâ€™s familiar System.EventHandler delegate type.</p><ul><li><p>Exceptions Under the covers, WinRT components, like COM components, indicate their status via HRESULT values (a 32-bit integer with special semantics). The CLR projects WinRT values of type Windows.Foundation.HResult as exception objects. When a WinRT API returns a well-known failure HRESULT value, the CLR throws an instance of a corresponding Exceptionderived class. For instance, the HRESULT 0x8007000e (E_OUTOFMEMORY) is mapped to a System.OutOfMemoryException. Other HRESULT values cause the CLR to throw a System. Exception object whose HResult property contains the HRESULT value. A WinRT component implemented in C# can just throw an exception of a desired type and the CLR will convert it to an appropriate HRESULT value. To have complete control over the HRESULT value, construct an exception object, assign a specific HRESULT value in the objectâ€™s HResult property, and then throw the object.</p></li><li><p>Strings Of course, you can pass immutable strings between the WinRT and CLR type systems. However, the WinRT type system doesnâ€™t allow a string to have a value of null. If you pass null to a string parameter of a WinRT API, the CLR detects this and throws an ArgumentNullException; instead, use String.Empty to pass an empty string into a WinRT API. Strings are passed by reference to a WinRT API; they are pinned on the way in and unpinned upon return. Strings are always copied when returned from a WinRT API back to the CLR. When passing a CLR string array (String[]) to or from a WinRT API, a copy of the array is made with all its string elements and the copy is passed or returned to the other side.</p></li><li><p>Dates and Times The WinRT Windows.Foundation.DateTime structure represents a UTC date/time. The CLR projects the WinRT DateTime structure as the .NET Frameworkâ€™s System.DateTimeOffset structure, because DateTimeOffset is preferred over the .NET Frameworkâ€™s System.DateTime structure. The CLR converts the UTC date/time being returned from a WinRT to local time in the resulting DateTimeOffset instance. The CLR passes a DateTimeOffet to a WinRT API as a UTC time.</p></li><li><p>URIs The CLR projects the WinRT Windows.Foundation.Uri type as the .NET Frameworkâ€™s System.Uri type. When passing a .NET Framework Uri to a WinRT API, the CLR throws an ArgumentException if the URI is a relative URI; WinRT supports absolute URIs only. URIs are always copied across the interop boundary.</p></li><li><p>IClosable/IDisposable The CLR projects the WinRT Windows.Foundation.IClosable interface (which has only a Close method) as the .NET Frameworkâ€™s System.IDisposable interface (with its Dispose method). One thing to really take note of here is that all WinRT APIs that perform I/O operations are implemented asynchronously. Because IClosable interfaceâ€™s method is called Close and is not called CloseAsync, the Close method must not perform any I/O operations. This is semantically different from how Dispose usually works in the .NET Framework. For .NET Framework-implemented types, calling Dispose can do I/O and, in fact, it frequently causes buffered data to be written before actually closing a device. When C# code calls Dispose on a WinRT type however, I/O (like writing buffered data) will not be performed and a loss of data is possible. You must be aware of this and, for WinRT components that wrap output streams, you will have to explicitly call methods to prevent data loss. For example, when using a DataWriter, you should always call its StoreAsync method.</p></li><li><p>Arrays WinRT APIs support single-dimension, zero-based arrays. WinRT can marshal an arrayâ€™s elements in or out of a method; never in and out. Because of this, you cannot pass an array into a WinRT API, have the API modify the arrayâ€™s elements and then access the modified elements after the API returns.4 I have just described the contract that should be adhered to. However, this contract is not actively enforced, so it is possible that some projections might marshal array contents both in and out. This usually happens naturally due to improving performance. For example, if the array contains structures, the CLR will simply pin the array, pass it to the WinRT API, and then unpin it upon return. In effect, the arrayâ€™s contents are passed in, the WinRT API can modify the contents and, in effect, the modified contents are returned. However, in this example, the WinRT API is violating the contract and this behavior is not guaranteed to work. And, in fact, it will not work if the API is invoked on a WinRT component that is running out-of-process.</p></li><li><p>Collections When passing a collection to a WinRT API, the CLR wraps the collection object with a CCW and passes a reference to the CCW to the WinRT API. When WinRT code invokes a member on the CCW, the calling thread crosses the interop boundary, thereby incurring a performance hit. Unlike arrays, this means that passing a collection to a WinRT API allows the API to manipulate the collection in place, and copies of the collectionâ€™s elements are not being created. Table 25-1 shows the WinRT collection interfaces and how the CLR projects them to .NET application code.</p></li></ul></blockquote><p><img data-src="/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/image-20221205201049228.png" alt="image-20221205201049228"></p><blockquote><p>As you can see from the previous list, the CLR team has done a lot of work to make interoperating between the WinRT type system and the CLRâ€™s type system as seamless as possible so that it is easy for managed code developers to leverage WinRT components in their code.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šå°±åƒ CLR å¼ºåˆ¶éµå¾ªä¸€ä¸ªç±»å‹ç³»ç»Ÿï¼ŒWinRT ç»„ä»¶ä¹Ÿéµå¾ªè‡ªå·±çš„ç±»å‹ç³»ç»Ÿã€‚CLR çœ‹åˆ°ä¸€ä¸ª WinRT ç±»å‹æ—¶ï¼Œé€šå¸¸å…è®¸é€šè¿‡ CLR çš„ä¸€èˆ¬åŒ– COM äº’æ“ä½œæŠ€æœ¯æ¥ä½¿ç”¨è¯¥ç±»å‹ã€‚ä½†æœ‰æ—¶ CLR ä¼šéšè— WinRT ç±»å‹ (å°†å…¶åŠ¨æ€è®¾ä¸ºç§æœ‰)ã€‚ç„¶åï¼ŒCLR é€šè¿‡ä¸€ä¸ªä¸åŒçš„ç±»å‹æ¥å…¬å¼€è¯¥ç±»å‹ã€‚åœ¨å†…éƒ¨ï¼ŒCLR ä¼šæŸ¥æ‰¾ç‰¹å®šçš„ç±»å‹ (é€šè¿‡å…ƒæ•°æ®)ï¼Œç„¶åå°†è¿™äº›ç±»å‹æ˜ å°„æˆ FCL çš„ç±»å‹ã€‚</p><h2 id="framework-projections"><a class="anchor" href="#framework-projections">#</a> Framework Projections</h2><blockquote><p>When the CLR canâ€™t implicitly project a WinRT type to the .NET Framework developer, the developer must resort to explicitly using framework projections. There are three main technologies where framework projections are required: asynchronous programming, interoperating between WinRT streams and .NET Framework streams, and when passing blocks of data between the CLR and WinRT APIs. These three framework projections are discussed in the following three sections of this chapter. Because many applications require the use of these technologies, it is important that you understand them well and use them effectively.</p></blockquote><h3 id="calling-asynchronous-winrt-apis-from-net-code"><a class="anchor" href="#calling-asynchronous-winrt-apis-from-net-code">#</a> Calling Asynchronous WinRT APIs from .NET Code</h3><blockquote><p>When a thread performs an I/O operation synchronously, the thread can block for an indefinite amount of time. When a GUI thread waits for a synchronous I/O operation to complete, the applicationâ€™s user interface stops responding to user input, such as touch, mouse, and stylus events, causing the user to get frustrated with the application. To prevent non-responsive applications, WinRT components that perform I/O operations expose the functionality via asynchronous APIs. In fact, WinRT components that perform compute operations also expose this functionality via asynchronous APIs if the CPU operation could take greater than 50 milliseconds. For more information about building responsive applications, see Part V, â€œThreadingâ€ of this book.</p></blockquote><blockquote><p>Because so many WinRT APIs are asynchronous, being productive with them requires that you understand how to interoperate with them from C#. To understand it, examine the following code.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WinRTAsyncIntro</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name">IAsyncOperation<span class="token punctuation">&lt;</span>StorageFile<span class="token punctuation">></span></span> asyncOp <span class="token operator">=</span> KnownFolders<span class="token punctuation">.</span>MusicLibrary<span class="token punctuation">.</span><span class="token function">GetFileAsync</span><span class="token punctuation">(</span><span class="token string">"Song.mp3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> asyncOp<span class="token punctuation">.</span>Completed <span class="token operator">=</span> OpCompleted<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// Optional: call asyncOp.Cancel() sometime later</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// NOTE: Callback method executes via GUI or thread pool thread:</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OpCompleted</span><span class="token punctuation">(</span><span class="token class-name">IAsyncOperation<span class="token punctuation">&lt;</span>StorageFile<span class="token punctuation">></span></span> asyncOp<span class="token punctuation">,</span> <span class="token class-name">AsyncStatus</span> status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">case</span> AsyncStatus<span class="token punctuation">.</span>Completed<span class="token punctuation">:</span> <span class="token comment">// Process result</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token class-name">StorageFile</span> file <span class="token operator">=</span> asyncOp<span class="token punctuation">.</span><span class="token function">GetResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Completed... */</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">case</span> AsyncStatus<span class="token punctuation">.</span>Canceled<span class="token punctuation">:</span> <span class="token comment">// Process cancellation </span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">/* Canceled... */</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">case</span> AsyncStatus<span class="token punctuation">.</span>Error<span class="token punctuation">:</span> <span class="token comment">// Process exception</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token class-name">Exception</span> exception <span class="token operator">=</span> asyncOp<span class="token punctuation">.</span>ErrorCode<span class="token punctuation">;</span> <span class="token comment">/* Error... */</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> asyncOp<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The WinRTAsyncIntro method invokes the WinRT GetFileAsync method to find a file in the userâ€™s music library. All WinRT APIs that perform asynchronous operations are named with the Async suffix and they all return an object whose type implements a WinRT IAsyncXxx interface; in this example, an IAsyncOperation interface where TResult is the WinRT StorageFile type. This object, whose reference I put in an asyncOp variable, represents the pending asynchronous operation. Your code must somehow receive notification when the pending operation completes. To do this, you must implement a callback method (OpCompleted in my example), create a delegate to it, and assign the delegate to the asyncOpâ€™s Completed property. Now, when the operation completes, the callback method is invoked via some thread (not necessarily the GUI thread). If the operation completed before assigning the delegate to the OnCompleted property, then the system will invoke the callback as soon as possible. In other words, there is a race condition here, but the object implementing the IAsyncXxx interface resolves the race for you, ensuring that your code works correctly.</p></blockquote><blockquote><p>As noted at the end of the WinRTAsyncIntro method, you can optionally call a Cancel method offered by all IAsyncXxx interfaces if you want to cancel the pending operation. All asynchronous operations complete for one of three possible reasons: the operation runs to completion successfully, the operation is explicitly canceled, or the operation results in a failure. When the operation completes due to any of these reasons, the system invokes the callback method, passes it a reference to the same object that the original XxxAsync method returned, and an AsyncStatus. In my OnCompleted method, I examine the status parameter and either process the result due to the successful completion, handle the explicit cancellation, or handle the failure.6 Also, note that after processing the operationâ€™s completion, the IAsyncXxx interface object should be cleaned up by calling its Close method.</p></blockquote><blockquote><p>Figure 25-2 shows the various WinRT IAsyncXxx interfaces. The four main interfaces all derive from the IAsyncInfo interface. The two IAsyncAction interfaces give you a way to know when the operation has completed, but their operations complete with no return value (their GetResults methods have a void return type). The two IAsyncOperation interfaces also give you a way to know when the operation has completed and allow you to get their return value (their GetResults methods have a generic TResult return type).</p></blockquote><blockquote><p>The two IAsyncXxxWithProgress interfaces allow your code to receive periodic progress updates as the asynchronous operation is progressing through its work. Most asynchronous operations do not offer progress updates but some (like background downloading and uploading) do. To receive periodic progress updates, you would define another callback method in your code, create a delegate that refers to it, and assign the delegate to the IAsyncXxxWithProgress objectâ€™s Progress property. When your callback method is invoked, it is passed an argument whose type matches the generic TProgress type.</p></blockquote><p><img data-src="/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/image-20221205201500265.png" alt="image-20221205201500265"></p><blockquote><p>In the .NET Framework, we use the types in the System.Threading.Tasks namespace to simplify performing asynchronous operations. I explain these types and how to use them to perform compute operations in Chapter 27, â€œCompute-Bound Asynchronous Operations,â€ and how to use them to perform I/O operations in Chapter 28, â€œI/O-Bound Asynchronous Operations.â€ In addition, C# offers the async and await keywords, which allow you to perform asynchronous operations by using a sequential programming model, thereby simplifying your code substantially.</p></blockquote><blockquote><p>The following code is a rewrite of the WinRTAsyncIntro method previously mentioned. However, this version is leveraging some extension methods supplied with the .NET Framework, which turn the WinRT asynchronous programming model into the more convenient C# programming model.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> <span class="token comment">// Required for extension methods in WindowsRuntimeSystemExtensions</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WinRTAsyncIntro</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token class-name">StorageFile</span> file <span class="token operator">=</span> <span class="token keyword">await</span> KnownFolders<span class="token punctuation">.</span>MusicLibrary<span class="token punctuation">.</span><span class="token function">GetFileAsync</span><span class="token punctuation">(</span><span class="token string">"Song.mp3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">/* Completed... */</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OperationCanceledException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* Canceled... */</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SomeOtherException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* Error... */</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Whatâ€™s happening here is that the use of C#â€™s await operator causes the compiler to look for a GetAwaiter method on the IAsyncOperation interface returned from the GetFileAsync method. This interface doesnâ€™t provide a GetAwaiter method, and so, the compiler looks for an extension method. Fortunately, the .NET Framework team has provided in System.Runtime.WindowsRuntime.dll a bunch of extension methods callable when you have one of WinRTâ€™s IAsyncXxx interfaces.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">namespace</span> <span class="token namespace">System</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WindowsRuntimeSystemExtensions</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">TaskAwaiter</span> <span class="token function">GetAwaiter</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IAsyncAction</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">TaskAwaiter</span> <span class="token generic-method"><span class="token function">GetAwaiter</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TProgress<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IAsyncActionWithProgress<span class="token punctuation">&lt;</span>TProgress<span class="token punctuation">></span></span> </pre></td></tr><tr><td data-num="5"></td><td><pre>source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">TaskAwaiter<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">GetAwaiter</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IAsyncOperation<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span> </pre></td></tr><tr><td data-num="7"></td><td><pre>source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">TaskAwaiter<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">GetAwaiter</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">,</span> TProgress<span class="token punctuation">></span></span></span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">this</span> <span class="token class-name">IAsyncOperationWithProgress<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">,</span> TProgress<span class="token punctuation">></span></span> source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Internally, all these methods construct a TaskCompletionSource and tell the IAsyncXxx object to invoke a callback that sets the TaskCompletionSourceâ€™s final state when the asynchronous operation completes. The TaskAwaiter object returned from these extension methods is ultimately what C# awaits. When the asynchronous operation completes, the TaskAwaiter object ensures that the code continues executing via the SynchronizationContext (discussed in Chapter 28) that is associated with the original thread. Then, the thread executes the C# compiler generated code, which queries the TaskCompletionSourceâ€™s Taskâ€™s Result property, which returns the result (a StorageFile in my example), throws an OperationCanceledException in case of cancellation, or throws some other exception if a failure occurred. For an example of how these methods work internally, see the code at the end of this section.</p></blockquote><blockquote><p>What I have just shown is the common scenario of calling an asynchronous WinRT API and discovering its outcome. But, in the previous code, I showed how to find out if cancellation occurred, but I didnâ€™t show how to actually cancel the operation. In addition, I didnâ€™t show how to deal with progress updates. To properly handle cancellation and progress updates, instead of having the compiler automatically call one of the GetAwaiter extension methods shown earlier, you would explicitly call one of the AsTask extension methods that the WindowsRuntimeSystemExtensions class also defines.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">namespace</span> <span class="token namespace">System</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WindowsRuntimeSystemExtensions</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task</span> <span class="token generic-method"><span class="token function">AsTask</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TProgress<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IAsyncActionWithProgress<span class="token punctuation">&lt;</span>TProgress<span class="token punctuation">></span></span> source<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">,</span> <span class="token class-name">IProgress<span class="token punctuation">&lt;</span>TProgress<span class="token punctuation">></span></span> progress<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">AsTask</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">,</span> TProgress<span class="token punctuation">></span></span></span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">this</span> <span class="token class-name">IAsyncOperationWithProgress<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">,</span> TProgress<span class="token punctuation">></span></span> source<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">,</span> <span class="token class-name">IProgress<span class="token punctuation">&lt;</span>TProgress<span class="token punctuation">></span></span> progress<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Simpler overloads not shown here</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>So now, let me show you the complete picture. Here is how to call an asynchronous WinRT API and fully leverage cancellation and progress for those times when you need these enhancements.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span> <span class="token comment">// For WindowsRuntimeSystemExtensionsâ€™s AsTask</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading</span><span class="token punctuation">;</span> <span class="token comment">// For CancellationTokenSource</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">CancellationTokenSource</span> m_cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// NOTE: If invoked by GUI thread, all code executes via GUI thread:</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MappingWinRTAsyncToDotNet</span><span class="token punctuation">(</span><span class="token class-name">WinRTType</span> someWinRTObj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token comment">// Assume XxxAsync returns IAsyncOperationWithProgress&lt;IBuffer, UInt32> </span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token class-name">IBuffer</span> result <span class="token operator">=</span> <span class="token keyword">await</span> someWinRTObj<span class="token punctuation">.</span><span class="token function">XxxAsync</span><span class="token punctuation">(</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">.</span><span class="token function">AsTask</span><span class="token punctuation">(</span>m_cts<span class="token punctuation">.</span>Token<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Progress<span class="token punctuation">&lt;</span>UInt32<span class="token punctuation">></span></span><span class="token punctuation">(</span>ProgressReport<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">/* Completed... */</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OperationCanceledException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* Canceled... */</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SomeOtherException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* Error... */</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ProgressReport</span><span class="token punctuation">(</span><span class="token class-name">UInt32</span> progress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* Update progress... */</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> m_cts<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// Called sometime later</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>I know that some readers would like to understand how these AsTask methods internally convert a WinRT IAsyncXxx into a .NET Framework Task that can ultimately be awaited. The following code shows how the most complicated AsTask method is effectively implemented internally. The simpler overloads are, of course, simpler than this.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">AsTask</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TResult<span class="token punctuation">,</span> TProgress<span class="token punctuation">></span></span></span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">this</span> <span class="token class-name">IAsyncOperationWithProgress<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">,</span> TProgress<span class="token punctuation">></span></span> asyncOp<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name">CancellationToken</span> ct <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name">IProgress<span class="token punctuation">&lt;</span>TProgress<span class="token punctuation">></span></span> progress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// When CancellationTokenSource is canceled, cancel the async operation</span></pre></td></tr><tr><td data-num="6"></td><td><pre> ct<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> asyncOp<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// When the async operation reports progress, report it to the progress callback </span></pre></td></tr><tr><td data-num="8"></td><td><pre> asyncOp<span class="token punctuation">.</span>Progress <span class="token operator">=</span> <span class="token punctuation">(</span>asyncInfo<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">=></span> progress<span class="token punctuation">.</span><span class="token function">Report</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token comment">// This TaskCompletionSource monitors the async operation's completion</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> tcs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskCompletionSource<span class="token punctuation">&lt;</span>TResult<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// When the async operation completes, notify the TaskCompletionSource</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token comment">// Code awaiting the TaskCompletionSource regains control when this happens</span></pre></td></tr><tr><td data-num="13"></td><td><pre> asyncOp<span class="token punctuation">.</span>Completed <span class="token operator">=</span> <span class="token punctuation">(</span>asyncOp2<span class="token punctuation">,</span> asyncStatus<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">switch</span> <span class="token punctuation">(</span>asyncStatus<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token keyword">case</span> AsyncStatus<span class="token punctuation">.</span>Completed<span class="token punctuation">:</span> tcs<span class="token punctuation">.</span><span class="token function">SetResult</span><span class="token punctuation">(</span>asyncOp2<span class="token punctuation">.</span><span class="token function">GetResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">case</span> AsyncStatus<span class="token punctuation">.</span>Canceled<span class="token punctuation">:</span> tcs<span class="token punctuation">.</span><span class="token function">SetCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token keyword">case</span> AsyncStatus<span class="token punctuation">.</span>Error<span class="token punctuation">:</span> tcs<span class="token punctuation">.</span><span class="token function">SetException</span><span class="token punctuation">(</span>asyncOp2<span class="token punctuation">.</span>ErrorCode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// When calling code awaits this returned Task, it calls GetAwaiter, which </span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token comment">// wraps a SynchronizationContext around the Task ensuring that completion </span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token comment">// occurs on the SynchronizationContext object's context</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token keyword">return</span> tcs<span class="token punctuation">.</span>Task<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="interoperating-between-winrt-streams-and-net-streams"><a class="anchor" href="#interoperating-between-winrt-streams-and-net-streams">#</a> Interoperating Between WinRT Streams and .NET Streams</h3><blockquote><p>There are many .NET Framework classes that operate on System.IO.Stream-derived types, such as serialization and LINQ to XML. To use a WinRT object that implements WinRTâ€™s IStorageFile or IStorageFolder interfaces with a .NET Framework class that requires a Stream-derived type, we leverage extension methods defined in the System.IO.WindowsRuntimeStorageExtensions class.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">namespace</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Defined in System.Runtime.WindowsRuntime.dll</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WindowsRuntimeStorageExtensions</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Stream<span class="token punctuation">></span></span> <span class="token function">OpenStreamForReadAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IStorageFile</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Stream<span class="token punctuation">></span></span> <span class="token function">OpenStreamForWriteAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IStorageFile</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Stream<span class="token punctuation">></span></span> <span class="token function">OpenStreamForReadAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IStorageFolder</span> rootDirectory<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token class-name">String</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Stream<span class="token punctuation">></span></span> <span class="token function">OpenStreamForWriteAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IStorageFolder</span> rootDirectory<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token class-name">String</span> relativePath<span class="token punctuation">,</span> <span class="token class-name">CreationCollisionOption</span> creationCollisionOption<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Here is an example that uses one of the extension methods to open a WinRT StorageFile and read its contents into a .NET Framework XElement object.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>XElement<span class="token punctuation">></span></span> <span class="token function">FromStorageFileToXElement</span><span class="token punctuation">(</span><span class="token class-name">StorageFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">Stream</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> file<span class="token punctuation">.</span><span class="token function">OpenStreamForReadAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">return</span> XElement<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Finally, the System.IO.WindowsRuntimeStreamExtensions class offers extension methods that â€œcastâ€ WinRT stream interfaces (such as IRandomAccessStream, IInputStream or IOutputStream) to the .NET Framework's Stream type and vice versa.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">namespace</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Defined in System.Runtime.WindowsRuntime.dll</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WindowsRuntimeStreamExtensions</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Stream</span> <span class="token function">AsStream</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IRandomAccessStream</span> winRTStream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Stream</span> <span class="token function">AsStream</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IRandomAccessStream</span> winRTStream<span class="token punctuation">,</span> <span class="token class-name">Int32</span> bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Stream</span> <span class="token function">AsStreamForRead</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IInputStream</span> winRTStream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Stream</span> <span class="token function">AsStreamForRead</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IInputStream</span> winRTStream<span class="token punctuation">,</span> <span class="token class-name">Int32</span> bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Stream</span> <span class="token function">AsStreamForWrite</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IOutputStream</span> winRTStream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Stream</span> <span class="token function">AsStreamForWrite</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IOutputStream</span> winRTStream<span class="token punctuation">,</span> <span class="token class-name">Int32</span> bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IInputStream</span> AsInputStream <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Stream</span> clrStream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IOutputStream</span> <span class="token function">AsOutputStream</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Stream</span> clrStream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Here is an example that uses one of the extension methods to â€œcastâ€ a WinRT IInputStream to a .NET Framework Stream object.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token return-type class-name">XElement</span> <span class="token function">FromWinRTStreamToXElement</span><span class="token punctuation">(</span><span class="token class-name">IInputStream</span> winRTStream<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name">Stream</span> netStream <span class="token operator">=</span> winRTStream<span class="token punctuation">.</span><span class="token function">AsStreamForRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">return</span> XElement<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>netStream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Note that the &quot;casting&quot; extension methods provided by the .NET Framework do a little more than just casting under the covers. Specifically, the methods that adapt a WinRT stream to a .NET Framework stream implicitly create a buffer for the WinRT stream in the managed heap. As a result, most operations write to this buffer and do not need to cross the interop boundary, thereby improving performance. This is especially significant in scenarios that involve many small I/O operations, such as parsing an XML document.</p></blockquote><blockquote><p>One of the benefits of using the .NET Frameworkâ€™s stream projections is that if you use an AsStreamXxx method more than once on the same WinRT stream instance, you do not need to worry that different, disconnected buffers will be created, and data written to one buffer will not be visible in the other. The .NET Framework APIs ensure that every stream object has a unique adapter instance and all users share the same buffer.</p></blockquote><blockquote><p>Although in most cases the default buffering offers a good compromise between performance and memory usage, there are some cases where you may want to tweak the size of your buffer to be different from the 16-KB default. The AsStreamXxx methods offer overloads for that. For instance, if you know that you will be working with a very large file for an extended period of time, and that not many other buffered streams will be used at the same time, you can gain some additional performance by requesting a very large buffer for your stream. Conversely, in some network scenarios with low-latency requirements, you may want to ensure that no more bytes are read from the network than were explicitly requested by your application. In such cases, you can disable buffering altogether. If you specify a buffer size of zero bytes to the AsStreamXxx methods, no buffer object will be created.</p></blockquote><h3 id="passing-blocks-of-data-between-the-clr-and-winrt"><a class="anchor" href="#passing-blocks-of-data-between-the-clr-and-winrt">#</a> Passing Blocks of Data Between the CLR and WinRT</h3><blockquote><p>When possible, you should use the stream framework projections as discussed in the previous section, because they have pretty good performance characteristics. However, there may be times when you need to pass raw blocks of data between the CLR and WinRT components. For example, WinRTâ€™s file and socket stream components require you to write and read raw blocks of data. Also, WinRTâ€™s cryptography components encrypt and decrypt blocks of data, and bitmap pixels are maintained in raw blocks of data too.</p></blockquote><blockquote><p>In the .NET Framework, the usual way to obtain a block of data is either with a byte array (Byte[]) or with a stream (such as when using the MemoryStream class). Of course, byte array and MemoryStream objects canâ€™t be passed to WinRT components directly. So, WinRT defines an IBuffer interface and objects that implement this interface represent raw blocks of data that can be passed to WinRT APIs. The WinRT IBuffer interface is defined as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">namespace</span> <span class="token namespace">Windows<span class="token punctuation">.</span>Storage<span class="token punctuation">.</span>Streams</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IBuffer</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token return-type class-name">UInt32</span> Capacity <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// Maximum size of the buffer (in bytes)</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token return-type class-name">UInt32</span> Length <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// Number of bytes currently in use by the buffer</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>As you can see, an IBuffer object has a maximum size and length; oddly enough, this interface gives you no way to actually read from or write to the data in the buffer. The main reason for this is because WinRT types cannot express pointers in their metadata, because pointers do not map well to some languages (like JavaScript or safe C# code). So, an IBuffer object is really just a way to pass a memory address between the CLR and WinRT APIs. To access the bytes at the memory address, an internal COM interface, known as IBufferByteAccess, is used. Note that this interface is a COM interface (because it returns a pointer) and it is not a WinRT interface. The .NET Framework team has defined an internal RCW for this COM interface, which looks like the following.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">namespace</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>WindowsRuntime</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Guid</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"905a0fef-bc53-11df-8c49-001e4fc686da"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">InterfaceType</span><span class="token attribute-arguments"><span class="token punctuation">(</span>ComInterfaceType<span class="token punctuation">.</span>InterfaceIsIUnknown<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ComImport</span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">internal</span> <span class="token keyword">interface</span> <span class="token class-name">IBufferByteAccess</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">unsafe</span> Byte<span class="token operator">*</span> Buffer <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>Internally, the CLR can take an IBuffer object, query for its IBufferByteAccess interface, and then query the Buffer property to get an unsafe pointer to the bytes contained within the buffer. With the pointer, the bytes can be accessed directly.</p></blockquote><blockquote><p>To avoid having developers write unsafe code that manipulates pointers, the Framework Class Library includes a WindowsRuntimeBufferExtensions class that defines a bunch of extension methods, which .NET Framework developers explicitly invoke to help pass blocks of data between CLR byte arrays and streams to WinRT IBuffer objects. To call these extension methods, make sure you add a using System.Runtime.InteropServices.WindowsRuntime; directive to your source code.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">namespace</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>WindowsRuntime</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WindowsRuntimeBufferExtensions</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IBuffer</span> <span class="token function">AsBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IBuffer</span> <span class="token function">AsBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> source<span class="token punctuation">,</span> <span class="token class-name">Int32</span> offset<span class="token punctuation">,</span> <span class="token class-name">Int32</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IBuffer</span> <span class="token function">AsBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> source<span class="token punctuation">,</span> <span class="token class-name">Int32</span> offset<span class="token punctuation">,</span> <span class="token class-name">Int32</span> length<span class="token punctuation">,</span> <span class="token class-name">Int32</span> </pre></td></tr><tr><td data-num="6"></td><td><pre>capacity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IBuffer</span> <span class="token function">GetWindowsRuntimeBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">MemoryStream</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IBuffer</span> <span class="token function">GetWindowsRuntimeBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">MemoryStream</span> stream<span class="token punctuation">,</span> <span class="token class-name">Int32</span> position<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token class-name">Int32</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>So, if you have a Byte[] and you want to pass it to a WinRT API requiring an IBuffer, you simply call AsBuffer on the Byte[] array. This effectively wraps the reference to the Byte[] inside an object that implements the IBuffer interface; the contents of the Byte[] array is not copied, so this is very efficient. Similarly, if you have a MemoryStream object wrapping a publicly visible Byte[] array buffer in it, you simply call GetWindowsRuntimeBuffer on it to wrap the reference to the MemoryStreamâ€™s buffer inside an object that implements the IBuffer interface. Again, the bufferâ€™s content is not copied, so this is very efficient. The following method demonstrates both scenarios.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">ByteArrayAndStreamToIBuffer</span><span class="token punctuation">(</span><span class="token class-name">IRandomAccessStream</span> winRTStream<span class="token punctuation">,</span> <span class="token class-name">Int32</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Byte</span><span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">await</span> winRTStream<span class="token punctuation">.</span><span class="token function">ReadAsync</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">AsBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>bytes<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> InputStreamOptions<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token class-name">Int32</span> sum <span class="token operator">=</span> bytes<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span>b <span class="token operator">=></span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Access the bytes read via the Byte[]</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamWriter</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> sw<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"This string represents data in a stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> sw<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token class-name">UInt32</span> bytesWritten <span class="token operator">=</span> <span class="token keyword">await</span> winRTStream<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">GetWindowsRuntimeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>WinRTâ€™s IRandomAccessStream interface implements WinRTâ€™s IInputStream interface defined as follows.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">namespace</span> <span class="token namespace">Windows<span class="token punctuation">.</span>Storage<span class="token punctuation">.</span>Streams</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IOutputStream</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token return-type class-name">IAsyncOperationWithProgress<span class="token punctuation">&lt;</span>UInt32<span class="token punctuation">,</span> UInt32<span class="token punctuation">></span></span> <span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token class-name">IBuffer</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>When you call the AsBuffer or GetWindowsRuntimeBuffer extension methods in your code, these methods wrap the source object inside an object whose class implements the IBuffer interface. The CLR then creates a CCW for this object and passes it to the WinRT API. When the WinRT API queries the IBufferByteAccess interfaceâ€™s Buffer property to obtain a pointer to the underlying byte array, the byte array is pinned, and the address is returned to the WinRT API so it can access the data. The underlying byte array is unpinned when the WinRT API internally calls COMâ€™s Release method on the IBufferByteAccess interface.</p></blockquote><blockquote><p>If you call a WinRT API that returns an IBuffer back to you, then the data itself is probably in native memory, and youâ€™ll need a way to access this data from managed code. For this, weâ€™ll turn to some other extension methods defined by the WindowsRuntimeBufferExtensions class.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">namespace</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>WindowsRuntime</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WindowsRuntimeBufferExtensions</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Stream</span> <span class="token function">AsStream</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IBuffer</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IBuffer</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IBuffer</span> source<span class="token punctuation">,</span> <span class="token class-name">UInt32</span> sourceIndex<span class="token punctuation">,</span> <span class="token class-name">Int32</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token comment">// Not shown: CopyTo method to transfer bytes between an IBuffer and a Byte[]</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token comment">// Not shown: GetByte, IsSameData methods</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The AsStream method creates a Stream-derived object that wraps the source IBuffer. With this Stream object, you can access the data in the IBuffer by calling Streamâ€™s Read, Write, and similar methods. The ToArray method internally allocates a Byte[] and then copies all the bytes from the source IBuffer into the Byte[]; be aware that this extension method is potentially expensive in terms of memory consumption and CPU time.</p></blockquote><blockquote><p>The WindowsRuntimeBufferExtensions class also has several overloads of a CopyTo method that can copy bytes between an IBuffer and a Byte[]. It also has a GetByte method that retrieves a single byte at a time from an IBuffer and an IsSameData method that compares the contents of two IBuffer objects to see if their contents are identical. For most applications, it is unlikely that you will have a need to call any of these methods.</p></blockquote><blockquote><p>â€™d also like to point out that the .NET Framework defines a System.Runtime.InteropServices. WindowsRuntimeBuffer class that allows you to create an IBuffer object whose bytes are in the managed heap. Similarly, there is a WinRT component called Windows.Storage.Streams.Buffer that allows you to create an IBuffer object whose bytes are in the native heap. For most .NET Framework developers, there should be no need to use either of these classes explicitly in your code.</p></blockquote><p>ğŸ’¡å°ç»“ï¼šåœ¨ CLR ä¸èƒ½å°†ä¸€ä¸ª WinRT ç±»å‹éšå¼æŠ•å°„ç»™ .NET Framework å¼€å‘äººå‘˜çš„æ—¶å€™ï¼Œå¼€å‘äººå‘˜å°±å¿…é¡»æ˜¾å¼ä½¿ç”¨æ¡†æ¶æŠ•å°„ã€‚ä¸»è¦æœ‰ä¸‰ç§éœ€è¦è¿›è¡Œæ¡†æ¶æŠ•å°„çš„æŠ€æœ¯ï¼šå¼‚æ­¥ç¼–ç¨‹ã€WinRT æµå’Œ .NET Framework æµä¹‹é—´çš„äº’æ“ä½œä»¥åŠéœ€è¦åœ¨ CLR å’Œ WinRT API ä¹‹é—´ä¼ è¾“æ•°æ®å—çš„æ—¶å€™ã€‚åç»­çš„å°èŠ‚å°†åˆ†åˆ«è®¨è®ºè¿™ä¸‰ç§æ¡†æ¶æŠ•å°„ã€‚ç”±äºè®¸å¤šåº”ç”¨ç¨‹åºéƒ½è¦ä½¿ç”¨è¿™äº›æŠ€æœ¯ï¼Œæ‰€ä»¥æœ‰å¿…è¦å¾ˆå¥½åœ°ç†è§£å’Œé«˜æ•ˆåœ°ä½¿ç”¨å®ƒä»¬ã€‚</p><h2 id="defining-winrt-components-in-c"><a class="anchor" href="#defining-winrt-components-in-c">#</a> Defining WinRT Components in C#</h2><blockquote><p>So far in this chapter, Iâ€™ve been focusing on how to consume WinRT components from C#. However, you can also define WinRT components in C# and then these components can be used by native C/C++, C#/Visual Basic, JavaScript, and potentially other languages too. Although this is possible to do, we need to think about the scenarios where this actually makes sense. For example, it makes no sense at all to define a WinRT component in C# if the only consumers of the component are other managed languages that run on top of the CLR. This is because the WinRT type system has far fewer features, which make it much more restrictive than the CLRâ€™s type system.</p></blockquote><blockquote><p>I also donâ€™t think it makes a lot of sense to implement a WinRT component with C# that could be consumed by native C/C++ code. Developers using native C/C++ to implement their application are probably doing so because they are very concerned about performance and/or memory consumption. They are unlikely to want to take advantage of a WinRT component implemented with managed code, because this forces the CLR to load into their process and thus increases their memory requirements and performance due to the garbage collections and just-in-time compiling of code. For this reason, most WinRT components (like those that ship with Windows itself) are implemented in native code. Of course, there may be some parts of a native C++ app where performance is not so sensitive and, at these times, it may make sense to leverage .NET Framework functionality in order to improve productivity. For example, Bing Maps uses native C++ to draw its UI by using DirectX, but it also uses C# for its business logic.</p></blockquote><blockquote><p>So, it seems to me that the sweet spot for C#-implemented WinRT components is for Windows Store app developers who want to build their user interface with HTML and CSS and then use JavaScript as the glue code to tie the UI with business logic code that is implemented in a C# WinRT component. Another scenario would be to leverage existing Framework Class Library functionality (like Windows Communication Foundation) from an HTML/JavaScript app. Developers working with HTML and JavaScript are already willing to accept the kind of performance and memory consumption that comes with a browser engine and may be willing to even further accept the additional performance and memory consumption that comes along with also using the CLR.</p></blockquote><blockquote><p>To build a WinRT component with C#, you must first create a Microsoft Visual Studio â€œWindows Runtime Componentâ€ project. What this really does is create a normal class library project; however, the C# compiler will be spawned with the /t:winmdobj command line switch in order to produce a file with a .winmdobj file extension. With this switch specified, the compiler emits some IL code differently than it normally would. For example, WinRT components add and remove delegates to events differently than how the CLR does it, so the compiler emits different code for an eventâ€™s add and remove methods when this compiler switch is specified. Iâ€™ll show how to explicitly implement an eventâ€™s add and remove methods later in this section.</p></blockquote><blockquote><p>After the compiler produces the .winmdobj file, the WinMD export utility (WinMDExp.exe) is spawned passing to it the .winmdobj, .pdb, and .xml (doc) files produced by the compiler. The WinMDExp.exe utility examines your fileâ€™s metadata, ensuring that your types adhere to the various WinRT type system rules, as discussed at the beginning of this chapter. The utility also modifies the metadata contained in the .winmdobj file; it does not alter the IL code at all. Specifically, the utility maps any CLR types to the equivalent WinRT types. For example, references to the .NET Frameworkâ€™s IList type are changed to WinRTâ€™s IVector type. The output of the WinMDExp.exe utility is a .winmd file that other programming languages can consume.</p></blockquote><blockquote><p>You can use the .NET Frameworkâ€™s Intermediate Disassembler utility (ILDasm.exe) to inspect the contents of a .winmd file. By default, ILDasm.exe shows you the raw contents of the file. However, ILDasm.exe supports a /project command-line switch that shows you what the metadata would look like after the CLR projected the WinRT types into their .NET Framework equivalents.</p></blockquote><blockquote><p>The following code demonstrates how to implement various WinRT components in C#. The components leverage many of the features discussed throughout this chapter, and there are a lot of comments throughout the code to explain what is going on. If you need to implement a WinRT component in C#, Iâ€™d suggest using the code I show here as a model.</p></blockquote><p>ğŸ’¡é‡è¦æç¤ºï¼šæ‰˜ç®¡ä»£ç ä½¿ç”¨åŒæ ·æ‰˜ç®¡ä»£ç æºç¨‹çš„ WinRT ç»„ä»¶æ—¶ï¼ŒCLR å°†å…¶è§†ä¸ºæ™®é€šçš„æ‰˜ç®¡ç»„ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒCLR ä¸ä¼šåˆ›å»º CCW å’Œ RCWï¼Œä¸é€šè¿‡è¿™äº›åŒ…è£…å™¨æ¥è°ƒç”¨ WinRT APIã€‚è¿™æ˜¾è‘—æ›¾å€©äº†æ€§èƒ½ã€‚ä½†åœ¨æµ‹è¯•ç»„ä»¶æ—¶ï¼ŒAPI çš„è°ƒç”¨æ–¹å¼æœ‰åˆ«äºä»å…¶ä»–è¯­è¨€ (å¦‚åŸç”Ÿ C/C++ æˆ– JavaScript) è°ƒç”¨æ—¶çš„æ–¹å¼ã€‚æ‰€ä»¥ï¼Œé™¤äº†æ€§èƒ½å’Œå†…å­˜æ¶ˆè€—ä¸èƒ½åæ˜ å®é™…æƒ…å†µï¼Œæ‰˜ç®¡ä»£ç è¿˜èƒ½å‘è¦æ±‚ä¸€ä¸ª <code>String</code> çš„ WinRT API ä¼ é€’ <code>null</code> è€Œä¸å¼•å‘ <code>ArgumentNullException</code> ã€‚å¦å¤–ï¼Œç”¨æ‰˜ç®¡ä»£ç å®ç°çš„ WinRT API å¯æ“ä½œä¼ å…¥çš„æ•°ç»„ï¼Œè°ƒç”¨è€…èƒ½åœ¨ API è¿”å›æ—¶çœ‹åˆ°æ›´æ”¹è¿‡çš„æ•°ç»„å†…å®¹ã€‚è€Œä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒWinRT ç±»å‹ç³»ç»Ÿç¦æ­¢ä¿®æ”¹ä¼ ç»™ API çš„æ•°ç»„ã€‚è¿˜æœ‰å…¶ä»–æœªåˆ—å‡ºçš„å·®å¼‚ï¼Œæ‰€ä»¥åŠ¡å¿…å°å¿ƒã€‚</p><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/******************************************************************************</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Module: WinRTComponents.cs</pre></td></tr><tr><td data-num="3"></td><td><pre>Notices: Copyright (c) 2012 by Jeffrey Richter</pre></td></tr><tr><td data-num="4"></td><td><pre>******************************************************************************/</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>WindowsRuntime</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">Windows<span class="token punctuation">.</span>Foundation</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">using</span> <span class="token namespace">Windows<span class="token punctuation">.</span>Foundation<span class="token punctuation">.</span>Metadata</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">// The namespace MUST match the assembly name and cannot be "Windows"</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">namespace</span> <span class="token namespace">Wintellect<span class="token punctuation">.</span>WinRTComponents</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token comment">// [Flags] // Must not be present if enum is int; required if enum is uint</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">WinRTEnum</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">int</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// Enums must be backed by int or uint</span></pre></td></tr><tr><td data-num="17"></td><td><pre> None<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre> NotNone</pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token comment">// Structures can only contain core data types, String, &amp; other structures </span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token comment">// No constructors or methods are allowed</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">WinRTStruct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token keyword">public</span> <span class="token class-name">Int32</span> ANumber<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token keyword">public</span> <span class="token class-name">String</span> AString<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token keyword">public</span> <span class="token class-name">WinRTEnum</span> AEnum<span class="token punctuation">;</span> <span class="token comment">// Really just a 32-bit integer</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token comment">// Delegates must have WinRT-compatible types in the signature (no BeginInvoke/EndInvoke)</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name">String</span> <span class="token function">WinRTDelegate</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre> <span class="token comment">// Interfaces can have methods, properties, &amp; events but cannot be generic.</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IWinRTInterface</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token comment">// Nullable&lt;T> marshals as IReference&lt;T></span></pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token return-type class-name">Int32<span class="token punctuation">?</span></span> InterfaceProperty <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token comment">// Members without a [Version(#)] attribute default to the class's </span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token comment">// version (1) and are part of the same underlying COM interface</span></pre></td></tr><tr><td data-num="36"></td><td><pre> <span class="token comment">// produced by WinMDExp.exe.</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Version</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token comment">// Class must be derived from Object, sealed, not generic, </span></pre></td></tr><tr><td data-num="39"></td><td><pre> <span class="token comment">// implement only WinRT interfaces, &amp; public members must be WinRT types</span></pre></td></tr><tr><td data-num="40"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">WinRTClass</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IWinRTInterface</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> <span class="token comment">// Public fields are not allowed </span></pre></td></tr><tr><td data-num="42"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">region</span> Class can expose static methods, properties, and events</span></pre></td></tr><tr><td data-num="43"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">String</span> <span class="token function">StaticMethod</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token string">"Returning "</span> <span class="token operator">+</span> s<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">WinRTStruct</span> StaticProperty <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token comment">// In JavaScript 'out' parameters are returned as objects with each </span></pre></td></tr><tr><td data-num="46"></td><td><pre> <span class="token comment">// parameter becoming a property along with the return value</span></pre></td></tr><tr><td data-num="47"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">String</span> <span class="token function">OutParameters</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">WinRTStruct</span> x<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name">Int32</span> year<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WinRTStruct</span> <span class="token punctuation">&#123;</span> AEnum <span class="token operator">=</span> WinRTEnum<span class="token punctuation">.</span>NotNone<span class="token punctuation">,</span> ANumber <span class="token operator">=</span> <span class="token number">333</span><span class="token punctuation">,</span> AString <span class="token operator">=</span> <span class="token string">"Jeff"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre> year <span class="token operator">=</span> DateTimeOffset<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Year<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre> <span class="token keyword">return</span> <span class="token string">"Grant"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span></pre></td></tr><tr><td data-num="53"></td><td><pre> <span class="token comment">// Constructor can take arguments but not out/ref arguments</span></pre></td></tr><tr><td data-num="54"></td><td><pre> <span class="token keyword">public</span> <span class="token function">WinRTClass</span><span class="token punctuation">(</span><span class="token class-name">Int32<span class="token punctuation">?</span></span> number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> InterfaceProperty <span class="token operator">=</span> number<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32<span class="token punctuation">?</span></span> InterfaceProperty <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre> <span class="token comment">// Only ToString is allowed to be overridden</span></pre></td></tr><tr><td data-num="57"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">String</span> <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre> <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"InterfaceProperty=&#123;0&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="59"></td><td><pre> <span class="token return-type class-name">InterfaceProperty<span class="token punctuation">.</span>HasValue <span class="token punctuation">?</span></span> InterfaceProperty<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">"(not set)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ThrowingMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token string">"My exception message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre> <span class="token comment">// To throw a specific HRESULT, use COMException instead</span></pre></td></tr><tr><td data-num="64"></td><td><pre> <span class="token comment">//const Int32 COR_E_INVALIDOPERATION = unchecked((Int32)0x80131509);</span></pre></td></tr><tr><td data-num="65"></td><td><pre> <span class="token comment">//throw new COMException("Invalid Operation", COR_E_INVALIDOPERATION);</span></pre></td></tr><tr><td data-num="66"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">region</span> Arrays are passed, returned OR filled; never a combination</span></pre></td></tr><tr><td data-num="68"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> <span class="token function">PassArray</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ReadOnlyArray</span></span><span class="token punctuation">]</span> <span class="token comment">/* [In] implied */</span> <span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre> <span class="token comment">// NOTE: Modified array contents MAY not be marshaled out; do not modify the array</span></pre></td></tr><tr><td data-num="70"></td><td><pre> <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> <span class="token function">FillArray</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">WriteOnlyArray</span></span><span class="token punctuation">]</span> <span class="token comment">/* [Out] implied */</span> <span class="token class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre> <span class="token comment">// NOTE: Original array contents MAY not be marshaled in; </span></pre></td></tr><tr><td data-num="74"></td><td><pre> <span class="token comment">// write to the array before reading from it</span></pre></td></tr><tr><td data-num="75"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> data<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre> <span class="token keyword">return</span> data<span class="token punctuation">.</span>Length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">ReturnArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre> <span class="token comment">// Array is marshaled out upon return</span></pre></td></tr><tr><td data-num="80"></td><td><pre> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Int32<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">&#123;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span></pre></td></tr><tr><td data-num="83"></td><td><pre> <span class="token comment">// Collections are passed by reference</span></pre></td></tr><tr><td data-num="84"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">PassAndModifyCollection</span><span class="token punctuation">(</span><span class="token class-name">IDictionary<span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">></span></span> collection<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre> collection<span class="token punctuation">[</span><span class="token string">"Key2"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Value2"</span><span class="token punctuation">;</span> <span class="token comment">// Modifies collection in place via interop</span></pre></td></tr><tr><td data-num="86"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">region</span> Method overloading</span></pre></td></tr><tr><td data-num="88"></td><td><pre> <span class="token comment">// Overloads with same # of parameters are considered identical to JavaScript</span></pre></td></tr><tr><td data-num="89"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Windows<span class="token punctuation">.</span>Foundation<span class="token punctuation">.</span>Metadata<span class="token punctuation">.</span>DefaultOverload</span></span><span class="token punctuation">]</span> <span class="token comment">// Makes this method the default overload</span></pre></td></tr><tr><td data-num="91"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span></pre></td></tr><tr><td data-num="93"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">region</span> Automatically implemented event</span></pre></td></tr><tr><td data-num="94"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">WinRTDelegate</span> AutoEvent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> <span class="token function">RaiseAutoEvent</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="96"></td><td><pre> <span class="token class-name">WinRTDelegate</span> d <span class="token operator">=</span> AutoEvent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre> <span class="token keyword">return</span> <span class="token punctuation">(</span>d <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token string">"No callbacks registered"</span> <span class="token punctuation">:</span> <span class="token function">d</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span></pre></td></tr><tr><td data-num="100"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">region</span> Manually implemented event</span></pre></td></tr><tr><td data-num="101"></td><td><pre> <span class="token comment">// Private field that keeps track of the event's registered delegates</span></pre></td></tr><tr><td data-num="102"></td><td><pre> <span class="token keyword">private</span> <span class="token class-name">EventRegistrationTokenTable<span class="token punctuation">&lt;</span>WinRTDelegate<span class="token punctuation">></span></span> m_manualEvent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre> <span class="token comment">// Manual implementation of the event's add and remove methods</span></pre></td></tr><tr><td data-num="104"></td><td><pre> <span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token return-type class-name">WinRTDelegate</span> ManualEvent <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="105"></td><td><pre> <span class="token keyword">add</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="106"></td><td><pre> <span class="token comment">// Gets the existing table, or creates a new one if the table is not yet initialized</span></pre></td></tr><tr><td data-num="107"></td><td><pre> <span class="token keyword">return</span> EventRegistrationTokenTable<span class="token operator">&lt;</span>WinRTDelegate<span class="token operator">></span></pre></td></tr><tr><td data-num="108"></td><td><pre> <span class="token punctuation">.</span><span class="token function">GetOrCreateEventRegistrationTokenTable</span><span class="token punctuation">(</span><span class="token keyword">ref</span> m_manualEvent<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="109"></td><td><pre> <span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="111"></td><td><pre> <span class="token keyword">remove</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="112"></td><td><pre> EventRegistrationTokenTable<span class="token operator">&lt;</span>WinRTDelegate<span class="token operator">></span></pre></td></tr><tr><td data-num="113"></td><td><pre> <span class="token punctuation">.</span><span class="token function">GetOrCreateEventRegistrationTokenTable</span><span class="token punctuation">(</span><span class="token keyword">ref</span> m_manualEvent<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="114"></td><td><pre> <span class="token punctuation">.</span><span class="token function">RemoveEventHandler</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="116"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="117"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">String</span> <span class="token function">RaiseManualEvent</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="118"></td><td><pre> <span class="token class-name">WinRTDelegate</span> d <span class="token operator">=</span> EventRegistrationTokenTable<span class="token operator">&lt;</span>WinRTDelegate<span class="token operator">></span></pre></td></tr><tr><td data-num="119"></td><td><pre> <span class="token punctuation">.</span><span class="token function">GetOrCreateEventRegistrationTokenTable</span><span class="token punctuation">(</span><span class="token keyword">ref</span> m_manualEvent<span class="token punctuation">)</span><span class="token punctuation">.</span>InvocationList<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre> <span class="token keyword">return</span> <span class="token punctuation">(</span>d <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token string">"No callbacks registered"</span> <span class="token punctuation">:</span> <span class="token function">d</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="122"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span></pre></td></tr><tr><td data-num="123"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">region</span> Asynchronous methods</span></pre></td></tr><tr><td data-num="124"></td><td><pre> <span class="token comment">// Async methods MUST return IAsync[Action|Operation](WithProgress)</span></pre></td></tr><tr><td data-num="125"></td><td><pre> <span class="token comment">// NOTE: Other languages see the DataTimeOffset as Windows.Foundation.DateTime</span></pre></td></tr><tr><td data-num="126"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">IAsyncOperationWithProgress<span class="token punctuation">&lt;</span>DateTimeOffset<span class="token punctuation">,</span> Int32<span class="token punctuation">></span></span> <span class="token function">DoSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="127"></td><td><pre> <span class="token comment">// Use the System.Runtime.InteropServices.WindowsRuntime.AsyncInfo's Run methods to </span></pre></td></tr><tr><td data-num="128"></td><td><pre> <span class="token comment">// invoke a private method written entirely in managed code</span></pre></td></tr><tr><td data-num="129"></td><td><pre> <span class="token keyword">return</span> AsyncInfo<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Run</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DateTimeOffset<span class="token punctuation">,</span> Int32<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>DoSomethingAsyncInternal<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="131"></td><td><pre> <span class="token comment">// Implement the async operation via a private method using normal .NET technologies</span></pre></td></tr><tr><td data-num="132"></td><td><pre> <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DateTimeOffset<span class="token punctuation">></span></span> <span class="token function">DoSomethingAsyncInternal</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="133"></td><td><pre> <span class="token class-name">CancellationToken</span> ct<span class="token punctuation">,</span> <span class="token class-name">IProgress<span class="token punctuation">&lt;</span>Int32<span class="token punctuation">></span></span> progress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="135"></td><td><pre> <span class="token comment">// This code supports cancellation and progress reporting</span></pre></td></tr><tr><td data-num="136"></td><td><pre> ct<span class="token punctuation">.</span><span class="token function">ThrowIfCancellationRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre> <span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> progress<span class="token punctuation">.</span><span class="token function">Report</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Simulate doing something asynchronously</span></pre></td></tr><tr><td data-num="139"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="140"></td><td><pre> <span class="token keyword">return</span> DateTimeOffset<span class="token punctuation">.</span>Now<span class="token punctuation">;</span> <span class="token comment">// Ultimate return value</span></pre></td></tr><tr><td data-num="141"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="142"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name">IAsyncOperation<span class="token punctuation">&lt;</span>DateTimeOffset<span class="token punctuation">></span></span> <span class="token function">DoSomethingAsync2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="143"></td><td><pre> <span class="token comment">// If you donâ€™t need cancellation &amp; progress, use </span></pre></td></tr><tr><td data-num="144"></td><td><pre> <span class="token comment">// System.WindowsRuntimeSystemExtensionsâ€™ AsAsync[Action|Operation] Task </span></pre></td></tr><tr><td data-num="145"></td><td><pre> <span class="token comment">// extension methods (these call AsyncInfo.Run internally)</span></pre></td></tr><tr><td data-num="146"></td><td><pre> <span class="token keyword">return</span> <span class="token function">DoSomethingAsyncInternal</span><span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">CancellationToken</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AsAsyncOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="148"></td><td><pre> <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span></pre></td></tr><tr><td data-num="149"></td><td><pre> <span class="token comment">// After you ship a version, mark new members with a [Version(#)] attribute</span></pre></td></tr><tr><td data-num="150"></td><td><pre> <span class="token comment">// so that WinMDExp.exe puts the new members in a different underlying COM </span></pre></td></tr><tr><td data-num="151"></td><td><pre> <span class="token comment">// interface. This is required since COM interfaces are supposed to be immutable.</span></pre></td></tr><tr><td data-num="152"></td><td><pre> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Version</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="153"></td><td><pre> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">NewMethodAddedInV2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="154"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>The following JavaScript code demonstrates how to access all of the previous WinRT components and features.</p></blockquote><figure class="highlight csharp"><figcaption data-lang="C#"></figcaption><table><tr><td data-num="1"></td><td><pre>function <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token comment">// Make accessing the namespace more convenient in the code</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> WinRTComps <span class="token operator">=</span> Wintellect<span class="token punctuation">.</span>WinRTComponents<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token comment">// NOTE: The JavaScript VM projects WinRT APIs via camel casing</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token comment">// Access WinRT type's static method &amp; property </span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> s <span class="token operator">=</span> WinRTComps<span class="token punctuation">.</span>WinRTClass<span class="token punctuation">.</span><span class="token function">staticMethod</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// NOTE: JavaScript pass "null" here!</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token keyword">var</span> <span class="token keyword">struct</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> anumber<span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">astring</span><span class="token punctuation">:</span> <span class="token string">"Jeff"</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">aenum</span><span class="token punctuation">:</span> WinRTComps<span class="token punctuation">.</span>WinRTEnum<span class="token punctuation">.</span>notNone <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> WinRTComps<span class="token punctuation">.</span>WinRTClass<span class="token punctuation">.</span>staticProperty <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> s <span class="token operator">=</span> WinRTComps<span class="token punctuation">.</span>WinRTClass<span class="token punctuation">.</span>staticProperty<span class="token punctuation">;</span> <span class="token comment">// Read it back</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token comment">// If the method has out parameters, they and the return value </span></pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token comment">// are returned as an objectâ€™s properties </span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> s <span class="token operator">=</span> WinRTComps<span class="token punctuation">.</span>WinRTClass<span class="token punctuation">.</span><span class="token function">outParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> name <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">;</span> <span class="token comment">// Return value</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token keyword">var</span> <span class="token keyword">struct</span> <span class="token operator">=</span> s<span class="token punctuation">.</span>x<span class="token punctuation">;</span> <span class="token comment">// an 'out' parameter</span></pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> year <span class="token operator">=</span> s<span class="token punctuation">.</span>year<span class="token punctuation">;</span> <span class="token comment">// another 'out' parameter</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token comment">// Construct an instance of the WinRT component</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> winRTClass <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WinRTComps<span class="token punctuation">.</span>WinRTClass</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> s <span class="token operator">=</span> winRTClass<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Call ToString()</span></pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token comment">// Demonstrate throw and catch</span></pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span> winRTClass<span class="token punctuation">.</span><span class="token function">throwingMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token comment">// Array passing</span></pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> sum <span class="token operator">=</span> winRTClass<span class="token punctuation">.</span><span class="token function">passArray</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token comment">// Array filling</span></pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> arrayOut <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// NOTE: fillArray sees all zeros!</span></pre></td></tr><tr><td data-num="27"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> length <span class="token operator">=</span> winRTClass<span class="token punctuation">.</span><span class="token function">fillArray</span><span class="token punctuation">(</span>arrayOut<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// On return, arrayOut = [0, 1, 2]</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token comment">// Array returning</span></pre></td></tr><tr><td data-num="29"></td><td><pre> a <span class="token operator">=</span> winRTClass<span class="token punctuation">.</span><span class="token function">returnArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a = [ 1, 2, 3]</span></pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token comment">// Pass a collection and have its elements modified</span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> localSettings <span class="token operator">=</span> Windows<span class="token punctuation">.</span>Storage<span class="token punctuation">.</span>ApplicationData<span class="token punctuation">.</span>current<span class="token punctuation">.</span>localSettings<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre> localSettings<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token string">"Key1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Value1"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre> winRTClass<span class="token punctuation">.</span><span class="token function">passAndModifyCollection</span><span class="token punctuation">(</span>localSettings<span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token comment">// On return, localSettings.values has 2 key/value pairs in it</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token comment">// Call overloaded method</span></pre></td></tr><tr><td data-num="36"></td><td><pre> winRTClass<span class="token punctuation">.</span><span class="token function">someMethod</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Actually calls SomeMethod(String) passing "5"</span></pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token comment">// Consume the automatically implemented event</span></pre></td></tr><tr><td data-num="38"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> f <span class="token operator">=</span> function <span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> v<span class="token punctuation">.</span>target<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre> winRTClass<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"autoevent"</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre> s <span class="token operator">=</span> winRTClass<span class="token punctuation">.</span><span class="token function">raiseAutoEvent</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> <span class="token comment">// Consume the manually implemented event</span></pre></td></tr><tr><td data-num="42"></td><td><pre> winRTClass<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"manualevent"</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre> s <span class="token operator">=</span> winRTClass<span class="token punctuation">.</span><span class="token function">raiseManualEvent</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre> <span class="token comment">// Invoke asynchronous method supporting progress, cancelation, &amp; error handling</span></pre></td></tr><tr><td data-num="45"></td><td><pre> <span class="token class-name"><span class="token keyword">var</span></span> promise <span class="token operator">=</span> winRTClass<span class="token punctuation">.</span><span class="token function">doSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="47"></td><td><pre> function <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Async op complete: "</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre> function <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Async op error: "</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="49"></td><td><pre> function <span class="token punctuation">(</span>progress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Async op progress: "</span> <span class="token operator">+</span> progress<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre> <span class="token comment">//if (progress == 30) promise.cancel(); // To test cancelation</span></pre></td></tr><tr><td data-num="52"></td><td><pre> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>ğŸ’¡å°ç»“ï¼šå¦‚æœå”¯ä¸€çš„ä½¿ç”¨è€…å°±æ˜¯åœ¨ CLR é¡¶éƒ¨è¿è¡Œçš„å…¶ä»–æ‰˜ç®¡è¯­è¨€ï¼Œé‚£ä¹ˆç”¨ C# å®šä¹‰çš„ WinRT ç»„ä»¶å°±æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚è¿™æ˜¯ç”±äº WinRT ç±»å‹ç³»ç»ŸåŠŸèƒ½å°‘å¾—å¤šï¼Œç›¸æ¯” CLR çš„ç±»å‹ç³»ç»Ÿé™åˆ¶å¤ªå¤§ã€‚ç”¨ C# å®šä¹‰èƒ½ç”±åŸç”Ÿ C/C++ ä»£ç ä½¿ç”¨çš„ WinRT ç»„ä»¶ä¹Ÿæ²¡æœ‰å¤šå¤§æ„ä¹‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºå…³å¿ƒæ€§èƒ½å’Œå†…å­˜æ¶ˆè€—æ—¶æ‰ä¼šç”¨åŸç”Ÿ C/C++ æ¥å®ç°ã€‚è¿™æ—¶ä¸å¤ªå¯èƒ½ä½¿ç”¨ç”±æ‰˜ç®¡ä»£ç å®ç°çš„ WinRT ç»„ä»¶ï¼Œå¦åˆ™å°±è¦è¢«è¿«åœ¨è¿›ç¨‹ä¸­åŠ è½½ CLRï¼Œå¢å¤§å†…å­˜æ¶ˆè€—å’Œé™ä½æ€§èƒ½ (å› ä¸ºè¦è¿›è¡Œåƒåœ¾å›æ”¶å’Œ JIT ç¼–è¯‘)ã€‚æ‰€ä»¥ï¼Œå¤§å¤šæ•° WinRT ç»„ä»¶ (æ¯”å¦‚éšåŒ Windows æä¾›çš„é‚£äº›) éƒ½æ˜¯ç”¨åŸç”Ÿä»£ç å®ç°çš„ã€‚å½“ç„¶ï¼Œå¦‚æœåŸç”Ÿ C++ åº”ç”¨çš„æŸäº›éƒ¨åˆ†å¯¹æ€§èƒ½ä¸æ•æ„Ÿï¼Œå°±å¯è€ƒè™‘åˆ©ç”¨ .NET Framework çš„åŠŸèƒ½æ¥æé«˜å¼€å‘æ•ˆç‡ã€‚ä¾‹å¦‚ï¼Œå¿…åº”åœ°å›¾ Bing Maps ç”¨åŸç”Ÿ C++ å’Œ DirectX ç»˜åˆ¶ UIï¼Œä½†ä¸šåŠ¡é€»è¾‘ç”¨ C# å®ç°ã€‚ç”¨ C# å®ç°çš„ WinRT ç»„ä»¶æœ€ä½³åº”ç”¨åœºåˆå°±æ˜¯ï¼šWindows Store åº”ç”¨çš„å¼€å‘äººå‘˜ç”¨ HTML å’Œ CSS æ„å»º UIã€‚ç„¶åï¼Œä½¿ç”¨ JavaScript ä»£ç å°† UI å’Œç”¨ C# WinRT ç»„ä»¶å®ç°çš„ä¸šåŠ¡é€»è¾‘ â€œç²˜åˆâ€ èµ·æ¥ã€‚è¿˜æœ‰ä¸€ä¸ªåº”ç”¨åœºåˆæ˜¯åœ¨ HTML/JavaScript åº”ç”¨ä¸­ä½¿ç”¨ç°æœ‰çš„ FCL åŠŸèƒ½ (æ¯”å¦‚ WCF)ã€‚HTML/JavaScript å¼€å‘äººå‘˜å·²ä¹ æƒ¯äº†æµè§ˆå™¨å¼•æ“é€ æˆçš„æ€§èƒ½æŸå¤±å’Œå†…å­˜æ¶ˆè€—ï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šèƒ½æ¥å—ä½¿ç”¨ CLR é€ æˆçš„é¢å¤–æ€§èƒ½æŸå¤±å’Œå†…å­˜æ¶ˆè€—ã€‚ç”¨ C# å®šä¹‰ WinRT ç»„ä»¶é¦–å…ˆè¦åœ¨ Microsoft Visual Studio ä¸­åˆ›å»º â€œWindows è¿è¡Œæ—¶ç»„ä»¶â€ é¡¹ç›®ã€‚åˆ›å»ºçš„å…¶å®æ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»åº“é¡¹ç›®ï¼Œä½† C# ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ·»åŠ  <code>t/:winmdobj</code> å‘½ä»¤è¡Œå¼€å…³æ¥ç”Ÿæˆ .winmdobj æ–‡ä»¶ã€‚æ–‡ä»¶ä¸­ä¼šæ’å…¥ä¸€äº›å’Œå¹³æ—¶ä¸åŒçš„ IL ä»£ç ã€‚ä¾‹å¦‚ï¼ŒWinRT ç»„ä»¶é‡‡ç”¨å’Œ CLR ä¸åŒçš„æ–¹å¼ä¸ºäº‹ä»¶æ·»åŠ å’Œåˆ é™¤å§”æ‰˜ã€‚æ‰€ä»¥ï¼Œå¦‚æœæŒ‡å®šäº†è¿™ä¸ªç¼–è¯‘å™¨å¼€å…³ï¼Œç¼–è¯‘å™¨å°±ä¼šä¸ºäº‹ä»¶çš„æ·»åŠ å’Œåˆ é™¤æ–¹æ³•ç”Ÿæˆä¸åŒçš„ä»£ç ã€‚ç¼–è¯‘å™¨ç”Ÿæˆ .winmdobj æ–‡ä»¶åå°†å¯åŠ¨ WinMD å®ç”¨ç¨‹åº (WinMDExp.exe)&lt;sup&gt;â‘ &lt;/sup&gt;ï¼Œå‘å®ƒä¼ é€’ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ .winmdobjï¼Œ.pdb å’Œ .xml (doc) æ–‡ä»¶ã€‚WinMDExp.exe å®ç”¨ç¨‹åºæ£€æŸ¥æ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œç¡®ä¿ä½ çš„ç±»å‹ç¬¦åˆæœ¬ç« å¼€å¤´è®¨è®ºçš„ WinRT ç±»å‹ç³»ç»Ÿçš„å„ç§è§„åˆ™ã€‚å®ç”¨ç¨‹åºè¿˜ä¼šä¿®æ”¹ .winmdobj æ–‡ä»¶ä¸­çš„å…ƒæ•°æ®ï¼›å®ƒä¸€ç‚¹å„¿éƒ½ä¸ä¼šç¢° IL ä»£ç ã€‚å…·ä½“åœ°è¯´ï¼Œå®ç”¨ç¨‹åºåªèƒ½å°† CLR ç±»å‹æ˜ å°„åˆ°ç­‰ä»·çš„ WinRT ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¯¹ .NET Framework <code>IList&lt;String&gt;</code> ç±»å‹çš„å¼•ç”¨è¢«æ›´æ”¹ä¸º WinRT çš„ <code>IVector&lt;String&gt;</code> ç±»å‹ã€‚WinMDExp.exe è¾“å‡ºçš„æ˜¯å¯ä¾›å…¶ä»–è¯­è¨€ä½¿ç”¨çš„ .winmd æ–‡ä»¶ã€‚å¯ç”¨ .NET Framework çš„ IL åæ±‡ç¼–å™¨å·¥å…· (ILDasm.exe) æ£€æŸ¥.winmd æ–‡ä»¶çš„å†…å®¹ã€‚ILDasm.exe é»˜è®¤æ˜¾ç¤ºæ–‡ä»¶çš„åŸå§‹å†…å®¹ã€‚ä½†å®ƒæ”¯æŒç”¨ <code>/project</code> å‘½ä»¤è¡Œå¼€å…³æ˜¾ç¤ºå°† WinRT ç±»å‹æŠ•å°„æˆ .NET Framework ç­‰ä»·ç±»å‹ä¹‹åçš„å…ƒæ•°æ®ã€‚</p><div class="tags"><a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag"><i class="ic i-tag"></i> è¯»ä¹¦ç¬”è®°</a> <a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C#</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2022-12-06 11:20:14" itemprop="dateModified" datetime="2022-12-06T11:20:14+08:00">2022-12-06</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(ï¿£â–½ï¿£)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Sakupinera WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/images/alipay.png" alt="Sakupinera Alipay"><p>Alipay</p></div><div><img data-src="/images/paypal.png" alt="Sakupinera PayPal"><p>PayPal</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Sakupinera <i class="ic i-at"><em>@</em></i>Sakupinera</li><li class="link"><strong>Post link: </strong><a href="http://sakupinera.github.io/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/" title="CLR via C# - Chapter 25 Interoperating with WinRT Components">http://sakupinera.github.io/2022/12/06/csharp/clr-via-csharp/Chapter 25 Interoperating with WinRT Components/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;03&#x2F;08&#x2F;hub7DjxPVYvzoB4.jpg" title="CLR via C# - Chapter 24 Runtime Serialization"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> CLR-via-CSharp</span><h3>CLR via C# - Chapter 24 Runtime Serialization</h3></a></div><div class="item right"><a href="/2022/12/09/cpp/cpp-primer/Chapter%201%20Getting%20Started/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;03&#x2F;08&#x2F;AK1D84aqsYghTOC.jpg" title="C++ Primer - Chapter 1 Getting Started"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> Cpp-Primer</span><h3>C++ Primer - Chapter 1 Getting Started</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#chapter-25-interoperating-with-winrt-components"><span class="toc-number">1.</span> <span class="toc-text">Chapter 25 Interoperating with WinRT Components</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#clr-projections-and-winrt-component-type-system-rules"><span class="toc-number">1.1.</span> <span class="toc-text">CLR Projections and WinRT Component Type System Rules</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#winrt-type-system-core-concepts"><span class="toc-number">1.1.1.</span> <span class="toc-text">WinRT Type System Core Concepts</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#framework-projections"><span class="toc-number">1.2.</span> <span class="toc-text">Framework Projections</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#calling-asynchronous-winrt-apis-from-net-code"><span class="toc-number">1.2.1.</span> <span class="toc-text">Calling Asynchronous WinRT APIs from .NET Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#interoperating-between-winrt-streams-and-net-streams"><span class="toc-number">1.2.2.</span> <span class="toc-text">Interoperating Between WinRT Streams and .NET Streams</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#passing-blocks-of-data-between-the-clr-and-winrt"><span class="toc-number">1.2.3.</span> <span class="toc-text">Passing Blocks of Data Between the CLR and WinRT</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#defining-winrt-components-in-c"><span class="toc-number">1.3.</span> <span class="toc-text">Defining WinRT Components in C#</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%201%20The%20CLR%E2%80%99s%20Execution%20Model/" rel="bookmark" title="CLR via C# - Chapter 1 The CLRâ€™s Execution Model">CLR via C# - Chapter 1 The CLRâ€™s Execution Model</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%202%20Building,%20Packaging,%20Deploying,%20and%20Administering%20Applications%20and%20Types/" rel="bookmark" title="CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types">CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types</a></li><li><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%203%20Shared%20Assemblies%20and%20Strongly%20Named%20Assemblies/" rel="bookmark" title="CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies">CLR via C# - Chapter 3 Shared Assemblies and Strongly Named Assemblies</a></li><li><a href="/2022/09/27/csharp/clr-via-csharp/Chapter%204%20Type%20Fundamentals/" rel="bookmark" title="CLR via C# - Chapter 4 Type Fundamentals">CLR via C# - Chapter 4 Type Fundamentals</a></li><li><a href="/2022/10/15/csharp/clr-via-csharp/Chapter%205%20Primitive,%20Reference,%20and%20Value%20%20Types/" rel="bookmark" title="CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals">CLR via C# - Chapter 5 Primitive, Reference, and Value Types Fundamentals</a></li><li><a href="/2022/10/21/csharp/clr-via-csharp/Chapter%206%20Type%20and%20Member%20Basics/" rel="bookmark" title="CLR via C# - Chapter 6 Type and Member Basics">CLR via C# - Chapter 6 Type and Member Basics</a></li><li><a href="/2022/10/24/csharp/clr-via-csharp/Chapter%207%20Constants%20and%20Fields/" rel="bookmark" title="CLR via C# - Chapter 7 Constants and Fields">CLR via C# - Chapter 7 Constants and Fields</a></li><li><a href="/2022/10/25/csharp/clr-via-csharp/Chapter%208%20Methods/" rel="bookmark" title="CLR via C# - Chapter 8 Methods">CLR via C# - Chapter 8 Methods</a></li><li><a href="/2022/10/27/csharp/clr-via-csharp/Chapter%209%20Parameters/" rel="bookmark" title="CLR via C# - Chapter 9 Parameters">CLR via C# - Chapter 9 Parameters</a></li><li><a href="/2022/10/28/csharp/clr-via-csharp/Chapter%2010%20Properties/" rel="bookmark" title="CLR via C# - Chapter 10 Properties">CLR via C# - Chapter 10 Properties</a></li><li><a href="/2022/10/29/csharp/clr-via-csharp/Chapter%2011%20Events/" rel="bookmark" title="CLR via C# - Chapter 11 Events">CLR via C# - Chapter 11 Events</a></li><li><a href="/2022/11/02/csharp/clr-via-csharp/Chapter%2012%20Generics/" rel="bookmark" title="CLR via C# - Chapter 12 Generics">CLR via C# - Chapter 12 Generics</a></li><li><a href="/2022/11/04/csharp/clr-via-csharp/Chapter%2013%20Interfaces/" rel="bookmark" title="CLR via C# - Chapter 13 Interfaces">CLR via C# - Chapter 13 Interfaces</a></li><li><a href="/2022/11/16/csharp/clr-via-csharp/Chapter%2014%20Chars,%20Strings,%20and%20Working%20%20with%20Text/" rel="bookmark" title="CLR via C# - Chapter 14 Chars, Strings, and Working with Text">CLR via C# - Chapter 14 Chars, Strings, and Working with Text</a></li><li><a href="/2022/11/17/csharp/clr-via-csharp/Chapter%2015%20Enumerated%20Types%20and%20Bit%20Flags/" rel="bookmark" title="CLR via C# - Chapter 15 Enumerated Types and Bit Flags">CLR via C# - Chapter 15 Enumerated Types and Bit Flags</a></li><li><a href="/2022/11/19/csharp/clr-via-csharp/Chapter%2016%20Arrays/" rel="bookmark" title="CLR via C# - Chapter 16 Arrays">CLR via C# - Chapter 16 Arrays</a></li><li><a href="/2022/11/21/csharp/clr-via-csharp/Chapter%2017%20Delegates/" rel="bookmark" title="CLR via C# - Chapter 17 Delegates">CLR via C# - Chapter 17 Delegates</a></li><li><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" rel="bookmark" title="CLR via C# - Chapter 18 Custom Attributes">CLR via C# - Chapter 18 Custom Attributes</a></li><li><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" rel="bookmark" title="CLR via C# - Chapter 19 Nullable Value Types">CLR via C# - Chapter 19 Nullable Value Types</a></li><li><a href="/2022/11/25/csharp/clr-via-csharp/Chapter%2020%20Exceptions%20and%20State%20Management/" rel="bookmark" title="CLR via C# - Chapter 20 Exceptions and State Management">CLR via C# - Chapter 20 Exceptions and State Management</a></li><li><a href="/2022/11/27/csharp/clr-via-csharp/Chapter%2021%20The%20Managed%20Heap%20and%20Garbage%20%20Collection/" rel="bookmark" title="CLR via C# - Chapter 21 The Managed Heap and Garbage  Collection">CLR via C# - Chapter 21 The Managed Heap and Garbage Collection</a></li><li><a href="/2022/11/28/csharp/clr-via-csharp/Chapter%2022%20CLR%20Hosting%20and%20AppDomains/" rel="bookmark" title="CLR via C# - Chapter 22 CLR Hosting and AppDomains">CLR via C# - Chapter 22 CLR Hosting and AppDomains</a></li><li><a href="/2022/11/29/csharp/clr-via-csharp/Chapter%2023%20Assembly%20Loading%20and%20Reflection/" rel="bookmark" title="CLR via C# - Chapter 23 Assembly Loading and Reflection">CLR via C# - Chapter 23 Assembly Loading and Reflection</a></li><li><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" rel="bookmark" title="CLR via C# - Chapter 24 Runtime Serialization">CLR via C# - Chapter 24 Runtime Serialization</a></li><li class="active"><a href="/2022/12/06/csharp/clr-via-csharp/Chapter%2025%20Interoperating%20with%20WinRT%20%20Components/" rel="bookmark" title="CLR via C# - Chapter 25 Interoperating with WinRT Components">CLR via C# - Chapter 25 Interoperating with WinRT Components</a></li><li><a href="/2023/02/06/csharp/clr-via-csharp/Chapter%2026%20Thread%20Basics/" rel="bookmark" title="CLR via C# - Chapter 26 Thread Basics">CLR via C# - Chapter 26 Thread Basics</a></li><li><a href="/2023/02/07/csharp/clr-via-csharp/Chapter%2027%20Compute-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations">CLR via C# - Chapter 27 Compute-Bound Asynchronous Operations</a></li><li><a href="/2023/02/08/csharp/clr-via-csharp/Chapter%2028%20IO-Bound%20Asynchronous%20Operations/" rel="bookmark" title="CLR via C# - Chapter 28 IO-Bound Asynchronous Operations">CLR via C# - Chapter 28 IO-Bound Asynchronous Operations</a></li><li><a href="/2023/02/09/csharp/clr-via-csharp/Chapter%2029%20Primitive%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 29 Primitive Thread Synchronization">CLR via C# - Chapter 29 Primitive Thread Synchronization</a></li><li><a href="/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/" rel="bookmark" title="CLR via C# - Chapter 30 Hybrid Thread Synchronization">CLR via C# - Chapter 30 Hybrid Thread Synchronization</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Sakupinera" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Sakupinera</p><div class="description" itemprop="description">ä¿æŒä½ çš„å†³å¿ƒï¼</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">86</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">13</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">6</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Nha3VwaW5lcmE=" title="https:&#x2F;&#x2F;github.com&#x2F;sakupinera"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9zYWt1cGluZXJh" title="https:&#x2F;&#x2F;twitter.com&#x2F;sakupinera"><i class="ic i-twitter"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTQwNzIyOTA3MQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;407229071"><i class="ic i-cloud-music"></i></span> <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMjIzMDczOTg/c3BtX2lkX2Zyb209MzMzLjEwMDcuMC4w" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;22307398?spm_id_from&#x3D;333.1007.0.0"><i class="ic i-bilibili"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/games/" rel="section"><i class="ic i-flag"></i>Games</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-person"></i>About</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/11/30/csharp/clr-via-csharp/Chapter%2024%20Runtime%20Serialization/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/12/09/cpp/cpp-primer/Chapter%201%20Getting%20Started/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/16/csharp/clr-via-csharp/Chapter%2014%20Chars,%20Strings,%20and%20Working%20%20with%20Text/" title="CLR via C# - Chapter 14 Chars, Strings, and Working with Text">CLR via C# - Chapter 14 Chars, Strings, and Working with Text</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/23/csharp/clr-via-csharp/Chapter%2019%20Nullable%20Value%20Types/" title="CLR via C# - Chapter 19 Nullable Value Types">CLR via C# - Chapter 19 Nullable Value Types</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2023/02/10/csharp/clr-via-csharp/Chapter%2030%20Hybrid%20Thread%20Synchronization%20Constructs/" title="CLR via C# - Chapter 30 Hybrid Thread Synchronization">CLR via C# - Chapter 30 Hybrid Thread Synchronization</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/08/28/linux/learn-linux/Linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85/" title="LearnLinux - Linuxç³»ç»Ÿå®‰è£…">LearnLinux - Linuxç³»ç»Ÿå®‰è£…</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CSharp-in-a-Nutshell/" title="In CSharp-in-a-Nutshell">CSharp-in-a-Nutshell</a></div><span><a href="/2022/08/29/csharp/csharp-in-a-nutshell/%E7%AC%AC2%E7%AB%A0%20%E5%9C%A8CSharp%E4%B8%AD%E5%88%9B%E5%BB%BA%E7%B1%BB%E5%9E%8B/" title="C# in a Nutshell - ç¬¬2ç«  C#è¯­è¨€åŸºç¡€">C# in a Nutshell - ç¬¬2ç«  C#è¯­è¨€åŸºç¡€</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/08/28/linux/learn-linux/%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/" title="LearnLinux - æƒé™ç®¡ç†">LearnLinux - æƒé™ç®¡ç†</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Cpp/" title="In Cpp">Cpp</a> <i class="ic i-angle-right"></i> <a href="/categories/Cpp/Cpp-Primer/" title="In Cpp-Primer">Cpp-Primer</a></div><span><a href="/2023/01/11/cpp/cpp-primer/Chapter%2019%20Specialized%20Tools%20and%20Techniques/" title="C++ Primer - Chapter 19 Specialized Tools and Techniques">C++ Primer - Chapter 19 Specialized Tools and Techniques</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/11/22/csharp/clr-via-csharp/Chapter%2018%20Custom%20Attributes/" title="CLR via C# - Chapter 18 Custom Attributes">CLR via C# - Chapter 18 Custom Attributes</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CSharp/" title="In CSharp">CSharp</a> <i class="ic i-angle-right"></i> <a href="/categories/CSharp/CLR-via-CSharp/" title="In CLR-via-CSharp">CLR-via-CSharp</a></div><span><a href="/2022/08/28/csharp/clr-via-csharp/Chapter%202%20Building,%20Packaging,%20Deploying,%20and%20Administering%20Applications%20and%20Types/" title="CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types">CLR via C# - Chapter 2 Building, Packaging, Deploying, and Administering Applications and Types</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Linux/" title="In Linux">Linux</a> <i class="ic i-angle-right"></i> <a href="/categories/Linux/Learn-Linux/" title="In Learn-Linux">Learn-Linux</a></div><span><a href="/2022/09/05/linux/learn-linux/%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/" title="LearnLinux - å¤‡ä»½ä¸æ¢å¤">LearnLinux - å¤‡ä»½ä¸æ¢å¤</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 â€“ <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Sakupinera @ Hanamai Sora</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">2.2m words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">33:30</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/12/06/csharp/clr-via-csharp/Chapter 25 Interoperating with WinRT  Components/",favicon:{show:"ï¼ˆâ—Â´3ï½€â—ï¼‰Goooood",hide:"(Â´Ğ”ï½€)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/assets/shifuku.model.json"},display:{position:"left",width:250,height:500},mobile:{show:!1},react:{opacity:.9},log:!1})</script></body></html>